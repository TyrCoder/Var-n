<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      body {
        background: #fafafa;
        font-family: 'Commissioner', sans-serif;
      }

      /* Top Bar */
      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 75px;
        background: #ffffff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 48px;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        backdrop-filter: blur(10px);
      }

      /* Brand Logo */
      .top-brand {
        font-family: 'Playfair Display', serif;
        font-size: 28px;
        font-weight: 600;
        color: #000000;
        letter-spacing: 0.03em;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s ease;
        text-decoration: none;
      }
      .top-brand:hover {
        opacity: 0.7;
      }

      /* User Dropdown in Top Bar */
      .user-dropdown {
        position: relative;
      }
      .user-button {
        background: #fafafa;
        border: 1px solid #e8e8e8;
        color: #000000;
        cursor: pointer;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 10px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .user-button:hover {
        background: #f5f5f5;
        border-color: #d4d4d4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
      }
      .user-button-icon {
        width: 34px;
        height: 34px;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 13px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }
      .user-button-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.2;
      }
      .user-button-label {
        font-size: 11px;
        color: #9ca3af;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .user-button-arrow {
        margin-left: 4px;
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s ease;
      }
      .user-dropdown.show .user-button-arrow {
        transform: rotate(180deg);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: #fff;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 10px;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
      }
      .dropdown-content.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 14px 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
      }
      .dropdown-content a:hover {
        background: #f9fafb;
        padding-left: 22px;
      }

      .checkout-page {
        max-width: 1200px;
        margin: 100px auto 80px;
        padding: 0 32px;
      }

      .checkout-header {
        text-align: center;
        margin-bottom: 48px;
      }

      .checkout-header h1 {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 600;
        margin: 0 0 16px;
        color: #000000;
      }

      .checkout-header p {
        font-size: 16px;
        color: #737373;
        margin: 0;
      }

      .checkout-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 48px;
        margin-bottom: 48px;
      }

      .checkout-form {
        background: #ffffff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      }

      .checkout-section {
        margin-bottom: 40px;
      }

      .checkout-section:last-child {
        margin-bottom: 0;
      }

      .checkout-section h2 {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 24px;
        color: #000000;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #374151;
        font-family: 'Commissioner', sans-serif;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
        background: #ffffff;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #000000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .payment-methods {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .payment-option {
        display: flex;
        align-items: center;
        padding: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .payment-option:hover {
        border-color: #000000;
        background: #f9fafb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .payment-option.selected {
        border-color: #000000;
        background: #f9fafb;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
      }

      .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 16px;
        cursor: pointer;
      }

      .payment-option-content {
        flex: 1;
      }

      .payment-option-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        color: #000000;
      }

      .payment-option-desc {
        font-size: 14px;
        color: #6b7280;
      }

      .payment-icon {
        font-size: 28px;
        margin-right: 16px;
        color: #6b7280;
      }

      .order-summary {
        background: #ffffff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .order-summary h2 {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 24px;
        color: #000000;
      }

      .order-items {
        margin-bottom: 24px;
      }

      .order-item {
        display: flex;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-item-image {
        width: 60px;
        height: 60px;
        background-color: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #f0f0f0;
        flex-shrink: 0;
      }

      .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-info {
        flex: 1;
        min-width: 0;
      }

      .order-item-name {
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        margin: 0 0 4px;
        display: block;
      }

      .order-item-details {
        font-size: 14px;
        color: #6b7280;
        margin: 0 0 4px;
      }

      .order-item-price {
        font-weight: 600;
        font-size: 16px;
        color: #000000;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        font-size: 16px;
        color: #374151;
      }

      .summary-row.total {
        font-size: 20px;
        font-weight: 600;
        color: #000000;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #f0f0f0;
      }

      .place-order-btn {
        width: 100%;
        padding: 16px;
        background: #000000;
        color: #ffffff;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 24px;
      }

      .place-order-btn:hover {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      }

      .place-order-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      @media (max-width: 768px) {
        .top-bar {
          padding: 0 20px;
          height: 65px;
        }
        .top-brand {
          font-size: 22px;
        }
        .checkout-container {
          grid-template-columns: 1fr;
          gap: 32px;
        }
        .checkout-header h1 {
          font-size: 28px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .order-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <a href="{{ url_for('buyer_dashboard') }}" class="top-brand">Var√≥n</a>
      <div class="user-dropdown">
        <button class="user-button" onclick="toggleUserDropdown()">
          <div class="user-button-icon" id="buyerInitial">{{ session.get('first_name', 'U')[0]|upper }}</div>
          <div class="user-button-text">
            <span class="user-button-label">Account</span>
            <span id="buyerFirstName" style="font-weight: 600;">{{ session.get('first_name', 'User') }}</span>
          </div>
          <span class="user-button-arrow">‚ñº</span>
        </button>
        <div id="userDropdown" class="dropdown-content">
          <a href="{{ url_for('cart') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 2L7.17 4H3c-.55 0-1 .45-1 1s.45 1 1 1h1l1.6 8.6c.18 1 1.05 1.73 2.06 1.73h7.72c1.01 0 1.88-.73 2.06-1.73L19 6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4.17L14 2H9z"/>
              <circle cx="9" cy="20" r="1"/>
              <circle cx="16" cy="20" r="1"/>
            </svg>
            Cart
          </a>
          <a href="{{ url_for('buyer_dashboard') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9,22 9,12 15,12 15,22"/>
            </svg>
            Dashboard
          </a>
          <a href="{{ url_for('logout') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </a>
        </div>
      </div>
    </div>

    <main class="checkout-page">
      <div class="checkout-header">
        <h1>Checkout</h1>
        <p>Complete your order with secure payment</p>
      </div>

      <div class="checkout-container">
        <form class="checkout-form" id="checkoutForm">
          <!-- Shipping Information -->
          <div class="checkout-section">
            <h2>Shipping Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name</label>
                <input type="text" id="firstName" name="firstName" required>
              </div>
              <div class="form-group">
                <label for="lastName">Last Name</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number</label>
              <input type="tel" id="phone" name="phone" required>
            </div>
            <div class="form-group">
              <label for="address">Street Address</label>
              <input type="text" id="address" name="address" required>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="postalCode">Postal Code</label>
                <input type="text" id="postalCode" name="postalCode" required>
              </div>
            </div>
            <div class="form-group">
              <label for="country">Country</label>
              <select id="country" name="country" required>
                <option value="">Select Country</option>
                <option value="PH">Philippines</option>
              </select>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="checkout-section">
            <h2>Payment Method</h2>
            <div class="payment-methods">
              <label class="payment-option selected" for="cod">
                <input type="radio" id="cod" name="paymentMethod" value="cod" checked>
                <div class="payment-icon">üí∞</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">Cash on Delivery</div>
                  <div class="payment-option-desc">Pay when you receive your order</div>
                </div>
              </label>
              <label class="payment-option" for="gcash">
                <input type="radio" id="gcash" name="paymentMethod" value="gcash">
                <div class="payment-icon">üì±</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">GCash</div>
                  <div class="payment-option-desc">Pay securely with GCash</div>
                </div>
              </label>
            </div>
          </div>

          <!-- Order Notes -->
          <div class="checkout-section">
            <h2>Order Notes (Optional)</h2>
            <div class="form-group">
              <label for="notes">Special Instructions</label>
              <textarea id="notes" name="notes" placeholder="Any special delivery instructions..."></textarea>
            </div>
          </div>
        </form>

        <!-- Order Summary -->
        <div class="order-summary">
          <h2>Order Summary</h2>
          <div class="order-items" id="orderItems">
            <!-- Order items will be loaded here -->
          </div>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">‚Ç±0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping">Calculated at checkout</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total">‚Ç±0.00</span>
          </div>
          <button class="place-order-btn" id="placeOrderBtn" onclick="placeOrder()">Place Order</button>
        </div>
      </div>
    </main>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(10,10,10,0.45);align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 6px rgba(0,0,0,0.1)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>

    <script>
      // User dropdown toggle
      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });

      // Logout confirmation function
      function confirmLogout() {
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '{{ url_for("logout") }}';
      }

      // Payment method selection
      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Load cart items and buyer info on page load
      document.addEventListener('DOMContentLoaded', async () => {
        // Fetch buyer name
        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            const firstName = data.firstName;
            const buyerFirstNameEl = document.getElementById('buyerFirstName');
            const buyerInitialEl = document.getElementById('buyerInitial');
            if (buyerFirstNameEl) buyerFirstNameEl.textContent = firstName;
            if (buyerInitialEl) buyerInitialEl.textContent = firstName.charAt(0).toUpperCase();
          })
          .catch(error => console.error('Error fetching buyer name:', error));

        // Load order summary
        await loadOrderSummary();
      });

      // Load order summary from cart
      async function loadOrderSummary() {
        const orderItems = document.getElementById('orderItems');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');

        if (!window.VaronCart) {
          orderItems.innerHTML = '<p>Cart system not loaded</p>';
          return;
        }

        try {
          const items = await VaronCart.get();

          if (!items || items.length === 0) {
            orderItems.innerHTML = '<p>No items in cart</p>';
            subtotalEl.textContent = '‚Ç±0.00';
            totalEl.textContent = '‚Ç±0.00';
            document.getElementById('placeOrderBtn').disabled = true;
            return;
          }

          document.getElementById('placeOrderBtn').disabled = false;

          let subtotal = 0;
          const itemsHtml = items.map(item => {
            const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
            subtotal += itemTotal;

            const sizeColor = [];
            if (item.size) sizeColor.push(`Size: ${item.size}`);
            if (item.color) sizeColor.push(`Color: ${item.color}`);
            const variant = sizeColor.length > 0 ? sizeColor.join(', ') : '';

            return `
              <div class="order-item">
                <div class="order-item-image">
                  <img src="${item.image_url || '/static/images/placeholder.svg'}" alt="${item.name}" onerror="this.src='/static/images/placeholder.svg'">
                </div>
                <div class="order-item-info">
                  <div class="order-item-name">${item.name}</div>
                  ${variant ? `<div class="order-item-details">${variant}</div>` : ''}
                  <div class="order-item-price">‚Ç±${itemTotal.toFixed(2)}</div>
                </div>
              </div>
            `;
          }).join('');

          orderItems.innerHTML = itemsHtml;
          subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
          totalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`; // For now, no shipping calculation

        } catch (error) {
          console.error('Error loading order summary:', error);
          orderItems.innerHTML = '<p>Error loading order summary</p>';
        }
      }

      // Place order function
          placeOrderBtn.textContent = originalText;
        }
      }
    </script>
  </body>
</html>
      }
      .order-totals {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #f0f0f0;
      }
      .order-total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 15px;
      }
      .order-total-row.final {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #e0e0e0;
        font-size: 20px;
        font-weight: 600;
      }
      .place-order-btn {
        width: 100%;
        padding: 18px;
        background: #0a0a0a;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 24px;
      }
      .place-order-btn:hover {
        background: #2d2d2d;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }
      .place-order-btn:active {
        transform: translateY(0);
      }
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #0a0a0a;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 24px;
        transition: all 0.2s;
      }
      .back-link:hover {
        gap: 12px;
      }
      .snackbar {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 10001;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      .snackbar.show {
        visibility: visible;
        animation: fadein 0.3s, fadeout 0.3s 2.7s;
      }
      .snackbar.success {
        background-color: #10b981;
      }
      .snackbar.error {
        background-color: #ef4444;
      }
      @keyframes fadein {
        from { bottom: 0; opacity: 0; }
        to { bottom: 30px; opacity: 1; }
      }
      @keyframes fadeout {
        from { bottom: 30px; opacity: 1; }
        to { bottom: 0; opacity: 0; }
      }
      @media (max-width: 968px) {
        .checkout-container {
          grid-template-columns: 1fr;
          margin-top: 80px;
        }
        .order-summary {
          position: relative;
          top: 0;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
      <h1 class="brand"><a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}" style="color:#fff;text-decoration:none">Var√≥n</a></h1>
      <nav class="top-nav" id="topNav">
        <a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}">Shop</a>
        {% if session.get('logged_in') %}
          <div class="user-dropdown">
            <button class="user-button" onclick="toggleUserDropdown()">
              {{ session.get('first_name', 'User') }} ‚ñæ
            </button>
            <div id="userDropdown" class="dropdown-content">
              <a href="{{ url_for('logout') }}">Logout</a>
            </div>
          </div>
          <span class="welcome-msg" style="color: #fff; font-size: 14px;">Welcome, {{ session.get('first_name', 'User') }}</span>
          <a href="{{ url_for('logout') }}" class="account">Logout</a>
        {% else %}
          <a href="{{ url_for('login') }}" class="account">Login</a>
        {% endif %}
      </nav>
    </header>

    <main class="checkout-container">
      <!-- Checkout Form -->
      <div>
        <a href="javascript:history.back()" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Shopping
        </a>
        
        <div class="checkout-section">
          <h2>Shipping Information</h2>
          
          <!-- Saved Addresses Section -->
          <div id="savedAddressesSection" style="display:none;margin-bottom:24px">
            <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:16px">
              <div>
                <h3 style="margin:0 0 8px;font-size:16px;font-weight:600">Saved Addresses</h3>
                <p style="margin:0;font-size:13px;color:#666">Select a saved address or add a new one</p>
              </div>
              <button type="button" onclick="showNewAddressForm()" style="padding:8px 16px;background:#0a0a0a;color:#fff;border:none;border-radius:6px;cursor:pointer;height:fit-content">
                + Add New Address
              </button>
            </div>
            
            <div id="savedAddressesList" style="display:grid;gap:12px;margin-bottom:24px">
              <!-- Saved addresses will be loaded here -->
            </div>
            
            <!-- Place Order Button for Saved Addresses -->
            <button type="button" onclick="placeOrder()" class="place-order-btn" id="placeOrderWithSaved">
              Place Order
            </button>
          </div>
          
          <!-- New Address Form -->
          <form id="checkoutForm" style="display:none">
            <!-- Back button if user has saved addresses -->
            <div id="backToSavedBtn" style="display:none;margin-bottom:16px">
              <button type="button" onclick="backToSavedAddresses()" style="padding:8px 16px;background:#f3f4f6;border:1px solid #e0e0e0;border-radius:8px;cursor:pointer;font-size:14px">
                ‚Üê Back to Saved Addresses
              </button>
            </div>
            
          <form id="checkoutForm">
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required value="{{ session.get('first_name', '') }}">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required placeholder="+63 XXX XXX XXXX">
            </div>
            
            <div class="form-group">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required placeholder="House No., Building, Street Name">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="province">Province *</label>
                <input type="text" id="province" name="province" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="postalCode">Postal Code *</label>
                <input type="text" id="postalCode" name="postalCode" required>
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="Philippines" selected>Philippines</option>
                  <option value="USA">United States</option>
                  <option value="Canada">Canada</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="notes">Delivery Notes (Optional)</label>
              <textarea id="notes" name="notes" placeholder="Add any special instructions for delivery..."></textarea>
            </div>
          </form>
        </div>

        <div class="checkout-section" style="margin-top: 24px;">
          <h2>Payment Method</h2>
          <div class="payment-method">
            <label class="payment-option selected" onclick="selectPayment('cod')">
              <input type="radio" name="payment" value="cod" checked>
              <span class="payment-icon">üíµ</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Cash on Delivery</div>
                <div class="payment-option-desc">Pay with cash when your order arrives</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('gcash')">
              <input type="radio" name="payment" value="gcash">
              <span class="payment-icon">üì±</span>
              <div class="payment-option-content">
                <div class="payment-option-title">GCash</div>
                <div class="payment-option-desc">Pay securely with GCash mobile wallet</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('paymaya')">
              <input type="radio" name="payment" value="paymaya">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">PayMaya</div>
                <div class="payment-option-desc">Pay securely with PayMaya</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('card')">
              <input type="radio" name="payment" value="card">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Credit/Debit Card</div>
                <div class="payment-option-desc">Visa, Mastercard, or American Express</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="checkout-section order-summary">
        <h2>Order Summary</h2>
        <div id="orderItems">
          <!-- Order items will be inserted here -->
        </div>
        
        <div class="order-totals">
          <div class="order-total-row">
            <span>Subtotal:</span>
            <span id="subtotal">‚Ç±0.00</span>
          </div>
          <div class="order-total-row">
            <span>Shipping:</span>
            <span id="shipping">‚Ç±100.00</span>
          </div>
          <div class="order-total-row final">
            <span>Total:</span>
            <span id="total">‚Ç±0.00</span>
          </div>
        </div>
        
        <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
        
        <p style="text-align:center;color:#666;font-size:13px;margin-top:16px;line-height:1.6">
          By placing your order, you agree to our Terms of Service and Privacy Policy
        </p>
      </div>
    </main>

    <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>

    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>

    <script>
      // User dropdown toggle
      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });

      // Logout confirmation function
      function confirmLogout() {
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '{{ url_for("logout") }}';
      }

      // Payment method selection
      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input[type="radio"]').checked = true;
        });
      });

      // Load cart items and buyer info on page load
      document.addEventListener('DOMContentLoaded', async () => {
        // Fetch buyer name
        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            const firstName = data.firstName;
            const buyerFirstNameEl = document.getElementById('buyerFirstName');
            const buyerInitialEl = document.getElementById('buyerInitial');
            if (buyerFirstNameEl) buyerFirstNameEl.textContent = firstName;
            if (buyerInitialEl) buyerInitialEl.textContent = firstName.charAt(0).toUpperCase();
          })
          .catch(error => console.error('Error fetching buyer name:', error));

        // Load order summary
        await loadOrderSummary();
      });

      // Load order summary from cart
      async function loadOrderSummary() {
        const orderItems = document.getElementById('orderItems');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');

        if (!window.VaronCart) {
          orderItems.innerHTML = '<p>Cart system not loaded</p>';
          return;
        }

        try {
          const items = await VaronCart.get();

          if (!items || items.length === 0) {
            orderItems.innerHTML = '<p>No items in cart</p>';
            subtotalEl.textContent = '‚Ç±0.00';
            totalEl.textContent = '‚Ç±0.00';
            document.getElementById('placeOrderBtn').disabled = true;
            return;
          }

          document.getElementById('placeOrderBtn').disabled = false;

          let subtotal = 0;
          const itemsHtml = items.map(item => {
            const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
            subtotal += itemTotal;

            const sizeColor = [];
            if (item.size) sizeColor.push(`Size: ${item.size}`);
            if (item.color) sizeColor.push(`Color: ${item.color}`);
            const variant = sizeColor.length > 0 ? sizeColor.join(', ') : '';

            return `
              <div class="order-item">
                <div class="order-item-image">
                  <img src="${item.image_url || '/static/images/placeholder.svg'}" alt="${item.name}" onerror="this.src='/static/images/placeholder.svg'">
                </div>
                <div class="order-item-info">
                  <div class="order-item-name">${item.name}</div>
                  ${variant ? `<div class="order-item-details">${variant}</div>` : ''}
                  <div class="order-item-price">‚Ç±${itemTotal.toFixed(2)}</div>
                </div>
              </div>
            `;
          }).join('');

          orderItems.innerHTML = itemsHtml;
          subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
          totalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`; // For now, no shipping calculation

        } catch (error) {
          console.error('Error loading order summary:', error);
          orderItems.innerHTML = '<p>Error loading order summary</p>';
        }
      }

      // Place order function
      async function placeOrder() {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // Get cart items
        if (!window.VaronCart) {
          alert('Cart system not loaded. Please refresh the page.');
          return;
        }

        const cartItems = await VaronCart.get();
        if (!cartItems || cartItems.length === 0) {
          alert('Your cart is empty.');
          return;
        }

        const formData = new FormData(form);

        // Calculate totals
        let subtotal = 0;
        const items = cartItems.map(item => {
          const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
          subtotal += itemTotal;
          return {
            id: item.id,
            name: item.name,
            price: parseFloat(item.price),
            quantity: parseInt(item.quantity),
            size: item.size,
            color: item.color,
            image_url: item.image_url
          };
        });

        const orderData = {
          shipping: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            city: formData.get('city'),
            postalCode: formData.get('postalCode'),
            country: formData.get('country'),
            notes: formData.get('notes')
          },
          payment_method: formData.get('paymentMethod'),
          items: items,
          subtotal: subtotal,
          shipping_fee: 0, // Free shipping for now
          total: subtotal
        };

        // Disable button and show loading
        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const originalText = placeOrderBtn.textContent;
        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Processing...';

        try {
          const response = await fetch('/api/place-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
          });

          const result = await response.json();

          if (result.success) {
            // Clear cart after successful order
            await VaronCart.clear();
            // Redirect to order confirmation
            window.location.href = `/order-confirmation/${result.order_number}`;
          } else {
            alert('Error placing order: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error placing order:', error);
          alert('Error placing order. Please try again.');
        } finally {
          // Re-enable button
          placeOrderBtn.disabled = false;
          placeOrderBtn.textContent = originalText;
        }
      }
    </script>
  </body>
</html>
