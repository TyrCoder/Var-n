<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      body {
        background: #f8f8f8;
      }
      .checkout-container {
        max-width: 1200px;
        margin: 100px auto 60px;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 40px;
      }
      .checkout-section {
        background: #fff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      }
      .checkout-section h2 {
        font-size: 24px;
        margin: 0 0 24px;
        font-weight: 600;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
      }
      .form-group {
        margin-bottom: 24px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #333;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s;
        box-sizing: border-box;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #0a0a0a;
        box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .payment-method {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }
      .payment-option {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
      }
      .payment-option:hover {
        border-color: #0a0a0a;
        background: #f8f8f8;
      }
      .payment-option.selected {
        border-color: #0a0a0a;
        background: #f8f8f8;
        box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
      }
      .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
      }
      .payment-option-content {
        flex: 1;
      }
      .payment-option-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
      }
      .payment-option-desc {
        font-size: 13px;
        color: #666;
      }
      .payment-icon {
        font-size: 28px;
        margin-right: 12px;
      }
      .order-summary {
        position: sticky;
        top: 100px;
        height: fit-content;
      }
      .order-item {
        display: flex;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .order-item:first-child {
        padding-top: 0;
      }
      .order-item-info {
        flex: 1;
      }
      .order-item-info h4 {
        margin: 0 0 6px;
        font-size: 15px;
        font-weight: 600;
      }
      .order-item-info p {
        margin: 0;
        font-size: 14px;
        color: #666;
      }
      .order-item-price {
        font-weight: 600;
        font-size: 16px;
        white-space: nowrap;
      }
      .order-totals {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #f0f0f0;
      }
      .order-total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 15px;
      }
      .order-total-row.final {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #e0e0e0;
        font-size: 20px;
        font-weight: 600;
      }
      .place-order-btn {
        width: 100%;
        padding: 18px;
        background: #0a0a0a;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 24px;
      }
      .place-order-btn:hover {
        background: #2d2d2d;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }
      .place-order-btn:active {
        transform: translateY(0);
      }
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #0a0a0a;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 24px;
        transition: all 0.2s;
      }
      .back-link:hover {
        gap: 12px;
      }
      .snackbar {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 10001;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      .snackbar.show {
        visibility: visible;
        animation: fadein 0.3s, fadeout 0.3s 2.7s;
      }
      .snackbar.success {
        background-color: #10b981;
      }
      .snackbar.error {
        background-color: #ef4444;
      }
      @keyframes fadein {
        from { bottom: 0; opacity: 0; }
        to { bottom: 30px; opacity: 1; }
      }
      @keyframes fadeout {
        from { bottom: 30px; opacity: 1; }
        to { bottom: 0; opacity: 0; }
      }
      @media (max-width: 968px) {
        .checkout-container {
          grid-template-columns: 1fr;
          margin-top: 80px;
        }
        .order-summary {
          position: relative;
          top: 0;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
      <h1 class="brand"><a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}" style="color:#fff;text-decoration:none">Var√≥n</a></h1>
      <nav class="top-nav" id="topNav">
        <a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}">Shop</a>
        {% if session.get('logged_in') %}
<<<<<<< HEAD
          <div class="user-dropdown">
            <button class="user-button" onclick="toggleUserDropdown()">
              {{ session.get('first_name', 'User') }} ‚ñæ
            </button>
            <div id="userDropdown" class="dropdown-content">
              <a href="{{ url_for('logout') }}">Logout</a>
            </div>
          </div>
=======
          <span class="welcome-msg" style="color: #fff; font-size: 14px;">Welcome, {{ session.get('first_name', 'User') }}</span>
          <a href="{{ url_for('logout') }}" class="account">Logout</a>
>>>>>>> parent of 1c35c95 (malapit na mga bes)
        {% else %}
          <a href="{{ url_for('login') }}" class="account">Login</a>
        {% endif %}
      </nav>
    </header>

    <main class="checkout-container">
      <!-- Checkout Form -->
      <div>
        <a href="javascript:history.back()" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Shopping
        </a>
        
        <div class="checkout-section">
          <h2>Shipping Information</h2>
<<<<<<< HEAD
          
          <!-- Saved Addresses Section -->
          <div id="savedAddressesSection" style="display:none;margin-bottom:24px">
            <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:16px">
              <div>
                <h3 style="margin:0 0 8px;font-size:16px;font-weight:600">Saved Addresses</h3>
                <p style="margin:0;font-size:13px;color:#666">Select a saved address or add a new one</p>
              </div>
              <button type="button" onclick="showNewAddressForm()" style="padding:8px 16px;background:#0a0a0a;color:#fff;border:none;border-radius:6px;cursor:pointer;height:fit-content">
                + Add New Address
              </button>
            </div>
            
            <div id="savedAddressesList" style="display:grid;gap:12px;margin-bottom:24px">
              <!-- Saved addresses will be loaded here -->
            </div>
            
            <!-- Place Order Button for Saved Addresses -->
            <button type="button" onclick="placeOrder()" class="place-order-btn" id="placeOrderWithSaved">
              Place Order
            </button>
          </div>
          
          <!-- New Address Form -->
          <form id="checkoutForm" style="display:none">
            <!-- Back button if user has saved addresses -->
            <div id="backToSavedBtn" style="display:none;margin-bottom:16px">
              <button type="button" onclick="backToSavedAddresses()" style="padding:8px 16px;background:#f3f4f6;border:1px solid #e0e0e0;border-radius:8px;cursor:pointer;font-size:14px">
                ‚Üê Back to Saved Addresses
              </button>
            </div>
            
=======
          <form id="checkoutForm">
>>>>>>> parent of 1c35c95 (malapit na mga bes)
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required value="{{ session.get('first_name', '') }}">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required placeholder="+63 XXX XXX XXXX">
            </div>
            
            <div class="form-group">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required placeholder="House No., Building, Street Name">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="province">Province *</label>
                <input type="text" id="province" name="province" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="postalCode">Postal Code *</label>
                <input type="text" id="postalCode" name="postalCode" required>
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="Philippines" selected>Philippines</option>
                  <option value="USA">United States</option>
                  <option value="Canada">Canada</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="notes">Delivery Notes (Optional)</label>
              <textarea id="notes" name="notes" placeholder="Add any special instructions for delivery..."></textarea>
            </div>
          </form>
        </div>

        <div class="checkout-section" style="margin-top: 24px;">
          <h2>Payment Method</h2>
          <div class="payment-method">
            <label class="payment-option selected" onclick="selectPayment('cod')">
              <input type="radio" name="payment" value="cod" checked>
              <span class="payment-icon">üíµ</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Cash on Delivery</div>
                <div class="payment-option-desc">Pay with cash when your order arrives</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('gcash')">
              <input type="radio" name="payment" value="gcash">
              <span class="payment-icon">üì±</span>
              <div class="payment-option-content">
                <div class="payment-option-title">GCash</div>
                <div class="payment-option-desc">Pay securely with GCash mobile wallet</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('paymaya')">
              <input type="radio" name="payment" value="paymaya">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">PayMaya</div>
                <div class="payment-option-desc">Pay securely with PayMaya</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('card')">
              <input type="radio" name="payment" value="card">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Credit/Debit Card</div>
                <div class="payment-option-desc">Visa, Mastercard, or American Express</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="checkout-section order-summary">
        <h2>Order Summary</h2>
        <div id="orderItems">
          <!-- Order items will be inserted here -->
        </div>
        
        <div class="order-totals">
          <div class="order-total-row">
            <span>Subtotal:</span>
            <span id="subtotal">‚Ç±0.00</span>
          </div>
          <div class="order-total-row">
            <span>Shipping:</span>
            <span id="shipping">‚Ç±100.00</span>
          </div>
          <div class="order-total-row final">
            <span>Total:</span>
            <span id="total">‚Ç±0.00</span>
          </div>
        </div>
        
        <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
        
        <p style="text-align:center;color:#666;font-size:13px;margin-top:16px;line-height:1.6">
          By placing your order, you agree to our Terms of Service and Privacy Policy
        </p>
      </div>
    </main>

    <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
      // Get cart - try both possible keys
      function getCart() {
        try {
          // Try varon_cart first (new key)
          let cartData = localStorage.getItem('varon_cart');
          if (cartData) {
            return JSON.parse(cartData);
          }
          // Fallback to cart if it exists
          cartData = localStorage.getItem('cart');
          if (cartData) {
            return JSON.parse(cartData);
          }
          return {};
        } catch (e) {
          console.error('Error reading cart:', e);
          return {};
        }
      }

      let cart = getCart();
      let validatedCart = [];
      let selectedPayment = 'cod';
      const shippingFee = 100;

      // Debug: log cart contents
      console.log('Cart contents:', cart);
      console.log('Cart type:', Array.isArray(cart) ? 'Array' : 'Object');
      console.log('Cart length:', Array.isArray(cart) ? cart.length : Object.keys(cart).length);

      // Check if cart is empty (handle both array and object formats)
      const cartIsEmpty = Array.isArray(cart) 
        ? cart.length === 0 
        : Object.keys(cart).filter(key => cart[key] && (cart[key].qty > 0 || cart[key].quantity > 0)).length === 0;
      
      if (cartIsEmpty) {
        setTimeout(() => {
          alert('Your cart is empty. Please add items before checking out.');
          window.location.href = '{{ url_for("buyer_dashboard") if session.get("logged_in") and session.get("role") == "buyer" else url_for("index") }}';
        }, 100);
      } else {
        // Validate cart with database
        validateCartWithDatabase();
      }

      // Validate cart items with database
      function validateCartWithDatabase() {
        // Convert cart to array format for API
        let cartArray;
        if (Array.isArray(cart)) {
          cartArray = cart.map(item => ({
            id: item.id || item.product_id,
            quantity: parseInt(item.quantity || item.qty) || 1,
            size: item.size || '',
            color: item.color || ''
          }));
        } else {
          cartArray = Object.entries(cart).map(([id, item]) => ({
            id: item.product_id || id,
            quantity: parseInt(item.qty || item.quantity) || 1,
            size: item.size || '',
            color: item.color || ''
          }));
        }

        console.log('üì§ Sending cart for validation:', cartArray);

        fetch('/api/validate-cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ items: cartArray })
        })
        .then(response => {
          console.log('üì• Validation response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('üì• Validation response data:', data);
          if (data.success && data.items) {
            validatedCart = data.items;
            console.log('‚úÖ Cart validated successfully:', validatedCart);
            displayOrderSummary();
          } else {
            console.error('‚ùå Failed to validate cart:', data.error);
            // Fallback to localStorage cart
            console.log('‚ö†Ô∏è  Falling back to localStorage cart');
            displayOrderSummary();
          }
        })
        .catch(error => {
          console.error('‚ùå Error validating cart:', error);
          // Fallback to displaying from localStorage
          console.log('‚ö†Ô∏è  Falling back to localStorage cart due to error');
          displayOrderSummary();
        });
      }

      function displayOrderSummary() {
        const orderItems = document.getElementById('orderItems');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        
        // Use validated cart from database if available, otherwise use localStorage cart
        let cartArray;
        if (validatedCart.length > 0) {
          cartArray = validatedCart;
        } else {
          // Fallback to localStorage cart
          if (Array.isArray(cart)) {
            cartArray = cart.map(item => ({
              id: item.id || item.product_id,
              name: item.name || item.title || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.quantity || item.qty) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          } else {
            cartArray = Object.entries(cart).map(([id, item]) => ({
              id: item.product_id || id,
              name: item.title || item.name || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.qty || item.quantity) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          }
        }
        
        // Display items with stock information
        orderItems.innerHTML = cartArray.map(item => `
          <div class="order-item">
            <div class="order-item-info">
              <h4>${item.name}</h4>
              ${item.size || item.color ? `<p style="color:#666;font-size:13px;">${[item.size, item.color].filter(Boolean).join(', ')}</p>` : ''}
              ${item.seller_name ? `<p style="color:#999;font-size:12px;">Sold by: ${item.seller_name}</p>` : ''}
              <p>Quantity: ${item.quantity}</p>
              ${item.stock_available !== undefined && item.stock_available < item.quantity ? `<p style="color:#dc2626;font-size:12px;">‚ö†Ô∏è Only ${item.stock_available} in stock</p>` : ''}
              <p>‚Ç±${item.price.toFixed(2)} each</p>
            </div>
            <div class="order-item-price">
              ‚Ç±${(item.price * item.quantity).toFixed(2)}
            </div>
          </div>
        `).join('');
        
        // Calculate totals
        const subtotal = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + shippingFee;
        
        subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
        totalEl.textContent = `‚Ç±${total.toFixed(2)}`;
      }

      function selectPayment(method) {
        selectedPayment = method;
        const options = document.querySelectorAll('.payment-option');
        options.forEach(opt => opt.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
      }

      function showSnackbar(message, type = 'success') {
        const snackbar = document.getElementById('snackbar');
        snackbar.textContent = message;
        snackbar.className = 'snackbar show ' + type;
        setTimeout(() => {
          snackbar.classList.remove('show');
        }, 3000);
      }

      function placeOrder() {
<<<<<<< HEAD
<<<<<<< HEAD
        console.log('üõí Place Order clicked');
        console.log('üì¶ Validated cart:', validatedCart);
        console.log('üè† Selected address ID:', selectedAddressId);
        console.log('üí≥ Selected payment method:', selectedPayment);
        
=======
>>>>>>> parent of 5ad2f62 (latest code)
        // Check if cart is empty
        if (!validatedCart || validatedCart.length === 0) {
          alert('Your cart is empty. Please add items before placing an order.');
=======
        const form = document.getElementById('checkoutForm');
        
        // Validate form
        if (!form.checkValidity()) {
          form.reportValidity();
>>>>>>> parent of 1c35c95 (malapit na mga bes)
          return;
        }
        
        // Get form data
        const formData = new FormData(form);
        
        // Use validated cart from database for accurate pricing
        let cartArray = validatedCart.length > 0 ? validatedCart : [];
        
        // Fallback if validation failed
        if (cartArray.length === 0) {
          if (Array.isArray(cart)) {
            cartArray = cart.map(item => ({
              id: item.id || item.product_id,
              name: item.name || item.title || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.quantity || item.qty) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          } else {
            cartArray = Object.entries(cart).map(([id, item]) => ({
              id: item.product_id || id,
              name: item.title || item.name || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.qty || item.quantity) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          }
        }
        
        const subtotal = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + shippingFee;
        
        const orderData = {
          shipping: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            barangay: formData.get('barangay') || '',
            city: formData.get('city'),
            province: formData.get('province'),
            postalCode: formData.get('postalCode'),
            country: formData.get('country'),
            notes: formData.get('notes') || ''
          },
          payment_method: selectedPayment,
          payment_provider: null,
          items: cartArray,
          subtotal: subtotal,
          shipping_fee: shippingFee,
          total: total
        };
        
        // Disable button
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        // Submit order
        fetch('/api/place-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSnackbar('Order placed successfully!', 'success');
            
<<<<<<< HEAD
            // Show save address prompt if using manual entry and no saved addresses
            if (usingManualEntry && savedAddresses.length === 0) {
              showSaveAddressPrompt();
            }
            
<<<<<<< HEAD
            // Clear cart from localStorage
=======
            // Clear cart
>>>>>>> parent of 1c35c95 (malapit na mga bes)
=======
            // Clear cart
>>>>>>> parent of 5ad2f62 (latest code)
            localStorage.removeItem('varon_cart');
            
            // Update cart badge
            if (typeof updateCartBadge === 'function') {
              updateCartBadge();
            }
            
            // Redirect to order confirmation
            setTimeout(() => {
              window.location.href = '/order-confirmation/' + data.order_number;
            }, 1500);
          } else {
            showSnackbar(data.message || 'Failed to place order', 'error');
            btn.disabled = false;
            btn.textContent = 'Place Order';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showSnackbar('An error occurred. Please try again.', 'error');
          btn.disabled = false;
          btn.textContent = 'Place Order';
        });
      }

      // Initialize
      displayOrderSummary();
<<<<<<< HEAD

      // User dropdown toggle
      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });
=======
>>>>>>> parent of 1c35c95 (malapit na mga bes)
    </script>
  </body>
</html>
