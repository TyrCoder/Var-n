<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      .user-dropdown {
        position: relative;
        display: inline-block;
      }
      .user-button {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .user-button:hover {
        background: rgba(255,255,255,0.1);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: #fff;
        min-width: 160px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        margin-top: 8px;
        z-index: 1000;
        overflow: hidden;
      }
      .dropdown-content.show {
        display: block;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        transition: background 0.2s;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }
      /* Floating Cart Button */
      .floating-cart {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: #0a0a0a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 999;
        transition: all 0.3s ease;
      }
      .floating-cart:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      }
      .floating-cart svg {
        width: 24px;
        height: 24px;
        fill: #fff;
      }
      .floating-cart-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: #fff;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        border: 2px solid #fff;
      }
      @media (max-width: 768px) {
        .floating-cart {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
        }
        .floating-cart svg {
          width: 20px;
          height: 20px;
        }
      }
    </style>
    <style>
      body {
        background: #f8f8f8;
      }
      .checkout-container {
        max-width: 1200px;
        margin: 100px auto 60px;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 40px;
      }
      .checkout-section {
        background: #fff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      }
      .checkout-section h2 {
        font-size: 24px;
        margin: 0 0 24px;
        font-weight: 600;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
      }
      .form-group {
        margin-bottom: 24px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #333;
      }
      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s;
        box-sizing: border-box;
      }
      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #0a0a0a;
        box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
      }
      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      .payment-method {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }
      .payment-option {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
      }
      .payment-option:hover {
        border-color: #0a0a0a;
        background: #f8f8f8;
      }
      .payment-option.selected {
        border-color: #0a0a0a;
        background: #f8f8f8;
        box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
      }
      .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 12px;
        cursor: pointer;
      }
      .payment-option-content {
        flex: 1;
      }
      .payment-option-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
      }
      .payment-option-desc {
        font-size: 13px;
        color: #666;
      }
      .payment-icon {
        font-size: 28px;
        margin-right: 12px;
      }
      .order-summary {
        position: sticky;
        top: 100px;
        height: fit-content;
      }
      .order-item {
        display: flex;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .order-item:first-child {
        padding-top: 0;
      }
      .order-item-info {
        flex: 1;
      }
      .order-item-info h4 {
        margin: 0 0 6px;
        font-size: 15px;
        font-weight: 600;
      }
      .order-item-info p {
        margin: 0;
        font-size: 14px;
        color: #666;
      }
      .order-item-price {
        font-weight: 600;
        font-size: 16px;
        white-space: nowrap;
      }
      .order-totals {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #f0f0f0;
      }
      .order-total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 15px;
      }
      .order-total-row.final {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 2px solid #e0e0e0;
        font-size: 20px;
        font-weight: 600;
      }
      /* Address Cards */
      .address-card {
        padding: 16px;
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        background: #fff;
      }
      .address-card:hover {
        border-color: #0a0a0a;
        background: #f8f8f8;
      }
      .address-card.selected {
        border-color: #0a0a0a;
        background: #f8f8f8;
        box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
      }
      .address-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 8px;
      }
      .address-card-name {
        font-weight: 600;
        font-size: 16px;
      }
      .address-card-default {
        background: #10b981;
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
      }
      .address-card-details {
        font-size: 14px;
        color: #666;
        line-height: 1.6;
      }
      .address-card-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
      }
      .address-card-actions button {
        padding: 6px 12px;
        font-size: 12px;
        border: 1px solid #ddd;
        background: #fff;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .address-card-actions button:hover {
        background: #f3f4f6;
        border-color: #0a0a0a;
      }
      .address-card-actions button.delete {
        color: #ef4444;
        border-color: #ef4444;
      }
      .address-card-actions button.delete:hover {
        background: #fef2f2;
      }
      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      }
      .modal-content {
        background: #fff;
        padding: 32px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }
      .modal-header h3 {
        margin: 0;
        font-size: 20px;
      }
      .modal-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #666;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
      }
      .modal-actions {
        display: flex;
        gap: 12px;
        margin-top: 24px;
      }
      .modal-actions button {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      .modal-actions .btn-cancel {
        background: #f3f4f6;
        border: 1px solid #e0e0e0;
        color: #0a0a0a;
      }
      .modal-actions .btn-confirm {
        background: #0a0a0a;
        border: none;
        color: #fff;
      }
      /* Saved Addresses Grid */
      #savedAddressesList {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 12px;
      }
      @media (max-width: 768px) {
        #savedAddressesList {
          grid-template-columns: 1fr;
        }
      }
      .place-order-btn {
        width: 100%;
        padding: 18px;
        background: #0a0a0a;
        color: #fff;
        border: none;
        border-radius: 12px;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 24px;
      }
      .place-order-btn:hover {
        background: #2d2d2d;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      }
      .place-order-btn:active {
        transform: translateY(0);
      }
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #0a0a0a;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 24px;
        transition: all 0.2s;
      }
      .back-link:hover {
        gap: 12px;
      }
      .snackbar {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 10001;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      .snackbar.show {
        visibility: visible;
        animation: fadein 0.3s, fadeout 0.3s 2.7s;
      }
      .snackbar.success {
        background-color: #10b981;
      }
      .snackbar.error {
        background-color: #ef4444;
      }
      @keyframes fadein {
        from { bottom: 0; opacity: 0; }
        to { bottom: 30px; opacity: 1; }
      }
      @keyframes fadeout {
        from { bottom: 30px; opacity: 1; }
        to { bottom: 0; opacity: 0; }
      }
      @media (max-width: 968px) {
        .checkout-container {
          grid-template-columns: 1fr;
          margin-top: 80px;
        }
        .order-summary {
          position: relative;
          top: 0;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
      <h1 class="brand"><a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}" style="color:#fff;text-decoration:none">Var√≥n</a></h1>
      <nav class="top-nav" id="topNav">
        <a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}">Shop</a>
        {% if session.get('logged_in') %}
          <div class="user-dropdown">
            <button class="user-button" onclick="toggleUserDropdown()">
              {{ session.get('first_name', 'User') }} ‚ñæ
            </button>
            <div id="userDropdown" class="dropdown-content">
              <a href="{{ url_for('logout') }}">Logout</a>
            </div>
          </div>
        {% else %}
          <a href="{{ url_for('login') }}" class="account">Login</a>
        {% endif %}
      </nav>
    </header>

    <main class="checkout-container">
      <!-- Checkout Form -->
      <div>
        <a href="javascript:history.back()" class="back-link">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Back to Shopping
        </a>
        
        <div class="checkout-section">
          <h2>Shipping Information</h2>
          
          <!-- Saved Addresses Section -->
          <div id="savedAddressesSection" style="display:none;margin-bottom:24px">
            <div style="display:grid;grid-template-columns:1fr auto;gap:16px;margin-bottom:16px">
              <div>
                <h3 style="margin:0 0 8px;font-size:16px;font-weight:600">Saved Addresses</h3>
                <p style="margin:0;font-size:13px;color:#666">Select a saved address or add a new one</p>
              </div>
              <button type="button" onclick="showNewAddressForm()" style="padding:8px 16px;background:#0a0a0a;color:#fff;border:none;border-radius:6px;cursor:pointer;height:fit-content">
                + Add New Address
              </button>
            </div>
            
            <div id="savedAddressesList" style="display:grid;gap:12px;margin-bottom:24px">
              <!-- Saved addresses will be loaded here -->
            </div>
            
            <!-- Place Order Button for Saved Addresses -->
            <button type="button" onclick="placeOrder()" class="place-order-btn" id="placeOrderWithSaved">
              Place Order
            </button>
          </div>
          
          <!-- New Address Form -->
          <form id="checkoutForm" style="display:none">
            <!-- Back button if user has saved addresses -->
            <div id="backToSavedBtn" style="display:none;margin-bottom:16px">
              <button type="button" onclick="backToSavedAddresses()" style="padding:8px 16px;background:#f3f4f6;border:1px solid #e0e0e0;border-radius:8px;cursor:pointer;font-size:14px">
                ‚Üê Back to Saved Addresses
              </button>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required value="{{ session.get('first_name', '') }}">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required placeholder="+63 XXX XXX XXXX">
            </div>
            
            <div class="form-group">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required placeholder="House No., Building, Street Name">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="province">Province *</label>
                <input type="text" id="province" name="province" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label for="postalCode">Postal Code *</label>
                <input type="text" id="postalCode" name="postalCode" required>
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="Philippines" selected>Philippines</option>
                  <option value="USA">United States</option>
                  <option value="Canada">Canada</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <label for="notes">Delivery Notes (Optional)</label>
              <textarea id="notes" name="notes" placeholder="Add any special instructions for delivery..."></textarea>
            </div>
          </form>
        </div>

        <div class="checkout-section" style="margin-top: 24px;">
          <h2>Payment Method</h2>
          <div class="payment-method">
            <label class="payment-option selected" onclick="selectPayment('cod')">
              <input type="radio" name="payment" value="cod" checked>
              <span class="payment-icon">üíµ</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Cash on Delivery</div>
                <div class="payment-option-desc">Pay with cash when your order arrives</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('gcash')">
              <input type="radio" name="payment" value="gcash">
              <span class="payment-icon">üì±</span>
              <div class="payment-option-content">
                <div class="payment-option-title">GCash</div>
                <div class="payment-option-desc">Pay securely with GCash mobile wallet</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('paymaya')">
              <input type="radio" name="payment" value="paymaya">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">PayMaya</div>
                <div class="payment-option-desc">Pay securely with PayMaya</div>
              </div>
            </label>
            
            <label class="payment-option" onclick="selectPayment('card')">
              <input type="radio" name="payment" value="card">
              <span class="payment-icon">üí≥</span>
              <div class="payment-option-content">
                <div class="payment-option-title">Credit/Debit Card</div>
                <div class="payment-option-desc">Visa, Mastercard, or American Express</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Order Summary -->
      <div class="checkout-section order-summary">
        <h2>Order Summary</h2>
        <div id="orderItems">
          <!-- Order items will be inserted here -->
        </div>
        
        <div class="order-totals">
          <div class="order-total-row">
            <span>Subtotal:</span>
            <span id="subtotal">‚Ç±0.00</span>
          </div>
          <div class="order-total-row">
            <span>Shipping:</span>
            <span id="shipping">‚Ç±100.00</span>
          </div>
          <div class="order-total-row final">
            <span>Total:</span>
            <span id="total">‚Ç±0.00</span>
          </div>
        </div>
        
        <button class="place-order-btn" onclick="placeOrder()">Place Order</button>
        
        <p style="text-align:center;color:#666;font-size:13px;margin-top:16px;line-height:1.6">
          By placing your order, you agree to our Terms of Service and Privacy Policy
        </p>
      </div>
    </main>

    <div id="snackbar" class="snackbar" role="status" aria-live="polite"></div>

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <script>
      let validatedCart = [];
      let selectedPayment = 'cod';
      const shippingFee = 100;
      let savedAddresses = [];
      let selectedAddressId = null;
      let hasShownSavePrompt = false;

      // Load saved addresses on page load
      function loadSavedAddresses() {
        fetch('/api/addresses/get')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.addresses) {
              savedAddresses = data.addresses;
              if (savedAddresses.length > 0) {
                displaySavedAddresses();
                document.getElementById('savedAddressesSection').style.display = 'block';
              } else {
                // Show form directly if no saved addresses
                document.getElementById('checkoutForm').style.display = 'block';
              }
            } else {
              document.getElementById('checkoutForm').style.display = 'block';
            }
          })
          .catch(error => {
            console.error('Error loading addresses:', error);
            document.getElementById('checkoutForm').style.display = 'block';
          });
      }

      function displaySavedAddresses() {
        const container = document.getElementById('savedAddressesList');
        let html = '';
        
        savedAddresses.forEach(address => {
          const isSelected = selectedAddressId === address.id;
          html += `
            <div class="address-card ${isSelected ? 'selected' : ''}" 
                 data-address-id="${address.id}"
                 onclick="selectAddress(${address.id}, this)">
              <div class="address-card-header">
                <div class="address-card-name">${address.full_name}</div>
                ${address.is_default ? '<span class="address-card-default">DEFAULT</span>' : ''}
              </div>
              <div class="address-card-details">
                ${address.phone}<br>
                ${address.street_address}<br>
                ${address.barangay ? address.barangay + ', ' : ''}${address.city}, ${address.province} ${address.postal_code || ''}
              </div>
              <div class="address-card-actions" onclick="event.stopPropagation()">
                <button onclick="deleteAddress(${address.id});" class="delete">Delete</button>
              </div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
        // Auto-select default address
        const defaultAddress = savedAddresses.find(a => a.is_default);
        if (defaultAddress && !selectedAddressId) {
          selectAddress(defaultAddress.id);
        }
      }

      function selectAddress(addressId, clickedElement) {
        selectedAddressId = addressId;
        document.querySelectorAll('.address-card').forEach(card => {
          card.classList.remove('selected');
        });
        
        // If called from click event, highlight the clicked element
        if (clickedElement) {
          clickedElement.classList.add('selected');
        } else {
          // If called programmatically, find and highlight by address ID
          const cards = document.querySelectorAll('.address-card');
          cards.forEach(card => {
            if (card.getAttribute('data-address-id') == addressId) {
              card.classList.add('selected');
            }
          });
        }
      }

      function showNewAddressForm() {
        document.getElementById('savedAddressesSection').style.display = 'none';
        document.getElementById('checkoutForm').style.display = 'block';
        
        // Show back button if user has saved addresses
        if (savedAddresses.length > 0) {
          document.getElementById('backToSavedBtn').style.display = 'block';
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function backToSavedAddresses() {
        document.getElementById('checkoutForm').style.display = 'none';
        document.getElementById('backToSavedBtn').style.display = 'none';
        document.getElementById('savedAddressesSection').style.display = 'block';
        
        // Reselect default address if none selected
        if (!selectedAddressId) {
          const defaultAddress = savedAddresses.find(a => a.is_default);
          if (defaultAddress) {
            selectAddress(defaultAddress.id);
          }
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function deleteAddress(addressId) {
        if (!confirm('Are you sure you want to delete this address?')) return;
        
        fetch(`/api/addresses/delete/${addressId}`, {
          method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSnackbar('Address deleted successfully');
            loadSavedAddresses();
          } else {
            alert('Failed to delete address: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error deleting address:', error);
          alert('Error deleting address');
        });
      }

      function showSaveAddressPrompt() {
        if (hasShownSavePrompt || savedAddresses.length > 0) return;
        hasShownSavePrompt = true;
        
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h3>üíæ Save Shipping Address?</h3>
              <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
            </div>
            <p style="margin:0 0 24px;color:#666;line-height:1.6">
              Would you like to save this shipping address for faster checkout next time?
            </p>
            <div class="modal-actions">
              <button class="btn-cancel" onclick="this.closest('.modal-overlay').remove()">Not Now</button>
              <button class="btn-confirm" onclick="saveCurrentAddress()">Yes, Save Address</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }

      function saveCurrentAddress() {
        const form = document.getElementById('checkoutForm');
        const formData = new FormData(form);
        
        const addressData = {
          full_name: `${formData.get('firstName')} ${formData.get('lastName')}`,
          phone: formData.get('phone'),
          street_address: formData.get('address'),
          barangay: '',
          city: formData.get('city'),
          province: formData.get('province'),
          postal_code: formData.get('postalCode'),
          country: formData.get('country'),
          is_default: savedAddresses.length === 0 // Set as default if it's the first address
        };
        
        fetch('/api/addresses/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(addressData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSnackbar('‚úÖ Address saved successfully!');
            document.querySelector('.modal-overlay').remove();
          } else {
            alert('Failed to save address: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error saving address:', error);
          alert('Error saving address');
        });
      }

      // Initialize
      loadSavedAddresses();

      // Load cart from database
      fetch('/api/cart/get')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.items && data.items.length > 0) {
            validateCartWithDatabase(data.items);
          } else {
            alert('Your cart is empty. Please add items before checking out.');
            window.location.href = '{{ url_for("buyer_dashboard") if session.get("logged_in") and session.get("role") == "buyer" else url_for("index") }}';
          }
        })
        .catch(error => {
          console.error('Error loading cart:', error);
          alert('Error loading cart. Please try again.');
          window.location.href = '{{ url_for("buyer_dashboard") if session.get("logged_in") and session.get("role") == "buyer" else url_for("index") }}';
        });

      // Validate cart items with database
      function validateCartWithDatabase(cartItems) {
        // Cart items already from database, just use them directly
        let cartArray = cartItems.map(item => ({
          id: item.id || item.product_id,
          quantity: parseInt(item.quantity) || 1,
          size: item.size || '',
          color: item.color || '',
          cart_id: item.cart_id
        }));

        console.log('üì§ Sending cart for validation:', cartArray);

        fetch('/api/validate-cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ items: cartArray })
        })
        .then(response => {
          console.log('üì• Validation response status:', response.status);
          return response.json();
        })
        .then(data => {
          console.log('üì• Validation response data:', data);
          if (data.success && data.items) {
            validatedCart = data.items;
            console.log('‚úÖ Cart validated successfully:', validatedCart);
            displayOrderSummary();
          } else {
            console.error('‚ùå Failed to validate cart:', data.error);
            // Fallback to localStorage cart
            console.log('‚ö†Ô∏è  Falling back to localStorage cart');
            displayOrderSummary();
          }
        })
        .catch(error => {
          console.error('‚ùå Error validating cart:', error);
          // Fallback to displaying from localStorage
          console.log('‚ö†Ô∏è  Falling back to localStorage cart due to error');
          displayOrderSummary();
        });
      }

      function displayOrderSummary() {
        const orderItems = document.getElementById('orderItems');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        
        // Use validated cart from database if available, otherwise use localStorage cart
        let cartArray;
        if (validatedCart.length > 0) {
          cartArray = validatedCart;
        } else {
          // Fallback to localStorage cart
          if (Array.isArray(cart)) {
            cartArray = cart.map(item => ({
              id: item.id || item.product_id,
              name: item.name || item.title || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.quantity || item.qty) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          } else {
            cartArray = Object.entries(cart).map(([id, item]) => ({
              id: item.product_id || id,
              name: item.title || item.name || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.qty || item.quantity) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          }
        }
        
        // Display items with stock information
        orderItems.innerHTML = cartArray.map(item => `
          <div class="order-item">
            <div class="order-item-info">
              <h4>${item.name}</h4>
              ${item.size || item.color ? `<p style="color:#666;font-size:13px;">${[item.size, item.color].filter(Boolean).join(', ')}</p>` : ''}
              ${item.seller_name ? `<p style="color:#999;font-size:12px;">Sold by: ${item.seller_name}</p>` : ''}
              <p>Quantity: ${item.quantity}</p>
              ${item.stock_available !== undefined && item.stock_available < item.quantity ? `<p style="color:#dc2626;font-size:12px;">‚ö†Ô∏è Only ${item.stock_available} in stock</p>` : ''}
              <p>‚Ç±${item.price.toFixed(2)} each</p>
            </div>
            <div class="order-item-price">
              ‚Ç±${(item.price * item.quantity).toFixed(2)}
            </div>
          </div>
        `).join('');
        
        // Calculate totals
        const subtotal = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + shippingFee;
        
        subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
        totalEl.textContent = `‚Ç±${total.toFixed(2)}`;
      }

      function selectPayment(method) {
        selectedPayment = method;
        const options = document.querySelectorAll('.payment-option');
        options.forEach(opt => opt.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
      }

      function showSnackbar(message, type = 'success') {
        const snackbar = document.getElementById('snackbar');
        snackbar.textContent = message;
        snackbar.className = 'snackbar show ' + type;
        setTimeout(() => {
          snackbar.classList.remove('show');
        }, 3000);
      }

      function placeOrder() {
        // Check if cart is empty
        if (!validatedCart || validatedCart.length === 0) {
          alert('Your cart is empty. Please add items before placing an order.');
          return;
        }
        
        // Check if using saved address or manual form
        let shippingData = {};
        let usingManualEntry = false;
        
        if (selectedAddressId) {
          // Use saved address
          const address = savedAddresses.find(a => a.id === selectedAddressId);
          if (!address) {
            alert('Please select a shipping address');
            return;
          }
          
          const nameParts = address.full_name.split(' ');
          const firstName = nameParts[0] || '';
          const lastName = nameParts.slice(1).join(' ') || '';
          
          shippingData = {
            firstName: firstName,
            lastName: lastName,
            email: '{{ session.email }}', // Use session email
            phone: address.phone,
            address: address.street_address,
            barangay: address.barangay || '',
            city: address.city,
            province: address.province,
            postalCode: address.postal_code || '',
            country: address.country,
            notes: ''
          };
        } else {
          // Use manual form entry
          const form = document.getElementById('checkoutForm');
          
          // Check if form is visible/being used
          if (form.style.display === 'none' && savedAddresses.length > 0) {
            alert('Please select a saved address or click "Add New Address" to enter shipping details.');
            return;
          }
          
          // Validate form
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }
          
          const formData = new FormData(form);
          shippingData = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            barangay: formData.get('barangay') || '',
            city: formData.get('city'),
            province: formData.get('province'),
            postalCode: formData.get('postalCode'),
            country: formData.get('country'),
            notes: formData.get('notes') || ''
          };
          usingManualEntry = true;
        }
        
        // Use validated cart from database for accurate pricing
        let cartArray = validatedCart.length > 0 ? validatedCart : [];
        
        // Fallback if validation failed
        if (cartArray.length === 0) {
          if (Array.isArray(cart)) {
            cartArray = cart.map(item => ({
              id: item.id || item.product_id,
              name: item.name || item.title || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.quantity || item.qty) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          } else {
            cartArray = Object.entries(cart).map(([id, item]) => ({
              id: item.product_id || id,
              name: item.title || item.name || 'Product',
              price: parseFloat(item.price) || 0,
              quantity: parseInt(item.qty || item.quantity) || 1,
              size: item.size || '',
              color: item.color || ''
            }));
          }
        }
        
        const subtotal = cartArray.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const total = subtotal + shippingFee;
        
        const orderData = {
          shipping: shippingData,
          payment_method: selectedPayment,
          payment_provider: null,
          items: cartArray,
          subtotal: subtotal,
          shipping_fee: shippingFee,
          total: total
        };
        
        // Disable button
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = 'Processing...';
        
        // Submit order
        fetch('/api/place-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData)
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSnackbar('Order placed successfully!', 'success');
            
            // Show save address prompt if using manual entry and no saved addresses
            if (usingManualEntry && savedAddresses.length === 0) {
              showSaveAddressPrompt();
            }
            
            // Clear cart
            localStorage.removeItem('varon_cart');
            
            // Update cart badge
            if (typeof updateCartBadge === 'function') {
              updateCartBadge();
            }
            
            // Redirect to order confirmation
            setTimeout(() => {
              window.location.href = '/order-confirmation/' + data.order_number;
            }, usingManualEntry && savedAddresses.length === 0 ? 3000 : 1500);
          } else {
            showSnackbar(data.message || 'Failed to place order', 'error');
            btn.disabled = false;
            btn.textContent = 'Place Order';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showSnackbar('An error occurred. Please try again.', 'error');
          btn.disabled = false;
          btn.textContent = 'Place Order';
        });
      }

      // Initialize
      displayOrderSummary();

      // User dropdown toggle
      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }

      // Close dropdown when clicking outside
      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });
    </script>
  </body>
</html>
