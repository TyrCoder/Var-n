<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Checkout ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      body {
        background: #fafafa;
        font-family: 'Commissioner', sans-serif;
        margin: 0;
        padding: 0;
      }

      /* Top Bar */
      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 75px;
        background: #ffffff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 48px;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      }

      .top-brand {
        font-family: 'Playfair Display', serif;
        font-size: 28px;
        font-weight: 600;
        color: #000000;
        letter-spacing: 0.03em;
        text-decoration: none;
        transition: opacity 0.2s ease;
      }
      .top-brand:hover {
        opacity: 0.7;
      }

      .user-dropdown {
        position: relative;
      }
      .user-button {
        background: #fafafa;
        border: 1px solid #e8e8e8;
        color: #000000;
        cursor: pointer;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 10px;
        transition: all 0.25s;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .user-button:hover {
        background: #f5f5f5;
        border-color: #d4d4d4;
      }
      .user-button-icon {
        width: 34px;
        height: 34px;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 13px;
      }
      .user-button-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.2;
      }
      .user-button-label {
        font-size: 11px;
        color: #9ca3af;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .user-button-arrow {
        margin-left: 4px;
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s ease;
      }
      .user-dropdown.show .user-button-arrow {
        transform: rotate(180deg);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: #fff;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 10px;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid #e5e7eb;
      }
      .dropdown-content.show {
        display: block;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 14px 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
      }
      .dropdown-content a:hover {
        background: #f9fafb;
        padding-left: 22px;
      }

      .checkout-page {
        max-width: 1200px;
        margin: 100px auto 40px;
        padding: 0 32px;
      }

      .checkout-header {
        text-align: center;
        margin-bottom: 48px;
      }

      .checkout-header h1 {
        font-family: 'Playfair Display', serif;
        font-size: 36px;
        font-weight: 600;
        margin: 0 0 16px;
        color: #000000;
      }

      .checkout-header p {
        font-size: 16px;
        color: #737373;
        margin: 0;
      }

      .checkout-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 48px;
        margin-bottom: 48px;
      }

      .checkout-form {
        background: #ffffff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      }

      .checkout-section {
        margin-bottom: 40px;
      }

      .checkout-section:last-child {
        margin-bottom: 0;
      }

      .checkout-section h2 {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 24px;
        color: #000000;
        padding-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-group {
        margin-bottom: 24px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        font-size: 14px;
        color: #374151;
        font-family: 'Commissioner', sans-serif;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 14px 16px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 15px;
        font-family: inherit;
        transition: all 0.2s ease;
        box-sizing: border-box;
        background: #ffffff;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #000000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .save-address-checkbox {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 24px;
        padding: 16px;
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
      }

      .save-address-checkbox input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .save-address-checkbox label {
        margin: 0;
        cursor: pointer;
        font-size: 14px;
        color: #374151;
        font-weight: 500;
      }

      .payment-methods {
        display: grid;
        gap: 12px;
        margin-top: 16px;
      }

      .payment-option {
        display: flex;
        align-items: center;
        padding: 20px;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
      }

      .payment-option:hover {
        border-color: #000000;
        background: #f9fafb;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .payment-option.selected {
        border-color: #000000;
        background: #f9fafb;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
      }

      .payment-option input[type="radio"] {
        width: 20px;
        height: 20px;
        margin-right: 16px;
        cursor: pointer;
      }

      .payment-option-content {
        flex: 1;
      }

      .payment-option-title {
        font-weight: 600;
        font-size: 16px;
        margin-bottom: 4px;
        color: #000000;
      }

      .payment-option-desc {
        font-size: 14px;
        color: #6b7280;
      }

      .payment-icon {
        font-size: 28px;
        margin-right: 16px;
      }

      .order-summary {
        background: #ffffff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .order-summary h2 {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 600;
        margin: 0 0 24px;
        color: #000000;
      }

      .order-items {
        margin-bottom: 24px;
      }

      .order-item {
        display: flex;
        gap: 16px;
        padding: 16px 0;
        border-bottom: 1px solid #f0f0f0;
        align-items: center;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-item-image {
        width: 60px;
        height: 60px;
        background-color: #f9fafb;
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #f0f0f0;
        flex-shrink: 0;
      }

      .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-info {
        flex: 1;
        min-width: 0;
      }

      .order-item-name {
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        margin: 0 0 4px;
        display: block;
      }

      .order-item-details {
        font-size: 14px;
        color: #6b7280;
        margin: 0 0 4px;
      }

      .order-item-price {
        font-weight: 600;
        font-size: 16px;
        color: #000000;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        font-size: 16px;
        color: #374151;
      }

      .summary-row.total {
        font-size: 20px;
        font-weight: 600;
        color: #000000;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid #f0f0f0;
      }

      .place-order-btn {
        width: 100%;
        padding: 16px;
        background: #000000;
        color: #ffffff;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 24px;
      }

      .place-order-btn:hover {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      }

      .place-order-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        color: #0a0a0a;
        text-decoration: none;
        font-weight: 500;
        margin-bottom: 24px;
        transition: all 0.2s;
      }
      .back-link:hover {
        gap: 12px;
      }

      @media (max-width: 768px) {
        .top-bar {
          padding: 0 20px;
          height: 65px;
        }
        .top-brand {
          font-size: 22px;
        }
        .checkout-container {
          grid-template-columns: 1fr;
          gap: 32px;
        }
        .checkout-header h1 {
          font-size: 28px;
        }
        .form-row {
          grid-template-columns: 1fr;
        }
        .order-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <a href="{{ url_for('buyer_dashboard') }}" class="top-brand">Var√≥n</a>
      <div class="user-dropdown">
        <button class="user-button" onclick="toggleUserDropdown()">
          <div class="user-button-icon" id="buyerInitial">{{ session.get('first_name', 'U')[0]|upper }}</div>
          <div class="user-button-text">
            <span class="user-button-label">Account</span>
            <span id="buyerFirstName" style="font-weight: 600;">{{ session.get('first_name', 'User') }}</span>
          </div>
          <span class="user-button-arrow">‚ñº</span>
        </button>
        <div id="userDropdown" class="dropdown-content">
          <a href="{{ url_for('my_orders') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            My Orders
          </a>
          <a href="{{ url_for('account_details') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            My Account
          </a>
          <a href="{{ url_for('logout') }}" style="color: #ef4444;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </a>
        </div>
      </div>
    </div>

    <main class="checkout-page">
      <div class="checkout-header">
        <h1>Checkout</h1>
        <p>Complete your order with secure payment</p>
      </div>

      <div class="checkout-container">
        <form class="checkout-form" id="checkoutForm">
          <a href="javascript:history.back()" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Shopping
          </a>

          <!-- Shipping Information -->
          <div class="checkout-section">
            <h2>Shipping Information</h2>

            <!-- Saved Addresses Selection -->
            <div class="form-group" id="savedAddressesContainer" style="display:none">
              <label for="savedAddressSelect">Use Saved Address (Optional) *</label>
              <select id="savedAddressSelect" name="savedAddressSelect" onchange="loadSavedAddress(this.value)">
                <option value="">-- Select a saved address or enter new --</option>
              </select>
              <small style="color:#999;margin-top:4px;display:block">Or fill in the form below to use a new address</small>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="firstName" required value="{{ session.get('first_name', '') }}">
              </div>
              <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="lastName" required>
              </div>
            </div>
            <div class="form-group">
              <label for="email">Email Address *</label>
              <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
              <label for="phone">Phone Number *</label>
              <input type="tel" id="phone" name="phone" required placeholder="+63 XXX XXX XXXX" value="+63">
            </div>
            <div class="form-group">
              <label for="address">Street Address *</label>
              <input type="text" id="address" name="address" required placeholder="House No., Building, Street Name">
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="city">City *</label>
                <input type="text" id="city" name="city" required>
              </div>
              <div class="form-group">
                <label for="province">Province *</label>
                <input type="text" id="province" name="province" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="postalCode">Postal Code *</label>
                <input type="text" id="postalCode" name="postalCode" required>
              </div>
              <div class="form-group">
                <label for="country">Country *</label>
                <select id="country" name="country" required>
                  <option value="Philippines" selected>Philippines</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label for="notes">Delivery Notes (Optional)</label>
              <textarea id="notes" name="notes" placeholder="Add any special instructions for delivery..."></textarea>
            </div>

            <!-- Save Address Checkbox -->
            <div class="save-address-checkbox">
              <input type="checkbox" id="saveAddress" name="saveAddress">
              <label for="saveAddress">Save this address for future orders</label>
            </div>
          </div>

          <!-- Payment Method -->
          <div class="checkout-section">
            <h2>Payment Method</h2>
            <div class="payment-methods">
              <label class="payment-option selected" for="cod">
                <input type="radio" id="cod" name="paymentMethod" value="cod" checked>
                <div class="payment-icon">üí∞</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">Cash on Delivery</div>
                  <div class="payment-option-desc">Pay with cash when your order arrives</div>
                </div>
              </label>
              <label class="payment-option" for="gcash">
                <input type="radio" id="gcash" name="paymentMethod" value="gcash">
                <div class="payment-icon">üì±</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">GCash</div>
                  <div class="payment-option-desc">Pay securely with GCash mobile wallet</div>
                </div>
              </label>
              <label class="payment-option" for="paymaya">
                <input type="radio" id="paymaya" name="paymentMethod" value="paymaya">
                <div class="payment-icon">üí≥</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">PayMaya</div>
                  <div class="payment-option-desc">Pay securely with PayMaya</div>
                </div>
              </label>
              <label class="payment-option" for="card">
                <input type="radio" id="card" name="paymentMethod" value="card">
                <div class="payment-icon">üí≥</div>
                <div class="payment-option-content">
                  <div class="payment-option-title">Credit/Debit Card</div>
                  <div class="payment-option-desc">Visa, Mastercard, or American Express</div>
                </div>
              </label>
            </div>
          </div>
        </form>

        <!-- Order Summary -->
        <div class="order-summary">
          <h2>Order Summary</h2>
          <div class="order-items" id="orderItems">
            <!-- Order items will be loaded here -->
          </div>
          <div class="summary-row">
            <span>Subtotal</span>
            <span id="subtotal">‚Ç±0.00</span>
          </div>
          <div class="summary-row">
            <span>Shipping</span>
            <span id="shipping">‚Ç±100.00</span>
          </div>
          <div class="summary-row total">
            <span>Total</span>
            <span id="total">‚Ç±0.00</span>
          </div>
          <button class="place-order-btn" id="placeOrderBtn" onclick="confirmAndPlaceOrder()">Confirm Order</button>
          <p style="text-align:center;color:#666;font-size:13px;margin-top:16px;line-height:1.6">
            By placing your order, you agree to our Terms of Service and Privacy Policy
          </p>
        </div>
      </div>
    </main>

    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>

    <script>

      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }


      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });


      document.querySelectorAll('.payment-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.payment-option').forEach(opt => opt.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input[type="radio"]').checked = true;
        });
      });


      function setupPhonePrefix() {
        const phoneInput = document.getElementById('phone');
        if (!phoneInput) return;


        function ensurePrefix() {
          if (!phoneInput.value.startsWith('+63')) {
            phoneInput.value = '+63' + phoneInput.value.replace(/^\+?63?/, '');
          }
        }


        if (!phoneInput.value || phoneInput.value === '') {
          phoneInput.value = '+63';
        }


        phoneInput.addEventListener('input', function(e) {
          let value = e.target.value;


          value = value.replace(/^\+?63?/, '');


          e.target.value = '+63' + value;


          if (e.target.value.length < 3) {
            e.target.value = '+63';
          }
        });


        phoneInput.addEventListener('focus', function(e) {
          if (e.target.value === '+63') {
            e.target.setSelectionRange(3, 3);
          } else if (e.target.value.startsWith('+63')) {

            const cursorPos = e.target.selectionStart;
            if (cursorPos < 3) {
              e.target.setSelectionRange(3, 3);
            }
          }
        });


        phoneInput.addEventListener('keydown', function(e) {
          const cursorPos = e.target.selectionStart;


          if ((e.key === 'Backspace' || e.key === 'Delete') && cursorPos <= 3) {
            e.preventDefault();
            return false;
          }


          if (e.target.selectionStart < 3 && (e.key === 'Backspace' || e.key === 'Delete')) {
            e.preventDefault();
            e.target.setSelectionRange(3, 3);
            return false;
          }
        });


        phoneInput.addEventListener('paste', function(e) {
          e.preventDefault();
          const pastedText = (e.clipboardData || window.clipboardData).getData('text');
          let cleaned = pastedText.replace(/[^0-9]/g, '');
          cleaned = cleaned.replace(/^63?/, '');
          phoneInput.value = '+63' + cleaned;
          phoneInput.setSelectionRange(phoneInput.value.length, phoneInput.value.length);
        });


        phoneInput.addEventListener('blur', ensurePrefix);
      }


      document.addEventListener('DOMContentLoaded', async () => {

        setupPhonePrefix();


        await loadSavedAddresses();


        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            const firstName = data.firstName;
            const buyerFirstNameEl = document.getElementById('buyerFirstName');
            const buyerInitialEl = document.getElementById('buyerInitial');
            if (buyerFirstNameEl) buyerFirstNameEl.textContent = firstName;
            if (buyerInitialEl) buyerInitialEl.textContent = firstName.charAt(0).toUpperCase();
          })
          .catch(error => console.error('Error fetching buyer name:', error));


        await loadOrderSummary();
      });


      async function loadOrderSummary() {
        const orderItems = document.getElementById('orderItems');
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const shippingEl = document.getElementById('shipping');

        if (!window.VaronCart) {
          orderItems.innerHTML = '<p>Cart system not loaded</p>';
          return;
        }

        try {
          const items = await VaronCart.get();

          if (!items || items.length === 0) {
            orderItems.innerHTML = '<p>No items in cart</p>';
            subtotalEl.textContent = '‚Ç±0.00';
            totalEl.textContent = '‚Ç±0.00';
            document.getElementById('placeOrderBtn').disabled = true;
            return;
          }

          document.getElementById('placeOrderBtn').disabled = false;

          let subtotal = 0;
          const itemsHtml = items.map(item => {
            const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
            subtotal += itemTotal;

            const sizeColor = [];
            if (item.size) sizeColor.push(`Size: ${item.size}`);
            if (item.color) sizeColor.push(`Color: ${item.color}`);
            const variant = sizeColor.length > 0 ? sizeColor.join(', ') : '';

            return `
              <div class="order-item">
                <div class="order-item-image">
                  <img src="${item.image_url || '/static/images/placeholder.svg'}" alt="${item.name}" onerror="this.src='/static/images/placeholder.svg'">
                </div>
                <div class="order-item-info">
                  <div class="order-item-name">${item.name}</div>
                  ${variant ? `<div class="order-item-details">${variant}</div>` : ''}
                  <div class="order-item-price">‚Ç±${itemTotal.toFixed(2)}</div>
                </div>
              </div>
            `;
          }).join('');

          orderItems.innerHTML = itemsHtml;
          const shipping = 100.00;
          const total = subtotal + shipping;
          subtotalEl.textContent = `‚Ç±${subtotal.toFixed(2)}`;
          shippingEl.textContent = `‚Ç±${shipping.toFixed(2)}`;
          totalEl.textContent = `‚Ç±${total.toFixed(2)}`;

        } catch (error) {
          console.error('Error loading order summary:', error);
          orderItems.innerHTML = '<p>Error loading order summary</p>';
        }
      }


      async function loadSavedAddresses() {
        try {
          const response = await fetch('/get-shipping-addresses');
          const data = await response.json();

          if (data.success && data.addresses && data.addresses.length > 0) {
            const container = document.getElementById('savedAddressesContainer');
            const select = document.getElementById('savedAddressSelect');


            container.style.display = 'block';


            data.addresses.forEach(addr => {
              const option = document.createElement('option');
              option.value = addr.id;
              option.textContent = `${addr.address_type || 'Address'} - ${addr.street_address}, ${addr.city}${addr.is_default ? ' (Default)' : ''}`;
              select.appendChild(option);
            });


            const defaultAddr = data.addresses.find(addr => addr.is_default);
            if (defaultAddr) {
              select.value = defaultAddr.id;
              loadSavedAddress(defaultAddr.id);
            }
          }
        } catch (error) {
          console.error('Error loading saved addresses:', error);
        }
      }


      function loadSavedAddress(addressId) {
        if (!addressId) {

          document.getElementById('firstName').value = '';
          document.getElementById('lastName').value = '';
          document.getElementById('email').value = '';
          document.getElementById('phone').value = '';
          document.getElementById('address').value = '';
          document.getElementById('city').value = '';
          document.getElementById('province').value = '';
          document.getElementById('postalCode').value = '';
          document.getElementById('country').value = 'Philippines';
          document.getElementById('notes').value = '';
          return;
        }

        fetch(`/get-address/${addressId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.address) {
              const addr = data.address;

              const nameParts = (addr.full_name || '').split(' ');
              const firstName = nameParts[0] || '';
              const lastName = nameParts.slice(1).join(' ') || '';


              document.getElementById('firstName').value = firstName;
              document.getElementById('lastName').value = lastName;
              document.getElementById('phone').value = addr.phone || '+63';
              document.getElementById('address').value = addr.street_address || '';
              document.getElementById('city').value = addr.city || '';
              document.getElementById('province').value = addr.province || '';
              document.getElementById('postalCode').value = addr.postal_code || '';
              document.getElementById('country').value = addr.country || 'Philippines';
            }
          })
          .catch(error => console.error('Error loading address:', error));
      }


      async function confirmAndPlaceOrder() {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }


        if (!window.VaronCart) {
          alert('Cart system not loaded. Please refresh the page.');
          return;
        }

        const cartItems = await VaronCart.get();
        if (!cartItems || cartItems.length === 0) {
          alert('Your cart is empty.');
          return;
        }

        const formData = new FormData(form);
        const saveAddress = document.getElementById('saveAddress').checked;


        let subtotal = 0;
        const items = cartItems.map(item => {
          const itemTotal = parseFloat(item.price) * parseInt(item.quantity);
          subtotal += itemTotal;
          return {
            id: item.id,
            name: item.name,
            price: parseFloat(item.price),
            quantity: parseInt(item.quantity),
            size: item.size,
            color: item.color,
            image_url: item.image_url
          };
        });

        const shippingFee = 100.00;
        const total = subtotal + shippingFee;

        const orderData = {
          shipping: {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            phone: formData.get('phone'),
            address: formData.get('address'),
            city: formData.get('city'),
            province: formData.get('province'),
            postalCode: formData.get('postalCode'),
            country: formData.get('country'),
            notes: formData.get('notes')
          },
          payment_method: formData.get('paymentMethod'),
          items: items,
          subtotal: subtotal,
          shipping_fee: shippingFee,
          total: total,
          save_address: saveAddress
        };


        const placeOrderBtn = document.getElementById('placeOrderBtn');
        const originalText = placeOrderBtn.textContent;
        placeOrderBtn.disabled = true;
        placeOrderBtn.textContent = 'Processing...';

        try {
          const response = await fetch('/api/place-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderData)
          });

          const result = await response.json();

          if (result.success) {

            await VaronCart.clear();


            const orderNumber = result.order_number || 'your order';
            alert(`‚úÖ Order Confirmed!\n\nOrder Number: ${orderNumber}\n\nYour order is now confirmed. Waiting for a rider to accept and deliver it.\n\nYou will be redirected to your order confirmation page.`);


            window.location.href = `/order-confirmation/${result.order_number}`;
          } else {
            alert('‚ùå Error confirming order: ' + (result.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error confirming order:', error);
          alert('Error confirming order. Please try again.');
        } finally {

          placeOrderBtn.disabled = false;
          placeOrderBtn.textContent = originalText;
        }
      }


      async function placeOrder() {
        return confirmAndPlaceOrder();
      }
    </script>
  </body>
</html>
