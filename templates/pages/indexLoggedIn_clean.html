<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Var√≥n ‚Äî Elegant Men's Fashion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      /* Left Sidebar Navigation */
      .sidebar-nav {
        position: fixed;
        left: 0;
        top: 0;
        height: 100vh;
        width: 280px;
        background: #0a0a0a;
        color: #fff;
        padding: 30px 20px;
        z-index: 1000;
        overflow-y: auto;
      }
      .sidebar-nav .brand {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 40px;
        text-align: center;
      }
      .sidebar-nav .nav-links {
        list-style: none;
        padding: 0;
        margin: 0;
      }
      .sidebar-nav .nav-links li {
        margin-bottom: 8px;
      }
      .sidebar-nav .nav-links a {
        color: #fff;
        text-decoration: none;
        display: block;
        padding: 12px 16px;
        border-radius: 8px;
        transition: background 0.2s;
        font-size: 15px;
      }
      .sidebar-nav .nav-links a:hover {
        background: rgba(255,255,255,0.1);
      }
      .sidebar-nav .nav-links a.active {
        background: rgba(255,255,255,0.2);
        font-weight: 500;
      }

      /* User Dropdown in Sidebar */
      .user-dropdown {
        position: relative;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid rgba(255,255,255,0.1);
      }
      .user-button {
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a);
        border: 1px solid rgba(255,255,255,0.2);
        color: #fff;
        cursor: pointer;
        padding: 14px 18px;
        font-size: 15px;
        border-radius: 12px;
        transition: all 0.3s ease;
        width: 100%;
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      .user-button:hover {
        background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: #fff;
        min-width: 100%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        margin-bottom: 8px;
        z-index: 1000;
        overflow: hidden;
      }
      .dropdown-content.show {
        display: block;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        transition: background 0.2s;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }

      /* Floating Cart Button */
      .floating-cart {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: #0a0a0a;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 999;
        transition: all 0.3s ease;
      }
      .floating-cart:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0,0,0,0.4);
      }
      .floating-cart svg {
        width: 24px;
        height: 24px;
        fill: #fff;
      }
      .floating-cart-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: #ef4444;
        color: #fff;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        border: 2px solid #fff;
      }

      /* Main Content */
      .main-content {
        margin-left: 280px;
        transition: margin-left 0.3s ease;
      }

      @media (max-width: 768px) {
        .floating-cart {
          bottom: 20px;
          right: 20px;
          width: 50px;
          height: 50px;
        }
        .floating-cart svg {
          width: 20px;
          height: 20px;
        }
        .main-content {
          margin-left: 0;
        }
        .sidebar-nav {
          transform: translateX(-100%);
          transition: transform 0.3s ease;
        }
        .sidebar-nav.mobile-open {
          transform: translateX(0);
        }
        .main-content.mobile-open {
          margin-left: 280px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar-nav" id="sidebarNav">
      <div class="brand">Var√≥n</div>
      <ul class="nav-links">
        <li><a href="javascript:void(0)" onclick="showSection('home')" class="active">Home</a></li>
        <li><a href="javascript:void(0)" onclick="showSection('browse')">Browse</a></li>
        <li><a href="javascript:void(0)" onclick="showSection('myOrders')">My Orders</a></li>
        <li><a href="javascript:void(0)" onclick="showSection('trackOrder')">Track Order</a></li>
        <li><a href="javascript:void(0)" onclick="showSection('journal')">Journal</a></li>
        <li><a href="javascript:void(0)" onclick="showSection('about')">About</a></li>
      </ul>

      <div class="user-dropdown">
        <button class="user-button" onclick="toggleUserDropdown()">
          <span id="buyerFirstName">User</span>
          <span>‚ñº</span>
        </button>
        <div id="userDropdown" class="dropdown-content">
          <a href="javascript:void(0)" onclick="confirmLogout()">Logout</a>
        </div>
      </div>
    </nav>

    <!-- Floating Cart Button -->
    <div class="floating-cart" onclick="openModal('cartModal')">
      <svg viewBox="0 0 24 24">
        <path d="M7 4V2C7 1.45 7.45 1 8 1H16C16.55 1 17 1.45 17 2V4H20C20.55 4 21 4.45 21 5S20.55 6 20 6H19V19C19 20.1 18.1 21 17 21H7C5.9 21 5 20.1 5 19V6H4C3.45 6 3 5.55 3 5S3.45 4 4 4H7ZM9 3V4H15V3H9ZM7 6V19H17V6H7Z"/>
        <path d="M9 8H11V17H9V8ZM13 8H15V17H13V8Z"/>
      </svg>
      <span id="cartBadge" class="floating-cart-badge" style="display: none;">0</span>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Hero Section -->
      <section class="hero" id="heroSection">
        <div class="hero-inner container">
          <div class="hero-copy">
            <h2>Refined Elegance for the Modern Gentleman</h2>
            <p class="muted">Where sophistication meets contemporary style. Each piece is meticulously crafted to elevate your presence.</p>
            <p><a href="javascript:void(0)" onclick="showSection('browse')" class="btn-cta">Discover Collection</a></p>
          </div>
          <div class="hero-media" aria-hidden="true"></div>
        </div>
      </section>

      <!-- Featured Products Section (Home) -->
      <section id="home" class="content-section" style="display:block">
        <div class="container">
          <h2 style="margin:40px 0 30px;text-align:center">Featured Collection</h2>
          <div id="featuredGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;margin-bottom:40px">
            <!-- Featured products will be loaded here from database -->
          </div>
          <div style="text-align:center">
            <a href="javascript:void(0)" onclick="showSection('browse')" class="btn-cta">View All Products</a>
          </div>
        </div>
      </section>

      <!-- Content Sections -->
      <div id="trackOrder" class="content-section" style="display:none">
        <div class="container" style="max-width:600px;margin:40px auto;padding:20px">
          <h2 style="margin-bottom:24px;text-align:center">Track Your Order</h2>
          <div style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1)">
            <form id="trackingForm" style="display:flex;flex-direction:column;gap:16px">
              <div>
                <label style="display:block;margin-bottom:8px;font-weight:500">Order Number</label>
                <input type="text" id="trackOrderNumber" placeholder="Enter your order number" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px">
              </div>
              <div>
                <label style="display:block;margin-bottom:8px;font-weight:500">Email</label>
                <input type="email" id="trackEmail" placeholder="Enter your email address" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px">
              </div>
              <button type="submit" class="btn-cta" style="width:100%">Track Order</button>
            </form>
            <div id="trackingResult" style="display:none;margin-top:20px;padding:20px;background:#f0f9ff;border-radius:8px;border-left:4px solid #3b82f6">
              <h3 style="margin-top:0">Order Details</h3>
              <div id="trackingResultContent"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="myOrders" class="content-section" style="display:none">
        <div class="container" style="max-width:900px;margin:40px auto;padding:20px">
          <h2 style="margin-bottom:24px;text-align:center">My Orders</h2>
          <div id="myOrdersList" style="display:grid;gap:16px">
            <!-- Orders will be loaded here -->
            <p style="text-align:center;color:#999">Loading your orders...</p>
          </div>
        </div>
      </div>

      <div id="browse" class="content-section" style="display:none">
        <div class="container">
          <h2 style="margin:24px 0">Browse Collection</h2>
          <div id="browseGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px">
            <!-- Products will be loaded here -->
          </div>
        </div>
      </div>

      <div id="journal" class="content-section" style="display:none">
        <div class="container">
          <h2 style="margin:24px 0">Journal</h2>
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px">
            <article style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
              <div style="height:200px;background:#f5f5f5;background-image:url('https://images.unsplash.com/photo-1521334884684-d80222895322?q=80&w=800&auto=format&fit=crop');background-size:cover"></div>
              <div style="padding:20px">
                <h3 style="margin:0 0 10px">Style Guide: Fall 2025</h3>
                <p style="margin:0;color:#666;line-height:1.5">Explore our comprehensive guide to fall fashion trends and essential pieces for your wardrobe.</p>
                <a href="#" class="btn-cta" style="display:inline-block;margin-top:16px;font-size:14px">Read More</a>
              </div>
            </article>
            <article style="background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)">
              <div style="height:200px;background:#f5f5f5;background-image:url('https://images.unsplash.com/photo-1610963876305-c8e7cb43a09b?q=80&w=800&auto=format&fit=crop');background-size:cover"></div>
              <div style="padding:20px">
                <h3 style="margin:0 0 10px">Sustainable Fashion</h3>
                <p style="margin:0;color:#666;line-height:1.5">Learn about our commitment to sustainable practices and ethical fashion production.</p>
                <a href="#" class="btn-cta" style="display:inline-block;margin-top:16px;font-size:14px">Read More</a>
              </div>
            </article>
          </div>
        </div>
      </div>

      <div id="about" class="content-section" style="display:none">
        <div class="container" style="max-width:800px;margin:40px auto;padding:20px">
          <h2 style="margin-bottom:24px;text-align:center">About Var√≥n</h2>
          <div style="background:#fff;padding:30px;border-radius:12px;box-shadow:0 4px 6px rgba(0,0,0,0.1)">
            <p style="line-height:1.6;margin:0 0 20px">Var√≥n is a modern menswear brand focused on creating timeless pieces that combine style, comfort, and sustainability. Our mission is to provide high-quality clothing that stands the test of time.</p>
            <p style="line-height:1.6;margin:0 0 20px">Founded in 2025, we've been dedicated to crafting minimal designs that emphasize quality materials and expert craftsmanship. Every piece in our collection is thoughtfully designed and responsibly made.</p>
            <p style="line-height:1.6;margin:0">Our commitment to sustainability and ethical fashion drives everything we do. We work closely with our partners to ensure responsible production methods and fair labor practices throughout our supply chain.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal" aria-hidden="true">
      <div class="cart-card">
        <button onclick="closeModal('cartModal')" class="cart-close-btn" aria-label="Close cart">√ó</button>
        <h2 style="text-align:left;margin-bottom:20px">Your Cart</h2>
        <div id="cartList" class="cart-list">
          <!-- Empty cart state -->
          <div class="empty-cart-state" style="text-align:center;padding:60px 20px">
            <div style="font-size:80px;color:#ddd;margin-bottom:16px">
              <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:inline-block">
                <path d="M9 2L7.17 4H3c-.55 0-1 .45 1 1s.45 1 1 1h1l1.6 8.6c.18 1 1.05 1.73 2.06 1.73h7.72c1.01 0 1.88-.73 2.06-1.73L19 6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4.17L14 2H9z"/>
                <circle cx="9" cy="20" r="1"/>
                <circle cx="16" cy="20" r="1"/>
              </svg>
            </div>
            <h3 style="font-size:18px;font-weight:400;color:#999;margin:0 0 8px">Your cart is empty</h3>
            <p style="font-size:14px;color:#bbb;margin:0">Add some products to get started!</p>
          </div>
        </div>
        <div class="cart-totals">
          <div style="padding:24px 0;border-top:1px solid #eee">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <span style="color:#666;font-size:15px">Subtotal:</span>
              <span style="font-size:16px;font-weight:500" id="cartSubtotal">‚Ç±0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
              <span style="font-size:18px;font-weight:600;color:#0a0a0a">Total:</span>
              <span style="font-size:20px;font-weight:600;color:#0a0a0a" id="cartTotal">‚Ç±0.00</span>
            </div>
          </div>
          <div style="display:flex;gap:12px">
            <button onclick="confirmClearCart()" class="btn-secondary" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;border:1px solid #e0e0e0;background:#fff;color:#0a0a0a;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">CLEAR CART</button>
            <button onclick="proceedToCheckout()" class="btn-cta" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;background:#0a0a0a;color:#fff;border:none;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='#0a0a0a'">PROCEED TO CHECKOUT</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm Clear Cart Modal -->
    <div id="clearModal" class="modal" aria-hidden="true">
      <div class="modal-panel">
        <button class="modal-close" onclick="closeModal('clearModal')">√ó</button>
        <h2 style="margin:0 0 8px">Clear Cart?</h2>
        <p style="margin:0 0 18px;color:var(--muted)">Are you sure you want to remove all items from your cart?</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeModal('clearModal')" class="btn-cta" style="background:#f6f6f6;color:#0a0a0a">Cancel</button>
          <button onclick="clearCart()" class="btn-cta">Yes, Clear Cart</button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" aria-hidden="true">
      <div class="modal-panel">
        <button class="modal-close" onclick="closeModal('logoutModal')">√ó</button>
        <h2 style="margin:0 0 8px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:var(--muted)">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeModal('logoutModal')" class="btn-cta" style="background:#f6f6f6;color:#0a0a0a">Cancel</button>
          <button onclick="proceedLogout()" class="btn-cta" style="background:#ef4444;color:#fff">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>

      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }


      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button') && !e.target.closest('.dropdown-content')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });


      function confirmLogout() {
        openModal('logoutModal');
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }


      function showSection(sectionName) {

        document.querySelectorAll('.content-section').forEach(section => {
          section.style.display = 'none';
        });


        const targetSection = document.getElementById(sectionName);
        if (targetSection) {
          targetSection.style.display = 'block';


          if (sectionName === 'myOrders') {
            loadMyOrders();
          }
        }


        document.querySelectorAll('.sidebar-nav .nav-links a').forEach(link => {
          link.classList.remove('active');
        });
        const activeLink = document.querySelector(`.sidebar-nav .nav-links a[onclick*="${sectionName}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      }


      function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'flex';
          modal.setAttribute('aria-hidden', 'false');
        }
      }

      function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.style.display = 'none';
          modal.setAttribute('aria-hidden', 'true');
        }
      }


      window.addEventListener('DOMContentLoaded', (event) => {
        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            document.getElementById('buyerFirstName').textContent = data.firstName;
          })
          .catch(error => console.error('Error fetching buyer name:', error));


        if (window.VaronCart) {
          VaronCart.updateBadge();
        }


        showSection('home');


        loadFeaturedProducts();
      });


      function loadFeaturedProducts() {
        fetch('/api/products?limit=4')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.products) {
              const featuredGrid = document.getElementById('featuredGrid');
              const filtered = data.products.slice(0, 4);
              featuredGrid.innerHTML = filtered.map(product => `
                <article class="product" style="cursor:pointer" onclick="window.location.href='/product/${product.id}'">
                  <div class="product-image">
                    <img src="${product.image_url || 'https://via.placeholder.com/400x500'}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">
                  </div>
                  <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="price">‚Ç±${parseFloat(product.price).toFixed(2)}</p>
                  </div>
                </article>
              `).join('');
            } else {
              document.getElementById('featuredGrid').innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px 20px"><h3 style="margin:0 0 12px;color:#666">No Products Available</h3><p style="color:#999;margin:0">Check back soon for new arrivals!</p></div>';
            }
          })
          .catch(error => console.error('Error loading featured products:', error));
      }


      function loadBrowseProducts() {
        fetch('/api/products')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.products) {
              const browseGrid = document.getElementById('browseGrid');
              browseGrid.innerHTML = data.products.map(product => `
                <article class="product" style="cursor:pointer" onclick="window.location.href='/product/${product.id}'">
                  <div class="product-image">
                    <img src="${product.image_url || 'https://via.placeholder.com/400x500'}" alt="${product.name}" style="width:100%;height:100%;object-fit:cover;">
                  </div>
                  <div class="product-info">
                    <h3>${product.name}</h3>
                    <p class="price">‚Ç±${parseFloat(product.price).toFixed(2)}</p>
                  </div>
                </article>
              `).join('');
            } else {
              document.getElementById('browseGrid').innerHTML = '<p style="color:#999;text-align:center;grid-column:1/-1;padding:40px">No products available</p>';
            }
          })
          .catch(error => {
            console.error('Error loading products:', error);
            document.getElementById('browseGrid').innerHTML = '<p style="color:#ef4444;text-align:center;grid-column:1/-1;padding:40px">Error loading products</p>';
          });
      }


      document.getElementById('trackingForm').addEventListener('submit', function(event) {
        event.preventDefault();
        const orderNumber = document.getElementById('trackOrderNumber').value;
        const email = document.getElementById('trackEmail').value;

        fetch('/api/search-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            order_number: orderNumber,
            email: email
          })
        })
        .then(response => response.json())
        .then(data => {
          const resultDiv = document.getElementById('trackingResult');
          const resultContent = document.getElementById('trackingResultContent');

          if (data.success) {
            const order = data.order;
            resultContent.innerHTML = `
              <div style="display:grid;gap:12px">
                <div style="display:flex;justify-content:space-between">
                  <span style="color:#666">Order Number:</span>
                  <span style="font-weight:600">${order.order_number}</span>
                </div>
                <div style="display:flex;justify-content:space-between">
                  <span style="color:#666">Status:</span>
                  <span style="font-weight:600;color:#3b82f6">${order.status}</span>
                </div>
                <div style="display:flex;justify-content:space-between">
                  <span style="color:#666">Total Amount:</span>
                  <span style="font-weight:600">‚Ç±${parseFloat(order.total_amount).toFixed(2)}</span>
                </div>
                <div style="display:flex;justify-content:space-between">
                  <span style="color:#666">Order Date:</span>
                  <span style="font-weight:600">${new Date(order.created_at).toLocaleDateString()}</span>
                </div>
              </div>
            `;
            resultDiv.style.display = 'block';
            resultDiv.style.borderLeftColor = '#10b981';
            resultDiv.style.background = '#f0fdf4';
          } else {
            resultContent.innerHTML = `<p style="color:#ef4444;margin:0">${data.error || 'Order not found'}</p>`;
            resultDiv.style.display = 'block';
            resultDiv.style.borderLeftColor = '#ef4444';
            resultDiv.style.background = '#fef2f2';
          }
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('trackingResult').style.display = 'block';
          document.getElementById('trackingResultContent').innerHTML = '<p style="color:#ef4444;margin:0">Error tracking order. Please try again.</p>';
        });
      });


      let myOrdersRefreshInterval = null;

      function loadMyOrders() {
        fetch('/api/my-orders')
          .then(response => response.json())
          .then(data => {
            const ordersList = document.getElementById('myOrdersList');
            if (data.success && data.orders && data.orders.length > 0) {

              const orderStatusToStage = {
                'pending': 'waiting_for_seller',
                'confirmed': 'confirmed',
                'waiting_for_pickup': 'ready_for_pickup',
                'released_to_rider': 'in_transit',
                'delivered': 'delivered',
                'cancelled': 'cancelled'
              };

              const stageDefinitions = [
                { key: 'waiting_for_seller', label: 'Waiting for Seller', icon: '‚è≥', color: '#ef4444' },
                { key: 'confirmed', label: 'Seller Confirmed', icon: '‚úîÔ∏è', color: '#f59e0b' },
                { key: 'ready_for_pickup', label: 'Ready for Pickup', icon: 'üì¶', color: '#8b5cf6' },
                { key: 'in_transit', label: 'In Transit', icon: 'üöö', color: '#3b82f6' },
                { key: 'delivered', label: 'Delivered', icon: '‚úÖ', color: '#10b981' }
              ];

              ordersList.innerHTML = data.orders.map(order => {
                const orderStatus = order.order_status || 'pending';
                const displayStatus = order.display_status || 'Processing...';
                const statusIcon = order.status_icon || 'üìã';
                const stageKey = orderStatusToStage[orderStatus] || 'pending';


                const currentStageIndex = stageDefinitions.findIndex(s => s.key === stageKey);

                const stageFlow = stageDefinitions.map((step, idx) => {
                  const isActive = idx === currentStageIndex;
                  const isCompleted = idx < currentStageIndex;
                  const statusColor = isCompleted ? '#10b981' : isActive ? step.color : '#d1d5db';
                  const textColor = isCompleted || isActive ? statusColor : '#999';

                  return `
                    <div style="display:flex;align-items:center;gap:4px;color:${textColor};font-weight:${isActive ? '600' : isCompleted ? '600' : '500'};font-size:12px;transition:all 0.3s">
                      <span>${step.icon}</span>
                      <span>${step.label}</span>
                      ${idx < stageDefinitions.length - 1 ? `<span style="color:#d1d5db;margin:0 4px">‚Ä∫</span>` : ''}
                    </div>
                  `;
                }).join('');

                const stageColor = stageDefinitions[currentStageIndex]?.color || '#666';

                return `
                  <div style="background:#fff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);border-left:4px solid ${stageColor};transition:all 0.3s" data-order-id="${order.id}">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px">
                      <div>
                        <h3 style="margin:0 0 4px;font-size:18px">Order #${order.order_number}</h3>
                        <p style="margin:0;color:#666;font-size:14px">${new Date(order.created_at).toLocaleDateString()}</p>
                      </div>
                      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
                        <span style="background:${stageColor}20;color:${stageColor};padding:6px 14px;border-radius:20px;font-size:12px;font-weight:600;border:1px solid ${stageColor}40">${displayStatus}</span>
                        <span style="font-size:11px;color:#999">${statusIcon}</span>
                      </div>
                    </div>
                    <div style="margin-bottom:16px">
                      <p style="margin:0;font-weight:600">Total: ‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}</p>
                    </div>
                    <div style="display:flex;gap:8px;margin-bottom:12px;padding:12px;background:#f9fafb;border-radius:8px;flex-wrap:wrap;overflow-x:auto">
                      ${stageFlow}
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
                      ${orderStatus === 'delivered' ? `
                        <button onclick="confirmReceived(${order.id})" style="flex:1;min-width:140px;padding:10px 14px;background:#10b981;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                          <span>‚úì</span> Confirm Received
                        </button>
                      ` : ''}
                      <button onclick="viewOrderDetails(${order.id})" style="flex:1;min-width:140px;padding:10px 14px;background:#3b82f6;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        <span>üëÅÔ∏è</span> Details
                      </button>
                      ${orderStatus !== 'cancelled' && orderStatus !== 'pending' ? `
                        <button onclick="refreshOrderStatus(${order.id})" style="padding:10px 14px;background:#6b7280;color:#fff;border:none;border-radius:6px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:6px" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'" title="Refresh status">
                          <span>üîÑ</span>
                        </button>
                      ` : ''}
                    </div>
                  </div>
                `;
              }).join('');


              startOrderAutoRefresh();
            } else {
              ordersList.innerHTML = '<div style="text-align:center;padding:60px 20px"><h3 style="margin:0 0 12px;color:#666">No Orders Yet</h3><p style="color:#999;margin:0">Your order history will appear here.</p></div>';
              if (myOrdersRefreshInterval) clearInterval(myOrdersRefreshInterval);
            }
          })
          .catch(error => {
            console.error('Error loading orders:', error);
            document.getElementById('myOrdersList').innerHTML = '<div style="text-align:center;padding:60px 20px"><h3 style="margin:0 0 12px;color:#666">Error Loading Orders</h3><p style="color:#999;margin:0">Please try again later.</p></div>';
          });
      }


      function startOrderAutoRefresh() {
        if (myOrdersRefreshInterval) clearInterval(myOrdersRefreshInterval);

        myOrdersRefreshInterval = setInterval(() => {
          const myOrdersSection = document.getElementById('myOrders');

          if (myOrdersSection && myOrdersSection.style.display !== 'none') {
            loadMyOrders();
          }
        }, 5000);
      }


      function refreshOrderStatus(orderId) {
        fetch(`/api/my-orders`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.orders) {
              const order = data.orders.find(o => o.id === orderId);
              if (order) {
                alert(`‚úÖ Order Status Updated\n\n${order.display_status}`);
                loadMyOrders();
              }
            }
          })
          .catch(error => console.error('Error refreshing status:', error));
      }


      function confirmReceived(orderId) {
        if (!confirm('‚úÖ Confirm that you have received this order in good condition?')) return;

        fetch(`/api/order/complete`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order_id: orderId, action: 'completed' })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Order confirmed as received! Thank you for shopping with us.');
            loadMyOrders();
          } else {
            alert('Error: ' + (data.error || data.message || 'Unable to confirm'));
          }
        })
        .catch(error => {
          console.error('Error confirming order:', error);
          alert('Error confirming order. Please try again.');
        });
      }


      function viewOrderDetails(orderId) {
        window.location.href = `/order/${orderId}`;
      }


      function confirmClearCart() {
        openModal('clearModal');
      }

      function clearCart() {

        closeModal('clearModal');
        closeModal('cartModal');
      }

      function proceedToCheckout() {

        window.location.href = '/checkout';
      }



      function showReturnDialog(orderId) {
        const message = `Please select the issue:

1 = Product Damaged
2 = Wrong Item Received
3 = Not as Described
4 = Other Issue

Enter number (1-4) or describe the problem:`;

        const reason = prompt(message);
        if (reason && reason.trim()) {
          returnOrDamagedOrder(orderId, reason);
        }
      }


      async function returnOrDamagedOrder(orderId, reason) {
        try {
          const response = await fetch(`/api/order/return`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ order_id: orderId, reason: reason })
          });

          const data = await response.json();
          if (data.success) {
            alert('üìã Return/Issue request submitted!\n\nOur support team will contact you within 24 hours.');
            loadMyOrders();
          } else {
            alert('‚ùå Error: ' + (data.error || 'Failed to submit request'));
          }
        } catch (error) {
          console.error('Error submitting return:', error);
          alert('‚ùå Error submitting request');
        }
      }
    </script>
  </body>
</html>