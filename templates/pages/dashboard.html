<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet" />
    <style>
      :root {
        --bg:#f3f4f6;
        --bg-alt:#e5e7eb;
        --panel:#ffffff;
        --card:#ffffff;
        --line:#e5e7eb;
        --line-strong:#d1d5db;
        --text:#0a0a0a;
        --heading:#0a0a0a;
        --muted:#6b7280;
        --accent:#0a0a0a;
        --accent-soft:rgba(10,10,10,0.08);
        --success:#16a34a;
        --warning:#f97316;
        --danger:#dc2626;
        --shadow:0 18px 40px rgba(15,23,42,0.08);
        --hero-bg:#05070f;
        --hero-bg-accent:#0f172a;
        --hero-highlight:#1d4ed8;
        --hero-highlight-strong:#2563eb;
        --hero-pill-bg:rgba(15,23,42,0.75);
        --hero-pill-border:rgba(255,255,255,0.18);
        --hero-pill-glow:0 25px 55px rgba(15,23,42,0.45);
        --hero-muted:rgba(248,250,252,0.72);
      }

      * { box-sizing:border-box; }

      body {
        margin:0;
        font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
        background:linear-gradient(135deg,#f9fafb 0%,#eef2ff 60%,#f3f4f6 100%);
        color:var(--text);
        min-height:100vh;
        line-height:1.6;
      }

      h1,h2,h3,h4,h5,h6 {
        font-family:'Playfair Display','Inter',serif;
        color:var(--heading);
        margin:0;
        letter-spacing:-0.02em;
      }

      a { color:inherit; text-decoration:none; }
      button,input,select,textarea { font-family:'Inter','Segoe UI',sans-serif; }

      .app-shell {
        display:grid;
        grid-template-columns:260px minmax(0,1fr);
        min-height:100vh;
        background:transparent;
      }

      .sidebar {
        background:#0a0a0a;
        padding:32px 22px;
        display:flex;
        flex-direction:column;
        gap:22px;
        box-shadow:16px 0 35px rgba(0,0,0,0.35);
        position:sticky;
        top:0;
        height:100vh;
        overflow-y:auto;
      }

      .sidebar::-webkit-scrollbar { width:6px; }
      .sidebar::-webkit-scrollbar-thumb {
        background:rgba(255,255,255,0.1);
        border-radius:999px;
      }

      .logo {
        display:flex;
        align-items:center;
        gap:12px;
        font-size:20px;
        font-weight:600;
        letter-spacing:0.18em;
        text-transform:uppercase;
        color:#fff;
      }

      .logo .dot {
        width:10px;
        height:10px;
        border-radius:50%;
        background:#22d3ee;
        box-shadow:0 0 12px rgba(34,211,238,0.8);
      }

      .sidebar-note {
        margin:0;
        color:rgba(255,255,255,0.65);
        font-size:13px;
        line-height:1.5;
      }

      .nav-links {
        display:flex;
        flex-direction:column;
        gap:6px;
      }

      .side-title {
        font-size:11px;
        font-weight:600;
        letter-spacing:0.3em;
        text-transform:uppercase;
        color:rgba(255,255,255,0.4);
        margin:18px 0 8px;
      }

      .side-link {
        display:flex;
        align-items:center;
        gap:10px;
        border:none;
        border-radius:10px;
        padding:10px 12px;
        text-align:left;
        background:transparent;
        color:rgba(255,255,255,0.65);
        font-size:14px;
        font-weight:500;
        cursor:pointer;
        transition:background 0.2s,color 0.2s,transform 0.2s;
      }

      .side-link:hover,
      .side-link.active {
        background:rgba(255,255,255,0.08);
        color:#fff;
        transform:translateX(4px);
      }

      .logout-btn {
        margin-top:auto;
        border:1px solid rgba(255,255,255,0.25);
        border-radius:12px;
        padding:12px;
        background:transparent;
        color:#fff;
        font-weight:600;
        letter-spacing:0.08em;
        cursor:pointer;
        transition:background 0.2s;
      }

      .logout-btn:hover { background:rgba(255,255,255,0.08); }

      .main-area {
        padding:36px 48px;
        background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(243,244,246,0.95));
        min-height:100vh;
        display:flex;
        flex-direction:column;
        gap:28px;
      }

      .topbar {
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:18px;
        flex-wrap:wrap;
        padding:22px 24px;
        background:#fff;
        border:1px solid var(--line);
        border-radius:20px;
        box-shadow:var(--shadow);
      }

      .topbar-heading {
        display:flex;
        flex-direction:column;
        gap:6px;
      }

      .eyebrow {
        margin:0;
        font-size:11px;
        letter-spacing:0.24em;
        text-transform:uppercase;
        color:var(--muted);
      }

      .page-title {
        margin:0;
        font-size:32px;
        font-weight:700;
        letter-spacing:-0.02em;
      }

      .page-subtitle {
        margin:0;
        color:var(--muted);
        font-size:14px;
      }

      .status-badge {
        padding:6px 12px;
        border-radius:999px;
        font-size:11px;
        letter-spacing:0.08em;
        text-transform:uppercase;
        border:1px solid var(--line);
        color:var(--muted);
      }

      .topbar-actions {
        display:flex;
        gap:12px;
        flex-wrap:wrap;
      }

      .ghost-btn {
        border:1px solid var(--line);
        border-radius:999px;
        padding:10px 18px;
        background:#fff;
        color:var(--text);
        font-weight:600;
        cursor:pointer;
        transition:transform 0.2s,box-shadow 0.2s;
      }

      .ghost-btn:hover {
        transform:translateY(-1px);
        box-shadow:0 10px 20px rgba(15,23,42,0.12);
      }

      .hero-banner {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap:24px;
        padding:36px;
        border-radius:32px;
        background:linear-gradient(135deg,var(--hero-bg),var(--hero-bg-accent) 60%,#020617 100%);
        color:#fff;
        box-shadow:0 35px 70px rgba(2,6,23,0.55);
        border:1px solid rgba(255,255,255,0.08);
        position:relative;
        overflow:hidden;
        flex-wrap:wrap;
      }

      .hero-banner::before {
        content:'';
        position:absolute;
        inset:18px;
        border:1px solid rgba(255,255,255,0.08);
        border-radius:26px;
        opacity:0.35;
        pointer-events:none;
      }

      .hero-banner::after {
        content:'';
        position:absolute;
        width:220px;
        height:220px;
        right:-60px;
        top:-60px;
        background:radial-gradient(circle,rgba(37,99,235,0.4),rgba(37,99,235,0));
      }

      .hero-core {
        flex:1;
        min-width:280px;
        position:relative;
        z-index:1;
      }

      .hero-eyebrow {
        text-transform:uppercase;
        letter-spacing:0.32em;
        font-size:11px;
        opacity:0.7;
        margin:0 0 10px;
        color:var(--hero-muted);
      }

      .hero-title {
        margin:0;
        font-size:34px;
        max-width:520px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      .hero-title-highlight {
        display:inline-flex;
        background:linear-gradient(120deg,var(--hero-highlight),var(--hero-highlight-strong));
        padding:12px 18px;
        border-radius:18px;
        font-size:28px;
        line-height:1.25;
        box-shadow:0 25px 50px rgba(37,99,235,0.45);
      }

      .hero-title-rest {
        color:rgba(248,250,252,0.85);
      }

      .hero-copy {
        margin:16px 0 0;
        max-width:520px;
        color:var(--hero-muted);
        font-size:15px;
      }

      .hero-metrics {
        display:flex;
        gap:18px;
        flex-wrap:wrap;
        position:relative;
        z-index:1;
      }

      .hero-metric {
        min-width:230px;
        padding:22px 24px;
        border-radius:20px;
        background:var(--hero-pill-bg);
        border:1px solid var(--hero-pill-border);
        box-shadow:var(--hero-pill-glow);
        display:flex;
        flex-direction:column;
        gap:10px;
      }

      .metric-eyebrow {
        font-size:11px;
        letter-spacing:0.2em;
        text-transform:uppercase;
        color:rgba(248,250,252,0.7);
      }

      .metric-main {
        display:flex;
        align-items:center;
        gap:12px;
        flex-wrap:wrap;
      }

      .hero-metric .value {
        font-size:30px;
        font-weight:700;
        letter-spacing:0.2em;
      }

      .hero-metric .value.accent {
        color:#60a5fa;
      }

      .hero-chip {
        padding:6px 14px;
        border-radius:999px;
        border:1px solid rgba(255,255,255,0.22);
        font-size:12px;
        text-transform:none;
        letter-spacing:0.04em;
        background:rgba(255,255,255,0.08);
        color:#fff;
        font-weight:600;
      }

      .hero-chip.accent {
        background:linear-gradient(120deg,var(--hero-highlight),var(--hero-highlight-strong));
        border-color:transparent;
        box-shadow:0 12px 25px rgba(37,99,235,0.45);
      }

      .metric-footnote {
        font-size:12px;
        color:var(--hero-muted);
        margin:0;
      }

      .content-area {
        display:flex;
        flex-direction:column;
        gap:22px;
      }

      .stats-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
        gap:18px;
      }

      .card {
        position:relative;
        background:var(--card);
        border-radius:20px;
        border:1px solid var(--line);
        box-shadow:var(--shadow);
        overflow:hidden;
      }

      .inner { padding:22px 24px 26px; }

      .metric {
        margin:0;
        font-size:13px;
        letter-spacing:0.12em;
        text-transform:uppercase;
        color:var(--muted);
        font-weight:600;
      }

      .value {
        margin:12px 0 0;
        font-size:30px;
        font-weight:700;
        color:var(--text);
      }

      .hint {
        margin:8px 0 0;
        font-size:12px;
        color:var(--muted);
      }

      .panel-grid {
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
        gap:18px;
      }

      .bar-chart {
        display:flex;
        align-items:flex-end;
        gap:12px;
        height:200px;
        margin-top:18px;
      }

      .bar {
        flex:1;
        background:linear-gradient(180deg,#111827,#1f2937);
        border-radius:12px 12px 8px 8px;
        position:relative;
        min-height:24px;
        transition:height 0.45s ease;
      }

      .bar span {
        position:absolute;
        bottom:-24px;
        left:50%;
        transform:translateX(-50%);
        font-size:11px;
        color:var(--muted);
      }

      table {
        width:100%;
        border-collapse:separate;
        border-spacing:0;
      }

      thead th {
        text-align:left;
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:0.1em;
        color:var(--muted);
        padding:12px 16px;
        background:#f9fafb;
      }

      tbody td {
        padding:14px 16px;
        border-bottom:1px solid var(--line);
        font-size:13px;
      }

      tbody tr:hover { background:#f9fafb; }

      .tag {
        display:inline-flex;
        align-items:center;
        justify-content:center;
        padding:6px 14px;
        border-radius:999px;
        background:#0a0a0a;
        color:#fff;
        font-size:12px;
        font-weight:600;
      }

      .growth-list {
        margin-top:18px;
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      .growth-item {
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:13px;
        color:var(--text);
      }

      .progress-track {
        width:100%;
        height:8px;
        background:var(--bg-alt);
        border-radius:999px;
        overflow:hidden;
        margin-top:6px;
      }

      .progress-bar {
        height:100%;
        background:#0a0a0a;
        border-radius:999px;
      }

      .toast-notification {
        position:fixed;
        bottom:24px;
        right:24px;
        padding:14px 18px;
        border-radius:12px;
        background:#0a0a0a;
        color:#fff;
        opacity:0;
        pointer-events:none;
        transform:translateY(20px);
        transition:opacity 0.3s,transform 0.3s;
        box-shadow:0 15px 30px rgba(0,0,0,0.2);
        z-index:1200;
      }

      .toast-notification.show {
        opacity:1;
        transform:translateY(0);
      }

      .toast-notification.error { background:#ef4444; }

      @media (max-width:1080px) {
        .app-shell { grid-template-columns:1fr; }
        .sidebar { position:relative; height:auto; flex-direction:row; flex-wrap:wrap; }
        .main-area { padding:28px; }
      }

      @media (max-width:720px) {
        .hero-banner { padding:24px; }
        .topbar { flex-direction:column; align-items:flex-start; }
        .topbar-actions { width:100%; }
        .main-area { padding:20px; }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="logo">
          <span class="dot"></span>
          <span>Var√≥n</span>
        </div>
        <p class="sidebar-note">Admin command deck for approvals, compliance, and fulfillment oversight.</p>
        <p class="side-title">Workflow</p>
        <nav class="nav-links">
          <a href="#" class="side-link active" data-page="overview">Overview</a>
          <a href="#" class="side-link" data-page="pending-products">Pending Products</a>
          <a href="#" class="side-link" data-page="pending-riders">Pending Riders</a>
          <a href="#" class="side-link" data-page="product-edits">Product Edits</a>
          <a href="#" class="side-link" data-page="recovery-requests">Recovery Requests</a>
          <a href="#" class="side-link" data-page="product">Products</a>
          <a href="#" class="side-link" data-page="customer">Customers</a>
          <a href="#" class="side-link" data-page="transactions">Transactions</a>
          <a href="#" class="side-link" data-page="sellers">Active Sellers</a>
          <a href="#" class="side-link" data-page="riders">Active Riders</a>
          <a href="#" class="side-link" data-page="statistics">Statistics</a>
          <a href="#" class="side-link" data-page="setting">System Settings</a>
          <a href="#" class="side-link" data-page="help">Help & Support</a>
        </nav>
        <button type="button" class="logout-btn" onclick="confirmLogout(event)">Logout</button>
      </aside>
      <section class="main-area">
        <header class="topbar">
          <div class="topbar-heading">
            <p class="eyebrow">Operations center</p>
            <h1 class="page-title">Dashboard</h1>
          </div>
          <div class="topbar-actions">
            <button type="button" class="ghost-btn" onclick="window.location.reload()">Refresh</button>
            <a class="ghost-btn" href="/" target="_blank" rel="noopener">View store</a>
          </div>
        </header>

        <div class="hero-banner" id="overviewHero">
          <div class="hero-core">
            <p class="hero-eyebrow">Operations brief</p>
            <h2 class="hero-title">
              <span class="hero-title-highlight">Track approvals, fulfillment risk, and critical escalations</span>
              <span class="hero-title-rest">from one command surface.</span>
            </h2>
            <p class="hero-copy">This panel mirrors the seller styling but now highlights admin-specific KPIs so you can react to compliance holds, surge orders, and rider gaps without context switching.</p>
          </div>
          <div class="hero-metrics">
            <article class="hero-metric">
              <p class="metric-eyebrow">Items awaiting action</p>
              <div class="metric-main">
                <span class="value">‚Äî</span>
                <span class="hero-chip">Pending products & rider reviews</span>
              </div>
              <p class="metric-footnote">High-contrast color lets you see instant status before diving into queues.</p>
            </article>
            <article class="hero-metric">
              <p class="metric-eyebrow">Critical SLA lanes</p>
              <div class="metric-main">
                <span class="value accent">Live</span>
                <span class="hero-chip accent">Release-to-rider & disputes</span>
              </div>
              <p class="metric-footnote">Use the neon highlight to spot when escalations need admin overrides.</p>
            </article>
          </div>
        </div>

        <main class="content-area" id="dashboardContent">
          <div class="stats-grid">
            <div class="card">
              <div class="inner">
                <p class="metric">Total Revenue</p>
                <p class="value">‚Ç±0.00</p>
                <p class="hint">Live data from /admin/statistics</p>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <p class="metric">Orders Today</p>
                <p class="value">0</p>
                <p class="hint">Auto-updates from /admin/recent-orders</p>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <p class="metric">Active Sellers</p>
                <p class="value">0</p>
                <p class="hint">Watch approvals for spikes</p>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <p class="metric">Active Riders</p>
                <p class="value">0</p>
                <p class="hint">Keep capacity aligned with demand</p>
              </div>
            </div>
          </div>

          <div class="panel-grid">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                  <p class="metric">Customer growth</p>
                  <span class="hint">Top Philippine regions</span>
                </div>
                <div id="overview-customer-growth" class="growth-list">
                  <p style="color:var(--muted);margin:0">Loading regional data...</p>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                  <p class="metric">Sales pulse</p>
                  <span class="hint">Mini bar snapshot</span>
                </div>
                <div class="bar-chart">
                  <div class="bar" data-height="40"><span>Mon</span></div>
                  <div class="bar" data-height="65"><span>Tue</span></div>
                  <div class="bar" data-height="55"><span>Wed</span></div>
                  <div class="bar" data-height="80"><span>Thu</span></div>
                  <div class="bar" data-height="60"><span>Fri</span></div>
                  <div class="bar" data-height="70"><span>Sat</span></div>
                  <div class="bar" data-height="30"><span>Sun</span></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="inner">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                <p class="metric">Recent orders</p>
                <span class="hint">Last ten placed</span>
              </div>
              <div style="overflow:auto;margin-top:12px">
                <table>
                  <thead>
                    <tr><th>Order #</th><th>Buyer</th><th>Date</th><th>Amount</th><th>Status</th></tr>
                  </thead>
                  <tbody id="recent-orders-list">
                    <tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">Loading orders...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="inner">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                <p class="metric">Best selling product</p>
                <a href="#" style="font-size:12px;color:var(--muted)">View catalog</a>
              </div>
              <div id="best-product-container" style="display:flex;gap:14px;align-items:center;margin-top:14px">
                <p style="color:var(--muted);margin:0">Loading...</p>
              </div>
            </div>
          </div>
        </main>
      </section>
    </div>

    <div id="toastNotification" class="toast-notification" role="status" aria-live="polite"></div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <!-- Approve Confirmation Modal -->
    <div id="approveConfirmModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:12px;padding:28px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
        <h2 style="margin:0 0 16px;font-size:18px;font-weight:600">Approve this product?</h2>
        <p style="margin:0 0 24px;color:#666;font-size:14px">Are you sure you want to approve this product? It will be published immediately.</p>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button onclick="closeApproveModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="confirmApprove()" style="padding:10px 20px;border:none;background:#10b981;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Approve</button>
        </div>
      </div>
    </div>

    <!-- Reject Confirmation Modal -->
    <div id="rejectConfirmModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:12px;padding:28px;max-width:400px;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
        <h2 style="margin:0 0 16px;font-size:18px;font-weight:600">Reject this product?</h2>
        <p style="margin:0 0 16px;color:#666;font-size:14px">Enter rejection reason (will be sent to the seller):</p>
        <textarea id="rejectReason" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:inherit;font-size:14px;resize:vertical;min-height:80px" placeholder="Please provide a reason for rejection..."></textarea>
        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button onclick="closeRejectModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="confirmReject()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Reject</button>
        </div>
      </div>
    </div>

    <!-- Variant Decision Modal -->
    <div id="variantDecisionModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.55);display:none;align-items:center;justify-content:center;z-index:1100">
      <div style="background:#fff;border-radius:12px;padding:24px;max-width:360px;width:90%;box-shadow:0 20px 50px rgba(0,0,0,0.25);text-align:center">
        <h3 style="margin:0 0 12px;font-size:18px">Confirm Action</h3>
        <p id="variantDecisionMessage" style="margin:0 0 18px;color:#555;font-size:15px"></p>
        <div style="display:flex;gap:10px;justify-content:center">
          <button onclick="closeVariantDecisionModal()" style="padding:10px 20px;border:1px solid #d1d5db;background:#f3f4f6;color:#111827;border-radius:8px;font-weight:600;cursor:pointer">Cancel</button>
          <button id="variantDecisionConfirm" onclick="handleVariantDecision()" style="padding:10px 20px;border:none;background:#10b981;color:#fff;border-radius:8px;font-weight:600;cursor:pointer">Confirm</button>
        </div>
      </div>
    </div>

    <script>
      // Variables to store product ID during confirmation flow
      let pendingApprovalProductId = null;
      let pendingRejectionProductId = null;
      let toastTimeout = null;
      let selectedRiderId = null;
      let currentRiderDetails = null;
      const riderDocumentLabels = {
        'government_id': "Driver's License",
        'vehicle_registration': 'Vehicle Registration',
        'orcr': 'Official Receipt (OR/CR)',
        'car_photo': 'Vehicle Photo'
      };

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toastNotification');
        if (!toast) return;
        toast.textContent = message;
        toast.classList.remove('success', 'error', 'show');
        toast.classList.add(type === 'error' ? 'error' : 'success');
        // Allow reflow so removing show works before re-adding
        void toast.offsetWidth;
        toast.classList.add('show');
        if (toastTimeout) {
          clearTimeout(toastTimeout);
        }
        toastTimeout = setTimeout(() => {
          toast.classList.remove('show');
        }, 3500);
      }

      // Approve Modal Functions
      function openApproveModal(productId) {
        console.log('openApproveModal called with:', productId);
        console.log('Product ID type:', typeof productId);
        pendingApprovalProductId = productId;
        console.log('pendingApprovalProductId set to:', pendingApprovalProductId);
        document.getElementById('approveConfirmModal').style.display = 'flex';
      }

      function closeApproveModal() {
        document.getElementById('approveConfirmModal').style.display = 'none';
        pendingApprovalProductId = null;
      }

      function confirmApprove() {
        console.log('confirmApprove called');
        console.log('pendingApprovalProductId:', pendingApprovalProductId);
        if (!pendingApprovalProductId) {
          showToast('No product selected', 'error');
          return;
        }
        const productId = pendingApprovalProductId;
        closeApproveModal();
        approveProduct(productId);
      }

      // Reject Modal Functions
      function openRejectModal(productId) {
        pendingRejectionProductId = productId;
        const reasonField = document.getElementById('rejectReason');
        if (reasonField) {
          reasonField.value = '';
        }
        document.getElementById('rejectConfirmModal').style.display = 'flex';
      }

      function closeRejectModal() {
        document.getElementById('rejectConfirmModal').style.display = 'none';
        const reasonField = document.getElementById('rejectReason');
        if (reasonField) {
          reasonField.value = '';
        }
        pendingRejectionProductId = null;
      }

      function confirmReject() {
        if (!pendingRejectionProductId) {
          return;
        }
        const reasonField = document.getElementById('rejectReason');
        const reason = reasonField ? reasonField.value.trim() : '';
        if (!reason) {
          showToast('Please enter a rejection reason', 'error');
          return;
        }
        const productId = pendingRejectionProductId;
        closeRejectModal();
        rejectProductWithReason(productId, reason);
      }

      const pageTemplates = {
        'pending-products': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Pending Product Approvals</h2>
              <div id="pending-products-list">Loading pending products...</div>
            </div>
          </div>
          <!-- Product Details Modal -->
          <div id="product-details-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">üì¶ Product Details</h2>
                <button onclick="closeProductDetailsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <div id="product-details-body">Loading...</div>
            </div>
          </div>
        `,
        'pending-riders': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üöö Pending Rider Applications</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Review new riders awaiting approval</p>
              <div id="pending-riders-list">Loading pending riders...</div>
            </div>
          </div>
          <div id="rider-details-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:820px;width:90%;max-height:85vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;padding-bottom:12px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">Rider Application</h2>
                <button onclick="closeRiderDetailsModal()" style="background:none;border:none;font-size:26px;cursor:pointer;color:#888">&times;</button>
              </div>
              <div id="rider-details-body" style="min-height:160px;">Loading rider details...</div>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:24px">
                <button onclick="openRiderRejectModal()" class="tag" style="background:#ef4444;color:#fff;border:none;cursor:pointer;padding:12px 18px;font-weight:600">Reject</button>
                <button onclick="openRiderApproveModal()" class="tag" style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:12px 18px;font-weight:600">Approve</button>
              </div>
            </div>
          </div>
          <div id="rider-reject-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1100;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:480px;width:90%;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h3 style="margin:0">Provide Rejection Reason</h3>
                <button onclick="closeRiderRejectModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#888">&times;</button>
              </div>
              <textarea id="rider-reject-reason" rows="4" style="width:100%;border:1px solid var(--line);border-radius:8px;padding:10px;resize:vertical" placeholder="Share a short explanation for rejecting this application"></textarea>
              <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:18px">
                <button onclick="closeRiderRejectModal()" class="tag" style="background:#e5e7eb;color:#111;border:none;cursor:pointer;padding:10px 16px">Cancel</button>
                <button onclick="submitRiderRejection()" class="tag" style="background:#ef4444;color:#fff;border:none;cursor:pointer;padding:10px 16px">Submit Rejection</button>
              </div>
            </div>
          </div>
          <div id="rider-approve-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1100;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:420px;width:90%;text-align:center">
              <div style="font-size:20px;font-weight:600;margin-bottom:10px">Approve this rider?</div>
              <p style="color:#666;margin:0 0 20px;line-height:1.5">Confirming will move them to Active Riders and grant access to delivery tools.</p>
              <div style="display:flex;gap:12px;justify-content:center">
                <button onclick="closeRiderApproveModal()" class="tag" style="background:#e5e7eb;color:#111;border:none;cursor:pointer;padding:10px 18px">Cancel</button>
                <button onclick="confirmRiderApproval()" class="tag" style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:10px 18px;font-weight:600">Confirm</button>
              </div>
            </div>
          </div>
        `,
        'product-edits': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üìù Product Edit Requests</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Review and approve changes requested by sellers</p>
              <div id="product-edits-list">Loading product edits...</div>
            </div>
          </div>
          <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">Review Product Edit</h2>
                <button onclick="closeEditModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <div id="edit-modal-body">Loading...</div>
            </div>
          </div>
        `,
        'recovery-requests': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">‚ôªÔ∏è Product Recovery Requests</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Review requests from sellers to recover archived products</p>
              <div id="recovery-requests-list">Loading recovery requests...</div>
            </div>
          </div>
        `,
        'sellers': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üë• Active Sellers</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">View all active sellers in the system</p>
              <div id="active-sellers-list">Loading sellers...</div>
            </div>
          </div>
        `,
        'riders': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üöó Active Riders</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">View all active riders in the system</p>
              <div id="active-riders-list">Loading riders...</div>
            </div>
          </div>
        `,
        'product': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üì¶ All Products</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Browse and manage all products in the system</p>
              <div id="all-products-list">Loading products...</div>
            </div>
          </div>
        `,
        'customer': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üë• Customer Management</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">View and manage customer accounts</p>
              <div id="customers-list">Loading customers...</div>
            </div>
          </div>
        `,
        'transactions': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üí≥ Transactions</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">View all transactions and payment history</p>
              <div id="transactions-list">Loading transactions...</div>
            </div>
          </div>
        `,
        'statistics': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üìä Statistics</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">View detailed analytics and statistics</p>
              <div id="statistics-content">Loading statistics...</div>
            </div>
          </div>
          <div class="card" style="margin-top: 20px;">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üìà Customer Growth (Philippines)</h2>
              <div id="customer-growth-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div id="regional-growth">Loading regional data...</div>
                <div style="background: #0a0a0a; color: #fff; border-radius: 10px; padding: 24px; display: flex; flex-direction: column; justify-content: center;">
                  <h3 style="margin: 0 0 16px; font-size: 18px;">See more detail statistic to analyze your decision</h3>
                  <button onclick="document.getElementById('detailed-stats-modal').style.display='flex'" class="tag" style="background:#fff;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px;width:fit-content">See more</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Detailed Statistics Modal -->
          <div id="detailed-stats-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:80vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">Detailed Statistics</h2>
                <button onclick="document.getElementById('detailed-stats-modal').style.display='none'" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <div id="detailed-stats-body">Loading...</div>
            </div>
          </div>
        `,
        'setting': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 24px;">‚öôÔ∏è System Settings</h2>
              <div style="display: grid; gap: 24px;">
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600;">General Settings</h3>
                  <div style="display: grid; gap: 16px;">
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-weight: 500;">System Name</label>
                      <input type="text" id="system-name" placeholder="e.g., Var-n E-Commerce" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-weight: 500;">Support Email</label>
                      <input type="email" id="support-email" placeholder="support@example.com" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; box-sizing: border-box;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                      <input type="tel" id="support-phone" placeholder="+63 9XX XXX XXXX" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; box-sizing: border-box;">
                    </div>
                  </div>
                </div>
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600;">Maintenance Mode</h3>
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="checkbox" id="maintenance-mode" style="width: 20px; height: 20px; cursor: pointer;">
                    <label for="maintenance-mode" style="font-weight: 500; cursor: pointer;">Enable Maintenance Mode</label>
                  </div>
                  <p style="margin: 12px 0 0; font-size: 13px; color: var(--muted);">When enabled, the store will be unavailable to customers.</p>
                </div>
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600;">Notification Settings</h3>
                  <div style="display: grid; gap: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input type="checkbox" id="email-notifications" checked style="width: 20px; height: 20px; cursor: pointer;">
                      <label for="email-notifications" style="font-weight: 500; cursor: pointer;">Email Notifications</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input type="checkbox" id="order-alerts" checked style="width: 20px; height: 20px; cursor: pointer;">
                      <label for="order-alerts" style="font-weight: 500; cursor: pointer;">Order Alerts</label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                      <input type="checkbox" id="seller-alerts" checked style="width: 20px; height: 20px; cursor: pointer;">
                      <label for="seller-alerts" style="font-weight: 500; cursor: pointer;">Seller Management Alerts</label>
                    </div>
                  </div>
                </div>
              </div>
              <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--line);">
                <button onclick="location.reload()" class="tag" style="background: #f3f4f6; color: #0a0a0a; cursor: pointer; border: none; padding: 10px 16px;">Cancel</button>
                <button onclick="saveSystemSettings()" class="tag" style="background: #0a0a0a; color: #fff; cursor: pointer; border: none; padding: 10px 16px;">Save Settings</button>
              </div>
            </div>
          </div>
        `,
        'help': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 24px;">üìö Help & Support</h2>
              <div style="display: grid; gap: 24px;">
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">‚ùì Frequently Asked Questions</h3>
                  <div style="display: grid; gap: 12px;" id="faq-list">
                    <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; cursor: pointer;" onclick="toggleFAQ(this)">
                      <div style="font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                        <span>How do I approve new products?</span>
                        <span style="font-size: 20px; color: var(--muted);">+</span>
                      </div>
                      <div style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line); font-size: 14px; color: var(--muted); line-height: 1.6;">
                        Navigate to "Pending Products", review the product details, and click the approve button. The seller will be notified immediately.
                      </div>
                    </div>
                    <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; cursor: pointer;" onclick="toggleFAQ(this)">
                      <div style="font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                        <span>How do I manage sellers?</span>
                        <span style="font-size: 20px; color: var(--muted);">+</span>
                      </div>
                      <div style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line); font-size: 14px; color: var(--muted); line-height: 1.6;">
                        Visit the "Active Sellers" section to view all registered sellers, their store information, and product counts. You can take action on seller accounts from here.
                      </div>
                    </div>
                    <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; cursor: pointer;" onclick="toggleFAQ(this)">
                      <div style="font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                        <span>How do I view transaction history?</span>
                        <span style="font-size: 20px; color: var(--muted);">+</span>
                      </div>
                      <div style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line); font-size: 14px; color: var(--muted); line-height: 1.6;">
                        Go to the "Transactions" section to see all orders, payment status, and delivery information. You can filter by date or customer.
                      </div>
                    </div>
                    <div style="padding: 12px; background: #f9f9f9; border-radius: 6px; cursor: pointer;" onclick="toggleFAQ(this)">
                      <div style="font-weight: 500; display: flex; justify-content: space-between; align-items: center;">
                        <span>What do the statistics show?</span>
                        <span style="font-size: 20px; color: var(--muted);">+</span>
                      </div>
                      <div style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--line); font-size: 14px; color: var(--muted); line-height: 1.6;">
                        The statistics page displays total revenue, order count, active users, and products. You can also see customer growth by region to analyze market trends.
                      </div>
                    </div>
                  </div>
                </div>
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">üìñ Documentation</h3>
                  <ul style="margin: 0; padding-left: 20px; list-style: disc;">
                    <li style="margin-bottom: 8px;"><a href="#" style="color: var(--primary); text-decoration: none; font-weight: 500;">Admin Dashboard Guide</a></li>
                    <li style="margin-bottom: 8px;"><a href="#" style="color: var(--primary); text-decoration: none; font-weight: 500;">Product Management Tutorial</a></li>
                    <li style="margin-bottom: 8px;"><a href="#" style="color: var(--primary); text-decoration: none; font-weight: 500;">Order Processing Workflow</a></li>
                    <li style="margin-bottom: 8px;"><a href="#" style="color: var(--primary); text-decoration: none; font-weight: 500;">Seller Verification Process</a></li>
                    <li style="margin-bottom: 8px;"><a href="#" style="color: var(--primary); text-decoration: none; font-weight: 500;">Rider Assignment & Tracking</a></li>
                  </ul>
                </div>
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 20px;">
                  <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">üìû Contact Support</h3>
                  <div style="display: grid; gap: 12px; font-size: 14px;">
                    <div>
                      <strong>Email:</strong>
                      <p style="margin: 4px 0 0; color: var(--muted);" id="support-contact-email">support@varn.com</p>
                    </div>
                    <div>
                      <strong>Phone:</strong>
                      <p style="margin: 4px 0 0; color: var(--muted);" id="support-contact-phone">+63 977 XXX XXXX</p>
                    </div>
                    <div>
                      <strong>Hours:</strong>
                      <p style="margin: 4px 0 0; color: var(--muted);">Monday - Friday: 9:00 AM - 6:00 PM (PST)</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `
      };

      function loadPage(page) {
        console.log('Loading page:', page);


        document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));

        document.querySelector(`[data-page="${page}"]`)?.classList.add('active');

        const content = document.getElementById('dashboardContent');
        const hero = document.getElementById('overviewHero');
        if (hero) {
          hero.style.display = page === 'overview' ? '' : 'none';
        }


        if (page === 'overview') {
          window.location.reload();
          return;
        }

        if (pageTemplates[page]) {
          content.innerHTML = pageTemplates[page];


          if (page === 'pending-products') {
            loadPendingProducts();
          } else if (page === 'pending-riders') {
            loadPendingRiders();
          } else if (page === 'product-edits') {
            loadProductEdits();
          } else if (page === 'recovery-requests') {
            loadRecoveryRequests();
          } else if (page === 'sellers') {
            loadActiveSellers();
          } else if (page === 'riders') {
            loadActiveRiders();
          } else if (page === 'product') {
            loadAllProducts();
          } else if (page === 'customer') {
            loadCustomers();
          } else if (page === 'transactions') {
            loadTransactions();
          } else if (page === 'statistics') {
            loadStatistics();
          } else if (page === 'setting') {
            loadSettings();
          } else if (page === 'help') {
            loadHelp();
          }
        } else {
          content.innerHTML = `
            <div class="card">
              <div class="inner">
                <h2 style="margin: 0 0 16px;">${page.charAt(0).toUpperCase() + page.slice(1)}</h2>
                <p style="text-align:center;color:#999;padding:40px;">This page is under construction.</p>
              </div>
            </div>
          `;
        }


        const pageNames = {
          'overview': 'Dashboard',
          'pending-products': 'Pending Products',
          'pending-riders': 'Pending Riders',
          'product': 'All Products',
          'customer': 'Customers',
          'transactions': 'Transactions',
          'statistics': 'Statistics',
          'riders': 'Active Riders',
          'sellers': 'Active Sellers',
          'setting': 'System Settings',
          'help': 'Help & Support',
          'log': 'Activity Log'
        };
        document.querySelector('.page-title').textContent = pageNames[page] || 'Dashboard';
      }

      function loadPendingProducts() {
        console.log('Loading pending products...');
        fetch('/admin/pending-products')
          .then(response => {
            console.log('Products response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Products data:', data);
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Seller</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              data.products.forEach(product => {
                const stockCount =
                  product.stock ??
                  product.total_stock ??
                  product.variant_stock ??
                  product.inventory_stock ??
                  0;
                const date = new Date(product.created_at).toLocaleDateString();
                const productId = product.id;
                html += `
                  <tr id="product-${productId}">
                    <td>
                      <strong>${product.name}</strong><br>
                      <small style="color: var(--muted)">${product.description ? product.description.substring(0, 50) + '...' : 'No description'}</small>
                    </td>
                    <td>${product.store_name}</td>
                    <td>‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td>${stockCount} pcs</td>
                    <td>${date}</td>
                    <td>
                      <button class="tag" onclick="viewProductDetails(${productId})" style="background: #3b82f6; cursor: pointer; border: none;">View Details</button>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              document.getElementById('pending-products-list').innerHTML = html;
            } else {
              document.getElementById('pending-products-list').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending products to review</p>';
            }
          })
          .catch(error => {
            document.getElementById('pending-products-list').innerHTML = '<p style="color:#ef4444;">Error loading pending products</p>';
          });
      }

      function approveProduct(productId) {
        console.log('Approving product:', productId);
        console.log('Product ID type:', typeof productId);
        
        // Ensure productId is a number
        const numericId = parseInt(productId, 10);
        if (isNaN(numericId)) {
          showToast('Invalid product ID: ' + productId, 'error');
          return;
        }
        
        const url = `/admin/approve-product/${numericId}`;
        console.log('Fetching URL:', url);
        
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('Approve response status:', response.status);
          console.log('Approve response URL:', response.url);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Approve response data:', data);
          if (data.success) {
            showToast('Product approved successfully!', 'success');
            const detailsModal = document.getElementById('product-details-modal');
            if (detailsModal && detailsModal.style.display !== 'none') {
              closeProductDetailsModal();
            }
            // Remove the approved product from the DOM
            const productRow = document.getElementById(`product-${numericId}`);
            if (productRow) {
              productRow.remove();
            }
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch(error => {
          console.error('Approve error:', error);
          showToast('Error approving product: ' + error.message, 'error');
        });
      }

      function rejectProduct(productId) {
        const reason = prompt('Enter rejection reason (will be sent to the seller):');
        if (reason === null) return;

        fetch(`/admin/reject-product/${productId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || 'No reason provided' })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove from pending products list
            const productRow = document.getElementById(`product-${productId}`);
            if (productRow) {
              productRow.remove();
            }

            // Update badge count
            const badge = document.querySelector('[data-page="pending-products"] .tag');
            if (badge) {
              const count = parseInt(badge.textContent) - 1;
              badge.textContent = count > 0 ? count : '0';
            }
            
            // Check if list is empty and show message
            const pendingList = document.getElementById('pending-products-list');
            if (pendingList && pendingList.querySelector('table tbody')?.children.length === 0) {
              pendingList.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending products to review</p>';
            }

            showToast('Product rejected successfully!', 'success');
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch(error => {
          showToast('Error rejecting product: ' + error.message, 'error');
        });
      }

      function rejectProductWithReason(productId, reason) {
        console.log('Rejecting product:', productId, 'Reason:', reason);
        fetch(`/admin/reject-product/${productId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason: reason || 'No reason provided' })
        })
        .then(response => {
          console.log('Reject response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Reject response data:', data);
          if (data.success) {
            showToast('Product rejected successfully!', 'success');
            // Remove from pending products list
            const productRow = document.getElementById(`product-${productId}`);
            if (productRow) {
              productRow.remove();
            }

            const badge = document.querySelector('[data-page="pending-products"] .tag');
            if (badge) {
              const count = parseInt(badge.textContent) - 1;
              badge.textContent = count > 0 ? count : '0';
            }

            const pendingList = document.getElementById('pending-products-list');
            if (pendingList && pendingList.querySelector('table tbody')?.children.length === 0) {
              pendingList.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending products to review</p>';
            }
          } else {
            showToast('Error: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch(error => {
          console.error('Reject error:', error);
          showToast('Error rejecting product: ' + error.message, 'error');
        });
      }

      function loadPendingSellers() {
        console.log('Loading pending sellers...');
        fetch('/admin/pending-sellers')
          .then(response => {
            console.log('Sellers response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Sellers data:', data);
            if (data.sellers && data.sellers.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Seller Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Store Name</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              data.sellers.forEach(seller => {
                const date = new Date(seller.created_at).toLocaleDateString();
                html += `
                  <tr id="seller-${seller.id}">
                    <td><strong>${seller.first_name} ${seller.last_name}</strong></td>
                    <td>${seller.email}</td>
                    <td>${seller.phone || 'N/A'}</td>
                    <td>${seller.store_name}</td>
                    <td>${date}</td>
                    <td>
                      <div style="display: flex; gap: 8px;">
                        <button class="tag" onclick="approveSeller(${seller.id})" style="background: #10b981; cursor: pointer; border: none;">Approve</button>
                        <button class="tag" onclick="rejectSeller(${seller.id})" style="background: #ef4444; cursor: pointer; border: none;">Reject</button>
                      </div>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              document.getElementById('pending-sellers-list').innerHTML = html;
            } else {
              document.getElementById('pending-sellers-list').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending sellers to verify</p>';
            }
          })
          .catch(error => {
            console.error('Error loading sellers:', error);
            document.getElementById('pending-sellers-list').innerHTML = '<p style="color:#ef4444;">Error loading pending sellers: ' + error.message + '</p>';
          });
      }

      function approveSeller(sellerId) {
        fetch(`/admin/approve-seller/${sellerId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {

            document.getElementById(`seller-${sellerId}`)?.remove();
          } else {

          }
        })
        .catch(error => {

        });
      }

      function rejectSeller(sellerId) {
        fetch(`/admin/reject-seller/${sellerId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {

            document.getElementById(`seller-${sellerId}`)?.remove();
          } else {

          }
        })
        .catch(error => {

        });
      }

      function loadPendingRiders() {
        console.log('Loading pending riders...');
        fetch('/admin/pending-riders')
          .then(response => {
            console.log('Riders response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Riders data:', data);
            const listContainer = document.getElementById('pending-riders-list');
            if (!listContainer) {
              return;
            }

            if (data.riders && data.riders.length > 0) {
              const badge = document.getElementById('pending-riders-count');
              if (badge) {
                badge.textContent = data.riders.length.toString();
              }

              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Rider Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Vehicle Type</th>
                      <th>License Number</th>
                      <th>Applied On</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              data.riders.forEach(rider => {
                const applied = rider.created_at ? new Date(rider.created_at).toLocaleDateString() : 'N/A';
                html += `
                  <tr id="rider-${rider.id}">
                    <td><strong>${rider.first_name || ''} ${rider.last_name || ''}</strong></td>
                    <td>${rider.email || 'N/A'}</td>
                    <td>${rider.phone || 'N/A'}</td>
                    <td>${rider.vehicle_type || 'N/A'}</td>
                    <td>${rider.license_number || 'N/A'}</td>
                    <td>${applied}</td>
                    <td>
                      <button class="tag" onclick="viewRiderDetails(${rider.id})" style="background: #3b82f6; cursor: pointer; border: none;">View Details</button>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              listContainer.innerHTML = html;
            } else {
              listContainer.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending riders to verify</p>';
              const badge = document.getElementById('pending-riders-count');
              if (badge) {
                badge.textContent = '0';
              }
            }
          })
          .catch(error => {
            console.error('Error loading riders:', error);
            const listContainer = document.getElementById('pending-riders-list');
            if (listContainer) {
              listContainer.innerHTML = '<p style="color:#ef4444;">Error loading pending riders</p>';
            }
          });
      }

      function removeRiderRow(riderId) {
        const listContainer = document.getElementById('pending-riders-list');
        if (!listContainer) {
          const badge = document.getElementById('pending-riders-count');
          if (badge) {
            badge.textContent = '0';
          }
          return;
        }

        const row = document.getElementById(`rider-${riderId}`);
        const tbody = row ? row.closest('tbody') : listContainer.querySelector('tbody');
        if (row) {
          row.remove();
        }

        let remaining = 0;
        if (tbody) {
          remaining = tbody.querySelectorAll('tr').length;
        }

        if (remaining === 0) {
          listContainer.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending riders to verify</p>';
        }

        const badge = document.getElementById('pending-riders-count');
        if (badge) {
          badge.textContent = remaining.toString();
        }

        if (document.getElementById('active-riders-list')) {
          loadActiveRiders();
        }
      }

      function viewRiderDetails(riderId) {
        selectedRiderId = riderId;
        currentRiderDetails = null;
        const modal = document.getElementById('rider-details-modal');
        const body = document.getElementById('rider-details-body');
        if (body) {
          body.innerHTML = '<p style="text-align:center;color:#777;padding:30px;">Loading rider details...</p>';
        }
        if (modal) {
          modal.style.display = 'flex';
        }

        fetch(`/admin/riders/${riderId}/details`)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              if (body) {
                body.innerHTML = `<p style="color:#ef4444;text-align:center;padding:30px;">${data.error}</p>`;
              }
              return;
            }
            currentRiderDetails = data;
            if (body) {
              body.innerHTML = renderRiderDetails(data.rider, data.documents || []);
            }
          })
          .catch(error => {
            console.error('Error loading rider details:', error);
            if (body) {
              body.innerHTML = '<p style="color:#ef4444;text-align:center;padding:30px;">Unable to load rider details. Please try again.</p>';
            }
          });
      }

      function renderRiderDetails(rider, documents) {
        if (!rider) {
          return '<p style="padding:20px;color:#999;">Rider information not found.</p>';
        }

        const submittedDocs = documents && documents.length ? documents.map(doc => {
          const label = riderDocumentLabels[doc.document_type] || doc.document_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
          const status = doc.verified ? 'Verified' : 'Pending Review';
          return `
            <div style="border:1px solid var(--line);border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:6px;">
              <div style="font-weight:600;">${label}</div>
              <div style="font-size:13px;color:var(--muted);">${status}</div>
              <a href="${doc.file_url}" target="_blank" rel="noopener" class="tag" style="background:#0a0a0a;color:#fff;width:fit-content;padding:6px 12px;">View Document</a>
            </div>
          `;
        }).join('') : '<p style="color:#999;">No documents uploaded yet.</p>';

        const applied = rider.created_at ? new Date(rider.created_at).toLocaleString() : 'N/A';

        return `
          <div style="display:grid;gap:18px">
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;">
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Name</div>
                <div style="font-size:18px;font-weight:600;">${rider.first_name || ''} ${rider.last_name || ''}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Email</div>
                <div>${rider.email || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Phone</div>
                <div>${rider.phone || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Vehicle Type</div>
                <div>${rider.vehicle_type || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">License Number</div>
                <div>${rider.license_number || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Service Area</div>
                <div>${rider.service_area || 'N/A'}</div>
              </div>
              <div>
                <div style="font-size:12px;color:var(--muted);text-transform:uppercase;">Applied On</div>
                <div>${applied}</div>
              </div>
            </div>
            <div>
              <h3 style="margin:0 0 10px;font-size:16px;">Submitted Documents</h3>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;">
                ${submittedDocs}
              </div>
            </div>
          </div>
        `;
      }

      function closeRiderDetailsModal() {
        const modal = document.getElementById('rider-details-modal');
        if (modal) {
          modal.style.display = 'none';
        }
        selectedRiderId = null;
        currentRiderDetails = null;
      }

      function openRiderRejectModal() {
        if (!selectedRiderId) {
          showToast('Select a rider first', 'error');
          return;
        }
        const modal = document.getElementById('rider-reject-modal');
        if (modal) {
          modal.style.display = 'flex';
        }
        const input = document.getElementById('rider-reject-reason');
        if (input) {
          input.value = '';
        }
      }

      function closeRiderRejectModal() {
        const modal = document.getElementById('rider-reject-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function openRiderApproveModal() {
        if (!selectedRiderId) {
          showToast('Select a rider first', 'error');
          return;
        }
        const modal = document.getElementById('rider-approve-modal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }

      function closeRiderApproveModal() {
        const modal = document.getElementById('rider-approve-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function confirmRiderApproval() {
        closeRiderApproveModal();
        approveRider();
      }

      function approveRider(riderId) {
        const targetId = riderId || selectedRiderId;
        if (!targetId) {
          showToast('Select a rider first', 'error');
          return;
        }
        fetch(`/admin/approve-rider/${targetId}`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Rider approved successfully', 'success');
              removeRiderRow(targetId);
              closeRiderDetailsModal();
            } else {
              showToast(data.error || 'Failed to approve rider', 'error');
            }
          })
          .catch(error => {
            console.error('Approve rider error:', error);
            showToast('Failed to approve rider', 'error');
          });
      }

      function submitRiderRejection() {
        const reasonField = document.getElementById('rider-reject-reason');
        const reason = reasonField ? reasonField.value.trim() : '';
        if (!selectedRiderId) {
          showToast('Select a rider first', 'error');
          return;
        }
        if (!reason) {
          showToast('Please provide a rejection reason', 'error');
          return;
        }

        fetch(`/admin/reject-rider/${selectedRiderId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reason })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Rider rejected', 'success');
              closeRiderRejectModal();
              closeRiderDetailsModal();
              removeRiderRow(selectedRiderId);
            } else {
              showToast(data.error || 'Failed to reject rider', 'error');
            }
          })
          .catch(error => {
            console.error('Reject rider error:', error);
            showToast('Failed to reject rider', 'error');
          });
      }

      function approveSingleEdit(editId){confirmVariantDecision(editId,'approve')}
      function rejectSingleEdit(editId){confirmVariantDecision(editId,'reject')}

      function loadProductEdits() {
        const container = document.getElementById('product-edits-list');
        const editsCount = document.getElementById('pending-edits-count');
        if (!container) {
          return;
        }

        fetch('/admin/pending-edits')
          .then(response => response.json())
          .then(data => {
            const pendingEdits = Array.isArray(data)
              ? data
              : (data && Array.isArray(data.pending_edits) ? data.pending_edits : []);

            if (pendingEdits.length) {
              if (editsCount) {
                editsCount.textContent = pendingEdits.length.toString();
              }

              let html = `
                <table class="dashboard-table" style="width:100%;border-spacing:0">
                  <thead>
                    <tr>
                      <th style="text-align:left;padding:12px 8px;font-size:13px;color:var(--muted);text-transform:uppercase">Product</th>
                      <th style="text-align:left;padding:12px 8px;font-size:13px;color:var(--muted);text-transform:uppercase">Seller</th>
                      <th style="text-align:left;padding:12px 8px;font-size:13px;color:var(--muted);text-transform:uppercase">Changes</th>
                      <th style="text-align:left;padding:12px 8px;font-size:13px;color:var(--muted);text-transform:uppercase">Submitted</th>
                      <th style="text-align:right;padding:12px 8px;font-size:13px;color:var(--muted);text-transform:uppercase"></th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              pendingEdits.forEach(item => {
                const submittedAt = item.created_at || item.updated_at || item.requested_at;
                const date = submittedAt ? new Date(submittedAt).toLocaleString() : '‚Äî';

                html += `
                  <tr id="edit-row-${item.product_id}">
                    <td><strong>${item.product_name}</strong></td>
                    <td>${item.store_name}</td>
                    <td><span class="tag" style="background:#fef3c7;color:#92400e">${item.edit_count} change${item.edit_count > 1 ? 's' : ''}</span></td>
                    <td style="color:var(--muted);font-size:13px">${date}</td>
                    <td style="text-align:right">
                      <button class="tag" onclick="viewEditDetails(${item.product_id})" style="background:#0a0a0a;cursor:pointer;border:none">Review</button>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              if (editsCount) {
                editsCount.textContent = '0';
              }
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">‚úì No pending edit requests</p>';
            }
          })
          .catch(error => {
            console.error('Failed to load product edits:', error);
            container.innerHTML = '<p style="color:#ef4444">Error loading edits</p>';
          });
      }

      function viewEditDetails(productId) {
        const modal = document.getElementById('edit-modal');
        modal.style.display = 'flex';
        document.getElementById('edit-modal-body').innerHTML = 'Loading...';

        fetch('/admin/product-edit-details/' + productId)
          .then(response => response.json())
          .then(data => {
            if (data.product && data.edits) {
              const FIELD_LABELS = {
                name: 'Product Name',
                description: 'Description',
                price: 'Price',
                brand: 'Brand',
                category_id: 'Category',
                variant_add: 'Variant Added',
                variant_update: 'Variant Update',
                variant_delete: 'Variant Removal'
              };
              const VARIANT_FIELDS = ['variant_add', 'variant_update', 'variant_delete'];
              const VARIANT_ACTION_LABELS = {
                variant_add: 'Variant Added',
                variant_update: 'Variant Updated',
                variant_delete: 'Variant Removed'
              };

              const escapeHtml = (value = '') => String(value)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');

              const tryParseJSON = raw => {
                if (!raw || typeof raw !== 'string') return null;
                try { return JSON.parse(raw); } catch (err) { return null; }
              };

              const formatFieldLabel = name => {
                if (!name) return 'Edit';
                if (FIELD_LABELS[name]) return FIELD_LABELS[name];
                return name.split('_').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ');
              };

              const formatVariantTitle = edit => {
                const variant = tryParseJSON(edit.new_value) || tryParseJSON(edit.old_value) || {};
                const descriptor = [variant.color, variant.size].filter(Boolean).map(escapeHtml).join(' ¬∑ ');
                const base = VARIANT_ACTION_LABELS[edit.field_name] || 'Variant Change';
                return descriptor ? `${base} ‚Äî ${descriptor}` : base;
              };

              const formatCurrency = raw => {
                const amount = Number(raw);
                return Number.isNaN(amount) ? escapeHtml(raw) : `‚Ç±${amount.toFixed(2)}`;
              };

              const renderVariantDetails = (variant, type, fieldName) => {
                if (!variant || typeof variant !== 'object') {
                  let placeholder = '(no data)';
                  if (fieldName === 'variant_add' && type === 'old') placeholder = 'Not yet created';
                  if (fieldName === 'variant_delete' && type === 'new') placeholder = 'Variant will be removed';
                  return `<div style="color:var(--muted);font-style:italic">${placeholder}</div>`;
                }

                const chips = [];
                if (variant.color) chips.push({ label: 'Color', value: variant.color });
                if (variant.size) chips.push({ label: 'Size', value: variant.size });
                if (variant.stock_quantity !== undefined && variant.stock_quantity !== null) {
                  chips.push({ label: 'Stock', value: variant.stock_quantity });
                }
                if (variant.is_active !== undefined && variant.is_active !== null) {
                  chips.push({ label: 'Active', value: variant.is_active ? 'Yes' : 'No' });
                }

                if (!chips.length) {
                  return '<div style="color:var(--muted);font-style:italic">Variant info unavailable</div>';
                }

                const badgeBg = type === 'old' ? '#fee2e2' : '#dcfce7';
                const badgeColor = type === 'old' ? '#b91c1c' : '#166534';

                return `
                  <div style="display:flex;flex-wrap:wrap;gap:6px">
                    ${chips.map(chip => `
                      <span style="background:${badgeBg};color:${badgeColor};padding:4px 8px;border-radius:999px;font-size:12px">
                        ${chip.label}: <strong>${escapeHtml(chip.value)}</strong>
                      </span>
                    `).join('')}
                  </div>
                `;
              };

              const renderValueContent = (edit, rawValue, type) => {
                if (!rawValue) {
                  return '<div style="color:var(--muted);font-style:italic">(empty)</div>';
                }

                const textStyle = type === 'old'
                  ? 'color:#ef4444;text-decoration:line-through'
                  : 'color:#10b981;font-weight:500';

                const formattedValue = edit.field_name === 'price'
                  ? formatCurrency(rawValue)
                  : escapeHtml(rawValue);

                return `<div style="${textStyle}">${formattedValue}</div>`;
              };

              const standardEdits = [];
              const variantEdits = [];
              data.edits.forEach(edit => {
                if (VARIANT_FIELDS.includes(edit.field_name)) {
                  variantEdits.push(edit);
                } else {
                  standardEdits.push(edit);
                }
              });

              let html = `
                <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:20px">
                  <h3 style="margin:0 0 8px">${data.product.name}</h3>
                  <p style="margin:0;color:var(--muted);font-size:14px">Store: ${data.product.store_name}</p>
                </div>

                <h3 style="margin:20px 0 12px">Requested Changes:</h3>
              `;

              if (!standardEdits.length && !variantEdits.length) {
                html += '<p style="color:var(--muted);font-size:14px">No pending edits for this product.</p>';
              }

              standardEdits.forEach(edit => {
                const fieldLabel = formatFieldLabel(edit.field_name);
                html += `
                  <div style="background:#f9fafb;padding:12px;border-radius:6px;margin:8px 0;border-left:3px solid #3b82f6" id="edit-item-${edit.id}">
                    <div style="font-weight:600;color:#0a0a0a;margin-bottom:6px">üìù ${fieldLabel}</div>
                    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;font-size:14px">
                      <div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Current</div>
                        ${renderValueContent(edit, edit.old_value, 'old')}
                      </div>
                      <div style="color:var(--muted)">‚Üí</div>
                      <div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Proposed</div>
                        ${renderValueContent(edit, edit.new_value, 'new')}
                      </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px">
                      <button class="tag" onclick="confirmVariantDecision(${edit.id}, 'approve')" style="background:#10b981;cursor:pointer;border:none">‚úì Approve</button>
                      <button class="tag" onclick="confirmVariantDecision(${edit.id}, 'reject')" style="background:#ef4444;cursor:pointer;border:none">‚úó Reject</button>
                    </div>
                  </div>
                `;
              });

              if (variantEdits.length) {
                html += `
                  <div style="background:#f9fafb;padding:16px;border-radius:6px;margin:12px 0;border-left:3px solid #7c3aed">
                    <div style="font-weight:600;color:#0a0a0a;margin-bottom:10px">üß© Variant Changes (${variantEdits.length})</div>
                    <div style="display:flex;flex-direction:column;gap:12px">
                `;

                variantEdits.forEach(edit => {
                  html += `
                    <div id="edit-item-${edit.id}" class="variant-edit-row" style="background:#fff;border:1px solid var(--line);border-radius:8px;padding:12px 14px">
                      <div style="font-weight:600;margin-bottom:10px">${formatVariantTitle(edit)}</div>
                      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center">
                        <div>
                          <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Current</div>
                          ${renderVariantDetails(tryParseJSON(edit.old_value), 'old', edit.field_name)}
                        </div>
                        <div style="color:var(--muted)">‚Üí</div>
                        <div>
                          <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Proposed</div>
                          ${renderVariantDetails(tryParseJSON(edit.new_value), 'new', edit.field_name)}
                        </div>
                      </div>
                      <div style="display:flex;gap:8px;margin-top:12px">
                        <button class="tag" onclick="confirmVariantDecision(${edit.id}, 'approve')" style="background:#10b981;cursor:pointer;border:none">‚úì Approve</button>
                        <button class="tag" onclick="confirmVariantDecision(${edit.id}, 'reject')" style="background:#ef4444;cursor:pointer;border:none">‚úó Reject</button>
                      </div>
                    </div>
                  `;
                });

                html += `
                    </div>
                  </div>
                `;
              }

              html += `
                <div style="display:flex;gap:12px;margin-top:24px;padding-top:20px;border-top:2px solid var(--line)">
                  <button class="tag" onclick="approveAllProductEdits(${productId})" style="background:#10b981;cursor:pointer;border:none;padding:10px 16px">‚úì Approve All Changes</button>
                  <button class="tag" onclick="closeEditModal()" style="background:#f3f4f6;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px">Close</button>
                </div>
              `;

              document.getElementById('edit-modal-body').innerHTML = html;
            } else {
              document.getElementById('edit-modal-body').innerHTML = '<p style="color:#ef4444">Unable to load edit details.</p>';
            }
          })
          .catch(error => {
            document.getElementById('edit-modal-body').innerHTML = '<p style="color:#ef4444">Error loading details</p>';
          });
      }

      function confirmVariantDecision(editId, action) {
        const modal = document.getElementById('variantDecisionModal');
        if (!modal) return;
        modal.dataset.editId = editId;
        modal.dataset.action = action;
        delete modal.dataset.bulkProductId;
        const message = action === 'approve'
          ? 'Approve this change?'
          : 'Reject this change?';
        document.getElementById('variantDecisionMessage').textContent = message;
        document.getElementById('variantDecisionConfirm').textContent = action === 'approve' ? 'Approve' : 'Reject';
        document.getElementById('variantDecisionConfirm').style.background = action === 'approve' ? '#10b981' : '#ef4444';
        modal.style.display = 'flex';
      }

      function closeVariantDecisionModal() {
        const modal = document.getElementById('variantDecisionModal');
        if (!modal) return;
        modal.style.display = 'none';
        delete modal.dataset.editId;
        delete modal.dataset.action;
        delete modal.dataset.bulkProductId;
      }

      function handleVariantDecision() {
        const modal = document.getElementById('variantDecisionModal');
        if (!modal) return;
        const editId = modal.dataset.editId;
        const action = modal.dataset.action;
        const bulkProductId = modal.dataset.bulkProductId;
        closeVariantDecisionModal();

        if (action === 'approve-all') {
          if (!bulkProductId) {
            showToast('Unable to process action.', 'error');
            return;
          }
          executeApproveAllProductEdits(bulkProductId);
          return;
        }

        if (!editId || !action) {
          showToast('Unable to process action.', 'error');
          return;
        }

        if (action === 'approve') {
          submitVariantApproval(editId);
        } else {
          submitVariantRejection(editId);
        }
      }

      function submitVariantApproval(editId) {
        fetch('/admin/approve-edit/' + editId, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Approved changes.', 'success');
              document.getElementById('edit-item-' + editId)?.remove();

              if (!document.querySelectorAll('[id^="edit-item-"]').length) {
                closeEditModal();
                loadProductEdits();
              }
            } else {
              showToast(data.error || 'Unable to approve edit.', 'error');
            }
          })
          .catch(() => showToast('Error approving edit.', 'error'));
      }

      function submitVariantRejection(editId) {
        const notes = prompt('Rejection reason (optional):');
        if (notes === null) return;

        const formData = new FormData();
        formData.append('notes', notes);

        fetch('/admin/reject-edit/' + editId, {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showToast('Rejected changes.', 'success');
              document.getElementById('edit-item-' + editId)?.remove();


              if (!document.querySelectorAll('[id^="edit-item-"]').length) {
                closeEditModal();
                loadProductEdits();
              }
            } else {
              showToast(data.error || 'Unable to reject edit.', 'error');
            }
          })
          .catch(() => showToast('Error rejecting edit.', 'error'));
      }

      function approveAllProductEdits(productId) {
        const modal = document.getElementById('variantDecisionModal');
        if (!modal) {
          if (confirm('Approve ALL changes for this product?')) {
            executeApproveAllProductEdits(productId);
          }
          return;
        }

        delete modal.dataset.editId;
        modal.dataset.action = 'approve-all';
        modal.dataset.bulkProductId = productId;
        document.getElementById('variantDecisionMessage').textContent = 'Approve all changes for this product?';
        const confirmBtn = document.getElementById('variantDecisionConfirm');
        confirmBtn.textContent = 'Approve All';
        confirmBtn.style.background = '#10b981';
        modal.style.display = 'flex';
      }

      function executeApproveAllProductEdits(productId) {
        const editItems = document.querySelectorAll('[id^="edit-item-"]');
        if (!editItems.length) {
          showToast('No pending edits to approve.', 'error');
          return;
        }
        const promises = [];

        editItems.forEach(item => {
          const editId = item.id.replace('edit-item-', '');
          promises.push(fetch('/admin/approve-edit/' + editId, { method: 'POST' }));
        });

        Promise.all(promises)
          .then(() => {
            showToast('Approved all changes.', 'success');
            closeEditModal();
            loadProductEdits();
          })
          .catch(() => showToast('Error approving all edits.', 'error'));
      }

      function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
      }


      function loadRecoveryRequests() {
        fetch('/admin/pending-recoveries')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('recovery-requests-list');
            const recoveryCount = document.getElementById('recovery-count');

            if (data.pending_recoveries && data.pending_recoveries.length > 0) {
              if (recoveryCount) recoveryCount.textContent = data.pending_recoveries.length;

              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Store</th>
                      <th>Price</th>
                      <th>Reason</th>
                      <th>Requested</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;

              data.pending_recoveries.forEach(item => {
                const date = new Date(item.requested_at).toLocaleString();
                html += `
                  <tr id="recovery-row-${item.request_id}">
                    <td><strong>${item.product_name}</strong><br><small style="color:var(--muted)">SKU: ${item.sku || 'N/A'}</small></td>
                    <td>${item.store_name}</td>
                    <td>‚Ç±${parseFloat(item.price).toFixed(2)}</td>
                    <td style="max-width:200px;font-size:13px">${item.reason || 'No reason provided'}</td>
                    <td style="color:var(--muted);font-size:13px">${date}</td>
                    <td>
                      <button class="tag" onclick="approveRecovery(${item.request_id})" style="background:#10b981;cursor:pointer;border:none;margin-right:4px">‚úì Approve</button>
                      <button class="tag" onclick="rejectRecovery(${item.request_id})" style="background:#ef4444;cursor:pointer;border:none">‚úó Reject</button>
                    </td>
                  </tr>
                `;
              });

              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              if (recoveryCount) recoveryCount.textContent = '0';
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">‚úì No pending recovery requests</p>';
            }
          })
          .catch(error => {
            document.getElementById('recovery-requests-list').innerHTML = '<p style="color:#ef4444">Error loading recovery requests</p>';
          });
      }

      function approveRecovery(requestId) {
        if (!confirm('Approve this recovery request? The product will be restored to active status.')) return;

        fetch('/admin/approve-recovery/' + requestId, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('‚úì Recovery approved! Product restored.');
              document.getElementById('recovery-row-' + requestId)?.remove();


              const recoveryCount = document.getElementById('recovery-count');
              if (recoveryCount) {
                const count = parseInt(recoveryCount.textContent) - 1;
                recoveryCount.textContent = count > 0 ? count : '0';
              }


              if (!document.querySelectorAll('[id^="recovery-row-"]').length) {
                loadRecoveryRequests();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error approving recovery'));
      }

      function rejectRecovery(requestId) {
        const notes = prompt('Rejection reason (optional):');
        if (notes === null) return;

        const formData = new FormData();
        formData.append('notes', notes);

        fetch('/admin/reject-recovery/' + requestId, {
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Recovery request rejected');
              document.getElementById('recovery-row-' + requestId)?.remove();


              const recoveryCount = document.getElementById('recovery-count');
              if (recoveryCount) {
                const count = parseInt(recoveryCount.textContent) - 1;
                recoveryCount.textContent = count > 0 ? count : '0';
              }


              if (!document.querySelectorAll('[id^="recovery-row-"]').length) {
                loadRecoveryRequests();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error rejecting recovery'));
      }


      fetch('/admin/pending-edits')
        .then(response => response.json())
        .then(data => {
          const editsCount = document.getElementById('edits-count');
          if (editsCount && data.pending_edits) {
            editsCount.textContent = data.pending_edits.length;
          }
        })
        .catch(error => console.error('Error loading edit count:', error));


      fetch('/admin/pending-recoveries')
        .then(response => response.json())
        .then(data => {
          const recoveryCount = document.getElementById('recovery-count');
          if (recoveryCount && data.pending_recoveries) {
            recoveryCount.textContent = data.pending_recoveries.length;
          }
        })
        .catch(error => console.error('Error loading recovery count:', error));


      document.querySelectorAll('.side-link').forEach(link => {
        link.addEventListener('click', (e) => {
          const page = e.currentTarget.getAttribute('data-page');
          if (page && e.currentTarget.getAttribute('href') === '#') {
            e.preventDefault();
            loadPage(page);
          }
        });
      });


      function loadRecentOrders() {
        fetch('/admin/recent-orders')
          .then(response => response.json())
          .then(data => {
            if (data.orders && data.orders.length > 0) {
              let html = '';
              data.orders.forEach(order => {
                const date = new Date(order.created_at).toLocaleDateString();
                const statusColor = order.status === 'completed' ? '#10b981' : order.status === 'pending' ? '#f59e0b' : '#ef4444';
                html += `
                  <tr>
                    <td><strong>#${order.order_number}</strong></td>
                    <td>${order.buyer_name || 'N/A'}</td>
                    <td>${date}</td>
                    <td>‚Ç±${parseFloat(order.total_amount).toFixed(2)}</td>
                    <td><span class="tag" style="background:${statusColor};text-transform:capitalize">${order.status}</span></td>
                  </tr>
                `;
              });
              document.getElementById('recent-orders-list').innerHTML = html;
            } else {
              document.getElementById('recent-orders-list').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px">No orders yet</td></tr>';
            }
          })
          .catch(error => {
            document.getElementById('recent-orders-list').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:20px">Error loading orders</td></tr>';
          });
      }


      function loadBestProduct() {
        fetch('/admin/best-product')
          .then(response => response.json())
          .then(data => {
            if (data.product) {
              const container = document.getElementById('best-product-container');
              const imageUrl = data.product.image_url || 'https://images.unsplash.com/photo-1610963876305-c8e7cb43a09b?q=80&w=600&auto=format&fit=crop';
              container.innerHTML = `
                <div style="width:120px;height:140px;border-radius:8px;background:#eaeaea;background-image:url('${imageUrl}');background-size:cover;background-position:center"></div>
                <div>
                  <div style="font-weight:700">${data.product.name}</div>
                  <div class="muted" style="margin-top:4px">${data.product.order_count || 0}+ items sold</div>
                  <div style="margin-top:6px;font-size:14px;color:#666">Store: ${data.product.store_name || 'N/A'}</div>
                  <a href="#" class="tag" style="display:inline-block;margin-top:10px">View Details</a>
                </div>
              `;
            } else {
              document.getElementById('best-product-container').innerHTML = '<p style="color:#999;text-align:center;width:100%">No products yet</p>';
            }
          })
          .catch(error => {
            document.getElementById('best-product-container').innerHTML = '<p style="color:#ef4444;text-align:center;width:100%">Error loading product</p>';
          });
      }


      window.addEventListener('DOMContentLoaded', () => {
        loadRecentOrders();
        loadBestProduct();

        document.querySelectorAll('.bar[data-height]').forEach(bar => {
          bar.style.height = bar.getAttribute('data-height') + '%';
        });
      });
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }


      function viewProductDetails(productId) {
        const modal = document.getElementById('product-details-modal');
        const modalBody = document.getElementById('product-details-body');

        modal.style.display = 'flex';
        modalBody.innerHTML = '<p style="text-align:center;padding:40px;">Loading product details...</p>';

        fetch(`/admin/product-details/${productId}`)
          .then(response => response.json())
          .then(data => {
            console.log('Product details data:', data);
            console.log('Variants:', data.variants);
            console.log('Product stock:', data.product?.stock);
            if (data.success && data.product) {
              const p = data.product;

              const categoryNames = {
                'shirts': 'Shirts & T-Shirts',
                'pants': 'Pants & Jeans',
                'shorts': 'Shorts',
                'jackets': 'Jackets & Coats',
                'shoes': 'Shoes & Footwear',
                'accessories': 'Accessories',
                'underwear': 'Underwear & Socks',
                'activewear': 'Activewear & Sports',
                'formal': 'Formal Wear',
                'casual': 'Casual Wear',
                'grooming': 'Grooming Products'
              };
              const categoryDisplay = categoryNames[p.category] || p.category || 'N/A';

              const formatMarkdown = (text) => {
                if (!text) return '';
                return text
                  .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                  .replace(/\r?\n/g, '<br>')
                  .trim();
              };

              const parseDescriptionSections = (rawText) => {
                if (!rawText) {
                  return {
                    summary: 'No description available.',
                    volume: '',
                    ingredients: ''
                  };
                }

                const volumeMarker = '**Volume/Size:**';
                const ingredientsMarker = '**Ingredients:**';

                let summary = rawText.trim();
                let volume = '';
                let ingredients = '';

                if (rawText.includes(volumeMarker)) {
                  const [beforeVolume, afterVolumeMarker] = rawText.split(volumeMarker);
                  summary = beforeVolume.trim();
                  if (afterVolumeMarker) {
                    if (afterVolumeMarker.includes(ingredientsMarker)) {
                      const [volumePart, afterIngredientsMarker] = afterVolumeMarker.split(ingredientsMarker);
                      volume = (volumePart || '').replace(/\*\*/g, '').trim();
                      ingredients = (afterIngredientsMarker || '').replace(/\*\*/g, '').trim();
                    } else {
                      volume = afterVolumeMarker.replace(/\*\*/g, '').trim();
                    }
                  }
                } else if (rawText.includes(ingredientsMarker)) {
                  const [beforeIngredients, afterIngredientsMarker] = rawText.split(ingredientsMarker);
                  summary = beforeIngredients.trim();
                  ingredients = (afterIngredientsMarker || '').replace(/\*\*/g, '').trim();
                }

                return {
                  summary: formatMarkdown(summary || 'No description available.'),
                  volume: volume ? formatMarkdown(volume) : '',
                  ingredients: ingredients ? formatMarkdown(ingredients) : ''
                };
              };

              const descriptionSections = parseDescriptionSections(p.description || '');
              const variantTotalStock = Array.isArray(data.variants)
                ? data.variants.reduce((sum, v) => sum + (parseInt(v.stock_quantity) || 0), 0)
                : 0;
              const fallbackStock = variantTotalStock > 0
                ? variantTotalStock
                : (Number(p.stock ?? p.inventory_stock ?? 0) || 0);

              let html = `
                <div style="display:grid;gap:20px;">
                  <!-- Product Images -->
                  ${p.image_url ? `
                    <div style="text-align:center;background:#f9fafb;padding:20px;border-radius:8px;">
                      <img src="${p.image_url}" alt="${p.name}" style="max-width:100%;max-height:300px;object-fit:contain;border-radius:8px;">
                    </div>
                  ` : ''}

                  <!-- Basic Info -->
                  <div style="background:#f9fafb;padding:16px;border-radius:8px;">
                    <h3 style="margin:0 0 12px;color:#0a0a0a;">üìã Basic Information</h3>
                    <div style="display:grid;gap:8px;">
                      <div><strong>Product Name:</strong> ${p.name}</div>
                      <div><strong>Category:</strong> ${categoryDisplay}</div>
                      <div><strong>Brand:</strong> ${p.brand || 'N/A'}</div>
                      <div><strong>SKU:</strong> ${p.sku || 'N/A'}</div>
                      <div><strong>Price:</strong> ‚Ç±${parseFloat(p.price).toFixed(2)}</div>
                      <div><strong>Description:</strong><br>${descriptionSections.summary}</div>
                      ${descriptionSections.volume ? `<div><strong>Volume/Size:</strong> ${descriptionSections.volume}</div>` : ''}
                      ${descriptionSections.ingredients ? `<div><strong>Ingredients:</strong><br>${descriptionSections.ingredients}</div>` : ''}
                    </div>
                  </div>

                  <!-- Seller Info -->
                  <div style="background:#f0f9ff;padding:16px;border-radius:8px;">
                    <h3 style="margin:0 0 12px;color:#0a0a0a;">üè™ Seller Information</h3>
                    <div style="display:grid;gap:8px;">
                      <div><strong>Store Name:</strong> ${p.store_name}</div>
                      <div><strong>Seller Email:</strong> ${p.seller_email || 'N/A'}</div>
                      <div><strong>Submitted:</strong> ${new Date(p.created_at).toLocaleString()}</div>
                    </div>
                  </div>

                  <!-- Stock Info -->
                  ${data.variants && data.variants.length > 0 ? `
                    <div style="background:#fef3c7;padding:16px;border-radius:8px;">
                      <h3 style="margin:0 0 12px;color:#0a0a0a;">üì¶ Stock & Variants</h3>
                      <div style="background:#fff;border-radius:6px;max-height:300px;overflow-y:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                          <thead>
                            <tr style="background:#fbbf24;color:#fff;position:sticky;top:0;">
                              <th style="padding:8px;text-align:left;border:1px solid #fbbf24;">Size</th>
                              <th style="padding:8px;text-align:left;border:1px solid #fbbf24;">Color</th>
                              <th style="padding:8px;text-align:right;border:1px solid #fbbf24;">Stock</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${data.variants.map(v => `
                              <tr style="border-bottom:1px solid #fde68a;">
                                <td style="padding:8px;border:1px solid #fde68a;font-weight:500;">${v.size || 'N/A'}</td>
                                <td style="padding:8px;border:1px solid #fde68a;font-weight:500;">${v.color || 'N/A'}</td>
                                <td style="padding:8px;border:1px solid #fde68a;text-align:right;font-weight:600;">${v.stock_quantity || 0} pcs</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                      <div style="margin-top:12px;padding:12px;background:#fef3c7;border-radius:6px;display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-weight:600;">Total Stock:</span>
                        <span style="font-size:18px;font-weight:700;color:#b45309;">${variantTotalStock} pcs</span>
                      </div>
                    </div>
                  ` : `
                    <div style="background:#fef3c7;padding:16px;border-radius:8px;">
                      <h3 style="margin:0 0 12px;color:#0a0a0a;">üì¶ Stock Information</h3>
                      <div><strong>Total Stock:</strong> ${fallbackStock} pcs</div>
                      ${!data.variants || data.variants.length === 0 ? '<p style="color:#666;font-size:14px;margin-top:8px;">No variant information available</p>' : ''}
                    </div>
                  `}

                  <!-- Action Buttons -->
                  <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:16px;border-top:2px solid var(--line);">
                    <button onclick="closeProductDetailsModal()" class="tag" style="background:#f3f4f6;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px;">Close</button>
                    <button onclick="openApproveModal(${p.id})" class="tag" style="background:#10b981;cursor:pointer;border:none;padding:10px 16px;color:#fff;">‚úì Approve</button>
                    <button onclick="openRejectModal(${p.id})" class="tag" style="background:#ef4444;cursor:pointer;border:none;padding:10px 16px;color:#fff;">‚úó Reject</button>
                  </div>
                </div>
              `;
              modalBody.innerHTML = html;
            } else {
              modalBody.innerHTML = '<p style="color:#ef4444;text-align:center;padding:40px;">Error loading product details</p>';
            }
          })
          .catch(error => {
            modalBody.innerHTML = '<p style="color:#ef4444;text-align:center;padding:40px;">Error: ' + error.message + '</p>';
          });
      }

      function closeProductDetailsModal() {
        document.getElementById('product-details-modal').style.display = 'none';
      }

      function approveProductFromModal(productId) {
        closeProductDetailsModal();
        approveProduct(productId);
      }

      function rejectProductFromModal(productId) {
        closeProductDetailsModal();
        rejectProduct(productId);
      }
      function loadAllProducts() {
        fetch('/admin/all-products')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('all-products-list');
            if (data.products && data.products.length > 0) {
              let html = `<table><thead><tr><th>Product</th><th>Seller</th><th>Price</th><th>Stock</th><th>Status</th></tr></thead><tbody>`;
              data.products.forEach(product => {
                html += `<tr><td><strong>${product.name}</strong></td><td>${product.store_name}</td><td>‚Ç±${parseFloat(product.price).toFixed(2)}</td><td>${product.stock}</td><td><span class="tag" style="background:#10b981">${product.status || 'Active'}</span></td></tr>`;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No products found</p>';
            }
          })
          .catch(error => {
            document.getElementById('all-products-list').innerHTML = '<p style="color:#ef4444">Error loading products</p>';
          });
      }


      function loadCustomers() {
        fetch('/admin/all-customers')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('customers-list');
            if (data.customers && data.customers.length > 0) {
              let html = `<table><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Joined</th><th>Orders</th></tr></thead><tbody>`;
              data.customers.forEach(customer => {
                const date = new Date(customer.created_at).toLocaleDateString();
                html += `<tr><td><strong>${customer.first_name} ${customer.last_name}</strong></td><td>${customer.email}</td><td>${customer.phone || 'N/A'}</td><td>${date}</td><td>${customer.order_count || 0}</td></tr>`;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No customers found</p>';
            }
          })
          .catch(error => {
            document.getElementById('customers-list').innerHTML = '<p style="color:#ef4444">Error loading customers</p>';
          });
      }


      function loadTransactions() {
        fetch('/admin/all-transactions')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('transactions-list');
            if (data.transactions && data.transactions.length > 0) {
              let html = `<table><thead><tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead><tbody>`;
              data.transactions.forEach(transaction => {
                const date = new Date(transaction.created_at).toLocaleDateString();
                html += `<tr><td>${transaction.order_number}</td><td>${transaction.customer_name}</td><td>‚Ç±${parseFloat(transaction.amount).toFixed(2)}</td><td><span class="tag" style="background:#10b981">${transaction.status}</span></td><td>${date}</td></tr>`;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No transactions found</p>';
            }
          })
          .catch(error => {
            document.getElementById('transactions-list').innerHTML = '<p style="color:#ef4444">Error loading transactions</p>';
          });
      }


      function loadStatistics() {
        fetch('/admin/statistics')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('statistics-content');
            if (data.success) {
              let html = `
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px">
                  <div class="card" style="text-align:center">
                    <div class="inner">
                      <div class="metric">Total Revenue</div>
                      <div class="value" style="color:#3b82f6">‚Ç±${data.total_revenue ? parseFloat(data.total_revenue).toFixed(2) : '0.00'}</div>
                    </div>
                  </div>
                  <div class="card" style="text-align:center">
                    <div class="inner">
                      <div class="metric">Total Orders</div>
                      <div class="value">${data.total_orders || 0}</div>
                    </div>
                  </div>
                  <div class="card" style="text-align:center">
                    <div class="inner">
                      <div class="metric">Active Users</div>
                      <div class="value">${data.active_users || 0}</div>
                    </div>
                  </div>
                  <div class="card" style="text-align:center">
                    <div class="inner">
                      <div class="metric">Active Products</div>
                      <div class="value">${data.active_products || 0}</div>
                    </div>
                  </div>
                </div>
              `;
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="color:#ef4444">Error loading statistics</p>';
            }
          })
          .catch(error => {
            document.getElementById('statistics-content').innerHTML = '<p style="color:#ef4444">Error loading statistics</p>';
          });


        fetch('/admin/customer-growth-by-region')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('regional-growth');
            if (data.success && data.regions && data.regions.length > 0) {
              let html = '<div style="display:flex;flex-direction:column;gap:16px">';
              const total = data.regions.reduce((sum, r) => sum + r.count, 0);

              data.regions.forEach(region => {
                const percentage = total > 0 ? Math.round((region.count / total) * 100) : 0;
                html += `
                  <div>
                    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
                      <span style="font-weight:500">${region.region}</span>
                      <span style="color:#3b82f6;font-weight:600">${percentage}%</span>
                    </div>
                    <div style="height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden">
                      <div style="height:100%;background:#0a0a0a;width:${percentage}%;transition:width 0.3s"></div>
                    </div>
                  </div>
                `;
              });

              html += '</div>';
              container.innerHTML = html;


              let detailedHtml = '<table style="width:100%;border-collapse:separate;border-spacing:0"><thead><tr><th style="text-align:left;padding:10px;border-bottom:1px solid var(--line);font-weight:600">Region</th><th style="text-align:center;padding:10px;border-bottom:1px solid var(--line);font-weight:600">Customers</th><th style="text-align:center;padding:10px;border-bottom:1px solid var(--line);font-weight:600">Percentage</th></tr></thead><tbody>';

              data.regions.forEach(region => {
                const percentage = total > 0 ? Math.round((region.count / total) * 100) : 0;
                detailedHtml += `<tr><td style="padding:12px;border-bottom:1px solid var(--line)">${region.region}</td><td style="padding:12px;border-bottom:1px solid var(--line);text-align:center;font-weight:600">${region.count}</td><td style="padding:12px;border-bottom:1px solid var(--line);text-align:center">${percentage}%</td></tr>`;
              });

              detailedHtml += '</tbody></table>';
              document.getElementById('detailed-stats-body').innerHTML = detailedHtml;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999">No regional data available</p>';
            }
          })
          .catch(error => {
            console.error('Error loading regional data:', error);
          });
      }


      function loadActiveSellers() {
        fetch('/admin/active-sellers')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('active-sellers-list');
            if (data.sellers && data.sellers.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Store Name</th>
                      <th>Owner</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Products</th>
                      <th>Joined</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              data.sellers.forEach(seller => {
                const date = new Date(seller.created_at).toLocaleDateString();
                html += `
                  <tr>
                    <td><strong>${seller.store_name}</strong></td>
                    <td>${seller.first_name} ${seller.last_name}</td>
                    <td>${seller.email}</td>
                    <td>${seller.phone || 'N/A'}</td>
                    <td>${seller.product_count || 0}</td>
                    <td>${date}</td>
                  </tr>
                `;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No active sellers found</p>';
            }
          })
          .catch(error => {
            document.getElementById('active-sellers-list').innerHTML = '<p style="color:#ef4444">Error loading sellers</p>';
          });
      }


      function loadActiveRiders() {
        fetch('/admin/active-riders')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('active-riders-list');
            if (data.riders && data.riders.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Vehicle Type</th>
                      <th>License Number</th>
                      <th>Service Area</th>
                      <th>Joined</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              data.riders.forEach(rider => {
                const date = new Date(rider.created_at).toLocaleDateString();
                html += `
                  <tr>
                    <td><strong>${rider.first_name} ${rider.last_name}</strong></td>
                    <td>${rider.email}</td>
                    <td>${rider.phone || 'N/A'}</td>
                    <td>${rider.vehicle_type || 'N/A'}</td>
                    <td>${rider.license_number || 'N/A'}</td>
                    <td>${rider.service_area || 'N/A'}</td>
                    <td>${date}</td>
                  </tr>
                `;
              });
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No active riders found</p>';
            }
          })
          .catch(error => {
            document.getElementById('active-riders-list').innerHTML = '<p style="color:#ef4444">Error loading riders</p>';
          });
      }


      function loadOverviewCustomerGrowth() {
        fetch('/admin/customer-growth-by-region')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('overview-customer-growth');
            if (data.success && data.regions && data.regions.length > 0) {
              let html = '';
              const total = data.regions.reduce((sum, r) => sum + r.count, 0);

              data.regions.slice(0, 5).forEach(region => {
                const percentage = total > 0 ? Math.round((region.count / total) * 100) : 0;
                html += `
                  <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:${html === '' ? '6px' : '10px'} 0">
                    <span>${region.region}</span>
                    <span>${percentage}%</span>
                  </div>
                  <div style="height:8px;background:#efefef;border-radius:999px;margin-bottom:${html !== '' ? '0' : '10px'}">
                    <div style="height:8px;width:${percentage}%;background:#0a0a0a;border-radius:999px"></div>
                  </div>
                `;
              });

              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:20px">No regional data available</p>';
            }
          })
          .catch(error => {
            document.getElementById('overview-customer-growth').innerHTML = '<p style="color:#ef4444">Error loading regional data</p>';
          });
      }


      document.addEventListener('DOMContentLoaded', function() {
        loadOverviewCustomerGrowth();
      });


      function loadSettings() {
        fetch('/admin/settings')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.settings) {
              document.getElementById('system-name').value = data.settings.system_name || 'Var-n E-Commerce';
              document.getElementById('support-email').value = data.settings.support_email || 'support@varn.com';
              document.getElementById('support-phone').value = data.settings.support_phone || '+63 977 XXX XXXX';
              document.getElementById('maintenance-mode').checked = data.settings.maintenance_mode === 1;
              document.getElementById('email-notifications').checked = data.settings.email_notifications !== 0;
              document.getElementById('order-alerts').checked = data.settings.order_alerts !== 0;
              document.getElementById('seller-alerts').checked = data.settings.seller_alerts !== 0;
            }
          })
          .catch(error => console.log('Using default settings'));
      }


      function saveSystemSettings() {
        const formData = new FormData();
        formData.append('system_name', document.getElementById('system-name').value);
        formData.append('support_email', document.getElementById('support-email').value);
        formData.append('support_phone', document.getElementById('support-phone').value);
        formData.append('maintenance_mode', document.getElementById('maintenance-mode').checked ? 1 : 0);
        formData.append('email_notifications', document.getElementById('email-notifications').checked ? 1 : 0);
        formData.append('order_alerts', document.getElementById('order-alerts').checked ? 1 : 0);
        formData.append('seller_alerts', document.getElementById('seller-alerts').checked ? 1 : 0);

        fetch('/admin/settings', { method: 'POST', body: formData })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Settings saved successfully');
              loadSettings();
            } else {
              alert('Error: ' + (data.error || 'Could not save settings'));
            }
          })
          .catch(error => alert('Error saving settings: ' + error.message));
      }


      function loadHelp() {

        fetch('/admin/settings')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.settings) {
              document.getElementById('support-contact-email').textContent = data.settings.support_email || 'support@varn.com';
              document.getElementById('support-contact-phone').textContent = data.settings.support_phone || '+63 977 XXX XXXX';
            }
          })
          .catch(error => console.log('Using default contact info'));
      }


      function toggleFAQ(element) {
        const answerDiv = element.querySelector('div:last-child');
        const toggleIcon = element.querySelector('span:last-child');

        if (answerDiv.style.display === 'none') {
          answerDiv.style.display = 'block';
          toggleIcon.textContent = '‚àí';
        } else {
          answerDiv.style.display = 'none';
          toggleIcon.textContent = '+';
        }
      }
    </script>
  </body>
</html>

