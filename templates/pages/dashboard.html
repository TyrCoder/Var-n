<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Admin Dashboard ‚Äî Var√≥n</title>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:#10b981;margin-left:8px}

      /* Chart placeholders */
      .grid.two{grid-template-columns:1.4fr 1fr}
      .chart{height:260px;padding:12px 14px}
      .bars{display:flex;align-items:flex-end;gap:10px;height:160px;margin-top:8px}
      .bar{flex:1;background:#0a0a0a;border-radius:6px}
      .legend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Right column widget */
      .promo{background:#0a0a0a;color:#fff;border-radius:10px;padding:16px;text-align:left}

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Var√≥n Admin</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Menu</div>
          <a class="side-link active" href="#" data-page="overview">Overview</a>
          <a class="side-link" href="#" data-page="pending-products">Pending Products <span class="tag" style="background:#ef4444;margin-left:auto;font-size:10px;padding:2px 6px;">{{ pending_products if pending_products else 0 }}</span></a>
          <a class="side-link" href="#" data-page="product-edits">Product Edits <span class="tag" style="background:#f59e0b;margin-left:auto;font-size:10px;padding:2px 6px;" id="edits-count">0</span></a>
          <a class="side-link" href="#" data-page="recovery-requests">Recovery Requests <span class="tag" style="background:#10b981;margin-left:auto;font-size:10px;padding:2px 6px;" id="recovery-count">0</span></a>
          <a class="side-link" href="#" data-page="product">All Products</a>
          <a class="side-link" href="#" data-page="customer">Customer</a>
          <a class="side-link" href="#" data-page="transactions">Transactions</a>
          <a class="side-link" href="#" data-page="statistics">Statistics</a>
          <a class="side-link" href="#" data-page="riders">Riders</a>
          <a class="side-link" href="#" data-page="sellers">Sellers</a>
          <a class="side-link" href="#" data-page="journal">Journal Management</a>
                    <a class="side-link" href="#" onclick="confirmLogout(event)">Logout</a>
        </div>
        <div class="side-group">
          <div class="side-title">Support</div>
          <a class="side-link" href="#" data-page="setting">Setting</a>
          <a class="side-link" href="#" data-page="help">Help</a>
          <a class="side-link" href="#" data-page="darkmode">Dark Mode</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Dashboard</div>
          <div class="search"><input placeholder="Search anything..."/></div>
          <div class="avatar">
            {% if session.logged_in %}
              <span class="tag">{{ session.email }}</span>
              <a href="#" onclick="confirmLogout(event)" class="tag" style="background:#efefef;color:#0a0a0a">Logout</a>
            {% else %}
              <a href="/login" class="tag">Login</a>
            {% endif %}
          </div>
        </div>

        <main class="main" id="dashboardContent">
          <!-- Stat cards -->
          <div class="grid stats">
            <div class="card"><div class="inner"><div class="metric">Total Users</div><div class="value">{{ total_users if total_users else 0 }}</div></div></div>
            <div class="card"><div class="inner"><div class="metric">Total Orders</div><div class="value">{{ total_orders if total_orders else 0 }}</div></div></div>
            <div class="card"><div class="inner"><div class="metric">Pending Products</div><div class="value">{{ pending_products if pending_products else 0 }} <span class="delta" style="color:#ef4444">{% if pending_products %}Needs Review{% endif %}</span></div></div></div>
            <div class="card"><div class="inner"><div class="metric">Pending Verifications</div><div class="value">{{ (pending_sellers if pending_sellers else 0) + (pending_riders if pending_riders else 0) }} <span class="delta" style="color:#ef4444">{% if pending_sellers or pending_riders %}Sellers/Riders{% endif %}</span></div></div></div>
          </div>

          <!-- Charts row -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div class="metric">Revenue Growth (PHP)</div>
                <div class="chart">
                  <div class="bars">
                    {% for day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                    <div class="bar" style="height:{{ ((weekly_revenue[day] / max_weekly_revenue) * 100)|int if weekly_revenue[day] > 0 else 5 }}%"></div>
                    {% endfor %}
                  </div>
                  <div class="legend"><span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span></div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Growth (Philippines)</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:6px">
                  <div>
                    <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:6px 0"><span>NCR (Metro Manila)</span><span>28%</span></div>
                    <div style="height:8px;background:#efefef;border-radius:999px"><div style="height:8px;width:28%;background:#0a0a0a;border-radius:999px"></div></div>
                    <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:10px 0 6px"><span>CALABARZON</span><span>22%</span></div>
                    <div style="height:8px;background:#efefef;border-radius:999px"><div style="height:8px;width:22%;background:#0a0a0a;border-radius:999px"></div></div>
                    <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:10px 0 6px"><span>Central Visayas</span><span>18%</span></div>
                    <div style="height:8px;background:#efefef;border-radius:999px"><div style="height:8px;width:18%;background:#0a0a0a;border-radius:999px"></div></div>
                    <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:10px 0 0"><span>Central Luzon</span><span>12%</span></div>
                    <div style="height:8px;background:#efefef;border-radius:999px"><div style="height:8px;width:12%;background:#0a0a0a;border-radius:999px"></div></div>
                    <div style="display:flex;align-items:center;justify-content:space-between;font-size:13px;margin:10px 0 0"><span>Davao Region</span><span>8%</span></div>
                    <div style="height:8px;background:#efefef;border-radius:999px"><div style="height:8px;width:8%;background:#0a0a0a;border-radius:999px"></div></div>
                  </div>
                  <div class="promo">
                    <div style="font-weight:700;margin-bottom:8px">See more detail statistic to analyze your decision</div>
                    <a href="#" class="tag" style="display:inline-block;background:#fff;color:#0a0a0a;margin-top:8px">See more</a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Data row -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Orders</div>
                  <a href="#" style="font-size:12px;color:var(--muted)">View detail</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead><tr><th>Order #</th><th>Buyer</th><th>Date</th><th>Amount</th><th>Status</th></tr></thead>
                    <tbody id="recent-orders-list">
                      <tr><td colspan="5" style="text-align:center;color:#999;padding:20px">Loading orders...</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Best Selling Product</div>
                  <a href="#" style="font-size:12px;color:var(--muted)">View more</a>
                </div>
                <div id="best-product-container" style="display:flex;gap:14px;align-items:center;margin-top:10px">
                  <p style="color:#999;text-align:center;width:100%">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        </main>
      </section>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      // Page templates
      const pageTemplates = {
        'pending-products': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Pending Product Approvals</h2>
              <div id="pending-products-list">Loading pending products...</div>
            </div>
          </div>
          <!-- Product Details Modal -->
          <div id="product-details-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:800px;width:90%;max-height:85vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">üì¶ Product Details</h2>
                <button onclick="closeProductDetailsModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <div id="product-details-body">Loading...</div>
            </div>
          </div>
        `,
        'product-edits': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">üìù Product Edit Requests</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Review and approve changes requested by sellers</p>
              <div id="product-edits-list">Loading product edits...</div>
            </div>
          </div>
          <div id="edit-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700">Review Product Edit</h2>
                <button onclick="closeEditModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <div id="edit-modal-body">Loading...</div>
            </div>
          </div>
        `,
        'recovery-requests': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">‚ôªÔ∏è Product Recovery Requests</h2>
              <p style="color: var(--muted); margin: 0 0 20px;">Review requests from sellers to recover archived products</p>
              <div id="recovery-requests-list">Loading recovery requests...</div>
            </div>
          </div>
        `,
        'sellers': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Pending Seller Verifications</h2>
              <div id="pending-sellers-list">Loading pending sellers...</div>
            </div>
          </div>
        `,
        'riders': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Pending Rider Verifications</h2>
              <div id="pending-riders-list">Loading pending riders...</div>
            </div>
          </div>
        `,
        'journal': `
          <div class="card">
            <div class="inner">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                <h2 style="margin: 0;">üìù Journal Management</h2>
                <button onclick="openAddJournalModal()" class="tag" style="background:#0a0a0a;cursor:pointer;border:none;padding:10px 16px">+ Add Journal Entry</button>
              </div>
              <div id="journal-list">Loading journal entries...</div>
            </div>
          </div>
          <!-- Add/Edit Journal Modal -->
          <div id="journal-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center">
            <div style="background:#fff;border-radius:12px;padding:24px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--line)">
                <h2 style="margin:0;font-size:20px;font-weight:700" id="journal-modal-title">Add Journal Entry</h2>
                <button onclick="closeJournalModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px">&times;</button>
              </div>
              <form id="journal-form" style="display:flex;flex-direction:column;gap:16px">
                <div>
                  <label style="display:block;margin-bottom:8px;font-weight:500">Title</label>
                  <input type="text" id="journal-title" required style="width:100%;padding:10px;border:1px solid var(--line);border-radius:6px">
                </div>
                <div>
                  <label style="display:block;margin-bottom:8px;font-weight:500">Description</label>
                  <textarea id="journal-description" required rows="4" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:6px;resize:vertical"></textarea>
                </div>
                <div>
                  <label style="display:block;margin-bottom:8px;font-weight:500">Image URL</label>
                  <input type="url" id="journal-image" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:6px" placeholder="https://example.com/image.jpg">
                </div>
                <div>
                  <label style="display:block;margin-bottom:8px;font-weight:500">Link URL (optional)</label>
                  <input type="url" id="journal-link" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:6px" placeholder="https://example.com/article">
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
                  <button type="button" onclick="closeJournalModal()" class="tag" style="background:#f3f4f6;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px">Cancel</button>
                  <button type="submit" class="tag" style="background:#0a0a0a;cursor:pointer;border:none;padding:10px 16px;color:#fff">Save</button>
                </div>
              </form>
            </div>
          </div>
        `
      };

      function loadPage(page) {
        console.log('Loading page:', page);
        
        // Remove active class from all links
        document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
        // Add active class to clicked link
        document.querySelector(`[data-page="${page}"]`)?.classList.add('active');
        
        const content = document.getElementById('dashboardContent');
        
        // Handle overview page - reload the page
        if (page === 'overview') {
          window.location.reload();
          return;
        }
        
        if (pageTemplates[page]) {
          content.innerHTML = pageTemplates[page];
          
          // Load dynamic data for specific pages
          if (page === 'pending-products') {
            loadPendingProducts();
          } else if (page === 'product-edits') {
            loadProductEdits();
          } else if (page === 'recovery-requests') {
            loadRecoveryRequests();
          } else if (page === 'sellers') {
            loadPendingSellers();
          } else if (page === 'riders') {
            loadPendingRiders();
          } else if (page === 'journal') {
            loadJournalEntries();
          }
        } else {
          content.innerHTML = `
            <div class="card">
              <div class="inner">
                <h2 style="margin: 0 0 16px;">${page.charAt(0).toUpperCase() + page.slice(1)}</h2>
                <p style="text-align:center;color:#999;padding:40px;">This page is under construction.</p>
              </div>
            </div>
          `;
        }
        
        // Update page title
        const pageNames = {
          'overview': 'Dashboard',
          'pending-products': 'Pending Products',
          'product': 'All Products',
          'customer': 'Customers',
          'transactions': 'Transactions',
          'statistics': 'Statistics',
          'riders': 'Rider Verifications',
          'sellers': 'Seller Verifications',
          'journal': 'Journal Management',
          'log': 'Activity Log'
        };
        document.querySelector('.page-title').textContent = pageNames[page] || 'Dashboard';
      }

      function loadPendingProducts() {
        console.log('Loading pending products...');
        fetch('/admin/pending-products')
          .then(response => {
            console.log('Products response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Products data:', data);
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Seller</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                const date = new Date(product.created_at).toLocaleDateString();
                html += `
                  <tr id="product-${product.id}">
                    <td>
                      <strong>${product.name}</strong><br>
                      <small style="color: var(--muted)">${product.description ? product.description.substring(0, 50) + '...' : 'No description'}</small>
                    </td>
                    <td>${product.store_name}</td>
                    <td>‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.stock} pcs</td>
                    <td>${date}</td>
                    <td>
                      <button class="tag" onclick="viewProductDetails(${product.id})" style="background: #3b82f6; cursor: pointer; border: none;">View Details</button>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('pending-products-list').innerHTML = html;
            } else {
              document.getElementById('pending-products-list').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending products to review</p>';
            }
          })
          .catch(error => {
            document.getElementById('pending-products-list').innerHTML = '<p style="color:#ef4444;">Error loading pending products</p>';
          });
      }

      function approveProduct(productId) {
        if (!confirm('Approve this product?')) return;
        
        fetch(`/admin/approve-product/${productId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Product approved successfully!');
            // Remove the row
            document.getElementById(`product-${productId}`)?.remove();
            // Update counter
            const badge = document.querySelector('[data-page="pending-products"] .tag');
            if (badge) {
              const count = parseInt(badge.textContent) - 1;
              badge.textContent = count > 0 ? count : '0';
            }
          } else {
            alert('Error approving product: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error approving product');
        });
      }

      function rejectProduct(productId) {
        if (!confirm('Reject and delete this product? This cannot be undone.')) return;
        
        fetch(`/admin/reject-product/${productId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Product rejected and removed');
            // Remove the row
            document.getElementById(`product-${productId}`)?.remove();
            // Update counter
            const badge = document.querySelector('[data-page="pending-products"] .tag');
            if (badge) {
              const count = parseInt(badge.textContent) - 1;
              badge.textContent = count > 0 ? count : '0';
            }
          } else {
            alert('Error rejecting product: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error rejecting product');
        });
      }

      function loadPendingSellers() {
        console.log('Loading pending sellers...');
        fetch('/admin/pending-sellers')
          .then(response => {
            console.log('Sellers response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Sellers data:', data);
            if (data.sellers && data.sellers.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Seller Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Store Name</th>
                      <th>Submitted</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.sellers.forEach(seller => {
                const date = new Date(seller.created_at).toLocaleDateString();
                html += `
                  <tr id="seller-${seller.id}">
                    <td><strong>${seller.first_name} ${seller.last_name}</strong></td>
                    <td>${seller.email}</td>
                    <td>${seller.phone || 'N/A'}</td>
                    <td>${seller.store_name}</td>
                    <td>${date}</td>
                    <td>
                      <div style="display: flex; gap: 8px;">
                        <button class="tag" onclick="approveSeller(${seller.id})" style="background: #10b981; cursor: pointer; border: none;">Approve</button>
                        <button class="tag" onclick="rejectSeller(${seller.id})" style="background: #ef4444; cursor: pointer; border: none;">Reject</button>
                      </div>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('pending-sellers-list').innerHTML = html;
            } else {
              document.getElementById('pending-sellers-list').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending sellers to verify</p>';
            }
          })
          .catch(error => {
            console.error('Error loading sellers:', error);
            document.getElementById('pending-sellers-list').innerHTML = '<p style="color:#ef4444;">Error loading pending sellers: ' + error.message + '</p>';
          });
      }

      function approveSeller(sellerId) {
        if (!confirm('Approve this seller?')) return;
        
        fetch(`/admin/approve-seller/${sellerId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Seller approved successfully!');
            document.getElementById(`seller-${sellerId}`)?.remove();
          } else {
            alert('Error approving seller: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error approving seller');
        });
      }

      function rejectSeller(sellerId) {
        if (!confirm('Reject this seller application? This will remove their seller account.')) return;
        
        fetch(`/admin/reject-seller/${sellerId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Seller application rejected');
            document.getElementById(`seller-${sellerId}`)?.remove();
          } else {
            alert('Error rejecting seller: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error rejecting seller');
        });
      }

      function loadPendingRiders() {
        console.log('Loading pending riders...');
        fetch('/admin/pending-riders')
          .then(response => {
            console.log('Riders response:', response);
            return response.json();
          })
          .then(data => {
            console.log('Riders data:', data);
            if (data.riders && data.riders.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Rider Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Vehicle Type</th>
                      <th>License Number</th>
                      <th>Applied On</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.riders.forEach(rider => {
                const date = new Date(rider.created_at).toLocaleDateString();
                html += `
                  <tr id="rider-${rider.id}">
                    <td><strong>${rider.first_name} ${rider.last_name}</strong></td>
                    <td>${rider.email}</td>
                    <td>${rider.phone || 'N/A'}</td>
                    <td>${rider.vehicle_type || 'N/A'}</td>
                    <td>${rider.license_number || 'N/A'}</td>
                    <td>${date}</td>
                    <td>
                      <div style="display: flex; gap: 8px;">
                        <button class="tag" onclick="approveRider(${rider.id})" style="background: #10b981; cursor: pointer; border: none;">Approve</button>
                        <button class="tag" onclick="rejectRider(${rider.id})" style="background: #ef4444; cursor: pointer; border: none;">Reject</button>
                      </div>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('pending-riders-list').innerHTML = html;
            } else {
              document.getElementById('pending-riders-list').innerHTML = '<p style="text-align:center;color:#999;padding:40px;">No pending riders to verify</p>';
            }
          })
          .catch(error => {
            console.error('Error loading riders:', error);
            document.getElementById('pending-riders-list').innerHTML = '<p style="color:#ef4444;">Error loading pending riders: ' + error.message + '</p>';
          });
      }

      function approveRider(riderId) {
        if (!confirm('Approve this rider?')) return;
        
        fetch(`/admin/approve-rider/${riderId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Rider approved successfully!');
            document.getElementById(`rider-${riderId}`)?.remove();
          } else {
            alert('Error approving rider: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error approving rider');
        });
      }

      function rejectRider(riderId) {
        if (!confirm('Reject this rider application?')) return;
        
        fetch(`/admin/reject-rider/${riderId}`, {
          method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Rider application rejected');
            document.getElementById(`rider-${riderId}`)?.remove();
          } else {
            alert('Error rejecting rider: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error rejecting rider');
        });
      }

      // Product Edits Functions
      function loadProductEdits() {
        fetch('/admin/pending-edits')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('product-edits-list');
            const editsCount = document.getElementById('edits-count');
            
            if (data.pending_edits && data.pending_edits.length > 0) {
              if (editsCount) editsCount.textContent = data.pending_edits.length;
              
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Store</th>
                      <th>Changes</th>
                      <th>Requested</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.pending_edits.forEach(item => {
                const date = new Date(item.first_request).toLocaleString();
                html += `
                  <tr id="edit-row-${item.product_id}">
                    <td><strong>${item.product_name}</strong></td>
                    <td>${item.store_name}</td>
                    <td><span class="tag" style="background:#fef3c7;color:#92400e">${item.edit_count} change${item.edit_count > 1 ? 's' : ''}</span></td>
                    <td style="color:var(--muted);font-size:13px">${date}</td>
                    <td>
                      <button class="tag" onclick="viewEditDetails(${item.product_id})" style="background:#0a0a0a;cursor:pointer;border:none">Review</button>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              if (editsCount) editsCount.textContent = '0';
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">‚úì No pending edit requests</p>';
            }
          })
          .catch(error => {
            document.getElementById('product-edits-list').innerHTML = '<p style="color:#ef4444">Error loading edits</p>';
          });
      }
      
      function viewEditDetails(productId) {
        const modal = document.getElementById('edit-modal');
        modal.style.display = 'flex';
        document.getElementById('edit-modal-body').innerHTML = 'Loading...';
        
        fetch('/admin/product-edit-details/' + productId)
          .then(response => response.json())
          .then(data => {
            if (data.product && data.edits) {
              let html = `
                <div style="background:#f9fafb;padding:16px;border-radius:8px;margin-bottom:20px">
                  <h3 style="margin:0 0 8px">${data.product.name}</h3>
                  <p style="margin:0;color:var(--muted);font-size:14px">Store: ${data.product.store_name}</p>
                </div>
                
                <h3 style="margin:20px 0 12px">Requested Changes:</h3>
              `;
              
              data.edits.forEach(edit => {
                html += `
                  <div style="background:#f9fafb;padding:12px;border-radius:6px;margin:8px 0;border-left:3px solid #3b82f6" id="edit-item-${edit.id}">
                    <div style="font-weight:600;color:#0a0a0a;margin-bottom:6px">üìù ${edit.field_name}</div>
                    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;font-size:14px">
                      <div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Current</div>
                        <div style="color:#ef4444;text-decoration:line-through">${edit.old_value || '(empty)'}</div>
                      </div>
                      <div style="color:var(--muted)">‚Üí</div>
                      <div>
                        <div style="font-size:11px;text-transform:uppercase;color:var(--muted);margin-bottom:4px">Proposed</div>
                        <div style="color:#10b981;font-weight:500">${edit.new_value}</div>
                      </div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px">
                      <button class="tag" onclick="approveSingleEdit(${edit.id})" style="background:#10b981;cursor:pointer;border:none">‚úì Approve</button>
                      <button class="tag" onclick="rejectSingleEdit(${edit.id})" style="background:#ef4444;cursor:pointer;border:none">‚úó Reject</button>
                    </div>
                  </div>
                `;
              });
              
              html += `
                <div style="display:flex;gap:12px;margin-top:24px;padding-top:20px;border-top:2px solid var(--line)">
                  <button class="tag" onclick="approveAllProductEdits(${productId})" style="background:#10b981;cursor:pointer;border:none;padding:10px 16px">‚úì Approve All Changes</button>
                  <button class="tag" onclick="closeEditModal()" style="background:#f3f4f6;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px">Close</button>
                </div>
              `;
              
              document.getElementById('edit-modal-body').innerHTML = html;
            }
          })
          .catch(error => {
            document.getElementById('edit-modal-body').innerHTML = '<p style="color:#ef4444">Error loading details</p>';
          });
      }
      
      function approveSingleEdit(editId) {
        if (!confirm('Approve this change?')) return;
        
        fetch('/admin/approve-edit/' + editId, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('‚úì Edit approved successfully!');
              document.getElementById('edit-item-' + editId)?.remove();
              
              // Check if any edits remain
              if (!document.querySelectorAll('[id^="edit-item-"]').length) {
                closeEditModal();
                loadProductEdits();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error approving edit'));
      }
      
      function rejectSingleEdit(editId) {
        const notes = prompt('Rejection reason (optional):');
        if (notes === null) return;
        
        const formData = new FormData();
        formData.append('notes', notes);
        
        fetch('/admin/reject-edit/' + editId, { 
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Edit rejected');
              document.getElementById('edit-item-' + editId)?.remove();
              
              // Check if any edits remain
              if (!document.querySelectorAll('[id^="edit-item-"]').length) {
                closeEditModal();
                loadProductEdits();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error rejecting edit'));
      }
      
      function approveAllProductEdits(productId) {
        if (!confirm('Approve ALL changes for this product?')) return;
        
        const editItems = document.querySelectorAll('[id^="edit-item-"]');
        const promises = [];
        
        editItems.forEach(item => {
          const editId = item.id.replace('edit-item-', '');
          promises.push(fetch('/admin/approve-edit/' + editId, { method: 'POST' }));
        });
        
        Promise.all(promises)
          .then(() => {
            alert('‚úì All changes approved successfully!');
            closeEditModal();
            loadProductEdits();
          })
          .catch(error => alert('Error approving all edits'));
      }
      
      function closeEditModal() {
        document.getElementById('edit-modal').style.display = 'none';
      }
      
      // Recovery Requests Functions
      function loadRecoveryRequests() {
        fetch('/admin/pending-recoveries')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('recovery-requests-list');
            const recoveryCount = document.getElementById('recovery-count');
            
            if (data.pending_recoveries && data.pending_recoveries.length > 0) {
              if (recoveryCount) recoveryCount.textContent = data.pending_recoveries.length;
              
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Store</th>
                      <th>Price</th>
                      <th>Reason</th>
                      <th>Requested</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.pending_recoveries.forEach(item => {
                const date = new Date(item.requested_at).toLocaleString();
                html += `
                  <tr id="recovery-row-${item.request_id}">
                    <td><strong>${item.product_name}</strong><br><small style="color:var(--muted)">SKU: ${item.sku || 'N/A'}</small></td>
                    <td>${item.store_name}</td>
                    <td>‚Ç±${parseFloat(item.price).toFixed(2)}</td>
                    <td style="max-width:200px;font-size:13px">${item.reason || 'No reason provided'}</td>
                    <td style="color:var(--muted);font-size:13px">${date}</td>
                    <td>
                      <button class="tag" onclick="approveRecovery(${item.request_id})" style="background:#10b981;cursor:pointer;border:none;margin-right:4px">‚úì Approve</button>
                      <button class="tag" onclick="rejectRecovery(${item.request_id})" style="background:#ef4444;cursor:pointer;border:none">‚úó Reject</button>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              if (recoveryCount) recoveryCount.textContent = '0';
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px;">‚úì No pending recovery requests</p>';
            }
          })
          .catch(error => {
            document.getElementById('recovery-requests-list').innerHTML = '<p style="color:#ef4444">Error loading recovery requests</p>';
          });
      }
      
      function approveRecovery(requestId) {
        if (!confirm('Approve this recovery request? The product will be restored to active status.')) return;
        
        fetch('/admin/approve-recovery/' + requestId, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('‚úì Recovery approved! Product restored.');
              document.getElementById('recovery-row-' + requestId)?.remove();
              
              // Update count
              const recoveryCount = document.getElementById('recovery-count');
              if (recoveryCount) {
                const count = parseInt(recoveryCount.textContent) - 1;
                recoveryCount.textContent = count > 0 ? count : '0';
              }
              
              // Reload if no items left
              if (!document.querySelectorAll('[id^="recovery-row-"]').length) {
                loadRecoveryRequests();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error approving recovery'));
      }
      
      function rejectRecovery(requestId) {
        const notes = prompt('Rejection reason (optional):');
        if (notes === null) return;
        
        const formData = new FormData();
        formData.append('notes', notes);
        
        fetch('/admin/reject-recovery/' + requestId, { 
          method: 'POST',
          body: formData
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Recovery request rejected');
              document.getElementById('recovery-row-' + requestId)?.remove();
              
              // Update count
              const recoveryCount = document.getElementById('recovery-count');
              if (recoveryCount) {
                const count = parseInt(recoveryCount.textContent) - 1;
                recoveryCount.textContent = count > 0 ? count : '0';
              }
              
              // Reload if no items left
              if (!document.querySelectorAll('[id^="recovery-row-"]').length) {
                loadRecoveryRequests();
              }
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error rejecting recovery'));
      }
      
      // Load edit count on page load
      fetch('/admin/pending-edits')
        .then(response => response.json())
        .then(data => {
          const editsCount = document.getElementById('edits-count');
          if (editsCount && data.pending_edits) {
            editsCount.textContent = data.pending_edits.length;
          }
        })
        .catch(error => console.error('Error loading edit count:', error));
      
      // Load recovery count on page load
      fetch('/admin/pending-recoveries')
        .then(response => response.json())
        .then(data => {
          const recoveryCount = document.getElementById('recovery-count');
          if (recoveryCount && data.pending_recoveries) {
            recoveryCount.textContent = data.pending_recoveries.length;
          }
        })
        .catch(error => console.error('Error loading recovery count:', error));

      // Add click handlers for sidebar navigation
      document.querySelectorAll('.side-link').forEach(link => {
        link.addEventListener('click', (e) => {
          const page = e.currentTarget.getAttribute('data-page');
          if (page && e.currentTarget.getAttribute('href') === '#') {
            e.preventDefault();
            loadPage(page);
          }
        });
      });

      // Load recent orders on page load
      function loadRecentOrders() {
        fetch('/admin/recent-orders')
          .then(response => response.json())
          .then(data => {
            if (data.orders && data.orders.length > 0) {
              let html = '';
              data.orders.forEach(order => {
                const date = new Date(order.created_at).toLocaleDateString();
                const statusColor = order.status === 'completed' ? '#10b981' : order.status === 'pending' ? '#f59e0b' : '#ef4444';
                html += `
                  <tr>
                    <td><strong>#${order.order_number}</strong></td>
                    <td>${order.buyer_name || 'N/A'}</td>
                    <td>${date}</td>
                    <td>‚Ç±${parseFloat(order.total_amount).toFixed(2)}</td>
                    <td><span class="tag" style="background:${statusColor};text-transform:capitalize">${order.status}</span></td>
                  </tr>
                `;
              });
              document.getElementById('recent-orders-list').innerHTML = html;
            } else {
              document.getElementById('recent-orders-list').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px">No orders yet</td></tr>';
            }
          })
          .catch(error => {
            document.getElementById('recent-orders-list').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:20px">Error loading orders</td></tr>';
          });
      }

      // Load best selling product
      function loadBestProduct() {
        fetch('/admin/best-product')
          .then(response => response.json())
          .then(data => {
            if (data.product) {
              const container = document.getElementById('best-product-container');
              const imageUrl = data.product.image_url || 'https://images.unsplash.com/photo-1610963876305-c8e7cb43a09b?q=80&w=600&auto=format&fit=crop';
              container.innerHTML = `
                <div style="width:120px;height:140px;border-radius:8px;background:#eaeaea;background-image:url('${imageUrl}');background-size:cover;background-position:center"></div>
                <div>
                  <div style="font-weight:700">${data.product.name}</div>
                  <div class="muted" style="margin-top:4px">${data.product.order_count || 0}+ items sold</div>
                  <div style="margin-top:6px;font-size:14px;color:#666">Store: ${data.product.store_name || 'N/A'}</div>
                  <a href="#" class="tag" style="display:inline-block;margin-top:10px">View Details</a>
                </div>
              `;
            } else {
              document.getElementById('best-product-container').innerHTML = '<p style="color:#999;text-align:center;width:100%">No products yet</p>';
            }
          })
          .catch(error => {
            document.getElementById('best-product-container').innerHTML = '<p style="color:#ef4444;text-align:center;width:100%">Error loading product</p>';
          });
      }

      // Load data on page load
      window.addEventListener('DOMContentLoaded', () => {
        loadRecentOrders();
        loadBestProduct();
      });
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }

      // Product Details Modal Functions
      function viewProductDetails(productId) {
        const modal = document.getElementById('product-details-modal');
        const modalBody = document.getElementById('product-details-body');
        
        modal.style.display = 'flex';
        modalBody.innerHTML = '<p style="text-align:center;padding:40px;">Loading product details...</p>';
        
        fetch(`/admin/product-details/${productId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.product) {
              const p = data.product;
              // Format category name
              const categoryNames = {
                'shirts': 'Shirts & T-Shirts',
                'pants': 'Pants & Jeans',
                'shorts': 'Shorts',
                'jackets': 'Jackets & Coats',
                'shoes': 'Shoes & Footwear',
                'accessories': 'Accessories',
                'underwear': 'Underwear & Socks',
                'activewear': 'Activewear & Sports',
                'formal': 'Formal Wear',
                'casual': 'Casual Wear',
                'grooming': 'Grooming Products'
              };
              const categoryDisplay = categoryNames[p.category] || p.category || 'N/A';
              
              let html = `
                <div style="display:grid;gap:20px;">
                  <!-- Product Images -->
                  ${p.image_url ? `
                    <div style="text-align:center;background:#f9fafb;padding:20px;border-radius:8px;">
                      <img src="${p.image_url}" alt="${p.name}" style="max-width:100%;max-height:300px;object-fit:contain;border-radius:8px;">
                    </div>
                  ` : ''}
                  
                  <!-- Basic Info -->
                  <div style="background:#f9fafb;padding:16px;border-radius:8px;">
                    <h3 style="margin:0 0 12px;color:#0a0a0a;">üìã Basic Information</h3>
                    <div style="display:grid;gap:8px;">
                      <div><strong>Product Name:</strong> ${p.name}</div>
                      <div><strong>Category:</strong> ${categoryDisplay}</div>
                      <div><strong>Brand:</strong> ${p.brand || 'N/A'}</div>
                      <div><strong>SKU:</strong> ${p.sku || 'N/A'}</div>
                      <div><strong>Price:</strong> ‚Ç±${parseFloat(p.price).toFixed(2)}</div>
                      <div><strong>Description:</strong><br>${p.description || 'No description'}</div>
                    </div>
                  </div>
                  
                  <!-- Seller Info -->
                  <div style="background:#f0f9ff;padding:16px;border-radius:8px;">
                    <h3 style="margin:0 0 12px;color:#0a0a0a;">üè™ Seller Information</h3>
                    <div style="display:grid;gap:8px;">
                      <div><strong>Store Name:</strong> ${p.store_name}</div>
                      <div><strong>Seller Email:</strong> ${p.seller_email || 'N/A'}</div>
                      <div><strong>Submitted:</strong> ${new Date(p.created_at).toLocaleString()}</div>
                    </div>
                  </div>
                  
                  <!-- Stock Info -->
                  ${data.variants && data.variants.length > 0 ? `
                    <div style="background:#fef3c7;padding:16px;border-radius:8px;">
                      <h3 style="margin:0 0 12px;color:#0a0a0a;">üì¶ Stock & Variants</h3>
                      <div style="max-height:300px;overflow-y:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                          <thead>
                            <tr style="background:#fbbf24;color:#fff;position:sticky;top:0;">
                              <th style="padding:8px;text-align:left;">Size</th>
                              <th style="padding:8px;text-align:left;">Color</th>
                              <th style="padding:8px;text-align:left;">Stock</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${data.variants.map(v => `
                              <tr style="border-bottom:1px solid #fde68a;">
                                <td style="padding:8px;font-weight:500;">${v.size || 'N/A'}</td>
                                <td style="padding:8px;font-weight:500;">${v.color || 'N/A'}</td>
                                <td style="padding:8px;">${v.stock_quantity || 0} pcs</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                      <div style="margin-top:12px;padding-top:12px;border-top:2px solid #fbbf24;">
                        <strong>Total Stock:</strong> ${data.variants.reduce((sum, v) => sum + (v.stock_quantity || 0), 0)} pcs
                      </div>
                    </div>
                  ` : `
                    <div style="background:#fef3c7;padding:16px;border-radius:8px;">
                      <h3 style="margin:0 0 12px;color:#0a0a0a;">üì¶ Stock Information</h3>
                      <div><strong>Total Stock:</strong> ${p.stock || 0} pcs</div>
                    </div>
                  `}
                  
                  <!-- Action Buttons -->
                  <div style="display:flex;gap:12px;justify-content:flex-end;padding-top:16px;border-top:2px solid var(--line);">
                    <button onclick="closeProductDetailsModal()" class="tag" style="background:#f3f4f6;color:#0a0a0a;cursor:pointer;border:none;padding:10px 16px;">Close</button>
                    <button onclick="approveProductFromModal(${productId})" class="tag" style="background:#10b981;cursor:pointer;border:none;padding:10px 16px;color:#fff;">‚úì Approve</button>
                    <button onclick="rejectProductFromModal(${productId})" class="tag" style="background:#ef4444;cursor:pointer;border:none;padding:10px 16px;color:#fff;">‚úó Reject</button>
                  </div>
                </div>
              `;
              modalBody.innerHTML = html;
            } else {
              modalBody.innerHTML = '<p style="color:#ef4444;text-align:center;padding:40px;">Error loading product details</p>';
            }
          })
          .catch(error => {
            modalBody.innerHTML = '<p style="color:#ef4444;text-align:center;padding:40px;">Error: ' + error.message + '</p>';
          });
      }
      
      function closeProductDetailsModal() {
        document.getElementById('product-details-modal').style.display = 'none';
      }
      
      function approveProductFromModal(productId) {
        closeProductDetailsModal();
        approveProduct(productId);
      }
      
      function rejectProductFromModal(productId) {
        closeProductDetailsModal();
        rejectProduct(productId);
      }

      // Journal Management Functions
      function loadJournalEntries() {
        fetch('/admin/journal-entries')
          .then(response => response.json())
          .then(data => {
            const container = document.getElementById('journal-list');
            if (data.success && data.entries && data.entries.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Title</th>
                      <th>Image</th>
                      <th>Created</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.entries.forEach(entry => {
                const date = new Date(entry.created_at).toLocaleDateString();
                html += `
                  <tr id="journal-row-${entry.id}">
                    <td><strong>${entry.title}</strong></td>
                    <td><img src="${entry.image_url || '/static/images/placeholder.svg'}" style="width:60px;height:60px;object-fit:cover;border-radius:6px" alt="${entry.title}"></td>
                    <td style="color:var(--muted);font-size:13px">${date}</td>
                    <td><span class="tag" style="background:${entry.is_active ? '#10b981' : '#ef4444'}">${entry.is_active ? 'Active' : 'Inactive'}</span></td>
                    <td>
                      <div style="display:flex;gap:8px">
                        <button class="tag" onclick="editJournalEntry(${entry.id})" style="background:#3b82f6;cursor:pointer;border:none">Edit</button>
                        <button class="tag" onclick="deleteJournalEntry(${entry.id})" style="background:#ef4444;cursor:pointer;border:none">Delete</button>
                      </div>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              container.innerHTML = html;
            } else {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:40px">No journal entries yet. Click "Add Journal Entry" to create one.</p>';
            }
          })
          .catch(error => {
            document.getElementById('journal-list').innerHTML = '<p style="color:#ef4444">Error loading journal entries</p>';
          });
      }

      function openAddJournalModal() {
        document.getElementById('journal-modal-title').textContent = 'Add Journal Entry';
        document.getElementById('journal-form').reset();
        document.getElementById('journal-form').setAttribute('data-entry-id', '');
        document.getElementById('journal-modal').style.display = 'flex';
      }

      function editJournalEntry(entryId) {
        fetch(`/admin/journal-entry/${entryId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.entry) {
              const entry = data.entry;
              document.getElementById('journal-modal-title').textContent = 'Edit Journal Entry';
              document.getElementById('journal-title').value = entry.title;
              document.getElementById('journal-description').value = entry.description || '';
              document.getElementById('journal-image').value = entry.image_url || '';
              document.getElementById('journal-link').value = entry.link_url || '';
              document.getElementById('journal-form').setAttribute('data-entry-id', entryId);
              document.getElementById('journal-modal').style.display = 'flex';
            }
          })
          .catch(error => alert('Error loading journal entry'));
      }

      function deleteJournalEntry(entryId) {
        if (!confirm('Delete this journal entry? This cannot be undone.')) return;
        
        fetch(`/admin/journal-entry/${entryId}`, { method: 'DELETE' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Journal entry deleted');
              loadJournalEntries();
            } else {
              alert('Error: ' + data.error);
            }
          })
          .catch(error => alert('Error deleting entry'));
      }

      function closeJournalModal() {
        document.getElementById('journal-modal').style.display = 'none';
        document.getElementById('journal-form').reset();
      }

      // Handle journal form submission
      document.addEventListener('DOMContentLoaded', function() {
        const journalForm = document.getElementById('journal-form');
        if (journalForm) {
          journalForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const entryId = this.getAttribute('data-entry-id');
            const formData = new FormData();
            formData.append('title', document.getElementById('journal-title').value);
            formData.append('description', document.getElementById('journal-description').value);
            formData.append('image_url', document.getElementById('journal-image').value);
            formData.append('link_url', document.getElementById('journal-link').value);

            const url = entryId ? `/admin/journal-entry/${entryId}` : '/admin/journal-entry';
            const method = entryId ? 'PUT' : 'POST';

            fetch(url, { method: method, body: formData })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert(entryId ? 'Journal entry updated' : 'Journal entry created');
                  closeJournalModal();
                  loadJournalEntries();
                } else {
                  alert('Error: ' + data.error);
                }
              })
              .catch(error => alert('Error saving journal entry'));
          });
        }
      });
    </script>
  </body>
</html>
