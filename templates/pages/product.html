<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>{{ product.name }} — Varón</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      body {
        background: #fafafa;
      }

      /* Top Bar */
      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        height: 75px;
        background: #ffffff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 48px;
        z-index: 999;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        backdrop-filter: blur(10px);
      }

      /* Brand Logo */
      .top-brand {
        font-family: 'Playfair Display', serif;
        font-size: 28px;
        font-weight: 600;
        color: #000000;
        letter-spacing: 0.03em;
        white-space: nowrap;
        cursor: pointer;
        transition: opacity 0.2s ease;
        text-decoration: none;
      }
      .top-brand:hover {
        opacity: 0.7;
      }

      /* User Dropdown in Top Bar */
      .user-dropdown {
        position: relative;
      }
      .user-button {
        background: #fafafa;
        border: 1px solid #e8e8e8;
        color: #000000;
        cursor: pointer;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 10px;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .user-button:hover {
        background: #f5f5f5;
        border-color: #d4d4d4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
      }
      .user-button-icon {
        width: 34px;
        height: 34px;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-weight: 600;
        font-size: 13px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      }
      .user-button-text {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        line-height: 1.2;
      }
      .user-button-label {
        font-size: 11px;
        color: #9ca3af;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .user-button-arrow {
        margin-left: 4px;
        font-size: 10px;
        color: #9ca3af;
        transition: transform 0.2s ease;
      }
      .user-dropdown.show .user-button-arrow {
        transform: rotate(180deg);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        background: #fff;
        min-width: 180px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 10px;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid #e5e7eb;
        opacity: 0;
        transform: translateY(-4px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
      }
      .dropdown-content.show {
        display: block;
        opacity: 1;
        transform: translateY(0);
        pointer-events: all;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 14px 18px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
      }
      .dropdown-content a:hover {
        background: #f9fafb;
        padding-left: 22px;
      }

      .product-page {
        max-width: 1280px;
        margin: 100px auto 80px;
        padding: 0 32px;
      }
      .product-container {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 80px;
        background: #ffffff;
        padding: 48px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
      }
      .product-images {
        position: sticky;
        top: 80px;
        height: fit-content;
      }
      .main-image {
        width: 100%;
        height: 650px;
        background-color: #fafafa;
        margin-bottom: 24px;
        border-radius: 12px;
        cursor: zoom-in;
        overflow: hidden;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #f0f0f0;
      }
      .main-image img {
        transition: transform 0.3s ease;
      }
      .thumbnails {
        display: flex;
        gap: 10px;
        overflow-x: auto;
      }
      .thumbnail {
        width: 90px;
        height: 90px;
        background-color: #fafafa;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid #e8e8e8;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .thumbnail:hover {
        border-color: #d4d4d4;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .thumbnail.active {
        border-color: #000000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      }
      .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .product-info h1 {
        font-family: 'Playfair Display', serif;
        font-size: 32px;
        font-weight: 600;
        margin: 0 0 16px;
        line-height: 1.3;
        color: #000000;
        letter-spacing: -0.01em;
      }
      .product-price {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #000000;
      }
      .tax-info {
        font-size: 14px;
        color: #737373;
        margin-bottom: 32px;
      }
      .selection-group {
        margin-bottom: 32px;
        padding-bottom: 32px;
        border-bottom: 1px solid #f0f0f0;
      }
      .selection-group:last-of-type {
        border-bottom: none;
      }
      .selection-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        font-size: 15px;
        font-weight: 600;
        color: #000000;
      }
      .selection-label span {
        font-weight: 500;
        color: #737373;
      }
      .color-swatches {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .color-swatch {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #e8e8e8;
        cursor: pointer;
        position: relative;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      }
      .color-swatch:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      }
      .color-swatch.selected {
        border-color: #000000;
        box-shadow: 0 0 0 3px #fff, 0 0 0 5px #000000;
        transform: scale(1.05);
      }
      .size-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        gap: 12px;
      }
      .size-btn {
        padding: 14px 16px;
        border: 2px solid #e8e8e8;
        background: #ffffff;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: center;
        color: #000000;
      }
      .size-btn:hover {
        border-color: #d4d4d4;
        background: #fafafa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .size-btn.selected {
        background: #000000;
        color: #ffffff;
        border-color: #000000;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      }
      .quantity-control {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      .qty-btn {
        width: 48px;
        height: 48px;
        border: 2px solid #e8e8e8;
        background: #ffffff;
        cursor: pointer;
        font-size: 22px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: #000000;
        font-weight: 500;
      }
      .qty-btn:hover {
        border-color: #d4d4d4;
        background: #fafafa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }
      .qty-btn:active {
        transform: translateY(0);
      }
      .qty-input {
        width: 80px;
        height: 48px;
        text-align: center;
        border: 2px solid #e8e8e8;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        color: #000000;
        background: #fafafa;
      }
      .stock-status {
        display: flex;
        align-items: center;
        gap: 8px;
        color: #10b981;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 24px;
        padding: 12px 16px;
        background: #f0fdf4;
        border-radius: 8px;
        border: 1px solid #d1fae5;
      }
      .low-stock-indicator {
        display: none;
        align-items: center;
        gap: 8px;
        color: #ea580c;
        font-size: 14px;
        font-weight: 600;
        margin: 16px 0;
        padding: 12px 16px;
        background: #fff7ed;
        border-radius: 8px;
        border: 1px solid #fed7aa;
        animation: pulse-warning 1.5s infinite;
      }
      .low-stock-indicator.show {
        display: flex;
      }
      @keyframes pulse-warning {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      .add-to-cart-btn {
        width: 100%;
        padding: 18px 24px;
        background: #000000;
        color: #ffffff;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin-top: 8px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        letter-spacing: 0.02em;
      }
      .add-to-cart-btn:hover:not(:disabled) {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      }
      .add-to-cart-btn:active:not(:disabled) {
        transform: translateY(0);
      }
      .add-to-cart-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        background: #e8e8e8;
        color: #a3a3a3;
        box-shadow: none;
      }
      .product-details {
        margin-top: 48px;
        padding-top: 32px;
        border-top: 2px solid #f0f0f0;
      }

      /* Reviews Section */
      .reviews-section {
        margin-top: 48px;
        padding-top: 32px;
        border-top: 2px solid #f0f0f0;
      }

      .reviews-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 20px;
      }

      .reviews-title {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
        color: #000;
      }

      .rating-summary {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .rating-stats {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
        padding: 16px 24px;
        background: #fafafa;
        border-radius: 12px;
        border: 1px solid #e8e8e8;
      }

      .rating-value {
        font-size: 36px;
        font-weight: 700;
        color: #000;
        line-height: 1;
      }

      .rating-stars {
        font-size: 18px;
        color: #fbbf24;
        letter-spacing: 2px;
      }

      .review-count {
        font-size: 13px;
        color: #666;
        font-weight: 500;
      }

      .review-form-btn {
        padding: 12px 24px;
        background: #000;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .review-form-btn:hover {
        background: #1a1a1a;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      }

      .reviews-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .review-card {
        background: #fff;
        border: 1px solid #e8e8e8;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.3s ease;
      }

      .review-card:hover {
        border-color: #d4d4d4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 16px;
      }

      .review-author {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .author-name {
        font-weight: 600;
        font-size: 15px;
        color: #000;
      }

      .review-stars {
        color: #fbbf24;
        font-size: 16px;
        letter-spacing: 2px;
      }

      .review-date {
        font-size: 13px;
        color: #999;
      }

      .verified-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #dcfce7;
        color: #15803d;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }

      .review-title {
        font-weight: 600;
        font-size: 16px;
        color: #000;
        margin: 0 0 10px 0;
      }

      .review-comment {
        font-size: 14px;
        color: #444;
        line-height: 1.6;
        margin: 0;
      }

      .no-reviews {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .no-reviews svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      .no-reviews h3 {
        font-size: 18px;
        color: #666;
        margin: 0 0 8px 0;
      }

      .no-reviews p {
        font-size: 14px;
        color: #999;
        margin: 0;
      }

      /* Reviews Pagination */
      .reviews-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }

      .review-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        animation: slideIn 0.3s ease;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .review-card:hover {
        border-color: #d4d4d4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .review-rating-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #ffffff;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        margin: 8px 0 12px 0;
      }

      .reviews-pagination {
        display: flex;
        justify-content: center;
        margin-top: 32px;
        gap: 12px;
      }

      .see-more-btn {
        padding: 14px 32px;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #ffffff;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        letter-spacing: 0.02em;
      }

      .see-more-btn:hover {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.25);
      }

      .see-more-btn:active {
        transform: translateY(0);
      }

      .see-more-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .reviews-count-info {
        text-align: center;
        font-size: 13px;
        color: #666;
        margin-top: 16px;
        font-weight: 500;
      }

      .hidden-review {
        display: none;
      }

      .hidden-review.show {
        display: block;
      }
      .details-section {
        margin-bottom: 28px;
      }
      .details-section h3 {
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 12px;
        color: #000000;
        letter-spacing: 0.01em;
      }
      .details-section p {
        font-size: 15px;
        line-height: 1.8;
        color: #525252;
        margin: 0;
      }
      .product-meta {
        display: grid;
        gap: 12px;
        margin-top: 24px;
        padding: 20px;
        background: #fafafa;
        border-radius: 10px;
        border: 1px solid #f0f0f0;
      }
      .meta-item {
        font-size: 14px;
        color: #737373;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .meta-item strong {
        color: #000000;
        font-weight: 600;
      }

      /* Reviews Section Styles */
      .reviews-section {
        margin-top: 60px;
        padding-top: 60px;
        border-top: 1px solid #f0f0f0;
      }

      .reviews-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
      }

      .reviews-title {
        font-size: 28px;
        font-weight: 600;
        color: #000000;
        margin: 0;
      }

      .rating-summary {
        display: flex;
        align-items: center;
        gap: 24px;
      }

      .rating-stats {
        text-align: center;
      }

      .rating-value {
        font-size: 36px;
        font-weight: 700;
        color: #000000;
      }

      .rating-stars {
        display: flex;
        gap: 4px;
        justify-content: center;
        margin: 8px 0;
      }

      .star {
        width: 20px;
        height: 20px;
        color: #fbbf24;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .star.filled {
        color: #fbbf24;
      }

      .star.empty {
        color: #e5e7eb;
      }

      .star:hover {
        transform: scale(1.1);
      }

      .review-count {
        font-size: 14px;
        color: #666;
        margin-top: 4px;
      }

      .review-form-btn {
        background: #000000;
        color: #ffffff;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .review-form-btn:hover {
        background: #333333;
        transform: translateY(-2px);
      }

      .review-form-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
      }

      .reviews-list {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .review-item {
        padding: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #fafafa;
        transition: all 0.3s ease;
      }

      .review-item:hover {
        border-color: #d4d4d4;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      }

      .review-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
      }

      .review-author {
        font-weight: 600;
        color: #000000;
        font-size: 15px;
      }

      .review-date {
        font-size: 13px;
        color: #999;
      }

      .review-rating {
        display: flex;
        gap: 4px;
        margin: 8px 0;
      }

      .review-title {
        font-weight: 600;
        font-size: 15px;
        color: #000000;
        margin: 8px 0;
      }

      .review-comment {
        color: #666;
        font-size: 14px;
        line-height: 1.6;
        margin: 8px 0;
      }

      .verified-badge {
        display: inline-block;
        background: #ecfdf5;
        color: #047857;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
        margin-top: 8px;
      }

      .no-reviews {
        text-align: center;
        padding: 40px 20px;
        color: #999;
      }

      /* Review Form Modal */
      .review-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10001;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .review-modal.show {
        display: flex;
      }

      .review-form-card {
        background: #fff;
        border-radius: 16px;
        max-width: 600px;
        width: 100%;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      }

      .review-form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
      }

      .review-form-title {
        font-size: 24px;
        font-weight: 600;
        margin: 0;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
      }

      .close-btn:hover {
        background: #f0f0f0;
        color: #000;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 14px;
        color: #000000;
      }

      .rating-selector {
        display: flex;
        gap: 12px;
      }

      .rating-option {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .rating-option input {
        display: none;
      }

      .rating-option label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
      }

      .rating-option input:checked + label {
        background: #f3f4f6;
      }

      .form-input {
        width: 100%;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      .form-input:focus {
        outline: none;
        border-color: #000000;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
      }

      .form-textarea {
        resize: vertical;
        min-height: 120px;
      }

      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
      }

      .btn-cancel {
        background: #f3f4f6;
        color: #000000;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-cancel:hover {
        background: #e5e7eb;
      }

      .btn-submit {
        background: #000000;
        color: #ffffff;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .btn-submit:hover {
        background: #333333;
      }

      .btn-submit:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      .error-message {
        color: #ef4444;
        font-size: 13px;
        margin-top: 4px;
      }

      .success-message {
        color: #10b981;
        font-size: 13px;
        margin-top: 4px;
      }

      @media (max-width: 768px) {
        .reviews-header {
          flex-direction: column;
          gap: 20px;
          align-items: flex-start;
        }

        .review-form-card {
          padding: 20px;
        }

        .rating-summary {
          flex-direction: column;
          align-items: flex-start;
        }
      }

      @media (max-width: 768px) {
        .product-container {
          grid-template-columns: 1fr;
          gap: 30px;
        }
        .product-images {
          position: relative;
          top: 0;
        }
        .size-grid {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      /* Cart Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }
      .cart-card {
        background: #fff;
        border-radius: 16px;
        max-width: 700px;
        width: 100%;
        max-height: 85vh;
        overflow-y: auto;
        padding: 32px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      }
      .cart-card h2 {
        font-size: 28px;
        margin-bottom: 24px;
        font-weight: 600;
      }
      .cart-list {
        max-height: 450px;
        overflow-y: auto;
        margin-bottom: 24px;
      }
      .cart-item {
        display: flex;
        gap: 16px;
        padding: 16px;
        border-bottom: 1px solid #e0e0e0;
        align-items: center;
      }
      .cart-item-info {
        flex: 1;
      }
      .cart-item-info h4 {
        margin: 0 0 6px;
        font-size: 16px;
        font-weight: 600;
      }
      .cart-item-info p {
        margin: 0;
        color: #666;
        font-size: 15px;
      }
      .cart-actions {
        border-top: 1px solid #e0e0e0;
        padding-top: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .cart-total {
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }
      .btn-cta {
        padding: 12px 24px;
        background: #0a0a0a;
        color: #fff;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        width: 100%;
      }
      .btn-cta:hover {
        background: #2d2d2d;
      }
      .snackbar {
        visibility: hidden;
        min-width: 250px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 8px;
        padding: 16px;
        position: fixed;
        z-index: 10001;
        left: 50%;
        bottom: 30px;
        transform: translateX(-50%);
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      }
      .snackbar.show {
        visibility: visible;
        animation: fadein 0.3s, fadeout 0.3s 2.7s;
      }
      @keyframes fadein {
        from { bottom: 0; opacity: 0; }
        to { bottom: 30px; opacity: 1; }
      }
      @keyframes fadeout {
        from { bottom: 30px; opacity: 1; }
        to { bottom: 0; opacity: 0; }
      }

      /* Floating Cart Button */
      .floating-cart-btn {
        position: fixed;
        bottom: 32px;
        right: 32px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(0,0,0,0.25);
        z-index: 998;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .floating-cart-btn:hover {
        transform: translateY(-4px) scale(1.05);
        box-shadow: 0 12px 32px rgba(0,0,0,0.35);
      }
      .floating-cart-btn:active {
        transform: translateY(-2px) scale(1.02);
      }
      .floating-cart-btn svg {
        width: 26px;
        height: 26px;
        stroke: #fff;
      }
      .floating-cart-badge {
        position: absolute;
        top: -4px;
        right: -4px;
        background: #ef4444;
        color: #fff;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      }
      @media (max-width: 768px) {
        .top-bar {
          padding: 0 20px;
          height: 65px;
        }
        .top-brand {
          font-size: 22px;
        }
        .user-button {
          padding: 8px 12px;
          gap: 8px;
        }
        .user-button-icon {
          width: 30px;
          height: 30px;
          font-size: 12px;
        }
        .user-button-text span {
          font-size: 13px;
        }
        .user-button-label {
          font-size: 10px;
        }
        .product-page {
          margin-top: 85px;
        }
        .floating-cart-btn {
          bottom: 20px;
          right: 20px;
          width: 55px;
          height: 55px;
        }
        .floating-cart-btn svg {
          width: 22px;
          height: 22px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Top Bar -->
    <div class="top-bar">
      <a href="{{ url_for('buyer_dashboard') if session.get('logged_in') and session.get('role') == 'buyer' else url_for('index') }}" class="top-brand">Varón</a>
      {% if session.get('logged_in') %}
      <div class="user-dropdown">
        <button class="user-button" onclick="toggleUserDropdown()">
          <div class="user-button-icon" id="buyerInitial">{{ session.get('username', 'U')[0]|upper }}</div>
          <div class="user-button-text">
            <span class="user-button-label">Account</span>
            <span id="buyerUsername" style="font-weight: 600;">{{ session.get('username', 'User') }}</span>
          </div>
          <span class="user-button-arrow">▼</span>
        </button>
        <div id="userDropdown" class="dropdown-content">
          <a href="{{ url_for('my_orders') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="9" y1="9" x2="15" y2="9"></line>
              <line x1="9" y1="15" x2="15" y2="15"></line>
            </svg>
            My Orders
          </a>
          <a href="{{ url_for('account_details') }}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            My Account
          </a>
          <a href="{{ url_for('logout') }}" style="color: #ef4444;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
          </a>
        </div>
      </div>
      {% else %}
      <a href="{{ url_for('login') }}" class="user-button" style="text-decoration: none;">Login</a>
      {% endif %}
    </div>

    <main class="product-page">
      <div class="product-container">
        <!-- Product Images -->
        <div class="product-images">
          {% if images and images|length > 0 %}
            <div class="main-image" id="mainImage">
              <img src="{{ images[0].image_url }}" alt="{{ product.name }}" style="width:100%;height:100%;object-fit:contain" onerror="this.src='/static/images/placeholder.jpg'">
            </div>
            <div class="thumbnails">
              {% for image in images %}
                <div class="thumbnail {% if loop.first %}active{% endif %}"
                     data-image="{{ image.image_url }}"
                     onclick="changeMainImage('{{ image.image_url }}', this)">
                  <img src="{{ image.image_url }}" alt="{{ product.name }}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='/static/images/placeholder.jpg'">
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="main-image" id="mainImage">
              <img src="{{ product.image_url or '/static/images/placeholder.svg' }}" alt="{{ product.name }}" style="width:100%;height:100%;object-fit:contain" onerror="this.src='/static/images/placeholder.svg'">
            </div>
            <div class="thumbnails">
              <div class="thumbnail active">
                <img src="{{ product.image_url or '/static/images/placeholder.svg' }}" alt="{{ product.name }}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='/static/images/placeholder.svg'">
              </div>
            </div>
          {% endif %}
        </div>

        <!-- Product Info -->
        <div class="product-info">
          <h1>{{ product.name }}</h1>

          <div class="product-price">PHP {{ "{:,.2f}".format(product.price) }}</div>
          <div class="tax-info">Tax included</div>

          <!-- Low Stock Indicator -->
          <div id="lowStockIndicator" class="low-stock-indicator">
            <span style="font-size: 18px;">⚠️</span>
            <span>Only <strong id="lowStockCount">10</strong> items left in stock</span>
          </div>

          <!-- Rating & Sold Count -->
          <div style="display:flex;align-items:center;gap:16px;margin:16px 0;padding:12px 0;border-top:1px solid #f0f0f0;border-bottom:1px solid #f0f0f0">
            <div style="display:flex;align-items:center;gap:6px">
              <span style="color:#fbbf24;font-size:16px">★</span>
              <span style="font-weight:600;color:#0a0a0a;font-size:15px">{{ "%.1f"|format(product.avg_rating or 0) }}</span>
              <span style="color:#999;font-size:14px">({{ product.review_count or 0 }} reviews)</span>
            </div>
            <div style="width:1px;height:20px;background:#e0e0e0"></div>
            <div style="color:#666;font-size:14px">
              <strong style="color:#0a0a0a">{{ product.sold_count or 0 }}</strong> sold
            </div>
          </div>

          <!-- Color Selection - Only show if colors exist -->
          {% if colors and colors|length > 0 and colors[0] != 'Standard' %}
          <div class="selection-group" id="colorSection">
            <div class="selection-label">
              <strong>Color: <span id="selectedColorName">Select a color</span></strong>
            </div>
            <div class="color-swatches" id="colorSwatches" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 16px;">
              {% for color in colors %}
                <div style="display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer;" onclick="selectColor('{{ color }}')">
                  <button class="color-swatch" data-color="{{ color }}" title="{{ color }}" style="width: 60px; height: 60px; border-radius: 8px; border: 2px solid #ddd; cursor: pointer; transition: all 0.2s;">
                  </button>
                  <span style="font-size: 12px; color: #666; text-align: center; max-width: 70px; word-wrap: break-word;">{{ color }}</span>
                </div>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Size/Volume Selection - Only show if sizes exist -->
          {% if sizes and sizes|length > 0 and sizes[0] != 'One Size' %}
          <div class="selection-group" id="sizeSection">
            <div class="selection-label">
              <strong>{% if 'grooming' in product.category_name|lower %}Volume:{% else %}Size:{% endif %} <span id="selectedSizeName">Select {% if 'grooming' in product.category_name|lower %}volume{% else %}size{% endif %}</span></strong>
            </div>
            <div class="size-grid" id="sizeGrid">
              {% for size in sizes %}
                <button class="size-btn" onclick="selectSize('{{ size }}')">{{ size }}</button>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Quantity -->
          <!-- Stock Status Display -->
          <div id="stockStatus" class="stock-status" style="display:none;">
            <span>✓ In Stock</span>
          </div>
          <div id="stockQuantity" style="display:none;padding:12px 16px;background:#f3f4f6;border-radius:8px;border:1px solid #e5e7eb;margin:16px 0;font-size:14px;font-weight:600;color:#374151;">
            <span id="stockQuantityText"></span>
          </div>

          <div class="selection-group">
            <div class="selection-label">
              <strong>Quantity</strong>
            </div>
            <div class="quantity-control">
              <button class="qty-btn" onclick="decreaseQuantity()">−</button>
              <input type="number" class="qty-input" id="quantity" value="1" min="1" readonly>
              <button class="qty-btn" onclick="increaseQuantity()">+</button>
            </div>
          </div>

          <!-- Stock Warning (Hidden by default, shown only when quantity exceeds stock) -->
          <div id="stockWarning" style="display:none;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;padding:14px;margin:16px 0;color:#991b1b;">
            <p style="margin:0;font-weight:600;font-size:14px;">⚠️ Limited Stock</p>
            <p id="stockWarningText" style="margin:4px 0 0 0;font-size:13px;"></p>
          </div>

          <!-- Add to Cart -->
          <button class="add-to-cart-btn" id="addToCartBtn" onclick="addToCartFromPage()" disabled>
            {% if colors and sizes %}
            Select Size and Color
            {% elif sizes %}
            Select {% if 'grooming' in product.category_name|lower %}Volume{% else %}Size{% endif %}
            {% elif colors %}
            Select Color
            {% else %}
            Add to Cart
            {% endif %}
          </button>

          <!-- Available Colors Summary -->
          {% if colors and colors|length > 0 %}
          <div style="margin: 20px 0; padding: 14px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 8px;">
            <p style="margin: 0 0 10px 0; font-size: 13px; font-weight: 600; color: #1e40af;">Available Colors:</p>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              {% for color in colors %}
              <span style="display: inline-block; padding: 6px 12px; background: white; border: 1px solid #dbeafe; border-radius: 20px; font-size: 12px; color: #1e3a8a; font-weight: 500;">{{ color }}</span>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <!-- Product Details -->
          <div class="product-details">
            <div class="details-section">
              <h3>Product Details</h3>
              <p>{{ product.description or 'High-quality product crafted with attention to detail. Made from premium materials for lasting comfort and style.' }}</p>
            </div>

            <div class="product-meta">
              <div class="meta-item"><strong>Brand:</strong> {{ product.brand or 'Varón' }}</div>
              <div class="meta-item"><strong>Category:</strong> {{ product.category_name or 'Apparel' }}</div>
            </div>
          </div>

          <!-- Reviews Section -->
          <div class="reviews-section">
            <div class="reviews-header">
              <h2 class="reviews-title">Customer Reviews</h2>
              {% if session.get('logged_in') and session.get('role') == 'buyer' %}
              <div class="rating-summary">
                <div class="rating-stats">
                  <div class="rating-value" id="avgRating">{{ "%.1f"|format(product.avg_rating or 0) }}</div>
                  <div class="rating-stars" id="ratingStars">
                    {% set rating = product.avg_rating or 0 %}
                    {% for i in range(5) %}
                      {% if i < rating|int %}⭐{% else %}☆{% endif %}
                    {% endfor %}
                  </div>
                  <div class="review-count" id="reviewCount">{{ product.review_count or 0 }} review{{ 's' if (product.review_count or 0) != 1 else '' }}</div>
                </div>
                <button class="review-form-btn" id="reviewBtn" onclick="openReviewForm()">Write a Review</button>
              </div>
              {% else %}
              <div class="rating-summary">
                <div class="rating-stats">
                  <div class="rating-value" id="avgRating">{{ "%.1f"|format(product.avg_rating or 0) }}</div>
                  <div class="rating-stars" id="ratingStars">
                    {% set rating = product.avg_rating or 0 %}
                    {% for i in range(5) %}
                      {% if i < rating|int %}⭐{% else %}☆{% endif %}
                    {% endfor %}
                  </div>
                  <div class="review-count" id="reviewCount">{{ product.review_count or 0 }} review{{ 's' if (product.review_count or 0) != 1 else '' }}</div>
                </div>
              </div>
              {% endif %}
            </div>

            <div class="reviews-list" id="reviewsList">
              <!-- Reviews will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Review Form Modal -->
    <div class="review-modal" id="reviewModal">
      <div class="review-form-card">
        <div class="review-form-header">
          <h3 class="review-form-title">Write a Review</h3>
          <button class="close-btn" onclick="closeReviewForm()">×</button>
        </div>

        <form id="reviewForm" onsubmit="submitReview(event)">
          <div class="form-group">
            <label class="form-label">Rating *</label>
            <div class="rating-selector">
              {% for i in range(1, 6) %}
              <div class="rating-option">
                <input type="radio" name="rating" id="rating{{ i }}" value="{{ i }}" required>
                <label for="rating{{ i }}">
                  <span>{{ '⭐' * i }}</span>
                  <span style="font-size: 13px; color: #666;">{{ i }} Star{{ 's' if i > 1 else '' }}</span>
                </label>
              </div>
              {% endfor %}
            </div>
            <div id="ratingError" class="error-message"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="reviewTitle">Review Title</label>
            <input type="text" id="reviewTitle" name="title" class="form-input" placeholder="e.g., Great product, highly recommend!" maxlength="200">
            <div id="titleError" class="error-message"></div>
          </div>

          <div class="form-group">
            <label class="form-label" for="reviewComment">Your Review *</label>
            <textarea id="reviewComment" name="comment" class="form-input form-textarea" placeholder="Share your experience with this product..." required></textarea>
            <div id="commentError" class="error-message"></div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" onclick="closeReviewForm()">Cancel</button>
            <button type="submit" class="btn-submit" id="submitBtn">Submit Review</button>
          </div>

          <div id="formMessage" class="success-message" style="display: none; text-align: center; margin-top: 16px;"></div>
        </form>
      </div>
    </div>

    <!-- Floating Cart Button -->
    <div class="floating-cart-btn" onclick="window.location.href='/cart'" title="View Cart">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 2L7.17 4H3c-.55 0-1 .45-1 1s.45 1 1 1h1l1.6 8.6c.18 1 1.05 1.73 2.06 1.73h7.72c1.01 0 1.88-.73 2.06-1.73L19 6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4.17L14 2H9z"/>
        <circle cx="9" cy="20" r="1"/>
        <circle cx="16" cy="20" r="1"/>
      </svg>
      <span id="floatingCartBadge" class="floating-cart-badge">0</span>
    </div>

    <footer class="site-footer">
      <div class="footer-grid">
        <div>
          <h4>Varón</h4>
          <p class="muted">Minimal, responsibly-made apparel.</p>
        </div>
        <div>
          <h5>Shop</h5>
          <ul>
            <li><a href="{{ url_for('index') }}">All Products</a></li>
          </ul>
        </div>
      </div>
    </footer>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" style="display:none;position:fixed;inset:0;background:rgba(10,10,10,0.45);align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;padding:24px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 6px rgba(0,0,0,0.1)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">×</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:12px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>

    <script>

      document.addEventListener('DOMContentLoaded', async () => {

        {% if session.get('logged_in') %}
        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            const firstName = data.firstName;
            const buyerFirstNameEl = document.getElementById('buyerFirstName');
            const buyerInitialEl = document.getElementById('buyerInitial');
            if (buyerFirstNameEl) buyerFirstNameEl.textContent = firstName;
            if (buyerInitialEl) buyerInitialEl.textContent = firstName.charAt(0).toUpperCase();
          })
          .catch(error => console.error('Error fetching buyer name:', error));
        {% endif %}


        if (window.VaronCart) {
          const items = await VaronCart.get();
          const count = items.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
          const badge = document.getElementById('floatingCartBadge');
          if (badge) badge.textContent = count;
        }

        // Initialize stock display for products without variations
        if (!hasColors && !hasSizes) {
          updateStockDisplay();
          checkSelection();
        }
      });

      // ======= COLOR HEX MAPPING AND INITIALIZATION =======
      const categoryName = '{{ product.category_name }}';
      const isGroomingProduct = categoryName && categoryName.toLowerCase().includes('grooming');

      const colorHex = {
        'Black': '#000000', 'White': '#FFFFFF', 'Gray': '#808080', 'Grey': '#808080',
        'Navy': '#000080', 'Blue': '#0000FF', 'Red': '#FF0000', 'Pink': '#FFC0CB',
        'Green': '#008000', 'Brown': '#8B4513', 'Beige': '#F5F5DC', 'Cream': '#FFFDD0',
        'Khaki': '#C3B091', 'Burgundy': '#800020', 'Olive': '#808000', 'Orange': '#FF8C00',
        'Charcoal': '#36454F', 'Yellow': '#FFD700', 'Purple': '#800080', 'Violet': '#8B00FF',
        'Maroon': '#800000', 'Tan': '#D2B48C', 'Ivory': '#FFFFF0', 'Silver': '#C0C0C0',
        'Gold': '#FFD700', 'Indigo': '#4B0082', 'Teal': '#008080', 'Cyan': '#00FFFF',
        'Magenta': '#FF00FF', 'Lime': '#00FF00', 'Coral': '#FF7F50', 'Peach': '#FFE5B4',
        'Lavender': '#E6E6FA', 'Mint': '#98FF98', 'Sky Blue': '#87CEEB', 'Dark Blue': '#00008B'
      };

      // Function to get hex color from color name
      function getHexColor(colorName) {
        if (colorHex[colorName]) return colorHex[colorName];
        
        // Try case-insensitive match
        for (const [key, value] of Object.entries(colorHex)) {
          if (key.toLowerCase() === colorName.toLowerCase()) {
            return value;
          }
        }
        
        // Try partial match
        const colorLower = colorName.toLowerCase();
        for (const [key, value] of Object.entries(colorHex)) {
          if (key.toLowerCase().includes(colorLower) || colorLower.includes(key.toLowerCase())) {
            return value;
          }
        }
        
        // Generate random hash-based color for unknown colors
        let hash = 0;
        for (let i = 0; i < colorName.length; i++) {
          const char = colorName.charCodeAt(i);
          hash = ((hash << 5) - hash) + char;
          hash = hash & hash;
        }
        const hue = (Math.abs(hash) % 360);
        return `hsl(${hue}, 70%, 50%)`;
      }

      // Function to initialize color swatches with actual colors
      function initializeColorSwatches() {
        console.log('[COLOR INIT] Starting color swatch initialization...');
        const swatches = document.querySelectorAll('.color-swatch');
        console.log(`[COLOR INIT] Found ${swatches.length} color swatches`);
        
        swatches.forEach(swatch => {
          const color = swatch.getAttribute('data-color');
          if (!color) {
            console.log('[COLOR INIT] Swatch missing data-color attribute');
            return;
          }

          console.log(`[COLOR INIT] Processing color: ${color}`);

          // Handle multi-color combinations (e.g., "Black/Yellow")
          if (color.includes('/')) {
            const colorParts = color.split('/').map(c => c.trim());
            const hexColors = colorParts.map(c => getHexColor(c));

            if (colorParts.length === 2) {
              swatch.style.background = `linear-gradient(135deg, ${hexColors[0]} 50%, ${hexColors[1]} 50%)`;
            } else if (colorParts.length === 3) {
              swatch.style.background = `linear-gradient(135deg, ${hexColors[0]} 33%, ${hexColors[1]} 33%, ${hexColors[1]} 66%, ${hexColors[2]} 66%)`;
            } else {
              const segments = colorParts.length;
              const percentPerColor = 100 / segments;
              let gradient = 'linear-gradient(135deg';
              hexColors.forEach((hex, i) => {
                const start = i * percentPerColor;
                const end = (i + 1) * percentPerColor;
                gradient += `, ${hex} ${start}%, ${hex} ${end}%`;
              });
              gradient += ')';
              swatch.style.background = gradient;
            }
          } else {
            // Single color
            const hex = getHexColor(color);
            swatch.style.background = hex;
            console.log(`[COLOR INIT] Applied color to ${color}: ${hex}`);
          }

          // Add color name as tooltip
          swatch.setAttribute('title', color);
          swatch.style.border = '2px solid #ddd';
          swatch.style.transition = 'transform 0.2s, box-shadow 0.2s';
        });
      }

      // Initialize colors once DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeColorSwatches);
      } else {
        // DOM is already loaded
        setTimeout(initializeColorSwatches, 100);
      }

      // Check if product has real variations
      const hasColors = {{ 'true' if colors and colors|length > 0 and colors[0] != 'Standard' else 'false' }};
      const hasSizes = {{ 'true' if sizes and sizes|length > 0 and sizes[0] != 'One Size' else 'false' }};
      
      let selectedColor = hasColors ? null : 'Standard';
      let selectedSize = hasSizes ? null : 'One Size';

      // Store all available sizes
      const allSizes = {{ sizes|tojson|safe }};
      const stockMap = {{ stock_map|tojson|safe }};

      // Function to sort sizes from smallest to largest
      function sortSizes(sizes) {
        const sizeOrder = {
          // Clothing sizes
          'XXS': 1, 'XS': 2, 'S': 3, 'M': 4, 'L': 5, 'XL': 6, '2XL': 7, '3XL': 8, '4XL': 9, '5XL': 10,
          // Shoe sizes (numeric)
          '5': 20, '5.5': 21, '6': 22, '6.5': 23, '7': 24, '7.5': 25, '8': 26, '8.5': 27, 
          '9': 28, '9.5': 29, '10': 30, '10.5': 31, '11': 32, '11.5': 33, '12': 34, '12.5': 35, '13': 36
        };
        
        return sizes.sort((a, b) => {
          const orderA = sizeOrder[a] || parseInt(a) || 999;
          const orderB = sizeOrder[b] || parseInt(b) || 999;
          return orderA - orderB;
        });
      }

      // Check and display low stock indicator
      function checkLowStock() {
        const lowStockIndicator = document.getElementById('lowStockIndicator');
        if (!lowStockIndicator) return;
        
        let minStock = Infinity;
        
        // Get minimum stock from all variants
        Object.values(stockMap).forEach(stock => {
          if (stock < minStock) {
            minStock = stock;
          }
        });
        
        // Show indicator if stock is 10 or below
        if (minStock <= 10 && minStock > 0) {
          document.getElementById('lowStockCount').textContent = minStock;
          lowStockIndicator.classList.add('show');
        } else if (minStock <= 0) {
          // Show out of stock
          document.getElementById('lowStockCount').textContent = '0';
          lowStockIndicator.innerHTML = '<span style="font-size: 18px;">🚫</span><span>This item is currently <strong>out of stock</strong></span>';
          lowStockIndicator.classList.add('show');
          lowStockIndicator.style.color = '#dc2626';
          lowStockIndicator.style.borderColor = '#fecaca';
          lowStockIndicator.style.background = '#fee2e2';
        } else {
          lowStockIndicator.classList.remove('show');
        }
      }
      checkLowStock();

      // If no variations exist, set defaults
      if (!hasColors && !hasSizes) {
        selectedColor = 'Standard';
        selectedSize = 'One Size';
      }
      // Initial render of sizes when no color is selected
      (function initSizesGrid() {
        const sizeGrid = document.getElementById('sizeGrid');
        if (!sizeGrid) return;
        if (hasSizes) {
          const sortedSizes = sortSizes([...allSizes]);
          sizeGrid.innerHTML = sortedSizes.map(size => 
            `<button class="size-btn" onclick="selectSize('${size}')">${size}</button>`
          ).join('');
        } else {
          // If product has no sizes, ensure grid is cleared
          sizeGrid.innerHTML = '';
        }
      })();
      function changeMainImage(imageUrl, thumbnail) {
        const mainImg = document.querySelector('#mainImage img');
        if (mainImg) {
          mainImg.src = imageUrl;
        }


        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        thumbnail.classList.add('active');
      }


      const mainImage = document.getElementById('mainImage');
      if (mainImage) {
        const mainImg = mainImage.querySelector('img');
        if (mainImg) {
          mainImage.addEventListener('mousemove', function(e) {
            const rect = this.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            mainImg.style.transform = `scale(1.8)`;
            mainImg.style.transformOrigin = `${x}% ${y}%`;
          });

          mainImage.addEventListener('mouseleave', function() {
            mainImg.style.transform = 'scale(1)';
            mainImg.style.transformOrigin = 'center';
          });
        }
      }

      function selectColor(color) {
        selectedColor = color;
        document.getElementById('selectedColorName').textContent = color;

        // Remove selected class from all color swatches
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
        
        // Add selected class to the clicked color swatch
        const clickedSwatch = document.querySelector(`.color-swatch[data-color="${color}"]`);
        if (clickedSwatch) {
          clickedSwatch.classList.add('selected');
        }

        // Switch to image matching the selected color
        switchImageByColor(color);

        // Filter sizes for this color only
        updateSizesForColor(color);
        
        // Reset size selection when color changes
        selectedSize = null;
        document.getElementById('selectedSizeName').textContent = 'Select {% if "grooming" in product.category_name|lower %}volume{% else %}size{% endif %}';

        hideStockWarning();
        updateStockDisplay();
        checkSelection();
      }

      function switchImageByColor(color) {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const colorLower = color.toLowerCase().trim();
        
        // Try to find thumbnail matching the color
        let matchedThumbnail = null;
        
        thumbnails.forEach(thumb => {
          const img = thumb.querySelector('img');
          if (!img) return;
          
          const imgSrc = img.src.toLowerCase();
          const imgAlt = (img.alt || '').toLowerCase();
          
          // Check if image URL or alt text contains the color name
          if (imgSrc.includes(colorLower) || imgAlt.includes(colorLower)) {
            matchedThumbnail = thumb;
          }
        });
        
        // If we found a matching thumbnail, click it to change main image
        if (matchedThumbnail) {
          const imgUrl = matchedThumbnail.querySelector('img').src;
          changeMainImage(imgUrl, matchedThumbnail);
        } else {
          // Fallback: try matching by index or pattern
          // Look for color keywords in any part of the filename
          const colorKeywords = {
            'black': ['black', 'negro', 'noir', 'schwarz', 'nero'],
            'brown': ['brown', 'marron', 'braun', 'cafe', 'chocolate'],
            'white': ['white', 'blanco', 'blanc', 'weiss', 'bianco'],
            'red': ['red', 'rojo', 'rouge', 'rot', 'rosso'],
            'blue': ['blue', 'azul', 'bleu', 'blau', 'blu'],
            'green': ['green', 'verde', 'vert', 'grun'],
            'gray': ['gray', 'grey', 'gris', 'grau', 'grigio'],
            'navy': ['navy', 'marine', 'naval'],
            'beige': ['beige', 'tan', 'sand', 'khaki'],
            'burgundy': ['burgundy', 'wine', 'maroon', 'vino']
          };
          
          const keywords = colorKeywords[colorLower] || [colorLower];
          
          thumbnails.forEach(thumb => {
            const img = thumb.querySelector('img');
            if (!img || matchedThumbnail) return;
            
            const imgSrc = img.src.toLowerCase();
            
            // Check if any keyword matches
            for (const keyword of keywords) {
              if (imgSrc.includes(keyword)) {
                matchedThumbnail = thumb;
                break;
              }
            }
          });
          
          if (matchedThumbnail) {
            const imgUrl = matchedThumbnail.querySelector('img').src;
            changeMainImage(imgUrl, matchedThumbnail);
          }
        }
      }

      function updateSizesForColor(color) {
        const sizeGrid = document.getElementById('sizeGrid');
        if (!sizeGrid) return;

        // Get all sizes that have stock for this color
        const availableSizes = Object.keys(stockMap)
          .filter(key => key.endsWith('_' + color))
          .map(key => key.split('_')[0])
          .filter((value, index, self) => self.indexOf(value) === index); // Remove duplicates

        if (availableSizes.length === 0) {
          // If no specific sizes found, show all sizes sorted
          const sortedSizes = sortSizes([...allSizes]);
          sizeGrid.innerHTML = sortedSizes.map(size => 
            `<button class="size-btn" onclick="selectSize('${size}')">${size}</button>`
          ).join('');
        } else {
          // Show only sizes available for this color, sorted
          const sortedAvailableSizes = sortSizes([...availableSizes]);
          sizeGrid.innerHTML = sortedAvailableSizes.map(size => 
            `<button class="size-btn" onclick="selectSize('${size}')">${size}</button>`
          ).join('');
        }
      }

      function selectSize(size) {
        selectedSize = size;
        document.getElementById('selectedSizeName').textContent = size;

        // Remove selected class from all size buttons
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('selected'));
        
        // Add selected class to all buttons with this size text
        document.querySelectorAll('.size-btn').forEach(btn => {
          if (btn.textContent.trim() === size) {
            btn.classList.add('selected');
          }
        });

        updateStockDisplay();
        checkSelection();
      }

      function updateStockDisplay() {
        const stockStatusEl = document.getElementById('stockStatus');
        const stockQuantityEl = document.getElementById('stockQuantity');
        const stockQuantityText = document.getElementById('stockQuantityText');

        // Get current stock based on selected variant
        let currentStock = 0;
        
        // Build key to match the stock_map format from backend: size_color
        const key = `${selectedSize}_${selectedColor}`;
        let stock = stockMap[key];
        
        console.log('[DEBUG updateStock] key:', key, 'stock:', stock);
        console.log('[DEBUG updateStock] stockMap:', stockMap);
        
        // Fallback: try to find stock by any key if not found
        if (stock === undefined) {
          // Try alternate format
          const altKey = `${selectedSize || 'One Size'}_${selectedColor || 'Standard'}`;
          stock = stockMap[altKey];
          console.log('[DEBUG updateStock] Trying altKey:', altKey, 'stock:', stock);
        }
        
        // If still not found, try to get any available stock from map
        if (stock === undefined) {
          stock = Object.values(stockMap)[0];
          console.log('[DEBUG updateStock] Using first value from stockMap:', stock);
        }
        
        currentStock = parseInt(stock) || 0;
        console.log('[DEBUG updateStock] Final currentStock:', currentStock);

        // Display stock information
        if (currentStock > 0 && currentStock <= 5) {
          stockStatusEl.style.display = 'flex';
          stockQuantityEl.style.display = 'block';
          stockQuantityText.textContent = `Only ${currentStock} left in stock`;
          stockStatusEl.style.background = '#fee2e2';
          stockStatusEl.style.borderColor = '#fecaca';
          stockStatusEl.style.color = '#dc2626';
          stockStatusEl.innerHTML = '<span style="color:#dc2626;">⚠️ Low Stock</span>';
        } else {
          stockStatusEl.style.display = 'none';
          stockQuantityEl.style.display = 'none';
        }
      }

      function checkSelection() {
        const btn = document.getElementById('addToCartBtn');

        const needsColor = hasColors;
        const needsSize = hasSizes;

        const colorOk = !needsColor || selectedColor;
        const sizeOk = !needsSize || selectedSize;

        if (colorOk && sizeOk) {
          btn.disabled = false;
          btn.textContent = 'Add to Cart';
          btn.style.opacity = '1';
          btn.style.cursor = 'pointer';
        } else {
          btn.disabled = true;
          const missing = [];
          if (!sizeOk) missing.push(isGrooming ? 'Volume' : 'Size');
          if (!colorOk) missing.push('Color');
          btn.textContent = missing.length > 0 ? `Select ${missing.join(' and ')}` : 'Add to Cart';
          btn.style.opacity = '0.4';
          btn.style.cursor = 'not-allowed';
        }
      }

      function increaseQuantity() {
        const input = document.getElementById('quantity');
        if (input) {
          const currentValue = parseInt(input.value) || 1;
          const newValue = currentValue + 1;
          
          // Check stock if variations are selected
          if ((hasColors && selectedColor) || (hasSizes && selectedSize)) {
            const key = `${selectedSize}_${selectedColor}`;
            const stock = stockMap[key] || 0;
            
            if (newValue > stock) {
              showStockWarning(stock);
              return;
            } else {
              hideStockWarning();
            }
          }
          
          input.value = newValue;
          console.log('[QUANTITY] Increased to:', input.value);
        }
      }

      function decreaseQuantity() {
        const input = document.getElementById('quantity');
        if (input) {
          const currentValue = parseInt(input.value) || 1;
          if (currentValue > 1) {
            input.value = currentValue - 1;
            hideStockWarning();
            console.log('[QUANTITY] Decreased to:', input.value);
          } else {
            console.log('[QUANTITY] Cannot go below 1');
          }
        }
      }

      function showStockWarning(availableStock) {
        const warning = document.getElementById('stockWarning');
        const warningText = document.getElementById('stockWarningText');
        if (warning && warningText) {
          warningText.textContent = `Only ${availableStock} ${availableStock === 1 ? 'item' : 'items'} available in stock for the selected variant.`;
          warning.style.display = 'block';
        }
      }

      function hideStockWarning() {
        const warning = document.getElementById('stockWarning');
        if (warning) {
          warning.style.display = 'none';
        }
      }


      const isUserLoggedIn = {{ 'true' if session.get('logged_in') else 'false' }};


      async function getVariantId(productId, color, size) {
        try {
          console.log(`Getting variant ID for product ${productId}, color: ${color}, size: ${size}`);
          const response = await fetch(`/api/product/${productId}/variants`);
          const data = await response.json();

          console.log('Available variants:', data);

          if (data.success && data.variants) {
            console.log('Searching for variant with color:', color, 'and size:', size);
            const variant = data.variants.find(v => v.color === color && v.size === size);

            if (variant) {
              console.log('Found variant:', variant);
              return variant.id;
            } else {
              console.warn('No matching variant found!');
              console.log('Available variants:', data.variants);
              return null;
            }
          }
          return null;
        } catch (error) {
          console.error('Error getting variant ID:', error);
          return null;
        }
      }

      async function addToCartFromPage() {

        if (!isUserLoggedIn) {
          alert('You need to log in to add items to cart');
          window.location.href = '/login';
          return;
        }

        // Check if color is required and selected
        if (hasColors && !selectedColor) {
          const snackbar = document.getElementById('snackbar');
          if(snackbar) {
            snackbar.textContent = 'Please select a color';
            snackbar.classList.add('show', 'error');
            setTimeout(() => snackbar.classList.remove('show', 'error'), 3000);
          }
          return;
        }

        // Check if size is required and selected
        if (hasSizes && !selectedSize) {
          const snackbar = document.getElementById('snackbar');
          if(snackbar) {
            snackbar.textContent = `Please select ${isGroomingProduct ? 'volume' : 'size'}`;
            snackbar.classList.add('show', 'error');
            setTimeout(() => snackbar.classList.remove('show', 'error'), 3000);
          }
          return;
        }

        const quantity = parseInt(document.getElementById('quantity').value);
        const productId = {{ product.id }};
        const productName = '{{ product.name }}';
        const addButton = document.querySelector('.add-to-cart-btn');

        // Check stock availability
        // Build key to match the stock_map format from backend: size_color
        const key = `${selectedSize}_${selectedColor}`;
        let stock = stockMap[key];
        
        console.log('[DEBUG addToCart] stockMap:', stockMap);
        console.log('[DEBUG addToCart] selectedSize:', selectedSize, 'selectedColor:', selectedColor);
        console.log('[DEBUG addToCart] key:', key, 'stock:', stock);
        
        // Fallback: try alternate key format if not found
        if (stock === undefined) {
          // Try the format used for products without variants
          const altKey = `${selectedSize || 'One Size'}_${selectedColor || 'Standard'}`;
          stock = stockMap[altKey] || 0;
          console.log('[DEBUG addToCart] Trying altKey:', altKey, 'stock:', stock);
        }
        
        // If still not found, try to get any available stock from map
        if (stock === undefined || stock === null) {
          stock = Object.values(stockMap)[0] || 0;
          console.log('[DEBUG addToCart] Using first value from stockMap:', stock);
        }
        
        stock = parseInt(stock) || 0;
        console.log('[DEBUG addToCart] Final stock:', stock);
        
        if (stock === 0) {
          const snackbar = document.getElementById('snackbar');
          if(snackbar) {
            snackbar.textContent = 'This item is currently out of stock';
            snackbar.classList.add('show', 'error');
            setTimeout(() => snackbar.classList.remove('show', 'error'), 3000);
          }
          return;
        }
        
        if (quantity > stock) {
          const snackbar = document.getElementById('snackbar');
          if(snackbar) {
            snackbar.textContent = `Only ${stock} ${stock === 1 ? 'item' : 'items'} available in stock`;
            snackbar.classList.add('show', 'error');
            setTimeout(() => snackbar.classList.remove('show', 'error'), 3000);
          }
          showStockWarning(stock);
          return;
        }

        if(addButton) {
          addButton.disabled = true;
          addButton.textContent = 'Adding to cart...';
        }


        if (window.VaronCart) {

          let variantId = null;

          if (hasSizes || hasColors) {
            console.log('Getting variant for:', {
              productId,
              color: selectedColor || 'Standard',
              size: selectedSize || 'One Size',
              isGrooming: isGroomingProduct
            });

            variantId = await getVariantId(
              productId,
              selectedColor || 'Standard',
              selectedSize || 'One Size'
            );

            console.log('Retrieved variant ID:', variantId);
          }

          console.log('Adding to cart with:', {
            productId,
            quantity,
            variantId,
            selectedColor: selectedColor || 'Standard',
            selectedSize: selectedSize || 'One Size'
          });

          const success = await VaronCart.add(
            productId,
            quantity,
            variantId,
            selectedColor || 'Standard',
            selectedSize || 'One Size'
          );


          if(addButton) {
            addButton.disabled = false;
            addButton.textContent = 'Add to Cart';
          }
          // If added successfully, update badge but stay on product page
          if (success) {
            try { await VaronCart.updateBadge(); } catch(e) {}
          }
        } else {

          const snackbar = document.getElementById('snackbar');
          if(snackbar) {
            snackbar.textContent = 'Cart system not loaded. Please refresh the page.';
            snackbar.classList.add('show', 'error');
            setTimeout(() => snackbar.classList.remove('show', 'error'), 3000);
          }

          if(addButton) {
            addButton.disabled = false;
            addButton.textContent = 'Add to Cart';
          }
        }
      }


      checkSelection();


      function confirmLogout(event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const modal = document.getElementById('logoutModal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }

      function closeLogoutModal() {
        const modal = document.getElementById('logoutModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }


      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        if (dropdown) dropdown.classList.toggle('show');
      }


      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button') && !e.target.closest('.dropdown-content')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });


      function openCartModal() {
          const modal = document.getElementById('cartModal');
          if (modal) {
              modal.style.display = 'flex';
              modal.setAttribute('aria-hidden', 'false');
          }
      }

      function closeModal(modalId) {
          const modal = document.getElementById(modalId);
          if (modal) {
              modal.style.display = 'none';
              modal.setAttribute('aria-hidden', 'true');
          }
      }


      async function renderCartItems() {
          if (!window.VaronCart) {
              console.error('VaronCart not loaded');
              return;
          }

          const cartList = document.getElementById('cartList');
          const items = await VaronCart.get();

          if (!items || items.length === 0) {

              cartList.innerHTML = `
                  <div class="empty-cart-state" style="text-align:center;padding:60px 20px">
                      <div style="font-size:80px;color:#ddd;margin-bottom:16px">
                          <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:inline-block">
                              <path d="M9 2L7.17 4H3c-.55 0-1 .45-1 1s.45 1 1 1h1l1.6 8.6c.18 1 1.05 1.73 2.06 1.73h7.72c1.01 0 1.88-.73 2.06-1.73L19 6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4.17L14 2H9z"/>
                              <circle cx="9" cy="20" r="1"/>
                              <circle cx="16" cy="20" r="1"/>
                          </svg>
                      </div>
                      <h3 style="font-size:18px;font-weight:400;color:#999;margin:0 0 8px">Your cart is empty</h3>
                      <p style="font-size:14px;color:#bbb;margin:0">Add some products to get started!</p>
                  </div>
              `;
              updateCartTotals(0);
              return;
          }


          let html = '';
          items.forEach(item => {
              const imageUrl = item.image_url || 'https://images.unsplash.com/photo-1495121605193-b116b5b09f06?q=80&w=200&auto=format&fit=crop';
              const itemTotal = (parseFloat(item.price) * parseInt(item.quantity)).toFixed(2);
              const sizeColor = [];
              if (item.size) sizeColor.push(`Size: ${item.size}`);
              if (item.color) sizeColor.push(`Color: ${item.color}`);
              const variant = sizeColor.length > 0 ? sizeColor.join(', ') : '';

              html += `
                  <div class="cart-item" style="display:flex;gap:16px;padding:16px;border-bottom:1px solid #f0f0f0;align-items:center">
                      <img src="${imageUrl}" alt="${item.name}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;flex-shrink:0">
                      <div style="flex:1;min-width:0">
                          <h4 style="margin:0 0 4px;font-size:15px;font-weight:500;color:#0a0a0a">${item.name}</h4>
                          ${variant ? `<p style="margin:0 0 8px;font-size:13px;color:#666">${variant}</p>` : ''}
                          <div style="display:flex;align-items:center;gap:12px">
                              <div style="display:flex;align-items:center;border:1px solid #e0e0e0;border-radius:6px;overflow:hidden">
                                  <button onclick="updateCartQuantity(${item.cart_id}, ${item.quantity - 1})" style="padding:6px 12px;background:#fff;border:none;cursor:pointer;font-size:18px;color:#666;transition:background 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">−</button>
                                  <span style="padding:6px 16px;font-size:14px;font-weight:500;min-width:40px;text-align:center">${item.quantity}</span>
                                  <button onclick="updateCartQuantity(${item.cart_id}, ${item.quantity + 1})" style="padding:6px 12px;background:#fff;border:none;cursor:pointer;font-size:18px;color:#666;transition:background 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">+</button>
                              </div>
                              <button onclick="removeCartItem(${item.cart_id})" style="padding:6px 12px;background:#fff;border:1px solid #e0e0e0;border-radius:6px;cursor:pointer;font-size:13px;color:#ef4444;transition:all 0.2s" onmouseover="this.style.background='#fef2f2';this.style.borderColor='#ef4444'" onmouseout="this.style.background='#fff';this.style.borderColor='#e0e0e0'">Remove</button>
                          </div>
                      </div>
                      <div style="text-align:right;flex-shrink:0">
                          <p style="margin:0;font-size:16px;font-weight:600;color:#0a0a0a">₱${itemTotal}</p>
                      </div>
                  </div>
              `;
          });

          cartList.innerHTML = html;


          const total = items.reduce((sum, item) => sum + (parseFloat(item.price) * parseInt(item.quantity)), 0);
          updateCartTotals(total);
      }


      function updateCartTotals(total) {
          const subtotalEl = document.getElementById('cartSubtotal');
          const totalEl = document.getElementById('cartTotal');

          if (subtotalEl) subtotalEl.textContent = `₱${total.toFixed(2)}`;
          if (totalEl) totalEl.textContent = `₱${total.toFixed(2)}`;
      }


      async function updateCartQuantity(cartId, newQuantity) {
          if (newQuantity < 1) {
              await removeCartItem(cartId);
              return;
          }

          if (window.VaronCart) {
              const success = await VaronCart.update(cartId, newQuantity);
              if (success) {
                  await renderCartItems();
              }
          }
      }


      async function removeCartItem(cartId) {
          if (window.VaronCart) {
              const success = await VaronCart.remove(cartId);
              if (success) {
                  VaronCart.showMessage('Item removed from cart', 'success');
                  await renderCartItems();
              }
          }
      }


      async function clearEntireCart() {
          if (!window.VaronCart) return;

          const items = await VaronCart.get();
          if (!items || items.length === 0) {
              VaronCart.showMessage('Cart is already empty', 'error');
              return;
          }

          if (confirm('Are you sure you want to clear your cart? This will remove all items.')) {
              const success = await VaronCart.clear();
              if (success) {
                  VaronCart.showMessage('Cart cleared successfully', 'success');
                  await renderCartItems();
              }
          }
      }


      function proceedToCheckout() {
          window.location.href = '/checkout';
      }



      let cart = JSON.parse(localStorage.getItem('cart')) || [];

      function updateCartDisplay() {
          const cartCount = document.getElementById('cartCount');
          const cartList = document.getElementById('cartList');
          const cartTotal = document.getElementById('cartTotal');
          const cartSubtotal = document.getElementById('cartSubtotal');


          const itemCount = cart.reduce((sum, item) => sum + item.quantity, 0);
          if (cartCount) cartCount.textContent = itemCount;


          if (cartList) {
              if (cart.length === 0) {
                  cartList.innerHTML = `
                      <div style="text-align:center;padding:60px 20px;color:#999">
                          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:16px;opacity:0.3">
                              <circle cx="9" cy="21" r="1"></circle>
                              <circle cx="20" cy="21" r="1"></circle>
                              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                          </svg>
                          <p style="margin:0;font-size:18px;font-weight:500">Your cart is empty</p>
                          <p style="margin:8px 0 0;font-size:14px">Add some products to get started!</p>
                      </div>
                  `;
              } else {
                  cartList.innerHTML = cart.map((item, index) => {
                      const imageUrl = item.image_url || 'https://images.unsplash.com/photo-1495121605193-b116b5b09f06?q=80&w=200&auto=format&fit=crop';
                      return `
                      <div class="cart-item">
                          <div class="cart-item-content">
                              <div class="cart-item-left">
                                  <div class="cart-title">${item.name}</div>
                                  <div class="cart-price muted">₱${parseFloat(item.price).toFixed(2)}</div>
                                  <div class="qty" style="margin-top:8px">Qty: <button onclick="decreaseCartQuantity(${index})">−</button> <span class="q">${item.quantity}</span> <button onclick="increaseCartQuantity(${index})">+</button></div>
                              </div>
                              <div class="cart-item-right">
                                  <img src="${imageUrl}" alt="${item.name}" class="cart-item-image" />
                              </div>
                          </div>
                          <div class="cart-item-actions">
                              <button onclick="removeFromCart(${index})" class="remove-btn">Remove</button>
                          </div>
                      </div>
                  `;
                  }).join('');
              }
          }


          const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          if (cartTotal) cartTotal.textContent = `₱${total.toFixed(2)}`;
          if (cartSubtotal) cartSubtotal.textContent = `₱${total.toFixed(2)}`;
      }

      function addToCart(name, price, id, image_url) {

          const existingItemIndex = cart.findIndex(item => item.id === id && item.name === name);

          if (existingItemIndex > -1) {

              cart[existingItemIndex].quantity += 1;
              showSnackbar('Item quantity updated');
          } else {

              cart.push({ name, price, id, quantity: 1, image_url: image_url || 'https://images.unsplash.com/photo-1495121605193-b116b5b09f06?q=80&w=200&auto=format&fit=crop' });
              showSnackbar('Added to cart');
          }

          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartDisplay();
      }

      function increaseCartQuantity(index) {
          if (cart[index]) {
              cart[index].quantity += 1;
              localStorage.setItem('cart', JSON.stringify(cart));
              updateCartDisplay();
          }
      }

      function decreaseCartQuantity(index) {
          if (cart[index]) {
              if (cart[index].quantity > 1) {
                  cart[index].quantity -= 1;
                  localStorage.setItem('cart', JSON.stringify(cart));
                  updateCartDisplay();
              } else {
                  removeFromCart(index);
              }
          }
      }

      function removeFromCart(index) {
          cart.splice(index, 1);
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartDisplay();
          showSnackbar('Item removed from cart');
      }

      function clearCart() {
          if (cart.length === 0) {
              showSnackbar('Cart is already empty');
              return;
          }

          if (confirm('Are you sure you want to clear your cart?')) {
              cart = [];
              localStorage.setItem('cart', JSON.stringify(cart));
              updateCartDisplay();
              showSnackbar('Cart cleared');
          }
      }

      function showSnackbar(message) {
          const snackbar = document.getElementById('snackbar');
          if (snackbar) {
              snackbar.textContent = message;
              snackbar.classList.add('show');
              setTimeout(() => {
                  snackbar.classList.remove('show');
              }, 3000);
          }
      }


      updateCartDisplay();


      const checkoutBtn = document.getElementById('checkoutBtn');
      if (checkoutBtn) {
          checkoutBtn.addEventListener('click', function() {
              if (cart.length === 0) {
                  showSnackbar('Your cart is empty');
                  return;
              }


              window.location.href = '/checkout';
          });
      }



      const productId = {{ product.id }};


      document.addEventListener('DOMContentLoaded', async () => {
        await loadProductReviews();
        {% if session.get('logged_in') and session.get('role') == 'buyer' %}
        await checkIfCanReview();
        {% endif %}
      });

      let allReviews = [];
      let reviewsDisplayed = 5;

      async function loadProductReviews() {
        try {
          const response = await fetch(`/api/product-reviews/${productId}`);
          const data = await response.json();

          if (data.success && data.reviews.length > 0) {
            // Sort reviews by date (latest first)
            allReviews = data.reviews.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            // Calculate average rating
            const avgRating = (allReviews.reduce((sum, r) => sum + r.rating, 0) / allReviews.length).toFixed(1);
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('reviewCount').textContent = `${allReviews.length} review${allReviews.length !== 1 ? 's' : ''}`;

            // Draw stars
            drawStars('ratingStars', avgRating);

            // Display reviews
            renderReviews();
          } else {
            document.getElementById('reviewsList').innerHTML = `
              <div class="no-reviews">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
                </svg>
                <h3>No reviews yet</h3>
                <p>Be the first to review this product!</p>
              </div>
            `;
            document.getElementById('avgRating').textContent = '0.0';
            document.getElementById('reviewCount').textContent = '0 reviews';
          }
        } catch (error) {
          console.error('Error loading reviews:', error);
          document.getElementById('reviewsList').innerHTML = '<div class="no-reviews">Error loading reviews. Please try again later.</div>';
        }
      }

      function renderReviews() {
        const reviewsList = document.getElementById('reviewsList');
        
        if (allReviews.length === 0) {
          return;
        }

        let html = '<div class="reviews-container">';

        // Display first batch of reviews
        for (let i = 0; i < allReviews.length; i++) {
          const review = allReviews[i];
          const isHidden = i >= reviewsDisplayed;
          const hiddenClass = isHidden ? 'hidden-review' : '';
          const reviewDate = new Date(review.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
          });

          html += `
            <div class="review-card ${hiddenClass}" data-review-index="${i}">
              <div class="review-header">
                <div class="review-author">
                  <div class="author-name">${review.first_name} ${review.last_name}</div>
                  <div class="review-rating-badge">
                    ${'⭐'.repeat(review.rating)}
                    <span>${review.rating}.0</span>
                  </div>
                  <div class="review-date">📅 ${reviewDate}</div>
                  ${review.is_verified_purchase ? '<div class="verified-badge" style="margin-top: 8px;"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg> Verified Purchase</div>' : ''}
                </div>
              </div>
              ${review.title ? `<h4 class="review-title" style="margin-top: 12px;">${escapeHtml(review.title)}</h4>` : ''}
              <p class="review-comment">${escapeHtml(review.comment)}</p>
            </div>
          `;
        }

        html += '</div>';

        // Add "See More" button if there are more reviews
        if (allReviews.length > reviewsDisplayed) {
          html += `
            <div class="reviews-pagination">
              <button class="see-more-btn" onclick="loadMoreReviews()">See More Reviews (${allReviews.length - reviewsDisplayed} more)</button>
            </div>
            <div class="reviews-count-info">
              Showing ${Math.min(reviewsDisplayed, allReviews.length)} of ${allReviews.length} reviews
            </div>
          `;
        } else if (allReviews.length > 0) {
          html += `
            <div class="reviews-count-info">
              Showing all ${allReviews.length} review${allReviews.length !== 1 ? 's' : ''}
            </div>
          `;
        }

        reviewsList.innerHTML = html;
      }

      function loadMoreReviews() {
        // Load 5 more reviews
        reviewsDisplayed += 5;
        renderReviews();
      }

      function drawStars(elementId, rating) {
        const container = document.getElementById(elementId);
        if (!container) return;

        const fullStars = Math.floor(rating);
        const hasHalfStar = rating % 1 !== 0;
        let html = '';

        for (let i = 0; i < 5; i++) {
          if (i < fullStars) {
            html += '<span class="star filled">⭐</span>';
          } else if (i === fullStars && hasHalfStar) {
            html += '<span class="star filled">⭐</span>';
          } else {
            html += '<span class="star empty">☆</span>';
          }
        }
        container.innerHTML = html;
      }

      function escapeHtml(text) {
        const map = {
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      async function checkIfCanReview() {
        try {
          const response = await fetch(`/api/check-can-review/${productId}`);
          const data = await response.json();

          const reviewBtn = document.getElementById('reviewBtn');
          if (reviewBtn) {
            if (data.success && data.can_review) {
              reviewBtn.disabled = false;
              reviewBtn.textContent = 'Write a Review';
              window.canReviewProductId = productId;
              window.orderIdForReview = data.order_id;
            } else if (data.already_reviewed) {
              reviewBtn.disabled = true;
              reviewBtn.textContent = 'Already Reviewed';
            } else {
              reviewBtn.disabled = true;
              reviewBtn.textContent = 'No Eligible Orders';
            }
          }
        } catch (error) {
          console.error('Error checking review eligibility:', error);
        }
      }

      function openReviewForm() {
        if (!window.orderIdForReview) {
          alert('You need to complete an order for this product to leave a review.');
          return;
        }
        document.getElementById('reviewModal').classList.add('show');
      }

      function closeReviewForm() {
        document.getElementById('reviewModal').classList.remove('show');
        document.getElementById('reviewForm').reset();
        document.getElementById('formMessage').style.display = 'none';
        clearErrors();
      }

      function clearErrors() {
        document.getElementById('ratingError').textContent = '';
        document.getElementById('titleError').textContent = '';
        document.getElementById('commentError').textContent = '';
      }

      async function submitReview(event) {
        event.preventDefault();
        clearErrors();

        const rating = document.querySelector('input[name="rating"]:checked')?.value;
        const title = document.getElementById('reviewTitle').value.trim();
        const comment = document.getElementById('reviewComment').value.trim();


        if (!rating) {
          document.getElementById('ratingError').textContent = 'Please select a rating';
          return;
        }

        if (!comment) {
          document.getElementById('commentError').textContent = 'Please write a review comment';
          return;
        }

        if (comment.length < 10) {
          document.getElementById('commentError').textContent = 'Review must be at least 10 characters';
          return;
        }

        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';

        try {
          const response = await fetch('/api/submit-review', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              product_id: productId,
              order_id: window.orderIdForReview,
              rating: parseInt(rating),
              title: title,
              comment: comment
            })
          });

          const data = await response.json();

          if (data.success) {
            const formMessage = document.getElementById('formMessage');
            formMessage.textContent = 'Review submitted successfully! Thank you for your feedback.';
            formMessage.style.display = 'block';
            formMessage.className = 'success-message';

            setTimeout(() => {
              closeReviewForm();
              loadProductReviews();
              checkIfCanReview();
            }, 2000);
          } else {
            alert('Error: ' + (data.error || 'Failed to submit review'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Review';
          }
        } catch (error) {
          console.error('Error submitting review:', error);
          alert('Error submitting review. Please try again.');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Review';
        }
      }


    </script>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal" aria-hidden="true">
      <div class="cart-card">
        <button onclick="closeModal('cartModal')" class="cart-close-btn" aria-label="Close cart">×</button>
        <h2 style="text-align:left;margin-bottom:20px">Your Cart</h2>
        <div id="cartList" class="cart-list">
          <!-- Empty cart state -->
          <div class="empty-cart-state" style="text-align:center;padding:60px 20px">
            <div style="font-size:80px;color:#ddd;margin-bottom:16px">
              <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="display:inline-block">
                <path d="M9 2L7.17 4H3c-.55 0-1 .45-1 1s.45 1 1 1h1l1.6 8.6c.18 1 1.05 1.73 2.06 1.73h7.72c1.01 0 1.88-.73 2.06-1.73L19 6h1c.55 0 1-.45 1-1s-.45-1-1-1h-4.17L14 2H9z"/>
                <circle cx="9" cy="20" r="1"/>
                <circle cx="16" cy="20" r="1"/>
              </svg>
            </div>
            <h3 style="font-size:18px;font-weight:400;color:#999;margin:0 0 8px">Your cart is empty</h3>
            <p style="font-size:14px;color:#bbb;margin:0">Add some products to get started!</p>
          </div>
        </div>
        <div class="cart-totals">
          <div style="padding:24px 0;border-top:1px solid #eee">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <span style="color:#666;font-size:15px">Subtotal:</span>
              <span style="font-size:16px;font-weight:500" id="cartSubtotal">₱0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
              <span style="font-size:18px;font-weight:600;color:#0a0a0a">Total:</span>
              <span style="font-size:20px;font-weight:600;color:#0a0a0a" id="cartTotal">₱0.00</span>
            </div>
          </div>
          <div style="display:flex;gap:12px">
            <button onclick="clearEntireCart()" class="btn-secondary" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;border:1px solid #e0e0e0;background:#fff;color:#0a0a0a;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">CLEAR CART</button>
            <button onclick="proceedToCheckout()" class="btn-cta" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;background:#0a0a0a;color:#fff;border:none;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='#0a0a0a'">PROCEED TO CHECKOUT</button>
            <button onclick="clearCart()" class="btn-secondary" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;border:1px solid #e0e0e0;background:#fff;color:#0a0a0a;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">CLEAR CART</button>
            <button id="checkoutBtn" class="btn-cta" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;background:#0a0a0a;color:#fff;border:none;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='#0a0a0a'">PROCEED TO CHECKOUT</button>
            <button id="clearCart" class="btn-secondary" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;border:1px solid #e0e0e0;background:#fff;color:#0a0a0a;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#f8f8f8'" onmouseout="this.style.background='#fff'">CLEAR CART</button>
            <button id="checkoutBtn" class="btn-cta" style="flex:1;padding:14px;font-size:15px;font-weight:500;border-radius:6px;background:#0a0a0a;color:#fff;border:none;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='#0a0a0a'">PROCEED TO CHECKOUT</button>
          </div>
        </div>
      </div>
    </div>

    <div id="snackbar" class="snackbar" role="status" aria-live="polite">Added to cart</div>

  </body>
</html>
