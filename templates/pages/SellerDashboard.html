  <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Seller Dashboard ‚Äî Var√≥n</title>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .app.add-product-mode{grid-template-columns:240px 1fr}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .app.add-product-mode .sidebar{display:flex;background:#f0f9ff;color:#0a0a0a;border-right:1px solid var(--line)}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}
      .order-count-badge{background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:10px;font-weight:600;min-width:18px;text-align:center;margin-left:auto}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .app.add-product-mode .main{max-width:1000px;margin:0 auto;padding:24px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:#10b981;margin-left:8px}

      /* Chart placeholders */
      .grid.two{grid-template-columns:1.4fr 1fr}
      .chart{height:260px;padding:12px 14px}
      .bars{display:flex;align-items:flex-end;gap:10px;height:160px;margin-top:8px}
      .bar{flex:1;background:#0a0a0a;border-radius:6px}
      .legend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Product Management */
      .action-btn {
        background: #0a0a0a;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
      }
      .action-btn:hover {
        background: #2d2d2d;
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .status-active {
        background: #dcfce7;
        color: #15803d;
      }
      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }
      .status-inactive {
        background: #fee2e2;
        color: #991b1b;
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(-20px);
        }
      }

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
      
      /* Add Product Sidebar Styles */
      .app.add-product-mode .sidebar {
        overflow-y: auto;
        padding: 18px 14px;
        gap: 8px;
        background: #0a0a0a;
        color: #fff;
      }
      
      .app.add-product-mode .sidebar .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 8px 14px 8px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        margin-bottom: 10px;
      }
      
      .app.add-product-mode .sidebar .logo .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #4ade80;
      }
      
      .app.add-product-mode .sidebar .side-group {
        margin-top: 8px;
        display: block;
      }
      
      .app.add-product-mode .sidebar .side-title {
        font-size: 12px;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: #bdbdbd;
        margin: 10px 8px 6px;
      }
      
      .app.add-product-mode .sidebar .side-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 8px;
        color: #eaeaea;
        cursor: pointer;
      }
      
      .app.add-product-mode .sidebar .side-link:hover,
      .app.add-product-mode .sidebar .side-link.active {
        background: #141414;
        color: #fff;
      }
      
      .add-product-sidebar-content {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Seller Dashboard</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Store Management</div>
          <a class="side-link active" href="#" data-page="overview">Overview</a>
          <a class="side-link" href="#" data-page="products">Products</a>
          <a class="side-link" href="#" data-page="add-product" style="padding-left: 24px; font-size: 14px;">+ Add Product</a>
          <a class="side-link" href="#" data-page="archived-products">Archived Products</a>
          <a class="side-link" href="#" data-page="orders" id="orders-link">
            Orders
            <span class="order-count-badge" id="order-count-badge" style="display:none;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:10px;margin-left:auto;">0</span>
          </a>
          <a class="side-link" href="#" data-page="inventory">Inventory</a>
          <a class="side-link" href="#" data-page="reviews">Customer Reviews</a>
          <a class="side-link" href="#" data-page="promotions">Promotions</a>
        </div>
        <div class="side-group">
          <div class="side-title">Analytics</div>
          <a class="side-link" href="#" data-page="sales">Sales Analytics</a>
          <a class="side-link" href="#" data-page="performance">Performance</a>
        </div>
        <div class="side-group">
          <div class="side-title">Settings</div>
          <a class="side-link" href="#" data-page="store-settings">Brand Settings</a>
          <a class="side-link" href="#" data-page="account">Account</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Store Dashboard</div>
          <div class="search"><input placeholder="Search products, orders..."/></div>
          <div class="avatar">
            <span class="tag store-name">Brand: {{ seller.store_name if seller else 'Your Brand' }}</span>
            <span class="tag" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üó∫Ô∏è 
              {% if seller and seller.island_group %}
                {{ seller.island_group }}
              {% else %}
                Not Set
              {% endif %}
            </span>
            <span class="tag status-badge {% if seller and seller.status == 'approved' %}status-active{% else %}status-pending{% endif %}">
              {{ seller.status.title() if seller else 'Pending' }}
            </span>
            <a href="#" onclick="confirmLogout(event); return false;" style="margin-left: 10px; padding: 8px 16px; background: #ef4444; color: #fff; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 500;">Logout</a>
          </div>
        </div>

        <main class="main" id="dashboardContent">
          <!-- Stat cards -->
          <div class="grid stats">
            <div class="card">
              <div class="inner">
                <div class="metric">Today's Sales</div>
                <div class="value">‚Ç±{{ "{:,.2f}".format(today_sales if today_sales else 0) }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Pending Orders</div>
                <div class="value">{{ pending_orders if pending_orders else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Products</div>
                <div class="value">{{ product_count if product_count else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Rating</div>
                <div class="value">{{ "{:.1f}".format(seller.rating if seller and seller.rating else 0) }}</div>
              </div>
            </div>
          </div>

          <!-- Charts row -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div class="metric">Weekly Sales Overview</div>
                <div class="chart">
                  <div class="bars">
                    {% for day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                    {% set bar_height = ((weekly_sales[day] / max_weekly_sales) * 100)|int if weekly_sales[day] > 0 else 5 %}
                    <div class="bar" style="height:{{ bar_height }}%"></div>
                    {% endfor %}
                  </div>
                  <div class="legend">
                    <span>Sun</span>
                    <span>Mon</span>
                    <span>Tue</span>
                    <span>Wed</span>
                    <span>Thu</span>
                    <span>Fri</span>
                    <span>Sat</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div class="metric">Top Performing Products</div>
                  <button class="action-btn" onclick="loadPage('add-product')" style="padding: 6px 12px; font-size: 12px;">+ Add Product</button>
                </div>
                <div style="margin-top:10px" id="topProducts">
                  {% if top_products and top_products|length > 0 %}
                    {% set max_sales = (top_products[0].sales_count if (top_products and top_products[0].sales_count) else 1) %}
                    {% for product in top_products[:3] %}
                      {% if not loop.first %}
                      <div style="height:16px"></div>
                      {% endif %}
                      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                        <div>{{ product.name }}</div>
                        <div class="tag" style="background:#efefef;color:#0a0a0a">{{ product.sales_count or 0 }} sold</div>
                      </div>
                      <div style="height:6px;background:#efefef;border-radius:999px;overflow:hidden">
                        {% set progress_width = ((product.sales_count / max_sales if max_sales > 0 else 0) * 100)|int %}
                        <div style="height:6px;background:#0a0a0a;border-radius:999px;width:{{ progress_width }}%;"></div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p style="text-align:center;color:#999;padding:20px;">No sales data yet. <a href="#" onclick="loadPage('add-product')" style="color:#0a0a0a;text-decoration:underline;">Add your first product</a></p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Orders and Low Stock -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Orders</div>
                  <a href="#" class="action-btn" onclick="loadPage('orders'); return false;">Process Orders</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_orders %}
                        {% for order in recent_orders %}
                        <tr>
                          <td>{{ order.order_number }}</td>
                          <td>{{ order.first_name }} {{ order.last_name }}</td>
                          <td>{% if order.products %}{{ order.products[:30] }}...{% else %}-{% endif %}</td>
                          <td>‚Ç±{{ "{:,.2f}".format(order.total_amount) }}</td>
                          <td><span class="status-badge status-{{ 'active' if order.order_status == 'delivered' else 'pending' }}">{{ order.order_status.title() }}</span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent orders</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Low Stock Alert</div>
                  <a href="#" class="action-btn">Restock Now</a>
                </div>
                <div style="margin-top:10px">
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Stock</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if low_stock %}
                        {% for product in low_stock %}
                        <tr>
                          <td>{{ product.name }}</td>
                          <td>{{ product.stock_quantity }} pcs</td>
                          <td><span class="status-badge {% if product.stock_quantity <= 3 %}status-inactive{% else %}status-pending{% endif %}">
                            {% if product.stock_quantity <= 3 %}Critical{% else %}Low{% endif %}
                          </span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="3" style="text-align:center;color:#999">All products in stock</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
      </section>
    </div>
    <script>
      // Page content templates
      const pageTemplates = {
        'add-product': `
          <div class="card">
            <div class="inner" style="max-width: 800px; margin: 0 auto;">
              <h2 style="margin: 0 0 20px;">Add New Product</h2>
              <form id="addProductForm" action="/seller/add-product" method="POST" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Product Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Enter product name">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Description</label>
                  <textarea name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Product description"></textarea>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Category/Genre *</label>
                  <select id="categorySelect" name="category_id" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" onchange="toggleSizeColorSections()">
                    <option value="">Select a category</option>
                    <!-- Categories will be loaded by JavaScript -->
                  </select>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Product Images *</label>
                  <input type="file" id="productImages" name="product_images" accept="image/*" multiple required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                  <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Upload multiple product images (JPG, PNG, max 5MB each). First image will be the primary image.</small>
                  
                  <!-- Image Preview Area -->
                  <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 12px;">
                    <!-- Previews will be inserted here -->
                  </div>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Price (‚Ç±) *</label>
                  <input type="number" name="price" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="0.00">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">SKU</label>
                  <input type="text" name="sku" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Product SKU (optional)">
                  <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Stock Keeping Unit for inventory tracking (auto-generated if left empty)</small>
                </div>
                
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa;" id="sizesSection">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Available Sizes per Color *</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Select a color tab above, then choose sizes for that specific color</small>
                  
                  <!-- Per-Color Sizes Container -->
                  <div id="perColorSizesContainer" style="display: none;">
                    <!-- Clothing Sizes (default) -->
                    <div id="clothingSizes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px;">
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="XS" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>XS</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="S" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>S</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="M" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>M</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="L" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>L</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="XL" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>XL</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="2XL" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>2XL</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="3XL" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>3XL</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="4XL" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>4XL</span>
                      </label>
                    </div>
                    
                    <!-- Shoe Sizes (hidden by default) - US Sizes -->
                    <div id="shoeSizes" style="display: none; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px;">
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="5" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>5</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="6" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>6</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="7" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>7</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="8" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>8</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="9" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>9</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="10" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>10</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="11" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>11</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="12" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>12</span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" class="color-size-checkbox" value="13" style="margin-right: 6px;" onchange="updateStockInputs()">
                        <span>13</span>
                      </label>
                    </div>
                    
                    <div style="margin-top: 12px;">
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Add Custom Size(s) for <span id="current-color-size-label" style="font-weight: 600; color: #3b82f6;">this color</span></label>
                      <input type="text" id="custom-sizes-per-color" placeholder="e.g. 4XL, 5XL, 36, 37, 38 (comma-separated)" 
                        style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px;" 
                        oninput="updateStockInputs()" 
                        onchange="updateStockInputs()" 
                        onblur="updateStockInputs()">
                      <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Custom sizes for this color only</small>
                    </div>
                  </div>
                  
                  <!-- Placeholder when no color selected -->
                  <p id="sizesPlaceholder" style="color: var(--muted); font-style: italic; margin: 20px 0;">üëâ Select a color tab above to add sizes for that color</p>
                </div>
                
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa;" id="colorsSection">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Available Colors *</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Click a color to select it and set its sizes below</small>
                  
                  <!-- Color Tab Buttons -->
                  <div id="colorTabs" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 16px;">
                    <!-- Tab buttons will be generated by JavaScript -->
                  </div>
                  
                  <!-- Predefined Colors (with visual color swatches) -->
                  <div id="predefinedColors" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Black" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #000000; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Black</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="White" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #FFFFFF; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>White</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Gray" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #808080; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Gray</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Navy" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #000080; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Navy</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Blue" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #0000FF; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Blue</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Red" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #FF0000; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Red</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Green" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #008000; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Green</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Brown" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #8B4513; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Brown</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Beige" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #F5F5DC; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Beige</span>
                      </span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; gap: 8px;">
                      <input type="checkbox" name="colors" value="Khaki" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <span style="width: 20px; height: 20px; background: #F0E68C; border: 1px solid #ccc; border-radius: 4px;"></span>
                        <span>Khaki</span>
                      </span>
                    </label>
                  </div>
                  
                  <div style="margin-top: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Add Custom Color(s)</label>
                    <input type="text" id="custom-colors" placeholder="e.g. Burgundy, Olive, Charcoal (comma-separated)" 
                      style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px;" 
                      oninput="updateColorTabs()" 
                      onchange="updateColorTabs()" 
                      onblur="updateColorTabs()">
                    <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">You can type here even without checking boxes above</small>
                  </div>
                </div>
                
                <!-- Hidden input to track selected color for stock table -->
                <input type="hidden" id="selected-color" value="">
                <input type="hidden" id="selected-color-sizes" value=""
                
                <div id="size-color-stocks" style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #f0f9ff;">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Stock per Size in <span id="stock-table-color">Selected Color</span></h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Enter stock quantity for each size in the selected color</small>
                  <div id="stock-inputs" style="display: grid; gap: 8px;">
                    <p style="color: var(--muted); font-style: italic;">üëâ Click on a color tab above to set stock for that color</p>
                  </div>
                </div>
                
                <div id="ingredientsSection" style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa; display: none;">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Ingredients *</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">List all key ingredients in this grooming product</small>
                  <textarea id="ingredients" name="ingredients" rows="5" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; font-family: monospace; font-size: 13px;" placeholder="e.g. Aloe Vera&#10;Vitamin E&#10;Coconut Oil&#10;Tea Tree Extract&#10;Shea Butter"></textarea>
                  <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 6px;">Enter one ingredient per line. Include all active ingredients and major components.</small>
                </div>
                
                <input type="hidden" name="custom-sizes" id="custom-sizes-hidden">
                <input type="hidden" name="custom-colors" id="custom-colors-hidden">
                
                <div style="display: flex; gap: 12px; margin-top: 10px;">
                  <button type="button" class="action-btn" style="padding: 12px 24px;" onclick="confirmAddProduct()">Add Product</button>
                  <button type="button" class="action-btn" onclick="loadPage('products')" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        `,
        
        'products': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">All Products</h2>
                <button class="action-btn" onclick="loadPage('add-product')">+ Add Product</button>
              </div>
              <div id="products-list">Loading products...</div>
            </div>
          </div>
        `,
        
        'edit-product': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Edit Product</h2>
              <div id="edit-product-form">Loading product...</div>
            </div>
          </div>
        `,
        
        'archived-products': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">üóÑÔ∏è Archived Products</h2>
              </div>
              <div id="archived-products-list">Loading archived products...</div>
            </div>
          </div>
        `,
        
        'inventory': `
          <div class="card">
            <div class="inner">
              <div style="margin-bottom: 20px;">
                <h2 style="margin: 0;">üì¶ Inventory Management</h2>
              </div>
              <div id="inventory-list" style="overflow-x: auto;">Loading inventory...</div>
            </div>
          </div>
        `,
        
        'orders': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Order Management</h2>
              
              <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="action-btn" data-filter-btn="all" onclick="filterOrders('all')" style="background: #666; color: #fff; padding: 8px 16px; font-size: 13px;">
                  üìã All Orders
                </button>
                <button class="action-btn" data-filter-btn="pending" onclick="filterOrders('pending')" style="background: #ff9800; color: #fff; padding: 8px 16px; font-size: 13px;">
                  ‚è≥ Pending
                </button>
                <button class="action-btn" data-filter-btn="confirmed" onclick="filterOrders('confirmed')" style="background: #2196f3; color: #fff; padding: 8px 16px; font-size: 13px;">
                  ‚úîÔ∏è Confirmed
                </button>
                <button class="action-btn" data-filter-btn="release_to_rider" onclick="filterOrders('release_to_rider')" style="background: #4caf50; color: #fff; padding: 8px 16px; font-size: 13px;">
                  üöö Release to Rider
                </button>
              </div>
              
              <div id="orders-list" style="overflow-x: auto;">
                <p style="color: #999;">Click a status filter to view orders...</p>
              </div>
            </div>
          </div>
        `,
        
        'reviews': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">‚≠ê Customer Reviews</h2>
                <div style="display: flex; gap: 8px;">
                  <button class="action-btn" onclick="filterReviews('all')" data-review-filter="all" style="background: #666;">All Reviews</button>
                  <button class="action-btn" onclick="filterReviews('pending')" data-review-filter="pending" style="background: #ff9800;">Pending</button>
                </div>
              </div>
              <div id="reviews-list">Loading reviews...</div>
            </div>
          </div>
        `,
        
        'promotions': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">üéØ Promotions</h2>
                <button class="action-btn" onclick="openCreatePromotion()" style="background: #0a0a0a; padding: 8px 16px;">+ Create Promotion</button>
              </div>
              <div id="promotions-list">Loading promotions...</div>
              
              <!-- Create/Edit Promotion Modal -->
              <div id="promotion-modal" style="position: fixed; inset: 0; background: rgba(10,10,10,0.6); display: none; align-items: center; justify-content: center; z-index: 1000;">
                <div style="background: #fff; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--line);">
                    <h3 style="margin: 0; font-size: 18px;">Create Promotion</h3>
                    <button onclick="closePromotionModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">√ó</button>
                  </div>
                  <form id="promotion-form" style="display: flex; flex-direction: column; gap: 16px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Product *</label>
                      <select id="promo-product" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                        <option value="">Select a product</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Discount Type *</label>
                      <select id="promo-discount-type" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" onchange="updateDiscountLabel()">
                        <option value="percentage">Percentage (%)</option>
                        <option value="fixed">Fixed Amount (‚Ç±)</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Discount Value *</label>
                      <input type="number" id="promo-discount-value" min="0" step="0.01" required placeholder="Enter discount value" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Start Date *</label>
                      <input type="datetime-local" id="promo-start-date" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">End Date *</label>
                      <input type="datetime-local" id="promo-end-date" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Description</label>
                      <textarea id="promo-description" rows="3" placeholder="Promotion details..." style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;"></textarea>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--line);">
                      <button type="button" class="action-btn" onclick="closePromotionModal()" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                      <button type="submit" class="action-btn" style="background: #0a0a0a; color: #fff;">Create Promotion</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `,
        
        'sales': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 20px;">üìä Sales Analytics</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Revenue (30 days)</div>
                  <div id="total-revenue" style="font-size: 24px; font-weight: 700; color: #10b981;">‚Ç±0.00</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Orders</div>
                  <div id="total-orders" style="font-size: 24px; font-weight: 700; color: #2196f3;">0</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Average Order Value</div>
                  <div id="avg-order" style="font-size: 24px; font-weight: 700; color: #ff9800;">‚Ç±0.00</div>
                </div>
              </div>
              <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Sales by Product</h3>
                <div id="sales-by-product" style="display: grid; gap: 12px;">
                  <p style="color: var(--muted); text-align: center;">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        `,
        
        'performance': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Performance</h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Average Rating</div>
                  <div id="avg-rating" style="font-size: 24px; font-weight: 700; color: #4caf50;">4.5 ‚≠ê</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Repeat Customers</div>
                  <div id="repeat-customers" style="font-size: 24px; font-weight: 700; color: #9c27b0;">0</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Reviews</div>
                  <div id="total-reviews" style="font-size: 24px; font-weight: 700; color: #ff5722;">0</div>
                </div>
              </div>
              <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Top Rated Products</h3>
                <div id="top-rated-products" style="display: grid; gap: 12px;">
                  <p style="color: var(--muted); text-align: center;">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        `,
        
        'store-settings': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Brand Settings</h2>
              <form id="brand-settings-form" style="max-width: 600px;">
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Brand Name *</label>
                  <input type="text" id="store-name" placeholder="Enter brand name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;" required>
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Brand Description *</label>
                  <textarea id="store-description" placeholder="Tell customers about your brand" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;" required></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contact Email</label>
                  <input type="email" id="contact-email" placeholder="Enter contact email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contact Phone</label>
                  <input type="text" id="contact-phone" placeholder="Enter contact phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Store Address</label>
                  <input type="text" id="store-address" placeholder="Enter store address" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>

                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">üó∫Ô∏è Service Island Location</label>
                  <select id="island-group" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                    <option value="">Select your service island...</option>
                    <option value="Luzon">üèùÔ∏è Luzon</option>
                    <option value="Visayas">üèùÔ∏è Visayas</option>
                    <option value="Mindanao">üèùÔ∏è Mindanao</option>
                  </select>
                  <p style="margin: 8px 0 0; font-size: 12px; color: #666;">Your store will be matched with riders serving this island group</p>
                </div>
                
                <div style="display: flex; gap: 12px;">
                  <button type="submit" class="action-btn" style="background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Settings</button>
                  <button type="button" onclick="reloadBrandSettings()" class="action-btn" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ü≤ Reload</button>
                </div>
              </form>
            </div>
          </div>
        `,
        
        'account': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Account Settings</h2>
              <form id="account-settings-form" style="max-width: 600px;">
                <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                  <p style="margin: 0; color: #666; font-size: 13px;"><strong id="account-username">Loading...</strong></p>
                  <p style="margin: 8px 0 0; color: #999; font-size: 12px;">Account Email: <strong id="account-email">Loading...</strong></p>
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Full Name</label>
                  <input type="text" id="full-name" placeholder="Enter full name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Phone Number</label>
                  <input type="text" id="phone-number" placeholder="Enter phone number" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                </div>
                
                <div style="margin-bottom: 20px;">
                  <label style="display: block; margin-bottom: 8px; font-weight: 500;">Email Address *</label>
                  <div style="display: flex; gap: 8px;">
                    <input type="email" id="email-address" placeholder="Enter email address" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                    <button type="button" id="verify-email-btn" onclick="sendEmailOTP()" class="action-btn" style="background: #3b82f6; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; white-space: nowrap;">Verify Email</button>
                  </div>
                  <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Click "Verify Email" to send OTP verification code</small>
                  <div id="otp-verification-section" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 6px;">
                    <input type="text" id="otp-code" placeholder="Enter 6-digit OTP code" style="width: 100%; padding: 10px; border: 1px solid #bfdbfe; border-radius: 6px; margin-bottom: 8px; box-sizing: border-box;">
                    <button type="button" id="verify-otp-btn" onclick="verifyEmailOTP()" class="action-btn" style="width: 100%; background: #10b981; color: white; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Verify OTP</button>
                  </div>
                  <div id="email-verified-message" style="display: none; margin-top: 12px; padding: 12px; background: #dcfce7; border: 1px solid #86efac; border-radius: 6px; color: #15803d; font-weight: 500;">
                    ‚úì Email verified successfully
                  </div>
                </div>
                
                <div style="display: flex; gap: 12px;">
                  <button type="submit" class="action-btn" style="background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
                  <button type="button" onclick="reloadAccountSettings()" class="action-btn" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ü≤ Reload</button>
                </div>
              </form>
            </div>
          </div>
        `,
        
        'overview': null  // Special case - will reload page
      };

      // Function to toggle size and color sections based on category
      function toggleSizeColorSections() {
        const categorySelect = document.getElementById('categorySelect');
        const sizesSection = document.getElementById('sizesSection');
        const colorsSection = document.getElementById('colorsSection');
        const stockSection = document.getElementById('size-color-stocks');
        const ingredientsSection = document.getElementById('ingredientsSection');
        const ingredientsInput = document.getElementById('ingredients');
        const clothingSizes = document.getElementById('clothingSizes');
        const shoeSizes = document.getElementById('shoeSizes');
        
        if (categorySelect && sizesSection && colorsSection && stockSection) {
          const categoryId = categorySelect.value;
          const selectedOption = categorySelect.options[categorySelect.selectedIndex];
          const categorySlug = selectedOption ? selectedOption.getAttribute('data-slug') || '' : '';
          
          if (!categoryId) {
            // No category selected, hide all sections
            sizesSection.style.display = 'none';
            colorsSection.style.display = 'none';
            stockSection.style.display = 'none';
            if (ingredientsSection) ingredientsSection.style.display = 'none';
            return;
          }
          
          // Check if it's a grooming category (check slug or name)
          const isGrooming = categorySlug && (categorySlug.toLowerCase().includes('grooming') || selectedOption.textContent.toLowerCase().includes('grooming'));
          
          if (isGrooming) {
            // Hide sizes, colors, and stock sections for grooming products
            sizesSection.style.display = 'none';
            colorsSection.style.display = 'none';
            stockSection.style.display = 'none';
            
            // Show ingredients section for grooming products
            if (ingredientsSection) {
              ingredientsSection.style.display = 'block';
              if (ingredientsInput) ingredientsInput.required = true;
            }
            
            // Remove required attribute from checkboxes
            document.querySelectorAll('input[name="sizes"], input[name="colors"]').forEach(input => {
              input.removeAttribute('required');
              input.checked = false; // Uncheck all
            });
          } else if (categorySlug && (categorySlug.toLowerCase().includes('shoe') || categorySlug.toLowerCase().includes('footwear') || selectedOption.textContent.toLowerCase().includes('shoe'))) {
            // Show sizes and colors sections for shoes
            sizesSection.style.display = 'block';
            colorsSection.style.display = 'block';
            stockSection.style.display = 'block';
            
            // Show shoe sizes, hide clothing sizes
            if (clothingSizes) clothingSizes.style.display = 'none';
            if (shoeSizes) shoeSizes.style.display = 'grid';
            
            // Uncheck clothing sizes
            document.querySelectorAll('#clothingSizes input[name="sizes"]').forEach(input => {
              input.checked = false;
            });
            
            // Hide ingredients section
            if (ingredientsSection) {
              ingredientsSection.style.display = 'none';
              if (ingredientsInput) ingredientsInput.required = false;
            }
            
            // Update placeholder for custom sizes
            const customSizesInput = document.getElementById('custom-sizes');
            if (customSizesInput) {
              customSizesInput.placeholder = 'e.g. 5.5, 6.5, 7.5, 14, 15 (comma-separated)';
            }
          } else {
            // Show sections for other categories (clothing)
            sizesSection.style.display = 'block';
            colorsSection.style.display = 'block';
            stockSection.style.display = 'block';
            
            // Show clothing sizes, hide shoe sizes
            if (clothingSizes) clothingSizes.style.display = 'grid';
            if (shoeSizes) shoeSizes.style.display = 'none';
            
            // Uncheck shoe sizes
            document.querySelectorAll('#shoeSizes input[name="sizes"]').forEach(input => {
              input.checked = false;
            });
            
            // Hide ingredients section for non-grooming products
            if (ingredientsSection) {
              ingredientsSection.style.display = 'none';
              if (ingredientsInput) ingredientsInput.required = false;
            }
            
            // Reset placeholder for custom sizes
            const customSizesInput = document.getElementById('custom-sizes');
            if (customSizesInput) {
              customSizesInput.placeholder = 'e.g. 4XL, 5XL, 28W, 32W (comma-separated)';
            }
          }
          
          // Update stock inputs whenever category changes
          updateStockInputs();
        }
      }

      // Function to copy custom values to hidden inputs before form submission
      function submitCustomValues() {
        const customSizes = document.getElementById('custom-sizes');
        const customColors = document.getElementById('custom-colors');
        const customSizesHidden = document.getElementById('custom-sizes-hidden');
        const customColorsHidden = document.getElementById('custom-colors-hidden');
        
        if (customSizes && customSizesHidden) {
          customSizesHidden.value = customSizes.value;
          console.log('Custom sizes copied:', customSizes.value);
        }
        if (customColors && customColorsHidden) {
          customColorsHidden.value = customColors.value;
          console.log('Custom colors copied:', customColors.value);
        }
        
        return true;
      }
      
      // Function to confirm product addition
      function confirmAddProduct() {
        const form = document.getElementById('addProductForm');
        const categorySelect = document.getElementById('categorySelect');
        const nameInput = form.elements['name'];
        const priceInput = form.elements['price'];
        
        // Basic validation for name and price
        if (!nameInput.value.trim()) {
          alert('‚ö†Ô∏è Please enter a product name');
          return;
        }
        
        if (!priceInput.value || parseFloat(priceInput.value) <= 0) {
          alert('‚ö†Ô∏è Please enter a valid price');
          return;
        }
        
        if (!categorySelect.value) {
          alert('‚ö†Ô∏è Please select a category');
          return;
        }
        
        // Check if category requires sizes and colors (not grooming)
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categorySlug = selectedOption ? selectedOption.getAttribute('data-slug') || '' : '';
        const isGrooming = categorySlug && (categorySlug.toLowerCase().includes('grooming') || selectedOption.textContent.toLowerCase().includes('grooming'));
        
        if (!isGrooming) {
          const selectedSizes = document.querySelectorAll('input[name="sizes"]:checked');
          const customSizesInput = document.getElementById('custom-sizes');
          const customSizes = customSizesInput ? customSizesInput.value.trim() : '';
          const selectedColors = document.querySelectorAll('input[name="colors"]:checked');
          const customColorsInput = document.getElementById('custom-colors');
          const customColors = customColorsInput ? customColorsInput.value.trim() : '';
          
          // Check if at least one size is provided (either checkbox or custom)
          const hasSizes = selectedSizes.length > 0 || customSizes.length > 0;
          if (!hasSizes) {
            alert('‚ö†Ô∏è Please select at least one size or add custom sizes');
            return;
          }
          
          // Check if at least one color is provided (either checkbox or custom)
          const hasColors = selectedColors.length > 0 || customColors.length > 0;
          if (!hasColors) {
            alert('‚ö†Ô∏è Please select at least one color or add custom colors');
            return;
          }
          
          // Make sure stock inputs are updated before proceeding
          updateStockInputs();
        }
        
        const productName = nameInput.value.trim();
        const productPrice = parseFloat(priceInput.value);
        const category = categorySelect.options[categorySelect.selectedIndex].text;
        
        // Get size and color info for confirmation
        const customSizesInput = document.getElementById('custom-sizes');
        const customColorsInput = document.getElementById('custom-colors');
        const selectedSizes = document.querySelectorAll('input[name="sizes"]:checked');
        const selectedColors = document.querySelectorAll('input[name="colors"]:checked');
        
        let sizeInfo = '';
        if (selectedSizes.length > 0) {
          sizeInfo = Array.from(selectedSizes).map(s => s.value).join(', ');
        }
        if (customSizesInput && customSizesInput.value.trim()) {
          sizeInfo += (sizeInfo ? ', ' : '') + customSizesInput.value.trim();
        }
        
        let colorInfo = '';
        if (selectedColors.length > 0) {
          colorInfo = Array.from(selectedColors).map(c => c.value).join(', ');
        }
        if (customColorsInput && customColorsInput.value.trim()) {
          colorInfo += (colorInfo ? ', ' : '') + customColorsInput.value.trim();
        }
        
        // Check if grooming for confirmation message
        const confirmSelectedOption = categorySelect.options[categorySelect.selectedIndex];
        const confirmCategorySlug = confirmSelectedOption ? confirmSelectedOption.getAttribute('data-slug') || '' : '';
        const confirmIsGrooming = confirmCategorySlug && (confirmCategorySlug.toLowerCase().includes('grooming') || confirmSelectedOption.textContent.toLowerCase().includes('grooming'));
        
        const confirmMsg = `Are you sure you want to add this product?\n\nProduct Name: ${productName}\nCategory: ${category}\nPrice: ‚Ç±${productPrice.toFixed(2)}${!confirmIsGrooming ? '\nSizes: ' + sizeInfo + '\nColors: ' + colorInfo : ''}\n\nThis product will be submitted for admin approval.`;
        
        if (confirm(confirmMsg)) {
          // Update stock inputs one final time before submission
          updateStockInputs();
          // Small delay to ensure inputs are ready
          setTimeout(() => {
            submitProductViaAJAX();
          }, 200);
        }
      }
      
      // Function to submit product via AJAX
      function submitProductViaAJAX() {
        const form = document.getElementById('addProductForm');
        
        // Validate form before submitting
        if (!form.checkValidity()) {
          alert('‚ùå Please fill in all required fields correctly');
          return;
        }
        
        // Copy custom sizes and colors to hidden inputs BEFORE creating FormData
        submitCustomValues();
        
        // Now create FormData after custom values are copied
        const formData = new FormData(form);
        
        // Add colorSizesMapping as JSON
        formData.append('color_sizes_mapping', JSON.stringify(colorSizesMapping));
        console.log('Color sizes mapping being sent:', colorSizesMapping);
        
        // Debug: Log all form data being sent
        console.log('=== Form Data Being Sent ===');
        for (let [key, value] of formData.entries()) {
          if (key.startsWith('stock_') || key.includes('size') || key.includes('color') || key === 'color_sizes_mapping') {
            console.log(`${key}: ${value}`);
          }
        }
        console.log('===========================');
        
        // Show loading state
        const submitBtn = document.querySelector('button[onclick="confirmAddProduct()"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Adding Product...';
        
        console.log('Submitting product form...');
        
        fetch('/seller/add-product', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json().then(data => ({
            status: response.status,
            data: data
          }));
        })
        .then(({ status, data }) => {
          console.log('Response data:', data);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          
          if (status === 200 && data.success) {
            // Success - product added to pending approval
            alert('‚úÖ Product submitted successfully!\n\nYour product has been added to the admin queue for approval.\n\nOnce approved, it will appear in your store.');
            // Clear form
            form.reset();
            // Reset category to trigger size/color sections
            document.getElementById('categorySelect').value = '';
            toggleSizeColorSections();
            // Reset color/size mappings
            colorSizesMapping = {};
            selectedColor = null;
            // Load products list
            loadPage('products');
          } else if (status === 400) {
            // Validation error
            alert('‚ùå Validation Error:\n\n' + data.error);
          } else if (data.error) {
            // Server error
            alert('‚ùå Error adding product:\n\n' + data.error);
          } else {
            alert('‚ùå Unexpected error occurred. Please try again.');
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          console.error('Request error:', error);
          alert('‚ùå Network error: ' + error.message + '\n\nPlease check your connection and try again.');
        });
      }
      
      // Function to update stock inputs based on selected sizes and colors
      // Store color-size mapping: each color has its own list of sizes
      let colorSizesMapping = {}; // { Red: ['S', 'M', 'L'], Black: ['M', 'L', 'XL'] }
      let selectedColor = null;
      let sizeType = 'clothing'; // 'clothing' or 'shoes'

      function updateColorTabs() {
        console.log('Updating color tabs...');
        
        const colors = [];
        
        // Get checked colors
        const checkedColors = Array.from(document.querySelectorAll('input[name="colors"]:checked')).map(cb => cb.value);
        colors.push(...checkedColors);
        
        // Get custom colors
        const customColorsInput = document.getElementById('custom-colors');
        const customColors = customColorsInput && customColorsInput.value.trim()
          ? customColorsInput.value.split(',').map(c => c.trim()).filter(c => c)
          : [];
        colors.push(...customColors);
        
        console.log('All colors:', colors);
        
        const colorTabsDiv = document.getElementById('colorTabs');
        
        if (colors.length === 0) {
          colorTabsDiv.innerHTML = '<p style="color: var(--muted); font-style: italic;">Select colors above to create tabs</p>';
          selectedColor = null;
          updateStockInputs();
          return;
        }
        
        // Generate color tabs
        let tabsHtml = '';
        colors.forEach(color => {
          const isSelected = selectedColor === color;
          tabsHtml += `<button type="button" id="color-tab-${color}" class="color-tab ${isSelected ? 'active' : ''}" 
            onclick="selectColor('${color}')" 
            style="padding: 10px 16px; border: 2px solid ${isSelected ? '#3b82f6' : '#ddd'}; background: ${isSelected ? '#3b82f6' : '#fff'}; 
            color: ${isSelected ? '#fff' : '#0a0a0a'}; border-radius: 6px; cursor: pointer; font-weight: ${isSelected ? '600' : '500'}; 
            transition: all 0.2s;">
            ${color}
          </button>`;
        });
        
        colorTabsDiv.innerHTML = tabsHtml;
        
        // If no color was selected, select the first one
        if (!selectedColor && colors.length > 0) {
          selectColor(colors[0]);
        }
      }

      function selectColor(color) {
        console.log(`Selected color: ${color}`);
        selectedColor = color;
        
        // Update hidden input
        document.getElementById('selected-color').value = color;
        
        // Update tab appearances
        document.querySelectorAll('.color-tab').forEach(tab => {
          const tabColor = tab.textContent.trim();
          const isSelected = tabColor === color;
          tab.style.borderColor = isSelected ? '#3b82f6' : '#ddd';
          tab.style.background = isSelected ? '#3b82f6' : '#fff';
          tab.style.color = isSelected ? '#fff' : '#0a0a0a';
          tab.style.fontWeight = isSelected ? '600' : '500';
        });
        
        // Update the color name in stock table title
        document.getElementById('stock-table-color').textContent = color;
        
        // Show sizes section and update for this color
        updateSizesForColor();
        
        // Update stock inputs for this color
        updateStockInputs();
      }

      function updateSizesForColor() {
        console.log('Updating sizes for color:', selectedColor);
        
        const placeholder = document.getElementById('sizesPlaceholder');
        const container = document.getElementById('perColorSizesContainer');
        
        // Show placeholder if no color selected
        if (!selectedColor) {
          if (placeholder) placeholder.style.display = 'block';
          if (container) container.style.display = 'none';
          return;
        }
        
        // Show sizes container
        if (placeholder) placeholder.style.display = 'none';
        if (container) container.style.display = 'block';
        
        // Update the label to show current color
        document.getElementById('current-color-size-label').textContent = selectedColor;
        
        // Check if this color already has saved sizes
        const savedSizes = colorSizesMapping[selectedColor];
        console.log(`Loading saved sizes for ${selectedColor}:`, savedSizes);
        
        // Restore previously selected sizes for this color
        document.querySelectorAll('.color-size-checkbox').forEach(checkbox => {
          if (savedSizes && savedSizes.includes(checkbox.value)) {
            checkbox.checked = true;
          } else {
            checkbox.checked = false;
          }
        });
        
        // Restore custom sizes input if it was saved
        const customSizesInput = document.getElementById('custom-sizes-per-color');
        if (customSizesInput) {
          // Extract custom sizes from the saved sizes array
          const customSizes = savedSizes ? savedSizes.filter(size => {
            return !['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5', '6', '7', '8', '9', '10', '11', '12', '13'].includes(size);
          }) : [];
          customSizesInput.value = customSizes.join(', ');
        }
        
        console.log(`Color ${selectedColor} sizes restored`);
        
        // Update stock table with new sizes
        updateStockInputs();
      }

      function updateStockInputs() {
        console.log('Updating stock inputs for color:', selectedColor);
        
        const sizes = [];
        
        // Get checked sizes from per-color checkboxes
        const checkedSizes = Array.from(document.querySelectorAll('.color-size-checkbox:checked')).map(cb => cb.value);
        sizes.push(...checkedSizes);
        
        // Get custom sizes for this color
        const customSizesInput = document.getElementById('custom-sizes-per-color');
        const customSizes = customSizesInput && customSizesInput.value.trim() 
          ? customSizesInput.value.split(',').map(s => s.trim()).filter(s => s)
          : [];
        
        sizes.push(...customSizes);
        
        console.log('Sizes for stock table:', sizes);
        
        const stockInputsDiv = document.getElementById('stock-inputs');
        
        if (!stockInputsDiv) {
          console.log('Stock inputs div not found');
          return;
        }
        
        // If no color selected or no sizes selected, show placeholder
        if (!selectedColor || sizes.length === 0) {
          stockInputsDiv.innerHTML = '<p style="color: var(--muted); font-style: italic;">üëâ Select sizes for this color above to set stock</p>';
          return;
        }
        
        // Save existing stock values before regenerating
        const existingValues = {};
        const existingInputs = stockInputsDiv.querySelectorAll('input[type="number"]');
        existingInputs.forEach(input => {
          if (input.value && input.value !== '0') {
            existingValues[input.name] = input.value;
          }
        });
        console.log('Preserved stock values:', existingValues);
        
        // Store selected sizes in colorSizesMapping for this color (including custom sizes)
        colorSizesMapping[selectedColor] = sizes;
        console.log('Updated colorSizesMapping:', colorSizesMapping);
        
        // Generate stock table for ONLY the selected color
        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #e5e7eb; position: sticky; top: 0;"><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Size</th><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Color</th><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Stock Qty</th><th style="padding: 8px; text-align: center; border: 1px solid var(--line); width: 50px;">Action</th></tr></thead>';
        html += '<tbody>';
        
        sizes.forEach(size => {
          // IMPORTANT: Only create stock input for the selected color
          const safeName = `stock_${size.replace(/[^a-zA-Z0-9]/g, '_')}_${selectedColor.replace(/[^a-zA-Z0-9]/g, '_')}`;
          const stockValue = existingValues[safeName] || '0';
          console.log(`Creating stock input for selected color: size="${size}", color="${selectedColor}", name="${safeName}", value="${stockValue}"`);
          html += `<tr style="transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.backgroundColor='';">
            <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${size}</td>
            <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${selectedColor}</td>
            <td style="padding: 8px; border: 1px solid var(--line);">
              <input type="number" name="${safeName}" min="0" value="${stockValue}" required 
                style="width: 80px; padding: 6px; border: 1px solid var(--line); border-radius: 4px;">
            </td>
            <td style="padding: 8px; border: 1px solid var(--line); text-align: center;">
              <button type="button" onclick="removeStockRow(this)" style="background: none; border: none; cursor: pointer; color: #ef4444; font-size: 18px; padding: 4px 8px; transition: transform 0.2s;" title="Remove this size-color combination" onmouseover="this.style.transform='scale(1.2)';" onmouseout="this.style.transform='scale(1)';">‚úï</button>
            </td>
          </tr>`;
        });
        
        html += '</tbody></table></div>';
        stockInputsDiv.innerHTML = html;
        console.log(`Stock table generated for color "${selectedColor}" with ${sizes.length} sizes`);
      }

      function removeStockRow(button) {
        const row = button.closest('tr');
        if (row) {
          row.style.animation = 'fadeOut 0.3s ease-out forwards';
          setTimeout(() => {
            row.remove();
            console.log('Row removed');
          }, 300);
        }
      }

      function loadPage(page) {
        const content = document.getElementById('dashboardContent');
        const app = document.querySelector('.app');
        
        // Toggle full-width mode for add-product page
        if (page === 'add-product') {
          app.classList.add('add-product-mode');
          updateAddProductSidebar();
        } else {
          app.classList.remove('add-product-mode');
          clearAddProductSidebar();
        }
        
        // Immediate UI updates first
        const links = document.querySelectorAll('.side-link');
        links.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) activeLink.classList.add('active');
        
        // Update page title immediately
        const pageNames = {
          'overview': 'Store Dashboard',
          'add-product': 'Add New Product',
          'products': 'Products',
          'archived-products': 'Archived Products',
          'inventory': 'Inventory',
          'orders': 'Order Management',
          'reviews': 'Customer Reviews',
          'promotions': 'Promotions',
          'sales': 'Sales Analytics',
          'performance': 'Performance',
          'store-settings': 'Brand Settings',
          'account': 'Account'
        };
        const titleEl = document.querySelector('.page-title');
        if (titleEl) titleEl.textContent = pageNames[page] || 'Seller Dashboard';
        
        // Special handling for overview page - reload the page to get server-side data
        if (page === 'overview') {
          window.location.href = '/seller-dashboard';
          return;
        }
        
        // Load content instantly
        if (pageTemplates[page]) {
          content.innerHTML = pageTemplates[page];
          
          // Use requestAnimationFrame for non-blocking event listener setup
          requestAnimationFrame(() => {
            if (page === 'products') {
              loadProducts();
            } else if (page === 'archived-products') {
              loadArchivedProducts();
            } else if (page === 'inventory') {
              loadInventory();
            } else if (page === 'reviews') {
              loadReviews();
            } else if (page === 'promotions') {
              loadPromotions();
            } else if (page === 'sales') {
              loadSalesAnalytics();
            } else if (page === 'performance') {
              loadPerformance();
            } else if (page === 'store-settings') {
              loadBrandSettings();
              // Attach form submit handler
              const brandForm = document.getElementById('brand-settings-form');
              if (brandForm) {
                brandForm.addEventListener('submit', (e) => {
                  e.preventDefault();
                  
                  // Validate required fields
                  const storeName = document.getElementById('store-name').value.trim();
                  const storeDesc = document.getElementById('store-description').value.trim();
                  
                  if (!storeName) {
                    alert('‚ö†Ô∏è Please enter a brand name');
                    return;
                  }
                  
                  if (!storeDesc) {
                    alert('‚ö†Ô∏è Please enter a brand description');
                    return;
                  }
                  
                  // Show confirmation popup
                  if (!confirm('Are you sure you want to save these brand settings?')) {
                    return;
                  }
                  
                  const formData = new FormData();
                  formData.append('store_name', storeName);
                  formData.append('description', storeDesc);
                  formData.append('contact_email', document.getElementById('contact-email').value);
                  formData.append('contact_phone', document.getElementById('contact-phone').value);
                  formData.append('address', document.getElementById('store-address').value);
                  formData.append('island_group', document.getElementById('island-group').value);
                  
                  fetch('/seller/brand-settings', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        alert('‚úÖ Brand settings updated successfully!');
                        loadBrandSettings();
                      } else {
                        alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                      }
                    })
                    .catch(error => alert('‚ùå Error saving settings: ' + error.message));
                });
              }
            } else if (page === 'account') {
              loadAccountSettings();
              // Attach form submit handler
              const accountForm = document.getElementById('account-settings-form');
              if (accountForm) {
                accountForm.addEventListener('submit', (e) => {
                  e.preventDefault();
                  
                  // Show confirmation popup
                  if (!confirm('Are you sure you want to save these account settings?')) {
                    return;
                  }
                  
                  // Check if email was verified (if it was changed)
                  const newEmail = document.getElementById('email-address').value.trim();
                  const currentEmail = document.getElementById('account-email').textContent;
                  
                  if (newEmail && newEmail !== currentEmail) {
                    const emailVerified = document.getElementById('email-verified-message').style.display !== 'none';
                    if (!emailVerified) {
                      alert('‚ö†Ô∏è Please verify the new email address before saving');
                      return;
                    }
                  }
                  
                  const formData = new FormData();
                  formData.append('full_name', document.getElementById('full-name').value);
                  formData.append('phone_number', document.getElementById('phone-number').value);
                  formData.append('email', newEmail);
                  
                  fetch('/seller/account-settings', { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                      if (data.success) {
                        alert('‚úÖ Account settings updated successfully!');
                        loadAccountSettings();
                      } else {
                        alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                      }
                    })
                    .catch(error => alert('‚ùå Error saving settings: ' + error.message));
                });
              }
            } else if (page === 'orders') {
              loadOrders('all');
            } else if (page === 'add-product') {
              // Load categories for dropdown
              loadCategories();
              
              // Attach event listeners for size/color checkboxes
              const sizeColorInputs = document.querySelectorAll('input[name="sizes"], input[name="colors"]');
              sizeColorInputs.forEach(checkbox => {
                checkbox.addEventListener('change', updateStockInputs);
              });
              
              // Attach event listeners for custom size/color inputs
              const customSizesInput = document.getElementById('custom-sizes');
              const customColorsInput = document.getElementById('custom-colors');
              
              if (customSizesInput) {
                customSizesInput.addEventListener('input', updateStockInputs);
                customSizesInput.addEventListener('blur', updateStockInputs);
              }
              
              if (customColorsInput) {
                customColorsInput.addEventListener('input', updateStockInputs);
                customColorsInput.addEventListener('blur', updateStockInputs);
              }
            }
          });
        }
      }

      // Switch between Orders and Products tabs in Order Management page
      // ============ ORDER MANAGEMENT FUNCTIONS ============
      let allOrders = [];
      let currentOrderFilter = 'all';

      function filterOrders(status) {
        console.log('üìã Filtering orders by status:', status);
        console.log('üìã All orders available:', allOrders.length);
        currentOrderFilter = status;
        
        // Update active button
        const buttons = document.querySelectorAll('[data-filter-btn]');
        buttons.forEach(btn => btn.classList.remove('active'));
        const activeBtn = document.querySelector(`[data-filter-btn="${status}"]`);
        if (activeBtn) activeBtn.classList.add('active');
        
        // Filter and display orders
        let filteredOrders = allOrders;
        if (status && status !== 'all') {
          filteredOrders = allOrders.filter(order => {
            const matches = order.order_status === status;
            console.log(`Order ${order.id}: status=${order.order_status}, filter=${status}, matches=${matches}`);
            return matches;
          });
        }
        
        console.log('üìã Filtered orders count:', filteredOrders.length);
        displayOrders(filteredOrders);
      }

      function loadOrders(initialFilter = 'confirmed') {
        console.log('üì§ Fetching orders from /seller/orders');
        
        fetch('/seller/orders')
          .then(response => {
            console.log('üì• Response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Orders response:', data);
            console.log('‚úÖ Orders array:', data.orders);
            console.log('‚úÖ Orders count:', data.orders ? data.orders.length : 0);
            
            if (data.success && data.orders && Array.isArray(data.orders)) {
              allOrders = data.orders;
              console.log('‚úÖ All orders stored:', allOrders.length);
              updateOrderCount(allOrders.length);
              
              // Show all orders first, then filter
              if (initialFilter && initialFilter !== 'all') {
                filterOrders(initialFilter);
              } else {
                displayOrders(allOrders);
              }
            } else {
              console.warn('‚ùå No orders in response or invalid format:', data);
              allOrders = [];
              updateOrderCount(0);
              const ordersList = document.getElementById('orders-list');
              if (ordersList) {
                ordersList.innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No orders yet</p>';
              }
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading orders:', error);
            updateOrderCount(0);
            const ordersList = document.getElementById('orders-list');
            if (ordersList) {
              ordersList.innerHTML = `<p style="color:#d32f2f;padding:40px;text-align:center;">Error loading orders: ${error.message}</p>`;
            }
          });
      }

      function updateOrderCount(count) {
        const badge = document.getElementById('order-count-badge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      function fetchOrderCount() {
        fetch('/seller/orders')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.orders && Array.isArray(data.orders)) {
              updateOrderCount(data.orders.length);
            } else {
              updateOrderCount(0);
            }
          })
          .catch(error => {
            console.error('Error fetching order count:', error);
          });
      }

      function displayOrders(orders) {
        const container = document.getElementById('orders-list');
        
        if (!container) {
          console.error('‚ùå orders-list container not found');
          return;
        }
        
        console.log('üìä Displaying orders:', orders ? orders.length : 0, orders);
        
        if (!orders || orders.length === 0) {
          container.innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No orders found</p>';
          return;
        }
        
        let html = `
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr style="background:#f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding:10px; text-align:left; font-weight:600;">Order Number</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Customer</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Items</th>
                <th style="padding:10px; text-align:right; font-weight:600;">Amount</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Status</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Date</th>
                <th style="padding:10px; text-align:center; font-weight:600;">Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        orders.forEach(order => {
          const statusColors = {
            'pending': '#ff9800',
            'confirmed': '#2196f3',
            'waiting_for_pickup': '#8b5cf6',
            'processing': '#ff5722',
            'shipped': '#4caf50',
            'delivered': '#9c27b0',
            'cancelled': '#f44336',
            'returned': '#795548'
          };
          
          const statusEmojis = {
            'pending': '‚è≥',
            'confirmed': '‚úîÔ∏è',
            'waiting_for_pickup': '‚è∏Ô∏è',
            'processing': 'üîÑ',
            'shipped': 'üì¶',
            'delivered': '‚úÖ',
            'cancelled': '‚ùå',
            'returned': '‚Ü©Ô∏è'
          };
          
          const statusBadgeColor = statusColors[order.order_status] || '#666';
          const statusEmoji = statusEmojis[order.order_status] || 'üìã';
          const orderDate = new Date(order.created_at).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          
          html += `
            <tr style="border-bottom: 1px solid #eee;" data-order-id="${order.id}" data-order-status="${order.order_status}">
              <td style="padding:10px;"><strong>${order.order_number}</strong></td>
              <td style="padding:10px;">${order.customer_name || 'N/A'}</td>
              <td style="padding:10px;">${order.item_count || 1} item(s)</td>
              <td style="padding:10px; text-align:right;"><strong>‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}</strong></td>
              <td style="padding:10px;">
                <span style="background:${statusBadgeColor}; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">
                  ${statusEmoji} ${order.order_status.replace(/_/g, ' ').toUpperCase()}
                </span>
              </td>
              <td style="padding:10px; font-size:12px; color:#666;">${orderDate}</td>
              <td style="padding:10px; text-align:center;">
                <div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap;align-items:center">
                  <button class="action-btn" onclick="viewOrderDetails(${order.id})" style="font-size:12px; padding:4px 8px;">üëÅÔ∏è View</button>
                  ${order.order_status === 'pending' ? 
                    `<button class="action-btn" onclick="confirmOrder(${order.id})" style="font-size:12px; padding:4px 8px; background:#2196f3; color:#fff;">‚úì Confirm</button>` :
                  order.order_status === 'confirmed' ? 
                    `<button class="action-btn" onclick="setToWaitingPickup(${order.id})" style="font-size:12px; padding:4px 8px; background:#8b5cf6; color:#fff;">‚è∏Ô∏è Mark Waiting</button>` :
                  order.order_status === 'waiting_for_pickup' ? 
                    `<span style="background:#8b5cf6;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600">‚è∏Ô∏è Awaiting Rider</span>` :
                  order.order_status === 'released_to_rider' || order.order_status === 'shipped' ? 
                    `
                    <button class="action-btn" onclick="viewDeliveryStatus(${order.id})" style="font-size:12px; padding:4px 8px; background:#10b981; color:#fff;">üìç Track</button>
                    ${order.order_status === 'shipped' ? `<button class="action-btn" onclick="confirmDelivery(${order.id})" style="font-size:12px; padding:4px 8px; background:#059669; color:#fff;">‚úÖ Delivered</button>` : ''}
                    ` :
                  order.order_status === 'delivered' ? 
                    `<span style="background:#10b981;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:600">‚úÖ Delivered</span>` :
                  order.order_status !== 'cancelled' ? 
                    `<button class="action-btn" onclick="viewDeliveryStatus(${order.id})" style="font-size:12px; padding:4px 8px; background:#3b82f6; color:#fff;">üìç Track</button>` : ''}
                </div>
              </td>
              </td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
        
        container.innerHTML = html;
      }

      function viewOrderDetails(orderId) {
        console.log('üëÄ Viewing order details:', orderId);
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
          alert('Order not found');
          return;
        }
        
        const shippingLocation = `${order.shipping_city || ''}${order.shipping_city ? ', ' : ''}${order.shipping_province || ''}${order.shipping_province ? ' ' : ''}${order.shipping_postal_code || ''}`.trim();
        
        const details = `
Order Number: ${order.order_number}
Customer: ${order.customer_name || 'N/A'}
Total: ‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}
Status: ${order.order_status.replace(/_/g, ' ').toUpperCase()}
Items: ${order.item_count || 1}
Shipping To: ${shippingLocation || 'N/A'}
Date: ${new Date(order.created_at).toLocaleDateString()}
        `;
        
        alert(details);
      }

      // ===== ORDER STATUS MANAGEMENT STATE MACHINE =====
      // Define valid status transitions (forward-only, no backwards allowed)
      const orderStatusFlow = {
        'pending': ['confirmed'],
        'confirmed': ['waiting_for_pickup'],
        'waiting_for_pickup': ['delivered'],
        'delivered': [], // Final state
        'cancelled': [], // Final state
        'returned': []   // Final state
      };

      function getNextAllowedStatuses(currentStatus) {
        return orderStatusFlow[currentStatus] || [];
      }

      function openStatusModal(orderId, currentStatus) {
        console.log('üîÑ Opening order management modal for order:', orderId, 'Current status:', currentStatus);
        
        // Get the order details
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          alert('Order not found');
          return;
        }
        
        // Get allowed next statuses (prevent backwards transitions)
        const allowedStatuses = getNextAllowedStatuses(currentStatus);
        
        if (allowedStatuses.length === 0) {
          alert(`‚ö†Ô∏è This order is in a final state (${currentStatus.toUpperCase()}) and cannot be modified further.`);
          return;
        }
        
        // Create status transition options with descriptions and emojis
        const statusDescriptions = {
          'confirmed': { desc: 'Start preparing the order for shipment', icon: 'üì¶', color: '#3b82f6' },
          'processing': { desc: 'Package is ready and awaiting shipment', icon: 'üìã', color: '#8b5cf6' },
          'shipped': { desc: 'Order dispatched to delivery address', icon: 'üöö', color: '#06b6d4' },
          'delivered': { desc: 'Order successfully delivered to customer', icon: '‚úÖ', color: '#10b981' },
          'cancelled': { desc: 'Cancel this order (cannot be reopened)', icon: '‚ùå', color: '#ef4444' }
        };
        
        let statusOptions = allowedStatuses.map(s => {
          const info = statusDescriptions[s] || {};
          return `<option value="${s}" data-description="${info.desc}">${info.icon} ${s.replace(/_/g, ' ').toUpperCase()}</option>`;
        }).join('');
        
        const currentStatusInfo = statusDescriptions[currentStatus] || {};
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';
        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:550px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
            
            <h2 style="margin:0 0 24px; font-size:22px; font-weight:600; color:#0a0a0a;">üìã Order Management</h2>
            
            <!-- Current Status Section -->
            <div style="background:#f3f4f6; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0 0 8px; font-size:12px; color:#6b7280; font-weight:600; text-transform:uppercase;">Current Status</p>
              <div style="font-size:18px; font-weight:600; color:#0a0a0a;">
                ${currentStatusInfo.icon} ${currentStatus.replace(/_/g, ' ').toUpperCase()}
              </div>
              <p style="margin:8px 0 0; font-size:13px; color:#6b7280;">${currentStatusInfo.desc || ''}</p>
            </div>
            
            <!-- Order Details Summary -->
            <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0; font-size:12px; color:#6b7280; font-weight:600;">üì¶ Order #${order.order_number || order.id}</p>
              <p style="margin:4px 0 0; font-size:12px; color:#6b7280;color:12px;>üí∞ Total: ‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)} | üë§ ${order.customer_name || 'N/A'}</p>
              <p style="margin:4px 0 0; font-size:12px; color:#6b7280;">üìÖ Placed: ${new Date(order.created_at).toLocaleDateString()}</p>
            </div>
            
            <!-- Status Transition Section -->
            <div style="margin-bottom:20px;">
              <label style="display:block; margin-bottom:8px; font-weight:600; font-size:14px; color:#0a0a0a;">Next Status</label>
              <select id="new-status-select" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; cursor:pointer; color:#0a0a0a;" onchange="updateStatusDescription(this)">
                <option value="">-- Select next status --</option>
                ${statusOptions}
              </select>
              <p id="status-description" style="margin:12px 0 0; padding:12px; background:#f0f9ff; border-left:3px solid #3b82f6; border-radius:4px; color:#0c4a6e; font-size:13px; display:none;"></p>
            </div>
            
            <!-- Warning Section -->
            <div id="status-warning" style="display:none; margin-bottom:20px; padding:12px; background:#fef3c7; border-left:3px solid #f59e0b; border-radius:4px;">
              <p style="margin:0; color:#92400e; font-size:13px; font-weight:600;">‚ö†Ô∏è <span id="warning-text"></span></p>
            </div>
            
            <!-- Action Buttons -->
            <div style="display:flex; gap:12px; justify-content:flex-end;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px; border:1px solid #e5e7eb; background:#f6f6f6; color:#0a0a0a; border-radius:8px; cursor:pointer; font-weight:600;">
                Cancel
              </button>
              <button onclick="updateOrderStatus(${orderId})" style="padding:12px 24px; border:none; background:#0a0a0a; color:#fff; border-radius:8px; cursor:pointer; font-weight:600;" id="update-btn" disabled>
                Update Status
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      function updateStatusDescription(selectElement) {
        const selectedStatus = selectElement.value;
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const description = selectedOption.getAttribute('data-description');
        
        const descDiv = document.getElementById('status-description');
        const updateBtn = document.getElementById('update-btn');
        
        if (selectedStatus) {
          descDiv.textContent = description;
          descDiv.style.display = 'block';
          updateBtn.disabled = false;
          updateBtn.style.opacity = '1';
          updateBtn.style.cursor = 'pointer';
          
          // Show warning for final statuses
          if (selectedStatus === 'delivered') {
            document.getElementById('status-warning').style.display = 'block';
            document.getElementById('warning-text').textContent = 'Once marked as delivered, this order cannot be modified.';
          } else if (selectedStatus === 'cancelled') {
            document.getElementById('status-warning').style.display = 'block';
            document.getElementById('warning-text').textContent = 'Cancelled orders cannot be reopened.';
          } else {
            document.getElementById('status-warning').style.display = 'none';
          }
        } else {
          descDiv.style.display = 'none';
          updateBtn.disabled = true;
          updateBtn.style.opacity = '0.5';
          updateBtn.style.cursor = 'not-allowed';
          document.getElementById('status-warning').style.display = 'none';
        }
      }

      function updateOrderStatus(orderId) {
        const newStatus = document.getElementById('new-status-select').value;
        
        if (!newStatus) {
          alert('Please select a valid status');
          return;
        }
        
        // Get current order to validate transition
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          alert('Order not found');
          return;
        }
        
        const currentStatus = order.order_status;
        const allowedStatuses = getNextAllowedStatuses(currentStatus);
        
        // Check if transition is allowed (prevent backwards transitions)
        if (!allowedStatuses.includes(newStatus)) {
          alert(`‚ùå Invalid status transition:\nCannot go from "${currentStatus.toUpperCase()}" to "${newStatus.toUpperCase()}"\n\nForward-only transitions are allowed.`);
          return;
        }
        
        const updateBtn = document.getElementById('update-btn');
        const originalText = updateBtn.textContent;
        updateBtn.disabled = true;
        updateBtn.textContent = '‚è≥ Updating...';
        
        console.log('üìä Updating order status: orderId=' + orderId + ', from=' + currentStatus + ', to=' + newStatus);
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', newStatus);
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.success) {
              const statusEmojis = {
                'confirmed': '‚úÖ',
                'processing': 'üîÑ',
                'shipped': 'üì¶',
                'delivered': '‚úÖ',
                'cancelled': '‚ùå'
              };
              
              alert(`${statusEmojis[newStatus] || '‚úÖ'} Order status updated!\n\nüìã Order #${order.order_number}\n‚è±Ô∏è New Status: ${newStatus.replace(/_/g, ' ').toUpperCase()}`);
              
              // Remove modal and reload
              document.querySelectorAll('[style*="position:fixed"]').forEach(el => el.remove());
              loadOrders(currentOrderFilter);
              fetchOrderCount();
            } else {
              alert('‚ùå Failed to update order status:\n' + (data.message || data.error || 'Unknown error'));
              updateBtn.disabled = false;
              updateBtn.textContent = originalText;
            }
          })
          .catch(error => {
            console.error('‚ùå Error updating order status:', error);
            alert('Error updating order status: ' + error.message);
            updateBtn.disabled = false;
            updateBtn.textContent = originalText;
          });
      }

      function approveRider(orderId, shipmentId) {
        console.log('‚úÖ Approving rider for order:', orderId, 'shipment:', shipmentId);
        
        if (!confirm('Approve this rider to pick up the order?')) return;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        if (shipmentId) {
          formData.append('shipment_id', shipmentId);
        }
        
        fetch('/seller/approve-rider', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Rider approved! You can now release the order to rider.');
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to approve rider: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error approving rider:', error);
          alert('Error approving rider: ' + error.message);
        });
      }

      function confirmOrder(orderId) {
        console.log('üìã Confirming order:', orderId);
        
        if (!confirm('Confirm this order?')) return;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        
        fetch('/seller/confirm-order', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const message = data.rider_assigned ? 
              '‚úÖ Order confirmed and assigned to a rider!' : 
              '‚úÖ Order confirmed! A rider in your area will accept it soon.';
            alert(message);
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to confirm order: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error confirming order:', error);
          alert('Error confirming order: ' + error.message);
        });
      }

      function setToWaitingPickup(orderId) {
        console.log('‚è∏Ô∏è Setting order to waiting for pickup:', orderId);
        
        if (!confirm('Mark this order as Waiting for Pick Up? Riders will be able to accept this order.')) {
          return;
        }
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'waiting_for_pickup');
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          console.log('Response:', data);
          if (data.success) {
            alert('Order marked as Waiting for Pick Up!');
            loadOrders('confirmed');
          } else {
            alert('Error: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error updating order status:', error);
          alert('Error updating order: ' + error.message);
        });
      }

      function viewDeliveryStatus(orderId) {
        console.log('üìç Viewing delivery status for order:', orderId);
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
          alert('Order not found');
          return;
        }
        
        // Map shipment status to readable status
        const statusMap = {
          'pending': 'Pending Pickup',
          'picked_up': 'Picked Up',
          'in_transit': 'In Transit',
          'out_for_delivery': 'Out for Delivery',
          'delivered': 'Delivered',
          'failed': 'Delivery Failed',
          'assigned_to_rider': 'Assigned to Rider'
        };
        
        const riderName = order.rider_name ? `${order.rider_name}` : 'Assigned Rider';
        const currentStatus = statusMap[order.shipment_status] || order.shipment_status;
        
        const details = `
üì¶ DELIVERY TRACKING
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Order #${order.order_number}
Customer: ${order.customer_name || 'N/A'}

üöö Rider: ${riderName}
üìç Current Status: ${currentStatus}
üìç Delivery to: ${order.shipping_city || ''}, ${order.shipping_province || ''}

‚è∞ Order Time: ${new Date(order.created_at).toLocaleString()}
        `;
        
        alert(details);
      }

      function confirmDelivery(orderId) {
        console.log('‚úÖ Confirming delivery for order:', orderId);
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
          alert('Order not found');
          return;
        }
        
        if (!confirm(`Confirm that Order #${order.order_number} has been delivered to ${order.customer_name}?`)) {
          return;
        }
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'delivered');
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Order marked as delivered!');
            loadOrders('all');
            fetchOrderCount();
          } else {
            alert('Error: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error confirming delivery:', error);
          alert('Error confirming delivery: ' + error.message);
        });
      }

      function releaseToRider(orderId) {
        console.log('üöö Releasing order to rider:', orderId);
        
        // Show rider selection modal
        showRiderSelectionModal(orderId);
      }

      function showRiderSelectionModal(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          alert('Order not found');
          return;
        }

        // Show loading state
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';
        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:600px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
            <h2 style="margin:0 0 8px; font-size:22px; font-weight:600; color:#0a0a0a;">üöö Select Rider for Delivery</h2>
            <p style="margin:0 0 24px; color:#666; font-size:14px;">Choose a rider to deliver Order #${order.order_number}</p>
            <div id="seller-island" style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; margin-bottom:20px; border-radius:4px; font-size:13px; color:#1565c0;">
              üìç <strong>Order Delivery Region:</strong> <span id="seller-island-text">Loading...</span>
            </div>
            <div id="rider-list" style="min-height:150px; display:flex; align-items:center; justify-content:center; color:#999;">
              ‚è≥ Loading available riders...
            </div>
            <div id="rider-error" style="display:none; padding:12px; background:#fee; color:#c33; border-radius:4px; margin-bottom:16px; border-left:3px solid #f44;"></div>
          </div>
        `;
        document.body.appendChild(modal);

        // Fetch available riders (filtered by order's delivery location)
        fetch(`/api/sellers/available-riders?order_id=${orderId}`)
          .then(r => r.json())
          .then(data => {
            // Display delivery location info
            let locationInfo = 'your area';
            if (data.delivery_location && data.delivery_location.city) {
              locationInfo = `${data.delivery_location.city}, ${data.delivery_location.province}`;
            }
            
            if (!data.success || !data.riders || data.riders.length === 0) {
              document.getElementById('rider-list').innerHTML = `
                <div style="text-align:center; padding:24px;">
                  <p style="color:#999; font-size:14px;">‚ö†Ô∏è No available riders found for ${data.delivery_region || 'your area'}</p>
                  <p style="color:#999; font-size:12px; margin-top:8px;">üìç Order delivery to: ${locationInfo}</p>
                  <p style="color:#999; font-size:12px; margin-top:8px;">Make sure riders have their service area set to ${data.delivery_region || 'All areas'}</p>
                  <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top:12px; padding:8px 16px; background:#999; color:#fff; border:none; border-radius:4px; cursor:pointer;">Close</button>
                </div>
              `;
              return;
            }

            // Update seller island info to show delivery region
            if (data.delivery_region) {
              document.getElementById('seller-island').innerHTML = `üìç <strong>Delivery Region:</strong> üèùÔ∏è ${data.delivery_region} (Order to: ${locationInfo})`;
            }

            // Display riders with selection buttons
            let riderHTML = '<div style="display:flex;flex-direction:column;gap:12px;">';
            
            data.riders.forEach(rider => {
              const riderName = rider.first_name && rider.last_name ? `${rider.first_name} ${rider.last_name}` : 'Rider #' + rider.id;
              const vehicleType = rider.vehicle_type || 'Unknown';
              const rating = rider.rating ? `‚≠ê ${parseFloat(rider.rating).toFixed(1)}` : 'No ratings';
              const deliveries = rider.total_deliveries || 0;
              const riderRegion = rider.sub_region || rider.service_area || 'All areas';
              
              riderHTML += `
                <div style="border:2px solid #e5e7eb; border-radius:8px; padding:16px; display:flex; justify-content:space-between; align-items:center; hover:{background:#f9f9f9};cursor:pointer;" onclick="assignRiderToOrder(${orderId}, ${rider.id}, '${riderName.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='#fff'">
                  <div>
                    <div style="font-weight:600; color:#0a0a0a; font-size:15px;">üë§ ${riderName}</div>
                    <div style="font-size:13px; color:#666; margin-top:4px;">
                      üöó ${vehicleType} | ${rating} | ${deliveries} deliveries
                    </div>
                    <div style="font-size:12px; color:#2196f3; margin-top:4px; font-weight:500;">
                      üìç Service Region: ${riderRegion}
                    </div>
                  </div>
                  <button style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;" onclick="event.stopPropagation(); assignRiderToOrder(${orderId}, ${rider.id}, '${riderName.replace(/'/g, "\\'")}')" onmouseover="this.background='#45a049'" onmouseout="this.background='#4caf50'">
                    ‚úì Select
                  </button>
                </div>
              `;
            });

            riderHTML += '</div>';
            document.getElementById('rider-list').innerHTML = riderHTML;
          })
          .catch(error => {
            console.error('Error loading riders:', error);
            document.getElementById('rider-error').style.display = 'block';
            document.getElementById('rider-error').textContent = '‚ùå Failed to load riders: ' + error.message;
            document.getElementById('rider-list').innerHTML = `
              <div style="text-align:center; padding:24px;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding:8px 16px; background:#999; color:#fff; border:none; border-radius:4px; cursor:pointer;">Close</button>
              </div>
            `;
          });
      }

      function assignRiderToOrder(orderId, riderId, riderName) {
        console.log(`‚úÖ Assigning rider ${riderId} (${riderName}) to order ${orderId}`);
        
        if (!confirm(`Assign ${riderName} as the rider for this delivery?`)) {
          return;
        }

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('rider_id', riderId);
        formData.append('new_status', 'released_to_rider');

        fetch('/seller/release-to-rider', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          console.log('Release to rider response:', data);
          
          if (data.success) {
            // Close modal
            document.querySelectorAll('[style*="fixed"]').forEach(el => {
              if (el.style.background && el.style.background.includes('rgba(0,0,0,0.6)')) {
                el.remove();
              }
            });
            
            alert(`‚úÖ Order released to ${riderName}! Rider can now start delivery.`);
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to assign rider: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error assigning rider:', error);
          alert('Error assigning rider: ' + error.message);
        });
      }

      function releaseToRiderDelivered(orderId) {
        console.log('üöö Releasing to rider (delivered status):', orderId);
        
        if (!confirm('Release to Rider?')) return;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'delivered');
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Approved! The rider will ship it to the customer.');
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error updating order:', error);
          alert('Error updating order: ' + error.message);
        });
      }

      function markShipped(orderId) {
        console.log('üì¶ Marking order as shipped:', orderId);
        
        if (!confirm('Mark as Shipped?')) return;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'shipped');
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Order marked as shipped!');
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error updating order:', error);
          alert('Error updating order: ' + error.message);
        });
      }

      function updateSellerOrderStatus(orderId, newStatus) {
        console.log('üìä Updating seller order status:', orderId, 'to:', newStatus);
        
        const statusLabels = {
          'processing': 'üîÑ Processing',
          'shipped': 'üì¶ Ready for Pickup',
          'released_to_rider': 'üöö Release to Rider'
        };
        
        if (!confirm(`Update order status to ${statusLabels[newStatus] || newStatus}?`)) return;
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', newStatus);
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`‚úÖ Order status updated to ${statusLabels[newStatus]}`);
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error updating order:', error);
          alert('Error updating order: ' + error.message);
        });
      }

      function approveRiderForDelivery(orderId, riderId) {
        console.log('‚úÖ Approving rider for delivery:', orderId, 'rider:', riderId);
        
        // Fetch rider details and show modal
        fetch(`/api/rider-details/${riderId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.rider) {
              const rider = data.rider;
              const profileImage = rider.profile_image_url || '/static/images/default-avatar.jpg';
              
              // Create and show modal
              const modal = document.createElement('div');
              modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000';
              modal.innerHTML = `
                <div style="background:#fff;padding:32px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
                  <button onclick="this.closest('[style*=fixed]').remove()" style="float:right;background:none;border:none;font-size:28px;cursor:pointer;color:#999">√ó</button>
                  <h2 style="margin:0 0 24px;font-size:22px;font-weight:600">Rider Details</h2>
                  
                  <div style="background:#f9fafb;padding:24px;border-radius:12px;text-align:center;margin-bottom:24px">
                    <div style="width:100px;height:100px;border-radius:50%;margin:0 auto 16px;overflow:hidden;background:#e5e7eb;display:flex;align-items:center;justify-content:center;border:3px solid #10b981">
                      <img src="${profileImage}" alt="${rider.first_name}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='/static/images/default-avatar.jpg'">
                    </div>
                    <h3 style="margin:0 0 8px;font-size:20px;font-weight:600">${rider.first_name} ${rider.last_name}</h3>
                    <p style="margin:0 0 16px;color:#6b7280;font-size:14px">Assigned delivery rider</p>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb">
                      <div>
                        <p style="margin:0 0 4px;font-size:12px;color:#9ca3af;text-transform:uppercase;font-weight:600">Phone</p>
                        <p style="margin:0;font-size:16px;font-weight:600">${rider.phone || 'N/A'}</p>
                      </div>
                      <div>
                        <p style="margin:0 0 4px;font-size:12px;color:#9ca3af;text-transform:uppercase;font-weight:600">Rating</p>
                        <p style="margin:0;font-size:16px;font-weight:600">‚≠ê ${parseFloat(rider.rating || 0).toFixed(1)}</p>
                      </div>
                    </div>
                    
                    <div style="margin-top:16px;padding:12px;background:#dcfce7;border-radius:8px;border-left:4px solid #10b981">
                      <p style="margin:0;color:#15803d;font-size:13px;font-weight:500">‚úì This rider is verified and ready to deliver</p>
                    </div>
                  </div>
                  
                  <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:8px;cursor:pointer;font-weight:600">Cancel</button>
                    <button onclick="completeRiderApproval(${orderId}, ${riderId}); this.closest('[style*=fixed]').remove();" style="padding:12px 24px;border:none;background:#10b981;color:#fff;border-radius:8px;cursor:pointer;font-weight:600">Approve for Delivery</button>
                  </div>
                </div>
              `;
              document.body.appendChild(modal);
            } else {
              alert('Error loading rider details');
            }
          })
          .catch(error => {
            console.error('Error fetching rider details:', error);
            alert('Error loading rider details');
          });
      }

      function completeRiderApproval(orderId, riderId) {
        console.log('‚úÖ Completing rider approval:', orderId, riderId);
        
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('rider_id', riderId);
        
        fetch('/seller/approve-rider-for-delivery', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Rider approved for delivery! Order will be picked up for delivery.');
            loadOrders(currentOrderFilter);
            fetchOrderCount();
          } else {
            alert('‚ùå Failed to approve rider: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error approving rider:', error);
          alert('Error: ' + error.message);
        });
      }
      // ============ END ORDER MANAGEMENT ============

      // ============ INVENTORY MANAGEMENT ============
      function loadInventory() {
        fetch('/seller/inventory')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.inventory) {
              const inventory = data.inventory;
              displayInventory(inventory);
            } else {
              document.getElementById('inventory-list').innerHTML = '<p style="color:#999;padding:40px;">No inventory items found</p>';
            }
          })
          .catch(error => {
            document.getElementById('inventory-list').innerHTML = '<p style="color:#d32f2f;padding:40px;">Error loading inventory</p>';
          });
      }
      
      function displayInventory(inventory) {
        if (!inventory || inventory.length === 0) {
          document.getElementById('inventory-list').innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No products in inventory</p>';
          return;
        }
        
        // Group by product for better display
        const grouped = {};
        inventory.forEach(item => {
          const key = item.product_id;
          if (!grouped[key]) {
            grouped[key] = {
              product_name: item.product_name,
              sku: item.sku,
              price: item.price,
              image_url: item.image_url,
              variants: []
            };
          }
          grouped[key].variants.push(item);
        });
        
        let html = '';
        
        Object.entries(grouped).forEach(([productId, product]) => {
          const hasVariants = product.variants.some(v => v.size || v.color);
          const imageHtml = product.image_url ? `<img src="${product.image_url}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #e0e0e0;">` : `<div style="width: 120px; height: 120px; background: #f0f0f0; border-radius: 8px; border: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: center; color: #999;">No Image</div>`;
          
          html += `
            <div style="margin-bottom: 24px; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden;">
              <div style="display: flex; gap: 20px; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                <div>${imageHtml}</div>
                <div style="flex: 1;">
                  <h3 style="margin: 0 0 8px; font-size: 18px; font-weight: 600; color: #0a0a0a;">${product.product_name}</h3>
                  <p style="margin: 4px 0; font-size: 13px; color: #666;">SKU: ${product.sku || 'N/A'}</p>
                  <p style="margin: 4px 0; font-size: 14px; font-weight: 600; color: #0a0a0a;">‚Ç±${parseFloat(product.price || 0).toFixed(2)}</p>
                  <p style="margin: 8px 0 0; font-size: 12px; color: #999;">Total Variants: ${product.variants.length}</p>
                </div>
              </div>
              
              ${hasVariants ? `
                <div style="padding: 20px;">
                  <h4 style="margin: 0 0 16px; font-size: 14px; font-weight: 600; color: #0a0a0a;">Stock Management by Size & Color</h4>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 16px;">
                    ${product.variants.map(variant => `
                      <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                        <div style="margin-bottom: 12px;">
                          <p style="margin: 0 0 4px; font-size: 12px; color: #666; font-weight: 600;">üìè Size: <strong>${variant.size || 'One Size'}</strong></p>
                          <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600;">üé® Color: <strong>${variant.color || 'N/A'}</strong></p>
                        </div>
                        
                        <div style="background: #f0f9ff; padding: 12px; border-radius: 6px; margin-bottom: 12px;">
                          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px;">
                            <div>
                              <p style="margin: 0; color: #0c4a6e; font-weight: 600;">Stock</p>
                              <p style="margin: 4px 0 0; font-size: 16px; font-weight: 600; color: #0c4a6e;">${variant.stock_quantity}</p>
                            </div>
                            <div>
                              <p style="margin: 0; color: #0c4a6e; font-weight: 600;">Available</p>
                              <p style="margin: 4px 0 0; font-size: 16px; font-weight: 600; color: #0c4a6e;">${variant.available_quantity}</p>
                            </div>
                          </div>
                        </div>
                        
                        <button class="restock-btn" data-product-id="${variant.product_id}" data-variant-id="${variant.variant_id_full}" data-product-name="${variant.product_name}" data-size="${variant.size || 'One Size'}" data-color="${variant.color || 'N/A'}" data-stock="${variant.stock_quantity}" style="width: 100%; padding: 8px; background: #0a0a0a; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Restock</button>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : `
                <div style="padding: 20px;">
                  <div style="background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                      <div>
                        <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600;">Current Stock</p>
                        <p style="margin: 4px 0 0; font-size: 18px; font-weight: 600; color: #0a0a0a;">${product.variants[0].stock_quantity}</p>
                      </div>
                      <div>
                        <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600;">Reserved</p>
                        <p style="margin: 4px 0 0; font-size: 18px; font-weight: 600; color: #0a0a0a;">${product.variants[0].reserved_quantity}</p>
                      </div>
                      <div>
                        <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600;">Available</p>
                        <p style="margin: 4px 0 0; font-size: 18px; font-weight: 600; color: #0a0a0a;">${product.variants[0].available_quantity}</p>
                      </div>
                      <div>
                        <p style="margin: 0; font-size: 12px; color: #666; font-weight: 600;">Alert Level</p>
                        <p style="margin: 4px 0 0; font-size: 18px; font-weight: 600; color: #0a0a0a;">${product.variants[0].low_stock_threshold}</p>
                      </div>
                    </div>
                    <button class="restock-btn" data-product-id="${product.variants[0].product_id}" data-variant-id="" data-product-name="${product.product_name}" data-size="One Size" data-color="N/A" data-stock="${product.variants[0].stock_quantity}" style="width: 100%; padding: 12px; background: #0a0a0a; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">Restock</button>
                  </div>
                </div>
              `}
            </div>
          `;
        });
        
        document.getElementById('inventory-list').innerHTML = html;
        
        // Attach click handlers to restock buttons
        console.log('Attaching event listeners to .restock-btn elements');
        setTimeout(() => {
          const buttons = document.querySelectorAll('.restock-btn');
          console.log(`Found ${buttons.length} restock buttons`);
          buttons.forEach((btn, index) => {
            console.log(`Attaching listener to button ${index}:`, btn.dataset);
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const productId = this.dataset.productId;
              const variantId = this.dataset.variantId;
              const productName = this.dataset.productName;
              const size = this.dataset.size;
              const color = this.dataset.color;
              const stock = this.dataset.stock;
              
              console.log('‚úì Restock button clicked:', { productId, variantId, productName, size, color, stock });
              openVariantRestockModal(productId, variantId, productName, size, color, stock);
            });
          });
        }, 100);
      }

      function openVariantRestockModal(productId, variantId, productName, size, color, currentStock) {
        console.log('üîß openVariantRestockModal called with:', { productId, variantId, productName, size, color, currentStock });
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';
        
        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:500px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
            
            <h2 style="margin:0 0 24px; font-size:22px; font-weight:600; color:#0a0a0a;">üì¶ Restock: ${size} - ${color}</h2>
            
            <!-- Product Details -->
            <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #0a0a0a;">
              <p style="margin:0 0 8px; font-size:12px; color:#6b7280; font-weight:600; text-transform:uppercase;">Product</p>
              <p style="margin:4px 0; font-size:14px; font-weight:600; color:#0a0a0a;">${productName}</p>
            </div>
            
            <!-- Current Stock -->
            <div style="background:#f0f9ff; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0 0 8px; font-size:12px; color:#0c4a6e; font-weight:600;">Current Stock: <strong>${currentStock} pcs</strong></p>
            </div>
            
            <!-- Quantity Input -->
            <div style="margin-bottom:20px;">
              <label style="display:block; margin-bottom:8px; font-weight:600; font-size:14px; color:#0a0a0a;">Add Quantity (pcs)</label>
              <input type="number" id="restock-quantity" min="1" value="10" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; box-sizing:border-box;">
            </div>
            
            <!-- Action Buttons -->
            <div style="display:flex; gap:12px; justify-content:flex-end;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px; border:1px solid #e5e7eb; background:#f6f6f6; color:#0a0a0a; border-radius:8px; cursor:pointer; font-weight:600;">Cancel</button>
              <button id="restock-submit-btn" style="padding:12px 24px; border:none; background:#0a0a0a; color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">‚úì Restock</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        console.log('‚úì Modal appended to body');
        
        // Attach submit handler to button with stored data
        document.getElementById('restock-submit-btn').addEventListener('click', function() {
          submitVariantRestock(productId, variantId);
        });
        
        document.getElementById('restock-quantity').focus();
      }

      function submitVariantRestock(productId, variantId) {
        console.log('Submitting restock:', { productId, variantId });
        
        const quantity = parseInt(document.getElementById('restock-quantity').value);
        
        if (!quantity || quantity <= 0) {
          alert('Please enter a valid quantity');
          return;
        }
        
        if (!productId) {
          alert('Error: Product ID missing');
          return;
        }
        
        const submitBtn = document.getElementById('restock-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Processing...';
        
        const formData = new FormData();
        formData.append('product_id', productId);
        if (variantId) {
          formData.append('variant_id', variantId);
        }
        formData.append('quantity', quantity);
        
        console.log('FormData entries:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }
        
        fetch('/seller/restock', {
          method: 'POST',
          body: formData
        })
          .then(response => {
            console.log('Response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Response data:', data);
            if (data.success) {
              alert(`‚úÖ Restocked!\nAdded: ${quantity} pcs\nNew Stock: ${data.new_stock} pcs`);
              document.querySelectorAll('[style*="position:fixed"]').forEach(el => el.remove());
              loadInventory();
            } else {
              alert('‚ùå Failed: ' + (data.error || 'Unknown error'));
              submitBtn.disabled = false;
              submitBtn.textContent = '‚úì Restock';
            }
          })
          .catch(error => {
            console.error('Fetch error:', error);
            alert('Error: ' + error.message);
            submitBtn.disabled = false;
            submitBtn.textContent = '‚úì Restock';
          });
      }
      
      // ============ REVIEWS MANAGEMENT ============
      function loadReviews(filter = 'all') {
        fetch('/seller/reviews')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.reviews) {
              let reviews = data.reviews;
              
              if (filter === 'pending') {
                reviews = reviews.filter(r => !r.is_approved);
              }
              
              displayReviews(reviews);
            } else {
              document.getElementById('reviews-list').innerHTML = '<p style="color:#999;padding:40px;">No reviews found</p>';
            }
          })
          .catch(error => {
            document.getElementById('reviews-list').innerHTML = '<p style="color:#d32f2f;padding:40px;">Error loading reviews</p>';
          });
      }
      
      function displayReviews(reviews) {
        if (!reviews || reviews.length === 0) {
          document.getElementById('reviews-list').innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No reviews to display</p>';
          return;
        }
        
        let html = `<div style="display: grid; gap: 16px;">`;
        
        reviews.forEach(review => {
          const stars = '‚≠ê'.repeat(review.rating);
          const approvalBadge = review.is_approved ? 
            '<span class="status-badge status-active">Approved</span>' : 
            '<span class="status-badge status-pending">Pending</span>';
          
          html += `
            <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <strong style="font-size: 14px;">${review.product_name}</strong>
                  <p style="margin: 4px 0 0; color: #666; font-size: 13px;">by ${review.buyer_name}</p>
                </div>
                ${approvalBadge}
              </div>
              <div style="margin-bottom: 8px; font-size: 14px;">${stars}</div>
              <p style="margin: 0 0 12px; font-size: 14px; line-height: 1.5;">${review.comment}</p>
              <div style="display: flex; gap: 8px; font-size: 12px; color: #999;">
                <span>${new Date(review.created_at).toLocaleDateString()}</span>
              </div>
              ${!review.is_approved ? `
                <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button class="action-btn" onclick="approveReview(${review.id})" style="flex: 1; background: #10b981; color: #fff; padding: 8px 12px; font-size: 13px;">‚úì Approve</button>
                  <button class="action-btn" onclick="rejectReview(${review.id})" style="flex: 1; background: #ef4444; color: #fff; padding: 8px 12px; font-size: 13px;">‚úó Reject</button>
                </div>
              ` : ''}
            </div>
          `;
        });
        
        html += `</div>`;
        document.getElementById('reviews-list').innerHTML = html;
      }
      
      function filterReviews(filter) {
        document.querySelectorAll('[data-review-filter]').forEach(btn => btn.style.background = '#666');
        document.querySelector(`[data-review-filter="${filter}"]`).style.background = '#0a0a0a';
        loadReviews(filter);
      }
      
      function approveReview(reviewId) {
        fetch(`/seller/review/${reviewId}/approve`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Review approved');
              loadReviews();
            } else {
              alert('Error: ' + (data.error || 'Unknown error'));
            }
          });
      }
      
      function rejectReview(reviewId) {
        fetch(`/seller/review/${reviewId}/reject`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Review rejected');
              loadReviews();
            } else {
              alert('Error: ' + (data.error || 'Unknown error'));
            }
          });
      }
      
      // ============ PROMOTIONS MANAGEMENT ============
      function loadPromotions() {
        fetch('/seller/promotions')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              displayPromotions(data.promotions || []);
              loadProductsForPromotion();
            } else {
              document.getElementById('promotions-list').innerHTML = '<p style="color:#999;padding:40px;">No promotions found</p>';
            }
          })
          .catch(error => {
            document.getElementById('promotions-list').innerHTML = '<p style="color:#d32f2f;padding:40px;">Error loading promotions</p>';
          });
      }
      
      function displayPromotions(promotions) {
        if (!promotions || promotions.length === 0) {
          document.getElementById('promotions-list').innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No active promotions. Create one to get started!</p>';
          return;
        }
        
        let html = `<div style="display: grid; gap: 16px;">`;
        
        promotions.forEach(promo => {
          const isActive = new Date(promo.start_date) <= new Date() && new Date() <= new Date(promo.end_date);
          const discountText = promo.discount_type === 'percentage' ? `${promo.discount_value}%` : `‚Ç±${promo.discount_value}`;
          const isApproved = promo.is_approved;
          const statusColor = isApproved ? (isActive ? '#10b981' : '#fbbf24') : '#9ca3af';
          const statusText = isApproved ? (isActive ? 'Active' : 'Scheduled') : 'Pending Approval';
          
          html += `
            <div style="background: #f9f9f9; border-left: 4px solid ${statusColor}; border-radius: 8px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <strong style="font-size: 14px;">${promo.product_name}</strong>
                  <p style="margin: 4px 0 0; color: #666; font-size: 13px;">Discount: ${discountText}</p>
                  ${!isApproved ? '<p style="margin: 4px 0 0; color: #f59e0b; font-size: 12px; font-weight: 500;">‚è≥ Waiting for admin approval...</p>' : ''}
                </div>
                <span class="status-badge ${isApproved ? (isActive ? 'status-active' : 'status-pending') : 'status-pending'}">${statusText}</span>
              </div>
              <p style="margin: 0 0 12px; font-size: 13px; color: #666;">${promo.description || 'No description'}</p>
              <div style="display: flex; gap: 16px; font-size: 12px; color: #999;">
                <span>Start: ${new Date(promo.start_date).toLocaleDateString()}</span>
                <span>End: ${new Date(promo.end_date).toLocaleDateString()}</span>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                ${!isApproved ? `<button class="action-btn" disabled style="flex: 1; background: #ccc; color: #999; padding: 8px 12px; font-size: 13px; cursor: not-allowed;">‚úé Edit (pending approval)</button>` : `<button class="action-btn" onclick="editPromotion(${promo.id})" style="flex: 1; background: #2196f3; color: #fff; padding: 8px 12px; font-size: 13px;">‚úé Edit</button>`}
                <button class="action-btn" onclick="deletePromotion(${promo.id})" style="flex: 1; background: #ef4444; color: #fff; padding: 8px 12px; font-size: 13px;">üóë Delete</button>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
        document.getElementById('promotions-list').innerHTML = html;
      }
      
      function loadProductsForPromotion() {
        fetch('/seller/products')
          .then(response => response.json())
          .then(data => {
            if (data.products) {
              const select = document.getElementById('promo-product');
              select.innerHTML = '<option value="">Select a product</option>';
              data.products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name + ' (‚Ç±' + product.price + ')';
                select.appendChild(option);
              });
            }
          });
      }
      
      function openCreatePromotion() {
        document.getElementById('promotion-modal').style.display = 'flex';
        loadProductsForPromotion();
      }
      
      function closePromotionModal() {
        document.getElementById('promotion-modal').style.display = 'none';
        document.getElementById('promotion-form').reset();
      }
      
      function updateDiscountLabel() {
        // Label already shows in the form
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        const promotionForm = document.getElementById('promotion-form');
        if (promotionForm) {
          promotionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('product_id', document.getElementById('promo-product').value);
            formData.append('discount_type', document.getElementById('promo-discount-type').value);
            formData.append('discount_value', document.getElementById('promo-discount-value').value);
            formData.append('start_date', document.getElementById('promo-start-date').value);
            formData.append('end_date', document.getElementById('promo-end-date').value);
            formData.append('description', document.getElementById('promo-description').value);
            
            fetch('/seller/promotion/create', { method: 'POST', body: formData })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  // Show success alert
                  const productSelect = document.getElementById('promo-product');
                  const discountType = document.getElementById('promo-discount-type').value;
                  const discountValue = document.getElementById('promo-discount-value').value;
                  const selectedProduct = productSelect.options[productSelect.selectedIndex].text;
                  
                  const discountDisplay = discountType === 'percentage' ? `${discountValue}%` : `‚Ç±${discountValue}`;
                  
                  alert(`‚úÖ Promotion Submitted for Admin Approval!\n\nProduct: ${selectedProduct}\nDiscount: ${discountDisplay}\n\nStatus: Pending Review\n\nYou will receive an email once the admin approves or rejects your promotion.`);
                  closePromotionModal();
                  loadPromotions();
                } else {
                  alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(error => alert('‚ùå Error creating promotion: ' + error.message));
          });
        }
      });
      
      // Load categories for add-product form
      function loadCategories() {
        const categorySelect = document.getElementById('categorySelect');
        if (!categorySelect) return;
        
        fetch('/api/categories')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.categories) {
              categorySelect.innerHTML = '<option value="">Select a category</option>';
              data.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                option.dataset.slug = category.slug;
                categorySelect.appendChild(option);
              });
            }
          })
          .catch(error => console.error('Error loading categories:', error));
      }
      
      function loadSalesAnalytics() {
        fetch('/seller/sales-analytics')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update metric cards
              const revenue = data.analytics.total_revenue || 0;
              const orders = data.analytics.total_orders || 0;
              const avgOrder = data.analytics.avg_order_value || 0;
              
              document.getElementById('total-revenue').textContent = '‚Ç±' + parseFloat(revenue).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              document.getElementById('total-orders').textContent = orders;
              document.getElementById('avg-order').textContent = '‚Ç±' + parseFloat(avgOrder).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              
              // Display sales by product
              displaySalesByProduct(data.analytics.top_products || []);
            }
          })
          .catch(error => {
            console.error('Error loading sales analytics:', error);
            document.getElementById('sales-by-product').innerHTML = '<p style="color:#ef4444;">Error loading analytics</p>';
          });
      }

      function displaySalesByProduct(products) {
        if (!products || products.length === 0) {
          document.getElementById('sales-by-product').innerHTML = '<p style="color:#999;text-align:center;">No sales data available</p>';
          return;
        }

        let html = `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Product Name</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">Quantity</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">Revenue</th>
            </tr>
          </thead>
          <tbody>`;

        products.forEach((product, index) => {
          html += `<tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 10px;">${product.product_name}</td>
            <td style="padding: 10px; text-align: right;">${product.quantity_sold}</td>
            <td style="padding: 10px; text-align: right;">‚Ç±${parseFloat(product.product_revenue).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('sales-by-product').innerHTML = html;
      }

      function loadPerformance() {
        fetch('/seller/performance')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update metric cards
              const avgRating = data.performance.avg_rating || 0;
              const repeatCustomers = data.performance.repeat_customers || 0;
              const totalReviews = data.performance.total_reviews || 0;
              
              document.getElementById('avg-rating').textContent = parseFloat(avgRating).toFixed(1) + ' ‚≠ê';
              document.getElementById('repeat-customers').textContent = repeatCustomers;
              document.getElementById('total-reviews').textContent = totalReviews;
              
              // Display top rated products
              displayTopRatedProducts(data.performance.top_rated_products || []);
            }
          })
          .catch(error => {
            console.error('Error loading performance:', error);
            document.getElementById('top-rated-products').innerHTML = '<p style="color:#ef4444;">Error loading performance</p>';
          });
      }

      function displayTopRatedProducts(products) {
        if (!products || products.length === 0) {
          document.getElementById('top-rated-products').innerHTML = '<p style="color:#999;text-align:center;">No rated products available</p>';
          return;
        }

        let html = ``;
        products.forEach(product => {
          const stars = Array(Math.round(product.avg_rating)).fill('‚≠ê').join('');
          html += `
            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div>
                  <strong style="font-size: 13px; display: block;">${product.product_name}</strong>
                  <small style="color: #666; display: block;">${product.review_count} reviews</small>
                </div>
                <span style="font-size: 14px; font-weight: 700; color: #f59e0b;">${parseFloat(product.avg_rating).toFixed(1)}</span>
              </div>
              <div style="color: #666; font-size: 12px;">${stars}</div>
            </div>
          `;
        });

        document.getElementById('top-rated-products').innerHTML = html;
      }

      function loadBrandSettings() {
        fetch('/seller/brand-settings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              const settings = data.settings;
              document.getElementById('store-name').value = settings.store_name || '';
              document.getElementById('store-description').value = settings.description || '';
              document.getElementById('contact-email').value = settings.contact_email || '';
              document.getElementById('contact-phone').value = settings.contact_phone || '';
              document.getElementById('store-address').value = settings.address || '';
              document.getElementById('island-group').value = settings.island_group || 'Luzon';
            }
          })
          .catch(error => console.error('Error loading brand settings:', error));
      }

      function reloadBrandSettings() {
        loadBrandSettings();
        alert('‚úÖ Brand settings reloaded!');
      }

      function loadAccountSettings() {
        fetch('/seller/account-settings')
          .then(response => {
            console.log('Account settings response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Account settings data:', data);
            if (data.success) {
              const account = data.account;
              document.getElementById('account-username').textContent = account.username || 'User';
              document.getElementById('account-email').textContent = account.email || '';
              document.getElementById('full-name').value = account.full_name || '';
              document.getElementById('phone-number').value = account.phone_number || '';
              document.getElementById('email-address').value = account.email || '';
              
              // Reset OTP verification UI
              document.getElementById('otp-verification-section').style.display = 'none';
              document.getElementById('email-verified-message').style.display = 'none';
              document.getElementById('otp-code').value = '';
            } else {
              console.error('Account settings error:', data.error);
              document.getElementById('account-username').textContent = 'Error: ' + (data.error || 'Unknown error');
            }
          })
          .catch(error => {
            console.error('Error loading account settings:', error);
            document.getElementById('account-username').textContent = 'Error loading settings';
          });
      }

      function reloadAccountSettings() {
        loadAccountSettings();
        alert('‚úÖ Account settings reloaded!');
      }

      function sendEmailOTP() {
        const email = document.getElementById('email-address').value.trim();
        if (!email) {
          alert('‚ö†Ô∏è Please enter an email address');
          return;
        }
        
        if (!email.includes('@')) {
          alert('‚ö†Ô∏è Please enter a valid email address');
          return;
        }

        const btn = document.getElementById('verify-email-btn');
        btn.disabled = true;
        btn.textContent = 'Sending...';

        fetch('/send-otp', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email: email, verification_type: 'email', purpose: 'email_change'})
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ OTP code sent to ' + email);
            document.getElementById('otp-verification-section').style.display = 'block';
            document.getElementById('otp-code').focus();
          } else {
            alert('‚ùå Error: ' + (data.message || data.error || 'Could not send OTP'));
          }
          btn.disabled = false;
          btn.textContent = 'Verify Email';
        })
        .catch(error => {
          alert('‚ùå Error sending OTP: ' + error.message);
          btn.disabled = false;
          btn.textContent = 'Verify Email';
        });
      }

      function verifyEmailOTP() {
        const email = document.getElementById('email-address').value.trim();
        const otp = document.getElementById('otp-code').value.trim();
        
        if (!otp || otp.length !== 6) {
          alert('‚ö†Ô∏è Please enter a valid 6-digit OTP code');
          return;
        }

        const btn = document.getElementById('verify-otp-btn');
        btn.disabled = true;
        btn.textContent = 'Verifying...';

        fetch('/verify-otp', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({email: email, otp_code: otp, purpose: 'email_change'})
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Email verified successfully!');
            document.getElementById('otp-verification-section').style.display = 'none';
            document.getElementById('email-verified-message').style.display = 'block';
            document.getElementById('verify-email-btn').disabled = true;
            document.getElementById('verify-email-btn').textContent = '‚úì Verified';
          } else {
            alert('‚ùå Error: ' + (data.message || data.error || 'Invalid OTP code'));
          }
          btn.disabled = false;
          btn.textContent = 'Verify OTP';
        })
        .catch(error => {
          alert('‚ùå Error verifying OTP: ' + error.message);
          btn.disabled = false;
          btn.textContent = 'Verify OTP';
        });
      }

      function deletePromotion(promoId) {
        if (confirm('Are you sure you want to delete this promotion?')) {
          fetch(`/seller/promotion/${promoId}/delete`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert('Promotion deleted');
                loadPromotions();
              } else {
                alert('Error: ' + (data.error || 'Unknown error'));
              }
            });
        }
      }

      function loadProducts() {
        console.log('Loading products...');
        fetch('/seller/products')
          .then(response => {
            console.log('Response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Data received:', data);
            
            if (data.error) {
              document.getElementById('products-list').innerHTML = `<p style="color:#ef4444; text-align: center; padding: 20px;">‚ùå Error: ${data.error}</p>`;
              return;
            }
            
            if (data.products && data.products.length > 0) {
              let approvedCount = 0, pendingCount = 0;
              
              let html = `
                <div style="margin-bottom: 16px; display: flex; gap: 12px;">
                  <div style="background: #dcfce7; padding: 10px 16px; border-radius: 8px; border-left: 4px solid #22c55e;">
                    <small style="color: #666; display: block;">Approved</small>
                    <strong style="font-size: 18px; color: #15803d;" id="approved-count">0</strong>
                  </div>
                  <div style="background: #fef3c7; padding: 10px 16px; border-radius: 8px; border-left: 4px solid #eab308;">
                    <small style="color: #666; display: block;">Pending Approval</small>
                    <strong style="font-size: 18px; color: #b45309;" id="pending-count">0</strong>
                  </div>
                  <div style="background: #f3f4f6; padding: 10px 16px; border-radius: 8px; border-left: 4px solid #6b7280;">
                    <small style="color: #666; display: block;">Total Products</small>
                    <strong style="font-size: 18px; color: #374151;">${data.products.length}</strong>
                  </div>
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f3f4f6;">
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Product Name</th>
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">SKU</th>
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Price</th>
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Stock</th>
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Status</th>
                      <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                let statusText = '', statusClass = '', statusIcon = '';
                
                if (product.is_active === 1 || product.is_active === true) {
                  statusText = 'Approved ‚úì';
                  statusClass = 'status-active';
                  statusIcon = '‚úì';
                  approvedCount++;
                } else {
                  statusText = 'Pending Review';
                  statusClass = 'status-pending';
                  statusIcon = '‚è≥';
                  pendingCount++;
                }
                
                // Check for pending edits
                if (product.edit_status === 'pending' && product.pending_edits > 0) {
                  statusText = `Edit Pending (${product.pending_edits})`;
                  statusClass = 'status-pending';
                  statusIcon = '‚è≥';
                }
                
                console.log(`Product: ${product.name}, Active: ${product.is_active}, Stock: ${product.stock}`);
                
                html += `
                  <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb';" onmouseout="this.style.backgroundColor='';">
                    <td style="padding: 12px; border: 1px solid #e5e7eb;">
                      <div style="font-weight: 600; color: #0a0a0a;">${escapeHtml(product.name)}</div>
                      ${product.category_name ? `<div style="font-size: 12px; color: #777; margin-top: 2px;">${product.category_name}</div>` : ''}
                    </td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb; font-size: 13px; color: #666;">${product.sku || 'N/A'}</td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; color: #0a0a0a;">‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb;">
                      <div style="font-weight: 600; color: #0a0a0a;">${product.stock} pcs</div>
                      ${product.stock < 5 ? '<div style="font-size: 11px; color: #ef4444; margin-top: 2px;">‚ö† Low stock</div>' : ''}
                    </td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb;">
                      <span class="status-badge ${statusClass}" style="display: inline-flex; align-items: center; gap: 6px;">
                        ${statusIcon} ${statusText}
                      </span>
                    </td>
                    <td style="padding: 12px; border: 1px solid #e5e7eb;">
                      <div style="display: flex; gap: 6px;">
                        ${product.is_active ? `
                          <button class="action-btn" onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 12px;">Edit</button>
                          <button class="action-btn" onclick="archiveProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')" style="padding: 6px 12px; font-size: 12px; background: #ef4444;">Archive</button>
                        ` : '<span style="color: #999; font-size: 12px;">‚è≥ Awaiting</span>'}
                      </div>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('products-list').innerHTML = html;
              
              // Update counters
              document.getElementById('approved-count').textContent = approvedCount;
              document.getElementById('pending-count').textContent = pendingCount;
            } else {
              document.getElementById('products-list').innerHTML = '<div style="text-align:center;color:#999;padding:40px;"><p style="font-size:16px; margin-bottom: 16px;">üì¶ No products yet</p><p>Click the "+ Add Product" button to add your first product</p></div>';
            }
          })
          .catch(error => {
            console.error('Error:', error);
            document.getElementById('products-list').innerHTML = '<p style="color:#ef4444; text-align: center; padding: 20px;">‚ùå Error loading products: ' + error.message + '</p>';
          });
      }

      function escapeHtml(text) {
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      // Global variable to store original product data for comparison
      let originalProductData = {};

      function editProduct(productId) {
        loadPage('edit-product');
        
        fetch('/seller/product/' + productId)
          .then(response => response.json())
          .then(data => {
            if (data.product) {
              const product = data.product;
              originalProductData = JSON.parse(JSON.stringify(product)); // Deep copy
              
              const formHtml = `
                <form id="editProductForm" style="display: flex; flex-direction: column; gap: 16px;">
                  <input type="hidden" name="product_id" value="${product.id}">
                  
                  <div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 12px; border-radius: 8px; font-size: 14px;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Changes require admin approval before they appear on your store.
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Product Name</label>
                    <input type="text" id="edit_name" name="name" value="${product.name}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Description</label>
                    <textarea id="edit_description" name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>${product.description || ''}</textarea>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Price (‚Ç±)</label>
                      <input type="number" id="edit_price" name="price" value="${product.price}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                    </div>
                    
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Brand</label>
                      <input type="text" id="edit_brand" name="brand" value="${product.brand || ''}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Category</label>
                    <select id="edit_category_id" name="category_id" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                      <option value="">Select Category</option>
                      ${data.categories ? data.categories.map(cat => `<option value="${cat.id}" ${cat.id == product.category_id ? 'selected' : ''}>${cat.name}</option>`).join('') : ''}
                    </select>
                  </div>
                  
                  <div style="display: flex; gap: 12px; margin-top: 10px;">
                    <button type="button" class="action-btn" onclick="submitProductEdit()" style="padding: 12px 24px;">Submit for Approval</button>
                    <button type="button" class="action-btn" onclick="loadPage('products')" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                  </div>
                </form>
              `;
              
              document.getElementById('edit-product-form').innerHTML = formHtml;
            } else {
              document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
            }
          })
          .catch(error => {
            document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
          });
      }

      function submitProductEdit() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);
        
        // Compare with original data to find changes
        const changes = {};
        const fieldMap = {
          'name': 'Product Name',
          'description': 'Description',
          'price': 'Price',
          'brand': 'Brand',
          'category_id': 'Category'
        };
        
        for (let [key, label] of Object.entries(fieldMap)) {
          const newValue = formData.get(key);
          const oldValue = originalProductData[key]?.toString() || '';
          
          if (newValue !== oldValue) {
            changes[key] = {
              label: label,
              old: oldValue,
              new: newValue
            };
          }
        }
        
        if (Object.keys(changes).length === 0) {
          alert('No changes detected');
          return;
        }
        
        // Confirm changes with user
        let confirmMsg = 'You are requesting to change:\\n\\n';
        for (let [key, change] of Object.entries(changes)) {
          confirmMsg += `${change.label}: "${change.old}" ‚Üí "${change.new}"\\n`;
        }
        confirmMsg += '\\nThese changes will require admin approval. Continue?';
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        fetch('/seller/edit-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product edit submitted for admin approval!\\n\\nYour changes will be reviewed and applied once approved.');
            loadPage('products');
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error submitting edit request');
        });
      }

      function archiveProduct(productId, productName) {
        const reason = prompt(`Archive "${productName}"?\n\nOptional reason for archiving:`, '');
        if (reason === null) return;
        
        if (!confirm(`Are you sure you want to archive "${productName}"?\n\nArchived products will be hidden from your store and require admin approval to recover.`)) {
          return;
        }
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason);
        
        fetch('/seller/archive-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product archived successfully!');
            loadPage('products');
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error archiving product');
        });
      }
      
      function loadArchivedProducts() {
        fetch('/seller/archived-products')
          .then(response => response.json())
          .then(data => {
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>SKU</th>
                      <th>Price</th>
                      <th>Archived Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                const archivedDate = new Date(product.archived_at).toLocaleDateString();
                const statusText = product.archive_status === 'pending_recovery' ? 'Recovery Pending' : 'Archived';
                const statusClass = product.archive_status === 'pending_recovery' ? 'status-pending' : 'status-inactive';
                
                html += `
                  <tr>
                    <td>${product.name}</td>
                    <td>${product.sku || 'N/A'}</td>
                    <td>‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td style="font-size:13px;color:var(--muted)">${archivedDate}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                      ${product.archive_status === 'archived' ? 
                        `<button class="action-btn" onclick="requestRecovery(${product.id}, '${product.name}')" style="padding: 6px 12px; font-size: 12px; background: #10b981;">Request Recovery</button>` :
                        '<span style="color: #f59e0b; font-size: 12px;">‚è≥ Awaiting admin approval</span>'
                      }
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('archived-products-list').innerHTML = html;
            } else {
              document.getElementById('archived-products-list').innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No archived products</p>';
            }
          })
          .catch(error => {
            document.getElementById('archived-products-list').innerHTML = '<p style="color:#ef4444;">Error loading archived products</p>';
          });
      }
      
      function requestRecovery(productId, productName) {
        const reason = prompt(`Request recovery for "${productName}"?\n\nReason for recovery (required):`, '');
        if (!reason || reason.trim() === '') {
          if (reason !== null) alert('Please provide a reason for recovery');
          return;
        }
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason);
        
        fetch('/seller/request-recovery', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Recovery request submitted!\n\nAn admin will review your request.');
            loadArchivedProducts();
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error submitting recovery request');
        });
      }

      function updateStock(productId, currentStock) {
        const newStock = prompt(`Update stock for product (current: ${currentStock}):`, currentStock);
        if (newStock !== null && !isNaN(newStock)) {
          const formData = new FormData();
          formData.append('product_id', productId);
          formData.append('stock_quantity', newStock);
          
          fetch('/seller/update-stock', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Stock updated successfully!');
              // Reload current page
              const activePage = document.querySelector('.side-link.active')?.getAttribute('data-page');
              if (activePage) loadPage(activePage);
            } else {
              alert('Error updating stock: ' + data.error);
            }
          })
          .catch(error => {
            alert('Error updating stock');
          });
        }
      }

      // Add Product Sidebar Management
      function updateAddProductSidebar() {
        const sidebar = document.querySelector('.app.add-product-mode .sidebar');
        if (!sidebar) return;
        
        // Show the logo and navigation groups that were hidden
        const logo = sidebar.querySelector('.logo');
        const sideGroups = sidebar.querySelectorAll('.side-group');
        
        if (logo) logo.style.display = 'flex';
        sideGroups.forEach(group => {
          group.style.display = 'block';
        });
      }
      
      function clearAddProductSidebar() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar && !document.querySelector('.app').classList.contains('add-product-mode')) {
          const logo = sidebar.querySelector('.logo');
          const sideGroups = sidebar.querySelectorAll('.side-group');
          
          if (logo) logo.style.display = 'flex';
          sideGroups.forEach(group => {
            group.style.display = 'block';
          });
        }
      }

      // Optimized single event delegation for all sidebar links
      document.addEventListener('click', function(e) {
        const link = e.target.closest('.side-link');
        if (link) {
          const page = link.getAttribute('data-page');
          const href = link.getAttribute('href');
          
          // Only handle hash links with data-page attribute
          if (page && href === '#') {
            e.preventDefault();
            e.stopPropagation();
            loadPage(page);
          }
        }
      }, true); // Use capture phase for faster response

      // Image preview functionality
      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'productImages') {
          const files = e.target.files;
          const previewContainer = document.getElementById('imagePreviewContainer');
          previewContainer.innerHTML = ''; // Clear previous previews
          
          if (files.length > 0) {
            Array.from(files).forEach((file, index) => {
              if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  const previewItem = document.createElement('div');
                  previewItem.style.cssText = 'position: relative; border: 2px solid var(--line); border-radius: 8px; overflow: hidden; aspect-ratio: 1/1;';
                  
                  const img = document.createElement('img');
                  img.src = e.target.result;
                  img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                  
                  const badge = document.createElement('div');
                  badge.textContent = index === 0 ? 'Primary' : `${index + 1}`;
                  badge.style.cssText = `position: absolute; top: 4px; left: 4px; background: ${index === 0 ? '#0a0a0a' : '#666'}; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;`;
                  
                  previewItem.appendChild(img);
                  previewItem.appendChild(badge);
                  previewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
              }
            });
          }
        }
      });
    </script>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }

      // Fetch order count on page load
      document.addEventListener('DOMContentLoaded', function() {
        fetchOrderCount();
        // Refresh order count every 30 seconds
        setInterval(fetchOrderCount, 30000);
      });
    </script>
  </body>
</html>
