  <!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Seller Dashboard ‚Äî Var√≥n</title>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:#10b981;margin-left:8px}

      /* Chart placeholders */
      .grid.two{grid-template-columns:1.4fr 1fr}
      .chart{height:260px;padding:12px 14px}
      .bars{display:flex;align-items:flex-end;gap:10px;height:160px;margin-top:8px}
      .bar{flex:1;background:#0a0a0a;border-radius:6px}
      .legend{display:flex;justify-content:space-between;color:var(--muted);font-size:12px;margin-top:8px}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Product Management */
      .action-btn {
        background: #0a0a0a;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      .action-btn:hover {
        background: #2d2d2d;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      .action-btn:active {
        transform: translateY(0);
      }
      .status-badge {
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
      }
      .status-active {
        background: #dcfce7;
        color: #15803d;
      }
      .status-pending {
        background: #fef3c7;
        color: #92400e;
      }
      .status-inactive {
        background: #fee2e2;
        color: #991b1b;
      }

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Seller Dashboard</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Store Management</div>
          <a class="side-link active" href="#" data-page="overview">Overview</a>
          <a class="side-link" href="#" data-page="products">Products</a>
          <a class="side-link" href="#" data-page="add-product" style="padding-left: 24px; font-size: 14px;">+ Add Product</a>
          <a class="side-link" href="#" data-page="archived-products">Archived Products</a>
          <a class="side-link" href="#" data-page="orders">Orders</a>
          <a class="side-link" href="#" data-page="inventory">Inventory</a>
          <a class="side-link" href="#" data-page="reviews">Customer Reviews</a>
          <a class="side-link" href="#" data-page="promotions">Promotions</a>
        </div>
        <div class="side-group">
          <div class="side-title">Analytics</div>
          <a class="side-link" href="#" data-page="sales">Sales Analytics</a>
          <a class="side-link" href="#" data-page="performance">Performance</a>
        </div>
        <div class="side-group">
          <div class="side-title">Settings</div>
          <a class="side-link" href="#" data-page="store-settings">Store Settings</a>
          <a class="side-link" href="#" data-page="account">Account</a>
          <a class="side-link" href="#" onclick="confirmLogout(event)">Logout</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Store Dashboard</div>
          <div class="search"><input placeholder="Search products, orders..."/></div>
          <div class="avatar">
            <span class="tag store-name">{{ seller.store_name if seller else 'Your Store Name' }}</span>
            <span class="tag status-badge {% if seller and seller.status == 'approved' %}status-active{% else %}status-pending{% endif %}">
              {{ seller.status.title() if seller else 'Pending' }}
            </span>
          </div>
        </div>

        <main class="main" id="dashboardContent">
          <!-- Stat cards -->
          <div class="grid stats">
            <div class="card">
              <div class="inner">
                <div class="metric">Today's Sales</div>
                <div class="value">‚Ç±{{ "{:,.2f}".format(today_sales if today_sales else 0) }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Pending Orders</div>
                <div class="value">{{ pending_orders if pending_orders else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Products</div>
                <div class="value">{{ product_count if product_count else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Rating</div>
                <div class="value">{{ "{:.1f}".format(seller.rating if seller and seller.rating else 0) }}</div>
              </div>
            </div>
          </div>

          <!-- Charts row -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div class="metric">Weekly Sales Overview</div>
                <div class="chart">
                  <div class="bars">
                    {% for day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                    <div class="bar" style="height:{{ ((weekly_sales[day] / max_weekly_sales) * 100)|int if weekly_sales[day] > 0 else 5 }}%"></div>
                    {% endfor %}
                  </div>
                  <div class="legend">
                    <span>Sun</span>
                    <span>Mon</span>
                    <span>Tue</span>
                    <span>Wed</span>
                    <span>Thu</span>
                    <span>Fri</span>
                    <span>Sat</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div class="metric">Top Performing Products</div>
                  <button class="action-btn" onclick="loadPage('add-product')" style="padding: 6px 12px; font-size: 12px;">+ Add Product</button>
                </div>
                <div style="margin-top:10px" id="topProducts">
                  {% if top_products and top_products|length > 0 %}
                    {% set max_sales = (top_products[0].sales_count if (top_products and top_products[0].sales_count) else 1) %}
                    {% for product in top_products[:3] %}
                      {% if not loop.first %}
                      <div style="height:16px"></div>
                      {% endif %}
                      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                        <div>{{ product.name }}</div>
                        <div class="tag" style="background:#efefef;color:#0a0a0a">{{ product.sales_count or 0 }} sold</div>
                      </div>
                      <div style="height:6px;background:#efefef;border-radius:999px;overflow:hidden">
                        <div style="height:6px;background:#0a0a0a;border-radius:999px;width:{{ ((product.sales_count / max_sales if max_sales > 0 else 0) * 100)|int ~ '%' }};"></div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p style="text-align:center;color:#999;padding:20px;">No sales data yet. <a href="#" onclick="loadPage('add-product')" style="color:#0a0a0a;text-decoration:underline;">Add your first product</a></p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Orders and Low Stock -->
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Orders</div>
                  <a href="#" class="action-btn" onclick="loadPage('orders'); return false;">Process Orders</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_orders %}
                        {% for order in recent_orders %}
                        <tr>
                          <td>{{ order.order_number }}</td>
                          <td>{{ order.first_name }} {{ order.last_name }}</td>
                          <td>{{ order.products[:30] }}...</td>
                          <td>‚Ç±{{ "{:,.2f}".format(order.total_amount) }}</td>
                          <td><span class="status-badge status-{{ 'active' if order.order_status == 'delivered' else 'pending' }}">{{ order.order_status.title() }}</span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent orders</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Low Stock Alert</div>
                  <a href="#" class="action-btn" onclick="loadPage('inventory'); return false;">Restock Now</a>
                </div>
                <div style="margin-top:10px">
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Stock</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if low_stock %}
                        {% for product in low_stock %}
                        <tr>
                          <td>{{ product.name }}</td>
                          <td>{{ product.stock_quantity }} pcs</td>
                          <td><span class="status-badge {% if product.stock_quantity <= 3 %}status-inactive{% else %}status-pending{% endif %}">
                            {% if product.stock_quantity <= 3 %}Critical{% else %}Low{% endif %}
                          </span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="3" style="text-align:center;color:#999">All products in stock</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
      </section>
    </div>
    <script>
      // Page content templates
      const pageTemplates = {
        'add-product': `
          <div class="card">
            <div class="inner" style="max-width: 800px; margin: 0 auto;">
              <h2 style="margin: 0 0 20px;">Add New Product</h2>
              <form id="addProductForm" action="/seller/add-product" method="POST" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 16px;">
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Product Name *</label>
                  <input type="text" name="name" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Enter product name">
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Description</label>
                  <textarea name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Product description"></textarea>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Category/Genre *</label>
                  <select id="categorySelect" name="category" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" onchange="toggleSizeColorSections()">
                    <option value="">Select a category</option>
                    <option value="suits-blazers">Suits & Blazers</option>
                    <option value="shoes-accessories">Shoes & Accessories</option>
                    <option value="outerwear-jackets">Outerwear & Jackets</option>
                    <option value="grooming">Grooming Products</option>
                    <option value="casual-shirts-pants">Casual Shirts & Pants</option>
                    <option value="activewear-fitness">Activewear & Fitness</option>
                  </select>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Product Images *</label>
                  <input type="file" id="productImages" name="product_images" accept="image/*" multiple required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                  <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Upload multiple product images (JPG, PNG, max 5MB each). First image will be the primary image.</small>
                  
                  <!-- Image Preview Area -->
                  <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-top: 12px;">
                    <!-- Previews will be inserted here -->
                  </div>
                </div>
                
                <div>
                  <label style="display: block; margin-bottom: 6px; font-weight: 500;">Price (‚Ç±) *</label>
                  <input type="number" name="price" step="0.01" required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="0.00">
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Brand Name</label>
                    <input type="text" name="brand" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="e.g. Nike, Adidas, Uniqlo">
                    <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">The manufacturer/brand of the product</small>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">SKU</label>
                    <input type="text" name="sku" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" placeholder="Product SKU (optional)">
                    <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Stock Keeping Unit for inventory tracking</small>
                  </div>
                </div>
                
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa;" id="colorsSection">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Available Colors *</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Select colors available for this product. Each color can have its own sizes.</small>
                  <div id="colorSelectors" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Black" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Black</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="White" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>White</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Gray" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Gray</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Navy" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Navy</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Blue" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Blue</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Red" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Red</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Green" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Green</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Brown" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Brown</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Beige" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Beige</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                      <input type="checkbox" name="colors" value="Khaki" style="margin-right: 6px;" onchange="updateStockInputs()">
                      <span>Khaki</span>
                    </label>
                  </div>
                  <div style="margin-top: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Add Custom Color(s)</label>
                    <input type="text" id="custom-colors" placeholder="e.g. Burgundy, Olive, Charcoal (comma-separated)" 
                      style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px;" onchange="updateStockInputs()">
                    <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Enter custom colors separated by commas if not listed above</small>
                  </div>
                </div>
                
                <div style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa;" id="sizesSection">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Sizes per Color</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">For each color, select which sizes are available. Each color can have different sizes.</small>
                  <div id="colorSizesList"></div>
                  <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line);">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500;">Add Custom Size(s) (for all colors)</label>
                    <input type="text" id="custom-sizes" placeholder="e.g. 4XL, 5XL, 28W, 32W (comma-separated)" 
                      style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px;" onchange="updateStockInputs()">
                    <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Enter custom sizes separated by commas. These will be available as options for all colors.</small>
                  </div>
                </div>
                
                <div id="size-color-stocks" style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #f0f9ff;">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Stock per Size & Color</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Enter stock quantity for each size-color combination</small>
                  <div id="stock-inputs" style="display: grid; gap: 8px;">
                    <p style="color: var(--muted); font-style: italic;">Select sizes and colors above to set stock quantities</p>
                  </div>
                </div>
                
                <div id="ingredientsSection" style="border: 1px solid var(--line); border-radius: 8px; padding: 16px; background: #fafafa; display: none;">
                  <h3 style="margin: 0 0 12px; font-size: 16px;">Ingredients *</h3>
                  <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">List all key ingredients in this grooming product</small>
                  <textarea id="ingredients" name="ingredients" rows="5" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; font-family: monospace; font-size: 13px;" placeholder="e.g. Aloe Vera&#10;Vitamin E&#10;Coconut Oil&#10;Tea Tree Extract&#10;Shea Butter"></textarea>
                  <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 6px;">Enter one ingredient per line. Include all active ingredients and major components.</small>
                </div>
                
                <input type="hidden" name="custom-sizes" id="custom-sizes-hidden">
                <input type="hidden" name="custom-colors" id="custom-colors-hidden">
                
                <div style="display: flex; gap: 12px; margin-top: 10px;">
                  <button type="button" class="action-btn" style="padding: 12px 24px;" onclick="confirmAddProduct()">Add Product</button>
                  <button type="button" class="action-btn" onclick="loadPage('products')" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                </div>
              </form>
            </div>
          </div>
        `,
        
        'products': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">All Products</h2>
                <button class="action-btn" onclick="loadPage('add-product')">+ Add Product</button>
              </div>
              <div id="products-list">Loading products...</div>
            </div>
          </div>
        `,
        
        'edit-product': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Edit Product</h2>
              <div id="edit-product-form">Loading product...</div>
            </div>
          </div>
        `,
        
        'archived-products': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2 style="margin: 0;">üóÑÔ∏è Archived Products</h2>
              </div>
              <div id="archived-products-list">Loading archived products...</div>
            </div>
          </div>
        `,
        
        'inventory': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Inventory Management</h2>
              <div id="inventory-list">Loading inventory...</div>
            </div>
          </div>
        `,
        
        'orders': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Order Management</h2>
              
              <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="action-btn" data-filter-btn="all" onclick="filterOrders('all')" style="background: #0a0a0a; color: #fff; padding: 8px 16px; font-size: 13px;">
                  üìã All Orders
                </button>
                <button class="action-btn" data-filter-btn="pending" onclick="filterOrders('pending')" style="background: #ff9800; color: #fff; padding: 8px 16px; font-size: 13px;">
                  ‚è≥ Pending
                </button>
                <button class="action-btn" data-filter-btn="confirmed" onclick="filterOrders('confirmed')" style="background: #2196f3; color: #fff; padding: 8px 16px; font-size: 13px;">
                  ‚úîÔ∏è Confirmed
                </button>
                <button class="action-btn" data-filter-btn="processing" onclick="filterOrders('processing')" style="background: #ff5722; color: #fff; padding: 8px 16px; font-size: 13px;">
                  üîÑ Processing
                </button>
                <button class="action-btn" data-filter-btn="shipped" onclick="filterOrders('shipped')" style="background: #4caf50; color: #fff; padding: 8px 16px; font-size: 13px;">
                  üì¶ Shipped
                </button>
              </div>
              
              <div id="orders-list" style="overflow-x: auto;">
                <p style="color: #999;">Click a status filter to view orders...</p>
              </div>
            </div>
          </div>
        `,
        
        'reviews': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Customer Reviews</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Customer reviews coming soon...</p>
            </div>
          </div>
        `,
        
        'promotions': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Promotions</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Promotions management coming soon...</p>
            </div>
          </div>
        `,
        
        'sales': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Sales Analytics</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Sales analytics coming soon...</p>
            </div>
          </div>
        `,
        
        'performance': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Performance</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Performance metrics coming soon...</p>
            </div>
          </div>
        `,
        
        'store-settings': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Store Settings</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Store settings coming soon...</p>
            </div>
          </div>
        `,
        
        'account': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Account Settings</h2>
              <p style="color: var(--muted); padding: 40px; text-align: center;">Account settings coming soon...</p>
            </div>
          </div>
        `,
        
        'overview': null  // Special case - will reload page
      };

      // Function to toggle size and color sections based on category
      function toggleSizeColorSections() {
        const categorySelect = document.getElementById('categorySelect');
        const sizesSection = document.getElementById('sizesSection');
        const colorsSection = document.getElementById('colorsSection');
        const stockSection = document.getElementById('size-color-stocks');
        const ingredientsSection = document.getElementById('ingredientsSection');
        const ingredientsInput = document.getElementById('ingredients');
        
        if (categorySelect && sizesSection && colorsSection && stockSection) {
          if (categorySelect.value === 'grooming') {
            // Hide sizes, colors, and stock sections for grooming products
            sizesSection.style.display = 'none';
            colorsSection.style.display = 'none';
            stockSection.style.display = 'none';
            
            // Show ingredients section for grooming products
            if (ingredientsSection) {
              ingredientsSection.style.display = 'block';
              if (ingredientsInput) ingredientsInput.required = true;
            }
            
            // Remove required attribute from checkboxes
            document.querySelectorAll('input[name="sizes"], input[name="colors"]').forEach(input => {
              input.removeAttribute('required');
            });
          } else {
            // Show sections for other categories
            sizesSection.style.display = 'block';
            colorsSection.style.display = 'block';
            stockSection.style.display = 'block';
            
            // Hide ingredients section for non-grooming products
            if (ingredientsSection) {
              ingredientsSection.style.display = 'none';
              if (ingredientsInput) ingredientsInput.required = false;
            }
            
            // Update custom sizes placeholder based on category
            const customSizesInput = document.getElementById('custom-sizes');
            if (customSizesInput) {
              if (categorySelect.value === 'shoes-accessories') {
                customSizesInput.placeholder = 'e.g. 5, 5.5, 13.5, 14, 15 (comma-separated)';
              } else {
                customSizesInput.placeholder = 'e.g. 4XL, 5XL, 28W, 32W (comma-separated)';
              }
            }
            
            // Refresh size options when category changes
            updateStockInputs();
          }
        }
      }

      // Function to copy custom values to hidden inputs before form submission
      function submitCustomValues() {
        const customSizes = document.getElementById('custom-sizes');
        const customColors = document.getElementById('custom-colors');
        const customSizesHidden = document.getElementById('custom-sizes-hidden');
        const customColorsHidden = document.getElementById('custom-colors-hidden');
        
        if (customSizes && customSizesHidden) {
          customSizesHidden.value = customSizes.value;
        }
        if (customColors && customColorsHidden) {
          customColorsHidden.value = customColors.value;
        }
        
        return true;
      }
      
      // Function to confirm product addition
      function confirmAddProduct() {
        const form = document.getElementById('addProductForm');
        const categorySelect = document.getElementById('categorySelect');
        const nameInput = form.elements['name'];
        const priceInput = form.elements['price'];
        
        // Validate required fields
        if (!form.checkValidity()) {
          alert('‚ùå Please fill in all required fields');
          return;
        }
        
        // For non-grooming products, validate stock combinations
        if (categorySelect.value !== 'grooming') {
          const validation = validateStockQuantities();
          if (!validation.valid) {
            alert(validation.errors.join('\n'));
            return;
          }
        }
        
        const productName = nameInput.value.trim();
        const productPrice = parseFloat(priceInput.value);
        const category = categorySelect.options[categorySelect.selectedIndex].text;
        
        let confirmMsg = `Are you sure you want to add this product?\n\n`;
        confirmMsg += `üì¶ Product Name: ${productName}\n`;
        confirmMsg += `üè∑Ô∏è Category: ${category}\n`;
        confirmMsg += `üí∞ Price: ‚Ç±${productPrice.toFixed(2)}\n`;
        
        if (categorySelect.value !== 'grooming') {
          const validation = validateStockQuantities();
          confirmMsg += `üìä Total Stock: ${validation.totalStock} units\n`;
        }
        
        confirmMsg += `\nThis product will be submitted for admin approval.`;
        
        if (confirm(confirmMsg)) {
          submitProductViaAJAX();
        }
      }
      
      // Function to submit product via AJAX
      function submitProductViaAJAX() {
        const form = document.getElementById('addProductForm');
        const categorySelect = document.getElementById('categorySelect');
        
        // Validate form before submitting
        if (!form.checkValidity()) {
          alert('‚ùå Please fill in all required fields correctly');
          return;
        }
        
        // For non-grooming products, validate stock
        if (categorySelect.value !== 'grooming') {
          const validation = validateStockQuantities();
          if (!validation.valid) {
            alert(validation.errors.join('\n'));
            return;
          }
          // Serialize stock data to hidden field
          serializeStockData();
        }
        
        // Copy custom sizes and colors to hidden inputs first
        submitCustomValues();
        
        // Show loading state
        const submitBtn = document.querySelector('button[onclick="confirmAddProduct()"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Adding Product...';
        
        const formData = new FormData(form);
        
        console.log('üì§ Submitting product form...');
        console.log('Form fields:', Array.from(formData.entries()));
        
        fetch('/seller/add-product', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('üì• Response status:', response.status);
          return response.json().then(data => ({
            status: response.status,
            data: data
          }));
        })
        .then(({ status, data }) => {
          console.log('‚úÖ Response data:', data);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          
          if (status === 200 && data.success) {
            // Success - product added to pending approval
            alert('‚úÖ Product submitted successfully!\n\nYour product has been added to the admin queue for approval.\n\nOnce approved, it will appear in your store.');
            // Clear form
            form.reset();
            // Reset category to trigger size/color sections
            document.getElementById('categorySelect').value = '';
            toggleSizeColorSections();
            // Load products list
            loadPage('products');
          } else if (status === 400) {
            // Validation error
            alert('‚ùå Validation Error:\n\n' + data.error);
          } else if (data.error) {
            // Server error
            alert('‚ùå Error adding product:\n\n' + data.error);
          } else {
            alert('‚ùå Unexpected error occurred. Please try again.');
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          console.error('‚ùå Request error:', error);
          alert('‚ùå Network error: ' + error.message + '\n\nPlease check your connection and try again.');
        });
      }
      
      // ============ STOCK COMBINATIONS DATA STRUCTURE ============
      // Global storage for size-color-stock combinations
      // Data structure: Map<color, {sizes: [], stocks: {sizeKey: qty}}>
      // This enables independent color-to-sizes mapping
      window.productStockData = {};
      
      /**
       * Get all available sizes (predefined + custom)
       * These are the pool of sizes that can be selected for each color
       */
      function getAllAvailableSizes() {
        // Check if Shoes & Accessories category is selected
        const categorySelect = document.getElementById('categorySelect');
        const isShoeCategory = categorySelect && categorySelect.value === 'shoes-accessories';
        
        // Use US shoe sizes for shoes, clothing sizes for other categories
        const predefinedSizes = isShoeCategory 
          ? ['6', '6.5', '7', '7.5', '8', '8.5', '9', '9.5', '10', '10.5', '11', '11.5', '12', '12.5', '13']
          : ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL'];
        
        const customSizesInput = document.getElementById('custom-sizes');
        let customSizes = [];
        
        if (customSizesInput && customSizesInput.value.trim()) {
          customSizes = customSizesInput.value
            .split(',')
            .map(s => s.trim())
            .filter(s => s && s.length > 0);
        }
        
        return [...new Set([...predefinedSizes, ...customSizes])];
      }
      
      /**
       * Get all selected colors (predefined + custom)
       * @returns {string[]} Array of unique color values
       */
      function getAllSelectedColors() {
        // Predefined colors
        const colors = Array.from(document.querySelectorAll('input[name="colors"]:checked')).map(cb => cb.value);
        
        // Custom colors
        const customColorsInput = document.getElementById('custom-colors');
        if (customColorsInput && customColorsInput.value.trim()) {
          const customColors = customColorsInput.value
            .split(',')
            .map(c => c.trim())
            .filter(c => c && c.length > 0);
          colors.push(...customColors);
        }
        
        // Remove duplicates and return
        return [...new Set(colors)];
      }
      
      /**
       * Get sizes selected for a specific color
       */
      function getSizesForColor(color) {
        const sizeCheckboxes = document.querySelectorAll(`input[data-color-size="${color}"]:checked`);
        return Array.from(sizeCheckboxes).map(cb => cb.value);
      }
      
      /**
       * Generate a unique key for size-color combination
       * @param {string} size - Size value
       * @param {string} color - Color value
       * @returns {string} Unique key
       */
      function generateCombinationKey(size, color) {
        return `${size}|${color}`;
      }
      
      /**
       * Serialize stock data to hidden input for form submission
       * Converts to array of objects: [{size, color, stock_qty}, ...]
       */
      function serializeStockData() {
        const stockArray = [];
        const stockInputs = document.querySelectorAll('input[data-combination]');
        
        stockInputs.forEach(input => {
          const qty = parseInt(input.value) || 0;
          if (qty > 0) {
            const key = input.dataset.combination;
            const [size, color] = key.split('|');
            stockArray.push({
              size: size,
              color: color,
              stock_qty: qty
            });
          }
        });
        
        // Store in hidden field
        const hiddenInput = document.getElementById('stock-data-hidden') || createHiddenStockInput();
        hiddenInput.value = JSON.stringify(stockArray);
        
        console.log('üì¶ Stock Data Serialized:', stockArray);
        return stockArray;
      }
      
      /**
       * Create hidden input for stock data if it doesn't exist
       */
      function createHiddenStockInput() {
        const existingInput = document.getElementById('stock-data-hidden');
        if (existingInput) return existingInput;
        
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.id = 'stock-data-hidden';
        hiddenInput.name = 'stock_data';
        hiddenInput.value = '[]';
        
        const form = document.getElementById('addProductForm');
        if (form) {
          form.appendChild(hiddenInput);
        }
        
        return hiddenInput;
      }
      
      /**
       * Render size selectors for each selected color
       * This shows a per-color UI where users can pick different sizes for each color
       */
      function renderColorSizeSelectors() {
        const colors = getAllSelectedColors();
        const allAvailableSizes = getAllAvailableSizes();
        const colorSizesList = document.getElementById('colorSizesList');
        
        if (!colorSizesList) return;
        
        if (colors.length === 0) {
          colorSizesList.innerHTML = '<p style="color: var(--muted); font-style: italic;">Select at least one color above</p>';
          return;
        }
        
        // PRESERVE CHECKED STATE: Save which checkboxes are currently checked before re-rendering
        const checkedState = {};
        const existingCheckboxes = colorSizesList.querySelectorAll('input[data-color-size]');
        existingCheckboxes.forEach(checkbox => {
          const color = checkbox.getAttribute('data-color-size');
          const size = checkbox.value;
          const key = `${color}|${size}`;
          checkedState[key] = checkbox.checked;
        });
        
        let html = '';
        
        colors.forEach(color => {
          html += `
            <div style="margin-bottom: 16px; padding: 12px; background: white; border: 1px solid var(--line); border-radius: 6px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">üìç ${color}</label>
              <small style="color: var(--muted); font-size: 11px; display: block; margin-bottom: 8px;">Select which sizes are available in ${color}</small>
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px;">
          `;
          
          allAvailableSizes.forEach(size => {
            const key = `${color}|${size}`;
            const isChecked = checkedState[key] || false;
            const checkedAttr = isChecked ? 'checked' : '';
            
            html += `
              <label style="display: flex; align-items: center; cursor: pointer; padding: 6px; border-radius: 4px; background: #f5f5f5;">
                <input 
                  type="checkbox" 
                  data-color-size="${color}" 
                  value="${size}" 
                  style="margin-right: 4px;"
                  ${checkedAttr}
                  onchange="updateStockInputs()"
                >
                <span style="font-size: 13px;">${size}</span>
              </label>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        colorSizesList.innerHTML = html;
        
        // Attach event listeners to dynamically created checkboxes
        const sizeCheckboxes = colorSizesList.querySelectorAll('input[data-color-size]');
        sizeCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', updateStockInputs);
        });
      }
      
      /**
       * Validate that all combinations have stock quantities > 0
       * @returns {object} {valid: boolean, errors: string[]}
       */
      function validateStockQuantities() {
        const errors = [];
        const colors = getAllSelectedColors();
        
        if (colors.length === 0) {
          errors.push('‚ùå Please select at least one color');
        }
        
        // Check that each color has at least one size
        colors.forEach(color => {
          const colorSizes = getSizesForColor(color);
          if (colorSizes.length === 0) {
            errors.push(`‚ùå Please select at least one size for ${color}`);
          }
        });
        
        if (errors.length > 0) {
          return { valid: false, errors };
        }
        
        // Check that all combinations have stock > 0
        let totalStock = 0;
        const missingStocks = [];
        
        colors.forEach(color => {
          const colorSizes = getSizesForColor(color);
          colorSizes.forEach(size => {
            const key = generateCombinationKey(size, color);
            const input = document.querySelector(`input[data-combination="${key}"]`);
            
            if (!input) {
              missingStocks.push(`${size} - ${color}`);
            } else {
              const qty = parseInt(input.value) || 0;
              if (qty <= 0) {
                missingStocks.push(`${size} - ${color} (qty: ${qty})`);
              } else {
                totalStock += qty;
              }
            }
          });
        });
        
        if (missingStocks.length > 0) {
          errors.push(`‚ùå Stock quantity required for: ${missingStocks.join(', ')}`);
        }
        
        if (totalStock === 0) {
          errors.push('‚ùå Total stock must be greater than 0');
        }
        
        console.log('‚úÖ Stock Validation Complete | Total Stock:', totalStock, '| Errors:', errors.length);
        
        return {
          valid: errors.length === 0,
          errors: errors,
          totalStock: totalStock
        };
      }
      
      /**
       * Update stock table based on selected sizes and colors
       * MAIN FUNCTION - Handles all dynamic updates
       * Now generates combinations based on per-color size selections
       */
      function updateStockInputs() {
        console.log('üîÑ Updating stock inputs table...');
        
        // First render the per-color size selectors
        renderColorSizeSelectors();
        
        const colors = getAllSelectedColors();
        const stockInputsDiv = document.getElementById('stock-inputs');
        
        if (!stockInputsDiv) {
          console.warn('‚ö†Ô∏è stock-inputs div not found');
          return;
        }
        
        // No color selections
        if (colors.length === 0) {
          stockInputsDiv.innerHTML = `
            <div style="padding: 20px; text-align: center; color: var(--muted);">
              <p style="margin: 0; font-style: italic;">üì¶ Select at least one color above to get started</p>
            </div>
          `;
          return;
        }
        
        // Build table with per-color sizes
        let html = `
          <div style="max-height: 500px; overflow-y: auto; border: 1px solid var(--line); border-radius: 6px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: #e5e7eb; position: sticky; top: 0; z-index: 10;">
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line); font-weight: 600;">Size</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line); font-weight: 600;">Color</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line); font-weight: 600;">Stock Qty</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        let combinationCount = 0;
        
        // Generate combinations based on per-color size selections
        colors.forEach(color => {
          const colorSizes = getSizesForColor(color);
          
          // Each color only shows its own sizes
          colorSizes.forEach(size => {
            const key = generateCombinationKey(size, color);
            combinationCount++;
            
            // Preserve existing value if it exists
            let existingValue = 0;
            const existingInput = document.querySelector(`input[data-combination="${key}"]`);
            if (existingInput) {
              existingValue = existingInput.value;
            }
            
            html += `
              <tr style="border-bottom: 1px solid var(--line); transition: background 0.2s;">
                <td style="padding: 10px; border-right: 1px solid var(--line);">
                  <span style="font-weight: 500;">${size}</span>
                </td>
                <td style="padding: 10px; border-right: 1px solid var(--line);">
                  <span style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">${color}</span>
                </td>
                <td style="padding: 10px;">
                  <input 
                    type="number" 
                    data-combination="${key}"
                    name="stock_quantity"
                    min="0" 
                    max="9999"
                    value="${existingValue}" 
                    placeholder="0"
                    style="width: 70px; padding: 6px 8px; border: 1px solid var(--line); border-radius: 4px; font-size: 13px;"
                    onchange="validateStockQuantities()"
                  >
                </td>
              </tr>
            `;
          });
        });
        
        html += `
              </tbody>
            </table>
          </div>
          <div style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 6px; border-left: 4px solid #3b82f6;">
            <small style="color: #1e40af; font-weight: 500;">
              üìä ${combinationCount} combination(s) ‚Ä¢ Enter stock qty for each combination above
            </small>
          </div>
        `;
        
        stockInputsDiv.innerHTML = html;
        console.log(`‚úÖ Generated ${combinationCount} size-color combinations`);
      }

      function loadPage(page) {
        const content = document.getElementById('dashboardContent');
        
        // Immediate UI updates first
        const links = document.querySelectorAll('.side-link');
        links.forEach(l => l.classList.remove('active'));
        const activeLink = document.querySelector(`[data-page="${page}"]`);
        if (activeLink) activeLink.classList.add('active');
        
        // Update page title immediately
        const pageNames = {
          'overview': 'Store Dashboard',
          'add-product': 'Add New Product',
          'products': 'Products',
          'archived-products': 'Archived Products',
          'inventory': 'Inventory',
          'orders': 'Order Management',
          'reviews': 'Customer Reviews',
          'promotions': 'Promotions',
          'sales': 'Sales Analytics',
          'performance': 'Performance',
          'store-settings': 'Store Settings',
          'account': 'Account'
        };
        const titleEl = document.querySelector('.page-title');
        if (titleEl) titleEl.textContent = pageNames[page] || 'Seller Dashboard';
        
        // Special handling for overview page - reload the page to get server-side data
        if (page === 'overview') {
          window.location.href = '/seller-dashboard';
          return;
        }
        
        // Load content instantly
        if (pageTemplates[page]) {
          content.innerHTML = pageTemplates[page];
          
          // Use requestAnimationFrame for non-blocking event listener setup
          requestAnimationFrame(() => {
            if (page === 'products') {
              loadProducts();
            } else if (page === 'archived-products') {
              loadArchivedProducts();
            } else if (page === 'inventory') {
              loadInventory();
            } else if (page === 'orders') {
              loadOrders('all');
            } else if (page === 'add-product') {
              // Attach event listeners for size/color checkboxes
              const sizeColorInputs = document.querySelectorAll('input[name="sizes"], input[name="colors"]');
              sizeColorInputs.forEach(checkbox => {
                checkbox.addEventListener('change', updateStockInputs);
              });
              
              // Attach event listeners for custom size/color inputs
              const customSizesInput = document.getElementById('custom-sizes');
              const customColorsInput = document.getElementById('custom-colors');
              
              if (customSizesInput) {
                customSizesInput.addEventListener('input', updateStockInputs);
                customSizesInput.addEventListener('blur', updateStockInputs);
              }
              
              if (customColorsInput) {
                customColorsInput.addEventListener('input', updateStockInputs);
                customColorsInput.addEventListener('blur', updateStockInputs);
              }
            }
          });
        }
      }

      // ============ ORDER MANAGEMENT FUNCTIONS ============
      let allOrders = [];
      let currentOrderFilter = 'all';

      function filterOrders(status) {
        console.log('üìã Filtering orders by status:', status);
        currentOrderFilter = status;
        
        // Update active button
        const buttons = document.querySelectorAll('[data-filter-btn]');
        buttons.forEach(btn => btn.classList.remove('active'));
        document.querySelector(`[data-filter-btn="${status}"]`)?.classList.add('active');
        
        // Filter and display orders
        let filteredOrders = allOrders;
        if (status !== 'all') {
          filteredOrders = allOrders.filter(order => order.order_status === status);
        }
        
        displayOrders(filteredOrders);
      }

      function loadOrders(initialFilter = 'all') {
        console.log('üì§ Fetching orders from /seller/orders');
        
        fetch('/seller/orders')
          .then(response => {
            console.log('üì• Response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Orders loaded:', data);
            
            if (data.orders && Array.isArray(data.orders)) {
              allOrders = data.orders;
              filterOrders(initialFilter);
            } else {
              console.warn('‚ùå No orders in response');
              document.getElementById('orders-list').innerHTML = '<p style="color:#999;">No orders yet</p>';
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading orders:', error);
            document.getElementById('orders-list').innerHTML = `<p style="color:#d32f2f;">Error loading orders: ${error.message}</p>`;
          });
      }

      function displayOrders(orders) {
        const container = document.getElementById('orders-list');
        
        if (!orders || orders.length === 0) {
          container.innerHTML = '<p style="color:#999;">No orders found</p>';
          return;
        }
        
        let html = `
          <table style="width:100%; border-collapse: collapse;">
            <thead>
              <tr style="background:#f5f5f5; border-bottom: 2px solid #ddd;">
                <th style="padding:10px; text-align:left; font-weight:600;">Order Number</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Customer</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Items</th>
                <th style="padding:10px; text-align:right; font-weight:600;">Amount</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Status</th>
                <th style="padding:10px; text-align:left; font-weight:600;">Date</th>
                <th style="padding:10px; text-align:center; font-weight:600;">Actions</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        orders.forEach(order => {
          const statusColors = {
            'pending': '#ff9800',
            'confirmed': '#2196f3',
            'processing': '#ff5722',
            'shipped': '#4caf50',
            'delivered': '#9c27b0',
            'cancelled': '#f44336',
            'returned': '#795548'
          };
          
          const statusEmojis = {
            'pending': '‚è≥',
            'confirmed': '‚úîÔ∏è',
            'processing': 'üîÑ',
            'shipped': 'üì¶',
            'delivered': '‚úÖ',
            'cancelled': '‚ùå',
            'returned': '‚Ü©Ô∏è'
          };
          
          const statusBadgeColor = statusColors[order.order_status] || '#666';
          const statusEmoji = statusEmojis[order.order_status] || 'üìã';
          const orderDate = new Date(order.created_at).toLocaleDateString('en-US', {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });
          
          html += `
            <tr style="border-bottom: 1px solid #eee;" data-order-id="${order.id}" data-order-status="${order.order_status}">
              <td style="padding:10px;"><strong>${order.order_number}</strong></td>
              <td style="padding:10px;">${order.customer_name || 'N/A'}</td>
              <td style="padding:10px;">${order.item_count || 1} item(s)</td>
              <td style="padding:10px; text-align:right;"><strong>‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}</strong></td>
              <td style="padding:10px;">
                <span style="background:${statusBadgeColor}; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">
                  ${statusEmoji} ${order.order_status.replace(/_/g, ' ').toUpperCase()}
                </span>
              </td>
              <td style="padding:10px; font-size:12px; color:#666;">${orderDate}</td>
              <td style="padding:10px; text-align:center;">
                <button class="action-btn" onclick="viewOrderDetails(${order.id})" style="font-size:12px; padding:4px 8px; margin-right:4px;">View</button>
                ${order.order_status !== 'delivered' && order.order_status !== 'cancelled' ? `<button class="action-btn" onclick="openStatusModal(${order.id}, '${order.order_status}')" style="font-size:12px; padding:4px 8px;">Update</button>` : ''}
              </td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
        
        container.innerHTML = html;
      }

      function viewOrderDetails(orderId) {
        console.log('üëÄ Viewing order details:', orderId);
        const order = allOrders.find(o => o.id === orderId);
        
        if (!order) {
          alert('Order not found');
          return;
        }
        
        const details = `
Order Number: ${order.order_number}
Customer: ${order.customer_name || 'N/A'}
Total: ‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}
Status: ${order.order_status.replace(/_/g, ' ').toUpperCase()}
Items: ${order.item_count || 1}
Date: ${new Date(order.created_at).toLocaleDateString()}
        `;
        
        alert(details);
      }

      function openStatusModal(orderId, currentStatus) {
        console.log('üîÑ Opening status modal for order:', orderId);
        
        const statuses = ['pending', 'confirmed', 'processing', 'shipped', 'delivered'];
        let statusOptions = statuses.map(s => `<option value="${s}" ${s === currentStatus ? 'selected' : ''}>${s.replace(/_/g, ' ').toUpperCase()}</option>`).join('');
        
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000;';
        modal.innerHTML = `
          <div style="background:#fff; padding:20px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.2); max-width:400px;">
            <h3>Update Order Status</h3>
            <label style="display:block; margin:15px 0; font-weight:600;">New Status</label>
            <select id="new-status-select" style="width:100%; padding:8px; border:1px solid #ddd; border-radius:4px; font-size:14px;">
              ${statusOptions}
            </select>
            <div style="margin-top:20px; display:flex; gap:10px; justify-content:flex-end;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding:8px 16px; border:1px solid #ddd; border-radius:4px; cursor:pointer;">Cancel</button>
              <button onclick="updateOrderStatus(${orderId})" style="padding:8px 16px; background:#0a0a0a; color:#fff; border:none; border-radius:4px; cursor:pointer;">Update</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      function updateOrderStatus(orderId) {
        console.log('üìä Updating order status:', orderId);
        
        const newStatus = document.getElementById('new-status-select').value;
        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', newStatus);
        
        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
          .then(response => {
            console.log('üì• Status update response:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log('‚úÖ Order status updated:', data);
            
            if (data.success) {
              alert('‚úÖ Order status updated successfully!');
              // Remove modal
              document.querySelectorAll('[style*="position:fixed"]').forEach(el => el.remove());
              // Reload orders
              loadOrders(currentOrderFilter);
            } else {
              alert('‚ùå Failed to update order status: ' + (data.message || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('‚ùå Error updating order status:', error);
            alert('Error updating order status: ' + error.message);
          });
      }
      // ============ END ORDER MANAGEMENT ============

      function loadProducts() {
        fetch('/seller/products')
          .then(response => response.json())
          .then(data => {
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Category</th>
                      <th>Brand</th>
                      <th>SKU</th>
                      <th>Price</th>
                      <th>Stock</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                let statusText = product.is_active ? 'Approved' : 'Pending Approval';
                let statusClass = product.is_active ? 'status-active' : 'status-pending';
                
                // Check for pending edits
                if (product.edit_status === 'pending' && product.pending_edits > 0) {
                  statusText = `Edit Pending (${product.pending_edits})`;
                  statusClass = 'status-pending';
                }
                
                html += `
                  <tr>
                    <td>
                      <div style="font-weight: 600;">${product.name}</div>
                      ${product.description ? '<div style="font-size: 11px; color: #666; margin-top: 2px;">' + (product.description.length > 50 ? product.description.substring(0, 50) + '...' : product.description) + '</div>' : ''}
                      ${product.pending_edits > 0 ? '<span style="color: #f59e0b; font-size: 11px; margin-left: 6px;">‚è≥ Edit review</span>' : ''}
                    </td>
                    <td>${product.category_name || 'N/A'}</td>
                    <td>${product.brand || 'N/A'}</td>
                    <td>${product.sku || 'N/A'}</td>
                    <td>‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td>${product.stock} pcs</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                      ${product.is_active ? `
                        <button class="action-btn" onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">Edit</button>
                        <button class="action-btn" onclick="updateStock(${product.id}, ${product.stock})" style="padding: 6px 12px; font-size: 12px; margin-right: 4px;">Update Stock</button>
                        <button class="action-btn" onclick="archiveProduct(${product.id}, '${product.name}')" style="padding: 6px 12px; font-size: 12px; background: #ef4444;">Archive</button>
                      ` : '<span style="color: #999; font-size: 12px;">Awaiting approval</span>'}
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('products-list').innerHTML = html;
            } else {
              document.getElementById('products-list').innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No products yet. <a href="#" onclick="loadPage(\'add-product\')">Add your first product</a></p>';
            }
          })
          .catch(error => {
            document.getElementById('products-list').innerHTML = '<p style="color:#ef4444;">Error loading products</p>';
          });
      }

      function loadInventory() {
        fetch('/seller/products')
          .then(response => response.json())
          .then(data => {
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Current Stock</th>
                      <th>Low Stock Alert</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                const isLow = product.stock <= product.threshold;
                html += `
                  <tr>
                    <td>${product.name}</td>
                    <td>${product.stock} pcs</td>
                    <td>${product.threshold} pcs</td>
                    <td><span class="status-badge ${isLow ? 'status-pending' : 'status-active'}">${isLow ? 'Low Stock' : 'In Stock'}</span></td>
                    <td>
                      <button class="action-btn" onclick="updateStock(${product.id}, ${product.stock})" style="padding: 6px 12px; font-size: 12px;">Restock</button>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('inventory-list').innerHTML = html;
            } else {
              document.getElementById('inventory-list').innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No products in inventory</p>';
            }
          })
          .catch(error => {
            document.getElementById('inventory-list').innerHTML = '<p style="color:#ef4444;">Error loading inventory</p>';
          });
      }

      // Global variable to store original product data for comparison
      let originalProductData = {};

      function editProduct(productId) {
        loadPage('edit-product');
        
        fetch('/seller/product/' + productId)
          .then(response => response.json())
          .then(data => {
            if (data.product) {
              const product = data.product;
              const variants = data.variants || [];
              originalProductData = JSON.parse(JSON.stringify(product)); // Deep copy
              
              // Extract existing colors and sizes from variants
              const existingColors = [...new Set(variants.map(v => v.color))];
              const colorSizeMap = {};
              variants.forEach(v => {
                if (!colorSizeMap[v.color]) colorSizeMap[v.color] = [];
                colorSizeMap[v.color].push({size: v.size, stock: v.stock_quantity});
              });
              
              const formHtml = `
                <form id="editProductForm" style="display: flex; flex-direction: column; gap: 16px;">
                  <input type="hidden" name="product_id" value="${product.id}">
                  <input type="hidden" id="edit_stock_data" name="stock_data" value='${JSON.stringify(variants.map(v => ({size: v.size, color: v.color, stock_qty: v.stock_quantity})))}'>
                  
                  <div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 12px; border-radius: 8px; font-size: 14px;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Changes require admin approval before they appear on your store.
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Product Name</label>
                    <input type="text" id="edit_name" name="name" value="${product.name}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Description</label>
                    <textarea id="edit_description" name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>${product.description || ''}</textarea>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Price (‚Ç±)</label>
                      <input type="number" id="edit_price" name="price" value="${product.price}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                    </div>
                    
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Brand</label>
                      <input type="text" id="edit_brand" name="brand" value="${product.brand || ''}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                  </div>
                  
                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Category</label>
                    <select id="edit_category_id" name="category_id" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required onchange="toggleEditSizeColorSections()">
                      <option value="">Select Category</option>
                      ${data.categories ? data.categories.map(cat => `<option value="${cat.id}" data-slug="${cat.slug}" ${cat.id == product.category_id ? 'selected' : ''}>${cat.name}</option>`).join('') : ''}
                    </select>
                  </div>
                  
                  <!-- Available Colors -->
                  <div id="edit-colors-section" style="display: ${product.category_slug !== 'grooming' ? 'block' : 'none'}">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Available Colors</label>
                    <small style="display: block; color: var(--muted); margin-bottom: 10px;">Select colors available for this product.</small>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
                      ${['Black', 'White', 'Gray', 'Navy', 'Blue', 'Green', 'Brown', 'Beige', 'Khaki'].map(color => `
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                          <input type="checkbox" name="colors" value="${color}" onchange="updateEditStockInputs()" ${existingColors.includes(color) ? 'checked' : ''}>
                          <span style="font-size: 14px;">${color}</span>
                        </label>
                      `).join('')}
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-size: 13px; color: var(--muted);">Add Custom Color(s)</label>
                      <input type="text" id="edit-custom-colors" placeholder="e.g., Burgundy, Olive" style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px;" oninput="updateEditStockInputs()">
                      <small style="color: var(--muted); font-size: 11px;">Separate multiple colors with commas</small>
                    </div>
                  </div>
                  
                  <!-- Sizes per Color -->
                  <div id="edit-sizes-section" style="display: ${product.category_slug !== 'grooming' ? 'block' : 'none'}">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Sizes per Color</label>
                    <small style="display: block; color: var(--muted); margin-bottom: 10px;">For each color selected above, choose which sizes are available.</small>
                    <div id="edit-colorSizesList"></div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--line);">
                      <label style="display: block; margin-bottom: 6px; font-weight: 500;">Add Custom Size(s) (for all colors)</label>
                      <input type="text" id="edit-custom-sizes" placeholder="e.g. 4XL, 5XL, 28W, 32W (comma-separated)" 
                        style="width: 100%; padding: 8px; border: 1px solid var(--line); border-radius: 6px;" oninput="updateEditStockInputs()">
                      <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Enter custom sizes separated by commas. These will be available as options for all colors.</small>
                    </div>
                  </div>
                  
                  <!-- Stock Quantities -->
                  <div id="edit-stock-section" style="display: ${product.category_slug !== 'grooming' ? 'block' : 'none'}">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Stock Quantities</label>
                    <small style="display: block; color: var(--muted); margin-bottom: 10px;">Enter stock quantity for each size-color combination.</small>
                    <div id="edit-stock-inputs"></div>
                  </div>
                  
                  <div style="display: flex; gap: 12px; margin-top: 10px;">
                    <button type="button" class="action-btn" onclick="submitProductEdit()" style="padding: 12px 24px;">Submit for Approval</button>
                    <button type="button" class="action-btn" onclick="loadPage('products')" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                  </div>
                </form>
              `;
              
              document.getElementById('edit-product-form').innerHTML = formHtml;
              
              // Initialize stock inputs for edit form
              if (product.category_slug !== 'grooming') {
                updateEditStockInputs();
              }
            } else {
              document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
            }
          })
          .catch(error => {
            document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
          });
      }
      
      // Function to toggle size and color sections in edit form based on category
      function toggleEditSizeColorSections() {
        const categorySelect = document.getElementById('edit_category_id');
        const colorsSection = document.getElementById('edit-colors-section');
        const sizesSection = document.getElementById('edit-sizes-section');
        const stockSection = document.getElementById('edit-stock-section');
        
        if (!categorySelect) return;
        
        // Get the selected option's slug
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categorySlug = selectedOption.getAttribute('data-slug');
        
        if (categorySlug === 'grooming') {
          // Hide sizes, colors, and stock sections for grooming products
          if (colorsSection) colorsSection.style.display = 'none';
          if (sizesSection) sizesSection.style.display = 'none';
          if (stockSection) stockSection.style.display = 'none';
        } else {
          // Show sections for other categories
          if (colorsSection) colorsSection.style.display = 'block';
          if (sizesSection) sizesSection.style.display = 'block';
          if (stockSection) stockSection.style.display = 'block';
          
          // Update custom sizes placeholder based on category
          const customSizesInput = document.getElementById('edit-custom-sizes');
          if (customSizesInput) {
            if (categorySlug === 'shoes-accessories') {
              customSizesInput.placeholder = 'e.g. 5, 5.5, 13.5, 14, 15 (comma-separated)';
            } else {
              customSizesInput.placeholder = 'e.g. 4XL, 5XL, 28W, 32W (comma-separated)';
            }
          }
          
          // Update the stock inputs when showing sections
          updateEditStockInputs();
        }
      }
      
      // Edit product stock management functions (similar to add product)
      function getAllEditAvailableSizes() {
        // Check if Shoes & Accessories category is selected
        const categorySelect = document.getElementById('edit_category_id');
        let predefinedSizes = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL'];
        
        if (categorySelect) {
          const selectedOption = categorySelect.options[categorySelect.selectedIndex];
          const categorySlug = selectedOption.getAttribute('data-slug');
          const isShoeCategory = categorySlug === 'shoes-accessories';
          
          // Use US shoe sizes for shoes, clothing sizes for other categories
          predefinedSizes = isShoeCategory 
            ? ['6', '6.5', '7', '7.5', '8', '8.5', '9', '9.5', '10', '10.5', '11', '11.5', '12', '12.5', '13']
            : ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL'];
        }
        
        // Add custom sizes
        const customSizesInput = document.getElementById('edit-custom-sizes');
        let customSizes = [];
        
        if (customSizesInput && customSizesInput.value.trim()) {
          customSizes = customSizesInput.value
            .split(',')
            .map(s => s.trim())
            .filter(s => s && s.length > 0);
        }
        
        return [...new Set([...predefinedSizes, ...customSizes])];
      }
      
      function getAllEditSelectedColors() {
        const colors = Array.from(document.querySelectorAll('input[name="colors"]:checked')).map(cb => cb.value);
        const customColorsInput = document.getElementById('edit-custom-colors');
        if (customColorsInput && customColorsInput.value.trim()) {
          const customColors = customColorsInput.value.split(',').map(c => c.trim()).filter(c => c);
          colors.push(...customColors);
        }
        return colors;
      }
      
      function getSizesForEditColor(color) {
        return Array.from(document.querySelectorAll(`input[data-color-size="${color}"]:checked`)).map(cb => cb.value);
      }
      
      function renderEditColorSizeSelectors() {
        const colors = getAllEditSelectedColors();
        const allAvailableSizes = getAllEditAvailableSizes();
        const colorSizesList = document.getElementById('edit-colorSizesList');
        
        if (!colorSizesList) return;
        
        if (colors.length === 0) {
          colorSizesList.innerHTML = '<p style="color: var(--muted); font-style: italic;">Select at least one color above</p>';
          return;
        }
        
        // Preserve checked state
        const checkedState = {};
        const existingCheckboxes = colorSizesList.querySelectorAll('input[data-color-size]');
        existingCheckboxes.forEach(checkbox => {
          const color = checkbox.getAttribute('data-color-size');
          const size = checkbox.value;
          const key = `${color}|${size}`;
          checkedState[key] = checkbox.checked;
        });
        
        let html = '';
        
        colors.forEach(color => {
          html += `
            <div style="margin-bottom: 16px; padding: 12px; background: white; border: 1px solid var(--line); border-radius: 6px;">
              <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">üìç ${color}</label>
              <small style="color: var(--muted); font-size: 11px; display: block; margin-bottom: 8px;">Select which sizes are available in ${color}</small>
              <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px;">
          `;
          
          allAvailableSizes.forEach(size => {
            const key = `${color}|${size}`;
            const isChecked = checkedState[key] || false;
            const checkedAttr = isChecked ? 'checked' : '';
            
            html += `
              <label style="display: flex; align-items: center; cursor: pointer; padding: 6px; border-radius: 4px; background: #f5f5f5;">
                <input 
                  type="checkbox" 
                  data-color-size="${color}" 
                  value="${size}" 
                  style="margin-right: 4px;"
                  ${checkedAttr}
                  onchange="updateEditStockInputs()"
                >
                <span style="font-size: 13px;">${size}</span>
              </label>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        colorSizesList.innerHTML = html;
        
        // Attach event listeners
        const sizeCheckboxes = colorSizesList.querySelectorAll('input[data-color-size]');
        sizeCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', updateEditStockInputs);
        });
      }
      
      function updateEditStockInputs() {
        renderEditColorSizeSelectors();
        
        const colors = getAllEditSelectedColors();
        const stockInputsDiv = document.getElementById('edit-stock-inputs');
        
        if (!stockInputsDiv) return;
        
        if (colors.length === 0) {
          stockInputsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--muted);"><p style="margin: 0; font-style: italic;">üì¶ Select at least one color above to get started</p></div>`;
          return;
        }
        
        const combinations = [];
        colors.forEach(color => {
          const sizes = getSizesForEditColor(color);
          sizes.forEach(size => {
            combinations.push({ color, size });
          });
        });
        
        if (combinations.length === 0) {
          stockInputsDiv.innerHTML = `<div style="padding: 20px; text-align: center; color: var(--muted);"><p style="margin: 0; font-style: italic;">üé® Select sizes for each color to continue</p></div>`;
          return;
        }
        
        // Get existing stock values
        const existingStockData = JSON.parse(document.getElementById('edit_stock_data')?.value || '[]');
        const stockMap = {};
        existingStockData.forEach(item => {
          stockMap[`${item.size}|${item.color}`] = item.stock_qty;
        });
        
        let html = `<div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--line); border-radius: 6px;"><table style="width: 100%; border-collapse: collapse;">
          <thead style="position: sticky; top: 0; background: #f8f8f8; z-index: 1;">
            <tr>
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line);">Color</th>
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line);">Size</th>
              <th style="padding: 10px; text-align: left; border-bottom: 2px solid var(--line);">Stock Quantity</th>
            </tr>
          </thead>
          <tbody>`;
        
        combinations.forEach(combo => {
          const key = `${combo.size}|${combo.color}`;
          const existingStock = stockMap[key] || 0;
          html += `
            <tr>
              <td style="padding: 10px; border-bottom: 1px solid var(--line);">${combo.color}</td>
              <td style="padding: 10px; border-bottom: 1px solid var(--line);">${combo.size}</td>
              <td style="padding: 10px; border-bottom: 1px solid var(--line);">
                <input 
                  type="number" 
                  data-combination="${combo.size}|${combo.color}" 
                  value="${existingStock}"
                  min="0" 
                  style="width: 100px; padding: 6px; border: 1px solid var(--line); border-radius: 4px;"
                  required
                >
              </td>
            </tr>
          `;
        });
        
        html += '</tbody></table></div>';
        stockInputsDiv.innerHTML = html;
      }

      function submitProductEdit() {
        const form = document.getElementById('editProductForm');
        const formData = new FormData(form);
        
        // Serialize stock data from edit form
        const stockInputs = document.querySelectorAll('#edit-stock-inputs input[data-combination]');
        const stockArray = [];
        stockInputs.forEach(input => {
          const qty = parseInt(input.value) || 0;
          if (qty > 0) {
            const key = input.dataset.combination;
            const [size, color] = key.split('|');
            stockArray.push({
              size: size,
              color: color,
              stock_qty: qty
            });
          }
        });
        
        // Update the hidden stock_data field
        formData.set('stock_data', JSON.stringify(stockArray));
        
        // Compare with original data to find changes
        const changes = {};
        const fieldMap = {
          'name': 'Product Name',
          'description': 'Description',
          'price': 'Price',
          'brand': 'Brand',
          'category_id': 'Category'
        };
        
        for (let [key, label] of Object.entries(fieldMap)) {
          const newValue = formData.get(key);
          const oldValue = originalProductData[key]?.toString() || '';
          
          if (newValue !== oldValue) {
            changes[key] = {
              label: label,
              old: oldValue,
              new: newValue
            };
          }
        }
        
        if (Object.keys(changes).length === 0 && stockArray.length === 0) {
          alert('No changes detected');
          return;
        }
        
        // Confirm changes with user
        let confirmMsg = 'You are requesting to change:\\n\\n';
        for (let [key, change] of Object.entries(changes)) {
          confirmMsg += `${change.label}: "${change.old}" ‚Üí "${change.new}"\\n`;
        }
        if (stockArray.length > 0) {
          confirmMsg += `Stock Variants: ${stockArray.length} combinations\\n`;
        }
        confirmMsg += '\\nThese changes will require admin approval. Continue?';
        
        if (!confirm(confirmMsg)) {
          return;
        }
        
        fetch('/seller/edit-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product edit submitted for admin approval!\\n\\nYour changes will be reviewed and applied once approved.');
            loadPage('products');
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error submitting edit request');
        });
      }

      function archiveProduct(productId, productName) {
        const reason = prompt(`Archive "${productName}"?\n\nOptional reason for archiving:`, '');
        if (reason === null) return;
        
        if (!confirm(`Are you sure you want to archive "${productName}"?\n\nArchived products will be hidden from your store and require admin approval to recover.`)) {
          return;
        }
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason);
        
        fetch('/seller/archive-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product archived successfully!');
            loadPage('products');
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error archiving product');
        });
      }
      
      function loadArchivedProducts() {
        fetch('/seller/archived-products')
          .then(response => response.json())
          .then(data => {
            if (data.products && data.products.length > 0) {
              let html = `
                <table>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>SKU</th>
                      <th>Price</th>
                      <th>Archived Date</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
              `;
              
              data.products.forEach(product => {
                const archivedDate = new Date(product.archived_at).toLocaleDateString();
                const statusText = product.archive_status === 'pending_recovery' ? 'Recovery Pending' : 'Archived';
                const statusClass = product.archive_status === 'pending_recovery' ? 'status-pending' : 'status-inactive';
                
                html += `
                  <tr>
                    <td>${product.name}</td>
                    <td>${product.sku || 'N/A'}</td>
                    <td>‚Ç±${parseFloat(product.price).toFixed(2)}</td>
                    <td style="font-size:13px;color:var(--muted)">${archivedDate}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                      <div style="display: flex; gap: 8px; align-items: center; justify-content: flex-start; min-height: 36px;">
                        ${product.archive_status === 'archived' ? 
                          `<button class="action-btn" onclick="requestRecovery(${product.id}, '${product.name.replace(/'/g, "\\'")}')" 
                            style="padding: 8px 14px; font-size: 13px; background: #10b981; border-radius: 6px; font-weight: 500; transition: all 0.2s; min-width: 140px; white-space: nowrap;">
                            üîÑ Request Recovery
                          </button>` :
                          `<div style="display: flex; align-items: center; padding: 8px 14px; background: #fef3c7; border-radius: 6px; font-size: 12px; color: #92400e; font-weight: 500; min-width: 140px; justify-content: center;">
                            ‚è≥ Pending Approval
                          </div>`
                        }
                        <button class="action-btn" onclick="deleteArchivedProduct(${product.id}, '${product.name.replace(/'/g, "\\'")}')" 
                          style="padding: 8px 14px; font-size: 13px; background: #ef4444; border-radius: 6px; font-weight: 500; transition: all 0.2s; min-width: 100px; white-space: nowrap;">
                          üóëÔ∏è Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              });
              
              html += '</tbody></table>';
              document.getElementById('archived-products-list').innerHTML = html;
            } else {
              document.getElementById('archived-products-list').innerHTML = '<p style="text-align:center;color:#999;padding:20px;">No archived products</p>';
            }
          })
          .catch(error => {
            document.getElementById('archived-products-list').innerHTML = '<p style="color:#ef4444;">Error loading archived products</p>';
          });
      }
      
      function requestRecovery(productId, productName) {
        const reason = prompt(`Request recovery for "${productName}"?\n\nReason for recovery (required):`, '');
        if (!reason || reason.trim() === '') {
          if (reason !== null) alert('Please provide a reason for recovery');
          return;
        }
        
        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason);
        
        fetch('/seller/request-recovery', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Recovery request submitted!\n\nAn admin will review your request.');
            loadArchivedProducts();
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error submitting recovery request');
        });
      }
      
      function deleteArchivedProduct(productId, productName) {
        if (!confirm(`‚ö†Ô∏è PERMANENT DELETE\n\nAre you sure you want to permanently delete "${productName}"?\n\nThis action CANNOT be undone. The product and all its data will be removed from the database.`)) {
          return;
        }
        
        // Double confirmation for safety
        const confirmation = prompt(`Type "DELETE" to confirm permanent deletion of "${productName}":`, '');
        if (confirmation !== 'DELETE') {
          if (confirmation !== null) alert('Deletion cancelled. You must type "DELETE" exactly to confirm.');
          return;
        }
        
        const formData = new FormData();
        formData.append('product_id', productId);
        
        fetch('/seller/delete-archived-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product permanently deleted!');
            loadArchivedProducts();
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          alert('Error deleting product');
        });
      }

      function updateStock(productId, currentStock) {
        const newStock = prompt(`Update stock for product (current: ${currentStock}):`, currentStock);
        if (newStock !== null && !isNaN(newStock)) {
          const formData = new FormData();
          formData.append('product_id', productId);
          formData.append('stock_quantity', newStock);
          
          fetch('/seller/update-stock', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Stock updated successfully!');
              // Reload current page
              const activePage = document.querySelector('.side-link.active')?.getAttribute('data-page');
              if (activePage) loadPage(activePage);
            } else {
              alert('Error updating stock: ' + data.error);
            }
          })
          .catch(error => {
            alert('Error updating stock');
          });
        }
      }

      // Optimized single event delegation for all sidebar links
      document.addEventListener('click', function(e) {
        const link = e.target.closest('.side-link');
        if (link) {
          const page = link.getAttribute('data-page');
          const href = link.getAttribute('href');
          
          // Only handle hash links with data-page attribute
          if (page && href === '#') {
            e.preventDefault();
            e.stopPropagation();
            loadPage(page);
          }
        }
      }, true); // Use capture phase for faster response

      // Image preview functionality
      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'productImages') {
          const files = e.target.files;
          const previewContainer = document.getElementById('imagePreviewContainer');
          previewContainer.innerHTML = ''; // Clear previous previews
          
          if (files.length > 0) {
            Array.from(files).forEach((file, index) => {
              if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                  const previewItem = document.createElement('div');
                  previewItem.style.cssText = 'position: relative; border: 2px solid var(--line); border-radius: 8px; overflow: hidden; aspect-ratio: 1/1;';
                  
                  const img = document.createElement('img');
                  img.src = e.target.result;
                  img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';
                  
                  const badge = document.createElement('div');
                  badge.textContent = index === 0 ? 'Primary' : `${index + 1}`;
                  badge.style.cssText = `position: absolute; top: 4px; left: 4px; background: ${index === 0 ? '#0a0a0a' : '#666'}; color: #fff; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;`;
                  
                  previewItem.appendChild(img);
                  previewItem.appendChild(badge);
                  previewContainer.appendChild(previewItem);
                };
                
                reader.readAsDataURL(file);
              }
            });
          }
        }
      });
    </script>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <!-- Debug & Helper Script -->
    <script>
      /**
       * DEBUG TOOLS - Remove or comment out in production
       * Access via browser console: debugStockForm()
       */
      window.debugStockForm = function() {
        console.log('='.repeat(60));
        console.log('üîç STOCK FORM DEBUG REPORT');
        console.log('='.repeat(60));
        
        const sizes = getAllSelectedSizes();
        const colors = getAllSelectedColors();
        const validation = validateStockQuantities();
        
        console.log('\nüìè SIZES SELECTED:', sizes);
        console.log('   Count:', sizes.length);
        
        console.log('\nüé® COLORS SELECTED:', colors);
        console.log('   Count:', colors.length);
        
        console.log('\nüì¶ COMBINATIONS:');
        console.log('   Total:', sizes.length * colors.length);
        
        console.log('\n‚úì VALIDATION RESULT:');
        console.log('   Valid:', validation.valid);
        console.log('   Total Stock:', validation.totalStock);
        console.log('   Errors:', validation.errors);
        
        console.log('\nüìä FORM DATA:');
        const form = document.getElementById('addProductForm');
        if (form) {
          const formData = new FormData(form);
          for (let [key, value] of formData.entries()) {
            if (key.includes('stock') || key.includes('size') || key.includes('color')) {
              console.log(`   ${key}:`, value);
            }
          }
        }
        
        console.log('\n' + '='.repeat(60));
        return { sizes, colors, validation };
      };
      
      /**
       * Export stock data to console (useful for testing)
       */
      window.getStockData = function() {
        return serializeStockData();
      };
      
      /**
       * Clear all stock inputs (for testing)
       */
      window.clearStockInputs = function() {
        const inputs = document.querySelectorAll('input[data-combination]');
        inputs.forEach(input => input.value = 0);
        console.log('‚úì Cleared', inputs.length, 'stock inputs');
      };
      
      /**
       * Fill all stock inputs with a test value (for testing)
       */
      window.fillStockInputs = function(qty = 10) {
        const inputs = document.querySelectorAll('input[data-combination]');
        inputs.forEach(input => input.value = qty);
        console.log('‚úì Filled', inputs.length, 'stock inputs with qty:', qty);
      };
    </script>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>