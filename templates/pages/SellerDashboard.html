<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Seller Dashboard ‚Äî Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500&display=swap" rel="stylesheet">
    <!-- markdownlint-disable -->
    <!-- htmlhint: off -->
    <!-- stylelint: disable -->
    <style>
      :root {
        --bg: #f3f4f6;
        --bg-alt: #e5e7eb;
        --surface: #ffffff;
        --card: #ffffff;
        --line: #e5e7eb;
        --line-strong: #d1d5db;
        --text: #0a0a0a;
        --heading: #0a0a0a;
        --muted: #6b7280;
        --accent: #0a0a0a;
        --accent-soft: rgba(10, 10, 10, 0.08);
        --accent-strong: #111827;
        --highlight: #111827;
        --success: #16a34a;
        --warning: #eab308;
        --danger: #dc2626;
        --shadow: 0 18px 40px rgba(15, 23, 42, 0.08);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #f9fafb 0%, #eef2ff 60%, #f3f4f6 100%);
        color: var(--text);
        min-height: 100vh;
        line-height: 1.6;
      }

      h1, h2, h3, h4, h5, h6 {
        font-family: 'Playfair Display', 'Inter', serif;
        color: var(--heading);
        margin: 0;
        letter-spacing: -0.02em;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      button,
      input,
      select,
      textarea {
        font-family: 'Plus Jakarta Sans', 'Space Grotesk', sans-serif;
      }

      ::selection {
        background: var(--accent);
        color: #050505;
      }

      .app {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr);
        min-height: 100vh;
        background: transparent;
        color: var(--text);
      }

      .sidebar {
        background: #0a0a0a;
        padding: 28px 20px;
        display: flex;
        flex-direction: column;
        gap: 22px;
        border-right: none;
        box-shadow: 16px 0 35px rgba(0, 0, 0, 0.35);
        position: sticky;
        top: 0;
        height: 100vh;
        overflow-y: auto;
      }

      .sidebar::-webkit-scrollbar {
        width: 6px;
      }

      .sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 999px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.2em;
        text-transform: uppercase;
        color: #fff;
      }

      .logo .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #22d3ee;
        box-shadow: 0 0 12px rgba(34, 211, 238, 0.8);
      }

      .side-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .side-title {
        font-size: 11px;
        font-weight: 600;
        letter-spacing: 0.3em;
        text-transform: uppercase;
        color: var(--muted);
        opacity: 0.8;
      }

      .side-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.7);
        transition: background 0.2s ease, transform 0.2s ease;
        font-weight: 500;
      }

      .side-link.active,
      .side-link:hover {
        background: rgba(255, 255, 255, 0.08);
        color: #fff;
        transform: translateX(4px);
      }

      .content {
        padding: 36px 48px;
        background: var(--bg);
      }

      .topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        background: #fff;
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 18px 22px;
        box-shadow: var(--shadow);
      }

      .page-title {
        font-size: 26px;
        font-weight: 600;
        color: var(--heading);
      }

      .topbar .search {
        display: none;
      }

      .search input {
        width: 240px;
        background: #f9fafb;
        border: 1px solid var(--line);
        border-radius: 12px;
        color: var(--text);
        padding: 10px 18px;
        font-size: 14px;
      }

      .search input::placeholder {
        color: var(--muted);
      }

      .avatar {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 10px;
      }

      .tag {
        padding: 6px 14px;
        border-radius: 999px;
        background: #0a0a0a;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
      }

      .status-badge {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid var(--line);
      }

      .status-active {
        background: rgba(34, 197, 94, 0.12);
        border-color: rgba(34, 197, 94, 0.4);
        color: #16a34a;
      }

      .status-pending {
        background: rgba(234, 179, 8, 0.12);
        border-color: rgba(234, 179, 8, 0.4);
        color: #ca8a04;
      }

      .status-inactive {
        background: rgba(248, 113, 113, 0.15);
        border-color: rgba(248, 113, 113, 0.4);
        color: #dc2626;
      }

      .main {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .grid {
        display: grid;
        gap: 20px;
      }

      .grid.stats {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .grid.two {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      }

      .card {
        position: relative;
        border-radius: 18px;
        border: 1px solid var(--line);
        background: var(--card);
        box-shadow: var(--shadow);
      }

      .card .inner {
        padding: 24px 24px 28px;
      }

      .page-section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        padding-bottom: 16px;
        margin-bottom: 18px;
        border-bottom: 1px solid var(--line);
      }

      .page-section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 22px;
        font-weight: 600;
        margin: 0;
      }

      .page-section-subtitle {
        margin: 6px 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .page-section-eyebrow {
        font-size: 11px;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: var(--muted);
        margin: 0 0 6px;
        font-weight: 600;
      }

      .page-section-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      .page-section-actions input[type="text"],
      .page-section-actions input[type="search"] {
        padding: 10px 14px;
        border: 1px solid var(--line);
        border-radius: 10px;
        font-size: 13px;
        min-width: 220px;
      }

      /* Order status filter grid */
      .order-status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e5e7eb;
      }

      .order-status-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px 18px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: flex-start;
        text-align: left;
        cursor: pointer;
        min-height: 120px;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        font: inherit;
      }

      .order-status-card:focus-visible {
        outline: 2px solid #0a0a0a;
        outline-offset: 2px;
      }

      .order-status-card[data-state="active"] {
        transform: translateY(-2px);
        box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
        border-color: #0a0a0a;
        background: #ffffff;
      }

      .order-status-card[data-state="idle"] {
        opacity: 0.9;
      }

      .order-status-card__top {
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .order-status-card__emoji {
        font-size: 24px;
      }

      .order-status-card__count {
        font-size: 28px;
        font-weight: 700;
        line-height: 1;
      }

      .order-status-card__label {
        font-size: 13px;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .order-status-card__hint {
        font-size: 12px;
        color: #6b7280;
        margin: 0;
      }

      .order-status-card[data-status="all"] {
        background: linear-gradient(135deg, #f8fafc, #ffffff);
      }

      .order-status-card[data-status="pending"] {
        border-color: rgba(249, 115, 22, 0.35);
        background: linear-gradient(135deg, #fff7ed, #fffbeb);
      }

      .order-status-card[data-status="confirmed"] {
        border-color: rgba(59, 130, 246, 0.35);
        background: linear-gradient(135deg, #eff6ff, #e0f2fe);
      }

      .order-status-card[data-status="waiting_for_pickup"] {
        border-color: rgba(245, 158, 11, 0.35);
        background: linear-gradient(135deg, #fefce8, #fff7ed);
      }

      .order-status-card[data-status="released_to_rider"] {
        border-color: rgba(16, 185, 129, 0.35);
        background: linear-gradient(135deg, #ecfdf5, #d1fae5);
      }

      .order-status-card[data-status="delivered"] {
        border-color: rgba(139, 92, 246, 0.35);
        background: linear-gradient(135deg, #f5f3ff, #ede9fe);
      }

      .order-status-card[data-status="pending"] .order-status-card__count,
      .order-status-card[data-status="pending"] .order-status-card__label {
        color: #c2410c;
      }

      .order-status-card[data-status="confirmed"] .order-status-card__count,
      .order-status-card[data-status="confirmed"] .order-status-card__label {
        color: #1d4ed8;
      }

      .order-status-card[data-status="waiting_for_pickup"] .order-status-card__count,
      .order-status-card[data-status="waiting_for_pickup"] .order-status-card__label {
        color: #b45309;
      }

      .order-status-card[data-status="released_to_rider"] .order-status-card__count,
      .order-status-card[data-status="released_to_rider"] .order-status-card__label {
        color: #047857;
      }

      .order-status-card[data-status="delivered"] .order-status-card__count,
      .order-status-card[data-status="delivered"] .order-status-card__label {
        color: #5b21b6;
      }

      .order-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        align-items: center;
      }

      .order-action {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 12px;
        font-weight: 600;
        border: 1px solid #e5e7eb;
        background: #f8fafc;
        color: #111827;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .order-action:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
      }

      .order-action--ghost {
        background: #f8fafc;
        border-color: #e2e8f0;
        color: #0f172a;
      }

      .order-action--info {
        background: #dbeafe;
        border-color: #bfdbfe;
        color: #1d4ed8;
      }

      .order-action--violet {
        background: #ede9fe;
        border-color: #ddd6fe;
        color: #5b21b6;
      }

      .order-action--success {
        background: #dcfce7;
        border-color: #bbf7d0;
        color: #047857;
      }

      .order-action--solid {
        background: #0a0a0a;
        border-color: #0a0a0a;
        color: #fff;
      }

      .order-action-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-radius: 999px;
        padding: 6px 14px;
        font-size: 12px;
        font-weight: 600;
      }

      .order-action-badge--violet {
        background: #ede9fe;
        color: #5b21b6;
      }

      .order-action-badge--success {
        background: #dcfce7;
        color: #047857;
      }

      .orders-table-wrapper {
        width: 100%;
        overflow-x: auto;
      }

      .orders-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 960px;
      }

      .orders-table thead th {
        background: #f9fafb;
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.1em;
        color: var(--muted);
        border-bottom: 1px solid var(--line);
        padding: 12px 16px;
      }

      .orders-table tbody td {
        padding: 14px 16px;
        border-bottom: 1px solid var(--line);
        font-size: 13px;
        color: var(--text);
      }

      .orders-table__cell {
        padding: 14px 16px;
      }

      .orders-table__cell--amount {
        text-align: right;
        font-weight: 600;
        font-variant-numeric: tabular-nums;
      }

      .orders-table__cell--view,
      .orders-table__cell--action {
        text-align: center;
        white-space: nowrap;
        min-width: 140px;
      }

      .order-view-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 6px 18px;
        border-radius: 999px;
        border: 1px solid var(--line);
        background: #ffffff;
        color: #0f172a;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .order-view-btn:hover {
        transform: translateY(-1px);
        border-color: #cbd5f5;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
      }

      .dashboard-modal {
        position: fixed;
        inset: 0;
        background: rgba(10, 10, 10, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 24px;
        z-index: 1200;
      }

      .dashboard-modal__card {
        background: #ffffff;
        border-radius: 20px;
        width: min(820px, 96vw);
        max-height: 90vh;
        overflow-y: auto;
        padding: 32px;
        box-shadow: 0 25px 70px rgba(15, 23, 42, 0.25);
      }

      .dashboard-modal__header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
        flex-wrap: wrap;
      }

      .dashboard-modal__title {
        font-size: 22px;
        font-weight: 700;
        margin: 0;
        color: #0f172a;
      }

      .dashboard-modal__close {
        border: none;
        background: #f3f4f6;
        color: #4b5563;
        width: 40px;
        height: 40px;
        border-radius: 999px;
        font-size: 20px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .dashboard-modal__close:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
      }

      .tracking-status-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 12px;
      }

      .tracking-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.04em;
        text-transform: uppercase;
      }

      .tracking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 16px;
        margin-top: 24px;
      }

      .tracking-card {
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 16px;
        background: #ffffff;
      }

      .tracking-card h4 {
        margin: 0 0 8px;
        font-size: 13px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      .tracking-card p {
        margin: 4px 0;
        font-size: 14px;
        color: #0f172a;
      }

      .tracking-summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        font-size: 13px;
      }

      .tracking-summary-table th,
      .tracking-summary-table td {
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
        text-align: left;
      }

      .tracking-summary-table th {
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #94a3b8;
      }

      .tracking-timeline {
        margin-top: 28px;
      }

      .tracking-timeline__title {
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 12px;
      }

      .tracking-event {
        display: grid;
        grid-template-columns: 140px 1fr;
        gap: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        margin-bottom: 10px;
      }

      .tracking-event__time {
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
      }

      .tracking-event__details {
        font-size: 13px;
        font-weight: 600;
        color: #0f172a;
      }

      .tracking-event__location {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
      }

      .tracking-event__note {
        font-size: 12px;
        color: #475569;
        margin-top: 4px;
      }

      .tracking-empty {
        padding: 24px;
        border-radius: 14px;
        border: 1px dashed #cbd5f5;
        background: #f8fafc;
        text-align: center;
        font-size: 13px;
        color: #64748b;
      }

      @media (max-width: 900px) {
        .orders-table {
          min-width: 720px;
        }

        .orders-table__cell--view,
        .orders-table__cell--action {
          min-width: 120px;
        }
      }

      .table-toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
      }

      .table-scroll {
        overflow-x: auto;
      }

      .metric {
        font-size: 13px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: var(--muted);
        font-weight: 600;
      }

      .value {
        font-size: 32px;
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        margin-top: 4px;
        color: var(--heading);
      }

      .chart {
        margin-top: 18px;
      }

      .bars {
        display: flex;
        align-items: flex-end;
        gap: 16px;
        min-height: 150px;
      }

      .bar {
        flex: 1;
        border-radius: 16px 16px 6px 6px;
        background: linear-gradient(180deg, var(--accent) 0%, var(--accent-strong) 60%, rgba(249, 115, 22, 0.65) 100%);
      }

      .legend {
        display: flex;
        justify-content: space-between;
        margin-top: 12px;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--muted);
      }

      .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 10px 18px;
        border-radius: 999px;
        border: none;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
        background: #0a0a0a;
        color: #fff;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 15px 30px rgba(10, 10, 10, 0.25);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead th {
        text-transform: uppercase;
        font-size: 11px;
        letter-spacing: 0.12em;
        color: var(--muted);
        border-bottom: 1px solid var(--line);
        padding: 10px 0;
      }

      tbody td {
        padding: 14px 0;
        border-bottom: 1px solid var(--line);
        font-size: 14px;
        color: var(--text);
      }

      .order-count-badge {
        background: #dc2626;
        color: #fff;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 11px;
        font-weight: 600;
      }

      .status-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
        gap: 14px;
      }

      .status-summary-card {
        display: flex;
        align-items: center;
        gap: 14px;
        border-radius: 14px;
        padding: 14px 16px;
        border: 1px solid #e2e8f0;
        background: #fff;
        box-shadow: 0 10px 24px rgba(15, 23, 42, 0.06);
        cursor: pointer;
        transition: transform 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
      }

      .status-summary-card--active {
        border-color: #0f172a;
        transform: translateY(-3px);
        box-shadow: 0 18px 34px rgba(15, 23, 42, 0.15);
      }

      .status-card-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        font-weight: 600;
      }

      .status-card-body {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .status-card-label {
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #475569;
      }

      .status-card-count {
        font-size: 26px;
        font-weight: 700;
        color: #0f172a;
        line-height: 1;
      }

      .status-card-approved {
        border-color: #bbf7d0;
        background: linear-gradient(145deg, #f0fdf4, #ffffff);
      }

      .status-card-approved .status-card-icon {
        background: #ecfdf5;
        color: #0f766e;
      }

      .status-card-pending {
        border-color: #fde68a;
        background: linear-gradient(145deg, #fffbeb, #ffffff);
      }

      .status-card-pending .status-card-icon {
        background: #fef3c7;
        color: #b45309;
      }

      .status-card-rejected {
        border-color: #fecdd3;
        background: linear-gradient(145deg, #fef2f2, #ffffff);
      }

      .status-card-rejected .status-card-icon {
        background: #fee2e2;
        color: #b91c1c;
      }
      
      .status-card-total {
        border-color: #c7d2fe;
        background: linear-gradient(145deg, #eef2ff, #ffffff);
      }

      .status-card-total .status-card-icon {
        background: #e0e7ff;
        color: #4338ca;
      }

      .add-product-sidebar-content {
        display: none;
      }

      @keyframes fadeOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(-20px);
        }
      }

      @media (max-width: 1200px) {
        .app {
          grid-template-columns: 1fr;
        }

        .sidebar {
          position: static;
          height: auto;
          flex-direction: row;
          overflow-x: auto;
        }

        .content {
          padding: 32px 24px;
        }

        .topbar {
          flex-direction: column;
          align-items: flex-start;
        }

        .search input {
          width: 100%;
        }
      }

      @media (max-width: 768px) {
        .grid.stats,
        .grid.two {
          grid-template-columns: 1fr;
        }

        .sidebar {
          display: none;
        }

        .content {
          padding: 24px 16px 48px;
        }

        .topbar {
          border-radius: 18px;
        }
      }

      /* Add Product Sidebar Styles */
      .app.add-product-mode .sidebar {
        overflow-y: auto;
        padding: 18px 14px;
        gap: 8px;
        background: #0a0a0a;
        color: #fff;
      }

      .app.add-product-mode .sidebar .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 8px 14px 8px;
        border-bottom: 1px solid rgba(255,255,255,0.06);
        margin-bottom: 10px;
      }

      .app.add-product-mode .sidebar .logo .dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #4ade80;
      }

      .app.add-product-mode .sidebar .side-group {
        margin-top: 8px;
        display: block;
      }

      .app.add-product-mode .sidebar .side-title {
        font-size: 12px;
        letter-spacing: .08em;
        text-transform: uppercase;
        color: #bdbdbd;
        margin: 10px 8px 6px;
      }

      .app.add-product-mode .sidebar .side-link {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 10px;
        border-radius: 8px;
        color: #eaeaea;
        cursor: pointer;
      }

      .app.add-product-mode .sidebar .side-link:hover,
      .app.add-product-mode .sidebar .side-link.active {
        background: #141414;
        color: #fff;
      }
    </style>
    <script src="{{ url_for('static', filename='js/timezone.js') }}"></script>
  </head>
  <body>
    <div class="app">
      
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Seller Dashboard</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Store Management</div>
          <a class="side-link" href="#" data-page="overview">Overview</a>
          <a class="side-link" href="#" data-page="products">Products</a>
          <a class="side-link" href="#" data-page="add-product" style="padding-left: 24px; font-size: 14px;">+ Add Product</a>
          <a class="side-link" href="#" data-page="archived-products">Archived Products</a>
          <a class="side-link" href="#" data-page="orders" id="orders-link">
            Orders
            <span class="order-count-badge" id="order-count-badge" style="display:none;background:#ef4444;color:#fff;border-radius:999px;padding:2px 6px;font-size:10px;margin-left:auto;">0</span>
          </a>
          <a class="side-link" href="#" data-page="inventory">Inventory</a>
          <a class="side-link" href="#" data-page="reviews">Customer Reviews</a>
          <a class="side-link" href="#" data-page="notifications">Notifications</a>
        </div>
        <div class="side-group">
          <div class="side-title">Analytics</div>
          <a class="side-link" href="#" data-page="sales">Sales Analytics</a>
          <a class="side-link" href="#" data-page="performance">Performance</a>
        </div>
        <div class="side-group">
          <div class="side-title">Settings</div>
          <a class="side-link" href="#" data-page="account-settings">Account</a>
        </div>
      </aside>

      
      <section class="content">
        <div class="topbar">
          <div class="page-title">Store Dashboard</div>
          <div class="search"><input id="dashboardSearch" name="dashboardSearch" placeholder="Search products, orders..."/></div>
          <div class="avatar">
            <span class="tag store-name">Brand: {{ seller.store_name if seller else 'Your Brand' }}</span>
            <span class="tag" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">üó∫Ô∏è
              {% if seller and seller.island_group %}
                {{ seller.island_group }}
              {% else %}
                Not Set
              {% endif %}
            </span>
            <span class="tag status-badge {% if seller and seller.status == 'approved' %}status-active{% else %}status-pending{% endif %}">
              {% if seller and seller.status == 'approved' %}Active{% elif seller %}{{ seller.status.title() }}{% else %}Pending{% endif %}
            </span>
            <a href="#" onclick="confirmLogout(event); return false;" style="margin-left: 10px; padding: 8px 16px; background: #ef4444; color: #fff; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 500;">Logout</a>
          </div>
        </div>

        <main class="main" id="dashboardContent">
          
          <div class="grid stats">
            <div class="card">
              <div class="inner">
                <div class="metric">Today's Sales</div>
                <div class="value">‚Ç±{{ "{:,.2f}".format(today_sales if today_sales else 0) }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Pending Orders</div>
                <div class="value">{{ pending_orders if pending_orders else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Products</div>
                <div class="value">{{ product_count if product_count else 0 }}</div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Rating</div>
                <div class="value">{{ "{:.1f}".format(seller.rating if seller and seller.rating else 0) }}</div>
              </div>
            </div>
          </div>

          
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div class="metric">Weekly Sales Overview</div>
                <div class="chart">
                  <div class="bars">
                    {% for day in ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] %}
                    {% set bar_height = ((weekly_sales[day] / max_weekly_sales) * 100)|int if weekly_sales[day] > 0 else 5 %}
                    <div class="bar" style="height:{{ bar_height }}%"></div>
                    {% endfor %}
                  </div>
                  <div class="legend">
                    <span>Sun</span>
                    <span>Mon</span>
                    <span>Tue</span>
                    <span>Wed</span>
                    <span>Thu</span>
                    <span>Fri</span>
                    <span>Sat</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                  <div class="metric">Top Performing Products</div>
                  <button class="action-btn" data-load-page="add-product" style="padding: 6px 12px; font-size: 12px;">+ Add Product</button>
                </div>
                <div style="margin-top:10px" id="topProducts">
                  {% if top_products and top_products|length > 0 %}
                    {% set max_sales = (top_products[0].sales_count if (top_products and top_products[0].sales_count) else 1) %}
                    {% for product in top_products[:3] %}
                      {% if not loop.first %}
                      <div style="height:16px"></div>
                      {% endif %}
                      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
                        <div>{{ product.name }}</div>
                        <div class="tag" style="background:#efefef;color:#0a0a0a">{{ product.sales_count or 0 }} sold</div>
                      </div>
                      <div style="height:6px;background:#efefef;border-radius:999px;overflow:hidden">
                        {% set progress_width = ((product.sales_count / max_sales if max_sales > 0 else 0) * 100)|int %}
                        <div style="height:6px;background:#0a0a0a;border-radius:999px;width:{{ progress_width }}%;"></div>
                      </div>
                    {% endfor %}
                  {% else %}
                    <p style="text-align:center;color:#999;padding:20px;">No sales data yet. <a href="#" data-load-page="add-product" style="color:#0a0a0a;text-decoration:underline;">Add your first product</a></p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          
          <div class="grid two" style="margin-top:14px">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Orders</div>
                  <a href="#" class="action-btn" data-load-page="orders">Process Orders</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Product</th>
                        <th>Amount</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_orders %}
                        {% for order in recent_orders %}
                        <tr>
                          <td>{{ order.order_number }}</td>
                          <td>{{ order.first_name }} {{ order.last_name }}</td>
                          <td>{% if order.products %}{{ order.products[:30] }}...{% else %}-{% endif %}</td>
                          <td>‚Ç±{{ "{:,.2f}".format(order.total_amount) }}</td>
                          <td><span class="status-badge status-{{ 'active' if order.order_status == 'delivered' else 'pending' }}">{{ order.order_status.title() }}</span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent orders</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Low Stock Alert</div>
                  <a href="#" class="action-btn">Restock Now</a>
                </div>
                <div style="margin-top:10px">
                  <table>
                    <thead>
                      <tr>
                        <th>Product</th>
                        <th>Stock</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if low_stock %}
                        {% for product in low_stock %}
                        <tr>
                          <td>{{ product.name }}</td>
                          <td>{{ product.stock_quantity }} pcs</td>
                          <td><span class="status-badge {% if product.stock_quantity <= 3 %}status-inactive{% else %}status-pending{% endif %}">
                            {% if product.stock_quantity <= 3 %}Critical{% else %}Low{% endif %}
                          </span></td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="3" style="text-align:center;color:#999">All products in stock</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
      </section>
    </div>
    <script>
      console.log('‚úÖ [INIT] SellerDashboard script starting...');

      // Declare global variables early so they're available when needed
      let pageTemplates = {};
      let pendingAccountSettingsSection = null;
      let allOrders = []; // Global orders array for filtering
      let currentOrderFilter = 'all'; // Track current filter state
      let currentOrderSearchTerm = '';
      let sellerProductsCache = [];
      let currentProductStatusFilter = 'all';
      let currentProductSearchTerm = '';
      let archivedProductsCache = [];
      let currentArchivedSearchTerm = '';
      const ACCOUNT_SETTINGS_FIELD_IDS = [
        'store-name',
        'store-description',
        'contact-email',
        'contact-phone',
        'store-address',
        'island-group'
      ];
      const VALID_ISLAND_GROUPS = ['Luzon', 'Visayas', 'Mindanao'];

      function initializeAccountSettingsFieldGuards() {
        ACCOUNT_SETTINGS_FIELD_IDS.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (!field || field.dataset.dirtyWatcherBound === 'true') {
            return;
          }

          const markDirty = () => {
            field.dataset.userEdited = 'true';
          };

          field.addEventListener('input', markDirty);
          field.addEventListener('change', markDirty);
          field.dataset.dirtyWatcherBound = 'true';
        });
      }

      function resetAccountSettingsDirtyFlags() {
        ACCOUNT_SETTINGS_FIELD_IDS.forEach(fieldId => {
          const field = document.getElementById(fieldId);
          if (field) {
            field.dataset.userEdited = 'false';
          }
        });
      }

      function setAccountSettingsFieldValue(fieldId, value, options = {}) {
        const { force = false } = options;
        const field = document.getElementById(fieldId);
        if (!field) {
          return;
        }

        if (!force && field.dataset.userEdited === 'true') {
          return;
        }

        const sanitizedValue = value == null ? '' : String(value);

        if (field.tagName === 'SELECT') {
          const optionExists = Array.from(field.options).some(option => option.value === sanitizedValue);
          field.value = optionExists ? sanitizedValue : '';
        } else {
          field.value = sanitizedValue;
        }

        field.dataset.userEdited = 'false';
      }

      function formatPHDate(value, options) {
        if (!value) return 'N/A';
        if (window.PhilippineTime && typeof window.PhilippineTime.formatDate === 'function') {
          const formatted = window.PhilippineTime.formatDate(value, options);
          if (formatted) return formatted;
        }
        const date = new Date(value);
        return date.toLocaleDateString('en-PH', Object.assign({ timeZone: 'Asia/Manila' }, options || {}));
      }

      function formatPHDateTime(value, options) {
        if (!value) return 'N/A';
        if (window.PhilippineTime && typeof window.PhilippineTime.formatDateTime === 'function') {
          const formatted = window.PhilippineTime.formatDateTime(value, options);
          if (formatted) return formatted;
        }
        const date = new Date(value);
        return date.toLocaleString('en-PH', Object.assign({ timeZone: 'Asia/Manila' }, options || {}));
      }

      function formatPHTime(value, options) {
        if (!value) return 'N/A';
        if (window.PhilippineTime && typeof window.PhilippineTime.formatTime === 'function') {
          const formatted = window.PhilippineTime.formatTime(value, options);
          if (formatted) return formatted;
        }
        const date = new Date(value);
        return date.toLocaleTimeString('en-PH', Object.assign({ timeZone: 'Asia/Manila' }, options || {}));
      }

      function updateOrderCount(count) {
        const badge = document.getElementById('order-count-badge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      function fetchOrderCount() {
        fetch('/seller/orders', { credentials: 'include' })
          .then(response => response.json())
          .then(data => {
            if (data.success && data.orders && Array.isArray(data.orders)) {
              updateOrderCount(data.orders.length);
            } else {
              updateOrderCount(0);
            }
          })
          .catch(error => {
            console.error('Error fetching order count:', error);
          });
      }

      const searchCapablePages = new Set();
      const searchPlaceholders = {
        'archived-products': 'Search archived products...',
        'orders': 'Search orders or customers...',
        'inventory': 'Search SKUs, colors, sizes...',
        'notifications': 'Search notifications...'
      };

      function updateSearchBarVisibility(page) {
        const searchContainer = document.querySelector('.topbar .search');
        const searchInput = document.getElementById('dashboardSearch');
        if (!searchContainer || !searchInput) {
          return;
        }

        const shouldShow = searchCapablePages.has(page);
        searchContainer.style.display = shouldShow ? 'flex' : 'none';

        if (shouldShow) {
          searchInput.placeholder = searchPlaceholders[page] || 'Search records...';
        } else {
          searchInput.value = '';
        }
      }

      function handleOrderSearchInput(event) {
        currentOrderSearchTerm = (event.target.value || '').trim();
        filterOrders();
      }

      function initializeOrderSearchField() {
        const searchInput = document.getElementById('order-search-input');
        if (!searchInput) {
          return;
        }

        ['input', 'search'].forEach(eventName => {
          searchInput.removeEventListener(eventName, handleOrderSearchInput);
        });

        searchInput.value = currentOrderSearchTerm;

        ['input', 'search'].forEach(eventName => {
          searchInput.addEventListener(eventName, handleOrderSearchInput);
        });
      }
      
      function loadPage(page) {
        console.log('=== LOADING PAGE:', page, '===');
        const content = document.getElementById('dashboardContent');
        const app = document.querySelector('.app');

        if (!content) {
          console.error('‚ùå ERROR: dashboardContent element not found!');
          return;
        }
        if (!app) {
          console.error('‚ùå ERROR: app element not found!');
          return;
        }

        try {
          updateSearchBarVisibility(page);
          if (page === 'add-product') {
            app.classList.add('add-product-mode');
            updateAddProductSidebar();
          } else {
            app.classList.remove('add-product-mode');
            clearAddProductSidebar();
          }

          const links = document.querySelectorAll('.side-link');
          links.forEach(l => l.classList.remove('active'));
          const activeLink = document.querySelector(`[data-page="${page}"]`);
          if (activeLink) activeLink.classList.add('active');

          const pageNames = {
            'overview': 'Store Dashboard',
            'add-product': '‚ûï Add New Product',
            'products': 'üì¶ Product Management',
            'archived-products': 'üóÑÔ∏è Archived Products',
            'inventory': 'üìã Inventory Management',
            'orders': 'üõí Order Management',
            'reviews': '‚≠ê Customer Reviews',
            'notifications': 'üîî Notifications',
            'sales': 'üìä Sales Analytics',
            'performance': 'üìà Performance',
            'account-settings': '‚öôÔ∏è Account Settings'
          };
          const titleEl = document.querySelector('.page-title');
          if (titleEl) titleEl.textContent = pageNames[page] || 'Seller Dashboard';

          if (page === 'overview') {
            window.location.href = '/seller-dashboard';
            return;
          }

          if (!content) {
            console.error('ERROR: dashboardContent element not found');
            return;
          }

          if (pageTemplates[page]) {
            content.innerHTML = pageTemplates[page];

            if (typeof PageNavigator !== 'undefined' && typeof PageNavigator.bindPageLoadElements === 'function') {
              PageNavigator.bindPageLoadElements();
            }
            const accountSectionToFocus = pendingAccountSettingsSection;
            pendingAccountSettingsSection = null;

            requestAnimationFrame(() => {
              if (page === 'products') {
                loadProducts();
              } else if (page === 'archived-products') {
                loadArchivedProducts();
              } else if (page === 'inventory') {
                loadInventory();
              } else if (page === 'reviews') {
                loadReviews();
              } else if (page === 'notifications') {
                loadNotifications();
              } else if (page === 'sales') {
                loadSalesAnalytics();
              } else if (page === 'performance') {
                loadPerformance();
              } else if (page === 'account-settings') {
                loadAccountSettings();
                setupProfileSettingsForm();
                if (accountSectionToFocus) {
                  setTimeout(() => focusAccountSettingsSection(accountSectionToFocus), 200);
                }
              } else if (page === 'orders') {
                currentOrderSearchTerm = '';
                initializeOrderSearchField();
                loadOrders('all');
              } else if (page === 'add-product') {
                loadCategories();
              }
            });
          } else {
            if (content) {
              content.innerHTML = '<div class="card"><div class="inner" style="text-align:center;padding:40px;"><div style="color:#ef4444;font-size:18px;font-weight:600;margin-bottom:8px;">Page Template Not Found</div><small style="color:#999;">The page template for ' + page + ' is not defined. This is a system error.</small></div></div>';
            }
            console.warn('WARNING: No template found for page: ' + page);
            pendingAccountSettingsSection = null;
          }
        } catch (error) {
          console.error('‚ùå ERROR in loadPage:', error);
          if (content) {
            content.innerHTML = '<div class="card"><div class="inner" style="text-align:center;padding:40px;"><div style="color:#ef4444;font-size:18px;font-weight:600;margin-bottom:8px;">Error Loading Page</div><small style="color:#999;">An error occurred: ' + error.message + '</small></div></div>';
          }
        }
      }

      const pageTemplates_content = {
        'add-product': `
          <div class="card">
            <div class="inner" style="max-width: 900px; margin: 0 auto;">
              <h2 style="margin: 0 0 24px; padding-bottom: 16px; border-bottom: 2px solid var(--line);"></h2>
              <form id="addProductForm" action="/seller/add-product" method="POST" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 24px;">

                
                <div style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">1</span> Basic Information</h3>

                  <div style="display: grid; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Product Name *</label>
                      <input type="text" name="name" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px; transition: border-color 0.2s;" placeholder="Enter product name">
                    </div>

                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Description</label>
                      <textarea name="description" rows="4" style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px; resize: vertical; transition: border-color 0.2s;" placeholder="Describe your product (features, materials, care instructions, etc.)"></textarea>
                    </div>

                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Category/Genre *</label>
                      <select id="categorySelect" name="category_id" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px; background: white; cursor: pointer; transition: border-color 0.2s;" onchange="toggleSizeColorSections()">
                        <option value="">Select a category</option>
                        
                      </select>
                      <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">This determines which fields you'll need to fill</small>
                    </div>
                  </div>
                </div>

                
                <div style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">2</span> Product Images</h3>

                  <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #0a0a0a;">Upload Images *</label>
                    <div id="dropZone" style="border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; text-align: center; background: #f0f9ff; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#0a0a0a'; this.style.background='#f3f4f6'" onmouseout="this.style.borderColor='#3b82f6'; this.style.background='#f0f9ff'">
                      <span style="display: block; font-size: 28px; margin-bottom: 8px;">üì∏</span>
                      <span style="display: block; font-weight: 500; color: #0a0a0a; margin-bottom: 4px;">Click or drag images here</span>
                      <span style="display: block; font-size: 12px; color: var(--muted);">JPG, PNG (max 5MB each) ‚Ä¢ Multiple images allowed</span>
                    </div>
                    <input type="file" id="productImages" name="product_images" accept="image/*" multiple required style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px; margin-top: 8px; font-size: 13px;">

                    
                    <div id="imagePreviewContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; margin-top: 16px;">
                      
                    </div>
                  </div>
                </div>

                
                <div style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #3b82f6; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">3</span> Pricing & Inventory</h3>

                  <div style="display: grid; grid-template-columns: 1fr; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Price (‚Ç±) *</label>
                      <input type="number" name="price" step="0.01" min="0.01" data-field-label="Price" data-require-positive="true" oninput="enforceNonNegativeValue(this)" required style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px; transition: border-color 0.2s;" placeholder="0.00">
                      <small style="color: var(--muted); font-size: 11px; margin-top: 4px; display: block;">Selling price of your product</small>
                    </div>
                  </div>
                </div>

                
                <!-- Grooming Product Ingredients Section -->
                <div id="ingredientsSection" style="display: none; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">4</span> Product Ingredients</h3>
                  <small style="color: var(--muted); font-size: 13px; margin-bottom: 16px; display: block;">List the ingredients for this grooming product</small>
                  
                  <div style="margin-bottom: 12px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Ingredients</label>
                    <textarea name="ingredients" rows="6" style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px; resize: vertical;" placeholder="Enter ingredients separated by commas&#10;Example: Water, Glycerin, Aloe Vera Extract, Vitamin E, Fragrance"></textarea>
                    <small style="color: var(--muted); font-size: 12px; margin-top: 4px; display: block;">Separate each ingredient with a comma</small>
                  </div>
                  
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Volume/Size</label>
                      <input type="text" name="volume" style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px;" placeholder="e.g., 100ml, 50g, 200ml">
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; color: #0a0a0a;">Stock Quantity *</label>
                      <input type="number" name="grooming_stock" min="1" data-field-label="Stock quantity" data-require-positive="true" oninput="enforceNonNegativeValue(this)" style="width: 100%; padding: 10px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 14px;" placeholder="0">
                    </div>
                  </div>
                </div>

                <!-- Apparel Product Variants Section -->
                <div id="variantsSection" style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">4</span> Product Variants</h3>
                  <small style="color: var(--muted); font-size: 13px; margin-bottom: 16px; display: block;">Define colors and sizes available for this product. You'll set stock quantities for each combination.</small>

                  
                  <div style="margin-bottom: 20px; padding: 14px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;" id="colorsSection">
                    <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #0a0a0a;">üé® Available Colors *</h4>
                    <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Select predefined colors or add custom ones</small>

                    
                    <div id="predefinedColors" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-bottom: 12px;">
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s; hover-bg: #f3f4f6;">
                        <input type="checkbox" name="colors" value="Black" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #000000; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Black</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="White" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #FFFFFF; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>White</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Gray" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #808080; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Gray</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Navy" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #000080; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Navy</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Blue" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #0000FF; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Blue</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Red" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #FF0000; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Red</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Green" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #008000; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Green</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Brown" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #8B4513; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Brown</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Beige" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #F5F5DC; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Beige</span>
                        </span>
                      </label>
                      <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px; transition: all 0.2s;">
                        <input type="checkbox" name="colors" value="Khaki" style="margin: 0; width: 16px; height: 16px;" onchange="updateColorTabs()">
                        <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                          <span style="width: 18px; height: 18px; background: #F0E68C; border: 1px solid #ccc; border-radius: 3px;"></span>
                          <span>Khaki</span>
                        </span>
                      </label>
                    </div>

                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #0a0a0a;">Custom Colors</label>
                      <input type="text" id="custom-colors" placeholder="e.g. Burgundy, Olive, Charcoal (comma-separated)"
                        style="width: 100%; padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px;"
                        oninput="updateColorTabs()"
                        onchange="updateColorTabs()"
                        onblur="updateColorTabs()">
                      <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Add custom colors not listed above</small>
                    </div>
                  </div>

                  
                  <div style="margin-bottom: 20px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <p style="margin: 0 0 10px; font-size: 13px; font-weight: 500; color: #0a0a0a; text-align: left; line-height: 1.4;">üëá Select a color to set its sizes:</p>
                    <div id="colorTabs" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;">
                      
                    </div>
                  </div>

                  
                  <div style="margin-bottom: 20px; padding: 14px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;" id="sizesSection">
                    <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #0a0a0a;">üìè Available Sizes *</h4>
                    <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Select a color tab above first, then choose sizes for that color</small>

                    
                    <div id="perColorSizesContainer" style="display: none;">
                      
                      <div id="clothingSizes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="XS" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">XS</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="S" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">S</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="M" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">M</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="L" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">L</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="XL" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">XL</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="2XL" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">2XL</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="3XL" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">3XL</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="4XL" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">4XL</span>
                        </label>
                      </div>

                    
                      <div id="shoeSizes" style="display: none; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="5" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">5</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="6" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">6</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="7" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">7</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="8" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">8</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="9" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">9</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="10" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">10</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="11" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">11</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="12" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">12</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                          <input type="checkbox" name="sizes" class="color-size-checkbox" value="13" style="margin: 0; width: 14px; height: 14px;" onchange="updateStockInputs()">
                          <span style="font-size: 13px;">13</span>
                        </label>
                      </div>

                      <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #0a0a0a;">Custom Sizes</label>
                        <input type="text" id="custom-sizes-per-color" placeholder="e.g. 36, 37, 38, 5XL (comma-separated)"
                          style="width: 100%; padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px;"
                          oninput="updateStockInputs()"
                          onchange="updateStockInputs()"
                          onblur="updateStockInputs()">
                        <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Add custom sizes for <span id="current-color-size-label" style="font-weight: 600; color: #3b82f6;">selected color</span></small>
                      </div>
                    </div>

                    
                    <p id="sizesPlaceholder" style="color: var(--muted); font-style: italic; margin: 0; padding: 12px; text-align: center; background: #f9fafb; border-radius: 4px;">üëâ Select a color tab above to add sizes for that color</p>
                  </div>
                </div>

                
                <div id="ingredientsSection" style="display: none; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #10b981; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">4</span> Product Ingredients *</h3>
                  <small style="color: var(--muted); font-size: 13px; margin-bottom: 12px; display: block;">üìù Enter all ingredients at once. One ingredient per line.</small>

                  
                  <div style="margin-bottom: 14px;">
                    <textarea id="ingredientsInput" name="ingredientsInput"
                      style="width: 100%; padding: 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px; font-family: 'Monaco', 'Courier New', monospace; resize: vertical; min-height: 120px;"
                      placeholder="Example:&#10;Aloe Vera&#10;Water&#10;Glycerin&#10;Vitamin E"></textarea>
                  </div>

                  
                  <div style="background: #f0fdf4; border: 1px solid #dcfce7; border-radius: 6px; padding: 12px; margin-bottom: 14px; font-size: 12px; color: #166534;">
                    <strong style="display: block; margin-bottom: 6px;">üìã Format Guide:</strong>
                    <ul style="margin: 0; padding-left: 18px; line-height: 1.5;">
                      <li>Each ingredient on a new line</li>
                      <li>Just type the ingredient name</li>
                      <li>No special formatting needed</li>
                      <li>Example: <code style="background: white; padding: 2px 4px; border-radius: 3px;">Aloe Vera</code></li>
                    </ul>
                  </div>

                  
                  <button type="button" class="action-btn" onclick="parseIngredientsFromTextarea()"
                    style="padding: 10px 16px; margin-bottom: 12px; font-size: 13px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; transition: background 0.2s; width: 100%;">
                    ‚úì Add Ingredients
                  </button>

                  
                  <div style="overflow-x: auto; margin-bottom: 12px; border: 1px solid var(--line); border-radius: 6px; display: none;" id="ingredientsPreviewContainer">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead>
                        <tr style="background: #f3f4f6;">
                          <th style="padding: 10px 12px; text-align: left; border-bottom: 2px solid var(--line); font-weight: 600; font-size: 13px; color: #0a0a0a;">Ingredient Name</th>
                          <th style="padding: 10px 12px; text-align: center; border-bottom: 2px solid var(--line); font-weight: 600; font-size: 13px; color: #0a0a0a; width: 80px;">Action</th>
                        </tr>
                      </thead>
                      <tbody id="ingredientsTableBody">
                        
                      </tbody>
                    </table>
                  </div>

                  
                  <div id="ingredientsStatus" style="padding: 10px 12px; border-radius: 6px; font-size: 12px; text-align: center; color: #666; display: none;"></div>

                  
                  <textarea id="ingredients" name="ingredients" rows="1" style="display: none;" placeholder="Ingredients JSON"></textarea>
                  <small id="ingredientsHint" style="color: var(--muted); font-size: 11px; display: block; margin-top: 6px;">üëá Fill in the ingredients above and click "Add Ingredients"</small>
                </div>

                
                <div id="size-color-stocks" style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;"><span style="background: #f59e0b; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 700;">5</span> Stock Quantities</h3>
                  <small style="color: var(--muted); font-size: 13px; margin-bottom: 16px; display: block;">Set stock quantity for each size in the <strong id="stock-table-color">selected color</strong></small>
                  <div id="stock-inputs" style="border: 1px solid var(--line); border-radius: 6px; overflow: hidden;">
                    <p style="color: var(--muted); font-style: italic; margin: 0; padding: 16px; text-align: center; background: #f9fafb;">üëâ Select a color and sizes to set stock quantities</p>
                  </div>
                </div>

                <!-- Stock & Variants Summary -->
                <div id="stock-variants-summary" style="padding: 16px; background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; display: none;">
                  <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    üì¶ Stock & Variants
                  </h4>
                  <div style="background: white; border-radius: 6px; overflow: hidden; max-height: 300px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                      <thead style="position: sticky; top: 0; background: #fef3c7;">
                        <tr>
                          <th style="padding: 10px; text-align: left; border: 1px solid #fbbf24; font-weight: 600; font-size: 13px;">Size</th>
                          <th style="padding: 10px; text-align: left; border: 1px solid #fbbf24; font-weight: 600; font-size: 13px;">Color</th>
                          <th style="padding: 10px; text-align: right; border: 1px solid #fbbf24; font-weight: 600; font-size: 13px;">Stock</th>
                        </tr>
                      </thead>
                      <tbody id="stock-variants-tbody">
                        <!-- Dynamically populated -->
                      </tbody>
                    </table>
                  </div>
                  <div style="margin-top: 12px; padding: 10px; background: #fef3c7; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-weight: 600; font-size: 14px;">Total Stock:</span>
                    <span id="total-stock-count" style="font-size: 18px; font-weight: 700; color: #b45309;">0 pcs</span>
                  </div>
                </div>

                
                <div style="display: flex; gap: 12px;">
                  <button type="button" class="action-btn" style="padding: 12px 24px; background: #0a0a0a; color: #fff; font-weight: 600; font-size: 14px; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s;" onclick="confirmAddProduct()">‚úì Add Product</button>
                  <button type="button" class="action-btn" data-load-page="products" style="padding: 12px 24px; background: #f3f4f6; color: #0a0a0a; font-weight: 500; font-size: 14px; border: 1px solid var(--line); border-radius: 6px; cursor: pointer; transition: all 0.2s;">Cancel</button>
                </div>

                <input type="hidden" name="custom-sizes" id="custom-sizes-hidden">
                <input type="hidden" name="custom-colors" id="custom-colors-hidden">
              </form>
            </div>
          </div>
        `,

        'products': `
          <div class="card">
            <div class="inner">
              <div class="page-section-header">
                <div>
                  <p class="page-section-eyebrow">Catalog Oversight</p>
                  <p class="page-section-subtitle">Review approvals, edit listings, and keep every item shopper-ready.</p>
                </div>
                <div class="page-section-actions">
                  <input type="search" id="product-search-input" placeholder="Search by name, category, or status" autocomplete="off">
                  <button class="action-btn" onclick="loadPage('add-product')">+ Add Product</button>
                </div>
              </div>
              <div id="products-list">Loading products...</div>
            </div>
          </div>
        `,

        'edit-product': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;">Edit Product</h2>
              <div id="edit-product-form">Loading product...</div>
            </div>
          </div>
        `,

        'archived-products': `
          <div class="card">
            <div class="inner">
              <div class="page-section-header">
                <div>
                  <p class="page-section-eyebrow">Product Lifecycle</p>
                  <p class="page-section-subtitle">Review what is shelved and request speedy recoveries when ready.</p>
                </div>
                <div class="page-section-actions">
                  <input type="search" id="archived-search-input" placeholder="Search archived items by name or status" autocomplete="off">
                </div>
              </div>
              <div id="archived-products-list">Loading archived products...</div>
            </div>
          </div>
        `,

        'inventory': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                <div>
                  <h2 style="margin: 0 0 4px 0; font-size: 24px; font-weight: 700;"></h2>
                  <p style="margin: 0; font-size: 13px; color: #6b7280;">Manage stock levels for all your products and variants</p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="text" id="inventory-search" placeholder="Search products..." style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; width: 220px;">
                  <button onclick="loadInventory()" style="padding: 8px 16px; background: #0a0a0a; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                    üîÑ Refresh
                  </button>
                </div>
              </div>
              
              <div id="inventory-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px;">
                <!-- Stats will be populated by JS -->
              </div>
              
              <div id="inventory-list" style="overflow-x: auto;">Loading inventory...</div>
            </div>
          </div>
        `,

        'orders': `
          <div class="card">
            <div class="inner">
              <div class="page-section-header">
                <div>
                  <p class="page-section-eyebrow">Order Flow</p>
                  <p class="page-section-subtitle">Filter, search, and track every customer promise in one place.</p>
                </div>
                <div class="page-section-actions">
                  <input type="search" id="order-search-input" placeholder="Search orders or customers..." autocomplete="off">
                  <button style="background: #3b82f6; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display:flex; align-items:center; gap:8px;" onclick="loadPage('notifications')">
                    üîî Notifications
                    <span id="notification-badge" style="background: #ef4444; color: white; border-radius: 999px; padding: 2px 8px; font-size: 11px; font-weight: 600; display: none;">0</span>
                  </button>
                </div>
              </div>

              <div class="order-status-grid" role="group" aria-label="Order status filters">
                <button type="button" class="order-status-card" data-filter-btn="all" data-status="all" data-state="active" aria-pressed="true" onclick="filterOrders('all')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">üìã</span>
                    <span class="order-status-card__count" data-status-count="all">0</span>
                  </div>
                  <div class="order-status-card__label">All Orders</div>
                  <p class="order-status-card__hint">Everything currently in motion</p>
                </button>
                <button type="button" class="order-status-card" data-filter-btn="pending" data-status="pending" data-state="idle" aria-pressed="false" onclick="filterOrders('pending')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">‚è≥</span>
                    <span class="order-status-card__count" data-status-count="pending">0</span>
                  </div>
                  <div class="order-status-card__label">Pending</div>
                  <p class="order-status-card__hint">Awaiting confirmation</p>
                </button>
                <button type="button" class="order-status-card" data-filter-btn="confirmed" data-status="confirmed" data-state="idle" aria-pressed="false" onclick="filterOrders('confirmed')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">‚úîÔ∏è</span>
                    <span class="order-status-card__count" data-status-count="confirmed">0</span>
                  </div>
                  <div class="order-status-card__label">Confirmed</div>
                  <p class="order-status-card__hint">Ready to pack and ship</p>
                </button>
                <button type="button" class="order-status-card" data-filter-btn="waiting_for_pickup" data-status="waiting_for_pickup" data-state="idle" aria-pressed="false" onclick="filterOrders('waiting_for_pickup')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">‚è∞</span>
                    <span class="order-status-card__count" data-status-count="waiting_for_pickup">0</span>
                  </div>
                  <div class="order-status-card__label">Waiting</div>
                  <p class="order-status-card__hint">Queued for rider pickup</p>
                </button>
                <button type="button" class="order-status-card" data-filter-btn="released_to_rider" data-status="released_to_rider" data-state="idle" aria-pressed="false" onclick="filterOrders('released_to_rider')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">üöö</span>
                    <span class="order-status-card__count" data-status-count="released_to_rider">0</span>
                  </div>
                  <div class="order-status-card__label">Release to rider</div>
                  <p class="order-status-card__hint">Handoff to riders in progress</p>
                </button>
                <button type="button" class="order-status-card" data-filter-btn="delivered" data-status="delivered" data-state="idle" aria-pressed="false" onclick="filterOrders('delivered')">
                  <div class="order-status-card__top">
                    <span class="order-status-card__emoji">‚úÖ</span>
                    <span class="order-status-card__count" data-status-count="delivered">0</span>
                  </div>
                  <div class="order-status-card__label">Delivered</div>
                  <p class="order-status-card__hint">Completed drops</p>
                </button>
              </div>

              <div id="orders-list" style="overflow-x: auto;">
                <p style="color: #999; text-align: center; padding: 40px;">Use the filters or search field above to surface orders.</p>
              </div>
            </div>
          </div>
        `,

        'reviews': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"></h2>
                <div style="display: flex; gap: 8px;">
                  <button class="action-btn" onclick="filterReviews('all')" data-review-filter="all" style="background: #666;">All Reviews</button>
                  <button class="action-btn" onclick="filterReviews('pending')" data-review-filter="pending" style="background: #ff9800;">Pending</button>
                </div>
              </div>
              <div id="reviews-list">Loading reviews...</div>
            </div>
          </div>
        `,

        'notifications': `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"></h2>
                <button class="action-btn" onclick="markAllNotificationsRead()" style="background: #0a0a0a; padding: 8px 16px;">Mark All as Read</button>
              </div>
              <div id="notifications-list" style="display: grid; gap: 12px;">
                <p style="color: var(--muted); text-align: center; padding: 40px 0;">Loading notifications...</p>
              </div>
            </div>
          </div>
        `,

        'sales': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 20px;"></h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Revenue (30 days)</div>
                  <div id="total-revenue" style="font-size: 24px; font-weight: 700; color: #10b981;">‚Ç±0.00</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Orders</div>
                  <div id="total-orders" style="font-size: 24px; font-weight: 700; color: #2196f3;">0</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Average Order Value</div>
                  <div id="avg-order" style="font-size: 24px; font-weight: 700; color: #ff9800;">‚Ç±0.00</div>
                </div>
              </div>
              <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Sales by Product</h3>
                <div id="sales-by-product" style="display: grid; gap: 12px;">
                  <p style="color: var(--muted); text-align: center;">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        `,

        'performance': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 16px;"></h2>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px;">
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Average Rating</div>
                  <div id="avg-rating" style="font-size: 24px; font-weight: 700; color: #4caf50;">4.5 ‚≠ê</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Repeat Customers</div>
                  <div id="repeat-customers" style="font-size: 24px; font-weight: 700; color: #9c27b0;">0</div>
                </div>
                <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px; text-align: center;">
                  <div style="color: var(--muted); font-size: 13px; margin-bottom: 8px;">Total Reviews</div>
                  <div id="total-reviews" style="font-size: 24px; font-weight: 700; color: #ff5722;">0</div>
                </div>
              </div>
              <div style="background: #f9f9f9; border: 1px solid var(--line); border-radius: 8px; padding: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 14px; font-weight: 600;">Top Rated Products</h3>
                <div id="top-rated-products" style="display: grid; gap: 12px;">
                  <p style="color: var(--muted); text-align: center;">Loading...</p>
                </div>
              </div>
            </div>
          </div>
        `,

        'account-settings': `
          <div class="card">
            <div class="inner">
              <h2 style="margin: 0 0 24px;"></h2>
              
              <form id="profile-settings-form">
                <div id="brand-settings-section" style="margin-bottom: 32px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 16px; color: #0a0a0a; font-size: 16px;">Brand Information</h3>
                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Brand Name *</label>
                    <input type="text" id="store-name" name="store_name" placeholder="Enter brand name" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;" required>
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Brand Description *</label>
                    <textarea id="store-description" name="description" placeholder="Tell customers about your brand" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;" required></textarea>
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contact Email</label>
                    <input type="email" id="contact-email" name="contact_email" placeholder="Enter contact email" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Contact Phone</label>
                    <input type="text" id="contact-phone" name="contact_phone" placeholder="Enter contact phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Store Address</label>
                    <input type="text" id="store-address" name="address" placeholder="Enter store address" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                  </div>

                  <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">üó∫Ô∏è Service Island Location</label>
                    <select id="island-group" name="island_group" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;">
                      <option value="">Select your service island...</option>
                      <option value="Luzon">üèùÔ∏è Luzon</option>
                      <option value="Visayas">üèùÔ∏è Visayas</option>
                      <option value="Mindanao">üèùÔ∏è Mindanao</option>
                    </select>
                    <p style="margin: 8px 0 0; font-size: 12px; color: #666;">Your store will be matched with riders serving this island group</p>
                  </div>
                </div>

                <div style="display: flex; gap: 12px;">
                  <button type="submit" class="action-btn" style="background: #10b981; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save All Settings</button>
                  <button type="button" onclick="reloadAccountSettings()" class="action-btn" style="background: #6b7280; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">‚ü≤ Reload Data</button>
                </div>
              </form>
            </div>
          </div>
        `,

        'overview': null
      };

      // Populate pageTemplates with the content
      pageTemplates = pageTemplates_content;

      function toggleSizeColorSections() {
        console.log('üîÑ toggleSizeColorSections() CALLED - Adjusting layout based on category');

        const categorySelect = document.getElementById('categorySelect');
        const variantsSection = document.getElementById('variantsSection');
        const sizesSection = document.getElementById('sizesSection');
        const colorsSection = document.getElementById('colorsSection');
        const stockSection = document.getElementById('size-color-stocks');
        const ingredientsSection = document.getElementById('ingredientsSection');
        const ingredientsInput = document.getElementById('ingredients');
        const clothingSizes = document.getElementById('clothingSizes');
        const shoeSizes = document.getElementById('shoeSizes');

        if (!categorySelect) {
          console.error('‚ùå Category select not found!');
          return;
        }

        if (!variantsSection || !sizesSection || !colorsSection || !stockSection) {
          console.error('‚ùå Sections not found!');
          return;
        }

        const categoryId = categorySelect.value;
        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categorySlug = selectedOption ? selectedOption.dataset.slug || selectedOption.getAttribute('data-slug') || '' : '';
        const categoryText = selectedOption ? selectedOption.textContent.toLowerCase() : '';

        console.log('[CATEGORY] Category:', { categoryId, categorySlug, categoryText });

        if (!categoryId) {

          console.log('[WARNING] No category selected - hiding all variants and ingredients');
          variantsSection.style.display = 'none';
          if (ingredientsSection) ingredientsSection.style.display = 'none';
          return;
        }


        const isGrooming = categoryText.includes('grooming') || (categorySlug && categorySlug.toLowerCase().includes('grooming'));
        const isShoe = categoryText.includes('shoe') || categoryText.includes('footwear') || (categorySlug && (categorySlug.toLowerCase().includes('shoe') || categorySlug.toLowerCase().includes('footwear')));

        console.log('[DETECTION] Category detection:', { isGrooming, isShoe, categoryText });

        if (isGrooming) {

          console.log('[SUCCESS] GROOMING PRODUCT MODE - Showing ingredients, hiding variants');


          variantsSection.style.display = 'none';
          sizesSection.style.display = 'none';
          colorsSection.style.display = 'none';
          stockSection.style.display = 'none';


          if (ingredientsSection) {
            ingredientsSection.style.display = 'block';
            console.log('[SUCCESS] Showing ingredients section');


            initializeIngredientsTable();
          }


          if (ingredientsInput) ingredientsInput.required = true;


          document.querySelectorAll('input[name="sizes"], input[name="colors"]').forEach(input => {
            input.removeAttribute('required');
            input.checked = false;
          });

        } else if (isShoe) {

          console.log('üëü SHOE PRODUCT MODE - Showing variants with shoe sizes');


          variantsSection.style.display = 'block';
          sizesSection.style.display = 'block';
          colorsSection.style.display = 'block';
          stockSection.style.display = 'block';


          if (clothingSizes) clothingSizes.style.display = 'none';
          if (shoeSizes) shoeSizes.style.display = 'grid';


          if (ingredientsSection) {
            ingredientsSection.style.display = 'none';
            if (ingredientsInput) ingredientsInput.required = false;
          }


          document.querySelectorAll('#clothingSizes input[name="sizes"]').forEach(input => input.checked = false);

          console.log('[SUCCESS] Shoe mode: showing shoe sizes (5-13)');

        } else {

          console.log('[INFO] OTHER PRODUCT MODE - Showing variants with clothing sizes');


          variantsSection.style.display = 'block';
          sizesSection.style.display = 'block';
          colorsSection.style.display = 'block';
          stockSection.style.display = 'block';


          if (clothingSizes) clothingSizes.style.display = 'grid';
          if (shoeSizes) shoeSizes.style.display = 'none';


          if (ingredientsSection) {
            ingredientsSection.style.display = 'none';
            if (ingredientsInput) ingredientsInput.required = false;
          }


          document.querySelectorAll('#shoeSizes input[name="sizes"]').forEach(input => input.checked = false);

          console.log('[SUCCESS] Apparel mode: showing clothing sizes (XS-4XL)');
        }

        console.log('[SUCCESS] toggleSizeColorSections() COMPLETE');


        updateStockInputs();
      }


      function submitCustomValues() {
        // Get custom colors and sizes from the per-color inputs
        const customColorsInput = document.getElementById('custom-colors');
        const customColorsHidden = document.getElementById('custom-colors-hidden');
        
        if (customColorsInput && customColorsHidden) {
          customColorsHidden.value = customColorsInput.value.trim();
          console.log('Custom colors being submitted:', customColorsHidden.value);
        }

        // For custom sizes, we need to collect from the colorSizesMapping
        // But since colorSizesMapping tracks per-color sizes, and we already have
        // predefined size checkboxes with name="sizes", we don't need the custom-sizes-hidden
        // The stock inputs already have the right names with the safe versions
        
        return true;
      }


      async function confirmAddProduct() {
        const form = document.getElementById('addProductForm');
        const categorySelect = document.getElementById('categorySelect');
        const nameInput = form.elements['name'];
        const priceInput = form.elements['price'];


        if (!nameInput.value.trim()) {
          VaronNotifications.warning('Please enter a product name');
          return;
        }

        const invalidNumbers = findInvalidNumberInputs(form);
        if (invalidNumbers.length > 0) {
          const firstInvalid = invalidNumbers[0];
          const fieldLabel = firstInvalid.dataset.fieldLabel || firstInvalid.name || 'This field';
          VaronNotifications.warning(`${fieldLabel} cannot be negative.`);
          firstInvalid.focus();
          firstInvalid.reportValidity();
          return;
        }

        if (!categorySelect.value) {
          VaronNotifications.warning('Please select a category');
          return;
        }


        const selectedOption = categorySelect.options[categorySelect.selectedIndex];
        const categorySlug = selectedOption ? selectedOption.dataset.slug || selectedOption.getAttribute('data-slug') || '' : '';
        const categoryText = selectedOption ? selectedOption.textContent.toLowerCase() : '';
        const isGrooming = categoryText.includes('grooming') || (categorySlug && categorySlug.toLowerCase().includes('grooming'));

        if (isGrooming) {
          // Ingredients are optional for grooming products
          updateIngredientsField();
        } else {
          const selectedSizes = document.querySelectorAll('input[name="sizes"]:checked');
          const customSizesInput = document.getElementById('custom-sizes');
          const customSizes = customSizesInput ? customSizesInput.value.trim() : '';
          const selectedColors = document.querySelectorAll('input[name="colors"]:checked');
          const customColorsInput = document.getElementById('custom-colors');
          const customColors = customColorsInput ? customColorsInput.value.trim() : '';


          const hasSizes = selectedSizes.length > 0 || customSizes.length > 0;
          const hasColors = selectedColors.length > 0 || customColors.length > 0;
          
          // Allow products with only custom sizes, only custom colors, or both
          // Only reject if BOTH sizes and colors are completely empty
          if (!hasSizes && !hasColors) {
            VaronNotifications.warning('Please select at least one size and color, or add custom sizes and colors');
            return;
          }


          updateStockInputs();
        }

        const productName = nameInput.value.trim();
        const productPrice = parseFloat(priceInput.value);
        const category = categorySelect.options[categorySelect.selectedIndex].text;


        const customSizesInput = document.getElementById('custom-sizes');
        const customColorsInput = document.getElementById('custom-colors');
        const selectedSizes = document.querySelectorAll('input[name="sizes"]:checked');
        const selectedColors = document.querySelectorAll('input[name="colors"]:checked');

        let sizeInfo = '';
        if (selectedSizes.length > 0) {
          sizeInfo = Array.from(selectedSizes).map(s => s.value).join(', ');
        }
        if (customSizesInput && customSizesInput.value.trim()) {
          sizeInfo += (sizeInfo ? ', ' : '') + customSizesInput.value.trim();
        }

        let colorInfo = '';
        if (selectedColors.length > 0) {
          colorInfo = Array.from(selectedColors).map(c => c.value).join(', ');
        }
        if (customColorsInput && customColorsInput.value.trim()) {
          colorInfo += (colorInfo ? ', ' : '') + customColorsInput.value.trim();
        }


        const confirmSelectedOption = categorySelect.options[categorySelect.selectedIndex];
        const confirmCategorySlug = confirmSelectedOption ? confirmSelectedOption.getAttribute('data-slug') || '' : '';
        const confirmIsGrooming = confirmCategorySlug && (confirmCategorySlug.toLowerCase().includes('grooming') || confirmSelectedOption.textContent.toLowerCase().includes('grooming'));

        let confirmMsg = `Are you sure you want to add this product?. Product Name: ${productName}. Category: ${category}. Price: ‚Ç±${productPrice.toFixed(2)}`;
        if (!confirmIsGrooming) {
          confirmMsg += `. Sizes: ${sizeInfo}. Colors: ${colorInfo}`;
        }
        confirmMsg += `. This product will be submitted for admin approval.`;

        const confirmed = await VaronNotifications.confirm(confirmMsg, {
          title: 'Confirm Submission',
          confirmText: 'Submit as Draft',
          cancelText: 'Cancel'
        });
        if (confirmed) {

          updateStockInputs();

          setTimeout(() => {
            submitProductViaAJAX();
          }, 200);
        }
      }


      function submitProductViaAJAX() {
        const form = document.getElementById('addProductForm');

        // Custom validation - only check essential fields
        const name = form.elements['name'] ? form.elements['name'].value.trim() : '';
        const price = form.elements['price'] ? form.elements['price'].value : '';
        const categorySelect = document.getElementById('categorySelect');
        const productImages = document.getElementById('productImages');

        if (!name) {
          VaronNotifications.error('Product name is required');
          return;
        }

        const invalidNumbers = findInvalidNumberInputs(form);
        if (invalidNumbers.length > 0) {
          const firstInvalid = invalidNumbers[0];
          const fieldLabel = firstInvalid.dataset.fieldLabel || firstInvalid.name || 'This field';
          VaronNotifications.error(`${fieldLabel} cannot be negative.`);
          firstInvalid.focus();
          firstInvalid.reportValidity();
          return;
        }

        if (!categorySelect.value) {
          VaronNotifications.error('Category is required');
          return;
        }

        if (!productImages.files || productImages.files.length === 0) {
          VaronNotifications.error('At least one product image is required');
          return;
        }

        submitCustomValues();

        const variantStockInputs = document.querySelectorAll('#stock-inputs input[name^="stock_"]');
        if (variantStockInputs.length && !validateNoZeroStock(variantStockInputs)) {
          return;
        }


        const formData = new FormData(form);

  const colorMappingPayload = buildColorMappingPayload();
  formData.append('color_sizes_mapping', JSON.stringify(colorMappingPayload));
  console.log('Color sizes mapping being sent:', colorMappingPayload);


        console.log('=== Form Data Being Sent ===');
        for (let [key, value] of formData.entries()) {
          if (key.startsWith('stock_') || key.includes('size') || key.includes('color') || key === 'color_sizes_mapping') {
            console.log(`${key}: ${value}`);
          }
        }
        console.log('===========================');


        const submitBtn = document.querySelector('button[onclick="confirmAddProduct()"]');
        const originalText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Adding Product...';

        console.log('Submitting product form...');

        fetch('/seller/add-product', {
          method: 'POST',
          body: formData
        })
        .then(response => {
          console.log('Response status:', response.status);
          return response.json().then(data => ({
            status: response.status,
            data: data
          }));
        })
        .then(({ status, data }) => {
          console.log('Response data:', data);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;

          if (status === 200 && data.success) {

            VaronNotifications.success('Product submitted successfully! Your product has been added to the admin queue for approval.');

            form.reset();

            document.getElementById('categorySelect').value = '';
            toggleSizeColorSections();

            colorSizesMapping = {};
            selectedColor = null;
            activeColorsCache = [];
            stockValueCache = {};

            loadPage('products');
          } else if (status === 400) {

            VaronNotifications.error('Validation Error: ' + data.error);
          } else if (data.error) {

            VaronNotifications.error('Error adding product: ' + data.error);
          } else {
            VaronNotifications.error('Unexpected error occurred. Please try again.');
          }
        })
        .catch(error => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
          console.error('Request error:', error);
          VaronNotifications.error('Network error: ' + error.message + '. Please check your connection and try again.');
        });
      }



      let colorSizesMapping = {};
      let selectedColor = null;
      let sizeType = 'clothing';
      let activeColorsCache = [];
      let stockValueCache = {};

      function sanitizeVariantToken(value = '') {
        return value.replace(/[^a-zA-Z0-9]/g, '_');
      }

      function buildStockInputName(size, color) {
        return `stock_${sanitizeVariantToken(size)}_${sanitizeVariantToken(color)}`;
      }

      function captureStockValues() {
        const inputs = document.querySelectorAll('input[name^="stock_"]');
        inputs.forEach(input => {
          stockValueCache[input.name] = input.value;
        });
      }

      function purgeStockValuesForColor(color) {
        if (!color) return;
        const colorToken = sanitizeVariantToken(color);
        Object.keys(stockValueCache).forEach(key => {
          if (key.endsWith(`_${colorToken}`)) {
            delete stockValueCache[key];
          }
        });
      }

      function purgeStockValueEntry(size, color) {
        const key = buildStockInputName(size, color);
        delete stockValueCache[key];
      }

      function showZeroStockWarning(targetInput) {
        if (typeof VaronNotifications !== 'undefined' && typeof VaronNotifications.error === 'function') {
          VaronNotifications.error('Stock quantity cannot be zero. Please enter a valid number.');
        } else {
          alert('Stock quantity cannot be zero. Please enter a valid number.');
        }

        if (targetInput) {
          if (typeof targetInput.focus === 'function') {
            targetInput.focus();
          }
          if (typeof targetInput.scrollIntoView === 'function') {
            targetInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }

          const originalBorder = targetInput.style.borderColor;
          const originalShadow = targetInput.style.boxShadow;
          targetInput.style.borderColor = '#ef4444';
          targetInput.style.boxShadow = '0 0 0 2px rgba(239,68,68,0.25)';
          setTimeout(() => {
            targetInput.style.borderColor = originalBorder;
            targetInput.style.boxShadow = originalShadow;
          }, 1500);
        }
      }

      function findZeroStockInput(inputs) {
        if (!inputs) return null;
        const iterable = Array.from(inputs);
        for (let i = 0; i < iterable.length; i += 1) {
          const input = iterable[i];
          if (!input || input.disabled) continue;
          const value = input.value;
          if (value === '' || value === null || value === undefined) continue;
          const numericValue = Number(value);
          if (!Number.isNaN(numericValue) && numericValue === 0) {
            return input;
          }
        }
        return null;
      }

      function validateNoZeroStock(inputs) {
        const offendingInput = findZeroStockInput(inputs);
        if (offendingInput) {
          showZeroStockWarning(offendingInput);
          return false;
        }
        return true;
      }

      function getActiveColors() {
        const colorSet = new Set();
        document.querySelectorAll('input[name="colors"]:checked').forEach(cb => colorSet.add(cb.value));
        const customColorsInput = document.getElementById('custom-colors');
        if (customColorsInput && customColorsInput.value.trim()) {
          customColorsInput.value.split(',')
            .map(color => color.trim())
            .filter(Boolean)
            .forEach(color => colorSet.add(color));
        }
        return Array.from(colorSet);
      }

      function buildColorMappingPayload() {
        const activeColors = getActiveColors();
        const payload = {};
        activeColors.forEach(color => {
          if (Array.isArray(colorSizesMapping[color])) {
            payload[color] = Array.from(new Set(colorSizesMapping[color]));
          } else {
            payload[color] = [];
          }
        });
        return payload;
      }

      function removeColorVariantData(color) {
        if (!color) return;

        if (colorSizesMapping[color]) {
          delete colorSizesMapping[color];
        }

        if (selectedColor === color) {
          selectedColor = null;
        }

        purgeStockValuesForColor(color);

        const stockRows = document.querySelectorAll('#stock-inputs tbody tr');
        let removedAny = false;
        stockRows.forEach(row => {
          const colorCell = row.querySelector('td:nth-child(2)');
          if (colorCell && colorCell.textContent.trim() === color) {
            row.remove();
            removedAny = true;
          }
        });

        if (removedAny) {
          updateStockSummary();
        }
      }

      function updateColorTabs() {
        console.log('üé® updateColorTabs() called');
        captureStockValues();
        const previousColors = activeColorsCache.slice();
        const colors = getActiveColors();
        const removedColors = previousColors.filter(color => !colors.includes(color));
        if (removedColors.length) {
          removedColors.forEach(removeColorVariantData);
        }
        activeColorsCache = colors.slice();

        console.log('üìä All colors:', colors);

        const colorTabsDiv = document.getElementById('colorTabs');

        if (colors.length === 0) {
          colorTabsDiv.innerHTML = '<p style="color: var(--muted); font-style: italic; text-align: left; margin: 0; line-height: 1.4;">Select colors above to create tabs</p>';
          selectedColor = null;
          document.querySelectorAll('.color-size-checkbox').forEach(cb => cb.checked = false);
          const customSizesField = document.getElementById('custom-sizes-per-color');
          if (customSizesField) customSizesField.value = '';
          updateStockInputs();
          return;
        }

        if (selectedColor && !colors.includes(selectedColor)) {
          selectedColor = null;
        }

        let tabsHtml = '';
        colors.forEach(color => {
          const isSelected = selectedColor === color;
          const borderColor = isSelected ? '#3b82f6' : '#ddd';
          const bgColor = isSelected ? '#3b82f6' : '#fff';
          const textColor = isSelected ? '#fff' : '#0a0a0a';
          const fontWeight = isSelected ? '600' : '500';
          tabsHtml += `<button type="button" class="color-tab" data-color="${color}" style="padding: 10px 16px; border: 2px solid ${borderColor}; background: ${bgColor}; color: ${textColor}; border-radius: 6px; cursor: pointer; font-weight: ${fontWeight}; transition: all 0.2s; border: none;">${color}</button>`;
        });

        colorTabsDiv.innerHTML = tabsHtml;
        console.log('‚úÖ Color tabs HTML generated and inserted');

        if (!selectedColor && colors.length > 0) {
          console.log('‚ö° Auto-selecting first color:', colors[0]);
          selectColor(colors[0]);
        } else {
          updateStockInputs();
        }
      }

      // Global event delegation for color tabs (setup after DOMContentLoaded)
      function setupColorTabDelegation() {
        document.addEventListener('click', function(e) {
          const addTab = e.target.closest('.color-tab');
          if (addTab) {
            e.preventDefault();
            const color = addTab.getAttribute('data-color');
            if (typeof selectColor === 'function') {
              selectColor(color);
            }
            return;
          }

          const editTab = e.target.closest('.edit-color-tab');
          if (editTab) {
            e.preventDefault();
            const color = editTab.getAttribute('data-color');
            if (typeof editSelectColor === 'function') {
              editSelectColor(color);
            }
            return;
          }

          const removeBtn = e.target.closest('.edit-remove-combo');
          if (removeBtn) {
            e.preventDefault();
            const color = removeBtn.getAttribute('data-color');
            const size = removeBtn.getAttribute('data-size');
            if (typeof removeEditVariantCombo === 'function') {
              removeEditVariantCombo(color, size);
            }
          }
        });
      }

      function selectColor(color) {
        try {
          console.log(`üîµ selectColor() called with: ${color}`);
          selectedColor = color;
          console.log(`‚úÖ selectedColor set to: ${selectedColor}`);

          const selectedColorInput = document.getElementById('selected-color');
          if (selectedColorInput) {
            selectedColorInput.value = color;
            console.log('‚úÖ selected-color input updated');
          }

          // Update tab styling
          document.querySelectorAll('.color-tab').forEach(tab => {
            const tabColor = tab.getAttribute('data-color');
            const isSelected = tabColor === color;
            tab.style.borderColor = isSelected ? '#3b82f6' : '#ddd';
            tab.style.background = isSelected ? '#3b82f6' : '#fff';
            tab.style.color = isSelected ? '#fff' : '#0a0a0a';
            tab.style.fontWeight = isSelected ? '600' : '500';
          });
          console.log('‚úÖ Tab styles updated');

          const stockTableColor = document.getElementById('stock-table-color');
          if (stockTableColor) {
            stockTableColor.textContent = color;
          }

          console.log('üîÑ Calling updateSizesForColor()...');
          updateSizesForColor();
          console.log('‚úÖ updateSizesForColor() completed');

          updateStockInputs();
          console.log('‚úÖ updateStockInputs() completed');
        } catch (error) {
          console.error('‚ùå Error in selectColor():', error);
        }
      }

      function updateSizesForColor() {
        try {
          console.log('üî¥ UPDATE SIZES FOR COLOR START:', selectedColor);
          
          if (!selectedColor) {
            console.log('No color - hiding container');
            document.getElementById('sizesPlaceholder').style.display = 'block';
            document.getElementById('perColorSizesContainer').style.display = 'none';
            return;
          }

          console.log('Color selected:', selectedColor, '- showing container');
          document.getElementById('sizesPlaceholder').style.display = 'none';
          document.getElementById('perColorSizesContainer').style.display = 'block';
          console.log('CONTAINER DISPLAY SET TO BLOCK');
          
          const label = document.getElementById('current-color-size-label');
          if (label) label.textContent = selectedColor;

          const savedSizes = colorSizesMapping[selectedColor] || [];
          document.querySelectorAll('.color-size-checkbox').forEach(checkbox => {
            checkbox.checked = savedSizes.includes(checkbox.value);
          });

          const customSizesInput = document.getElementById('custom-sizes-per-color');
          if (customSizesInput) {
            const customSizes = savedSizes.filter(size => {
              return !['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', '4XL', '5', '6', '7', '8', '9', '10', '11', '12', '13'].includes(size);
            });
            customSizesInput.value = customSizes.join(', ');
          }
          
          console.log('‚úÖ UPDATE SIZES FOR COLOR END');
        } catch (error) {
          console.error('‚ùå ERROR in updateSizesForColor:', error);
        }
      }

      let ingredientRowCount = 0;
      let parsedIngredients = [];

      function parseIngredientsFromTextarea() {
        console.log('üîç Parsing ingredients from textarea...');
        const textarea = document.getElementById('ingredientsInput');
        const statusDiv = document.getElementById('ingredientsStatus');
        const previewContainer = document.getElementById('ingredientsPreviewContainer');
        const tbody = document.getElementById('ingredientsTableBody');

        if (!textarea.value.trim()) {
          statusDiv.textContent = '‚ö†Ô∏è Please enter ingredients above';
          statusDiv.style.color = '#d97706';
          statusDiv.style.background = '#fffbeb';
          statusDiv.style.display = 'block';
          previewContainer.style.display = 'none';
          return;
        }

        parsedIngredients = [];
        const lines = textarea.value.split('. ').filter(line => line.trim());
        let successCount = 0;

        lines.forEach((line, index) => {
          const trimmedLine = line.trim();
          if (!trimmedLine) return;


          const name = trimmedLine;

          if (!name) {
            return;
          }

          parsedIngredients.push({ name });
          successCount++;
        });

        if (successCount === 0) {
          statusDiv.textContent = '‚ö†Ô∏è No valid ingredients found';
          statusDiv.style.color = '#d97706';
          statusDiv.style.background = '#fffbeb';
          statusDiv.style.display = 'block';
          previewContainer.style.display = 'none';
          return;
        }


        statusDiv.textContent = `‚úÖ Successfully added ${successCount} ingredient(s)`;
        statusDiv.style.color = '#166534';
        statusDiv.style.background = '#dcfce7';
        statusDiv.style.display = 'block';


        tbody.innerHTML = '';
        parsedIngredients.forEach((ingredient, idx) => {
          const rowId = `ingredient-row-${idx}`;
          const row = document.createElement('tr');
          row.id = rowId;
          row.style.transition = 'background-color 0.2s';
          row.innerHTML = `
            <td style="padding: 10px 12px; border: 1px solid var(--line); font-size: 13px;">${ingredient.name}</td>
            <td style="padding: 10px 12px; border: 1px solid var(--line); text-align: center;">
              <button type="button" class="action-btn" data-row-id="${rowId}" onclick="removeIngredientRow(this.getAttribute('data-row-id'))" style="padding: 4px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úï Remove</button>
            </td>
          `;
          row.addEventListener('mouseover', () => row.style.backgroundColor = '#f9fafb');
          row.addEventListener('mouseout', () => row.style.backgroundColor = '');
          tbody.appendChild(row);
        });

        previewContainer.style.display = 'block';
        updateIngredientsField();
        console.log('[SUCCESS] Ingredients parsed:', parsedIngredients);
      }

      function removeIngredientRow(rowId) {
        console.log('[ACTION] Removing ingredient row:', rowId);
        const row = document.getElementById(rowId);
        if (row) {
          row.style.animation = 'fadeOut 0.3s ease-out forwards';
          setTimeout(() => {
            row.remove();
            updateIngredientsField();


            const tbody = document.getElementById('ingredientsTableBody');
            if (tbody.children.length === 0) {
              document.getElementById('ingredientsPreviewContainer').style.display = 'none';
              document.getElementById('ingredientsStatus').style.display = 'none';
            }
          }, 300);
        }
      }

      function updateIngredientsField() {
        const rows = document.querySelectorAll('#ingredientsTableBody tr');
        const ingredients = [];

        rows.forEach(row => {
          const cells = row.querySelectorAll('td');
          if (cells.length >= 1) {
            const name = cells[0].textContent.trim();

            if (name) {
              ingredients.push({ name });
            }
          }
        });


        const ingredientsInput = document.getElementById('ingredients');
        if (ingredientsInput) {
          ingredientsInput.value = JSON.stringify(ingredients);
        }

        console.log('Updated ingredients field:', ingredients);
      }


      function initializeIngredientsTable() {

        document.getElementById('ingredientsInput').value = '';
        document.getElementById('ingredientsTableBody').innerHTML = '';
        document.getElementById('ingredientsPreviewContainer').style.display = 'none';
        document.getElementById('ingredientsStatus').style.display = 'none';
        console.log('[SUCCESS] Ingredients section initialized');
      }

      function enforceNonNegativeValue(input) {
        if (!input) return;

        const rawValue = input.value;
        if (rawValue === '') {
          input.setCustomValidity('');
          return;
        }

        const numericValue = Number(rawValue);
        if (Number.isNaN(numericValue)) {
          input.setCustomValidity('');
          return;
        }

        const requirePositive = input.dataset.requirePositive === 'true';
        const label = input.dataset.fieldLabel || input.getAttribute('placeholder') || input.name || 'This field';

        if (numericValue < 0) {
          input.setCustomValidity(`${label} cannot be negative.`);
          input.reportValidity();
        } else if (requirePositive && numericValue === 0) {
          input.setCustomValidity(`${label} must be greater than zero.`);
          input.reportValidity();
        } else {
          input.setCustomValidity('');
        }
      }

      function findInvalidNumberInputs(form) {
        if (!form) return [];

        const invalidInputs = [];
        const numberInputs = form.querySelectorAll('input[type="number"]');

        numberInputs.forEach(input => {
          if (input.disabled) return;
          if (input.value === '') return;

          const numericValue = Number(input.value);
          if (Number.isNaN(numericValue)) return;

          const requirePositive = input.dataset.requirePositive === 'true';
          if (numericValue < 0 || (requirePositive && numericValue === 0)) {
            invalidInputs.push(input);
          }
        });

        return invalidInputs;
      }

      function updateStockInputs() {
        console.log('[UPDATE] Updating stock inputs - generating for ALL colors');

        captureStockValues();

        const sizes = [];


        const checkedSizes = Array.from(document.querySelectorAll('.color-size-checkbox:checked')).map(cb => cb.value);
        sizes.push(...checkedSizes);


        const customSizesInput = document.getElementById('custom-sizes-per-color');
        const customSizes = customSizesInput && customSizesInput.value.trim()
          ? customSizesInput.value.split(',').map(s => s.trim()).filter(s => s)
          : [];

        sizes.push(...customSizes);

        console.log('Sizes for current color tab:', sizes);

        const stockInputsDiv = document.getElementById('stock-inputs');

        if (!stockInputsDiv) {
          console.log('Stock inputs div not found');
          return;
        }


        if (!selectedColor || sizes.length === 0) {
          stockInputsDiv.innerHTML = '<p style="color: var(--muted); font-style: italic;">üëâ Select sizes for this color above to set stock</p>';
          return;
        }


        if (selectedColor) {
          colorSizesMapping[selectedColor] = sizes;
        }
        console.log('Updated colorSizesMapping:', colorSizesMapping);

        const allColors = getActiveColors();

        console.log('ALL COLORS detected:', allColors);
        console.log('colorSizesMapping:', colorSizesMapping);

        let html = '<div style="max-height: 400px; overflow-y: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #e5e7eb; position: sticky; top: 0;"><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Size</th><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Color</th><th style="padding: 8px; text-align: left; border: 1px solid var(--line);">Stock Qty</th><th style="padding: 8px; text-align: center; border: 1px solid var(--line); width: 50px;">Action</th></tr></thead>';
        html += '<tbody>';

        // Create stock inputs for ALL colors √ó ALL their sizes
        allColors.forEach(color => {
          const colorSizes = colorSizesMapping[color] || [];
          console.log(`Processing color "${color}" with sizes:`, colorSizes);
          
          colorSizes.forEach(size => {
            const safeName = buildStockInputName(size, color);
            const stockValue = (stockValueCache[safeName] !== undefined) ? stockValueCache[safeName] : '0';
            console.log(`Creating stock input: size="${size}", color="${color}", name="${safeName}", value="${stockValue}"`);
            
            // Highlight current color's rows
            const isCurrentColor = color === selectedColor;
            const rowBg = isCurrentColor ? '#eff6ff' : 'transparent';
            
            html += `<tr style="transition: background-color 0.2s; background-color: ${rowBg};" onmouseover="this.style.backgroundColor='#f3f4f6';" onmouseout="this.style.backgroundColor='${rowBg}';">
              <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${size}</td>
              <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${color}</td>
              <td style="padding: 8px; border: 1px solid var(--line);">
                <input type="number" name="${safeName}" min="0" value="${stockValue}" required
                  style="width: 80px; padding: 6px; border: 1px solid var(--line); border-radius: 4px;">
              </td>
              <td style="padding: 8px; border: 1px solid var(--line); text-align: center;">
                <button type="button" onclick="removeStockRow(this)" style="background: none; border: none; cursor: pointer; color: #ef4444; font-size: 18px; padding: 4px 8px; transition: transform 0.2s;" title="Remove this size-color combination" onmouseover="this.style.transform='scale(1.2)';" onmouseout="this.style.transform='scale(1)';">‚úï</button>
              </td>
            </tr>`;
          });
        });

        html += '</tbody></table></div>';
        stockInputsDiv.innerHTML = html;
        console.log(`Stock table generated for ALL ${allColors.length} colors`);
        
        // Update stock summary after rendering
        updateStockSummary();
        
        // Attach event listeners to stock inputs to update summary on change
        stockInputsDiv.querySelectorAll('input[type="number"]').forEach(input => {
          input.setAttribute('min', '0');
          input.dataset.fieldLabel = `${input.name.replace('stock_', '').replace(/_/g, ' ')} stock`;
          input.addEventListener('input', event => {
            stockValueCache[event.target.name] = event.target.value;
            enforceNonNegativeValue(event.target);
            updateStockSummary();
          });
          stockValueCache[input.name] = input.value;
        });
      }

      function updateStockSummary() {
        const summaryDiv = document.getElementById('stock-variants-summary');
        const tbody = document.getElementById('stock-variants-tbody');
        const totalStockSpan = document.getElementById('total-stock-count');
        
        if (!summaryDiv || !tbody || !totalStockSpan) return;
        
        // Collect all stock inputs
        const allStockInputs = document.querySelectorAll('input[name^="stock_"]');
        const variants = [];
        let totalStock = 0;
        
        allStockInputs.forEach(input => {
          const stock = parseInt(input.value) || 0;
          if (stock > 0) {
            // Parse the input name to extract size and color
            // Format: stock_<safe_size>_<safe_color>
            const nameParts = input.name.replace('stock_', '').split('_');
            if (nameParts.length >= 2) {
              const colorIndex = nameParts.length - 1;
              const sizeIndex = nameParts.slice(0, colorIndex).join('_');
              const size = sizeIndex.replace(/_/g, ' ').trim();
              const color = nameParts[colorIndex].replace(/_/g, ' ').trim();
              
              // Try to get the actual values from the closest table row
              const row = input.closest('tr');
              if (row) {
                const actualSize = row.querySelector('td:first-child')?.textContent?.trim() || size;
                const actualColor = row.querySelector('td:nth-child(2)')?.textContent?.trim() || color;
                
                variants.push({
                  size: actualSize,
                  color: actualColor,
                  stock: stock
                });
                totalStock += stock;
              }
            }
          }
        });
        
        // Update summary table
        if (variants.length > 0) {
          let html = '';
          variants.forEach(v => {
            html += `
              <tr style="border-bottom: 1px solid #fbbf24;">
                <td style="padding: 8px; border: 1px solid #fbbf24;">${v.size}</td>
                <td style="padding: 8px; border: 1px solid #fbbf24;">${v.color}</td>
                <td style="padding: 8px; border: 1px solid #fbbf24; text-align: right; font-weight: 600;">${v.stock} pcs</td>
              </tr>
            `;
          });
          tbody.innerHTML = html;
          totalStockSpan.textContent = `${totalStock} pcs`;
          summaryDiv.style.display = 'block';
        } else {
          summaryDiv.style.display = 'none';
        }
      }

      function removeStockRow(button) {
        const row = button.closest('tr');
        if (!row) return;

        const sizeCell = row.querySelector('td:first-child');
        const colorCell = row.querySelector('td:nth-child(2)');
        const size = sizeCell ? sizeCell.textContent.trim() : '';
        const color = colorCell ? colorCell.textContent.trim() : '';

        row.style.animation = 'fadeOut 0.3s ease-out forwards';
        setTimeout(() => {
          row.remove();
          console.log('Row removed');
          syncRemovedVariantSelection(color, size);
          updateStockSummary();
        }, 300);
      }

      function syncRemovedVariantSelection(color, size) {
        if (!color || !size) return;

        if (colorSizesMapping[color]) {
          colorSizesMapping[color] = colorSizesMapping[color].filter(entry => entry !== size);
          if (colorSizesMapping[color].length === 0) {
            delete colorSizesMapping[color];
          }
        }

        purgeStockValueEntry(size, color);

        if (selectedColor === color) {
          updateSizesForColor();
        }
      }

      const PREDEFINED_COLOR_OPTIONS = ['Black','White','Gray','Navy','Blue','Red','Green','Brown','Beige','Khaki'];
      const PREDEFINED_COLOR_SWATCHES = {
        'Black': '#000000',
        'White': '#FFFFFF',
        'Gray': '#808080',
        'Navy': '#000080',
        'Blue': '#0000FF',
        'Red': '#FF0000',
        'Green': '#008000',
        'Brown': '#8B4513',
        'Beige': '#F5F5DC',
        'Khaki': '#F0E68C'
      };

      const EDIT_CLOTHING_SIZES = ['XS','S','M','L','XL','2XL','3XL','4XL'];
      const EDIT_SHOE_SIZES = ['5','6','7','8','9','10','11','12','13'];
      const EDIT_PRESET_SIZES = [...EDIT_CLOTHING_SIZES, ...EDIT_SHOE_SIZES];

      function getEditVariantKey(color = '', size = '') {
        return `${color.trim().toLowerCase()}__${size.trim().toLowerCase()}`;
      }

      function inferEditSizeType(product = {}) {
        const clothingBlock = document.getElementById('editClothingSizes');
        const shoeBlock = document.getElementById('editShoeSizes');
        const categoryName = (product.category_name || product.category || '').toLowerCase();
        const categorySlug = (product.category_slug || '').toLowerCase();
        const isShoeCategory = categoryName.includes('shoe') || categoryName.includes('footwear') || categorySlug.includes('shoe') || categorySlug.includes('footwear');
        editSizeType = isShoeCategory ? 'shoes' : 'clothing';
        if (clothingBlock) {
          clothingBlock.style.display = editSizeType === 'clothing' ? 'grid' : 'none';
        }
        if (shoeBlock) {
          shoeBlock.style.display = editSizeType === 'shoes' ? 'grid' : 'none';
        }
      }

      function getActiveEditColors() {
        const colorSet = new Set();
        document.querySelectorAll('input[name="edit_colors"]:checked').forEach(checkbox => {
          const value = (checkbox.value || '').trim();
          if (value) {
            colorSet.add(value);
          }
        });
        const customInput = document.getElementById('edit-custom-colors');
        if (customInput && customInput.value.trim()) {
          customInput.value.split(',').map(color => color.trim()).filter(Boolean).forEach(color => colorSet.add(color));
        }
        return Array.from(colorSet);
      }

      function initializeEditVariantWorkflow(product = {}, variants = []) {
        editVariantMap = {};
        editColorSizesMapping = {};
        editSelectedColor = null;

        const safeVariants = Array.isArray(variants) ? variants : [];
        const existingColors = [];

        safeVariants.forEach(variant => {
          const rawColor = (variant.color || 'Unspecified').trim();
          const matchedPredefined = PREDEFINED_COLOR_OPTIONS.find(option => option.toLowerCase() === rawColor.toLowerCase());
          const color = matchedPredefined || rawColor;
          const size = (variant.size || 'One Size').trim();
          const key = getEditVariantKey(color, size);

          if (!existingColors.some(existing => existing.toLowerCase() === color.toLowerCase())) {
            existingColors.push(color);
          }
          if (!editColorSizesMapping[color]) {
            editColorSizesMapping[color] = [];
          }
          if (size && !editColorSizesMapping[color].includes(size)) {
            editColorSizesMapping[color].push(size);
          }

          editVariantMap[key] = {
            id: variant.id || null,
            color,
            size,
            stock_quantity: Number(variant.stock_quantity ?? variant.stock ?? 0) || 0,
            is_active: variant.is_active === 0 ? 0 : 1,
            isNew: !variant.id,
            deleted: false,
            modified: false
          };
        });

        document.querySelectorAll('input[name="edit_colors"]').forEach(checkbox => {
          const matchIndex = existingColors.findIndex(color => color.toLowerCase() === checkbox.value.toLowerCase());
          checkbox.checked = matchIndex !== -1;
          if (matchIndex !== -1) {
            existingColors.splice(matchIndex, 1);
          }
        });

        const customColorsInput = document.getElementById('edit-custom-colors');
        if (customColorsInput) {
          const uniqueCustomColors = Array.from(new Set(existingColors));
          customColorsInput.value = uniqueCustomColors.join(', ');
        }

        inferEditSizeType(product);
        editUpdateColorTabs();
        editUpdateSizesForColor();
        editUpdateStockInputs();
        editUpdateStockSummary();
        syncEditVariantsHiddenField();
      }

      function captureCurrentEditStockInputs() {
        const stockInputs = document.querySelectorAll('#edit-stock-inputs input[type="number"][data-color][data-size]');
        stockInputs.forEach(input => {
          const color = input.dataset.color;
          const size = input.dataset.size;
          if (!color || !size) {
            return;
          }
          const key = getEditVariantKey(color, size);
          if (!editVariantMap[key]) {
            editVariantMap[key] = {
              id: null,
              color,
              size,
              stock_quantity: 0,
              is_active: 1,
              isNew: true,
              deleted: false,
              modified: false
            };
          }
          editVariantMap[key].stock_quantity = Number(input.value) || 0;
          if (editVariantMap[key].id) {
            editVariantMap[key].modified = true;
          }
        });
      }

      function editUpdateColorTabs() {
        captureCurrentEditStockInputs();

        const colors = getActiveEditColors();
        const tabsContainer = document.getElementById('editColorTabs');
        const placeholderHtml = '<p style="color: var(--muted); font-style: italic;">Select or add colors to get started.</p>';

        if (!tabsContainer) {
          return;
        }

        if (!colors.length) {
          tabsContainer.innerHTML = placeholderHtml;
          editSelectedColor = null;
          const perColorContainer = document.getElementById('edit-perColorSizesContainer');
          const sizesPlaceholder = document.getElementById('editSizesPlaceholder');
          if (perColorContainer) perColorContainer.style.display = 'none';
          if (sizesPlaceholder) sizesPlaceholder.style.display = 'block';
          const stockInputsDiv = document.getElementById('edit-stock-inputs');
          if (stockInputsDiv) {
            stockInputsDiv.innerHTML = '<p id="edit-stock-placeholder" style="color: var(--muted); font-style: italic; text-align: center; padding: 20px; background: #f9fafb; border-radius: 6px;">Select a color and sizes to set stock quantities.</p>';
          }
          const stockColorLabel = document.getElementById('edit-stock-table-color');
          if (stockColorLabel) stockColorLabel.textContent = '‚Äî';
          editUpdateStockSummary();
          syncEditVariantsHiddenField();
          return;
        }

        const activeColorSet = new Set(colors);
        Object.keys(editColorSizesMapping).forEach(color => {
          if (!activeColorSet.has(color)) {
            delete editColorSizesMapping[color];
          }
        });
        Object.keys(editVariantMap).forEach(key => {
          const entry = editVariantMap[key];
          if (!activeColorSet.has(entry.color)) {
            if (entry.id) {
              entry.deleted = true;
            } else {
              delete editVariantMap[key];
            }
          }
        });

        let html = '';
        colors.forEach(color => {
          if (!editColorSizesMapping[color]) {
            editColorSizesMapping[color] = [];
          }
          const isActive = color === editSelectedColor;
          html += `
            <button type="button" class="edit-color-tab" data-color="${color}" style="padding: 10px 12px; border-radius: 6px; border: 2px solid ${isActive ? '#3b82f6' : '#d1d5db'}; background: ${isActive ? '#3b82f6' : '#fff'}; color: ${isActive ? '#fff' : '#111827'}; font-weight: ${isActive ? '600' : '500'}; cursor: pointer;">
              ${color}
            </button>
          `;
        });
        tabsContainer.innerHTML = html;

        if (!editSelectedColor || !colors.includes(editSelectedColor)) {
          editSelectedColor = colors[0];
        }

        const stockColorLabel = document.getElementById('edit-stock-table-color');
        if (stockColorLabel) {
          stockColorLabel.textContent = editSelectedColor || '‚Äî';
        }

        const hiddenSelected = document.getElementById('edit-selected-color');
        if (hiddenSelected) {
          hiddenSelected.value = editSelectedColor || '';
        }

        editSelectColor(editSelectedColor);
      }

      function editSelectColor(color) {
        if (!color) {
          return;
        }

        captureCurrentEditStockInputs();
        editSelectedColor = color;

        const hiddenSelected = document.getElementById('edit-selected-color');
        if (hiddenSelected) {
          hiddenSelected.value = color;
        }

        document.querySelectorAll('.edit-color-tab').forEach(tab => {
          const tabColor = tab.getAttribute('data-color');
          const isActive = tabColor === color;
          tab.style.borderColor = isActive ? '#3b82f6' : '#d1d5db';
          tab.style.background = isActive ? '#3b82f6' : '#fff';
          tab.style.color = isActive ? '#fff' : '#111827';
          tab.style.fontWeight = isActive ? '600' : '500';
        });

        editUpdateSizesForColor();
        editUpdateStockInputs();
      }

      function editUpdateSizesForColor() {
        const perColorContainer = document.getElementById('edit-perColorSizesContainer');
        const placeholder = document.getElementById('editSizesPlaceholder');
        const colorLabel = document.getElementById('edit-current-color-size-label');

        if (!editSelectedColor) {
          if (perColorContainer) perColorContainer.style.display = 'none';
          if (placeholder) placeholder.style.display = 'block';
          return;
        }

        if (perColorContainer) perColorContainer.style.display = 'block';
        if (placeholder) placeholder.style.display = 'none';
        if (colorLabel) colorLabel.textContent = editSelectedColor;

        const savedSizes = editColorSizesMapping[editSelectedColor] || [];
        document.querySelectorAll('.edit-color-size-checkbox').forEach(checkbox => {
          checkbox.checked = savedSizes.includes(checkbox.value);
        });

        const customInput = document.getElementById('edit-custom-sizes-per-color');
        if (customInput) {
          const customSizes = savedSizes.filter(size => !EDIT_PRESET_SIZES.includes(size));
          customInput.value = customSizes.join(', ');
        }
      }

      function editUpdateStockInputs() {
        const stockInputsDiv = document.getElementById('edit-stock-inputs');
        if (!stockInputsDiv) {
          return;
        }

        captureCurrentEditStockInputs();

        const activeColors = getActiveEditColors();
        if (!activeColors.length) {
          stockInputsDiv.innerHTML = '<p id="edit-stock-placeholder" style="color: var(--muted); font-style: italic; text-align: center; padding: 20px; background: #f9fafb; border-radius: 6px;">Select a color and sizes to set stock quantities.</p>';
          editUpdateStockSummary();
          syncEditVariantsHiddenField();
          return;
        }

        if (!editSelectedColor || !activeColors.includes(editSelectedColor)) {
          editSelectedColor = activeColors[0];
        }

        const sizesForSelected = [];
        document.querySelectorAll('.edit-color-size-checkbox:checked').forEach(checkbox => sizesForSelected.push(checkbox.value));
        const customInput = document.getElementById('edit-custom-sizes-per-color');
        if (customInput && customInput.value.trim()) {
          customInput.value.split(',').map(size => size.trim()).filter(Boolean).forEach(size => sizesForSelected.push(size));
        }
        if (editSelectedColor) {
          editColorSizesMapping[editSelectedColor] = Array.from(new Set(sizesForSelected.filter(Boolean)));
        }

        let hasRows = false;
        let html = '<div style="max-height: 400px; overflow-y: auto;"><table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #e5e7eb; position: sticky; top: 0;"><th style="padding: 8px; border: 1px solid var(--line); text-align: left;">Size</th><th style="padding: 8px; border: 1px solid var(--line); text-align: left;">Color</th><th style="padding: 8px; border: 1px solid var(--line); text-align: left;">Stock Qty</th><th style="padding: 8px; border: 1px solid var(--line); text-align: center;">Action</th></tr></thead><tbody>';

        activeColors.forEach(color => {
          const sizes = editColorSizesMapping[color] || [];
          sizes.forEach(size => {
            const key = getEditVariantKey(color, size);
            if (!editVariantMap[key]) {
              editVariantMap[key] = {
                id: null,
                color,
                size,
                stock_quantity: 0,
                is_active: 1,
                isNew: true,
                deleted: false,
                modified: false
              };
            }
            const variant = editVariantMap[key];
            if (variant.deleted) {
              return;
            }
            hasRows = true;
            const safeName = `edit_stock_${size.replace(/[^a-zA-Z0-9]/g, '_')}_${color.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const isActiveColor = color === editSelectedColor;
            html += `
              <tr style="background: ${isActiveColor ? '#eff6ff' : '#fff'};">
                <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${size}</td>
                <td style="padding: 8px; border: 1px solid var(--line); font-weight: 500;">${color}</td>
                <td style="padding: 8px; border: 1px solid var(--line);">
                  <input type="number" name="${safeName}" min="0" value="${variant.stock_quantity}" data-color="${color}" data-size="${size}" style="width: 90px; padding: 6px; border: 1px solid var(--line); border-radius: 4px; text-align: right;">
                </td>
                <td style="padding: 8px; border: 1px solid var(--line); text-align: center;">
                  <button type="button" class="edit-remove-combo" data-color="${color}" data-size="${size}" style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 14px;">Remove</button>
                </td>
              </tr>
            `;
          });
        });

        html += '</tbody></table></div>';

        if (!hasRows) {
          stockInputsDiv.innerHTML = '<p id="edit-stock-placeholder" style="color: var(--muted); font-style: italic; text-align: center; padding: 20px; background: #f9fafb; border-radius: 6px;">Select a color and sizes to set stock quantities.</p>';
        } else {
          stockInputsDiv.innerHTML = html;
          stockInputsDiv.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', event => handleEditStockInputChange(event.target));
          });
        }

        editUpdateStockSummary();
        syncEditVariantsHiddenField();
      }

      function handleEditStockInputChange(input) {
        if (!input) {
          return;
        }
        enforceNonNegativeValue(input);
        const color = input.dataset.color;
        const size = input.dataset.size;
        if (!color || !size) {
          return;
        }
        const key = getEditVariantKey(color, size);
        if (!editVariantMap[key]) {
          editVariantMap[key] = {
            id: null,
            color,
            size,
            stock_quantity: 0,
            is_active: 1,
            isNew: true,
            deleted: false,
            modified: false
          };
        }
        editVariantMap[key].stock_quantity = Number(input.value) || 0;
        if (editVariantMap[key].id) {
          editVariantMap[key].modified = true;
        }
        syncEditVariantsHiddenField();
        editUpdateStockSummary();
      }

      function removeEditVariantCombo(color, size) {
        captureCurrentEditStockInputs();
        const key = getEditVariantKey(color, size);
        const entry = editVariantMap[key];
        if (entry) {
          if (entry.id) {
            entry.deleted = true;
          } else {
            delete editVariantMap[key];
          }
        }

        if (editColorSizesMapping[color]) {
          editColorSizesMapping[color] = editColorSizesMapping[color].filter(savedSize => savedSize !== size);
        }

        editUpdateStockInputs();
        editUpdateStockSummary();
        syncEditVariantsHiddenField();
      }

      function editUpdateStockSummary() {
        const summary = document.getElementById('edit-stock-variants-summary');
        const tbody = document.getElementById('edit-stock-variants-tbody');
        const totalSpan = document.getElementById('edit-total-stock-count');
        if (!summary || !tbody || !totalSpan) {
          return;
        }

        const activeVariants = Object.values(editVariantMap || {}).filter(variant => !variant.deleted && (Number(variant.stock_quantity) || 0) > 0);

        if (!activeVariants.length) {
          summary.style.display = 'none';
          tbody.innerHTML = '';
          totalSpan.textContent = '0 pcs';
          return;
        }

        let totalStock = 0;
        let html = '';
        activeVariants.sort((a, b) => {
          if (a.color === b.color) {
            return a.size.localeCompare(b.size);
          }
          return a.color.localeCompare(b.color);
        }).forEach(variant => {
          totalStock += Number(variant.stock_quantity) || 0;
          html += `
            <tr style="border-bottom: 1px solid #fbbf24;">
              <td style="padding: 8px; border: 1px solid #fbbf24;">${variant.size}</td>
              <td style="padding: 8px; border: 1px solid #fbbf24;">${variant.color}</td>
              <td style="padding: 8px; border: 1px solid #fbbf24; text-align: right; font-weight: 600;">${variant.stock_quantity} pcs</td>
            </tr>
          `;
        });

        tbody.innerHTML = html;
        totalSpan.textContent = `${totalStock} pcs`;
        summary.style.display = 'block';
      }

      function syncEditVariantsHiddenField() {
        const hiddenField = document.getElementById('variants_data');
        if (!hiddenField) {
          return;
        }

        const serialized = Object.values(editVariantMap || {}).filter(variant => {
          if (!variant.id && variant.deleted) {
            return false;
          }
          return true;
        }).map(variant => ({
          id: variant.id,
          color: variant.color,
          size: variant.size,
          stock_quantity: Number(variant.stock_quantity) || 0,
          is_active: variant.is_active ?? 1,
          isNew: !!variant.isNew,
          deleted: !!variant.deleted,
          modified: !!variant.modified
        }));

        editVariantsData = serialized;
        hiddenField.value = JSON.stringify(serialized);
      }

      function loadOrders(initialFilter = 'all') {
        console.log('[FETCH] Fetching orders from /seller/orders');
        
        // Update current filter
        currentOrderFilter = initialFilter;

        fetch('/seller/orders', { credentials: 'include' })
          .then(response => {
            console.log('[RESPONSE] Response status:', response.status);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            console.log('[SUCCESS] Orders response:', data);
            console.log('[SUCCESS] Orders array:', data.orders);
            console.log('[SUCCESS] Orders count:', data.orders ? data.orders.length : 0);

            if (data.success && data.orders && Array.isArray(data.orders)) {
              allOrders = data.orders;
              console.log('[SUCCESS] All orders stored:', allOrders.length);
              updateOrderCount(allOrders.length);
              updateStatusCounts();

              const nextFilter = initialFilter || 'all';
              filterOrders(nextFilter);
            } else {
              console.warn('‚ùå No orders in response or invalid format:', data);
              allOrders = [];
              updateOrderCount(0);
              updateStatusCounts();
              const ordersList = document.getElementById('orders-list');
              if (ordersList) {
                ordersList.innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No orders yet</p>';
              }
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading orders:', error);
            updateOrderCount(0);
            updateStatusCounts();
            const ordersList = document.getElementById('orders-list');
            if (ordersList) {
              ordersList.innerHTML = `<p style="color:#d32f2f;padding:40px;text-align:center;">Error loading orders: ${error.message}</p>`;
            }
          });
      }
      function displayOrders(orders) {
        const container = document.getElementById('orders-list');

        if (!container) {
          console.error('‚ùå orders-list container not found');
          return;
        }

        console.log('üìä Displaying orders:', orders ? orders.length : 0, orders);

        if (!orders || orders.length === 0) {
          container.innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No orders found</p>';
          return;
        }

        let html = `
          <div class="orders-table-wrapper table-scroll">
            <table class="orders-table">
              <thead>
                <tr>
                  <th>Order Number</th>
                  <th>Customer</th>
                  <th>Items</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th>View Order</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
        `;

        orders.forEach(order => {
          const statusColors = {
            'pending': '#ff9800',
            'confirmed': '#2196f3',
            'waiting_for_pickup': '#8b5cf6',
            'processing': '#ff5722',
            'shipped': '#4caf50',
            'delivered': '#9c27b0',
            'cancelled': '#f44336',
            'returned': '#795548'
          };

          const statusEmojis = {
            'pending': '‚è≥',
            'confirmed': '‚úîÔ∏è',
            'waiting_for_pickup': '‚è∏Ô∏è',
            'processing': 'üîÑ',
            'shipped': 'üì¶',
            'delivered': '‚úÖ',
            'cancelled': '‚ùå',
            'returned': '‚Ü©Ô∏è'
          };

          const statusBadgeColor = statusColors[order.order_status] || '#666';
          const statusEmoji = statusEmojis[order.order_status] || 'üìã';
          const orderDate = formatPHDate(order.created_at, {
            month: 'short',
            day: 'numeric',
            year: 'numeric'
          });

          const actionMarkup = (() => {
            if (order.order_status === 'pending') {
              return '<button class="order-action order-action--info" onclick="confirmOrder(' + order.id + ')">‚úì Confirm</button>';
            } else if (order.order_status === 'confirmed') {
              return '<button class="order-action order-action--violet" onclick="setToWaitingPickup(' + order.id + ')">‚è∞ Mark Waiting</button>';
            } else if (order.order_status === 'waiting_for_pickup') {
              return '<span class="order-action-badge order-action-badge--violet">‚è∞ Awaiting Rider</span>';
            } else if (order.order_status === 'released_to_rider') {
              return '<button class="order-action order-action--success" onclick="viewDeliveryStatus(' + order.id + ')">üìç Track</button>';
            } else if (order.order_status === 'shipped') {
              let btns = '<button class="order-action order-action--success" onclick="viewDeliveryStatus(' + order.id + ')">üìç Track</button>';
              btns += '<button class="order-action order-action--success" onclick="confirmDelivery(' + order.id + ')">‚úÖ Delivered</button>';
              return btns;
            } else if (order.order_status === 'delivered') {
              return '<span class="order-action-badge order-action-badge--success">‚úÖ Delivered</span>';
            } else if (order.order_status !== 'cancelled') {
              return '<button class="order-action order-action--info" onclick="viewDeliveryStatus(' + order.id + ')">üìç Track</button>';
            }
            return '<span style="font-size:12px; color:#94a3b8;">‚Äî</span>';
          })();

          const viewButton = `
            <button class="order-view-btn" onclick="viewOrderDetails(${order.id})">
              üëÅÔ∏è View Order
            </button>
          `;

          html += `
            <tr style="border-bottom: 1px solid #eee;" data-order-id="${order.id}" data-order-status="${order.order_status}">
              <td style="padding:10px;"><strong>${order.order_number}</strong></td>
              <td style="padding:10px;">${order.customer_name || 'N/A'}</td>
              <td style="padding:10px;">${order.item_count || 1} item(s)</td>
              <td class="orders-table__cell orders-table__cell--amount">‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)}</td>
              <td style="padding:10px;">
                <span style="background:${statusBadgeColor}; color:#fff; padding:4px 8px; border-radius:4px; font-size:12px; font-weight:600;">
                  ${statusEmoji} ${order.order_status.replace(/_/g, ' ').toUpperCase()}
                </span>
              </td>
              <td style="padding:10px; font-size:12px; color:#666;">${orderDate}</td>
              <td class="orders-table__cell orders-table__cell--view">${viewButton}</td>
              <td class="orders-table__cell orders-table__cell--action">
                <div class="order-actions">
                  ${actionMarkup}
                </div>
              </td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>
          </div>
        `;

        container.innerHTML = html;
      }

      function viewOrderDetails(orderId) {
        const modal = ensureOrderDetailsModal();
        const body = modal.querySelector('#order-modal-body');
        body.innerHTML = '<p style="padding:40px 0; text-align:center; color:#6b7280;">Loading order details...</p>';
        modal.style.display = 'flex';

        fetch(`/seller/order/${orderId}`)
          .then(response => response.json())
          .then(data => {
            if (!data.success || !data.order) {
              body.innerHTML = `<p style="padding:40px 0; text-align:center; color:#ef4444;">${data.error || 'Unable to load order details'}</p>`;
              return;
            }

            const order = data.order;
            const items = data.items || [];
            const formatCurrency = (amount) => '‚Ç±' + parseFloat(amount || 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const sellerSubtotal = parseFloat(order.seller_subtotal ?? order.seller_total_amount ?? order.subtotal ?? 0);
            const sellerTotal = parseFloat(order.seller_total_amount ?? sellerSubtotal);
            const sellerItemCount = order.seller_item_count ?? order.item_count ?? items.length;
            const buyerShipping = order.shipping_fee !== null && order.shipping_fee !== undefined ? parseFloat(order.shipping_fee) : null;
            const buyerOrderTotal = parseFloat(order.order_total_amount ?? sellerTotal);

            const statusColors = {
              'pending': '#ff9800',
              'confirmed': '#2196f3',
              'waiting_for_pickup': '#8b5cf6',
              'processing': '#ff5722',
              'shipped': '#4caf50',
              'released_to_rider': '#10b981',
              'delivered': '#059669',
              'cancelled': '#f44336',
              'returned': '#795548'
            };
            const statusEmoji = {
              'pending': '‚è≥',
              'confirmed': '‚úîÔ∏è',
              'waiting_for_pickup': '‚è∞',
              'processing': 'üîÑ',
              'shipped': 'üì¶',
              'released_to_rider': 'üöö',
              'delivered': '‚úÖ',
              'cancelled': '‚ùå',
              'returned': '‚Ü©Ô∏è'
            };
            const badgeColor = statusColors[order.order_status] || '#374151';
            const badgeEmoji = statusEmoji[order.order_status] || 'üìã';
            const orderDate = order.created_at ? formatPHDateTime(order.created_at, {
              month: 'short',
              day: 'numeric',
              year: 'numeric',
              hour: 'numeric',
              minute: 'numeric'
            }) : '‚Äî';

            let itemsHtml = '';
            if (items.length === 0) {
              itemsHtml = '<tr><td colspan="5" style="text-align:center; color:#999; padding:16px;">No products found for this order</td></tr>';
            } else {
              items.forEach(item => {
                const image = item.image_url || '/static/images/placeholder-product.png';
                itemsHtml += `
                  <tr style="border-bottom:1px solid #f1f1f1;">
                    <td style="padding:12px 8px;">
                      <div style="display:flex; align-items:center; gap:12px;">
                        <img src="${image}" alt="${item.product_name}" style="width:48px; height:48px; object-fit:cover; border-radius:8px; border:1px solid #eee;" onerror="this.src='/static/images/placeholder-product.png'">
                        <div>
                          <div style="font-weight:600;">${item.product_name}</div>
                          <div style="font-size:12px; color:#6b7280;">${item.size ? 'Size: ' + item.size : ''}${item.size && item.color ? ' ‚Ä¢ ' : ''}${item.color ? 'Color: ' + item.color : ''}</div>
                        </div>
                      </div>
                    </td>
                    <td style="padding:12px 8px; text-align:center;">${item.quantity}</td>
                    <td style="padding:12px 8px; text-align:right;">${formatCurrency(item.unit_price)}</td>
                    <td style="padding:12px 8px; text-align:right; font-weight:600;">${formatCurrency(item.subtotal)}</td>
                  </tr>
                `;
              });
            }

            const shippingRecipient = order.recipient_name || order.customer_name || 'Customer';
            const shippingPhone = order.recipient_phone || 'Not provided';
            const shippingAddress = order.shipping_address_text || 'Shipping address not available';

            body.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap;">
                <div>
                  <div style="font-size:13px; color:#6b7280;">Order Number</div>
                  <div style="font-size:22px; font-weight:700;">${order.order_number}</div>
                  <div style="font-size:13px; color:#6b7280; margin-top:4px;">${sellerItemCount} item(s) for your store</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                  <span style="background:${badgeColor}; color:#fff; padding:6px 12px; border-radius:999px; font-size:13px; font-weight:600;">
                    ${badgeEmoji} ${order.order_status.replace(/_/g, ' ').toUpperCase()}
                  </span>
                  <button type="button" onclick="closeOrderDetailsModal()" style="border:none; background:#f3f4f6; color:#6b7280; width:36px; height:36px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer;">√ó</button>
                </div>
              </div>
              <p style="margin:12px 0 24px; color:#6b7280; font-size:13px;">Placed on ${orderDate}</p>

              <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-bottom:24px;">
                <div style="border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                  <h3 style="margin:0 0 8px; font-size:15px;">Customer</h3>
                  <p style="margin:0; font-weight:600;">${order.customer_name || 'N/A'}</p>
                  <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">${order.customer_email || ''}</p>
                </div>
                <div style="border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                  <h3 style="margin:0 0 8px; font-size:15px;">Shipping</h3>
                  <p style="margin:0; font-weight:600;">${shippingRecipient}</p>
                  <p style="margin:4px 0; color:#6b7280; font-size:13px;">${shippingAddress}</p>
                  <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">üìû ${shippingPhone}</p>
                </div>
                <div style="border:1px solid #e5e7eb; border-radius:12px; padding:16px;">
                  <h3 style="margin:0 0 8px; font-size:15px;">Payment</h3>
                  <p style="margin:0; font-weight:600;">${order.payment_method || 'N/A'}</p>
                  <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">Buyer paid (entire order): ${formatCurrency(buyerOrderTotal)}</p>
                  <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">Your earnings for this order: <strong>${formatCurrency(sellerTotal)}</strong></p>
                </div>
              </div>

              <h3 style="margin:0 0 12px; font-size:16px;">Ordered Products</h3>
              <div style="border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;">
                <table style="width:100%; border-collapse:collapse; font-size:13px;">
                  <thead style="background:#f9fafb;">
                    <tr>
                      <th style="text-align:left; padding:12px 8px;">Product</th>
                      <th style="text-align:center; padding:12px 8px; width:80px;">Qty</th>
                      <th style="text-align:right; padding:12px 8px; width:120px;">Price</th>
                      <th style="text-align:right; padding:12px 8px; width:140px;">Subtotal</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${itemsHtml}
                  </tbody>
                </table>
              </div>

              <div style="display:flex; justify-content:flex-end; margin-top:20px;">
                <div style="width:260px;">
                  <div style="display:flex; justify-content:space-between; margin-bottom:6px; color:#6b7280;">
                    <span>Seller Subtotal</span>
                    <span>${formatCurrency(sellerSubtotal)}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; margin-bottom:6px; color:#6b7280;">
                    <span>Buyer Paid Shipping</span>
                    <span>${buyerShipping !== null ? formatCurrency(buyerShipping) : '‚Äî'}</span>
                  </div>
                  <div style="display:flex; justify-content:space-between; font-weight:700; font-size:16px; border-top:1px solid #e5e7eb; padding-top:8px;">
                    <span>Amount Due to You</span>
                    <span>${formatCurrency(sellerTotal)}</span>
                  </div>
                </div>
              </div>
            `;
          })
          .catch(error => {
            console.error('Error loading order details:', error);
            body.innerHTML = '<p style="padding:40px 0; text-align:center; color:#ef4444;">Error loading order details</p>';
          });
      }

      function ensureOrderDetailsModal() {
        let modal = document.getElementById('order-details-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'order-details-modal';
          modal.style.cssText = 'position:fixed; inset:0; background:rgba(10,10,10,0.65); display:none; align-items:center; justify-content:center; z-index:1100; padding:20px;';
          modal.innerHTML = `
            <div style="background:#fff; border-radius:16px; width:min(900px, 95vw); max-height:90vh; overflow-y:auto; padding:32px; position:relative; box-shadow:0 20px 60px rgba(0,0,0,0.25);">
              <div id="order-modal-body"></div>
            </div>
          `;
          modal.addEventListener('click', (event) => {
            if (event.target === modal) {
              closeOrderDetailsModal();
            }
          });
          document.body.appendChild(modal);
        }
        return modal;
      }

      function closeOrderDetailsModal() {
        const modal = document.getElementById('order-details-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function ensureTrackOrderModal() {
        let modal = document.getElementById('track-order-modal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'track-order-modal';
          modal.className = 'dashboard-modal';
          modal.innerHTML = `
            <div class="dashboard-modal__card">
              <div id="track-order-body"></div>
            </div>
          `;
          modal.addEventListener('click', (event) => {
            if (event.target === modal) {
              closeTrackOrderModal();
            }
          });
          document.body.appendChild(modal);
        }
        return modal;
      }

      function closeTrackOrderModal() {
        const modal = document.getElementById('track-order-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      // Filter orders by status and search term
      function filterOrders(status) {
        const nextFilter = status || currentOrderFilter || 'all';
        console.log('üìã Filtering orders by status:', nextFilter, '| search term:', currentOrderSearchTerm);

        currentOrderFilter = nextFilter;

        const filterButtons = document.querySelectorAll('.order-status-card[data-filter-btn]');
        filterButtons.forEach(btn => {
          const isActive = btn.getAttribute('data-filter-btn') === nextFilter;
          btn.setAttribute('data-state', isActive ? 'active' : 'idle');
          btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });

        let filtered = Array.isArray(allOrders) ? allOrders.slice() : [];

        if (nextFilter !== 'all') {
          filtered = filtered.filter(order => {
            if (nextFilter === 'release_to_rider') {
              return order.order_status === 'confirmed' && order.seller_confirmed_rider === true;
            }
            return order.order_status === nextFilter;
          });
        }

        const normalizedSearch = (currentOrderSearchTerm || '').toLowerCase();
        if (normalizedSearch) {
          filtered = filtered.filter(order => {
            const searchableFields = [
              order.order_number,
              order.customer_name,
              order.customer_email,
              order.customer_phone,
              order.shipping_city,
              order.shipping_province,
              order.order_status
            ].filter(Boolean).map(value => value.toString().toLowerCase());

            if (Array.isArray(order.items)) {
              order.items.forEach(item => {
                if (item && item.product_name) {
                  searchableFields.push(item.product_name.toLowerCase());
                }
              });
            }

            return searchableFields.some(field => field.includes(normalizedSearch));
          });
        }

        console.log(`‚úÖ Filtered ${filtered.length} orders with status: ${nextFilter}`);
        displayOrders(filtered);
      }

      const orderStatusFlow = {
        'pending': ['confirmed'],
        'confirmed': ['waiting_for_pickup'],
        'waiting_for_pickup': ['delivered'],
        'delivered': [],
        'cancelled': [],
        'returned': []
      };

      function getNextAllowedStatuses(currentStatus) {
        return orderStatusFlow[currentStatus] || [];
      }

      function openStatusModal(orderId, currentStatus) {
        console.log('üîÑ Opening order management modal for order:', orderId, 'Current status:', currentStatus);


        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          VaronNotifications.error('Order not found');
          return;
        }


        const allowedStatuses = getNextAllowedStatuses(currentStatus);

        if (allowedStatuses.length === 0) {
          alert(`‚ö†Ô∏è This order is in a final state (${currentStatus.toUpperCase()}) and cannot be modified further.`);
          return;
        }


        const statusDescriptions = {
          'confirmed': { desc: 'Start preparing the order for shipment', icon: 'üì¶', color: '#3b82f6' },
          'processing': { desc: 'Package is ready and awaiting shipment', icon: 'üìã', color: '#8b5cf6' },
          'shipped': { desc: 'Order dispatched to delivery address', icon: 'üöö', color: '#06b6d4' },
          'delivered': { desc: 'Order successfully delivered to customer', icon: '‚úÖ', color: '#10b981' },
          'cancelled': { desc: 'Cancel this order (cannot be reopened)', icon: '‚ùå', color: '#ef4444' }
        };

        let statusOptions = allowedStatuses.map(s => {
          const info = statusDescriptions[s] || {};
          return `<option value="${s}" data-description="${info.desc}">${info.icon} ${s.replace(/_/g, ' ').toUpperCase()}</option>`;
        }).join('');

        const currentStatusInfo = statusDescriptions[currentStatus] || {};

        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';
        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:550px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>

            <h2 style="margin:0 0 24px; font-size:22px; font-weight:600; color:#0a0a0a;">üìã Order Management</h2>

            
            <div style="background:#f3f4f6; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0 0 8px; font-size:12px; color:#6b7280; font-weight:600; text-transform:uppercase;">Current Status</p>
              <div style="font-size:18px; font-weight:600; color:#0a0a0a;">
                ${currentStatusInfo.icon} ${currentStatus.replace(/_/g, ' ').toUpperCase()}
              </div>
              <p style="margin:8px 0 0; font-size:13px; color:#6b7280;">${currentStatusInfo.desc || ''}</p>
            </div>

            
            <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0; font-size:12px; color:#6b7280; font-weight:600;">üì¶ Order #${order.order_number || order.id}</p>
              <p style="margin:4px 0 0; font-size:12px; color:#6b7280;color:12px;>üí∞ Total: ‚Ç±${parseFloat(order.total_amount || 0).toFixed(2)} | üë§ ${order.customer_name || 'N/A'}</p>
              <p style="margin:4px 0 0; font-size:12px; color:#6b7280;">üìÖ Placed: ${formatPHDate(order.created_at)}</p>
            </div>

            
            <div style="margin-bottom:20px;">
              <label style="display:block; margin-bottom:8px; font-weight:600; font-size:14px; color:#0a0a0a;">Next Status</label>
              <select id="new-status-select" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; cursor:pointer; color:#0a0a0a;" onchange="updateStatusDescription(this)">
                <option value="">-- Select next status --</option>
                ${statusOptions}
              </select>
              <p id="status-description" style="margin:12px 0 0; padding:12px; background:#f0f9ff; border-left:3px solid #3b82f6; border-radius:4px; color:#0c4a6e; font-size:13px; display:none;"></p>
            </div>

            
            <div id="status-warning" style="display:none; margin-bottom:20px; padding:12px; background:#fef3c7; border-left:3px solid #f59e0b; border-radius:4px;">
              <p style="margin:0; color:#92400e; font-size:13px; font-weight:600;">‚ö†Ô∏è <span id="warning-text"></span></p>
            </div>

            
            <div style="display:flex; gap:12px; justify-content:flex-end;">
              <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px; border:1px solid #e5e7eb; background:#f6f6f6; color:#0a0a0a; border-radius:8px; cursor:pointer; font-weight:600;">
                Cancel
              </button>
              <button onclick="updateOrderStatus(${orderId})" style="padding:12px 24px; border:none; background:#0a0a0a; color:#fff; border-radius:8px; cursor:pointer; font-weight:600;" id="update-btn" disabled>
                Update Status
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      }

      function updateStatusDescription(selectElement) {
        const selectedStatus = selectElement.value;
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const description = selectedOption.getAttribute('data-description');

        const descDiv = document.getElementById('status-description');
        const updateBtn = document.getElementById('update-btn');

        if (selectedStatus) {
          descDiv.textContent = description;
          descDiv.style.display = 'block';
          updateBtn.disabled = false;
          updateBtn.style.opacity = '1';
          updateBtn.style.cursor = 'pointer';


          if (selectedStatus === 'delivered') {
            document.getElementById('status-warning').style.display = 'block';
            document.getElementById('warning-text').textContent = 'Once marked as delivered, this order cannot be modified.';
          } else if (selectedStatus === 'cancelled') {
            document.getElementById('status-warning').style.display = 'block';
            document.getElementById('warning-text').textContent = 'Cancelled orders cannot be reopened.';
          } else {
            document.getElementById('status-warning').style.display = 'none';
          }
        } else {
          descDiv.style.display = 'none';
          updateBtn.disabled = true;
          updateBtn.style.opacity = '0.5';
          updateBtn.style.cursor = 'not-allowed';
          document.getElementById('status-warning').style.display = 'none';
        }
      }

      function updateOrderStatus(orderId) {
        const newStatus = document.getElementById('new-status-select').value;

        if (!newStatus) {
          VaronNotifications.warning('Please select a valid status');
          return;
        }


        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          VaronNotifications.error('Order not found');
          return;
        }

        const currentStatus = order.order_status;
        const allowedStatuses = getNextAllowedStatuses(currentStatus);


        if (!allowedStatuses.includes(newStatus)) {
          alert(`‚ùå Invalid status transition:. Cannot go from "${currentStatus.toUpperCase()}" to "${newStatus.toUpperCase()}". Forward-only transitions are allowed.`);
          return;
        }

        const updateBtn = document.getElementById('update-btn');
        const originalText = updateBtn.textContent;
        updateBtn.disabled = true;
        updateBtn.textContent = '‚è≥ Updating...';

        console.log('üìä Updating order status: orderId=' + orderId + ', from=' + currentStatus + ', to=' + newStatus);

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', newStatus);

        fetch('/seller/update-order-status', {
          method: 'POST',
          body: formData
        })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.success) {
              const statusEmojis = {
                'confirmed': '‚úÖ',
                'processing': 'üîÑ',
                'shipped': 'üì¶',
                'delivered': '‚úÖ',
                'cancelled': '‚ùå'
              };

              alert(`${statusEmojis[newStatus] || '‚úÖ'} Order status updated!. üìã Order #${order.order_number}. ‚è±Ô∏è New Status: ${newStatus.replace(/_/g, ' ').toUpperCase()}`);


              document.querySelectorAll('[style*="position:fixed"]').forEach(el => el.remove());
              loadOrders(currentOrderFilter);
              if (typeof fetchOrderCount === 'function') fetchOrderCount();
            } else {
              alert('‚ùå Failed to update order status:. ' + (data.message || data.error || 'Unknown error'));
              updateBtn.disabled = false;
              updateBtn.textContent = originalText;
            }
          })
          .catch(error => {
            console.error('‚ùå Error updating order status:', error);
            VaronNotifications.error('Error updating order status: ' + error.message);
            updateBtn.disabled = false;
            updateBtn.textContent = originalText;
          });
      }

      async function approveRider(orderId, shipmentId) {
        console.log('[SUCCESS] Approving rider for order:', orderId, 'shipment:', shipmentId);

        const confirmed = await VaronNotifications.confirm('Approve this rider to pick up the order?', {
          title: 'Approve Rider',
          confirmText: 'Approve',
          cancelText: 'Cancel'
        });
        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        if (shipmentId) {
          formData.append('shipment_id', shipmentId);
        }

        fetch('/seller/approve-rider', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            VaronNotifications.success('Rider approved! You can now release the order to rider.');
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to approve rider: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error approving rider:', error);
          VaronNotifications.error('Error approving rider: ' + error.message);
        });
      }

      // ===== NEW: Notification and Status Tracking Functions =====

      function updateStatusCounts() {
        const counts = {
          pending: 0,
          confirmed: 0,
          waiting_for_pickup: 0,
          released_to_rider: 0,
          delivered: 0
        };

        if (Array.isArray(allOrders)) {
          allOrders.forEach(order => {
            if (counts.hasOwnProperty(order.order_status)) {
              counts[order.order_status]++;
            }
          });
        }

        const totalOrders = Array.isArray(allOrders) ? allOrders.length : 0;
        setOrderStatusCount('all', totalOrders);
        Object.entries(counts).forEach(([status, value]) => setOrderStatusCount(status, value));
      }

      function setOrderStatusCount(status, value) {
        const target = document.querySelector(`[data-status-count="${status}"]`);
        if (target) {
          target.textContent = value;
        }
      }

      function updateNotificationBadge() {
        console.log('[FETCH] Updating notification badge...');
        
        fetch('/api/seller/notifications?unread_only=true&limit=1', { credentials: 'include' })
          .then(response => {
            if (!response.ok) return;
            return response.json();
          })
          .then(data => {
            if (data && data.success) {
              const badge = document.getElementById('notification-badge');
              if (badge) {
                const unreadCount = data.unread_count || 0;
                if (unreadCount > 0) {
                  badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                  badge.style.display = 'inline-block';
                  console.log(`üì¨ ${unreadCount} unread notifications`);
                } else {
                  badge.style.display = 'none';
                  console.log('üì≠ No unread notifications');
                }
              }
            }
          })
          .catch(error => {
            console.error('‚ö†Ô∏è Error updating notification badge:', error);
          });
      }

      function loadNotifications() {
        console.log('[FETCH] Loading seller notifications...');

        fetch('/api/seller/notifications?unread_only=false&limit=20', { credentials: 'include' })
          .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
          })
          .then(data => {
            if (data.success && data.notifications) {
              displayNotifications(data.notifications, data.unread_count);
            } else {
              VaronNotifications.error('Failed to load notifications');
            }
          })
          .catch(error => {
            console.error('‚ùå Error loading notifications:', error);
            VaronNotifications.error('Error loading notifications: ' + error.message);
          });
      }

      function displayNotifications(notifications, unreadCount) {
        const content = document.getElementById('dashboardContent');
        if (!content) return;

        // Update notification badge
        const badge = document.getElementById('notification-badge');
        if (badge) {
          if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.style.display = 'inline-block';
          } else {
            badge.style.display = 'none';
          }
        }

        let html = `
          <div class="card">
            <div class="inner">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;"> Notifications</h2>
                <button onclick="loadPage('orders')" style="background: #0a0a0a; color: #fff; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 13px;">‚Üê Back to Orders</button>
              </div>

              <div style="max-height: 600px; overflow-y: auto;">
        `;

        if (notifications.length === 0) {
          html += '<p style="color: #999; text-align: center; padding: 40px;">No notifications yet</p>';
        } else {
          notifications.forEach(notif => {
            const createdDate = formatPHDate(notif.created_at);
            const createdTime = formatPHTime(notif.created_at);
            const isRead = notif.is_read ? 'opacity: 0.6;' : '';
            const typeEmojis = {
              'new_order': 'üì¶',
              'order_confirmed': '‚úîÔ∏è',
              'order_released': 'üöö',
              'order_cancelled': '‚ùå',
              'rider_assigned': 'üèçÔ∏è',
              'delivery_complete': '‚úÖ'
            };
            const emoji = typeEmojis[notif.notification_type] || 'üì¢';

            html += `
              <div style="background: #f9fafb; border-left: 4px solid ${notif.priority === 'high' ? '#ef4444' : '#3b82f6'}; padding: 14px; margin-bottom: 10px; border-radius: 6px; ${isRead}" onclick="${!notif.is_read ? `markNotificationRead(${notif.id})` : ''}">
                <div style="display: flex; justify-content: space-between; align-items: start; gap: 10px;">
                  <div style="flex: 1;">
                    <p style="margin: 0 0 6px; font-weight: 600; color: #0a0a0a; font-size: 14px;">
                      ${emoji} ${notif.title}
                    </p>
                    <p style="margin: 0 0 8px; color: #6b7280; font-size: 13px;">${notif.message}</p>
                    <p style="margin: 0; font-size: 11px; color: #9ca3af;">${createdDate} at ${createdTime}</p>
                  </div>
                  ${!notif.is_read ? `<span style="background: #3b82f6; color: white; width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; margin-top: 4px;"></span>` : ''}
                </div>
              </div>
            `;
          });
        }

        html += `
              </div>
            </div>
          </div>
        `;

        content.innerHTML = html;
      }

      function markNotificationRead(notificationId) {
        console.log('[POST] Marking notification as read:', notificationId);

        fetch(`/api/seller/notifications/${notificationId}/read`, {
          method: 'POST',
          credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('‚úÖ Notification marked as read');
            loadNotifications();
            updateNotificationBadge();
          }
        })
        .catch(error => console.error('‚ùå Error marking notification read:', error));
      }

      async function releaseOrderToRider(orderId) {
        console.log('[INFO] Releasing order to rider:', orderId);

        const confirmed = await VaronNotifications.confirm(
          'Release this order for rider pickup? Available riders in the area will be notified.',
          {
            confirmText: 'Release Order',
            cancelText: 'Not Now',
            confirmClass: 'confirm'
          }
        );

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);

        try {
          const response = await fetch(`/api/seller/order/${orderId}/release`, {
            method: 'POST',
            body: formData,
            credentials: 'include'
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success(data.message || 'Order released for rider pickup');
            loadOrders(currentOrderFilter || 'all');
            loadNotifications();
          } else {
            VaronNotifications.error('Failed to release order: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error releasing order:', error);
          VaronNotifications.error('Error releasing order: ' + error.message);
        }
      }

      async function confirmOrder(orderId) {
        console.log('[INFO] Confirming order:', orderId);

        const confirmed = await VaronNotifications.confirm('Confirm this order?', {
          confirmText: 'Confirm Order',
          cancelText: 'Not Yet',
          confirmClass: 'confirm'
        });

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);

        try {
          const response = await fetch('/seller/confirm-order', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            const message = data.rider_assigned ?
              '‚úÖ Order confirmed and assigned to a rider!' :
              '‚úÖ Order confirmed! A rider in your area will accept it soon.';
            VaronNotifications.success(message);
            loadOrders(currentOrderFilter);
            updateStatusCounts();
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to confirm order: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error confirming order:', error);
          VaronNotifications.error('Error confirming order: ' + error.message);
        }
      }

      async function setToWaitingPickup(orderId) {
        console.log('[INFO] Setting order to waiting for pickup:', orderId);

        const confirmed = await VaronNotifications.confirm(
          'Mark this order as Waiting for Pick Up? Riders will be able to accept this order.',
          {
            confirmText: 'Enable Pickup',
            cancelText: 'Keep Pending',
            confirmClass: 'confirm'
          }
        );

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'waiting_for_pickup');

        try {
          const response = await fetch('/seller/update-order-status', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Order marked as Waiting for Pick Up!');
            loadOrders(currentOrderFilter || 'all');
          } else {
            VaronNotifications.error('Error: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error updating order status:', error);
          VaronNotifications.error('Error updating order: ' + error.message);
        }
      }

      function viewDeliveryStatus(orderId) {
        console.log('üìç Viewing delivery status for order:', orderId);
        const order = allOrders.find(o => o.id === orderId);

        if (!order) {
          VaronNotifications.error('Order not found');
          return;
        }

        const modal = ensureTrackOrderModal();
        const body = modal.querySelector('#track-order-body');
        modal.style.display = 'flex';

        const shipmentStatusRaw = (order.shipment_status || order.order_status || 'pending').toString();
        const orderStatusRaw = (order.order_status || 'pending').toString();
        const shipmentStatusKey = shipmentStatusRaw.toLowerCase();
        const shipmentStatusLabel = shipmentStatusRaw.replace(/_/g, ' ').toUpperCase();
        const orderStatusLabel = orderStatusRaw.replace(/_/g, ' ').toUpperCase();

        const shipmentBadges = {
          'pending': { bg: '#fef3c7', color: '#92400e', icon: '‚è≥' },
          'picked_up': { bg: '#dbeafe', color: '#1d4ed8', icon: 'üì¶' },
          'in_transit': { bg: '#ede9fe', color: '#5b21b6', icon: 'üöö' },
          'out_for_delivery': { bg: '#dcfce7', color: '#047857', icon: 'üìç' },
          'delivered': { bg: '#e0f2fe', color: '#0369a1', icon: '‚úÖ' },
          'failed': { bg: '#fee2e2', color: '#b91c1c', icon: '‚ö†Ô∏è' },
          'assigned_to_rider': { bg: '#fef9c3', color: '#854d0e', icon: 'üèçÔ∏è' }
        };

        const shipmentBadge = shipmentBadges[shipmentStatusKey] || { bg: '#e2e8f0', color: '#0f172a', icon: 'üì¶' };

        const shippingCity = order.shipping_city || '';
        const shippingProvince = order.shipping_province || '';
        const addressSummary = order.shipping_address_text || [shippingCity, shippingProvince].filter(Boolean).join(', ') || 'Not provided';
        const recipientName = order.recipient_name || order.customer_name || 'Customer';
        const recipientPhone = order.recipient_phone || order.customer_phone || 'Not provided';
        const trackingNumber = order.tracking_number || order.awb_number || order.airway_bill || 'Not assigned';
        const riderName = order.rider_name || 'Awaiting assignment';
        const riderPhone = order.rider_phone || order.rider_contact || 'Not provided';
        const riderVehicle = order.rider_vehicle || order.rider_vehicle_type || 'Not specified';
        const riderPlate = order.rider_plate_number || order.rider_plate || '‚Äî';
        const etaValue = order.estimated_delivery_at ? formatPHDateTime(order.estimated_delivery_at) : '‚Äî';
        const lastUpdate = order.shipment_status_updated_at
          ? formatPHDateTime(order.shipment_status_updated_at)
          : (order.updated_at ? formatPHDateTime(order.updated_at) : '‚Äî');

        const trackingUpdatesRaw = order.tracking_updates || order.shipment_updates || order.trackingEvents || [];
        const trackingUpdates = Array.isArray(trackingUpdatesRaw) ? trackingUpdatesRaw : [];

        const mappedUpdates = trackingUpdates.map((update, index) => {
          const safeUpdate = update || {};
          const timestampRaw = safeUpdate.timestamp || safeUpdate.created_at || safeUpdate.time || safeUpdate.logged_at || null;
          const parsedTimestamp = timestampRaw ? Date.parse(timestampRaw) : NaN;
          const fallbackOrder = Date.now() - index;
          const numericTime = Number.isFinite(parsedTimestamp) ? parsedTimestamp : fallbackOrder;
          const formattedTime = timestampRaw ? formatPHDateTime(timestampRaw) : `Update ${index + 1}`;
          const statusText = escapeHtml((safeUpdate.status || safeUpdate.description || `Status update ${index + 1}`).toString());
          const locationText = escapeHtml(([safeUpdate.location, safeUpdate.city, safeUpdate.province].filter(Boolean).join(', ')) || addressSummary);
          const noteText = safeUpdate.note || safeUpdate.details || safeUpdate.comment || '';

          return {
            rawTime: numericTime,
            time: formattedTime,
            status: statusText,
            location: locationText,
            note: noteText ? escapeHtml(noteText.toString()) : ''
          };
        }).sort((a, b) => b.rawTime - a.rawTime);

        const timelineHtml = mappedUpdates.length
          ? mappedUpdates.map(event => `
              <div class="tracking-event">
                <div class="tracking-event__time">${event.time}</div>
                <div>
                  <div class="tracking-event__details">${event.status}</div>
                  <div class="tracking-event__location">üìç ${event.location}</div>
                  ${event.note ? `<div class="tracking-event__note">${event.note}</div>` : ''}
                </div>
              </div>
            `).join('')
          : `<p class="tracking-empty">No live tracking updates yet. Current status: <strong>${escapeHtml(shipmentStatusLabel)}</strong>.</p>`;

        body.innerHTML = `
          <div class="dashboard-modal__header">
            <div>
              <p style="margin:0; font-size:12px; letter-spacing:0.08em; color:#94a3b8; text-transform:uppercase;">Track Order</p>
              <h2 class="dashboard-modal__title">Order #${escapeHtml((order.order_number || orderId).toString())}</h2>
              <p style="margin:4px 0 0; color:#6b7280; font-size:13px;">Customer: <strong>${escapeHtml(order.customer_name || 'N/A')}</strong></p>
            </div>
            <button class="dashboard-modal__close" onclick="closeTrackOrderModal()">√ó</button>
          </div>

          <div class="tracking-status-badges">
            <span class="tracking-badge" style="background:${shipmentBadge.bg}; color:${shipmentBadge.color};">
              ${shipmentBadge.icon} Shipment: ${escapeHtml(shipmentStatusLabel)}
            </span>
            <span class="tracking-badge" style="background:#eef2ff; color:#312e81;">
              üìã Order: ${escapeHtml(orderStatusLabel)}
            </span>
            <span class="tracking-badge" style="background:#f0fdf4; color:#166534;">
              ‚è±Ô∏è Last Update: ${escapeHtml(lastUpdate)}
            </span>
          </div>

          <div class="tracking-grid">
            <div class="tracking-card">
              <h4>Destination</h4>
              <p><strong>${escapeHtml(recipientName)}</strong></p>
              <p>${escapeHtml(addressSummary)}</p>
              <p>üìû ${escapeHtml(recipientPhone)}</p>
            </div>
            <div class="tracking-card">
              <h4>Rider</h4>
              <p><strong>${escapeHtml(riderName)}</strong></p>
              <p>üìû ${escapeHtml(riderPhone)}</p>
              <p>üõµ ${escapeHtml(riderVehicle)}</p>
              <p>ü™™ Plate: ${escapeHtml(riderPlate)}</p>
            </div>
            <div class="tracking-card">
              <h4>Delivery ETA</h4>
              <p>Estimated Arrival</p>
              <p style="font-size:18px; font-weight:700; margin-top:4px;">${escapeHtml(etaValue)}</p>
            </div>
          </div>

          <div class="tracking-card" style="margin-top:24px;">
            <h4>Summary</h4>
            <table class="tracking-summary-table">
              <tbody>
                <tr>
                  <th>Tracking #</th>
                  <td>${escapeHtml(trackingNumber.toString())}</td>
                </tr>
                <tr>
                  <th>Shipment Status</th>
                  <td>${escapeHtml(shipmentStatusLabel)}</td>
                </tr>
                <tr>
                  <th>Order Status</th>
                  <td>${escapeHtml(orderStatusLabel)}</td>
                </tr>
                <tr>
                  <th>Last Update</th>
                  <td>${escapeHtml(lastUpdate)}</td>
                </tr>
                <tr>
                  <th>Destination</th>
                  <td>${escapeHtml(addressSummary)}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="tracking-timeline">
            <div class="tracking-timeline__title">Tracking Updates</div>
            ${timelineHtml}
          </div>
        `;
      }

      async function confirmDelivery(orderId) {
        console.log('[SUCCESS] Confirming delivery for order:', orderId);
        const order = allOrders.find(o => o.id === orderId);

        if (!order) {
          VaronNotifications.error('Order not found');
          return;
        }

        const confirmed = await VaronNotifications.confirm(
          `Confirm that Order #${order.order_number} has been delivered to ${order.customer_name}?`,
          {
            confirmText: 'Mark Delivered',
            cancelText: 'Not Yet',
            confirmClass: 'confirm'
          }
        );

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'delivered');

        try {
          const response = await fetch('/seller/update-order-status', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Order marked as delivered!');
            loadOrders(currentOrderFilter || 'all');
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Error: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error confirming delivery:', error);
          VaronNotifications.error('Error confirming delivery: ' + error.message);
        }
      }

      function releaseToRider(orderId) {
        console.log('üöö Releasing order to rider:', orderId);


        showRiderSelectionModal(orderId);
      }

      function showRiderSelectionModal(orderId) {
        const order = allOrders.find(o => o.id === orderId);
        if (!order) {
          VaronNotifications.error('Order not found');
          return;
        }


        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';
        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:600px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>
            <h2 style="margin:0 0 8px; font-size:22px; font-weight:600; color:#0a0a0a;">üöö Select Rider for Delivery</h2>
            <p style="margin:0 0 24px; color:#666; font-size:14px;">Choose a rider to deliver Order #${order.order_number}</p>
            <div id="seller-island" style="background:#e3f2fd; border-left:4px solid #2196f3; padding:12px; margin-bottom:20px; border-radius:4px; font-size:13px; color:#1565c0;">
              üìç <strong>Order Delivery Region:</strong> <span id="seller-island-text">Loading...</span>
            </div>
            <div id="rider-list" style="min-height:150px; display:flex; align-items:center; justify-content:center; color:#999;">
              ‚è≥ Loading available riders...
            </div>
            <div id="rider-error" style="display:none; padding:12px; background:#fee; color:#c33; border-radius:4px; margin-bottom:16px; border-left:3px solid #f44;"></div>
          </div>
        `;
        document.body.appendChild(modal);


        fetch(`/api/sellers/available-riders?order_id=${orderId}`)
          .then(r => r.json())
          .then(data => {

            let locationInfo = 'your area';
            if (data.delivery_location && data.delivery_location.city) {
              locationInfo = `${data.delivery_location.city}, ${data.delivery_location.province}`;
            }

            if (!data.success || !data.riders || data.riders.length === 0) {
              document.getElementById('rider-list').innerHTML = `
                <div style="text-align:center; padding:24px;">
                  <p style="color:#999; font-size:14px;">‚ö†Ô∏è No available riders found for ${data.delivery_region || 'your area'}</p>
                  <p style="color:#999; font-size:12px; margin-top:8px;">üìç Order delivery to: ${locationInfo}</p>
                  <p style="color:#999; font-size:12px; margin-top:8px;">Make sure riders have their service area set to ${data.delivery_region || 'All areas'}</p>
                  <button onclick="this.closest('[style*=fixed]').remove()" style="margin-top:12px; padding:8px 16px; background:#999; color:#fff; border:none; border-radius:4px; cursor:pointer;">Close</button>
                </div>
              `;
              return;
            }


            if (data.delivery_region) {
              document.getElementById('seller-island').innerHTML = `üìç <strong>Delivery Region:</strong> üèùÔ∏è ${data.delivery_region} (Order to: ${locationInfo})`;
            }


            let riderHTML = '<div style="display:flex;flex-direction:column;gap:12px;">';

            data.riders.forEach(rider => {
              const riderName = rider.first_name && rider.last_name ? `${rider.first_name} ${rider.last_name}` : 'Rider #' + rider.id;
              const vehicleType = rider.vehicle_type || 'Unknown';
              const rating = rider.rating ? `‚≠ê ${parseFloat(rider.rating).toFixed(1)}` : 'No ratings';
              const deliveries = rider.total_deliveries || 0;
              const riderRegion = rider.sub_region || rider.service_area || 'All areas';

              riderHTML += `
                <div style="border:2px solid #e5e7eb; border-radius:8px; padding:16px; display:flex; justify-content:space-between; align-items:center; hover:{background:#f9f9f9};cursor:pointer;" onclick="assignRiderToOrder(${orderId}, ${rider.id}, '${riderName.replace(/'/g, "\\'")}')" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='#fff'">
                  <div>
                    <div style="font-weight:600; color:#0a0a0a; font-size:15px;">üë§ ${riderName}</div>
                    <div style="font-size:13px; color:#666; margin-top:4px;">
                      üöó ${vehicleType} | ${rating} | ${deliveries} deliveries
                    </div>
                    <div style="font-size:12px; color:#2196f3; margin-top:4px; font-weight:500;">
                      üìç Service Region: ${riderRegion}
                    </div>
                  </div>
                  <button style="padding:8px 16px; background:#4caf50; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:600;" onclick="event.stopPropagation(); assignRiderToOrder(${orderId}, ${rider.id}, '${riderName.replace(/'/g, "\\'")}')" onmouseover="this.background='#45a049'" onmouseout="this.background='#4caf50'">
                    ‚úì Select
                  </button>
                </div>
              `;
            });

            riderHTML += '</div>';
            document.getElementById('rider-list').innerHTML = riderHTML;
          })
          .catch(error => {
            console.error('Error loading riders:', error);
            document.getElementById('rider-error').style.display = 'block';
            document.getElementById('rider-error').textContent = '‚ùå Failed to load riders: ' + error.message;
            document.getElementById('rider-list').innerHTML = `
              <div style="text-align:center; padding:24px;">
                <button onclick="this.closest('[style*=fixed]').remove()" style="padding:8px 16px; background:#999; color:#fff; border:none; border-radius:4px; cursor:pointer;">Close</button>
              </div>
            `;
          });
      }

      async function assignRiderToOrder(orderId, riderId, riderName) {
        console.log('[SUCCESS] Assigning rider ' + riderId + ' (' + riderName + ') to order ' + orderId);

        const confirmed = await VaronNotifications.confirm(
          `Assign ${riderName} as the rider for this delivery?`,
          {
            confirmText: 'Assign Rider',
            cancelText: 'Cancel',
            confirmClass: 'confirm'
          }
        );

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('rider_id', riderId);
        formData.append('new_status', 'released_to_rider');

        try {
          const response = await fetch('/seller/release-to-rider', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();
          console.log('Release to rider response:', data);

          if (data.success) {
            document.querySelectorAll('[style*="fixed"]').forEach(el => {
              if (el.style.background && el.style.background.includes('rgba(0,0,0,0.6)')) {
                el.remove();
              }
            });
            VaronNotifications.success(`Order released to ${riderName}! Rider can now start delivery.`);
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to assign rider: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error assigning rider:', error);
          VaronNotifications.error('Error assigning rider: ' + error.message);
        }
      }

      async function releaseToRiderDelivered(orderId) {
        console.log('üöö Releasing to rider (delivered status):', orderId);

        const confirmed = await VaronNotifications.confirm('Release to rider?', {
          confirmText: 'Release',
          cancelText: 'Keep Pending',
          confirmClass: 'confirm'
        });

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'delivered');

        try {
          const response = await fetch('/seller/update-order-status', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Approved! The rider will ship it to the customer.');
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error updating order:', error);
          VaronNotifications.error('Error updating order: ' + error.message);
        }
      }

      async function markShipped(orderId) {
        console.log('[ACTION] Marking order as shipped:', orderId);

        const confirmed = await VaronNotifications.confirm('Mark as Shipped?', {
          confirmText: 'Mark Shipped',
          cancelText: 'Cancel',
          confirmClass: 'confirm'
        });

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', 'shipped');

        try {
          const response = await fetch('/seller/update-order-status', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Order marked as shipped!');
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error updating order:', error);
          VaronNotifications.error('Error updating order: ' + error.message);
        }
      }

      async function updateSellerOrderStatus(orderId, newStatus) {
        console.log('üìä Updating seller order status:', orderId, 'to:', newStatus);

        const statusLabels = {
          'processing': 'üîÑ Processing',
          'shipped': 'üì¶ Ready for Pickup',
          'released_to_rider': 'üöö Release to rider'
        };

        const confirmed = await VaronNotifications.confirm(
          `Update order status to ${statusLabels[newStatus] || newStatus}?`,
          {
            confirmText: 'Update Status',
            cancelText: 'Cancel',
            confirmClass: 'confirm'
          }
        );

        if (!confirmed) return;

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('new_status', newStatus);

        try {
          const response = await fetch('/seller/update-order-status', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success(`Order status updated to ${statusLabels[newStatus] || newStatus}`);
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            VaronNotifications.error('Failed to update order: ' + (data.error || data.message || 'Unknown error'));
          }
        } catch (error) {
          console.error('‚ùå Error updating order:', error);
          VaronNotifications.error('Error updating order: ' + error.message);
        }
      }

      function approveRiderForDelivery(orderId, riderId) {
        console.log('[SUCCESS] Approving rider for delivery:', orderId, 'rider:', riderId);


        fetch(`/api/rider-details/${riderId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.rider) {
              const rider = data.rider;
              const profileImage = rider.profile_image_url || '/static/images/default-avatar.jpg';


              const modal = document.createElement('div');
              modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:2000';
              modal.innerHTML = `
                <div style="background:#fff;padding:32px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.2)">
                  <button onclick="this.closest('[style*=fixed]').remove()" style="float:right;background:none;border:none;font-size:28px;cursor:pointer;color:#999">√ó</button>
                  <h2 style="margin:0 0 24px;font-size:22px;font-weight:600">Rider Details</h2>

                  <div style="background:#f9fafb;padding:24px;border-radius:12px;text-align:center;margin-bottom:24px">
                    <div style="width:100px;height:100px;border-radius:50%;margin:0 auto 16px;overflow:hidden;background:#e5e7eb;display:flex;align-items:center;justify-content:center;border:3px solid #10b981">
                      <img src="${profileImage}" alt="${rider.first_name}" style="width:100%;height:100%;object-fit:cover" onerror="this.src='/static/images/default-avatar.jpg'">
                    </div>
                    <h3 style="margin:0 0 8px;font-size:20px;font-weight:600">${rider.first_name} ${rider.last_name}</h3>
                    <p style="margin:0 0 16px;color:#6b7280;font-size:14px">Assigned delivery rider</p>

                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;padding-top:20px;border-top:1px solid #e5e7eb">
                      <div>
                        <p style="margin:0 0 4px;font-size:12px;color:#9ca3af;text-transform:uppercase;font-weight:600">Phone</p>
                        <p style="margin:0;font-size:16px;font-weight:600">${rider.phone || 'N/A'}</p>
                      </div>
                      <div>
                        <p style="margin:0 0 4px;font-size:12px;color:#9ca3af;text-transform:uppercase;font-weight:600">Rating</p>
                        <p style="margin:0;font-size:16px;font-weight:600">‚≠ê ${parseFloat(rider.rating || 0).toFixed(1)}</p>
                      </div>
                    </div>

                    <div style="margin-top:16px;padding:12px;background:#dcfce7;border-radius:8px;border-left:4px solid #10b981">
                      <p style="margin:0;color:#15803d;font-size:13px;font-weight:500">‚úì This rider is verified and ready to deliver</p>
                    </div>
                  </div>

                  <div style="display:flex;gap:12px;justify-content:flex-end">
                    <button onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:8px;cursor:pointer;font-weight:600">Cancel</button>
                    <button onclick="completeRiderApproval(${orderId}, ${riderId}); this.closest('[style*=fixed]').remove();" style="padding:12px 24px;border:none;background:#10b981;color:#fff;border-radius:8px;cursor:pointer;font-weight:600">Approve for Delivery</button>
                  </div>
                </div>
              `;
              document.body.appendChild(modal);
            } else {
              VaronNotifications.error('Error loading rider details');
            }
          })
          .catch(error => {
            console.error('Error fetching rider details:', error);
            VaronNotifications.error('Error loading rider details');
          });
      }

      function completeRiderApproval(orderId, riderId) {
        console.log('[SUCCESS] Completing rider approval:', orderId, riderId);

        const formData = new FormData();
        formData.append('order_id', orderId);
        formData.append('rider_id', riderId);

        fetch('/seller/approve-rider-for-delivery', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Rider approved for delivery! Order will be picked up for delivery.');
            loadOrders(currentOrderFilter);
            if (typeof fetchOrderCount === 'function') fetchOrderCount();
          } else {
            alert('‚ùå Failed to approve rider: ' + (data.error || data.message || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('‚ùå Error approving rider:', error);
          alert('Error: ' + error.message);
        });
      }



      function loadInventory() {
        fetch('/seller/inventory')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.inventory) {
              const inventory = data.inventory;
              displayInventory(inventory);
            } else {
              document.getElementById('inventory-list').innerHTML = '<p style="color:#999;padding:40px;">No inventory items found</p>';
            }
          })
          .catch(error => {
            document.getElementById('inventory-list').innerHTML = '<p style="color:#d32f2f;padding:40px;">Error loading inventory</p>';
          });
      }

      function displayInventory(inventory) {
        if (!inventory || inventory.length === 0) {
          document.getElementById('inventory-list').innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No products in inventory</p>';
          document.getElementById('inventory-stats').innerHTML = '';
          return;
        }

        // Group products
        const grouped = {};
        let totalProducts = 0;
        let totalStock = 0;
        let lowStockCount = 0;
        let totalVariants = 0;

        inventory.forEach(item => {
          const key = item.product_id;
          if (!grouped[key]) {
            grouped[key] = {
              product_name: item.product_name,
              price: item.price,
              image_url: item.image_url,
              variants: []
            };
            totalProducts++;
          }
          grouped[key].variants.push(item);
          totalStock += item.stock_quantity || 0;
          totalVariants++;
          if (item.stock_quantity < 10) lowStockCount++;
        });

        // Display stats
        const statsHtml = `
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white;">
            <p style="margin: 0 0 4px; font-size: 12px; opacity: 0.9;">Total Products</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700;">${totalProducts}</p>
          </div>
          <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 10px; color: white;">
            <p style="margin: 0 0 4px; font-size: 12px; opacity: 0.9;">Total Variants</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700;">${totalVariants}</p>
          </div>
          <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); padding: 20px; border-radius: 10px; color: white;">
            <p style="margin: 0 0 4px; font-size: 12px; opacity: 0.9;">Total Stock</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700;">${totalStock}</p>
          </div>
          <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); padding: 20px; border-radius: 10px; color: white;">
            <p style="margin: 0 0 4px; font-size: 12px; opacity: 0.9;">Low Stock Items</p>
            <p style="margin: 0; font-size: 28px; font-weight: 700;">${lowStockCount}</p>
          </div>
        `;
        document.getElementById('inventory-stats').innerHTML = statsHtml;

        // Start building table
        let html = `
          <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 14px 16px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Product</th>
                <th style="padding: 14px 16px; text-align: right; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Price</th>
                <th style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Variants</th>
                <th style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Total Stock</th>
                <th style="padding: 14px 16px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb;">Actions</th>
              </tr>
            </thead>
            <tbody>
        `;

        Object.entries(grouped).forEach(([productId, product]) => {
          const hasVariants = product.variants.some(v => v.size || v.color);
          const totalProductStock = product.variants.reduce((sum, v) => sum + (v.stock_quantity || 0), 0);
          const stockStatus = totalProductStock < 10 ? 'low' : totalProductStock < 30 ? 'medium' : 'good';
          const stockColor = stockStatus === 'low' ? '#ef4444' : stockStatus === 'medium' ? '#f59e0b' : '#10b981';
          const imageHtml = product.image_url 
            ? `<img src="${product.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #e0e0e0;">` 
            : `<div style="width: 50px; height: 50px; background: #f0f0f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 20px;">üì¶</div>`;

          // Main product row
          html += `
            <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
              <td style="padding: 16px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                  ${imageHtml}
                  <div>
                    <p style="margin: 0 0 4px; font-weight: 600; color: #111827;">${product.product_name}</p>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">${product.variants.length} variant${product.variants.length > 1 ? 's' : ''}</p>
                  </div>
                </div>
              </td>
              <td style="padding: 16px; text-align: right; font-weight: 600; color: #111827;">‚Ç±${parseFloat(product.price || 0).toFixed(2)}</td>
              <td style="padding: 16px; text-align: center;">
                <span style="background: #f3f4f6; color: #374151; padding: 4px 12px; border-radius: 12px; font-weight: 600; font-size: 12px;">
                  ${product.variants.length}
                </span>
              </td>
              <td style="padding: 16px; text-align: center;">
                <span style="background: ${stockColor}15; color: ${stockColor}; padding: 6px 12px; border-radius: 12px; font-weight: 700; font-size: 13px;">
                  ${totalProductStock}
                </span>
              </td>
              <td style="padding: 16px; text-align: center;">
                <button onclick="toggleVariants('${productId}')" style="background: #0a0a0a; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: all 0.2s;">
                  üìã View Details
                </button>
              </td>
            </tr>
            <tr id="variants-${productId}" style="display: none; background: #fafafa;">
              <td colspan="5" style="padding: 0;">
                <div style="padding: 24px; border-top: 2px solid #e5e7eb;">
                  <h4 style="margin: 0 0 16px; font-size: 15px; font-weight: 600; color: #111827; display: flex; align-items: center; gap: 8px;">
                    <span style="background: #0a0a0a; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px;">üì¶</span>
                    Variant Stock Details
                  </h4>
                  <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px;">
                    ${product.variants.map(variant => {
                      const variantStock = variant.stock_quantity || 0;
                      const variantStatus = variantStock < 5 ? 'critical' : variantStock < 15 ? 'low' : 'good';
                      const variantColor = variantStatus === 'critical' ? '#dc2626' : variantStatus === 'low' ? '#ea580c' : '#059669';
                      
                      return `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                              <p style="margin: 0 0 4px; font-size: 13px; color: #6b7280; font-weight: 600;">Size</p>
                              <p style="margin: 0; font-size: 15px; font-weight: 700; color: #111827;">${variant.size || 'One Size'}</p>
                            </div>
                            <div style="text-align: right;">
                              <p style="margin: 0 0 4px; font-size: 13px; color: #6b7280; font-weight: 600;">Color</p>
                              <p style="margin: 0; font-size: 15px; font-weight: 700; color: #111827;">${variant.color || 'Standard'}</p>
                            </div>
                          </div>
                          
                          <div style="background: ${variantColor}08; border: 2px solid ${variantColor}; border-radius: 8px; padding: 14px; margin-bottom: 12px;">
                            <p style="margin: 0 0 4px; font-size: 11px; color: ${variantColor}; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Current Stock</p>
                            <p style="margin: 0; font-size: 26px; font-weight: 700; color: ${variantColor};">${variantStock}</p>
                            ${variantStatus === 'critical' ? '<p style="margin: 4px 0 0; font-size: 11px; color: #dc2626; font-weight: 600;">‚ö†Ô∏è Critical Low!</p>' : ''}
                            ${variantStatus === 'low' ? '<p style="margin: 4px 0 0; font-size: 11px; color: #ea580c; font-weight: 600;">‚ö† Running Low</p>' : ''}
                          </div>
                          
                          <button class="restock-btn" 
                            data-product-id="${variant.product_id}" 
                            data-variant-id="${variant.variant_id_full}" 
                            data-product-name="${product.product_name}" 
                            data-size="${variant.size || 'One Size'}" 
                            data-color="${variant.color || 'N/A'}" 
                            data-stock="${variantStock}" 
                            style="width: 100%; padding: 10px; background: #0a0a0a; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s;">
                            ‚ûï Restock
                          </button>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </div>
              </td>
            </tr>
          `;
        });

        html += `
            </tbody>
          </table>
        `;

        document.getElementById('inventory-list').innerHTML = html;

        // Setup search functionality
        setupInventorySearch();

        console.log('Attaching event listeners to .restock-btn elements');
        setTimeout(() => {
          const buttons = document.querySelectorAll('.restock-btn');
          console.log(`Found ${buttons.length} restock buttons`);
          buttons.forEach((btn, index) => {
            console.log(`Attaching listener to button ${index}:`, btn.dataset);
            btn.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              const productId = this.dataset.productId;
              const variantId = this.dataset.variantId;
              const productName = this.dataset.productName;
              const size = this.dataset.size;
              const color = this.dataset.color;
              const stock = this.dataset.stock;

              console.log('[ACTION] Restock button clicked:', { productId, variantId, productName, size, color, stock });
              openVariantRestockModal(productId, variantId, productName, size, color, stock);
            });
          });
        }, 100);
      }

      // Toggle variant details visibility
      function toggleVariants(productId) {
        const row = document.getElementById(`variants-${productId}`);
        if (row) {
          if (row.style.display === 'none') {
            row.style.display = 'table-row';
          } else {
            row.style.display = 'none';
          }
        }
      }

      // Setup inventory search
      function setupInventorySearch() {
        const searchInput = document.getElementById('inventory-search');
        if (searchInput) {
          searchInput.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr[onmouseover]');
            
            rows.forEach((row) => {
              const productNameElement = row.querySelector('td:first-child p');
              const productName = productNameElement ? productNameElement.textContent.toLowerCase() : '';
              
              if (productName.includes(searchTerm)) {
                row.style.display = '';
                // Also show the variant details row if it exists
                const variantRow = row.nextElementSibling;
                if (variantRow && variantRow.id && variantRow.id.startsWith('variants-')) {
                  // Keep it in DOM but respect its current state
                }
              } else {
                row.style.display = 'none';
                // Hide variant details row
                const variantRow = row.nextElementSibling;
                if (variantRow && variantRow.id && variantRow.id.startsWith('variants-')) {
                  variantRow.style.display = 'none';
                }
              }
            });
          });
        }
      }

      function openVariantRestockModal(productId, variantId, productName, size, color, currentStock) {
        console.log('üîß openVariantRestockModal called with:', { productId, variantId, productName, size, color, currentStock });
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1000;';

        modal.innerHTML = `
          <div style="background:#fff; padding:32px; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.3); max-width:500px; width:90%;">
            <button onclick="this.closest('[style*=fixed]').remove()" style="float:right; background:none; border:none; font-size:24px; cursor:pointer; color:#999;">√ó</button>

            <h2 style="margin:0 0 24px; font-size:22px; font-weight:600; color:#0a0a0a;">üì¶ Restock: ${size} - ${color}</h2>

            
            <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #0a0a0a;">
              <p style="margin:0 0 8px; font-size:12px; color:#6b7280; font-weight:600; text-transform:uppercase;">Product</p>
              <p style="margin:4px 0; font-size:14px; font-weight:600; color:#0a0a0a;">${productName}</p>
            </div>

            
            <div style="background:#f0f9ff; padding:16px; border-radius:8px; margin-bottom:20px; border-left:4px solid #3b82f6;">
              <p style="margin:0 0 8px; font-size:12px; color:#0c4a6e; font-weight:600;">Current Stock: <strong>${currentStock} pcs</strong></p>
            </div>

            
            <div style="margin-bottom:20px;">
              <label style="display:block; margin-bottom:8px; font-weight:600; font-size:14px; color:#0a0a0a;">Add Quantity (pcs)</label>
              <input type="number" id="restock-quantity" min="1" value="10" style="width:100%; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; box-sizing:border-box;">
            </div>

            
            <div style="display:flex; gap:12px; justify-content:flex-end;">
              <button id="restock-cancel-btn" onclick="this.closest('[style*=fixed]').remove()" style="padding:12px 24px; border:1px solid #e5e7eb; background:#f6f6f6; color:#0a0a0a; border-radius:8px; cursor:pointer; font-weight:600;">Cancel</button>
              <button id="restock-submit-btn" style="padding:12px 24px; border:none; background:#0a0a0a; color:#fff; border-radius:8px; cursor:pointer; font-weight:600;">‚úì Restock</button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
        console.log('[SUCCESS] Modal appended to body');


        document.getElementById('restock-submit-btn').addEventListener('click', function() {
          submitVariantRestock(productId, variantId);
        });

        document.getElementById('restock-quantity').focus();
      }

      function submitVariantRestock(productId, variantId) {
        console.log('Submitting restock:', { productId, variantId });

        const quantity = parseInt(document.getElementById('restock-quantity').value);

        if (!quantity || quantity <= 0) {
          VaronNotifications.warning('Please enter a valid quantity');
          return;
        }

        if (!productId) {
          VaronNotifications.error('Error: Product ID missing');
          return;
        }

        const submitBtn = document.getElementById('restock-submit-btn');
        const cancelBtn = document.getElementById('restock-cancel-btn');
        
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Processing...';
        if (cancelBtn) cancelBtn.disabled = true;

        const formData = new FormData();
        formData.append('product_id', productId);
        if (variantId) {
          formData.append('variant_id', variantId);
        }
        formData.append('quantity', quantity);

        console.log('FormData entries:');
        for (let [key, value] of formData.entries()) {
          console.log(`  ${key}: ${value}`);
        }

        fetch('/seller/restock', {
          method: 'POST',
          body: formData
        })
          .then(response => {
            console.log('Response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Response data:', data);
            
            if (data.success) {
              // Reset button state first
              submitBtn.disabled = false;
              submitBtn.textContent = '‚úÖ Success!';
              if (cancelBtn) cancelBtn.disabled = false;
              
              // Show success notification
              VaronNotifications.success(`Restocked! Added: ${quantity} pcs. New Stock: ${data.new_stock} pcs`);
              
              // Close modal after a delay to show success feedback
              setTimeout(() => {
                const modal = document.querySelector('[style*="position:fixed"]');
                if (modal) modal.remove();
                // Reload inventory after modal is closed
                loadInventory();
              }, 800);
            } else {
              VaronNotifications.error('Failed: ' + (data.error || 'Unknown error'));
              // Reset button state on failure
              submitBtn.disabled = false;
              submitBtn.textContent = '‚úì Restock';
              if (cancelBtn) cancelBtn.disabled = false;
            }
          })
          .catch(error => {
            console.error('Fetch error:', error);
            VaronNotifications.error('Error: ' + error.message);
            
            // Reset button state on error - only if elements still exist
            const currentSubmitBtn = document.getElementById('restock-submit-btn');
            const currentCancelBtn = document.getElementById('restock-cancel-btn');
            
            if (currentSubmitBtn) {
              currentSubmitBtn.disabled = false;
              currentSubmitBtn.textContent = '‚úì Restock';
            }
            if (currentCancelBtn) {
              currentCancelBtn.disabled = false;
            }
          });
      }


      function loadReviews(filter = 'all') {
        fetch('/seller/reviews')
          .then(response => response.json())
          .then(data => {
            if (data.success && data.reviews) {
              let reviews = data.reviews;

              if (filter === 'pending') {
                reviews = reviews.filter(r => !r.is_approved);
              }

              displayReviews(reviews);
            } else {
              document.getElementById('reviews-list').innerHTML = '<p style="color:#999;padding:40px;">No reviews found</p>';
            }
          })
          .catch(error => {
            document.getElementById('reviews-list').innerHTML = '<p style="color:#d32f2f;padding:40px;">Error loading reviews</p>';
          });
      }

      function displayReviews(reviews) {
        if (!reviews || reviews.length === 0) {
          document.getElementById('reviews-list').innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No reviews to display</p>';
          return;
        }

        let html = `<div style="display: grid; gap: 16px;">`;

        reviews.forEach(review => {
          const stars = '‚≠ê'.repeat(review.rating);
          const approvalBadge = review.is_approved ?
            '<span class="status-badge status-active">Approved</span>' :
            '<span class="status-badge status-pending">Pending</span>';

          html += `
            <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div>
                  <strong style="font-size: 14px;">${review.product_name}</strong>
                  <p style="margin: 4px 0 0; color: #666; font-size: 13px;">by ${review.buyer_name}</p>
                </div>
                ${approvalBadge}
              </div>
              <div style="margin-bottom: 8px; font-size: 14px;">${stars}</div>
              <p style="margin: 0 0 12px; font-size: 14px; line-height: 1.5;">${review.comment}</p>
              <div style="display: flex; gap: 8px; font-size: 12px; color: #999;">
                <span>${formatPHDate(review.created_at)}</span>
              </div>
              ${!review.is_approved ? `
                <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #e0e0e0;">
                  <button class="action-btn" onclick="approveReview(${review.id})" style="flex: 1; background: #10b981; color: #fff; padding: 8px 12px; font-size: 13px;">‚úì Approve</button>
                  <button class="action-btn" onclick="rejectReview(${review.id})" style="flex: 1; background: #ef4444; color: #fff; padding: 8px 12px; font-size: 13px;">‚úó Reject</button>
                </div>
              ` : ''}
            </div>
          `;
        });

        html += `</div>`;
        document.getElementById('reviews-list').innerHTML = html;
      }

      function filterReviews(filter) {
        document.querySelectorAll('[data-review-filter]').forEach(btn => btn.style.background = '#666');
        document.querySelector(`[data-review-filter="${filter}"]`).style.background = '#0a0a0a';
        loadReviews(filter);
      }

      function approveReview(reviewId) {
        fetch(`/seller/review/${reviewId}/approve`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Review approved');
              loadReviews();
            } else {
              alert('Error: ' + (data.error || 'Unknown error'));
            }
          });
      }

      function rejectReview(reviewId) {
        fetch(`/seller/review/${reviewId}/reject`, { method: 'POST' })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Review rejected');
              loadReviews();
            } else {
              alert('Error: ' + (data.error || 'Unknown error'));
            }
          });
      }

      // Notifications Functions
      function loadNotifications() {
        console.log('[NOTIFICATIONS] Loading notifications...');
        fetch('/api/seller/notifications')
          .then(response => {
            console.log('[NOTIFICATIONS] Response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('[NOTIFICATIONS] Data received:', data);
            if (data.success) {
              displayNotifications(data.notifications || []);
            } else {
              console.error('[NOTIFICATIONS] Failed:', data.error);
              document.getElementById('notifications-list').innerHTML = `<p style="color:#ef4444;padding:40px;text-align:center;">Failed to load notifications: ${data.error || 'Unknown error'}</p>`;
            }
          })
          .catch(error => {
            console.error('[NOTIFICATIONS] Error loading notifications:', error);
            document.getElementById('notifications-list').innerHTML = '<p style="color:#d32f2f;padding:40px;text-align:center;">Error loading notifications. Please check console.</p>';
          });
      }

      function displayNotifications(notifications) {
        const container = document.getElementById('notifications-list');
        
        if (!notifications || notifications.length === 0) {
          container.innerHTML = '<p style="color:#999;padding:40px;text-align:center;">No notifications yet</p>';
          return;
        }

        let html = '';
        notifications.forEach(notif => {
          const isRead = notif.is_read;
          const bgColor = isRead ? '#f9f9f9' : '#fff9e6';
          const borderColor = notif.notification_type === 'product_approved' ? '#10b981' : '#ef4444';
          const icon = notif.notification_type === 'product_approved' ? '‚úÖ' : '‚ùå';
          const title = notif.notification_type === 'product_approved' ? 'Product Approved' : 'Product Rejected';
          
          html += `
            <div style="background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px; padding: 16px; display: flex; gap: 12px;">
              <div style="font-size: 24px;">${icon}</div>
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <strong style="font-size: 14px;">${title}</strong>
                  <span style="font-size: 11px; color: #999;">${formatPHDateTime(notif.created_at)}</span>
                </div>
                <p style="margin: 0 0 8px; font-size: 13px; color: #666;">${notif.message}</p>
                ${!isRead ? `<button class="action-btn" onclick="markNotificationRead(${notif.id})" style="background: #2196f3; padding: 6px 12px; font-size: 12px;">Mark as Read</button>` : ''}
              </div>
            </div>
          `;
        });

        container.innerHTML = html;
      }

      function markNotificationRead(notifId) {
        fetch(`/api/seller/notifications/${notifId}/read`, {
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadNotifications();
            }
          })
          .catch(error => console.error('Error marking notification as read:', error));
      }

      function markAllNotificationsRead() {
        fetch('/api/seller/notifications/mark-all-read', {
          method: 'POST'
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              loadNotifications();
            }
          })
          .catch(error => console.error('Error marking all notifications as read:', error));
      }


      function loadCategories() {
        const categorySelect = document.getElementById('categorySelect');
        if (!categorySelect) return;

        console.log('[INIT] Loading categories...');
        fetch('/api/categories')
          .then(response => response.json())
          .then(data => {
            console.log('[SUCCESS] Categories loaded:', data);
            if (data.success && data.categories) {
              categorySelect.innerHTML = '<option value="">Select a category</option>';
              
              // Iterate through parent categories
              data.categories.forEach(parentCategory => {
                // Create optgroup for parent category with custom styling
                const optgroup = document.createElement('optgroup');
                optgroup.label = parentCategory.name;
                optgroup.style.fontWeight = 'bold';
                optgroup.style.fontSize = '15px';
                
                // Add parent category as selectable option with styling
                const parentOption = document.createElement('option');
                parentOption.value = parentCategory.id;
                parentOption.textContent = `‚ñ∫ ${parentCategory.name} (Main Category)`;
                parentOption.dataset.slug = parentCategory.slug;
                parentOption.style.fontWeight = 'bold';
                parentOption.style.fontSize = '14px';
                parentOption.style.color = '#0a0a0a';
                optgroup.appendChild(parentOption);
                
                // Add child categories as regular options
                if (parentCategory.children && parentCategory.children.length > 0) {
                  parentCategory.children.forEach(child => {
                    const childOption = document.createElement('option');
                    childOption.value = child.id;
                    childOption.textContent = `   ‚îî‚îÄ ${child.name}`;
                    childOption.dataset.slug = child.slug;
                    childOption.dataset.parent = parentCategory.id;
                    optgroup.appendChild(childOption);
                  });
                }
                
                categorySelect.appendChild(optgroup);
              });
              console.log('[SUCCESS] All categories loaded into dropdown');
            } else {
              console.warn('[ERROR] Invalid categories response:', data);
            }
          })
          .catch(error => {
            console.error('[ERROR] Failed to load categories:', error);
            categorySelect.innerHTML = '<option value="">Error loading categories - ' + error.message + '</option>';
          });
      }

      function loadSalesAnalytics() {
        fetch('/seller/sales-analytics')
          .then(response => response.json())
          .then(data => {
            if (data.success) {

              const revenue = data.analytics.total_revenue || 0;
              const orders = data.analytics.total_orders || 0;
              const avgOrder = data.analytics.avg_order_value || 0;

              document.getElementById('total-revenue').textContent = '‚Ç±' + parseFloat(revenue).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              document.getElementById('total-orders').textContent = orders;
              document.getElementById('avg-order').textContent = '‚Ç±' + parseFloat(avgOrder).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });


              displaySalesByProduct(data.analytics.top_products || []);
            }
          })
          .catch(error => {
            console.error('Error loading sales analytics:', error);
            document.getElementById('sales-by-product').innerHTML = '<p style="color:#ef4444;">Error loading analytics</p>';
          });
      }

      function displaySalesByProduct(products) {
        if (!products || products.length === 0) {
          document.getElementById('sales-by-product').innerHTML = '<p style="color:#999;text-align:center;">No sales data available</p>';
          return;
        }

        let html = `<table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="background: #f3f4f6;">
              <th style="padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb;">Product Name</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">Quantity</th>
              <th style="padding: 10px; text-align: right; border-bottom: 1px solid #e5e7eb;">Revenue</th>
            </tr>
          </thead>
          <tbody>`;

        products.forEach((product, index) => {
          html += `<tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 10px;">${product.product_name}</td>
            <td style="padding: 10px; text-align: right;">${product.quantity_sold}</td>
            <td style="padding: 10px; text-align: right;">‚Ç±${parseFloat(product.product_revenue).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
          </tr>`;
        });

        html += `</tbody></table>`;
        document.getElementById('sales-by-product').innerHTML = html;
      }

      function loadPerformance() {
        fetch('/seller/performance')
          .then(response => response.json())
          .then(data => {
            if (data.success) {

              const avgRating = data.performance.avg_rating || 0;
              const repeatCustomers = data.performance.repeat_customers || 0;
              const totalReviews = data.performance.total_reviews || 0;

              document.getElementById('avg-rating').textContent = parseFloat(avgRating).toFixed(1) + ' ‚≠ê';
              document.getElementById('repeat-customers').textContent = repeatCustomers;
              document.getElementById('total-reviews').textContent = totalReviews;


              displayTopRatedProducts(data.performance.top_rated_products || []);
            }
          })
          .catch(error => {
            console.error('Error loading performance:', error);
            document.getElementById('top-rated-products').innerHTML = '<p style="color:#ef4444;">Error loading performance</p>';
          });
      }

      function displayTopRatedProducts(products) {
        if (!products || products.length === 0) {
          document.getElementById('top-rated-products').innerHTML = '<p style="color:#999;text-align:center;">No rated products available</p>';
          return;
        }

        let html = ``;
        products.forEach(product => {
          const stars = Array(Math.round(product.avg_rating)).fill('‚≠ê').join('');
          html += `
            <div style="background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                <div>
                  <strong style="font-size: 13px; display: block;">${product.product_name}</strong>
                  <small style="color: #666; display: block;">${product.review_count} reviews</small>
                </div>
                <span style="font-size: 14px; font-weight: 700; color: #f59e0b;">${parseFloat(product.avg_rating).toFixed(1)}</span>
              </div>
              <div style="color: #666; font-size: 12px;">${stars}</div>
            </div>
          `;
        });

        document.getElementById('top-rated-products').innerHTML = html;
      }

      function loadAccountSettings(options = {}) {
        const { force = false } = options;

        return fetch('/seller/account-settings')
          .then(response => {
            console.log('Account settings response status:', response.status);
            return response.json();
          })
          .then(data => {
            console.log('Account settings data:', data);
            if (!data.success) {
              console.error('Account settings error:', data.error);
              return false;
            }

            const brand = data.brand || {};
            const account = data.account || {};

            const brandName = brand.store_name || account.username || account.full_name || '';
            const contactEmail = brand.contact_email || account.email || '';
            const contactPhone = brand.contact_phone || account.phone_number || '';
            const brandDescription = brand.description || '';
            const storeAddress = brand.address || '';
            const islandGroupRaw = (brand.island_group || '').trim();
            const islandGroupValue = VALID_ISLAND_GROUPS.includes(islandGroupRaw) ? islandGroupRaw : 'Luzon';

            setAccountSettingsFieldValue('store-name', brandName, { force });
            setAccountSettingsFieldValue('store-description', brandDescription, { force });
            setAccountSettingsFieldValue('contact-email', contactEmail, { force });
            setAccountSettingsFieldValue('contact-phone', contactPhone, { force });
            setAccountSettingsFieldValue('store-address', storeAddress, { force });
            setAccountSettingsFieldValue('island-group', islandGroupValue, { force });

            return true;
          })
          .catch(error => {
            console.error('Error loading account settings:', error);
            return false;
          });
      }

      async function reloadAccountSettings() {
        resetAccountSettingsDirtyFlags();
        const refreshed = await loadAccountSettings({ force: true });
        if (refreshed) {
          alert('‚úÖ Account data refreshed!');
        } else {
          alert('‚ùå Unable to refresh account data. Please try again.');
        }
      }

      function setupProfileSettingsForm() {
        const profileSettingsForm = document.getElementById('profile-settings-form');
        if (!profileSettingsForm) {
          console.log('[PROFILE FORM] Not present on current page.');
          return;
        }

        initializeAccountSettingsFieldGuards();

        if (profileSettingsForm.dataset.bound === 'true') {
          return;
        }

        profileSettingsForm.addEventListener('submit', async (event) => {
          event.preventDefault();

          const submitBtn = profileSettingsForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';
          }

          try {
            const formData = new FormData(profileSettingsForm);
            const response = await fetch('/seller/account-settings', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();

            if (data.success) {
              alert('‚úÖ Profile settings saved successfully!');
              await loadAccountSettings({ force: true });
            } else {
              alert('‚ùå Error: ' + (data.error || 'Unknown error'));
            }
          } catch (error) {
            alert('‚ùå Error saving profile settings: ' + error.message);
          } finally {
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'üíæ Save All Settings';
            }
          }
        });

        profileSettingsForm.dataset.bound = 'true';
        console.log('‚úÖ Profile settings form listener set up');
      }

      function focusAccountSettingsSection(section) {
        const target = document.getElementById('brand-settings-section');
        if (!target) return;

        target.classList.add('section-focus-highlight');
        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        setTimeout(() => target.classList.remove('section-focus-highlight'), 1600);
      }

      async function deletePromotion(promoId) {
        const confirmed = await VaronNotifications.confirm('Are you sure you want to delete this promotion?', {
          confirmText: 'Delete Promotion',
          cancelText: 'Keep',
          confirmClass: 'danger'
        });

        if (!confirmed) return;

        try {
          const response = await fetch(`/seller/promotion/${promoId}/delete`, { method: 'POST' });
          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Promotion deleted');
            loadPromotions();
          } else {
            VaronNotifications.error('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          VaronNotifications.error('Error deleting promotion: ' + error.message);
        }
      }

      function normalizeProductArray(rawProducts) {
        if (!rawProducts) {
          return [];
        }

        if (Array.isArray(rawProducts)) {
          return rawProducts;
        }

        if (typeof rawProducts === 'object') {
          return Object.values(rawProducts);
        }

        return [];
      }

      function renderProductStatusCards(stats = {}) {
        const buildCard = (key, label, count, icon, options = {}) => {
          const { filterKey, countId } = options;
          return `
            <div class="status-summary-card status-card-${key}" role="button" tabindex="0" data-status="${filterKey}" aria-pressed="false" onclick="filterProductsByStatus('${filterKey}')" onkeydown="handleStatusCardKey(event, '${filterKey}')">
              <span class="status-card-icon" aria-hidden="true">${icon}</span>
              <div class="status-card-body">
                <span class="status-card-label">${label}</span>
                <span class="status-card-count"${countId ? ` id="${countId}"` : ''}>${count}</span>
              </div>
            </div>
          `;
        };

        return `
          <div class="status-summary-grid" role="group" aria-label="Product status summary">
            ${buildCard('approved', 'Approved', stats.approved || 0, '‚úì', { filterKey: 'approved', countId: 'approved-count' })}
            ${buildCard('pending', 'Pending Approval', stats.pending || 0, '‚è≥', { filterKey: 'pending', countId: 'pending-count' })}
            ${buildCard('rejected', 'Rejected', stats.rejected || 0, '‚ö†Ô∏è', { filterKey: 'rejected', countId: 'rejected-count' })}
            ${buildCard('total', 'Total Products', stats.total || 0, 'üì¶', { filterKey: 'all', countId: 'total-products-count' })}
          </div>
        `;
      }

      function renderProductsTableShell(stats = {}) {
        return `
          ${renderProductStatusCards(stats)}
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f3f4f6;">
                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Product Name</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Price</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Stock</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Status</th>
                <th style="padding: 12px; text-align: left; border: 1px solid #e5e7eb; font-weight: 600;">Actions</th>
              </tr>
            </thead>
            <tbody id="products-table-body">
              <tr>
                <td colspan="5" style="padding: 24px; text-align: center; color: #6b7280;">Preparing product list...</td>
              </tr>
            </tbody>
          </table>
        `;
      }

      function configureSectionSearchField({ inputId, enabled, value, handler }) {
        const searchInput = document.getElementById(inputId);
        if (!searchInput) {
          return null;
        }

        const events = ['input', 'search'];
        events.forEach(eventName => {
          searchInput.removeEventListener(eventName, handler);
        });

        if (!enabled) {
          searchInput.value = '';
          searchInput.setAttribute('disabled', 'disabled');
          return searchInput;
        }

        searchInput.removeAttribute('disabled');
        searchInput.value = value || '';
        events.forEach(eventName => {
          searchInput.addEventListener(eventName, handler);
        });

        return searchInput;
      }

      function initializeProductSearchField(hasProducts = false) {
        configureSectionSearchField({
          inputId: 'product-search-input',
          enabled: hasProducts,
          value: currentProductSearchTerm,
          handler: handleProductSearchInput
        });
      }

      function handleProductSearchInput(event) {
        currentProductSearchTerm = (event.target.value || '').trim();
        renderProductsTable(currentProductStatusFilter);
      }

      function initializeArchivedSearchField(hasProducts = false) {
        configureSectionSearchField({
          inputId: 'archived-search-input',
          enabled: hasProducts,
          value: currentArchivedSearchTerm,
          handler: handleArchivedSearchInput
        });
      }

      function handleArchivedSearchInput(event) {
        currentArchivedSearchTerm = (event.target.value || '').trim();
        renderArchivedProductsTable();
      }

      function renderArchivedProductsTable() {
        const container = document.getElementById('archived-products-list');
        if (!container) {
          return;
        }

        if (!archivedProductsCache || archivedProductsCache.length === 0) {
          container.innerHTML = '<p style="text-align:center;color:#999;padding:24px;">No archived products</p>';
          return;
        }

        const normalizedSearchTerm = (currentArchivedSearchTerm || '').toLowerCase();
        let filteredProducts = archivedProductsCache.slice();

        if (normalizedSearchTerm) {
          filteredProducts = filteredProducts.filter(product => {
            const searchableFields = [
              product.name || '',
              product.category_name || '',
              product.archive_status || '',
              product.archived_at ? formatPHDate(product.archived_at) : '',
              typeof product.price !== 'undefined' ? String(product.price) : ''
            ].map(value => (value || '').toString().toLowerCase());

            return searchableFields.some(value => value.includes(normalizedSearchTerm));
          });
        }

        if (filteredProducts.length === 0) {
          const sanitizedTerm = escapeHtml(currentArchivedSearchTerm || '');
          container.innerHTML = `<p style="text-align:center;color:#999;padding:24px;">No archived products match "${sanitizedTerm}".</p>`;
          return;
        }

        const rowsHtml = filteredProducts.map(getArchivedProductRowHtml).join('');
        container.innerHTML = `
          <div class="table-scroll">
            <table style="width:100%; border-collapse: collapse;">
              <thead>
                <tr style="background:#f3f4f6;">
                  <th style="padding:12px; text-align:left; border:1px solid #e5e7eb; font-weight:600;">Product</th>
                  <th style="padding:12px; text-align:left; border:1px solid #e5e7eb; font-weight:600;">Price</th>
                  <th style="padding:12px; text-align:left; border:1px solid #e5e7eb; font-weight:600;">Archived</th>
                  <th style="padding:12px; text-align:left; border:1px solid #e5e7eb; font-weight:600;">Status</th>
                  <th style="padding:12px; text-align:left; border:1px solid #e5e7eb; font-weight:600;">Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        `;
      }

      function getArchivedProductRowHtml(product) {
        const safeName = escapeHtml(product.name || 'Untitled Product');
        const sanitizedNameForAction = (product.name || '').replace(/'/g, "\\'");
        const priceNumber = Number(product.price);
        const priceDisplay = Number.isFinite(priceNumber) ? priceNumber.toFixed(2) : '0.00';
        const archivedDate = product.archived_at ? formatPHDate(product.archived_at) : '‚Äî';
        const statusIsRecovery = (product.archive_status || '').toLowerCase() === 'pending_recovery';
        const statusText = statusIsRecovery ? 'Recovery Pending' : 'Archived';
        const statusClass = statusIsRecovery ? 'status-pending' : 'status-inactive';
        const actionContent = statusIsRecovery
          ? '<span style="color: #f59e0b; font-size: 12px;">‚è≥ Awaiting admin approval</span>'
          : `<button class="action-btn" onclick="requestRecovery(${product.id}, '${sanitizedNameForAction}')" style="padding: 6px 12px; font-size: 12px; background: #10b981;">Request Recovery</button>`;

        return `
          <tr style="border-bottom:1px solid #e5e7eb;">
            <td style="padding:12px; border:1px solid #e5e7eb; font-weight:600; color:#0a0a0a;">
              ${safeName}
              ${product.category_name ? `<div style="font-size:12px;color:#6b7280;margin-top:2px;">${escapeHtml(product.category_name)}</div>` : ''}
            </td>
            <td style="padding:12px; border:1px solid #e5e7eb;">‚Ç±${priceDisplay}</td>
            <td style="padding:12px; border:1px solid #e5e7eb; font-size:13px; color:var(--muted);">${archivedDate}</td>
            <td style="padding:12px; border:1px solid #e5e7eb;">
              <span class="status-badge ${statusClass}">${statusText}</span>
            </td>
            <td style="padding:12px; border:1px solid #e5e7eb;">
              ${actionContent}
            </td>
          </tr>
        `;
      }

      function loadProducts() {
        console.log('[FETCH] Loading products...');
        const container = document.getElementById('products-list');

        if (!container) {
          console.error('[ERROR] products-list container not found');
          return;
        }

        currentProductSearchTerm = '';
        initializeProductSearchField(false);

        fetch('/seller/products', { credentials: 'include' })
          .then(response => {
            console.log('[RESPONSE] Products response status:', response.status);
            if (!response.ok) {
              throw new Error('HTTP ' + response.status + ': ' + response.statusText);
            }
            return response.json();
          })
          .then(data => {
            console.log('[DATA] Products received:', data);

            if (data.error) {
              container.innerHTML = `<p style="color:#ef4444; text-align: center; padding: 20px; font-weight: bold;">Error: ${data.error}</p>`;
              return;
            }

            sellerProductsCache = normalizeProductArray(data.products);

            if (sellerProductsCache.length > 0) {
              const stats = data.stats || {};
              currentProductStatusFilter = 'all';
              initializeProductSearchField(true);

              container.innerHTML = renderProductsTableShell(stats);

              // Defer rendering to ensure the table body exists in the DOM
              requestAnimationFrame(() => {
                renderProductsTable(currentProductStatusFilter);
                updateStatusCardActiveStates();
              });
            } else {
              initializeProductSearchField(false);
              document.getElementById('products-list').innerHTML = '<div style="text-align:center;color:#999;padding:40px;"><p style="font-size:16px; margin-bottom: 16px;">No products yet</p><p>Click the "+ Add Product" button to add your first product</p></div>';
            }
          })
          .catch(error => {
            console.error('[ERROR] Error loading products:', error);
            const container = document.getElementById('products-list');
            if (container) {
              container.innerHTML = '<div style="color:#ef4444; text-align: center; padding: 20px;"><strong>Failed to load products</strong><br><small>' + error.message + '</small></div>';
            }
            initializeProductSearchField(false);
          });
      }

      function filterProductsByStatus(status = 'all') {
        currentProductStatusFilter = (status || 'all').toLowerCase();
        renderProductsTable(currentProductStatusFilter);
        updateStatusCardActiveStates();
      }

      function renderProductsTable(statusFilter = 'all') {
        const tbody = document.getElementById('products-table-body');
        if (!tbody) {
          return;
        }

        const normalizedStatus = (statusFilter || 'all').toLowerCase();
        let filteredProducts = sellerProductsCache.filter(product => {
          const approvalStatus = (product.approval_status || 'approved').toLowerCase();
          if (normalizedStatus === 'all') {
            return true;
          }
          return approvalStatus === normalizedStatus;
        });

        const normalizedSearchTerm = (currentProductSearchTerm || '').toLowerCase();
        const sanitizedSearchTerm = escapeHtml(currentProductSearchTerm || '');
        if (normalizedSearchTerm) {
          filteredProducts = filteredProducts.filter(product => {
            const name = (product.name || '').toLowerCase();
            const category = (product.category_name || '').toLowerCase();
            const status = (product.approval_status || '').toLowerCase();
            return name.includes(normalizedSearchTerm) ||
              category.includes(normalizedSearchTerm) ||
              status.includes(normalizedSearchTerm);
          });
        }

        if (filteredProducts.length === 0) {
          const emptyMessage = normalizedSearchTerm
            ? `No products match "${sanitizedSearchTerm}".`
            : 'No products found for this status.';
          tbody.innerHTML = `<tr><td colspan="5" style="padding: 32px; text-align: center; color: #6b7280;">${emptyMessage}</td></tr>`;
          return;
        }

        tbody.innerHTML = filteredProducts.map(product => getProductRowHtml(product)).join('');
      }

      function getProductRowHtml(product) {
        let statusText = '';
        let statusClass = '';
        let statusIcon = '';
        const approvalStatus = (product.approval_status || 'approved').toLowerCase();

        if (approvalStatus === 'approved') {
          statusText = 'Approved ‚úì';
          statusClass = 'status-active';
          statusIcon = '‚úì';
        } else if (approvalStatus === 'pending') {
          statusText = 'Pending Review';
          statusClass = 'status-pending';
          statusIcon = '‚è≥';
        } else if (approvalStatus === 'rejected') {
          statusText = 'Rejected ‚ùå';
          statusClass = 'status-inactive';
          statusIcon = '‚ùå';
        }

        if (product.edit_status === 'pending' && product.pending_edits > 0) {
          statusText = `Edit Pending (${product.pending_edits})`;
          statusClass = 'status-pending';
          statusIcon = '‚è≥';
        }

        const safeName = escapeHtml(product.name || 'Untitled Product');
        const category = product.category_name ? `<div style="font-size: 12px; color: #777; margin-top: 2px;">${product.category_name}</div>` : '';
        const priceNumber = Number(product.price);
        const priceValue = Number.isFinite(priceNumber) ? priceNumber.toFixed(2) : '0.00';
        const stockNumber = Number(product.stock);
        const hasStockValue = Number.isFinite(stockNumber);
        const stockDisplay = hasStockValue ? `${stockNumber} pcs` : '‚Äî';
        const lowStockLabel = hasStockValue && stockNumber < 5
          ? '<div style="font-size: 11px; color: #ef4444; margin-top: 2px;">‚ö† Low stock</div>'
          : '';
        const sanitizedNameForAction = (product.name || '').replace(/'/g, "\\'");

        let actionContent = '';
        if (approvalStatus === 'approved') {
          actionContent = `
            <button class="action-btn" onclick="editProduct(${product.id})" style="padding: 6px 12px; font-size: 12px;">Edit</button>
            <button class="action-btn" onclick="archiveProduct(${product.id}, '${sanitizedNameForAction}')" style="padding: 6px 12px; font-size: 12px; background: #ef4444;">Archive</button>
          `;
        } else if (approvalStatus === 'rejected') {
          actionContent = '<span style="color: #999; font-size: 12px;">Rejected</span>';
        } else {
          actionContent = '<span style="color: #999; font-size: 12px;">‚è≥ Awaiting approval</span>';
        }

        return `
          <tr style="border-bottom: 1px solid #e5e7eb; transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9fafb';" onmouseout="this.style.backgroundColor='';">
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              <div style="font-weight: 600; color: #0a0a0a;">${safeName}</div>
              ${category}
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb; font-weight: 600; color: #0a0a0a;">‚Ç±${priceValue}</td>
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              <div style="font-weight: 600; color: #0a0a0a;">${stockDisplay}</div>
              ${lowStockLabel}
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              <span class="status-badge ${statusClass}" style="display: inline-flex; align-items: center; gap: 6px;">
                ${statusIcon} ${statusText}
              </span>
            </td>
            <td style="padding: 12px; border: 1px solid #e5e7eb;">
              <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                ${actionContent}
              </div>
            </td>
          </tr>
        `;
      }

      function updateStatusCardActiveStates() {
        const cards = document.querySelectorAll('.status-summary-card[role="button"]');
        cards.forEach(card => {
          const status = (card.dataset.status || 'all').toLowerCase();
          const isActive = status === currentProductStatusFilter;
          card.classList.toggle('status-summary-card--active', isActive);
          card.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      }

      function handleStatusCardKey(event, status) {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          filterProductsByStatus(status);
        }
      }

      function escapeHtml(text) {
        const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
        return text.replace(/[&<>"']/g, m => map[m]);
      }


      let originalProductData = {};
      let editVariantsData = [];
      let editVariantMap = {};
      let editColorSizesMapping = {};
      let editSelectedColor = null;
      let editSizeType = 'clothing';
      function editProduct(productId) {
        loadPage('edit-product');

        fetch('/seller/product/' + productId)
          .then(response => response.json())
          .then(data => {
            if (data.product) {
              const product = data.product;
              const variants = data.variants || [];
              originalProductData = JSON.parse(JSON.stringify(product));
              editVariantsData = JSON.parse(JSON.stringify(variants));

              const variantsHtml = `
                <div id="edit-variants-section" style="padding-bottom: 16px; border-bottom: 1px solid #e5e7eb;">
                  <h3 style="margin: 0 0 12px; font-size: 15px; font-weight: 600; display: flex; align-items: center; gap: 8px; color: #0a0a0a;">Product Variants</h3>
                  <small style="color: var(--muted); font-size: 13px; margin-bottom: 12px; display: block;">Define colors and sizes available for this product, then set stock for every combination.</small>

                  <div style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; padding: 12px; margin-bottom: 16px; line-height: 1.5; color: #065f46; font-size: 13px;">
                    <div style="display: flex; align-items: center; gap: 8px; font-weight: 600; margin-bottom: 4px;">
                      <span style="font-size: 16px;">üí°</span> Variant Workflow Tips
                    </div>
                    <div style="padding-left: 24px;">
                      <div>‚ÄúSelect a color tab above first, then choose sizes for that color.‚Äù</div>
                      <div>‚ÄúSelect a color and sizes to set stock quantities.‚Äù</div>
                    </div>
                  </div>

                  <div id="editColorsSection" style="margin-bottom: 18px; padding: 14px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #0a0a0a;">üé® Available Colors</h4>
                    <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">Select predefined colors or add custom ones</small>
                    <div id="editPredefinedColors" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; margin-bottom: 12px;">
                      ${PREDEFINED_COLOR_OPTIONS.map(color => `
                        <label style="display: flex; align-items: center; cursor: pointer; gap: 8px; padding: 8px; border: 1px solid transparent; border-radius: 6px;">
                          <input type="checkbox" name="edit_colors" value="${color}" style="margin: 0; width: 16px; height: 16px;" onchange="editUpdateColorTabs()">
                          <span style="display: flex; align-items: center; gap: 6px; font-size: 13px;">
                            <span style="width: 18px; height: 18px; background: ${PREDEFINED_COLOR_SWATCHES[color] || '#000'}; border: 1px solid #ccc; border-radius: 3px;"></span>
                            <span>${color}</span>
                          </span>
                        </label>
                      `).join('')}
                    </div>
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #0a0a0a;">Custom Colors</label>
                      <input type="text" id="edit-custom-colors" placeholder="e.g. Burgundy, Olive, Charcoal (comma-separated)" style="width: 100%; padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px;" oninput="editUpdateColorTabs()" onchange="editUpdateColorTabs()">
                      <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Add custom colors not listed above.</small>
                    </div>
                  </div>

                  <div style="margin-bottom: 18px; padding: 12px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <p style="margin: 0 0 10px; font-size: 13px; font-weight: 500; color: #0a0a0a;">üëá Select a color to set its sizes:</p>
                    <div id="editColorTabs" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px;"></div>
                  </div>

                  <div id="editSizesSection" style="margin-bottom: 18px; padding: 14px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #0a0a0a;">üìè Available Sizes</h4>
                    <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">‚ÄúSelect a color tab above first, then choose sizes for that color.‚Äù</small>
                    <div id="edit-perColorSizesContainer" style="display: none;">
                      <div id="editClothingSizes" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px; margin-bottom: 12px;">
                        ${['XS','S','M','L','XL','2XL','3XL','4XL'].map(size => `
                          <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                            <input type="checkbox" class="edit-color-size-checkbox" value="${size}" style="margin: 0; width: 14px; height: 14px;" onchange="editUpdateStockInputs()">
                            <span style="font-size: 13px;">${size}</span>
                          </label>
                        `).join('')}
                      </div>
                      <div id="editShoeSizes" style="display: none; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 10px; margin-bottom: 12px;">
                        ${['5','6','7','8','9','10','11','12','13'].map(size => `
                          <label style="display: flex; align-items: center; cursor: pointer; gap: 6px;">
                            <input type="checkbox" class="edit-color-size-checkbox" value="${size}" style="margin: 0; width: 14px; height: 14px;" onchange="editUpdateStockInputs()">
                            <span style="font-size: 13px;">${size}</span>
                          </label>
                        `).join('')}
                      </div>
                      <div>
                        <label style="display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: #0a0a0a;">Custom Sizes</label>
                        <input type="text" id="edit-custom-sizes-per-color" placeholder="e.g. 36, 37, 38, 5XL (comma-separated)" style="width: 100%; padding: 8px 12px; border: 1px solid var(--line); border-radius: 6px; font-size: 13px;" oninput="editUpdateStockInputs()" onchange="editUpdateStockInputs()">
                        <small style="color: var(--muted); font-size: 11px; display: block; margin-top: 4px;">Add custom sizes for <span id="edit-current-color-size-label" style="font-weight: 600; color: #3b82f6;">selected color</span></small>
                      </div>
                    </div>
                    <p id="editSizesPlaceholder" style="color: var(--muted); font-style: italic; margin: 0; padding: 12px; text-align: center; background: #f9fafb; border-radius: 4px;">üëâ Select a color tab above to add sizes for that color</p>
                  </div>

                  <div id="edit-stock-section" style="padding: 14px; background: white; border: 1px solid #e5e7eb; border-radius: 6px;">
                    <h4 style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #0a0a0a;">üì¶ Stock per Color + Size</h4>
                    <small style="color: var(--muted); font-size: 12px; display: block; margin-bottom: 12px;">‚ÄúSelect a color and sizes to set stock quantities.‚Äù</small>
                    <div id="edit-stock-inputs">
                      <p id="edit-stock-placeholder" style="color: var(--muted); font-style: italic; text-align: center; padding: 20px; background: #f9fafb; border-radius: 6px;">Select a color and sizes to set stock quantities.</p>
                    </div>
                    <div style="text-align: right; margin-top: 8px;">
                      <small style="color: var(--muted);">Active color: <span id="edit-stock-table-color" style="font-weight: 600; color: #0a0a0a;">‚Äî</span></small>
                    </div>
                  </div>

                  <div id="edit-stock-variants-summary" style="display: none; margin-top: 16px; border: 1px solid #fbbf24; border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: #fffbeb; border-bottom: 1px solid #fef3c7;">
                      <strong style="font-size: 14px; color: #92400e;">Variant Summary</strong>
                      <span style="color: #92400e; font-size: 13px;">Total Stock: <strong id="edit-total-stock-count">0 pcs</strong></span>
                    </div>
                    <div style="max-height: 220px; overflow-y: auto;">
                      <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <thead>
                          <tr style="background: #fff7ed;">
                            <th style="padding: 8px; border-bottom: 1px solid #fcd34d; text-align: left;">Size</th>
                            <th style="padding: 8px; border-bottom: 1px solid #fcd34d; text-align: left;">Color</th>
                            <th style="padding: 8px; border-bottom: 1px solid #fcd34d; text-align: right;">Stock</th>
                          </tr>
                        </thead>
                        <tbody id="edit-stock-variants-tbody"></tbody>
                      </table>
                    </div>
                  </div>

                  <input type="hidden" id="variants_data" name="variants_data" value='${JSON.stringify(variants)}'>
                  <input type="hidden" id="edit-selected-color" value="">
                </div>
              `;

              const formHtml = `
                <form id="editProductForm" style="display: flex; flex-direction: column; gap: 16px;">
                  <input type="hidden" name="product_id" value="${product.id}">

                  <div style="background: #fffbeb; border: 1px solid #fbbf24; padding: 12px; border-radius: 8px; font-size: 14px;">
                    ‚ÑπÔ∏è <strong>Note:</strong> Changes require admin approval before they appear on your store.
                  </div>

                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Product Name</label>
                    <input type="text" id="edit_name" name="name" value="${product.name}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                  </div>

                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Description</label>
                    <textarea id="edit_description" name="description" rows="4" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>${product.description || ''}</textarea>
                  </div>

                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Price (‚Ç±)</label>
                      <input type="number" id="edit_price" name="price" value="${product.price}" step="0.01" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                    </div>

                    <div>
                      <label style="display: block; margin-bottom: 6px; font-weight: 600;">Brand</label>
                      <input type="text" id="edit_brand" name="brand" value="${product.brand || ''}" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;">
                    </div>
                  </div>

                  <div>
                    <label style="display: block; margin-bottom: 6px; font-weight: 600;">Category</label>
                    <select id="edit_category_id" name="category_id" style="width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 6px;" required>
                      <option value="">Select Category</option>
                      ${data.categories ? data.categories.map(cat => `<option value="${cat.id}" ${cat.id == product.category_id ? 'selected' : ''}>${cat.name}</option>`).join('') : ''}
                    </select>
                  </div>

                  ${variantsHtml}

                  <div style="display: flex; gap: 12px; margin-top: 10px;">
                    <button type="button" class="action-btn" onclick="submitProductEdit()" style="padding: 12px 24px;">Submit for Approval</button>
                    <button type="button" class="action-btn" onclick="loadPage('products')" style="background: #f3f4f6; color: #0a0a0a;">Cancel</button>
                  </div>
                </form>
              `;

              document.getElementById('edit-product-form').innerHTML = formHtml;
              initializeEditVariantWorkflow(product, variants);
            } else {
              document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
            }
          })
          .catch(error => {
            document.getElementById('edit-product-form').innerHTML = '<p style="color: #ef4444;">Error loading product</p>';
          });
      }

      function updateEditVariant(variantId, field, value) {
        const variantIndex = editVariantsData.findIndex(v => v.id === variantId);
        if (variantIndex !== -1) {
          editVariantsData[variantIndex][field] = value;
          editVariantsData[variantIndex].modified = true;
          
          // Update hidden field
          const hiddenField = document.getElementById('variants_data');
          if (hiddenField) {
            hiddenField.value = JSON.stringify(editVariantsData);
          }
          
          console.log('Updated variant:', variantId, field, value);
        }
      }

      async function removeEditVariant(variantId) {
        const confirmed = await VaronNotifications.confirm('Are you sure you want to delete this variant?', {
          confirmText: 'Delete Variant',
          cancelText: 'Keep Variant',
          confirmClass: 'danger'
        });

        if (!confirmed) return;

        const variantIndex = editVariantsData.findIndex(v => v.id === variantId);
        if (variantIndex !== -1) {
          editVariantsData[variantIndex].deleted = true;
          
          // Hide the row
          const row = document.querySelector(`tr[data-variant-id="${variantId}"]`);
          if (row) {
            row.style.display = 'none';
          }
          
          // Update hidden field
          const hiddenField = document.getElementById('variants_data');
          if (hiddenField) {
            hiddenField.value = JSON.stringify(editVariantsData);
          }
          
          VaronNotifications.success('Variant marked for deletion');
        }
      }

      let newVariantCounter = 0;
      function addNewVariant(productId) {
        const tbody = document.getElementById('variant-rows');
        const container = document.getElementById('variants-container');
        
        if (!tbody) {
          // Create table if it doesn't exist
          const variantsDiv = container.parentElement;
          container.style.display = 'block';
          container.innerHTML = `
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: #fff; margin-top: 12px;">
              <thead>
                <tr style="border-bottom: 2px solid var(--line);">
                  <th style="padding: 8px; text-align: left;">Color</th>
                  <th style="padding: 8px; text-align: left;">Size</th>
                  <th style="padding: 8px; text-align: right;">Stock</th>
                  <th style="padding: 8px; text-align: center;">Active</th>
                  <th style="padding: 8px; text-align: center;">Actions</th>
                </tr>
              </thead>
              <tbody id="variant-rows"></tbody>
            </table>
          `;
        }
        
        const newId = 'new_' + (++newVariantCounter);
        const newVariant = {
          id: newId,
          product_id: productId,
          color: '',
          size: '',
          stock_quantity: 0,
          is_active: 1,
          isNew: true
        };
        
        editVariantsData.push(newVariant);
        
        const newRow = `
          <tr data-variant-id="${newId}" style="border-bottom: 1px solid var(--line); background: #f0fff4;">
            <td style="padding: 8px;">
              <input type="text" value="" placeholder="Enter color"
                onchange="updateEditVariant('${newId}', 'color', this.value)"
                style="width: 100%; padding: 6px; border: 1px solid var(--line); border-radius: 4px;">
            </td>
            <td style="padding: 8px;">
              <input type="text" value="" placeholder="Enter size"
                onchange="updateEditVariant('${newId}', 'size', this.value)"
                style="width: 100%; padding: 6px; border: 1px solid var(--line); border-radius: 4px;">
            </td>
            <td style="padding: 8px;">
              <input type="number" value="0" min="0"
                onchange="updateEditVariant('${newId}', 'stock_quantity', this.value)"
                style="width: 80px; padding: 6px; border: 1px solid var(--line); border-radius: 4px; text-align: right;">
            </td>
            <td style="padding: 8px; text-align: center;">
              <input type="checkbox" checked
                onchange="updateEditVariant('${newId}', 'is_active', this.checked ? 1 : 0)"
                style="width: 18px; height: 18px; cursor: pointer;">
            </td>
            <td style="padding: 8px; text-align: center;">
              <button type="button" onclick="removeNewVariant('${newId}')" 
                style="background: #ef4444; color: #fff; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                Remove
              </button>
            </td>
          </tr>
        `;
        
        document.getElementById('variant-rows').insertAdjacentHTML('beforeend', newRow);
        
        // Update hidden field
        const hiddenField = document.getElementById('variants_data');
        if (hiddenField) {
          hiddenField.value = JSON.stringify(editVariantsData);
        }
        
        VaronNotifications.success('New variant row added');
      }

      function removeNewVariant(variantId) {
        const variantIndex = editVariantsData.findIndex(v => v.id === variantId);
        if (variantIndex !== -1) {
          editVariantsData.splice(variantIndex, 1);
          
          const row = document.querySelector(`tr[data-variant-id="${variantId}"]`);
          if (row) {
            row.remove();
          }
          
          // Update hidden field
          const hiddenField = document.getElementById('variants_data');
          if (hiddenField) {
            hiddenField.value = JSON.stringify(editVariantsData);
          }
        }
      }

      async function submitProductEdit() {
        const form = document.getElementById('editProductForm');
        captureCurrentEditStockInputs();
        syncEditVariantsHiddenField();

        const editStockInputs = document.querySelectorAll('#edit-stock-inputs input[type="number"][data-color][data-size]');
        if (editStockInputs.length && !validateNoZeroStock(editStockInputs)) {
          return;
        }

        const manualVariantInputs = document.querySelectorAll('#variant-rows input[type="number"]');
        if (manualVariantInputs.length && !validateNoZeroStock(manualVariantInputs)) {
          return;
        }

        const formData = new FormData(form);


        const changes = {};
        const fieldMap = {
          'name': 'Product Name',
          'description': 'Description',
          'price': 'Price',
          'brand': 'Brand',
          'category_id': 'Category'
        };

        for (let [key, label] of Object.entries(fieldMap)) {
          const newValue = formData.get(key);
          const oldValue = originalProductData[key]?.toString() || '';

          if (newValue !== oldValue) {
            changes[key] = {
              label: label,
              old: oldValue,
              new: newValue
            };
          }
        }

        // Check for variant changes
        let variantChanges = [];
        if (editVariantsData && editVariantsData.length > 0) {
          editVariantsData.forEach(variant => {
            if (variant.isNew && !variant.deleted) {
              variantChanges.push(`Add new variant: ${variant.color || 'N/A'} / ${variant.size || 'N/A'} (Stock: ${variant.stock_quantity})`);
            } else if (variant.deleted) {
              variantChanges.push(`Delete variant: ${variant.color || 'N/A'} / ${variant.size || 'N/A'}`);
            } else if (variant.modified) {
              variantChanges.push(`Update variant: ${variant.color || 'N/A'} / ${variant.size || 'N/A'}`);
            }
          });
        }

        if (Object.keys(changes).length === 0 && variantChanges.length === 0) {
          alert('No changes detected');
          return;
        }


        let confirmMsg = 'You are requesting to change:\. \. ';
        for (let [key, change] of Object.entries(changes)) {
          confirmMsg += `${change.label}: "${change.old}" ‚Üí "${change.new}"\. `;
        }
        if (variantChanges.length > 0) {
          confirmMsg += '\. Variant Changes:\. ' + variantChanges.join('\. ');
        }
        confirmMsg += '\. These changes will require admin approval. Continue?';

        const confirmed = await VaronNotifications.confirm(confirmMsg, {
          confirmText: 'Submit for Review',
          cancelText: 'Go Back',
          confirmClass: 'confirm'
        });

        if (!confirmed) {
          return;
        }

        // Append variants data
        const variantsDataField = document.getElementById('variants_data');
        if (variantsDataField) {
          formData.set('variants_data', variantsDataField.value);
        }

        console.log('Submitting product edit with variants:', editVariantsData);

        fetch('/seller/edit-product', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Product edit submitted for admin approval!\. \. Your changes will be reviewed and applied once approved.');
            loadPage('products');
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          VaronNotifications.error('Error submitting edit request');
        });
      }

      async function archiveProduct(productId, productName) {
        const reason = await VaronNotifications.prompt(`Archive "${productName}"? Optional reason for archiving:`, {
          title: 'Archive Product',
          placeholder: 'Optional reason (e.g., seasonal pause)',
          confirmText: 'Continue',
          cancelText: 'Cancel'
        });

        if (reason === null) return;

        const confirmed = await VaronNotifications.confirm(
          `Are you sure you want to archive "${productName}"? Archived products will be hidden from your store and require admin approval to recover.`,
          {
            confirmText: 'Archive Product',
            cancelText: 'Keep Active',
            confirmClass: 'danger'
          }
        );

        if (!confirmed) {
          return;
        }

        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason || '');

        try {
          const response = await fetch('/seller/archive-product', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Product archived successfully!');
            loadPage('products');
          } else {
            VaronNotifications.error('Error: ' + data.error);
          }
        } catch (error) {
          VaronNotifications.error('Error archiving product: ' + error.message);
        }
      }

      function loadArchivedProducts() {
        const container = document.getElementById('archived-products-list');
        if (!container) {
          console.error('[ERROR] archived-products-list container not found');
          return;
        }

        container.innerHTML = '<p style="text-align:center;color:#999;padding:24px;">Loading archived products...</p>';
        currentArchivedSearchTerm = '';
        initializeArchivedSearchField(false);

        fetch('/seller/archived-products')
          .then(response => response.json())
          .then(data => {
            archivedProductsCache = Array.isArray(data.products) ? data.products : [];

            if (!archivedProductsCache.length) {
              container.innerHTML = '<p style="text-align:center;color:#999;padding:24px;">No archived products</p>';
              initializeArchivedSearchField(false);
              return;
            }

            initializeArchivedSearchField(true);
            renderArchivedProductsTable();
          })
          .catch(error => {
            console.error('[ERROR] Error loading archived products:', error);
            container.innerHTML = '<p style="color:#ef4444;text-align:center;padding:24px;">Error loading archived products</p>';
            initializeArchivedSearchField(false);
          });
      }

      function requestRecovery(productId, productName) {
        const reason = prompt(`Request recovery for "${productName}"?. Reason for recovery (required):`, '');
        if (!reason || reason.trim() === '') {
          if (reason !== null) alert('Please provide a reason for recovery');
          return;
        }

        const formData = new FormData();
        formData.append('product_id', productId);
        formData.append('reason', reason);

        fetch('/seller/request-recovery', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('‚úì Recovery request submitted!. An admin will review your request.');
            loadArchivedProducts();
          } else {
            alert('Error: ' + data.error);
          }
        })
        .catch(error => {
          VaronNotifications.error('Error submitting recovery request');
        });
      }

      function updateStock(productId, currentStock) {
        const newStock = prompt(`Update stock for product (current: ${currentStock}):`, currentStock);
        if (newStock !== null && !isNaN(newStock)) {
          const formData = new FormData();
          formData.append('product_id', productId);
          formData.append('stock_quantity', newStock);

          fetch('/seller/update-stock', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              alert('Stock updated successfully!');

              const activePage = document.querySelector('.side-link.active')?.getAttribute('data-page');
              if (activePage) loadPage(activePage);
            } else {
              VaronNotifications.error('Error updating stock: ' + data.error);
            }
          })
          .catch(error => {
            VaronNotifications.error('Error updating stock');
          });
        }
      }


      function updateAddProductSidebar() {
        const sidebar = document.querySelector('.app.add-product-mode .sidebar');
        if (!sidebar) return;


        const logo = sidebar.querySelector('.logo');
        const sideGroups = sidebar.querySelectorAll('.side-group');

        if (logo) logo.style.display = 'flex';
        sideGroups.forEach(group => {
          group.style.display = 'block';
        });
      }

      function clearAddProductSidebar() {
        const sidebar = document.querySelector('.sidebar');
        if (sidebar && !document.querySelector('.app').classList.contains('add-product-mode')) {
          const logo = sidebar.querySelector('.logo');
          const sideGroups = sidebar.querySelectorAll('.side-group');

          if (logo) logo.style.display = 'flex';
          sideGroups.forEach(group => {
            group.style.display = 'block';
          });
        }
      }


      document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'productImages') {
          const files = e.target.files;
          const previewContainer = document.getElementById('imagePreviewContainer');
          previewContainer.innerHTML = '';

          if (files.length > 0) {
            // Store files in a data attribute for reordering
            previewContainer.dataset.fileOrder = JSON.stringify(Array.from(files).map((_, i) => i));

            Array.from(files).forEach((file, index) => {
              if (file.type.startsWith('image/')) {
                const reader = new FileReader();

                reader.onload = function(e) {
                  const previewItem = document.createElement('div');
                  previewItem.style.cssText = 'position: relative; border: 2px solid var(--line); border-radius: 8px; overflow: hidden; aspect-ratio: 1/1; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;';
                  previewItem.dataset.fileIndex = index;

                  const img = document.createElement('img');
                  img.src = e.target.result;
                  img.style.cssText = 'width: 100%; height: 100%; object-fit: cover;';

                  const badge = document.createElement('div');
                  badge.textContent = index === 0 ? '‚≠ê Primary' : `${index + 1}`;
                  badge.style.cssText = `position: absolute; top: 4px; left: 4px; background: ${index === 0 ? '#10b981' : '#666'}; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;`;

                  const setButton = document.createElement('button');
                  setButton.type = 'button';
                  setButton.textContent = index === 0 ? '‚úì Primary' : 'Set Primary';
                  setButton.style.cssText = `position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); background: ${index === 0 ? '#10b981' : '#3b82f6'}; color: #fff; border: none; padding: 6px 10px; border-radius: 4px; font-size: 11px; font-weight: 600; cursor: pointer; transition: background 0.2s; opacity: 0; width: calc(100% - 8px);`;
                  
                  setButton.addEventListener('mouseover', () => setButton.style.opacity = '1');
                  setButton.addEventListener('mouseout', () => setButton.style.opacity = '0');
                  
                  setButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    setImageAsPrimary(index);
                  });

                  previewItem.appendChild(img);
                  previewItem.appendChild(badge);
                  previewItem.appendChild(setButton);
                  
                  // Hover effect
                  previewItem.addEventListener('mouseover', () => {
                    previewItem.style.transform = 'scale(1.05)';
                    previewItem.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                  });
                  previewItem.addEventListener('mouseout', () => {
                    previewItem.style.transform = 'scale(1)';
                    previewItem.style.boxShadow = 'none';
                  });
                  
                  previewContainer.appendChild(previewItem);
                };

                reader.readAsDataURL(file);
              }
            });
          }
        }
      });

      // Function to set image as primary
      function setImageAsPrimary(targetIndex) {
        const productImagesInput = document.getElementById('productImages');
        const previewContainer = document.getElementById('imagePreviewContainer');
        
        if (!productImagesInput.files || productImagesInput.files.length === 0) return;

        // Create a DataTransfer object to reorder files
        const dt = new DataTransfer();
        const files = Array.from(productImagesInput.files);

        // Add the target file first
        dt.items.add(files[targetIndex]);

        // Add remaining files in order
        files.forEach((file, index) => {
          if (index !== targetIndex) {
            dt.items.add(file);
          }
        });

        // Update the input's files
        productImagesInput.files = dt.files;

        // Trigger change event to update preview with new order
        const event = new Event('change', { bubbles: true });
        productImagesInput.dispatchEvent(event);
      }

      // Logout Modal Functions
      async function confirmLogout(event) {
        if (event) event.preventDefault();
        console.log('[LOGOUT] Opening logout confirmation modal');
        const modal = document.getElementById('logoutModal');
        if (modal) {
          modal.style.display = 'flex';
        } else {
          console.error('[LOGOUT] Logout modal not found!');
          const confirmed = await VaronNotifications.confirm('Are you sure you want to logout?', {
            confirmText: 'Logout',
            cancelText: 'Stay Logged In',
            confirmClass: 'danger'
          });
          if (confirmed) {
            window.location.href = '/logout';
          }
        }
      }

      function closeLogoutModal() {
        console.log('[LOGOUT] Closing logout modal');
        const modal = document.getElementById('logoutModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }

      function proceedLogout() {
        console.log('[LOGOUT] Proceeding with logout');
        window.location.href = '/logout';
      }


      // ============================================================================
      // SIDEBAR NAVIGATION SYSTEM - Overhauled
      // ============================================================================

      /**
       * Sidebar Navigation Manager
       * Handles all sidebar link navigation with proper state management
       */
      const SidebarNavigator = {
        currentPage: 'overview',
        activeLink: null,

        /**
         * Initialize the sidebar navigation system
         */
        init() {
          console.log('üöÄ Initializing Sidebar Navigator...');
          
          // Set initial active link
          this.setActiveLink('overview');
          
          // Bind all sidebar links
          this.bindSidebarLinks();
          
          console.log('‚úÖ Sidebar Navigator initialized successfully');
        },

        /**
         * Bind click event listeners to all sidebar links
         */
        bindSidebarLinks() {
          const sidebarLinks = document.querySelectorAll('.side-link');
          
          if (sidebarLinks.length === 0) {
            console.warn('‚ö†Ô∏è No sidebar links found');
            return;
          }

          sidebarLinks.forEach((link) => {
            link.addEventListener('click', (event) => this.handleLinkClick(event, link));
          });

          console.log(`‚úÖ Bound ${sidebarLinks.length} sidebar links`);
        },

        /**
         * Handle sidebar link click
         * @param {Event} event - Click event
         * @param {Element} link - The clicked link element
         */
        handleLinkClick(event, link) {
          event.preventDefault();
          
          const page = link.getAttribute('data-page');
          const targetSection = link.dataset.section || null;
          
          if (!page) {
            console.warn('‚ö†Ô∏è No data-page attribute on link', link);
            return;
          }

          if (targetSection && page === 'account-settings') {
            pendingAccountSettingsSection = targetSection;
          } else if (page !== 'account-settings') {
            pendingAccountSettingsSection = null;
          }

          // Check if loadPage function is available
          if (typeof loadPage !== 'function') {
            console.error('‚ùå loadPage function not available');
            return;
          }

          // Load the page
          this.currentPage = page;
          this.setActiveLink(page, link);
          loadPage(page);
          
          return false;
        },

        /**
         * Set active link styling based on page name
         * @param {string} page - Page identifier
         */
        setActiveLink(page, specificLink = null) {
          // Remove active class from all links
          const allLinks = document.querySelectorAll('.side-link');
          allLinks.forEach((link) => {
            link.classList.remove('active');
          });

          // Add active class to matching link
          const activeLink = specificLink || document.querySelector(`[data-page="${page}"]`);
          if (activeLink) {
            activeLink.classList.add('active');
            this.activeLink = activeLink;
            console.log(`‚úÖ Active link set to: ${page}`);
          } else {
            console.warn(`‚ö†Ô∏è No link found for page: ${page}`);
          }
        },

        /**
         * Get current active page
         * @returns {string} Current page identifier
         */
        getCurrentPage() {
          return this.currentPage;
        },

        /**
         * Navigate to a specific page (programmatically)
         * @param {string} page - Page identifier
         */
        navigateTo(page) {
          if (typeof loadPage !== 'function') {
            console.error('‚ùå loadPage function not available');
            return;
          }

          this.currentPage = page;
          this.setActiveLink(page);
          loadPage(page);
        }
      };

      /**
       * Page Navigation Manager
       * Handles non-sidebar navigation (buttons, links with data-load-page attribute)
       */
      const PageNavigator = {
        /**
         * Initialize page navigation listeners
         */
        init() {
          console.log('üöÄ Initializing Page Navigator...');
          this.bindPageLoadElements();
          console.log('‚úÖ Page Navigator initialized successfully');
        },

        /**
         * Bind all elements with data-load-page attribute
         */
        bindPageLoadElements() {
          const elements = document.querySelectorAll('[data-load-page]');
          
          if (elements.length === 0) {
            console.warn('‚ö†Ô∏è No elements with data-load-page attribute found');
            return;
          }

          const newElements = Array.from(elements).filter((element) => element.dataset.pageNavBound !== 'true');

          if (newElements.length === 0) {
            console.log('‚ÑπÔ∏è All page navigation elements already bound');
            return;
          }

          newElements.forEach((element) => {
            element.addEventListener('click', (event) => this.handleNavigation(event, element));
            element.dataset.pageNavBound = 'true';
          });

          console.log(`‚úÖ Bound ${newElements.length} page navigation elements`);
        },

        /**
         * Handle navigation click
         * @param {Event} event - Click event
         * @param {Element} element - The clicked element
         */
        handleNavigation(event, element) {
          event.preventDefault();
          
          const page = element.getAttribute('data-load-page');
          const targetSection = element.dataset.section || null;
          
          if (!page) {
            console.warn('‚ö†Ô∏è No data-load-page attribute on element', element);
            return;
          }

          if (targetSection && page === 'account-settings') {
            pendingAccountSettingsSection = targetSection;
          } else if (page !== 'account-settings') {
            pendingAccountSettingsSection = null;
          }

          if (typeof loadPage !== 'function') {
            console.error('‚ùå loadPage function not available');
            return;
          }

          // Update sidebar if the page has a corresponding link
          if (typeof SidebarNavigator !== 'undefined' && SidebarNavigator.setActiveLink) {
            SidebarNavigator.setActiveLink(page);
          }

          loadPage(page);
          return false;
        }
      };

      document.addEventListener('DOMContentLoaded', function() {
        console.log('üìÑ DOMContentLoaded - Setting up all systems...');
        
        try {
          updateSearchBarVisibility('overview');

          // Initialize sidebar navigation
          SidebarNavigator.init();
          
          // Initialize page navigation
          PageNavigator.init();
          
          // Load notification badge count on startup
          updateNotificationBadge();
          
          // Setup color tab delegation if available
          if (typeof setupColorTabDelegation === 'function') {
            setupColorTabDelegation();
          }

          setupProfileSettingsForm();

          // Setup drag-and-drop for images
          const dropZone = document.getElementById('dropZone');
          const productImagesInput = document.getElementById('productImages');

          if (dropZone && productImagesInput) {
            // Click on drop zone to open file picker
            dropZone.addEventListener('click', function() {
              productImagesInput.click();
            });

            // Drag over
            dropZone.addEventListener('dragover', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.borderColor = '#0a0a0a';
              dropZone.style.background = '#f3f4f6';
            });

            // Drag leave
            dropZone.addEventListener('dragleave', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.borderColor = '#3b82f6';
              dropZone.style.background = '#f0f9ff';
            });

            // Drop
            dropZone.addEventListener('drop', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.borderColor = '#3b82f6';
              dropZone.style.background = '#f0f9ff';
              
              const files = e.dataTransfer.files;
              if (files && files.length > 0) {
                productImagesInput.files = files;
                // Trigger change event to update preview
                const event = new Event('change', { bubbles: true });
                productImagesInput.dispatchEvent(event);
              }
            });

            console.log('‚úÖ Drag-and-drop for images initialized');
          }

          // Fetch order count and set up interval
          if (typeof fetchOrderCount === 'function') {
            fetchOrderCount();
            setInterval(fetchOrderCount, 30000);
            console.log('‚úÖ Order count fetching initialized');
          } else {
            console.warn('‚ö†Ô∏è fetchOrderCount function not available');
          }

          console.log('‚úÖ All systems initialized successfully');
        } catch (error) {
          console.error('‚ùå Error during initialization:', error);
        }
      });
    </script>
    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:32px; border-radius:12px; max-width:400px; box-shadow:0 10px 40px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 16px; font-size:20px; font-weight:600; color:#0a0a0a;">Confirm Logout</h3>
        <p style="margin:0 0 24px; color:#666; font-size:14px;">Are you sure you want to log out of your seller account?</p>
        <div style="display:flex; gap:12px; justify-content:flex-end;">
          <button onclick="closeLogoutModal()" style="padding:10px 20px; border:1px solid #ddd; background:#fff; color:#0a0a0a; border-radius:6px; cursor:pointer; font-weight:500;">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px; border:none; background:#ef4444; color:#fff; border-radius:6px; cursor:pointer; font-weight:600;">Logout</button>
        </div>
      </div>
    </div>
    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
  </body>
</html>
