<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rider Dashboard ‚Äî Var√≥n</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer;user-select:none}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:var(--success);margin-left:8px}
      .delta.down{color:var(--error)}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Status tags */
      .status{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:12px}
      .status.pending{background:#fef3c7;color:#92400e}
      .status.in-transit{background:#dbeafe;color:#1e40af}
      .status.delivered{background:#dcfce7;color:#15803d}
      .status.cancelled{background:#fee2e2;color:#991b1b}

      /* Map container */
      .map-container{height:400px;background:#f3f4f6;border-radius:8px;position:relative;overflow:hidden;border:1px solid var(--line)}
      #serviceMap{height:100%;width:100%;z-index:1}

      /* Area coverage section */
      .coverage-area{margin-top:14px;padding:14px;background:#f8fafc;border-radius:8px}
      .coverage-title{font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
      .coverage-title .icon{font-size:20px}
      .coverage-details{color:var(--muted);font-size:14px;line-height:1.6}
      .coverage-list{list-style:none;padding:0;margin:10px 0 0;display:grid;gap:6px}
      .coverage-list li{padding:8px 10px;background:#fff;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px}
      .coverage-list li:before{content:'üìç';font-size:14px}

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Var√≥n Rider</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Menu</div>
          <a class="side-link active" href="#" onclick="switchSection('overview'); return false;">Overview</a>
          <a class="side-link" href="#" onclick="switchSection('deliveries'); return false;">Active Deliveries</a>
          <a class="side-link" href="#" onclick="switchSection('history'); return false;">Delivery History</a>
          <a class="side-link" href="#" onclick="switchSection('earnings'); return false;">Earnings</a>
          <a class="side-link" href="#" onclick="switchSection('schedule'); return false;">Schedule</a>
          <a class="side-link" href="#" onclick="switchSection('ratings'); return false;">Ratings & Reviews</a>
        </div>
        <div class="side-group">
          <div class="side-title">Account</div>
          <a class="side-link" href="#" onclick="switchSection('profile'); return false;">Profile</a>
          <a class="side-link" href="#" onclick="switchSection('settings'); return false;">Settings</a>
          <a class="side-link" href="#" onclick="switchSection('support'); return false;">Support</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Welcome back, <span id="riderName">{{ rider_name }}</span>!</div>
          <div class="avatar">
            <img src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                 alt="Profile" 
                 style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);cursor:pointer"
                 onclick="switchSection('profile')"
                 title="View Profile"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22%3E%3Crect fill=%22%23efefef%22 width=%2236%22 height=%2236%22 rx=%2218%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
            <div class="status in-transit">
              <span class="dot" style="width:6px;height:6px;background:currentColor;border-radius:999px"></span>
              Online
            </div>
            {% if session.logged_in %}
              <span class="tag">{{ session.email }}</span>
              <a href="/logout" class="tag" style="background:#efefef;color:#0a0a0a">Logout</a>
            {% else %}
              <a href="/login" class="tag">Login</a>
            {% endif %}
          </div>
        </div>

        <main class="main" id="mainContent">
          <!-- Overview Section -->
          <div id="overview-section">
            <!-- Coverage Area with Interactive Map -->
            <div class="card">
              <div class="inner">
                <div class="coverage-title">
                  <span class="icon">üó∫Ô∏è</span>
                  Your Service Area: {% if rider and rider.service_area %}{{ rider.service_area.split(',')[0].strip() }}{% else %}South Luzon{% endif %}
                </div>
                <div class="coverage-details" id="coverage-description">
                  Loading coverage details...
                </div>
                
                <!-- Interactive Map -->
                <div class="map-container" style="margin-top:12px">
                  <div id="serviceMap"></div>
                </div>

              </div>
            </div>

            <!-- Stat cards -->
            <div class="grid stats" style="margin-top:14px">
              <div class="card">
                <div class="inner">
                  <div class="metric">Today's Earnings</div>
                  <div class="value">‚Ç±{{ "%.2f"|format(earnings_today) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Deliveries Today</div>
                  <div class="value">{{ deliveries_today }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Rating</div>
                  <div class="value">{{ "%.1f"|format(rating) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Acceptance Rate</div>
                  <div class="value">{{ acceptance_rate }}%</div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Deliveries</div>
                  <a href="#" class="show-section" data-section="history" style="font-size:12px;color:var(--muted)">View History</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Route</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Earnings</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_deliveries and recent_deliveries|length > 0 %}
                        {% for delivery in recent_deliveries %}
                        <tr>
                          <td>#{{ delivery.order_number }}</td>
                          <td>{{ delivery.pickup_location or 'N/A' }} ‚Üí {{ delivery.delivery_location or 'N/A' }}</td>
                          <td>{{ delivery.delivered_at.strftime('%I:%M %p') if delivery.delivered_at else 'N/A' }}</td>
                          <td><span class="status {{ delivery.status }}">{{ delivery.status|title|replace('_', ' ') }}</span></td>
                          <td>‚Ç±{{ "%.2f"|format(delivery.total_amount * 0.15) }}</td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent deliveries</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Deliveries Section -->
          <div id="deliveries-section" style="display: none;">
            <!-- Available Orders Tab -->
            <div class="card" style="margin-bottom:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">Available Orders in Your Area</div>
                  <button onclick="loadAvailableOrders()" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer">üîÑ Refresh</button>
                </div>
                <div style="overflow:auto">
                  <table id="available-orders-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Amount</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading available orders...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- My Active Deliveries Tab -->
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">My Active Deliveries</div>
                  <div class="tag" style="background:#10b981;color:#fff" id="active-count">0 Active</div>
                </div>

                <!-- Region/Area Filter Controls -->
                <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;padding:12px;background:#f8fafc;border-radius:8px">
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by Province</label>
                    <input type="text" id="filterProvince" placeholder="Enter province" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadMyActiveDeliveries()">
                  </div>
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by City</label>
                    <input type="text" id="filterCity" placeholder="Enter city" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadMyActiveDeliveries()">
                  </div>
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by Postal Code</label>
                    <input type="text" id="filterPostalCode" placeholder="Enter postal code" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadMyActiveDeliveries()">
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:6px">
                    <button onclick="clearFilters()" style="padding:8px 14px;background:#efefef;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#efefef'">Clear Filters</button>
                  </div>
                </div>

                <div style="font-size:12px;color:#666;margin-bottom:10px">
                  üìç Your Service Area: <strong id="riderServiceArea">Loading...</strong>
                </div>

                <div style="overflow:auto">
                  <table id="active-deliveries-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Status</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="active-deliveries-tbody" style="color:#0a0a0a">
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading your deliveries...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="history-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Delivery History</div>
                  <div class="tag" style="background:#efefef;color:#0a0a0a">Last 30 Days</div>
                </div>
                <div style="overflow:auto">
                  <table id="history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Orders</th>
                        <th>Earnings</th>
                        <th>Rating</th>
                        <th style="text-align:center">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings Section -->
          <div id="earnings-section" style="display: none;">
            <div class="grid stats">
              <div class="card">
                <div class="inner">
                  <div class="metric">Weekly Earnings</div>
                  <div class="value" id="weekly-earnings">‚Ç±0.00</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Monthly Earnings</div>
                  <div class="value" id="monthly-earnings">‚Ç±0.00</div>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div class="metric">Earnings Breakdown</div>
                <div style="overflow:auto">
                  <table id="earnings-breakdown-table">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Share</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="3" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Schedule Section -->
          <div id="schedule-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Your Schedule</div>
                  <div class="tag" style="background:#10b981;color:#fff">Online</div>
                </div>
                <div style="margin-top:20px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Today's Hours</div>
                    <div>8:00 AM - 5:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Break Time</div>
                    <div>12:00 PM - 1:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Area Coverage</div>
                    <div>Sta Cruz, Laguna</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ratings Section -->
          <div id="ratings-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Feedback</div>
                <div style="margin-top:20px">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
                    <div style="font-size:32px;font-weight:bold" id="overall-rating">4.5</div>
                    <div id="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <div style="color:var(--muted)" id="rating-count">(0 ratings)</div>
                  </div>
                  <table id="reviews-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Rating</th>
                        <th>Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Profile Information</div>
                <div style="margin-top:20px">
                  <div style="display:flex;gap:20px;margin-bottom:20px">
                    <div style="position:relative;width:100px;height:100px">
                      <img id="profileImage" 
                           src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                           alt="Profile" 
                           style="width:100px;height:100px;border-radius:50%;object-fit:cover;background:#efefef;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.1)"
                           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
                      <label for="profileImageInput" 
                             style="position:absolute;bottom:0;right:0;background:#0a0a0a;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);font-size:16px"
                             title="Upload profile photo">
                        üì∑
                      </label>
                      <input type="file" 
                             id="profileImageInput" 
                             accept="image/*" 
                             style="display:none" 
                             onchange="uploadProfileImage(this)">
                    </div>
                    <div>
                      <div style="font-size:20px;font-weight:bold">{{ rider_name }}</div>
                      <div style="color:var(--muted)">{{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }} Rider</div>
                      <div style="margin-top:10px">
                        <span class="tag" style="background:#efefef;color:#0a0a0a">Motorcycle</span>
                        <span class="tag" style="background:#efefef;color:#0a0a0a">2+ Years</span>
                      </div>
                    </div>
                  </div>
                  <div style="display:grid;gap:10px">
                    <div style="display:flex;justify-content:space-between">
                      <div>Vehicle Type(s)</div>
                      <div>
                        {% if rider and rider.vehicle_type %}
                          {% set vehicles = rider.vehicle_type.split(',') %}
                          {% for vehicle in vehicles %}
                            <span class="tag" style="background:#efefef;color:#0a0a0a;margin-right:6px">{{ vehicle.strip()|title }}</span>
                          {% endfor %}
                        {% else %}
                          <span>Not specified</span>
                        {% endif %}
                      </div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>License Number</div>
                      <div>{{ rider.license_number if rider and rider.license_number else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Contact Number</div>
                      <div>{{ user.phone if user and user.phone else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Email</div>
                      <div>{{ user.email if user and user.email else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Total Deliveries</div>
                      <div>{{ total_deliveries }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </main>
      </section>
    </div>
    <style>
      /* Hide all sections by default */
      [id$="-section"] {
        display: none;
      }
      /* Show overview section by default */
      #overview-section {
        display: block;
      }
    </style>

    <script>
      // Region coordinates mapping - supports major Philippine regions
      const regionCoordinates = {
        'north luzon': { center: [16.4023, 120.5960], zoom: 7, radius: 150000, displayName: 'North Luzon' },
        'central luzon': { center: [15.4828, 120.7129], zoom: 8, radius: 100000, displayName: 'Central Luzon' },
        'south luzon': { center: [14.2691, 121.4147], zoom: 8, radius: 120000, displayName: 'South Luzon' },
        'visayas': { center: [11.2447, 123.0167], zoom: 7, radius: 200000, displayName: 'Visayas' },
        'mindanao': { center: [7.1907, 124.2250], zoom: 7, radius: 250000, displayName: 'Mindanao' },
        // Legacy support for specific cities
        'sta cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Sta Cruz, Laguna' },
        'santa cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Santa Cruz, Laguna' },
        'calamba': { center: [14.2117, 121.1653], zoom: 13, radius: 6000, displayName: 'Calamba, Laguna' },
        'los ba√±os': { center: [14.1697, 121.2408], zoom: 13, radius: 5000, displayName: 'Los Ba√±os, Laguna' },
        'manila': { center: [14.5995, 120.9842], zoom: 12, radius: 8000, displayName: 'Manila (NCR)' },
        'quezon city': { center: [14.6760, 121.0437], zoom: 12, radius: 10000, displayName: 'Quezon City (NCR)' }
      };

      // Initialize Interactive Map based on rider's region
      function initializeMap() {
        // Get rider's service area from template
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "South Luzon" }}';
        console.log('Service Area from DB:', serviceAreaText);
        
        // Parse service area: format is "Region" or "Region,Province1,Province2,..."
        const serviceAreaParts = serviceAreaText.split(',').map(part => part.trim());
        const mainRegion = serviceAreaParts[0]; // First part is the main region
        const normalizedRegion = mainRegion.toLowerCase().trim();
        
        console.log('Parsed main region:', mainRegion);
        console.log('All service area parts:', serviceAreaParts);
        
        // Find matching region coordinates (case-insensitive)
        let regionConfig = null;
        for (const [region, config] of Object.entries(regionCoordinates)) {
          if (normalizedRegion.includes(region.toLowerCase()) || region.toLowerCase().includes(normalizedRegion)) {
            regionConfig = config;
            console.log('Matched region:', region, config);
            break;
          }
        }
        
        // Default to South Luzon if no match found
        if (!regionConfig) {
          console.log('No match found, using default: South Luzon');
          regionConfig = regionCoordinates['south luzon'];
        }
        
        // Initialize the map with region-specific settings
        const map = L.map('serviceMap').setView(regionConfig.center, regionConfig.zoom);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        
        // Define service area boundaries with region-specific radius
        const serviceArea = L.circle(regionConfig.center, {
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.15,
          radius: regionConfig.radius
        }).addTo(map);
        
        // Add center marker for service area (region name only)
        const centerMarker = L.marker(regionConfig.center, {
          icon: L.divIcon({
            className: 'center-marker',
            html: '<div style="background:#0a0a0a;color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üìç ' + regionConfig.displayName + '</div>',
            iconSize: [120, 32],
            iconAnchor: [60, 16]
          })
        }).addTo(map);
        
        centerMarker.bindPopup(`<b>${regionConfig.displayName}</b><br>Your Service Area`);
        
        // Add scale control
        L.control.scale().addTo(map);
      }
      
      // Simple function to switch between sections
      function switchSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('[id$="-section"]').forEach(section => {
          section.style.display = 'none';
        });
        
        // Show selected section
        const selectedSection = document.getElementById(sectionId + '-section');
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }
        
        // Update active state in sidebar
        document.querySelectorAll('.side-link').forEach(link => {
          link.classList.remove('active');
        });
        
        // Find and activate the clicked link
        const activeLink = Array.from(document.querySelectorAll('.side-link')).find(
          link => link.textContent.toLowerCase().includes(sectionId.toLowerCase())
        );
        if (activeLink) {
          activeLink.classList.add('active');
        }

        // Load deliveries when switching to deliveries section
        if (sectionId === 'deliveries') {
          loadAvailableOrders();
          loadMyActiveDeliveries();
        }
      }

      // Load available orders for delivery
      function loadAvailableOrders() {
        fetch('/api/rider/available-orders')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#available-orders-table tbody');
            
            console.log('[DEBUG] Available Orders Response:', data);
            
            if (data.success && data.orders && data.orders.length > 0) {
              const availableOrders = data.orders.filter(order => 
                order.shipment_status === 'pending' && !order.assigned_rider_id
              );
              
              if (availableOrders.length > 0) {
                tbody.innerHTML = availableOrders.map(order => {
                  const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                  const orderDate = new Date(order.created_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  });
                  const location = `${order.delivery_city}, ${order.delivery_province} ${order.delivery_postal_code}`.trim();
                  return `
                    <tr>
                      <td>
                        <div style="font-weight:600">#${order.order_number}</div>
                        <div style="font-size:11px;color:#999">${orderDate}</div>
                      </td>
                      <td>
                        <div>${order.customer_name}</div>
                        <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                      </td>
                      <td style="max-width:200px">
                        <div>${order.delivery_address}</div>
                        <div style="font-size:11px;color:#10b981;margin-top:2px">üìç ${location}</div>
                      </td>
                      <td style="font-weight:600">‚Ç±${parseFloat(order.total_amount).toFixed(2)}</td>
                      <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                      <td>
                        <button onclick="acceptOrder(${order.shipment_id})" 
                                class="tag" 
                                style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:8px 16px">
                          Accept
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('');
              } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">All available orders in your area are already accepted</td></tr>';
              }
            } else {
              const message = data.service_area ? 
                'No available orders in your area. New orders will appear here.' :
                'No service area assigned. Please contact support.';
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">${message}</td></tr>`;
              console.log('[DEBUG] Data:', data);
            }
          })
          .catch(error => {
            console.error('Error loading available orders:', error);
            document.querySelector('#available-orders-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading orders</td></tr>';
          });
      }

      // Load rider's active deliveries with regional filtering
      function loadMyActiveDeliveries() {
        // Get filter values from inputs
        const filterProvince = document.getElementById('filterProvince')?.value.trim() || '';
        const filterCity = document.getElementById('filterCity')?.value.trim() || '';
        const filterPostalCode = document.getElementById('filterPostalCode')?.value.trim() || '';
        
        // Build query parameters
        let url = '/api/rider/active-deliveries';
        const params = new URLSearchParams();
        if (filterProvince) params.append('province', filterProvince);
        if (filterCity) params.append('city', filterCity);
        if (filterPostalCode) params.append('postal_code', filterPostalCode);
        if (params.toString()) url += '?' + params.toString();
        
        fetch(url)
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#active-deliveries-table tbody');
            // Include all active deliveries: pending (waiting approval), picked_up, in_transit, out_for_delivery
            const activeOrders = data.deliveries || [];
            
            // Display rider's service area
            if (data.service_area) {
              document.getElementById('riderServiceArea').textContent = data.service_area || 'Not assigned';
            }
            
            // Update count badge with filter info
            let countText = `${activeOrders.length} Active`;
            if (filterProvince || filterCity || filterPostalCode) {
              const filters = [];
              if (filterProvince) filters.push(filterProvince);
              if (filterCity) filters.push(filterCity);
              if (filterPostalCode) filters.push(filterPostalCode);
              countText = `${activeOrders.length} Found (${filters.join(', ')})`;
            }
            document.getElementById('active-count').textContent = countText;
            
            if (activeOrders.length > 0) {
              tbody.innerHTML = activeOrders.map(order => {
                const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                const statusClass = order.shipment_status.replace('_', '-');
                
                // Show status based on seller_confirmed
                let statusText, statusColor;
                if (!order.seller_confirmed && order.shipment_status === 'pending') {
                  statusText = 'WAITING FOR APPROVAL';
                  statusColor = '#f59e0b'; // Orange/amber
                } else {
                  statusText = order.shipment_status.replace('_', ' ').toUpperCase();
                  statusColor = order.shipment_status === 'delivered' ? '#10b981' : 
                               order.shipment_status === 'picked_up' ? '#3b82f6' :
                               order.shipment_status === 'in_transit' ? '#8b5cf6' : '#6b7280';
                }
                
                // Display order location
                const orderLocation = `${order.city}, ${order.province} ${order.postal_code}`.trim();
                
                // Only show status update buttons if seller has approved
                const statusButtons = order.seller_confirmed ? `
                  <div style="display:flex;gap:6px;flex-wrap:wrap">
                    ${order.shipment_status !== 'in_transit' ? `<button onclick="updateDeliveryStatus(${order.shipment_id}, 'in_transit')" class="tag" style="background:#3b82f6;color:#fff;border:none;cursor:pointer;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">In Transit</button>` : ''}
                    ${order.shipment_status !== 'out_for_delivery' && order.shipment_status !== 'delivered' ? `<button onclick="updateDeliveryStatus(${order.shipment_id}, 'out_for_delivery')" class="tag" style="background:#8b5cf6;color:#fff;border:none;cursor:pointer;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#7c3aed'" onmouseout="this.style.background='#8b5cf6'">Out for Delivery</button>` : ''}
                    ${order.shipment_status !== 'delivered' ? `<button onclick="updateDeliveryStatus(${order.shipment_id}, 'delivered')" class="tag" style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">‚úì Delivered</button>` : '<span style="background:#10b981;color:#fff;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600">‚úì Delivered</span>'}
                  </div>
                ` : `
                  <span style="color:#f59e0b;font-size:12px;font-weight:500">‚è≥ Waiting for seller approval</span>
                `;
                
                return `
                  <tr style="color:#0a0a0a">
                    <td style="color:#0a0a0a">
                      <div style="font-weight:600;color:#0a0a0a">#${order.order_number}</div>
                    </td>
                    <td style="color:#0a0a0a">
                      <div style="color:#0a0a0a">${order.customer_name}</div>
                      <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                    </td>
                    <td style="max-width:200px;color:#0a0a0a">
                      <div>${order.delivery_address}</div>
                      <div style="font-size:11px;color:#10b981;margin-top:2px">üìç ${orderLocation}</div>
                    </td>
                    <td style="color:#0a0a0a">
                      <span class="status ${statusClass}" style="background:${statusColor};color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">
                        ${statusText}
                      </span>
                    </td>
                    <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                    <td style="color:#0a0a0a">
                      ${statusButtons}
                    </td>
                  </tr>
                `;
              }).join('');
            } else {
              const filterText = (filterProvince || filterCity || filterPostalCode) ? 
                'No deliveries found in this area. Try adjusting your filters.' : 
                'No active deliveries. New orders will appear here.';
              tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">${filterText}</td></tr>`;
            }
          })
          .catch(error => {
            console.error('Error loading active deliveries:', error);
            document.querySelector('#active-deliveries-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading deliveries</td></tr>';
          });
      }

      // Clear all filters
      function clearFilters() {
        document.getElementById('filterProvince').value = '';
        document.getElementById('filterCity').value = '';
        document.getElementById('filterPostalCode').value = '';
        loadMyActiveDeliveries();
      }

      // Accept an order
      function acceptOrder(shipmentId) {
        if (!confirm('Accept this delivery order?')) return;
        
        fetch('/api/rider/accept-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ shipment_id: shipmentId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Order accepted! You can now start the delivery.');
            loadAvailableOrders();
            loadMyActiveDeliveries();
          } else {
            alert('Failed to accept order: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error accepting order:', error);
          alert('Error accepting order. Please try again.');
        });
      }

      // Update delivery status
      function updateDeliveryStatus(shipmentId, newStatus) {
        if (!newStatus) return;
        
        const statusText = newStatus.replace('_', ' ').toUpperCase();
        if (!confirm(`Update status to ${statusText}?`)) {
          // Reset the select dropdown
          event.target.value = '';
          return;
        }
        
        fetch('/api/rider/update-delivery-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            shipment_id: shipmentId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status updated successfully!');
            if (newStatus === 'delivered') {
              alert('üéâ Delivery completed! Your earnings have been updated.');
            }
            loadMyActiveDeliveries();
          } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
            event.target.value = '';
          }
        })
        .catch(error => {
          console.error('Error updating status:', error);
          alert('Error updating status. Please try again.');
          event.target.value = '';
        });
      }

      // Load delivery history from database
      function loadDeliveryHistory() {
        fetch('/api/rider/delivery-history')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#history-table tbody');
            if (data.success && data.history && data.history.length > 0) {
              tbody.innerHTML = data.history.map((day, index) => {
                const date = new Date(day.delivery_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const rating = day.avg_rating ? parseFloat(day.avg_rating).toFixed(1) : '5.0';
                return `
                  <tr>
                    <td>${date}</td>
                    <td>${day.order_count} deliveries</td>
                    <td>‚Ç±${parseFloat(day.daily_earnings).toFixed(2)}</td>
                    <td>${rating} ‚≠ê</td>
                    <td style="text-align:center">
                      <div style="display:flex;gap:6px;justify-content:center">
                        <button onclick="viewHistoryDetails(${index}, '${date}', ${day.order_count}, ${day.daily_earnings})" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#2d2d2d'" onmouseout="this.style.background='#0a0a0a'">View</button>
                        <button onclick="updateHistoryRecord(${index}, '${date}')" class="tag" style="background:#6b7280;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">Update</button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999">No delivery history found</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading delivery history:', error);
            document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444">Error loading history</td></tr>';
          });
      }

      // View history details
      function viewHistoryDetails(index, date, orderCount, earnings) {
        const details = `
Delivery Date: ${date}
Total Deliveries: ${orderCount}
Daily Earnings: ‚Ç±${parseFloat(earnings).toFixed(2)}
        `;
        alert(details);
      }

      // Update history record (for future enhancements)
      function updateHistoryRecord(index, date) {
        alert('Edit delivery record for ' + date + '\n(To be implemented)');
      }

      // Load earnings data from database
      function loadEarnings() {
        fetch('/api/rider/earnings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update weekly and monthly earnings
              document.getElementById('weekly-earnings').textContent = '‚Ç±' + parseFloat(data.weekly_earnings).toFixed(2);
              document.getElementById('monthly-earnings').textContent = '‚Ç±' + parseFloat(data.monthly_earnings).toFixed(2);
              
              // Update earnings breakdown
              const tbody = document.querySelector('#earnings-breakdown-table tbody');
              tbody.innerHTML = `
                <tr>
                  <td>Base Fare</td>
                  <td>‚Ç±${parseFloat(data.breakdown.base_fare).toFixed(2)}</td>
                  <td>70%</td>
                </tr>
                <tr>
                  <td>Tips</td>
                  <td>‚Ç±${parseFloat(data.breakdown.tips).toFixed(2)}</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td>Bonuses</td>
                  <td>‚Ç±${parseFloat(data.breakdown.bonuses).toFixed(2)}</td>
                  <td>10%</td>
                </tr>
              `;
            } else {
              document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999">No earnings data available</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading earnings:', error);
            document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ef4444">Error loading earnings</td></tr>';
          });
      }

      // Load ratings and reviews from database
      function loadRatings() {
        fetch('/api/rider/ratings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update overall rating
              const rating = parseFloat(data.overall_rating).toFixed(1);
              document.getElementById('overall-rating').textContent = rating;
              
              // Generate stars based on rating
              const fullStars = Math.floor(data.overall_rating);
              const stars = '‚≠ê'.repeat(fullStars);
              document.getElementById('rating-stars').textContent = stars;
              
              // Update rating count
              document.getElementById('rating-count').textContent = `(${data.total_ratings} ratings)`;
              
              // Update reviews table
              const tbody = document.querySelector('#reviews-table tbody');
              if (data.reviews && data.reviews.length > 0) {
                tbody.innerHTML = data.reviews.map(review => {
                  const date = new Date(review.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  const stars = '‚≠ê'.repeat(review.rating);
                  return `
                    <tr>
                      <td>${date}</td>
                      <td>${review.customer_name}</td>
                      <td>${stars}</td>
                      <td>${review.comment || 'No comment'}</td>
                    </tr>
                  `;
                }).join('');
              } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No reviews yet</td></tr>';
              }
            }
          })
          .catch(error => {
            console.error('Error loading ratings:', error);
            document.querySelector('#reviews-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading reviews</td></tr>';
          });
      }

      // Region to provinces mapping
      const regionProvinces = {
        'North Luzon': [
          'Ilocos Norte', 'Ilocos Sur', 'La Union', 'Pangasinan', 
          'Baguio City', 'Benguet', 'Abra', 'Kalinga', 'Apayao', 'Mountain Province',
          'Cagayan', 'Isabela', 'Nueva Vizcaya', 'Quirino', 'Batanes'
        ],
        'Central Luzon': [
          'Pampanga', 'Tarlac', 'Nueva Ecija', 'Zambales', 'Bataan', 
          'Bulacan', 'Aurora', 'Angeles City', 'Olongapo City', 'San Fernando City'
        ],
        'South Luzon': [
          'Laguna', 'Batangas', 'Cavite', 'Rizal', 'Quezon', 
          'Antipolo City', 'Lucena City', 'Batangas City', 'Lipa City', 'Tagaytay City',
          'Calamba City', 'Los Ba√±os', 'Bi√±an City', 'Cabuyao', 'San Pablo City',
          'Albay', 'Camarines Norte', 'Camarines Sur', 'Catanduanes', 'Masbate', 'Sorsogon',
          'Marinduque', 'Occidental Mindoro', 'Oriental Mindoro', 'Palawan', 'Romblon',
          'Manila', 'Quezon City', 'Makati', 'Pasig', 'Taguig', 'Mandaluyong', 
          'Marikina', 'Pasay', 'Para√±aque', 'Las Pi√±as', 'Muntinlupa', 'Caloocan',
          'Malabon', 'Navotas', 'Valenzuela', 'San Juan'
        ],
        'Visayas': [
          'Cebu', 'Cebu City', 'Mandaue City', 'Lapu-Lapu City', 'Talisay City',
          'Iloilo', 'Iloilo City', 'Bacolod City', 'Negros Occidental', 'Negros Oriental',
          'Bohol', 'Tagbilaran City', 'Dumaguete City', 'Roxas City', 'Kalibo',
          'Tacloban City', 'Ormoc City', 'Leyte', 'Samar', 'Eastern Samar', 'Northern Samar',
          'Biliran', 'Southern Leyte'
        ],
        'Mindanao': [
          'Davao City', 'Davao del Norte', 'Davao del Sur', 'Davao Oriental', 'Davao de Oro',
          'Cagayan de Oro City', 'Misamis Oriental', 'Misamis Occidental', 'Iligan City',
          'Zamboanga City', 'Zamboanga del Norte', 'Zamboanga del Sur', 'Zamboanga Sibugay',
          'General Santos City', 'South Cotabato', 'North Cotabato', 'Sultan Kudarat',
          'Butuan City', 'Agusan del Norte', 'Agusan del Sur', 'Surigao del Norte', 'Surigao del Sur',
          'Cotabato City', 'Maguindanao', 'Lanao del Norte', 'Lanao del Sur', 'Marawi City',
          'Bukidnon', 'Valencia City', 'Malaybalay City'
        ]
      };

      // Update coverage details based on rider's service area
      function updateCoverageDetails() {
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "South Luzon" }}';
        console.log('Updating coverage details for:', serviceAreaText);
        
        // Parse service area: format is "Region" or "Region,Province1,Province2,..."
        const serviceAreaParts = serviceAreaText.split(',').map(part => part.trim());
        const mainRegion = serviceAreaParts[0];
        
        // Build coverage description - always show all provinces for the region
        let coverageText = 'Covering: ';
        
        // Get all provinces for the region
        const allRegionProvinces = regionProvinces[mainRegion] || [];
        
        if (allRegionProvinces.length > 0) {
          // Show all provinces in the region
          coverageText += allRegionProvinces.join(', ');
        } else {
          // Fallback to just the region name if no provinces mapped
          coverageText += mainRegion;
        }
        
        // Update description
        const coverageDescription = document.getElementById('coverage-description');
        if (coverageDescription) {
          coverageDescription.textContent = coverageText;
        }
      }

      // Upload profile image
      function uploadProfileImage(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image size must be less than 5MB.');
          return;
        }
        
        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to server
        const formData = new FormData();
        formData.append('profile_image', file);
        
        fetch('/api/rider/upload-profile-image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Profile image updated successfully!');
          } else {
            alert('Failed to upload image: ' + (data.error || 'Unknown error'));
            // Reload to show original image
            location.reload();
          }
        })
        .catch(error => {
          console.error('Error uploading image:', error);
          alert('Error uploading image. Please try again.');
          // Reload to show original image
          location.reload();
        });
      }

      // Initialize the dashboard
      document.addEventListener('DOMContentLoaded', function() {
        // Show overview section by default
        document.getElementById('overview-section').style.display = 'block';
        
        // Update coverage details based on region
        updateCoverageDetails();
        
        // Initialize the map with region-specific settings
        initializeMap();
        
        // Load data from database
        loadDeliveryHistory();
        loadEarnings();
        loadRatings();
        
        // Add click handler for "View History" link
        document.querySelectorAll('.show-section').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
              switchSection(section);
            }
          });
        });
        
        // Add click handlers to all sidebar links as backup
        document.querySelectorAll('.side-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Extract section from onclick attribute or text
            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {
              // Extract section name from onclick="switchSection('section'); return false;"
              const match = onclickAttr.match(/switchSection\('(.+?)'\)/);
              if (match && match[1]) {
                switchSection(match[1]);
              }
            }
          });
        });
        
        console.log('Rider Dashboard initialized');
      });
    </script>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>
