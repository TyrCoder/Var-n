<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rider Dashboard ‚Äî Var√≥n</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer;user-select:none}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:var(--success);margin-left:8px}
      .delta.down{color:var(--error)}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Status tags */
      .status{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:12px}
      .status.pending{background:#fef3c7;color:#92400e}
      .status.in-transit{background:#dbeafe;color:#1e40af}
      .status.delivered{background:#dcfce7;color:#15803d}
      .status.cancelled{background:#fee2e2;color:#991b1b}

      /* Map container */
      .map-container{height:500px;background:#f3f4f6;border-radius:8px;position:relative;overflow:hidden;border:1px solid var(--line);margin-left:-14px;margin-right:-14px;width:calc(100% + 28px)}
      #serviceMap{height:100%;width:100%;z-index:1}

      /* Area coverage section */
      .coverage-area{margin-top:14px;padding:14px;background:#f8fafc;border-radius:8px}
      .coverage-title{font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
      .coverage-title .icon{font-size:20px}
      .coverage-details{color:var(--muted);font-size:14px;line-height:1.6}
      .coverage-list{list-style:none;padding:0;margin:10px 0 0;display:grid;gap:6px}
      .coverage-list li{padding:8px 10px;background:#fff;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px}
      .coverage-list li:before{content:'üìç';font-size:14px}

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Var√≥n Rider</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Menu</div>
          <a class="side-link active" href="#" onclick="switchSection('overview'); return false;">Overview</a>
          <a class="side-link" href="#" onclick="switchSection('deliveries'); return false;">Active Deliveries</a>
          <a class="side-link" href="#" onclick="switchSection('history'); return false;">Delivery History</a>
          <a class="side-link" href="#" onclick="switchSection('earnings'); return false;">Earnings</a>
          <a class="side-link" href="#" onclick="switchSection('schedule'); return false;">Schedule</a>
          <a class="side-link" href="#" onclick="switchSection('ratings'); return false;">Ratings & Reviews</a>
        </div>
        <div class="side-group">
          <div class="side-title">Account</div>
          <a class="side-link" href="#" onclick="switchSection('profile'); return false;">Profile</a>
          <a class="side-link" href="#" onclick="switchSection('settings'); return false;">Settings</a>
          <a class="side-link" href="#" onclick="switchSection('support'); return false;">Support</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Welcome back, <span id="riderName">{{ rider_name }}</span>!</div>
          <div class="avatar">
            <img src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                 alt="Profile" 
                 style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);cursor:pointer"
                 onclick="switchSection('profile')"
                 title="View Profile"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22%3E%3Crect fill=%22%23efefef%22 width=%2236%22 height=%2236%22 rx=%2218%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
            <div class="status in-transit">
              <span class="dot" style="width:6px;height:6px;background:currentColor;border-radius:999px"></span>
              Online
            </div>
            {% if session.logged_in %}
              <span class="tag">{{ session.email }}</span>
              <a href="/logout" class="tag" style="background:#efefef;color:#0a0a0a">Logout</a>
            {% else %}
              <a href="/login" class="tag">Login</a>
            {% endif %}
          </div>
        </div>

        <main class="main" id="mainContent">
          <!-- Overview Section -->
          <div id="overview-section">
            <!-- Coverage Area with Interactive Map -->
            <div class="card">
              <div class="inner">
                <div class="coverage-title">
                  <span class="icon">üó∫Ô∏è</span>
                  Your Service Area: {{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }}
                </div>
                <div class="coverage-details" id="coverage-description">
                  Loading coverage details...
                </div>
                
                <!-- Interactive Map -->
                <div class="map-container" style="margin-top:12px">
                  <div id="serviceMap"></div>
                </div>
              </div>
            </div>

            <!-- Stat cards -->
            <div class="grid stats" style="margin-top:14px">
              <div class="card">
                <div class="inner">
                  <div class="metric">Today's Earnings</div>
                  <div class="value">‚Ç±{{ "%.2f"|format(earnings_today) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Deliveries Today</div>
                  <div class="value">{{ deliveries_today }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Rating</div>
                  <div class="value">{{ "%.1f"|format(rating) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Acceptance Rate</div>
                  <div class="value">{{ acceptance_rate }}%</div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Deliveries</div>
                  <a href="#" class="show-section" data-section="history" style="font-size:12px;color:var(--muted)">View History</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Route</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Earnings</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_deliveries and recent_deliveries|length > 0 %}
                        {% for delivery in recent_deliveries %}
                        <tr>
                          <td>#{{ delivery.order_number }}</td>
                          <td>{{ delivery.pickup_location or 'N/A' }} ‚Üí {{ delivery.delivery_location or 'N/A' }}</td>
                          <td>{{ delivery.delivered_at.strftime('%I:%M %p') if delivery.delivered_at else 'N/A' }}</td>
                          <td><span class="status {{ delivery.status }}">{{ delivery.status|title|replace('_', ' ') }}</span></td>
                          <td>‚Ç±{{ "%.2f"|format(delivery.total_amount * 0.15) }}</td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent deliveries</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Deliveries Section -->
          <div id="deliveries-section" style="display: none;">
            <!-- Available Orders Tab -->
            <div class="card" style="margin-bottom:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">Available Orders in Your Area</div>
                  <button onclick="loadAvailableOrders()" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer">üîÑ Refresh</button>
                </div>
                <div style="overflow:auto">
                  <table id="available-orders-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Amount</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading available orders...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- My Active Deliveries Tab -->
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">My Active Deliveries</div>
                  <div class="tag" style="background:#10b981;color:#fff" id="active-count">0 Active</div>
                </div>
                <div style="overflow:auto">
                  <table id="active-deliveries-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Status</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading your deliveries...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="history-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Delivery History</div>
                  <div class="tag" style="background:#efefef;color:#0a0a0a">Last 30 Days</div>
                </div>
                <div style="overflow:auto">
                  <table id="history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Orders</th>
                        <th>Earnings</th>
                        <th>Rating</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings Section -->
          <div id="earnings-section" style="display: none;">
            <div class="grid stats">
              <div class="card">
                <div class="inner">
                  <div class="metric">Weekly Earnings</div>
                  <div class="value" id="weekly-earnings">‚Ç±0.00</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Monthly Earnings</div>
                  <div class="value" id="monthly-earnings">‚Ç±0.00</div>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div class="metric">Earnings Breakdown</div>
                <div style="overflow:auto">
                  <table id="earnings-breakdown-table">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Share</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="3" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Schedule Section -->
          <div id="schedule-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Your Schedule</div>
                  <div class="tag" style="background:#10b981;color:#fff">Online</div>
                </div>
                <div style="margin-top:20px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Today's Hours</div>
                    <div>8:00 AM - 5:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Break Time</div>
                    <div>12:00 PM - 1:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Area Coverage</div>
                    <div>Sta Cruz, Laguna</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ratings Section -->
          <div id="ratings-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Feedback</div>
                <div style="margin-top:20px">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
                    <div style="font-size:32px;font-weight:bold" id="overall-rating">4.5</div>
                    <div id="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <div style="color:var(--muted)" id="rating-count">(0 ratings)</div>
                  </div>
                  <table id="reviews-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Rating</th>
                        <th>Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Profile Information</div>
                <div style="margin-top:20px">
                  <div style="display:flex;gap:20px;margin-bottom:20px">
                    <div style="position:relative;width:100px;height:100px">
                      <img id="profileImage" 
                           src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                           alt="Profile" 
                           style="width:100px;height:100px;border-radius:50%;object-fit:cover;background:#efefef;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.1)"
                           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
                      <label for="profileImageInput" 
                             style="position:absolute;bottom:0;right:0;background:#0a0a0a;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);font-size:16px"
                             title="Upload profile photo">
                        üì∑
                      </label>
                      <input type="file" 
                             id="profileImageInput" 
                             accept="image/*" 
                             style="display:none" 
                             onchange="uploadProfileImage(this)">
                    </div>
                    <div>
                      <div style="font-size:20px;font-weight:bold">{{ rider_name }}</div>
                      <div style="color:var(--muted)">{{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }} Rider</div>
                      <div style="margin-top:10px">
                        <span class="tag" style="background:#efefef;color:#0a0a0a">Motorcycle</span>
                        <span class="tag" style="background:#efefef;color:#0a0a0a">2+ Years</span>
                      </div>
                    </div>
                  </div>
                  <div style="display:grid;gap:10px">
                    <div style="display:flex;justify-content:space-between">
                      <div>Vehicle Type</div>
                      <div>{{ rider.vehicle_type|title if rider and rider.vehicle_type else 'Not specified' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>License Number</div>
                      <div>{{ rider.license_number if rider and rider.license_number else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Contact Number</div>
                      <div>{{ user.phone if user and user.phone else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Email</div>
                      <div>{{ user.email if user and user.email else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Total Deliveries</div>
                      <div>{{ total_deliveries }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </main>
      </section>
    </div>
    <style>
      /* Hide all sections by default */
      [id$="-section"] {
        display: none;
      }
      /* Show overview section by default */
      #overview-section {
        display: block;
      }
    </style>

    <script>
      // Region coordinates mapping - organized by major geographic areas
      const regionCoordinates = {
        // ===== NORTH LUZON =====
        // Cordillera Administrative Region (CAR)
        'baguio': { center: [16.4023, 120.5960], zoom: 11, radius: 18000, displayName: 'Baguio City (North Luzon - CAR)' },
        'baguio city': { center: [16.4023, 120.5960], zoom: 11, radius: 18000, displayName: 'Baguio City (North Luzon - CAR)' },
        
        // Ilocos Region
        'laoag': { center: [18.1987, 120.5937], zoom: 11, radius: 15000, displayName: 'Laoag City (North Luzon - Region I)' },
        'vigan': { center: [17.5747, 120.3869], zoom: 11, radius: 12000, displayName: 'Vigan City (North Luzon - Region I)' },
        
        // Cagayan Valley
        'tuguegarao': { center: [17.6132, 121.7270], zoom: 11, radius: 18000, displayName: 'Tuguegarao City (North Luzon - Region II)' },
        'santiago': { center: [16.6875, 121.5468], zoom: 11, radius: 15000, displayName: 'Santiago City (North Luzon - Region II)' },
        
        // ===== CENTRAL LUZON =====
        // Metro Manila (NCR)
        'manila': { center: [14.5995, 120.9842], zoom: 11, radius: 20000, displayName: 'Manila (Central Luzon - NCR)' },
        'quezon city': { center: [14.6760, 121.0437], zoom: 10, radius: 30000, displayName: 'Quezon City (Central Luzon - NCR)' },
        'makati': { center: [14.5547, 121.0244], zoom: 11, radius: 18000, displayName: 'Makati (Central Luzon - NCR)' },
        'pasig': { center: [14.5764, 121.0851], zoom: 11, radius: 18000, displayName: 'Pasig City (Central Luzon - NCR)' },
        'taguig': { center: [14.5176, 121.0509], zoom: 11, radius: 20000, displayName: 'Taguig City (Central Luzon - NCR)' },
        'mandaluyong': { center: [14.5794, 121.0359], zoom: 12, radius: 12000, displayName: 'Mandaluyong (Central Luzon - NCR)' },
        'paranaque': { center: [14.4793, 121.0198], zoom: 11, radius: 18000, displayName: 'Para√±aque (Central Luzon - NCR)' },
        'las pinas': { center: [14.4453, 120.9820], zoom: 11, radius: 18000, displayName: 'Las Pi√±as (Central Luzon - NCR)' },
        'muntinlupa': { center: [14.3833, 121.0333], zoom: 11, radius: 18000, displayName: 'Muntinlupa (Central Luzon - NCR)' },
        'caloocan': { center: [14.6500, 120.9833], zoom: 11, radius: 20000, displayName: 'Caloocan City (Central Luzon - NCR)' },
        'valenzuela': { center: [14.7000, 120.9833], zoom: 11, radius: 18000, displayName: 'Valenzuela City (Central Luzon - NCR)' },
        'malabon': { center: [14.6604, 120.9570], zoom: 12, radius: 12000, displayName: 'Malabon City (Central Luzon - NCR)' },
        'navotas': { center: [14.6617, 120.9408], zoom: 12, radius: 10000, displayName: 'Navotas City (Central Luzon - NCR)' },
        'ncr': { center: [14.5995, 120.9842], zoom: 10, radius: 35000, displayName: 'Metro Manila (Central Luzon - NCR)' },
        
        // Central Luzon Region (Region III)
        'angeles': { center: [15.1450, 120.5887], zoom: 11, radius: 18000, displayName: 'Angeles City (Central Luzon - Region III)' },
        'san fernando': { center: [15.0290, 120.6897], zoom: 11, radius: 15000, displayName: 'San Fernando, Pampanga (Central Luzon - Region III)' },
        'olongapo': { center: [14.8294, 120.2828], zoom: 11, radius: 15000, displayName: 'Olongapo City (Central Luzon - Region III)' },
        'tarlac': { center: [15.4755, 120.5963], zoom: 11, radius: 18000, displayName: 'Tarlac City (Central Luzon - Region III)' },
        
        // ===== SOUTH LUZON =====
        // CALABARZON (Region IV-A)
        'santa cruz': { center: [14.2691, 121.4147], zoom: 11, radius: 15000, displayName: 'Santa Cruz, Laguna (South Luzon - CALABARZON)' },
        'santa cruz, laguna': { center: [14.2691, 121.4147], zoom: 11, radius: 15000, displayName: 'Santa Cruz, Laguna (South Luzon - CALABARZON)' },
        'calamba': { center: [14.2117, 121.1653], zoom: 11, radius: 18000, displayName: 'Calamba, Laguna (South Luzon - CALABARZON)' },
        'los ba√±os': { center: [14.1697, 121.2408], zoom: 11, radius: 15000, displayName: 'Los Ba√±os, Laguna (South Luzon - CALABARZON)' },
        'san pablo': { center: [14.0681, 121.3260], zoom: 11, radius: 20000, displayName: 'San Pablo, Laguna (South Luzon - CALABARZON)' },
        'bi√±an': { center: [14.3364, 121.0823], zoom: 11, radius: 15000, displayName: 'Bi√±an, Laguna (South Luzon - CALABARZON)' },
        'cabuyao': { center: [14.2780, 121.1230], zoom: 11, radius: 15000, displayName: 'Cabuyao, Laguna (South Luzon - CALABARZON)' },
        'batangas': { center: [13.7565, 121.0583], zoom: 11, radius: 18000, displayName: 'Batangas City (South Luzon - CALABARZON)' },
        'lipa': { center: [13.9411, 121.1650], zoom: 11, radius: 18000, displayName: 'Lipa City (South Luzon - CALABARZON)' },
        'lucena': { center: [13.9372, 121.6176], zoom: 11, radius: 18000, displayName: 'Lucena City (South Luzon - CALABARZON)' },
        'antipolo': { center: [14.5864, 121.1755], zoom: 11, radius: 20000, displayName: 'Antipolo City (South Luzon - CALABARZON)' },
        'cavite': { center: [14.2456, 120.8782], zoom: 11, radius: 20000, displayName: 'Cavite City (South Luzon - CALABARZON)' },
        'bacoor': { center: [14.4598, 120.9414], zoom: 11, radius: 15000, displayName: 'Bacoor, Cavite (South Luzon - CALABARZON)' },
        'imus': { center: [14.4297, 120.9367], zoom: 11, radius: 15000, displayName: 'Imus, Cavite (South Luzon - CALABARZON)' },
        'dasmarinas': { center: [14.3294, 120.9367], zoom: 11, radius: 18000, displayName: 'Dasmari√±as, Cavite (South Luzon - CALABARZON)' },
        
        // MIMAROPA (Region IV-B)
        'puerto princesa': { center: [9.7392, 118.7353], zoom: 11, radius: 25000, displayName: 'Puerto Princesa (South Luzon - MIMAROPA)' },
        'calapan': { center: [13.4117, 121.1803], zoom: 11, radius: 15000, displayName: 'Calapan City (South Luzon - MIMAROPA)' },
        
        // Bicol Region (Region V)
        'legazpi': { center: [13.1391, 123.7437], zoom: 11, radius: 20000, displayName: 'Legazpi City (South Luzon - Bicol)' },
        'legazpi city': { center: [13.1391, 123.7437], zoom: 11, radius: 20000, displayName: 'Legazpi City (South Luzon - Bicol)' },
        'naga': { center: [13.6192, 123.1814], zoom: 11, radius: 18000, displayName: 'Naga City (South Luzon - Bicol)' },
        'naga city': { center: [13.6192, 123.1814], zoom: 11, radius: 18000, displayName: 'Naga City (South Luzon - Bicol)' },
        'albay': { center: [13.1391, 123.7437], zoom: 10, radius: 30000, displayName: 'Albay Province (South Luzon - Bicol)' },
        'sorsogon': { center: [12.9736, 124.0047], zoom: 11, radius: 18000, displayName: 'Sorsogon City (South Luzon - Bicol)' },
        
        // ===== VISAYAS =====
        // Western Visayas (Region VI)
        'iloilo': { center: [10.7202, 122.5621], zoom: 11, radius: 20000, displayName: 'Iloilo City (Visayas - Region VI)' },
        'iloilo city': { center: [10.7202, 122.5621], zoom: 11, radius: 20000, displayName: 'Iloilo City (Visayas - Region VI)' },
        'bacolod': { center: [10.6760, 122.9500], zoom: 11, radius: 20000, displayName: 'Bacolod City (Visayas - Region VI)' },
        'roxas': { center: [11.5854, 122.7510], zoom: 11, radius: 15000, displayName: 'Roxas City (Visayas - Region VI)' },
        
        // Central Visayas (Region VII)
        'cebu': { center: [10.3157, 123.8854], zoom: 10, radius: 25000, displayName: 'Cebu City (Visayas - Region VII)' },
        'cebu city': { center: [10.3157, 123.8854], zoom: 10, radius: 25000, displayName: 'Cebu City (Visayas - Region VII)' },
        'mandaue': { center: [10.3237, 123.9227], zoom: 11, radius: 18000, displayName: 'Mandaue City (Visayas - Region VII)' },
        'lapu-lapu': { center: [10.3103, 123.9494], zoom: 11, radius: 15000, displayName: 'Lapu-Lapu City (Visayas - Region VII)' },
        'tagbilaran': { center: [9.6478, 123.8533], zoom: 11, radius: 15000, displayName: 'Tagbilaran City (Visayas - Region VII)' },
        'dumaguete': { center: [9.3068, 123.3054], zoom: 11, radius: 15000, displayName: 'Dumaguete City (Visayas - Region VII)' },
        
        // Eastern Visayas (Region VIII)
        'tacloban': { center: [11.2447, 125.0038], zoom: 11, radius: 18000, displayName: 'Tacloban City (Visayas - Region VIII)' },
        'ormoc': { center: [11.0059, 124.6074], zoom: 11, radius: 15000, displayName: 'Ormoc City (Visayas - Region VIII)' },
        
        // ===== MINDANAO =====
        // Zamboanga Peninsula (Region IX)
        'zamboanga': { center: [6.9214, 122.0790], zoom: 11, radius: 25000, displayName: 'Zamboanga City (Mindanao - Region IX)' },
        'zamboanga city': { center: [6.9214, 122.0790], zoom: 11, radius: 25000, displayName: 'Zamboanga City (Mindanao - Region IX)' },
        'pagadian': { center: [7.8250, 123.4353], zoom: 11, radius: 15000, displayName: 'Pagadian City (Mindanao - Region IX)' },
        
        // Northern Mindanao (Region X)
        'cagayan de oro': { center: [8.4542, 124.6319], zoom: 11, radius: 20000, displayName: 'Cagayan de Oro (Mindanao - Region X)' },
        'cdo': { center: [8.4542, 124.6319], zoom: 11, radius: 20000, displayName: 'Cagayan de Oro (Mindanao - Region X)' },
        'iligan': { center: [8.2280, 124.2452], zoom: 11, radius: 18000, displayName: 'Iligan City (Mindanao - Region X)' },
        
        // Davao Region (Region XI)
        'davao': { center: [7.0731, 125.6128], zoom: 10, radius: 35000, displayName: 'Davao City (Mindanao - Region XI)' },
        'davao city': { center: [7.0731, 125.6128], zoom: 10, radius: 35000, displayName: 'Davao City (Mindanao - Region XI)' },
        'tagum': { center: [7.4479, 125.8078], zoom: 11, radius: 18000, displayName: 'Tagum City (Mindanao - Region XI)' },
        'panabo': { center: [7.3068, 125.6838], zoom: 11, radius: 15000, displayName: 'Panabo City (Mindanao - Region XI)' },
        'digos': { center: [6.7497, 125.3569], zoom: 11, radius: 15000, displayName: 'Digos City (Mindanao - Region XI)' },
        
        // SOCCSKSARGEN (Region XII)
        'general santos': { center: [6.1164, 125.1716], zoom: 11, radius: 20000, displayName: 'General Santos City (Mindanao - Region XII)' },
        'koronadal': { center: [6.5008, 124.8461], zoom: 11, radius: 15000, displayName: 'Koronadal City (Mindanao - Region XII)' },
        
        // Caraga (Region XIII)
        'butuan': { center: [8.9475, 125.5406], zoom: 11, radius: 18000, displayName: 'Butuan City (Mindanao - Region XIII)' },
        
        // BARMM
        'cotabato': { center: [7.2233, 124.2461], zoom: 11, radius: 18000, displayName: 'Cotabato City (Mindanao - BARMM)' },
        
        // ===== REGIONAL DEFAULTS =====
        'north luzon': { center: [16.4023, 120.5960], zoom: 6, radius: 250000, displayName: 'North Luzon Region' },
        'central luzon': { center: [14.5995, 120.9842], zoom: 6, radius: 180000, displayName: 'Central Luzon Region' },
        'south luzon': { center: [13.5, 121.5], zoom: 6, radius: 250000, displayName: 'South Luzon Region' },
        'visayas': { center: [10.3157, 123.8854], zoom: 6, radius: 300000, displayName: 'Visayas Region' },
        'mindanao': { center: [7.5, 125.0], zoom: 6, radius: 350000, displayName: 'Mindanao Region' },
        'calabarzon': { center: [14.2691, 121.4147], zoom: 9, radius: 50000, displayName: 'CALABARZON Region' },
        'region i': { center: [17.5, 120.5], zoom: 9, radius: 50000, displayName: 'Ilocos Region (I)' },
        'region ii': { center: [17.5, 121.5], zoom: 9, radius: 50000, displayName: 'Cagayan Valley (II)' },
        'region iii': { center: [15.0, 120.5], zoom: 9, radius: 50000, displayName: 'Central Luzon (III)' },
        'region v': { center: [13.1391, 123.7437], zoom: 9, radius: 50000, displayName: 'Bicol Region (V)' },
        'region vi': { center: [10.7202, 122.5621], zoom: 9, radius: 50000, displayName: 'Western Visayas (VI)' },
        'region vii': { center: [10.3157, 123.8854], zoom: 9, radius: 50000, displayName: 'Central Visayas (VII)' },
        'region viii': { center: [11.2447, 125.0038], zoom: 9, radius: 50000, displayName: 'Eastern Visayas (VIII)' },
        'region ix': { center: [6.9214, 122.0790], zoom: 9, radius: 50000, displayName: 'Zamboanga Peninsula (IX)' },
        'region x': { center: [8.4542, 124.6319], zoom: 9, radius: 50000, displayName: 'Northern Mindanao (X)' },
        'region xi': { center: [7.0731, 125.6128], zoom: 9, radius: 50000, displayName: 'Davao Region (XI)' },
        'region xii': { center: [6.5, 125.0], zoom: 9, radius: 50000, displayName: 'SOCCSKSARGEN (XII)' },
        'region xiii': { center: [8.9475, 125.5406], zoom: 9, radius: 50000, displayName: 'Caraga (XIII)' }
      };

      // Warehouse locations organized by geographic area - case insensitive keys
      const warehouses = {
        // NORTH LUZON Warehouses
        'baguio': [
          { name: 'Baguio Main Warehouse', coords: [16.4023, 120.5960], type: 'main' },
          { name: 'Session Road Distribution', coords: [16.4100, 120.5980], type: 'distribution' }
        ],
        'laoag': [
          { name: 'Laoag Main Hub', coords: [18.1987, 120.5937], type: 'main' }
        ],
        'tuguegarao': [
          { name: 'Tuguegarao Warehouse', coords: [17.6132, 121.7270], type: 'main' }
        ],
        
        // CENTRAL LUZON Warehouses
        'manila': [
          { name: 'Manila Main Hub', coords: [14.6042, 120.9822], type: 'main' },
          { name: 'Divisoria Storage', coords: [14.6008, 120.9756], type: 'storage' }
        ],
        'quezon city': [
          { name: 'Quezon City Main Warehouse', coords: [14.6760, 121.0437], type: 'main' },
          { name: 'Cubao Distribution Hub', coords: [14.6190, 121.0556], type: 'distribution' }
        ],
        'makati': [
          { name: 'Makati Central Warehouse', coords: [14.5547, 121.0244], type: 'main' },
          { name: 'BGC Storage Facility', coords: [14.5520, 121.0472], type: 'storage' }
        ],
        'pasig': [
          { name: 'Pasig Main Warehouse', coords: [14.5764, 121.0851], type: 'main' }
        ],
        'taguig': [
          { name: 'Taguig Distribution Hub', coords: [14.5176, 121.0509], type: 'main' }
        ],
        'ncr': [
          { name: 'Manila Main Hub', coords: [14.6042, 120.9822], type: 'main' },
          { name: 'Quezon City Warehouse', coords: [14.6760, 121.0437], type: 'distribution' }
        ],
        'angeles': [
          { name: 'Angeles City Warehouse', coords: [15.1450, 120.5887], type: 'main' }
        ],
        'san fernando': [
          { name: 'San Fernando Pampanga Hub', coords: [15.0290, 120.6897], type: 'main' }
        ],
        
        // SOUTH LUZON Warehouses
        'santa cruz': [
          { name: 'Var√≥n Main Warehouse', coords: [14.2741, 121.4097], type: 'main' },
          { name: 'Patimbao Distribution Hub', coords: [14.2850, 121.4200], type: 'distribution' },
          { name: 'Poblacion Storage', coords: [14.2680, 121.4160], type: 'storage' }
        ],
        'calamba': [
          { name: 'Calamba Central Warehouse', coords: [14.2150, 121.1700], type: 'main' },
          { name: 'PEZA Distribution Center', coords: [14.2080, 121.1620], type: 'distribution' }
        ],
        'batangas': [
          { name: 'Batangas Main Warehouse', coords: [13.7565, 121.0583], type: 'main' }
        ],
        'lipa': [
          { name: 'Lipa City Hub', coords: [13.9411, 121.1650], type: 'main' }
        ],
        'lucena': [
          { name: 'Lucena Distribution Center', coords: [13.9372, 121.6176], type: 'main' }
        ],
        'antipolo': [
          { name: 'Antipolo Warehouse', coords: [14.5864, 121.1755], type: 'main' }
        ],
        'cavite': [
          { name: 'Cavite Main Hub', coords: [14.2456, 120.8782], type: 'main' }
        ],
        'bacoor': [
          { name: 'Bacoor Distribution', coords: [14.4598, 120.9414], type: 'main' }
        ],
        'legazpi': [
          { name: 'Legazpi Main Warehouse', coords: [13.1450, 123.7450], type: 'main' },
          { name: 'Albay Distribution Hub', coords: [13.1300, 123.7350], type: 'distribution' }
        ],
        'albay': [
          { name: 'Legazpi Main Warehouse', coords: [13.1450, 123.7450], type: 'main' },
          { name: 'Albay Distribution Hub', coords: [13.1300, 123.7350], type: 'distribution' }
        ],
        'naga': [
          { name: 'Naga Main Warehouse', coords: [13.6192, 123.1814], type: 'main' },
          { name: 'Naga Distribution', coords: [13.6250, 123.1900], type: 'distribution' }
        ],
        
        // VISAYAS Warehouses
        'cebu': [
          { name: 'Cebu Main Warehouse', coords: [10.3200, 123.8900], type: 'main' },
          { name: 'IT Park Storage', coords: [10.3186, 123.8950], type: 'storage' }
        ],
        'cebu city': [
          { name: 'Cebu Main Warehouse', coords: [10.3200, 123.8900], type: 'main' },
          { name: 'Mandaue Distribution Hub', coords: [10.3237, 123.9227], type: 'distribution' }
        ],
        'mandaue': [
          { name: 'Mandaue Distribution Hub', coords: [10.3237, 123.9227], type: 'main' }
        ],
        'iloilo': [
          { name: 'Iloilo Central Warehouse', coords: [10.7202, 122.5621], type: 'main' },
          { name: 'Jaro Distribution Center', coords: [10.7300, 122.5450], type: 'distribution' }
        ],
        'bacolod': [
          { name: 'Bacolod Central Warehouse', coords: [10.6760, 122.9500], type: 'main' }
        ],
        'tacloban': [
          { name: 'Tacloban Main Hub', coords: [11.2447, 125.0038], type: 'main' }
        ],
        'dumaguete': [
          { name: 'Dumaguete Warehouse', coords: [9.3068, 123.3054], type: 'main' }
        ],
        
        // MINDANAO Warehouses
        'davao': [
          { name: 'Davao Main Warehouse', coords: [7.0780, 125.6120], type: 'main' },
          { name: 'Matina Distribution Center', coords: [7.0645, 125.6050], type: 'distribution' },
          { name: 'Toril Storage Hub', coords: [7.0100, 125.5050], type: 'storage' }
        ],
        'davao city': [
          { name: 'Davao Main Warehouse', coords: [7.0780, 125.6120], type: 'main' },
          { name: 'Matina Distribution Center', coords: [7.0645, 125.6050], type: 'distribution' }
        ],
        'cagayan de oro': [
          { name: 'CDO Main Warehouse', coords: [8.4542, 124.6319], type: 'main' },
          { name: 'Carmen Distribution Hub', coords: [8.4700, 124.6200], type: 'distribution' }
        ],
        'cdo': [
          { name: 'CDO Main Warehouse', coords: [8.4542, 124.6319], type: 'main' }
        ],
        'zamboanga': [
          { name: 'Zamboanga Main Hub', coords: [6.9214, 122.0790], type: 'main' },
          { name: 'Zamboanga Distribution', coords: [6.9300, 122.0850], type: 'distribution' }
        ],
        'general santos': [
          { name: 'General Santos Warehouse', coords: [6.1164, 125.1716], type: 'main' }
        ],
        'butuan': [
          { name: 'Butuan Main Hub', coords: [8.9475, 125.5406], type: 'main' }
        ],
        'iligan': [
          { name: 'Iligan Distribution Center', coords: [8.2280, 124.2452], type: 'main' }
        ],
        
        // REGIONAL WAREHOUSE CONSOLIDATIONS
        'north luzon': [
          { name: 'Baguio Main Warehouse', coords: [16.4023, 120.5960], type: 'main' },
          { name: 'Laoag Main Hub', coords: [18.1987, 120.5937], type: 'main' },
          { name: 'Tuguegarao Warehouse', coords: [17.6132, 121.7270], type: 'main' },
          { name: 'Vigan Distribution', coords: [17.5747, 120.3869], type: 'distribution' },
          { name: 'Santiago Hub', coords: [16.6875, 121.5468], type: 'distribution' }
        ],
        'central luzon': [
          { name: 'Manila Main Hub', coords: [14.6042, 120.9822], type: 'main' },
          { name: 'Quezon City Main Warehouse', coords: [14.6760, 121.0437], type: 'main' },
          { name: 'Makati Central Warehouse', coords: [14.5547, 121.0244], type: 'main' },
          { name: 'Angeles City Warehouse', coords: [15.1450, 120.5887], type: 'main' },
          { name: 'Cubao Distribution Hub', coords: [14.6190, 121.0556], type: 'distribution' },
          { name: 'BGC Storage Facility', coords: [14.5520, 121.0472], type: 'storage' },
          { name: 'Pasig Warehouse', coords: [14.5764, 121.0851], type: 'distribution' },
          { name: 'San Fernando Pampanga Hub', coords: [15.0290, 120.6897], type: 'distribution' }
        ],
        'south luzon': [
          { name: 'Var√≥n Main Warehouse (Santa Cruz)', coords: [14.2741, 121.4097], type: 'main' },
          { name: 'Calamba Central Warehouse', coords: [14.2150, 121.1700], type: 'main' },
          { name: 'Batangas Main Warehouse', coords: [13.7565, 121.0583], type: 'main' },
          { name: 'Legazpi Main Warehouse', coords: [13.1450, 123.7450], type: 'main' },
          { name: 'Naga Main Warehouse', coords: [13.6192, 123.1814], type: 'main' },
          { name: 'Lipa City Hub', coords: [13.9411, 121.1650], type: 'distribution' },
          { name: 'Lucena Distribution Center', coords: [13.9372, 121.6176], type: 'distribution' },
          { name: 'Antipolo Warehouse', coords: [14.5864, 121.1755], type: 'distribution' },
          { name: 'Cavite Main Hub', coords: [14.2456, 120.8782], type: 'distribution' },
          { name: 'Patimbao Distribution Hub', coords: [14.2850, 121.4200], type: 'storage' }
        ],
        'visayas': [
          { name: 'Cebu Main Warehouse', coords: [10.3200, 123.8900], type: 'main' },
          { name: 'Iloilo Central Warehouse', coords: [10.7202, 122.5621], type: 'main' },
          { name: 'Bacolod Central Warehouse', coords: [10.6760, 122.9500], type: 'main' },
          { name: 'Tacloban Main Hub', coords: [11.2447, 125.0038], type: 'main' },
          { name: 'Mandaue Distribution Hub', coords: [10.3237, 123.9227], type: 'distribution' },
          { name: 'Dumaguete Warehouse', coords: [9.3068, 123.3054], type: 'distribution' },
          { name: 'Jaro Distribution Center', coords: [10.7300, 122.5450], type: 'storage' }
        ],
        'mindanao': [
          { name: 'Davao Main Warehouse', coords: [7.0780, 125.6120], type: 'main' },
          { name: 'CDO Main Warehouse', coords: [8.4542, 124.6319], type: 'main' },
          { name: 'Zamboanga Main Hub', coords: [6.9214, 122.0790], type: 'main' },
          { name: 'General Santos Warehouse', coords: [6.1164, 125.1716], type: 'main' },
          { name: 'Butuan Main Hub', coords: [8.9475, 125.5406], type: 'main' },
          { name: 'Matina Distribution Center', coords: [7.0645, 125.6050], type: 'distribution' },
          { name: 'Carmen Distribution Hub', coords: [8.4700, 124.6200], type: 'distribution' },
          { name: 'Iligan Distribution Center', coords: [8.2280, 124.2452], type: 'distribution' },
          { name: 'Toril Storage Hub', coords: [7.0100, 125.5050], type: 'storage' }
        ]
      };

      // Initialize Interactive Map based on rider's region
      function initializeMap() {
        // Check if Leaflet is loaded
        if (typeof L === 'undefined') {
          console.error('Leaflet library not loaded');
          return;
        }
        
        // Check if map container exists
        const mapContainer = document.getElementById('serviceMap');
        if (!mapContainer) {
          console.error('Map container not found');
          return;
        }
        
        // Get rider's service area from template
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "North Luzon" }}';
        console.log('Service Area from DB:', serviceAreaText);
        
        // Normalize the service area text for matching
        const normalizedArea = serviceAreaText.toLowerCase().trim();
        
        // Find matching region coordinates with improved matching
        let regionConfig = null;
        let matchedKey = null;
        
        // First try exact match
        for (const [region, config] of Object.entries(regionCoordinates)) {
          if (normalizedArea === region.toLowerCase()) {
            regionConfig = config;
            matchedKey = region;
            console.log('Exact match:', region);
            break;
          }
        }
        
        // If no exact match, try partial match with better logic
        if (!regionConfig) {
          // Remove common suffixes for better matching
          const areaBase = normalizedArea.replace(/, ?(city|laguna|philippines|ph|region \w+)$/gi, '').trim();
          
          for (const [region, config] of Object.entries(regionCoordinates)) {
            const regionLower = region.toLowerCase();
            
            // Check if the base area matches the region key
            if (areaBase === regionLower || areaBase.includes(regionLower) || regionLower.includes(areaBase)) {
              regionConfig = config;
              matchedKey = region;
              console.log('Partial match:', region, 'for area:', serviceAreaText);
              break;
            }
          }
        }
        
        // Default to North Luzon if no match found
        if (!regionConfig) {
          console.warn('No region match found for:', serviceAreaText, '- using default North Luzon');
          regionConfig = regionCoordinates['north luzon'];
          matchedKey = 'north luzon';
        }
        
        console.log('Final matched region:', matchedKey, 'Config:', regionConfig);
        
        try {
          // Initialize the map with region-specific settings
          const map = L.map('serviceMap').setView(regionConfig.center, regionConfig.zoom);
          
          // Add OpenStreetMap tile layer
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19
          }).addTo(map);
          
          // Define service area boundaries with region-specific radius
          const serviceArea = L.circle(regionConfig.center, {
            color: '#10b981',
            fillColor: '#10b981',
            fillOpacity: 0.15,
            radius: regionConfig.radius
          }).addTo(map);
          
          // Add warehouse markers based on region (case-insensitive matching)
          const normalizedAreaKey = normalizedArea.replace(/,.*$/,'').trim(); // Remove everything after comma
          let regionWarehouses = null;
          
          // Try to find matching warehouses
          for (const [warehouseKey, warehouseList] of Object.entries(warehouses)) {
            if (normalizedAreaKey.includes(warehouseKey.toLowerCase()) || warehouseKey.toLowerCase().includes(normalizedAreaKey)) {
              regionWarehouses = warehouseList;
              console.log('Matched warehouses for:', warehouseKey);
              break;
            }
          }
          
          // Default to Baguio warehouses if no match (North Luzon)
          if (!regionWarehouses) {
            console.log('No warehouse match, using default Baguio warehouses');
            regionWarehouses = warehouses['baguio'] || [];
          }
          
          // Custom icons for different warehouse types
          const mainWarehouseIcon = L.divIcon({
            className: 'warehouse-marker',
            html: '<div style="background:#ef4444;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);font-size:18px;">üè≠</div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
          });
          
          const distributionIcon = L.divIcon({
            className: 'warehouse-marker',
            html: '<div style="background:#f59e0b;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:16px;">üì¶</div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14]
          });
          
          const storageIcon = L.divIcon({
            className: 'warehouse-marker',
            html: '<div style="background:#3b82f6;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);font-size:14px;">üè™</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });
          
          // Add warehouse markers
          regionWarehouses.forEach(warehouse => {
            let icon = storageIcon;
            let warehouseType = 'Storage Facility';
            
            if (warehouse.type === 'main') {
              icon = mainWarehouseIcon;
              warehouseType = 'Main Warehouse';
            } else if (warehouse.type === 'distribution') {
              icon = distributionIcon;
              warehouseType = 'Distribution Hub';
            }
            
            const marker = L.marker(warehouse.coords, { icon: icon }).addTo(map);
            marker.bindPopup(`
              <div style="font-family:Inter,sans-serif;">
                <strong style="font-size:14px;">${warehouse.name}</strong><br>
                <span style="color:#666;font-size:12px;">${warehouseType}</span><br>
                <span style="color:#10b981;font-size:11px;">‚úì Pickup Available</span>
              </div>
            `);
          });
          
          // Add center marker for service area
          const centerMarker = L.marker(regionConfig.center, {
            icon: L.divIcon({
              className: 'center-marker',
              html: '<div style="background:#0a0a0a;color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üìç ' + (regionConfig.displayName || serviceAreaText) + '</div>',
              iconSize: [120, 32],
              iconAnchor: [60, 16]
            })
          }).addTo(map);
          
          centerMarker.bindPopup(`<b>${regionConfig.displayName || serviceAreaText}</b><br>Your Service Area`);
          
          // Add scale control
          L.control.scale().addTo(map);
          
          // Add legend for warehouse types
          const legend = L.control({ position: 'bottomright' });
          legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
              <div style="background:white;padding:10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-family:Inter,sans-serif;">
                <div style="font-weight:600;margin-bottom:6px;font-size:11px;color:#666;">PICKUP LOCATIONS</div>
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px;">
                  <span style="font-size:14px;">üè≠</span> Main Warehouse
                </div>
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px;">
                  <span style="font-size:14px;">üì¶</span> Distribution Hub
                </div>
                <div style="display:flex;align-items:center;gap:6px;font-size:11px;">
                  <span style="font-size:14px;">üè™</span> Storage Facility
                </div>
              </div>
            `;
            return div;
          };
          legend.addTo(map);
          
          // Fix map size after initialization
          setTimeout(function() {
            map.invalidateSize();
          }, 250);
        
        } catch (error) {
          console.error('Error initializing map:', error);
          const mapContainer = document.getElementById('serviceMap');
          if (mapContainer) {
            mapContainer.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#999;font-size:14px;">Unable to load map. Please refresh the page.</div>';
          }
        }
      }
      
      // Simple function to switch between sections
      function switchSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('[id$="-section"]').forEach(section => {
          section.style.display = 'none';
        });
        
        // Show selected section
        const selectedSection = document.getElementById(sectionId + '-section');
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }
        
        // Update active state in sidebar
        document.querySelectorAll('.side-link').forEach(link => {
          link.classList.remove('active');
        });
        
        // Find and activate the clicked link
        const activeLink = Array.from(document.querySelectorAll('.side-link')).find(
          link => link.textContent.toLowerCase().includes(sectionId.toLowerCase())
        );
        if (activeLink) {
          activeLink.classList.add('active');
        }

        // Load deliveries when switching to deliveries section
        if (sectionId === 'deliveries') {
          loadAvailableOrders();
          loadMyActiveDeliveries();
        }
      }

      // Load available orders for delivery
      function loadAvailableOrders() {
        fetch('/api/rider/available-orders')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#available-orders-table tbody');
            if (data.success && data.orders && data.orders.length > 0) {
              tbody.innerHTML = data.orders
                .filter(order => order.shipment_status === 'pending')
                .map(order => {
                  const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                  const orderDate = new Date(order.created_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  });
                  return `
                    <tr>
                      <td>
                        <div style="font-weight:600">#${order.order_number}</div>
                        <div style="font-size:11px;color:#999">${orderDate}</div>
                      </td>
                      <td>
                        <div>${order.customer_name}</div>
                        <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                      </td>
                      <td style="max-width:200px">${order.delivery_address}</td>
                      <td style="font-weight:600">‚Ç±${parseFloat(order.total_amount).toFixed(2)}</td>
                      <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                      <td>
                        <button onclick="acceptOrder(${order.shipment_id})" 
                                class="tag" 
                                style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:8px 16px">
                          Accept
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">No available orders in your area</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading available orders:', error);
            document.querySelector('#available-orders-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading orders</td></tr>';
          });
      }

      // Load rider's active deliveries
      function loadMyActiveDeliveries() {
        fetch('/api/rider/active-deliveries')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#active-deliveries-table tbody');
            const activeOrders = data.deliveries || [];
            
            // Update count badge
            document.getElementById('active-count').textContent = `${activeOrders.length} Active`;
            
            if (activeOrders.length > 0) {
              tbody.innerHTML = activeOrders.map(order => {
                const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                const isAwaitingConfirmation = !order.seller_confirmed && order.shipment_status === 'pending';
                
                let statusDisplay, statusClass, actionButton;
                
                if (isAwaitingConfirmation) {
                  statusClass = 'pending';
                  statusDisplay = '‚è≥ AWAITING SELLER CONFIRMATION';
                  actionButton = `<span class="tag" style="background:#fef3c7;color:#92400e;padding:8px 16px">Waiting...</span>`;
                } else {
                  statusClass = order.shipment_status.replace('_', '-');
                  statusDisplay = order.shipment_status.replace('_', ' ').toUpperCase();
                  actionButton = `
                    <select onchange="updateDeliveryStatus(${order.shipment_id}, this.value)" 
                            class="tag" 
                            style="background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer;color:#0a0a0a">
                      <option value="">Update Status...</option>
                      <option value="in_transit">In Transit</option>
                      <option value="out_for_delivery">Out for Delivery</option>
                      <option value="delivered">Delivered ‚úì</option>
                      <option value="failed">Failed</option>
                    </select>
                  `;
                }
                
                return `
                  <tr>
                    <td>
                      <div style="font-weight:600">#${order.order_number}</div>
                    </td>
                    <td>
                      <div>${order.customer_name}</div>
                      <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                    </td>
                    <td style="max-width:200px">${order.delivery_address}</td>
                    <td>
                      <span class="status ${statusClass}">${statusDisplay}</span>
                    </td>
                    <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                    <td>
                      ${actionButton}
                    </td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">No active deliveries</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading active deliveries:', error);
            document.querySelector('#active-deliveries-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading deliveries</td></tr>';
          });
      }

      // Accept an order
      function acceptOrder(shipmentId) {
        if (!confirm('Accept this delivery order?')) return;
        
        fetch('/api/rider/accept-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ shipment_id: shipmentId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Order accepted! You can now start the delivery.');
            loadAvailableOrders();
            loadMyActiveDeliveries();
          } else {
            alert('Failed to accept order: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error accepting order:', error);
          alert('Error accepting order. Please try again.');
        });
      }

      // Update delivery status
      function updateDeliveryStatus(shipmentId, newStatus) {
        if (!newStatus) return;
        
        const statusText = newStatus.replace('_', ' ').toUpperCase();
        if (!confirm(`Update status to ${statusText}?`)) {
          // Reset the select dropdown
          event.target.value = '';
          return;
        }
        
        fetch('/api/rider/update-delivery-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            shipment_id: shipmentId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status updated successfully!');
            if (newStatus === 'delivered') {
              alert('üéâ Delivery completed! Your earnings have been updated.');
            }
            loadMyActiveDeliveries();
          } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
            event.target.value = '';
          }
        })
        .catch(error => {
          console.error('Error updating status:', error);
          alert('Error updating status. Please try again.');
          event.target.value = '';
        });
      }

      // Load delivery history from database
      function loadDeliveryHistory() {
        fetch('/api/rider/delivery-history')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#history-table tbody');
            if (data.success && data.history && data.history.length > 0) {
              tbody.innerHTML = data.history.map(day => {
                const date = new Date(day.delivery_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const rating = day.avg_rating ? parseFloat(day.avg_rating).toFixed(1) : '5.0';
                return `
                  <tr>
                    <td>${date}</td>
                    <td>${day.order_count} deliveries</td>
                    <td>‚Ç±${parseFloat(day.daily_earnings).toFixed(2)}</td>
                    <td>${rating} ‚≠ê</td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No delivery history found</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading delivery history:', error);
            document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading history</td></tr>';
          });
      }

      // Load earnings data from database
      function loadEarnings() {
        fetch('/api/rider/earnings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update weekly and monthly earnings
              document.getElementById('weekly-earnings').textContent = '‚Ç±' + parseFloat(data.weekly_earnings).toFixed(2);
              document.getElementById('monthly-earnings').textContent = '‚Ç±' + parseFloat(data.monthly_earnings).toFixed(2);
              
              // Update earnings breakdown
              const tbody = document.querySelector('#earnings-breakdown-table tbody');
              tbody.innerHTML = `
                <tr>
                  <td>Base Fare</td>
                  <td>‚Ç±${parseFloat(data.breakdown.base_fare).toFixed(2)}</td>
                  <td>70%</td>
                </tr>
                <tr>
                  <td>Tips</td>
                  <td>‚Ç±${parseFloat(data.breakdown.tips).toFixed(2)}</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td>Bonuses</td>
                  <td>‚Ç±${parseFloat(data.breakdown.bonuses).toFixed(2)}</td>
                  <td>10%</td>
                </tr>
              `;
            } else {
              document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999">No earnings data available</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading earnings:', error);
            document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ef4444">Error loading earnings</td></tr>';
          });
      }

      // Load ratings and reviews from database
      function loadRatings() {
        fetch('/api/rider/ratings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update overall rating
              const rating = parseFloat(data.overall_rating).toFixed(1);
              document.getElementById('overall-rating').textContent = rating;
              
              // Generate stars based on rating
              const fullStars = Math.floor(data.overall_rating);
              const stars = '‚≠ê'.repeat(fullStars);
              document.getElementById('rating-stars').textContent = stars;
              
              // Update rating count
              document.getElementById('rating-count').textContent = `(${data.total_ratings} ratings)`;
              
              // Update reviews table
              const tbody = document.querySelector('#reviews-table tbody');
              if (data.reviews && data.reviews.length > 0) {
                tbody.innerHTML = data.reviews.map(review => {
                  const date = new Date(review.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  const stars = '‚≠ê'.repeat(review.rating);
                  return `
                    <tr>
                      <td>${date}</td>
                      <td>${review.customer_name}</td>
                      <td>${stars}</td>
                      <td>${review.comment || 'No comment'}</td>
                    </tr>
                  `;
                }).join('');
              } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No reviews yet</td></tr>';
              }
            }
          })
          .catch(error => {
            console.error('Error loading ratings:', error);
            document.querySelector('#reviews-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading reviews</td></tr>';
          });
      }

      // Region-specific coverage data - Updated for major regions
      const regionCoverage = {
        'North Luzon': {
          description: 'Serving all of North Luzon including CAR (Baguio), Ilocos Region, and Cagayan Valley areas'
        },
        'Central Luzon': {
          description: 'Serving Metro Manila (NCR) and Central Luzon (Region III) including all cities and municipalities'
        },
        'South Luzon': {
          description: 'Serving South Luzon including CALABARZON, MIMAROPA, and Bicol Region areas'
        },
        'Visayas': {
          description: 'Serving all Visayas regions including Western, Central, and Eastern Visayas'
        },
        'Mindanao': {
          description: 'Serving all Mindanao regions including Davao, Northern Mindanao, Zamboanga, and other areas'
        }
      };

      // Update coverage details based on rider's region
      function updateCoverageDetails() {
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "South Luzon" }}';
        console.log('Service Area from DB:', serviceAreaText);
        
        // Find matching region coverage
        const coverage = regionCoverage[serviceAreaText] || regionCoverage['South Luzon'];
        
        // Update description
        document.getElementById('coverage-description').textContent = coverage.description;
        
        console.log('Coverage updated for region:', serviceAreaText);
      }

      // Upload profile image
      function uploadProfileImage(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image size must be less than 5MB.');
          return;
        }
        
        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to server
        const formData = new FormData();
        formData.append('profile_image', file);
        
        fetch('/api/rider/upload-profile-image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Profile image updated successfully!');
          } else {
            alert('Failed to upload image: ' + (data.error || 'Unknown error'));
            // Reload to show original image
            location.reload();
          }
        })
        .catch(error => {
          console.error('Error uploading image:', error);
          alert('Error uploading image. Please try again.');
          // Reload to show original image
          location.reload();
        });
      }

      // Initialize the dashboard
      document.addEventListener('DOMContentLoaded', function() {
        // Show overview section by default
        document.getElementById('overview-section').style.display = 'block';
        
        // Update coverage details based on region
        updateCoverageDetails();
        
        // Initialize the map with region-specific settings after a short delay
        // This ensures the DOM is fully rendered
        setTimeout(function() {
          initializeMap();
        }, 100);
        
        // Load data from database
        loadDeliveryHistory();
        loadEarnings();
        loadRatings();
        
        // Add click handler for "View History" link
        document.querySelectorAll('.show-section').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
              switchSection(section);
            }
          });
        });
        
        // Add click handlers to all sidebar links as backup
        document.querySelectorAll('.side-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Extract section from onclick attribute or text
            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {
              // Extract section name from onclick="switchSection('section'); return false;"
              const match = onclickAttr.match(/switchSection\('(.+?)'\)/);
              if (match && match[1]) {
                switchSection(match[1]);
              }
            }
          });
        });
        
        console.log('Rider Dashboard initialized');
      });
    </script>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>
