<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rider Dashboard ‚Äî Var√≥n</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .logo .dot{width:10px;height:10px;border-radius:999px;background:#4ade80}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer;user-select:none}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:var(--success);margin-left:8px}
      .delta.down{color:var(--error)}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Status tags */
      .status{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:12px}
      .status.pending{background:#fef3c7;color:#92400e}
      .status.in-transit{background:#dbeafe;color:#1e40af}
      .status.delivered{background:#dcfce7;color:#15803d}
      .status.cancelled{background:#fee2e2;color:#991b1b}

      /* Map container */
      .map-container{height:400px;background:#f3f4f6;border-radius:8px;position:relative;overflow:hidden;border:1px solid var(--line)}
      #serviceMap{height:100%;width:100%;z-index:1}

      /* Area coverage section */
      .coverage-area{margin-top:14px;padding:14px;background:#f8fafc;border-radius:8px}
      .coverage-title{font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
      .coverage-title .icon{font-size:20px}
      .coverage-details{color:var(--muted);font-size:14px;line-height:1.6}
      .coverage-list{list-style:none;padding:0;margin:10px 0 0;display:grid;gap:6px}
      .coverage-list li{padding:8px 10px;background:#fff;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px}
      .coverage-list li:before{content:'üìç';font-size:14px}

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <div class="dot"></div>
          <strong>Var√≥n Rider</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Menu</div>
          <a class="side-link active" href="#" onclick="switchSection('overview'); return false;">Overview</a>
          <a class="side-link" href="#" onclick="switchSection('deliveries'); return false;">Active Deliveries</a>
          <a class="side-link" href="#" onclick="switchSection('history'); return false;">Delivery History</a>
          <a class="side-link" href="#" onclick="switchSection('earnings'); return false;">Earnings</a>
          <a class="side-link" href="#" onclick="switchSection('schedule'); return false;">Schedule</a>
          <a class="side-link" href="#" onclick="switchSection('ratings'); return false;">Ratings & Reviews</a>
        </div>
        <div class="side-group">
          <div class="side-title">Account</div>
          <a class="side-link" href="#" onclick="switchSection('profile'); return false;">Profile</a>
          <a class="side-link" href="#" onclick="switchSection('settings'); return false;">Settings</a>
          <a class="side-link" href="#" onclick="switchSection('support'); return false;">Support</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Welcome back, <span id="riderName">{{ rider_name }}</span>!</div>
          <div class="avatar">
            <img src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                 alt="Profile" 
                 style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);cursor:pointer"
                 onclick="switchSection('profile')"
                 title="View Profile"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22%3E%3Crect fill=%22%23efefef%22 width=%2236%22 height=%2236%22 rx=%2218%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
            <div class="status in-transit">
              <span class="dot" style="width:6px;height:6px;background:currentColor;border-radius:999px"></span>
              Online
            </div>
            {% if session.logged_in %}
              <span class="tag">{{ session.email }}</span>
              <a href="/logout" class="tag" style="background:#efefef;color:#0a0a0a">Logout</a>
            {% else %}
              <a href="/login" class="tag">Login</a>
            {% endif %}
          </div>
        </div>

        <main class="main" id="mainContent">
          <!-- Overview Section -->
          <div id="overview-section">
            <!-- Coverage Area with Interactive Map -->
            <div class="card">
              <div class="inner">
                <div class="coverage-title">
                  <span class="icon">üó∫Ô∏è</span>
                  Your Service Area: {{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }}
                </div>
                <div class="coverage-details" id="coverage-description">
                  Loading coverage details...
                </div>
                
                <!-- Interactive Map -->
                <div class="map-container" style="margin-top:12px">
                  <div id="serviceMap"></div>
                </div>

                <!-- Barangays List -->
                <ul class="coverage-list" id="barangays-list">
                  <li>Loading...</li>
                </ul>
              </div>
            </div>

            <!-- Stat cards -->
            <div class="grid stats" style="margin-top:14px">
              <div class="card">
                <div class="inner">
                  <div class="metric">Today's Earnings</div>
                  <div class="value">‚Ç±{{ "%.2f"|format(earnings_today) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Deliveries Today</div>
                  <div class="value">{{ deliveries_today }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Rating</div>
                  <div class="value">{{ "%.1f"|format(rating) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Acceptance Rate</div>
                  <div class="value">{{ acceptance_rate }}%</div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Deliveries</div>
                  <a href="#" class="show-section" data-section="history" style="font-size:12px;color:var(--muted)">View History</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Route</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Earnings</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_deliveries and recent_deliveries|length > 0 %}
                        {% for delivery in recent_deliveries %}
                        <tr>
                          <td>#{{ delivery.order_number }}</td>
                          <td>{{ delivery.pickup_location or 'N/A' }} ‚Üí {{ delivery.delivery_location or 'N/A' }}</td>
                          <td>{{ delivery.delivered_at.strftime('%I:%M %p') if delivery.delivered_at else 'N/A' }}</td>
                          <td><span class="status {{ delivery.status }}">{{ delivery.status|title|replace('_', ' ') }}</span></td>
                          <td>‚Ç±{{ "%.2f"|format(delivery.total_amount * 0.15) }}</td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent deliveries</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Deliveries Section -->
          <div id="deliveries-section" style="display: none;">
            <!-- Available Orders Tab -->
            <div class="card" style="margin-bottom:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">Available Orders in Your Area</div>
                  <button onclick="loadAvailableOrders()" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer">üîÑ Refresh</button>
                </div>
                <div style="overflow:auto">
                  <table id="available-orders-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Amount</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading available orders...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- My Active Deliveries Tab -->
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
                  <div class="metric">My Active Deliveries</div>
                  <div class="tag" style="background:#10b981;color:#fff" id="active-count">0 Active</div>
                </div>
                <div style="overflow:auto">
                  <table id="active-deliveries-table">
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Delivery Address</th>
                        <th>Status</th>
                        <th>Earning</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="6" style="text-align:center;color:#999">Loading your deliveries...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="history-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Delivery History</div>
                  <div class="tag" style="background:#efefef;color:#0a0a0a">Last 30 Days</div>
                </div>
                <div style="overflow:auto">
                  <table id="history-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Orders</th>
                        <th>Earnings</th>
                        <th>Rating</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings Section -->
          <div id="earnings-section" style="display: none;">
            <div class="grid stats">
              <div class="card">
                <div class="inner">
                  <div class="metric">Weekly Earnings</div>
                  <div class="value" id="weekly-earnings">‚Ç±0.00</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Monthly Earnings</div>
                  <div class="value" id="monthly-earnings">‚Ç±0.00</div>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div class="metric">Earnings Breakdown</div>
                <div style="overflow:auto">
                  <table id="earnings-breakdown-table">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Share</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="3" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Schedule Section -->
          <div id="schedule-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Your Schedule</div>
                  <div class="tag" style="background:#10b981;color:#fff">Online</div>
                </div>
                <div style="margin-top:20px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Today's Hours</div>
                    <div>8:00 AM - 5:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Break Time</div>
                    <div>12:00 PM - 1:00 PM</div>
                  </div>
                  <div style="display:flex;justify-content:space-between;margin-bottom:10px">
                    <div>Area Coverage</div>
                    <div>Sta Cruz, Laguna</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ratings Section -->
          <div id="ratings-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Feedback</div>
                <div style="margin-top:20px">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
                    <div style="font-size:32px;font-weight:bold" id="overall-rating">4.5</div>
                    <div id="rating-stars">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê</div>
                    <div style="color:var(--muted)" id="rating-count">(0 ratings)</div>
                  </div>
                  <table id="reviews-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Rating</th>
                        <th>Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Profile Information</div>
                <div style="margin-top:20px">
                  <div style="display:flex;gap:20px;margin-bottom:20px">
                    <div style="position:relative;width:100px;height:100px">
                      <img id="profileImage" 
                           src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}" 
                           alt="Profile" 
                           style="width:100px;height:100px;border-radius:50%;object-fit:cover;background:#efefef;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.1)"
                           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
                      <label for="profileImageInput" 
                             style="position:absolute;bottom:0;right:0;background:#0a0a0a;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);font-size:16px"
                             title="Upload profile photo">
                        üì∑
                      </label>
                      <input type="file" 
                             id="profileImageInput" 
                             accept="image/*" 
                             style="display:none" 
                             onchange="uploadProfileImage(this)">
                    </div>
                    <div>
                      <div style="font-size:20px;font-weight:bold">{{ rider_name }}</div>
                      <div style="color:var(--muted)">{{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }} Rider</div>
                      <div style="margin-top:10px">
                        <span class="tag" style="background:#efefef;color:#0a0a0a">Motorcycle</span>
                        <span class="tag" style="background:#efefef;color:#0a0a0a">2+ Years</span>
                      </div>
                    </div>
                  </div>
                  <div style="display:grid;gap:10px">
                    <div style="display:flex;justify-content:space-between">
                      <div>Vehicle Type</div>
                      <div>{{ rider.vehicle_type|title if rider and rider.vehicle_type else 'Not specified' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>License Number</div>
                      <div>{{ rider.license_number if rider and rider.license_number else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Contact Number</div>
                      <div>{{ user.phone if user and user.phone else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Email</div>
                      <div>{{ user.email if user and user.email else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between">
                      <div>Total Deliveries</div>
                      <div>{{ total_deliveries }}</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </main>
      </section>
    </div>
    <style>
      /* Hide all sections by default */
      [id$="-section"] {
        display: none;
      }
      /* Show overview section by default */
      #overview-section {
        display: block;
      }
    </style>

    <script>
      // Region coordinates mapping - supports various naming formats
      const regionCoordinates = {
        'sta cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Sta Cruz, Laguna (CALABARZON)' },
        'santa cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Santa Cruz, Laguna (CALABARZON)' },
        'sta cruz, laguna': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Sta Cruz, Laguna (CALABARZON)' },
        'santa cruz, laguna': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Santa Cruz, Laguna (CALABARZON)' },
        'calamba': { center: [14.2117, 121.1653], zoom: 13, radius: 6000, displayName: 'Calamba, Laguna (CALABARZON)' },
        'los ba√±os': { center: [14.1697, 121.2408], zoom: 13, radius: 5000, displayName: 'Los Ba√±os, Laguna (CALABARZON)' },
        'san pablo': { center: [14.0681, 121.3260], zoom: 13, radius: 7000, displayName: 'San Pablo, Laguna (CALABARZON)' },
        'bi√±an': { center: [14.3364, 121.0823], zoom: 13, radius: 5000, displayName: 'Bi√±an, Laguna (CALABARZON)' },
        'cabuyao': { center: [14.2780, 121.1230], zoom: 13, radius: 5000, displayName: 'Cabuyao, Laguna (CALABARZON)' },
        'manila': { center: [14.5995, 120.9842], zoom: 12, radius: 8000, displayName: 'Manila (NCR)' },
        'ncr': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Sta Cruz, Laguna (CALABARZON)' },
        'quezon city': { center: [14.6760, 121.0437], zoom: 12, radius: 10000, displayName: 'Quezon City (NCR)' },
        'makati': { center: [14.5547, 121.0244], zoom: 13, radius: 6000, displayName: 'Makati (NCR)' },
        'calabarzon': { center: [14.2691, 121.4147], zoom: 11, radius: 15000, displayName: 'CALABARZON Region' }
      };

      // Warehouse locations for different regions - case insensitive keys
      const warehouses = {
        'sta cruz': [
          { name: 'Var√≥n Main Warehouse', coords: [14.2741, 121.4097], type: 'main' },
          { name: 'Patimbao Distribution Hub', coords: [14.2850, 121.4200], type: 'distribution' },
          { name: 'Poblacion Storage', coords: [14.2680, 121.4160], type: 'storage' }
        ],
        'santa cruz': [
          { name: 'Var√≥n Main Warehouse', coords: [14.2741, 121.4097], type: 'main' },
          { name: 'Patimbao Distribution Hub', coords: [14.2850, 121.4200], type: 'distribution' }
        ],
        'ncr': [
          { name: 'Var√≥n Main Warehouse', coords: [14.2741, 121.4097], type: 'main' },
          { name: 'Patimbao Distribution Hub', coords: [14.2850, 121.4200], type: 'distribution' },
          { name: 'Poblacion Storage', coords: [14.2680, 121.4160], type: 'storage' }
        ],
        'calamba': [
          { name: 'Calamba Central Warehouse', coords: [14.2150, 121.1700], type: 'main' },
          { name: 'PEZA Distribution Center', coords: [14.2080, 121.1620], type: 'distribution' }
        ],
        'manila': [
          { name: 'Manila Main Hub', coords: [14.6042, 120.9822], type: 'main' },
          { name: 'Divisoria Storage', coords: [14.6008, 120.9756], type: 'storage' }
        ]
      };

      // Initialize Interactive Map based on rider's region
      function initializeMap() {
        // Get rider's service area from template
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "Sta Cruz, Laguna" }}';
        console.log('Service Area from DB:', serviceAreaText);
        
        // Normalize the service area text for matching
        const normalizedArea = serviceAreaText.toLowerCase().trim();
        
        // Find matching region coordinates (case-insensitive)
        let regionConfig = null;
        for (const [region, config] of Object.entries(regionCoordinates)) {
          if (normalizedArea.includes(region.toLowerCase()) || region.toLowerCase().includes(normalizedArea)) {
            regionConfig = config;
            console.log('Matched region:', region, config);
            break;
          }
        }
        
        // Default to Sta Cruz if no match found
        if (!regionConfig) {
          console.log('No match found, using default: Sta Cruz, Laguna');
          regionConfig = regionCoordinates['sta cruz'];
        }
        
        // Initialize the map with region-specific settings
        const map = L.map('serviceMap').setView(regionConfig.center, regionConfig.zoom);
        
        // Add OpenStreetMap tile layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);
        
        // Define service area boundaries with region-specific radius
        const serviceArea = L.circle(regionConfig.center, {
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.15,
          radius: regionConfig.radius
        }).addTo(map);
        
        // Add warehouse markers based on region (case-insensitive matching)
        const normalizedAreaKey = normalizedArea.replace(/,.*$/,'').trim(); // Remove everything after comma
        let regionWarehouses = null;
        
        // Try to find matching warehouses
        for (const [warehouseKey, warehouseList] of Object.entries(warehouses)) {
          if (normalizedAreaKey.includes(warehouseKey.toLowerCase()) || warehouseKey.toLowerCase().includes(normalizedAreaKey)) {
            regionWarehouses = warehouseList;
            console.log('Matched warehouses for:', warehouseKey);
            break;
          }
        }
        
        // Default to Sta Cruz warehouses if no match
        if (!regionWarehouses) {
          console.log('No warehouse match, using default Sta Cruz warehouses');
          regionWarehouses = warehouses['sta cruz'];
        }
        
        // Custom icons for different warehouse types
        const mainWarehouseIcon = L.divIcon({
          className: 'warehouse-marker',
          html: '<div style="background:#ef4444;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);font-size:18px;">üè≠</div>',
          iconSize: [32, 32],
          iconAnchor: [16, 16]
        });
        
        const distributionIcon = L.divIcon({
          className: 'warehouse-marker',
          html: '<div style="background:#f59e0b;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 6px rgba(0,0,0,0.3);font-size:16px;">üì¶</div>',
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
        
        const storageIcon = L.divIcon({
          className: 'warehouse-marker',
          html: '<div style="background:#3b82f6;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.3);font-size:14px;">üè™</div>',
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        
        // Add warehouse markers
        regionWarehouses.forEach(warehouse => {
          let icon = storageIcon;
          let warehouseType = 'Storage Facility';
          
          if (warehouse.type === 'main') {
            icon = mainWarehouseIcon;
            warehouseType = 'Main Warehouse';
          } else if (warehouse.type === 'distribution') {
            icon = distributionIcon;
            warehouseType = 'Distribution Hub';
          }
          
          const marker = L.marker(warehouse.coords, { icon: icon }).addTo(map);
          marker.bindPopup(`
            <div style="font-family:Inter,sans-serif;">
              <strong style="font-size:14px;">${warehouse.name}</strong><br>
              <span style="color:#666;font-size:12px;">${warehouseType}</span><br>
              <span style="color:#10b981;font-size:11px;">‚úì Pickup Available</span>
            </div>
          `);
        });
        
        // Add center marker for service area
        const centerMarker = L.marker(regionConfig.center, {
          icon: L.divIcon({
            className: 'center-marker',
            html: '<div style="background:#0a0a0a;color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üìç ' + (regionConfig.displayName || serviceAreaText) + '</div>',
            iconSize: [120, 32],
            iconAnchor: [60, 16]
          })
        }).addTo(map);
        
        centerMarker.bindPopup(`<b>${regionConfig.displayName || serviceAreaText}</b><br>Your Service Area`);
        
        // Add scale control
        L.control.scale().addTo(map);
        
        // Add legend for warehouse types
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = function(map) {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = `
            <div style="background:white;padding:10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15);font-family:Inter,sans-serif;">
              <div style="font-weight:600;margin-bottom:6px;font-size:11px;color:#666;">PICKUP LOCATIONS</div>
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px;">
                <span style="font-size:14px;">üè≠</span> Main Warehouse
              </div>
              <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:11px;">
                <span style="font-size:14px;">üì¶</span> Distribution Hub
              </div>
              <div style="display:flex;align-items:center;gap:6px;font-size:11px;">
                <span style="font-size:14px;">üè™</span> Storage Facility
              </div>
            </div>
          `;
          return div;
        };
        legend.addTo(map);
      }
      
      // Simple function to switch between sections
      function switchSection(sectionId) {
        // Hide all sections
        document.querySelectorAll('[id$="-section"]').forEach(section => {
          section.style.display = 'none';
        });
        
        // Show selected section
        const selectedSection = document.getElementById(sectionId + '-section');
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }
        
        // Update active state in sidebar
        document.querySelectorAll('.side-link').forEach(link => {
          link.classList.remove('active');
        });
        
        // Find and activate the clicked link
        const activeLink = Array.from(document.querySelectorAll('.side-link')).find(
          link => link.textContent.toLowerCase().includes(sectionId.toLowerCase())
        );
        if (activeLink) {
          activeLink.classList.add('active');
        }

        // Load deliveries when switching to deliveries section
        if (sectionId === 'deliveries') {
          loadAvailableOrders();
          loadMyActiveDeliveries();
        }
      }

      // Load available orders for delivery
      function loadAvailableOrders() {
        fetch('/api/rider/available-orders')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#available-orders-table tbody');
            if (data.success && data.orders && data.orders.length > 0) {
              tbody.innerHTML = data.orders
                .filter(order => order.shipment_status === 'pending')
                .map(order => {
                  const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                  const orderDate = new Date(order.created_at).toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    hour: '2-digit', 
                    minute: '2-digit' 
                  });
                  return `
                    <tr>
                      <td>
                        <div style="font-weight:600">#${order.order_number}</div>
                        <div style="font-size:11px;color:#999">${orderDate}</div>
                      </td>
                      <td>
                        <div>${order.customer_name}</div>
                        <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                      </td>
                      <td style="max-width:200px">${order.delivery_address}</td>
                      <td style="font-weight:600">‚Ç±${parseFloat(order.total_amount).toFixed(2)}</td>
                      <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                      <td>
                        <button onclick="acceptOrder(${order.shipment_id})" 
                                class="tag" 
                                style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:8px 16px">
                          Accept
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">No available orders in your area</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading available orders:', error);
            document.querySelector('#available-orders-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading orders</td></tr>';
          });
      }

      // Load rider's active deliveries
      function loadMyActiveDeliveries() {
        fetch('/api/rider/available-orders')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#active-deliveries-table tbody');
            const activeOrders = data.orders ? data.orders.filter(order => order.shipment_status === 'picked_up') : [];
            
            // Update count badge
            document.getElementById('active-count').textContent = `${activeOrders.length} Active`;
            
            if (activeOrders.length > 0) {
              tbody.innerHTML = activeOrders.map(order => {
                const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
                const statusClass = order.shipment_status.replace('_', '-');
                const statusText = order.shipment_status.replace('_', ' ').toUpperCase();
                
                return `
                  <tr>
                    <td>
                      <div style="font-weight:600">#${order.order_number}</div>
                    </td>
                    <td>
                      <div>${order.customer_name}</div>
                      <div style="font-size:11px;color:#999">${order.customer_phone || 'N/A'}</div>
                    </td>
                    <td style="max-width:200px">${order.delivery_address}</td>
                    <td>
                      <span class="status ${statusClass}">${statusText}</span>
                    </td>
                    <td style="color:#10b981;font-weight:600">‚Ç±${earning}</td>
                    <td>
                      <select onchange="updateDeliveryStatus(${order.shipment_id}, this.value)" 
                              class="tag" 
                              style="background:#fff;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer">
                        <option value="">Update Status...</option>
                        <option value="in_transit">In Transit</option>
                        <option value="out_for_delivery">Out for Delivery</option>
                        <option value="delivered">Delivered ‚úì</option>
                        <option value="failed">Failed</option>
                      </select>
                    </td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;padding:40px">No active deliveries</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading active deliveries:', error);
            document.querySelector('#active-deliveries-table tbody').innerHTML = 
              '<tr><td colspan="6" style="text-align:center;color:#dc2626;padding:40px">Error loading deliveries</td></tr>';
          });
      }

      // Accept an order
      function acceptOrder(shipmentId) {
        if (!confirm('Accept this delivery order?')) return;
        
        fetch('/api/rider/accept-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ shipment_id: shipmentId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Order accepted! You can now start the delivery.');
            loadAvailableOrders();
            loadMyActiveDeliveries();
          } else {
            alert('Failed to accept order: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error accepting order:', error);
          alert('Error accepting order. Please try again.');
        });
      }

      // Update delivery status
      function updateDeliveryStatus(shipmentId, newStatus) {
        if (!newStatus) return;
        
        const statusText = newStatus.replace('_', ' ').toUpperCase();
        if (!confirm(`Update status to ${statusText}?`)) {
          // Reset the select dropdown
          event.target.value = '';
          return;
        }
        
        fetch('/api/rider/update-delivery-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            shipment_id: shipmentId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status updated successfully!');
            if (newStatus === 'delivered') {
              alert('üéâ Delivery completed! Your earnings have been updated.');
            }
            loadMyActiveDeliveries();
          } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
            event.target.value = '';
          }
        })
        .catch(error => {
          console.error('Error updating status:', error);
          alert('Error updating status. Please try again.');
          event.target.value = '';
        });
      }

      // Load delivery history from database
      function loadDeliveryHistory() {
        fetch('/api/rider/delivery-history')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#history-table tbody');
            if (data.success && data.history && data.history.length > 0) {
              tbody.innerHTML = data.history.map(day => {
                const date = new Date(day.delivery_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                const rating = day.avg_rating ? parseFloat(day.avg_rating).toFixed(1) : '5.0';
                return `
                  <tr>
                    <td>${date}</td>
                    <td>${day.order_count} deliveries</td>
                    <td>‚Ç±${parseFloat(day.daily_earnings).toFixed(2)}</td>
                    <td>${rating} ‚≠ê</td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No delivery history found</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading delivery history:', error);
            document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading history</td></tr>';
          });
      }

      // Load earnings data from database
      function loadEarnings() {
        fetch('/api/rider/earnings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update weekly and monthly earnings
              document.getElementById('weekly-earnings').textContent = '‚Ç±' + parseFloat(data.weekly_earnings).toFixed(2);
              document.getElementById('monthly-earnings').textContent = '‚Ç±' + parseFloat(data.monthly_earnings).toFixed(2);
              
              // Update earnings breakdown
              const tbody = document.querySelector('#earnings-breakdown-table tbody');
              tbody.innerHTML = `
                <tr>
                  <td>Base Fare</td>
                  <td>‚Ç±${parseFloat(data.breakdown.base_fare).toFixed(2)}</td>
                  <td>70%</td>
                </tr>
                <tr>
                  <td>Tips</td>
                  <td>‚Ç±${parseFloat(data.breakdown.tips).toFixed(2)}</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td>Bonuses</td>
                  <td>‚Ç±${parseFloat(data.breakdown.bonuses).toFixed(2)}</td>
                  <td>10%</td>
                </tr>
              `;
            } else {
              document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999">No earnings data available</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading earnings:', error);
            document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ef4444">Error loading earnings</td></tr>';
          });
      }

      // Load ratings and reviews from database
      function loadRatings() {
        fetch('/api/rider/ratings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update overall rating
              const rating = parseFloat(data.overall_rating).toFixed(1);
              document.getElementById('overall-rating').textContent = rating;
              
              // Generate stars based on rating
              const fullStars = Math.floor(data.overall_rating);
              const stars = '‚≠ê'.repeat(fullStars);
              document.getElementById('rating-stars').textContent = stars;
              
              // Update rating count
              document.getElementById('rating-count').textContent = `(${data.total_ratings} ratings)`;
              
              // Update reviews table
              const tbody = document.querySelector('#reviews-table tbody');
              if (data.reviews && data.reviews.length > 0) {
                tbody.innerHTML = data.reviews.map(review => {
                  const date = new Date(review.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  const stars = '‚≠ê'.repeat(review.rating);
                  return `
                    <tr>
                      <td>${date}</td>
                      <td>${review.customer_name}</td>
                      <td>${stars}</td>
                      <td>${review.comment || 'No comment'}</td>
                    </tr>
                  `;
                }).join('');
              } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No reviews yet</td></tr>';
              }
            }
          })
          .catch(error => {
            console.error('Error loading ratings:', error);
            document.querySelector('#reviews-table tbody').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading reviews</td></tr>';
          });
      }

      // Region-specific coverage data
      const regionCoverage = {
        'Sta Cruz, Laguna': {
          description: 'Covering: Sta Cruz proper, Patimbao, Santissima, Poblacion I-V, and surrounding barangays',
          barangays: ['Sta Cruz Proper', 'Patimbao', 'Santissima', 'Poblacion I', 'Poblacion II', 'Poblacion III', 'Poblacion IV', 'Poblacion V']
        },
        'Santa Cruz, Laguna': {
          description: 'Covering: Sta Cruz proper, Patimbao, Santissima, Poblacion I-V, and surrounding barangays',
          barangays: ['Sta Cruz Proper', 'Patimbao', 'Santissima', 'Poblacion I', 'Poblacion II', 'Poblacion III']
        },
        'Calamba, Laguna': {
          description: 'Covering: Calamba City proper, PEZA industrial area, and major residential barangays',
          barangays: ['Barangay 1 (Poblacion)', 'Barangay 2', 'Barangay 3', 'Parian', 'Canlubang', 'Halang', 'Bucal', 'Milagros']
        },
        'Los Ba√±os, Laguna': {
          description: 'Covering: Los Ba√±os proper, UPLB area, and commercial districts',
          barangays: ['Poblacion', 'Anos', 'Batong Malake', 'Bay', 'Mayondon', 'Maahas', 'Malinta']
        },
        'Manila': {
          description: 'Covering: Manila downtown, Ermita, Malate, and major commercial districts',
          barangays: ['Ermita', 'Malate', 'Paco', 'San Miguel', 'Santa Ana', 'Sampaloc', 'Quiapo', 'Binondo']
        },
        'Quezon City': {
          description: 'Covering: Quezon City central business districts and residential areas',
          barangays: ['Araneta Center Area', 'Cubao', 'Diliman', 'Project 4-8', 'Commonwealth', 'Fairview', 'Novaliches']
        }
      };

      // Update coverage details based on rider's region
      function updateCoverageDetails() {
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "Sta Cruz, Laguna" }}';
        const normalizedArea = serviceAreaText.toLowerCase().trim();
        
        // Find matching region coverage
        let coverage = null;
        for (const [region, data] of Object.entries(regionCoverage)) {
          if (normalizedArea.includes(region.toLowerCase()) || region.toLowerCase().includes(normalizedArea)) {
            coverage = data;
            console.log('Matched coverage for:', region);
            break;
          }
        }
        
        // Default to Sta Cruz if no match
        if (!coverage) {
          console.log('No coverage match, using default');
          coverage = regionCoverage['Sta Cruz, Laguna'];
        }
        
        // Update description
        document.getElementById('coverage-description').textContent = coverage.description;
        
        // Update barangays list
        const barangaysList = document.getElementById('barangays-list');
        barangaysList.innerHTML = coverage.barangays.map(barangay => 
          `<li>${barangay}</li>`
        ).join('');
      }

      // Upload profile image
      function uploadProfileImage(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }
        
        // Validate file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert('Image size must be less than 5MB.');
          return;
        }
        
        // Show preview immediately
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload to server
        const formData = new FormData();
        formData.append('profile_image', file);
        
        fetch('/api/rider/upload-profile-image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Profile image updated successfully!');
          } else {
            alert('Failed to upload image: ' + (data.error || 'Unknown error'));
            // Reload to show original image
            location.reload();
          }
        })
        .catch(error => {
          console.error('Error uploading image:', error);
          alert('Error uploading image. Please try again.');
          // Reload to show original image
          location.reload();
        });
      }

      // Initialize the dashboard
      document.addEventListener('DOMContentLoaded', function() {
        // Show overview section by default
        document.getElementById('overview-section').style.display = 'block';
        
        // Update coverage details based on region
        updateCoverageDetails();
        
        // Initialize the map with region-specific settings
        initializeMap();
        
        // Load data from database
        loadDeliveryHistory();
        loadEarnings();
        loadRatings();
        
        // Add click handler for "View History" link
        document.querySelectorAll('.show-section').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
              switchSection(section);
            }
          });
        });
        
        // Add click handlers to all sidebar links as backup
        document.querySelectorAll('.side-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Extract section from onclick attribute or text
            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {
              // Extract section name from onclick="switchSection('section'); return false;"
              const match = onclickAttr.match(/switchSection\('(.+?)'\)/);
              if (match && match[1]) {
                switchSection(match[1]);
              }
            }
          });
        });
        
        console.log('Rider Dashboard initialized');
      });
    </script>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>
