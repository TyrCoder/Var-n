<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Rider Dashboard ‚Äî Var√≥n</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="{{ url_for('static', filename='js/timezone.js') }}"></script>
    <style>
      :root{--bg:#fff;--fg:#0a0a0a;--muted:#777;--accent:#000;--card:#f8f8f8;--line:#efefef;--success:#10b981;--warning:#f59e0b;--error:#ef4444}
      *{box-sizing:border-box}
      html,body{height:100%}
      body{margin:0;font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:#f3f4f6;color:var(--fg)}
      a{text-decoration:none;color:inherit}
      /* Layout */
      .app{display:grid;grid-template-columns:240px 1fr;min-height:100vh}
      .sidebar{background:#0a0a0a;color:#fff;padding:18px 14px;display:flex;flex-direction:column;gap:8px}
      .logo{display:flex;align-items:center;gap:10px;padding:8px 8px 14px 8px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:10px}
      .side-group{margin-top:8px}
      .side-title{font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:#bdbdbd;margin:10px 8px 6px}
      .side-link{display:flex;align-items:center;gap:10px;padding:10px 10px;border-radius:8px;color:#eaeaea;cursor:pointer;user-select:none}
      .side-link.active,.side-link:hover{background:#141414;color:#fff}

      .content{display:flex;flex-direction:column}
      .topbar{display:flex;align-items:center;gap:14px;background:#fff;border-bottom:1px solid var(--line);padding:10px 16px;position:sticky;top:0;z-index:5}
      .search{flex:1}
      .search input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:8px;background:#fff}
      .avatar{display:flex;align-items:center;gap:8px;margin-left:auto}
      .tag{background:#0a0a0a;color:#fff;border-radius:999px;padding:6px 10px;font-size:12px}

      .main{padding:18px 18px 26px}
      .page-title{font-size:22px;margin:8px 0 14px}

      /* Cards */
      .grid{display:grid;gap:14px}
      .grid.stats{grid-template-columns:repeat(4, minmax(180px,1fr))}
      .card{background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:0 2px 10px rgba(10,10,10,.03)}
      .card .inner{padding:14px}
      .metric{font-size:12px;color:var(--muted);margin-bottom:6px}
      .value{font-size:22px;font-weight:700}
      .delta{font-size:12px;color:var(--success);margin-left:8px}
      .delta.down{color:var(--error)}

      /* Table */
      table{width:100%;border-collapse:separate;border-spacing:0}
      thead th{font-size:12px;color:var(--muted);text-align:left;border-bottom:1px solid var(--line);padding:10px 12px}
      tbody td{padding:12px;border-bottom:1px solid var(--line)}

      /* Status tags */
      .status{display:inline-flex;align-items:center;gap:4px;padding:4px 8px;border-radius:999px;font-size:12px}
      .status.pending{background:#fef3c7;color:#92400e}
      .status.in-transit{background:#dbeafe;color:#1e40af}
      .status.delivered{background:#dcfce7;color:#15803d}
      .status.cancelled{background:#fee2e2;color:#991b1b}

      /* Map container */
      .map-container{height:400px;background:#f3f4f6;border-radius:8px;position:relative;overflow:hidden;border:1px solid var(--line)}
      #serviceMap{height:100%;width:100%;z-index:1}

      /* Area coverage section */
      .coverage-area{margin-top:14px;padding:14px;background:#f8fafc;border-radius:8px}
      .coverage-title{font-weight:600;margin-bottom:8px;display:flex;align-items:center;gap:8px}
      .coverage-title .icon{font-size:20px}
      .coverage-details{color:var(--muted);font-size:14px;line-height:1.6}
      .coverage-list{list-style:none;padding:0;margin:10px 0 0;display:grid;gap:6px}
      .coverage-list li{padding:8px 10px;background:#fff;border-radius:6px;font-size:13px;display:flex;align-items:center;gap:8px}
      .coverage-list li:before{content:'üìç';font-size:14px}

      .approval-modal{position:fixed;inset:0;background:rgba(10,10,10,0.55);display:none;align-items:center;justify-content:center;z-index:2000;padding:20px}
      .approval-modal__content{background:#fff;border-radius:14px;padding:28px;max-width:420px;width:100%;text-align:center;box-shadow:0 20px 45px rgba(0,0,0,0.25)}
      .approval-modal__content h2{margin:0 0 12px;font-size:20px}
      .approval-modal__content p{margin:0 0 18px;color:#555;line-height:1.5}
      .approval-modal__content button{padding:10px 22px;border:none;border-radius:999px;background:#0a0a0a;color:#fff;font-weight:600;cursor:pointer}

      @media (max-width:1000px){
        .app{grid-template-columns:1fr}
        .sidebar{display:none}
        .grid.stats{grid-template-columns:repeat(2,1fr)}
        .grid.two{grid-template-columns:1fr}
      }
    </style>
  </head>
  <body>
    {% if rider and rider.status != 'approved' %}
    <div class="approval-modal" id="riderApprovalModal" role="alertdialog" aria-live="assertive">
      <div class="approval-modal__content">
        <h2>Account Pending Approval</h2>
        <p>Your account has not been approved. Wait for approval or contact the admin.</p>
        <button id="riderApprovalDismiss">Okay</button>
      </div>
    </div>
    {% endif %}
    <div class="app">
      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="logo">
          <strong>Var√≥n Rider</strong>
        </div>
        <div class="side-group">
          <div class="side-title">Menu</div>
          <a class="side-link active" href="#" onclick="switchSection('overview'); return false;">Overview</a>
          <a class="side-link" href="#" onclick="switchSection('deliveries'); return false;">Active Deliveries</a>
          <a class="side-link" href="#" onclick="switchSection('history'); return false;">Delivery History</a>
          <a class="side-link" href="#" onclick="switchSection('earnings'); return false;">Earnings</a>
          <a class="side-link" href="#" onclick="switchSection('ratings'); return false;">Ratings & Reviews</a>
        </div>
        <div class="side-group">
          <div class="side-title">Account &amp; Docs</div>
          <a class="side-link" href="#" onclick="switchSection('profile'); return false;">Profile</a>
          <a class="side-link" href="#" onclick="switchSection('documents'); return false;">Documents</a>
          <a class="side-link" href="#" onclick="switchSection('settings'); return false;">Settings</a>
          <a class="side-link" href="#" onclick="switchSection('support'); return false;">Support</a>
        </div>
      </aside>

      <!-- Content -->
      <section class="content">
        <div class="topbar">
          <div class="page-title">Welcome back, <span id="riderName">{{ rider_name }}</span>!</div>
          <div class="avatar">
            <img src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}"
                 alt="Profile"
                 style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.1);cursor:pointer"
                 onclick="switchSection('profile')"
                 title="View Profile"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2236%22 height=%2236%22%3E%3Crect fill=%22%23efefef%22 width=%2236%22 height=%2236%22 rx=%2218%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2216%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
            <div class="status in-transit">
              <span class="dot" style="width:6px;height:6px;background:currentColor;border-radius:999px"></span>
              Online
            </div>
            {% if session.logged_in %}
              <span class="tag">{{ session.email }}</span>
              <a href="/logout" class="tag" style="background:#efefef;color:#0a0a0a">Logout</a>
            {% else %}
              <a href="/login" class="tag">Login</a>
            {% endif %}
          </div>
        </div>

        <main class="main" id="mainContent">
          <!-- Overview Section -->
          <div id="overview-section">
            <!-- Coverage Area with Interactive Map -->
            <div class="card">
              <div class="inner">
                <div class="coverage-title">
                  <span class="icon">üó∫Ô∏è</span>
                  Your Service Area: {% if rider and rider.service_area %}{{ rider.service_area.split(',')[0].strip() }}{% else %}South Luzon{% endif %}
                </div>
                <div class="coverage-details" id="coverage-description">
                  Loading coverage details...
                </div>

                <!-- Interactive Map -->
                <div class="map-container" style="margin-top:12px">
                  <div id="serviceMap"></div>
                </div>

              </div>
            </div>

            <!-- Stat cards -->
            <div class="grid stats" style="margin-top:14px">
              <div class="card">
                <div class="inner">
                  <div class="metric">Today's Earnings</div>
                  <div class="value">‚Ç±{{ "%.2f"|format(earnings_today) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Deliveries Today</div>
                  <div class="value">{{ deliveries_today }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Rating</div>
                  <div class="value">{{ "%.1f"|format(rating) }}</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Acceptance Rate</div>
                  <div class="value">{{ acceptance_rate }}%</div>
                </div>
              </div>
            </div>

            <!-- Recent Activity -->
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Recent Deliveries</div>
                  <a href="#" class="show-section" data-section="history" style="font-size:12px;color:var(--muted)">View History</a>
                </div>
                <div style="overflow:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Order ID</th>
                        <th>Route</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Earnings</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% if recent_deliveries and recent_deliveries|length > 0 %}
                        {% for delivery in recent_deliveries %}
                        <tr>
                          <td>#{{ delivery.order_number }}</td>
                          <td>{{ delivery.pickup_location or 'N/A' }} ‚Üí {{ delivery.delivery_location or 'N/A' }}</td>
                          <td>{{ delivery.delivered_at|ph_time('%I:%M %p') or 'N/A' }}</td>
                          <td><span class="status {{ delivery.status }}">{{ delivery.status|title|replace('_', ' ') }}</span></td>
                          <td>‚Ç±{{ "%.2f"|format(delivery.total_amount * 0.15) }}</td>
                        </tr>
                        {% endfor %}
                      {% else %}
                        <tr>
                          <td colspan="5" style="text-align:center;color:#999">No recent deliveries</td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Deliveries Section -->
          <div id="deliveries-section" style="display: none;">
            <!-- Unified Orders & Deliveries Tab -->
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:10px">
                  <div>
                    <div class="metric">Deliveries & Orders</div>
                    <div style="font-size:13px;color:#666;margin-top:2px">All available and active deliveries in your area</div>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button onclick="loadOrdersAndDeliveries()" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer;padding:8px 14px">üîÑ Refresh</button>
                    <button id="activeDeliveryAlerts"
                            class="alert-button disabled-alert"
                            onclick="openActiveDeliveryModal()"
                            disabled>
                      üîî Active Alerts
                      <span id="activeDeliveryBadge" style="margin-left:6px;background:#fff;color:#0a0a0a;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700">0</span>
                    </button>
                    <div class="tag" style="background:#10b981;color:#fff" id="order-count">0 Orders</div>
                  </div>
                </div>

                <!-- Filter Controls -->
                <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;padding:12px;background:#f8fafc;border-radius:8px">
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by Province</label>
                    <input type="text" id="filterProvince" placeholder="Enter province" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadOrdersAndDeliveries()">
                  </div>
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by City</label>
                    <input type="text" id="filterCity" placeholder="Enter city" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadOrdersAndDeliveries()">
                  </div>
                  <div style="flex:1;min-width:150px">
                    <label style="display:block;font-size:12px;color:#666;margin-bottom:4px;font-weight:600">Filter by Postal Code</label>
                    <input type="text" id="filterPostalCode" placeholder="Enter postal code" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:13px" onchange="loadOrdersAndDeliveries()">
                  </div>
                  <div style="display:flex;align-items:flex-end;gap:6px">
                    <button onclick="clearFilters()" style="padding:8px 14px;background:#efefef;border:1px solid #ddd;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;transition:all 0.2s" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#efefef'">Clear Filters</button>
                  </div>
                </div>

                <div style="font-size:12px;color:#666;margin-bottom:12px">
                  üìç Your Service Area: <strong id="riderServiceArea">Loading...</strong>
                </div>

                <div id="orders-deliveries-container" style="overflow:auto">
                  <table id="orders-deliveries-table" style="width:100%;border-collapse:collapse;background:#fff">
                    <thead>
                      <tr style="background:#f8fafc;border-bottom:2px solid #e5e7eb">
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:100px">Order ID</th>
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:140px">Date Available</th>
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:200px">Customer & Location</th>
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:120px">Amount</th>
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:100px">Your Earning</th>
                        <th style="padding:12px 14px;text-align:left;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:120px">Status</th>
                        <th style="padding:12px 14px;text-align:center;font-size:12px;font-weight:700;color:#374151;letter-spacing:0.5px;min-width:110px">Action</th>
                      </tr>
                    </thead>
                    <tbody id="orders-deliveries-tbody" style="color:#0a0a0a">
                      <tr>
                        <td colspan="7" style="text-align:center;color:#999;padding:40px">Loading your orders and deliveries...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- History Section -->
          <div id="history-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div class="metric">Delivery History</div>
                  <div class="tag" style="background:#efefef;color:#0a0a0a">All Delivered Orders</div>
                </div>
                <div style="overflow:auto">
                  <table id="history-table">
                    <thead>
                      <tr>
                        <th>Order #</th>
                        <th>Customer</th>
                        <th>Earnings</th>
                        <th>Status</th>
                        <th style="text-align:center">Details</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="5" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Earnings Section -->
          <div id="earnings-section" style="display: none;">
            <div class="grid stats">
              <div class="card">
                <div class="inner">
                  <div class="metric">Weekly Earnings</div>
                  <div class="value" id="weekly-earnings">‚Ç±0.00</div>
                </div>
              </div>
              <div class="card">
                <div class="inner">
                  <div class="metric">Monthly Earnings</div>
                  <div class="value" id="monthly-earnings">‚Ç±0.00</div>
                </div>
              </div>
            </div>
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div class="metric">Earnings Breakdown</div>
                <div style="overflow:auto">
                  <table id="earnings-breakdown-table">
                    <thead>
                      <tr>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Share</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="3" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Ratings Section -->
          <div id="ratings-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div class="metric">Customer Feedback</div>
                <div style="margin-top:20px">
                  <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px">
                    <div style="font-size:32px;font-weight:bold" id="overall-rating">0.0</div>
                    <div id="rating-stars"></div>
                    <div style="color:var(--muted)" id="rating-count">(0 ratings)</div>
                  </div>
                  
                  <!-- Rating Breakdown -->
                  <div id="rating-breakdown" style="margin-bottom: 30px; padding: 20px; background: #f9fafb; border-radius: 10px;">
                    <div style="font-weight: 600; margin-bottom: 16px; color: #0a0a0a;">Rating Distribution</div>
                    <div style="color: #6b7280; font-size: 14px;">Loading rating breakdown...</div>
                  </div>

                  <div style="font-weight: 600; margin-bottom: 12px; color: #0a0a0a;">Customer Reviews</div>
                  <table id="reviews-table">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Rating</th>
                        <th>Comment</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td colspan="4" style="text-align:center;color:#999">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Profile Section -->
          <div id="profile-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
                  <div class="metric">Profile Settings</div>
                  <button id="editProfileBtn" onclick="toggleEditMode()" class="tag" style="background:#0a0a0a;color:#fff;border:none;cursor:pointer;padding:8px 16px">‚úé Edit Profile</button>
                </div>

                <!-- View Mode -->
                <div id="profileViewMode">
                  <div style="display:flex;gap:20px;margin-bottom:20px">
                    <div style="position:relative;width:100px;height:100px">
                      <img id="profileImage"
                           src="{{ rider.profile_image if rider and rider.profile_image else '/static/images/default-avatar.png' }}"
                           alt="Profile"
                           style="width:100px;height:100px;border-radius:50%;object-fit:cover;background:#efefef;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.1)"
                           onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22%3E%3Crect fill=%22%23efefef%22 width=%22100%22 height=%22100%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 font-size=%2240%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3Eüë§%3C/text%3E%3C/svg%3E'">
                      <label for="profileImageInput"
                             style="position:absolute;bottom:0;right:0;background:#0a0a0a;color:#fff;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid #fff;box-shadow:0 2px 4px rgba(0,0,0,0.2);font-size:16px"
                             title="Upload profile photo">
                        üì∑
                      </label>
                      <input type="file"
                             id="profileImageInput"
                             accept="image/*"
                             style="display:none"
                             onchange="uploadProfileImage(this)">
                    </div>
                    <div>
                      <div style="font-size:20px;font-weight:bold" id="viewRiderName">{{ rider_name }}</div>
                      <div style="color:var(--muted)">{{ rider.service_area if rider and rider.service_area else 'Sta Cruz, Laguna' }} Rider</div>
                      <div style="margin-top:10px">
                        <span class="tag" style="background:#efefef;color:#0a0a0a">Motorcycle</span>
                        <span class="tag" style="background:#efefef;color:#0a0a0a">2+ Years</span>
                      </div>
                    </div>
                  </div>
                  <div style="display:grid;gap:10px">
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">First Name</div>
                      <div id="viewFirstName">{{ user.first_name if user and user.first_name else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Last Name</div>
                      <div id="viewLastName">{{ user.last_name if user and user.last_name else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Email</div>
                      <div id="viewEmail">{{ user.email if user and user.email else 'N/A' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Phone Number</div>
                      <div id="viewPhone">{{ user.phone if user and user.phone else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Vehicle Type</div>
                      <div id="viewVehicle">{{ rider.vehicle_type if rider and rider.vehicle_type else 'Not specified' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">License Number</div>
                      <div id="viewLicense">{{ rider.license_number if rider and rider.license_number else 'Not provided' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Service Area</div>
                      <div id="viewServiceArea">{{ rider.service_area if rider and rider.service_area else 'Not assigned' }}</div>
                    </div>
                    <div style="display:flex;justify-content:space-between;padding:10px;background:#f9fafb;border-radius:6px">
                      <div style="font-weight:500">Total Deliveries</div>
                      <div>{{ total_deliveries }}</div>
                    </div>
                  </div>
                </div>

                <!-- Edit Mode -->
                <div id="profileEditMode" style="display:none">
                  <form id="editProfileForm" style="display:grid;gap:14px">
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">First Name</label>
                      <input type="text" id="editFirstName" placeholder="First Name"
                             value="{{ user.first_name if user and user.first_name else '' }}"
                             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                    </div>
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Last Name</label>
                      <input type="text" id="editLastName" placeholder="Last Name"
                             value="{{ user.last_name if user and user.last_name else '' }}"
                             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                    </div>
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Email Address</label>
                      <input type="email" id="editEmail" placeholder="Email"
                             value="{{ user.email if user and user.email else '' }}"
                             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                    </div>
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Phone Number</label>
                      <input type="tel" id="editPhone" placeholder="Phone Number"
                             value="{{ user.phone if user and user.phone else '' }}"
                             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                    </div>
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Vehicle Type</label>
                      <select id="editVehicle" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                        <option value="">Select Vehicle Type</option>
                        <option value="motorcycle">Motorcycle</option>
                        <option value="bicycle">Bicycle</option>
                        <option value="tricycle">Tricycle</option>
                        <option value="van">Van</option>
                      </select>
                    </div>
                    <div>
                      <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">License Number</label>
                      <input type="text" id="editLicense" placeholder="License Number"
                             value="{{ rider.license_number if rider and rider.license_number else '' }}"
                             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                    </div>

                    <div style="display:flex;gap:10px;margin-top:20px">
                      <button type="button" onclick="saveProfileChanges()"
                              style="flex:1;padding:12px;background:#10b981;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s"
                              onmouseover="this.style.background='#059669'"
                              onmouseout="this.style.background='#10b981'">
                        ‚úì Save Changes
                      </button>
                      <button type="button" onclick="toggleEditMode()"
                              style="flex:1;padding:12px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s"
                              onmouseover="this.style.background='#dc2626'"
                              onmouseout="this.style.background='#ef4444'">
                        ‚úï Cancel
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

            <!-- Change Password Section -->
            <div class="card" style="margin-top:14px">
              <div class="inner">
                <div style="margin-bottom:20px">
                  <div class="metric">Security Settings</div>
                </div>
                <button onclick="openChangePasswordModal()"
                        style="width:100%;padding:12px;background:#3b82f6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:all 0.2s"
                        onmouseover="this.style.background='#2563eb'"
                        onmouseout="this.style.background='#3b82f6'">
                  üîí Change Password
                </button>
              </div>
            </div>
          </div>

          <!-- Documents Section -->
          <div id="documents-section" style="display: none;">
            <div class="card">
              <div class="inner">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px">
                  <div>
                    <div class="metric">Registration Documents</div>
                    <div style="font-size:13px;color:#6b7280;margin-top:4px">Upload your driver's license, vehicle registration, OR/CR, and a clear photo of your vehicle for verification.</div>
                  </div>
                  <div class="tag" style="background:#0a0a0a;color:#fff">Secure Uploads</div>
                </div>

                <div class="document-grid" style="margin-top:16px">
                  <div class="document-card" data-doc-type="government_id">
                    <div class="document-card-header">
                      <div class="document-icon">ü™™</div>
                      <div>
                        <div class="document-title">Driver's License</div>
                        <div class="document-description">Upload a clear copy of your valid driver's license.</div>
                      </div>
                      <span class="doc-status doc-status-missing">Not uploaded</span>
                    </div>
                    <div class="doc-upload-status">No file uploaded yet.</div>
                    <div class="document-card-actions">
                      <button class="doc-upload-btn" type="button" onclick="triggerDocumentUpload('government_id')">Upload license</button>
                      <a class="doc-view-link" href="#" target="_blank" rel="noopener" style="display:none">üîé View file</a>
                    </div>
                    <input type="file" id="doc-file-government_id" accept="image/*,.pdf" style="display:none" onchange="handleDocumentUpload(event, 'government_id')">
                  </div>

                  <div class="document-card" data-doc-type="vehicle_registration">
                    <div class="document-card-header">
                      <div class="document-icon">üõµ</div>
                      <div>
                        <div class="document-title">Vehicle Registration</div>
                        <div class="document-description">Latest vehicle registration card or certificate.</div>
                      </div>
                      <span class="doc-status doc-status-missing">Not uploaded</span>
                    </div>
                    <div class="doc-upload-status">No file uploaded yet.</div>
                    <div class="document-card-actions">
                      <button class="doc-upload-btn" type="button" onclick="triggerDocumentUpload('vehicle_registration')">Upload Registration</button>
                      <a class="doc-view-link" href="#" target="_blank" rel="noopener" style="display:none">üîé View file</a>
                    </div>
                    <input type="file" id="doc-file-vehicle_registration" accept="image/*,.pdf" style="display:none" onchange="handleDocumentUpload(event, 'vehicle_registration')">
                  </div>

                  <div class="document-card" data-doc-type="orcr">
                    <div class="document-card-header">
                      <div class="document-icon">üìÑ</div>
                      <div>
                        <div class="document-title">Official Receipt / CR</div>
                        <div class="document-description">Upload your latest OR/CR copy for compliance.</div>
                      </div>
                      <span class="doc-status doc-status-missing">Not uploaded</span>
                    </div>
                    <div class="doc-upload-status">No file uploaded yet.</div>
                    <div class="document-card-actions">
                      <button class="doc-upload-btn" type="button" onclick="triggerDocumentUpload('orcr')">Upload OR/CR</button>
                      <a class="doc-view-link" href="#" target="_blank" rel="noopener" style="display:none">üîé View file</a>
                    </div>
                    <input type="file" id="doc-file-orcr" accept="image/*,.pdf" style="display:none" onchange="handleDocumentUpload(event, 'orcr')">
                  </div>

                  <div class="document-card" data-doc-type="car_photo">
                    <div class="document-card-header">
                      <div class="document-icon">üöó</div>
                      <div>
                        <div class="document-title">Vehicle Photo</div>
                        <div class="document-description">Share a recent exterior photo that clearly shows your registered vehicle.</div>
                      </div>
                      <span class="doc-status doc-status-missing">Not uploaded</span>
                    </div>
                    <div class="doc-upload-status">No file uploaded yet.</div>
                    <div class="document-card-actions">
                      <button class="doc-upload-btn" type="button" onclick="triggerDocumentUpload('car_photo')">Upload Vehicle Photo</button>
                      <a class="doc-view-link" href="#" target="_blank" rel="noopener" style="display:none">üîé View file</a>
                    </div>
                    <input type="file" id="doc-file-car_photo" accept="image/*" style="display:none" onchange="handleDocumentUpload(event, 'car_photo')">
                  </div>
                </div>
              </div>
            </div>
          </div>

        </main>
      </section>
    </div>

    <style>
      /* Hide all sections by default */
      [id$="-section"] {
        display: none;
      }
      /* Show overview section by default */
      #overview-section {
        display: block;
      }

      /* Active Deliveries Table Styling */
      #active-deliveries-table {
        width: 100%;
        border-collapse: collapse;
        background: #fff;
      }

      #active-deliveries-table thead tr {
        background: #f8fafc;
        border-bottom: 2px solid #e5e7eb;
      }

      #active-deliveries-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background-color 0.2s ease;
      }

      #active-deliveries-table tbody tr:hover {
        background-color: #f9fafb;
      }

      #active-deliveries-table td,
      #active-deliveries-table th {
        padding: 12px 14px;
        text-align: left;
      }

      #active-deliveries-table th {
        font-size: 12px;
        font-weight: 700;
        color: #374151;
        letter-spacing: 0.5px;
      }

      #active-deliveries-table tbody td {
        color: #0a0a0a;
        font-size: 13px;
      }

      .alert-button {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        border-radius: 999px;
        padding: 8px 14px;
        font-weight: 600;
        cursor: pointer;
        background: #f97316;
        color: #fff;
        transition: all 0.2s ease;
      }

      .alert-button:not(.disabled-alert):hover {
        background: #ea580c;
        transform: translateY(-1px);
      }

      .alert-button.disabled-alert {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .active-delivery-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 16px;
        background: #fff;
        margin-bottom: 12px;
        box-shadow: 0 2px 6px rgba(10,10,10,0.04);
      }

      .active-delivery-card:last-child {
        margin-bottom: 0;
      }

      .active-delivery-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .active-delivery-card .card-title {
        font-size: 16px;
        font-weight: 600;
        color: #0a0a0a;
      }

      .active-delivery-card .card-subtitle {
        font-size: 12px;
        color: #6b7280;
      }

      .status-pill {
        padding: 6px 12px;
        border-radius: 999px;
        font-size: 12px;
        font-weight: 600;
      }

      .active-delivery-card .card-details {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        margin-bottom: 12px;
      }

      .active-delivery-card .label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      .active-delivery-card .value {
        font-size: 14px;
        font-weight: 600;
        color: #0a0a0a;
      }

      .active-delivery-card .muted {
        font-size: 12px;
        color: #6b7280;
      }

      .status-stepper {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 14px;
      }

      .status-chip {
        border-radius: 999px;
        border: 1px solid #d1d5db;
        padding: 6px 12px;
        background: #fff;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .status-chip.done {
        background: #dcfce7;
        border-color: #10b981;
        color: #15803d;
        cursor: default;
      }

      .status-chip.active {
        background: #dbeafe;
        border-color: #3b82f6;
        color: #1d4ed8;
        cursor: default;
      }

      .status-chip.next {
        background: #fef3c7;
        border-color: #fbbf24;
        color: #92400e;
      }

      .status-chip:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .active-delivery-card .card-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .active-delivery-card .card-actions button {
        border: none;
        border-radius: 6px;
        padding: 8px 12px;
        font-weight: 600;
        cursor: pointer;
      }

      .status-actions-wrapper {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .status-actions-wrapper .status-stepper {
        margin-bottom: 0;
      }

      .document-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
      }

      .document-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 16px;
        background: #fff;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: 0 2px 8px rgba(15,23,42,0.03);
      }

      .document-card-header {
        display: flex;
        gap: 12px;
        align-items: flex-start;
      }

      .document-icon {
        width: 46px;
        height: 46px;
        border-radius: 14px;
        background: #f3f4f6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
      }

      .document-title {
        font-weight: 600;
        color: #0f172a;
      }

      .document-description {
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
      }

      .doc-status {
        margin-left: auto;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        border-radius: 999px;
        white-space: nowrap;
      }

      .doc-status-missing {
        background: #fee2e2;
        color: #b91c1c;
      }

      .doc-status-pending {
        background: #fef3c7;
        color: #b45309;
      }

      .doc-status-verified {
        background: #dcfce7;
        color: #15803d;
      }

      .doc-upload-status {
        font-size: 12px;
        color: #6b7280;
      }

      .document-card-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .doc-upload-btn {
        border: none;
        border-radius: 6px;
        padding: 8px 14px;
        background: #0a0a0a;
        color: #fff;
        font-size: 13px;
        font-weight: 600;
        cursor: pointer;
        transition: opacity 0.2s ease;
      }

      .doc-upload-btn:hover {
        opacity: 0.85;
      }

      .doc-view-link {
        font-size: 12px;
        color: #3b82f6;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }
    </style>

    <script>

      const regionCoordinates = {
        'north luzon': { center: [16.4023, 120.5960], zoom: 7, radius: 150000, displayName: 'North Luzon' },
        'central luzon': { center: [15.4828, 120.7129], zoom: 8, radius: 100000, displayName: 'Central Luzon' },
        'south luzon': { center: [14.2691, 121.4147], zoom: 8, radius: 120000, displayName: 'South Luzon' },
        'visayas': { center: [11.2447, 123.0167], zoom: 7, radius: 200000, displayName: 'Visayas' },
        'mindanao': { center: [7.1907, 124.2250], zoom: 7, radius: 250000, displayName: 'Mindanao' },

        'sta cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Sta Cruz, Laguna' },
        'santa cruz': { center: [14.2691, 121.4147], zoom: 13, radius: 5000, displayName: 'Santa Cruz, Laguna' },
        'calamba': { center: [14.2117, 121.1653], zoom: 13, radius: 6000, displayName: 'Calamba, Laguna' },
        'los ba√±os': { center: [14.1697, 121.2408], zoom: 13, radius: 5000, displayName: 'Los Ba√±os, Laguna' },
        'manila': { center: [14.5995, 120.9842], zoom: 12, radius: 8000, displayName: 'Manila (NCR)' },
        'quezon city': { center: [14.6760, 121.0437], zoom: 12, radius: 10000, displayName: 'Quezon City (NCR)' }
      };

      const shipmentStatusMeta = {
        'pending': { label: 'Waiting Approval', color: '#92400e', bg: '#fffbeb' },
        'assigned_to_rider': { label: 'Assigned to You', color: '#2563eb', bg: '#dbeafe' },
        'picked_up': { label: 'Picked Up', color: '#1d4ed8', bg: '#dbeafe' },
        'in_transit': { label: 'In Transit', color: '#8b5cf6', bg: '#f3e8ff' },
        'out_for_delivery': { label: 'Out for Delivery', color: '#ec4899', bg: '#fce7f3' },
        'delivered': { label: 'Delivered', color: '#15803d', bg: '#dcfce7' }
      };

      const riderStatusFlow = [
        { key: 'picked_up', label: 'Picked Up', emoji: 'üì¶' },
        { key: 'in_transit', label: 'In Transit', emoji: 'üöó' },
        { key: 'out_for_delivery', label: 'Out for Delivery', emoji: 'üö™' },
        { key: 'delivered', label: 'Delivered', emoji: '‚úÖ' }
      ];

      let activeDeliveryCache = [];

      function getShipmentStatusMeta(status) {
        if (!status) {
          return { label: 'Pending', color: '#6b7280', bg: '#f3f4f6' };
        }
        return shipmentStatusMeta[status] || {
          label: status.replace('_', ' ').toUpperCase(),
          color: '#6b7280',
          bg: '#f3f4f6'
        };
      }

      function formatDateTime(dateString) {
        if (!dateString) {
          return '‚Äî';
        }
        if (window.PhilippineTime && typeof window.PhilippineTime.formatDateTime === 'function') {
          const formatted = window.PhilippineTime.formatDateTime(dateString, {
            month: 'short',
            day: 'numeric',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          if (formatted) {
            return formatted;
          }
        }
        const parsed = new Date(dateString);
        if (Number.isNaN(parsed.getTime())) {
          return '‚Äî';
        }
        return parsed.toLocaleString('en-PH', {
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          timeZone: 'Asia/Manila'
        });
      }

      function getNextStatus(currentStatus) {
        if (!currentStatus || currentStatus === 'pending' || currentStatus === 'assigned_to_rider') {
          return riderStatusFlow[0].key;
        }
        const index = riderStatusFlow.findIndex(step => step.key === currentStatus);
        if (index === -1 || index === riderStatusFlow.length - 1) {
          return null;
        }
        return riderStatusFlow[index + 1].key;
      }

      function renderStatusStepper(order) {
        const currentStatus = order.shipment_status || 'pending';
        const deliveredComplete = currentStatus === 'delivered';
        const currentIndex = riderStatusFlow.findIndex(step => step.key === currentStatus);
        const isPending = currentStatus === 'pending' || currentStatus === 'assigned_to_rider';

        return riderStatusFlow.map((step, index) => {
          const isCompleted = deliveredComplete ? true : currentIndex > index;
          const isCurrent = !deliveredComplete && currentIndex === index;
          const canAdvanceFromPending = isPending && index === 0;
          const canAdvance = (!deliveredComplete) && (
            (isPending && canAdvanceFromPending) ||
            (currentIndex >= 0 && index === currentIndex + 1)
          );
          const shouldDisable = isCompleted || isCurrent || !canAdvance;
          const stateClass = isCompleted ? 'done' : isCurrent ? 'active' : canAdvance ? 'next' : '';
          const disabledAttr = shouldDisable ? 'disabled' : '';
          const handler = shouldDisable ? '' : ` onclick="updateDeliveryStatus(${order.shipment_id}, '${step.key}')"`;
          return `<button class="status-chip ${stateClass}" ${disabledAttr}${handler}>${step.emoji} ${step.label}</button>`;
        }).join('');
      }

      function renderActiveDeliveryModalContent(deliveries = []) {
        const container = document.getElementById('activeDeliveryList');
        if (!container) {
          return;
        }

        if (!deliveries.length) {
          container.innerHTML = '<div style="padding:30px;text-align:center;color:#6b7280">No active deliveries right now. Accept an order to see live updates here.</div>';
          return;
        }

        container.innerHTML = deliveries.map(delivery => {
          const statusMeta = getShipmentStatusMeta(delivery.shipment_status);
          const earning = (parseFloat(delivery.total_amount || 0) * 0.15).toFixed(2);
          const totalAmount = parseFloat(delivery.total_amount || 0).toFixed(2);
          const nextStatus = getNextStatus(delivery.shipment_status);
          const nextStatusMeta = nextStatus ? getShipmentStatusMeta(nextStatus) : null;

          const nextButton = nextStatus ? `
            <button style="background:#10b981;color:#fff" onclick="updateDeliveryStatus(${delivery.shipment_id}, '${nextStatus}')">
              Advance to ${nextStatusMeta.label}
            </button>
          ` : '';

          const acceptButton = (delivery.shipment_status === 'pending' || delivery.shipment_status === 'assigned_to_rider') ? `
            <button style="background:#f97316;color:#fff" onclick="acceptOrder(${delivery.shipment_id})">
              Accept Delivery
            </button>
          ` : '';

          return `
            <div class="active-delivery-card">
              <div class="card-header">
                <div>
                  <div class="card-title">Order #${delivery.order_number}</div>
                  <div class="card-subtitle">Updated ${formatDateTime(delivery.available_since || delivery.created_at)}</div>
                </div>
                <span class="status-pill" style="background:${statusMeta.bg};color:${statusMeta.color}">${statusMeta.label}</span>
              </div>
              <div class="card-details">
                <div>
                  <div class="label">Customer</div>
                  <div class="value">${delivery.customer_name || 'N/A'}</div>
                  <div class="muted">${delivery.customer_phone || 'No phone on file'}</div>
                </div>
                <div>
                  <div class="label">Dropoff</div>
                  <div class="value">${delivery.delivery_address || 'Not provided'}</div>
                  <div class="muted">${[delivery.city, delivery.province].filter(Boolean).join(', ')}</div>
                </div>
                <div>
                  <div class="label">Earnings</div>
                  <div class="value">‚Ç±${earning}</div>
                  <div class="muted">Order ‚Ç±${totalAmount}</div>
                </div>
              </div>
              <div class="status-stepper">
                ${renderStatusStepper(delivery)}
              </div>
              <div class="card-actions">
                ${acceptButton}
                ${nextButton}
                <button style="background:#3b82f6;color:#fff" onclick="viewShipmentDetails(${delivery.shipment_id}, '${delivery.order_number}')">View Details</button>
              </div>
            </div>
          `;
        }).join('');
      }

      function updateActiveDeliveryNotifications(deliveries = []) {
        activeDeliveryCache = deliveries;
        const alertBtn = document.getElementById('activeDeliveryAlerts');
        const badge = document.getElementById('activeDeliveryBadge');

        if (!alertBtn || !badge) {
          return;
        }

        const count = deliveries.length;
        badge.textContent = count;

        if (count === 0) {
          alertBtn.classList.add('disabled-alert');
          alertBtn.setAttribute('disabled', 'disabled');
        } else {
          alertBtn.classList.remove('disabled-alert');
          alertBtn.removeAttribute('disabled');
        }

        renderActiveDeliveryModalContent(deliveries);
      }

      function buildActiveDeliveryActions(order) {
        if (!order.seller_confirmed) {
          return `
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center">
              <span style="font-size:12px;color:#f59e0b;font-weight:600">‚è≥ Waiting for seller</span>
              <button onclick="viewShipmentDetails(${order.shipment_id}, '${order.order_number}')"
                      style="background:#3b82f6;color:#fff;border:none;cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:600;font-size:11px;transition:all 0.2s;white-space:nowrap"
                      onmouseover="this.style.background='#2563eb'"
                      onmouseout="this.style.background='#3b82f6'">
                üìä Details
              </button>
            </div>
          `;
        }

        if (order.shipment_status === 'pending' || order.shipment_status === 'assigned_to_rider') {
          return `
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center">
              <button onclick="acceptOrder(${order.shipment_id})"
                      style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;transition:all 0.2s;white-space:nowrap"
                      onmouseover="this.style.background='#059669'"
                      onmouseout="this.style.background='#10b981'">
                Accept
              </button>
              <button onclick="viewShipmentDetails(${order.shipment_id}, '${order.order_number}')"
                      style="background:#6b7280;color:#fff;border:none;cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:600;font-size:11px;transition:all 0.2s;white-space:nowrap"
                      onmouseover="this.style.background='#4b5563'"
                      onmouseout="this.style.background='#6b7280'">
                üìä Details
              </button>
            </div>
          `;
        }

        if (order.shipment_status === 'delivered') {
          return `
            <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;justify-content:center">
              <span style="background:#10b981;color:#fff;padding:6px 10px;border-radius:6px;font-size:11px;font-weight:600">‚úì Delivered</span>
              <button onclick="viewShipmentDetails(${order.shipment_id}, '${order.order_number}')"
                      style="background:#6b7280;color:#fff;border:none;cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:600;font-size:11px;transition:all 0.2s;white-space:nowrap"
                      onmouseover="this.style.background='#4b5563'"
                      onmouseout="this.style.background='#6b7280'">
                üìä Details
              </button>
            </div>
          `;
        }

        const nextStatus = getNextStatus(order.shipment_status);
        const nextStatusMeta = nextStatus ? getShipmentStatusMeta(nextStatus) : null;
        const nextButton = nextStatus ? `
          <button onclick="updateDeliveryStatus(${order.shipment_id}, '${nextStatus}')"
                  style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;transition:all 0.2s;white-space:nowrap"
                  onmouseover="this.style.background='#059669'"
                  onmouseout="this.style.background='#10b981'">
            Advance to ${nextStatusMeta.label}
          </button>
        ` : '';

        return `
          <div class="status-actions-wrapper">
            <div class="status-stepper">
              ${renderStatusStepper(order)}
            </div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center">
              ${nextButton}
              <button onclick="viewShipmentDetails(${order.shipment_id}, '${order.order_number}')"
                      style="background:#6b7280;color:#fff;border:none;cursor:pointer;padding:4px 8px;border-radius:6px;font-weight:600;font-size:11px;transition:all 0.2s;white-space:nowrap"
                      onmouseover="this.style.background='#4b5563'"
                      onmouseout="this.style.background='#6b7280'">
                üìä Details
              </button>
            </div>
          </div>
        `;
      }

      const documentTypeDefinitions = [
        { key: 'government_id', label: "Driver's License" },
        { key: 'vehicle_registration', label: 'Vehicle Registration' },
        { key: 'orcr', label: 'Official Receipt / CR' },
        { key: 'car_photo', label: 'Vehicle Photo' }
      ];

      function triggerDocumentUpload(docType) {
        const input = document.getElementById(`doc-file-${docType}`);
        if (input) {
          input.click();
        }
      }

      function handleDocumentUpload(event, docType) {
        const file = event.target.files && event.target.files[0];
        if (!file) {
          return;
        }

        const card = document.querySelector(`[data-doc-type="${docType}"]`);
        const statusNote = card ? card.querySelector('.doc-upload-status') : null;
        if (statusNote) {
          statusNote.textContent = 'Uploading document...';
        }

        const formData = new FormData();
        formData.append('document_type', docType);
        formData.append('document', file);

        fetch('/api/rider/upload-document', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (!data.success) {
            throw new Error(data.error || 'Upload failed');
          }
          loadDocumentStatuses();
          alert('Document uploaded successfully. It will be reviewed shortly.');
        })
        .catch(error => {
          console.error('Error uploading document:', error);
          alert('Failed to upload document. Please try again.');
          if (statusNote) {
            statusNote.textContent = 'Upload failed. Please retry.';
          }
        })
        .finally(() => {
          event.target.value = '';
        });
      }

      function loadDocumentStatuses() {
        fetch('/api/rider/document-status')
          .then(response => response.json())
          .then(data => {
            if (!data.success || !data.documents) {
              throw new Error(data.error || 'Unable to load documents');
            }

            documentTypeDefinitions.forEach(def => {
              const card = document.querySelector(`[data-doc-type="${def.key}"]`);
              if (!card) {
                return;
              }
              const badge = card.querySelector('.doc-status');
              const note = card.querySelector('.doc-upload-status');
              const viewLink = card.querySelector('.doc-view-link');
              const docData = data.documents[def.key];

              if (!docData) {
                badge.textContent = 'Not uploaded';
                badge.className = 'doc-status doc-status-missing';
                if (note) {
                  note.textContent = 'No file uploaded yet.';
                }
                if (viewLink) {
                  viewLink.style.display = 'none';
                  viewLink.removeAttribute('href');
                }
                return;
              }

              if (docData.verified) {
                badge.textContent = 'Verified';
                badge.className = 'doc-status doc-status-verified';
                if (note) {
                  note.textContent = `Approved ${formatDateTime(docData.updated_at || docData.uploaded_at)}`;
                }
              } else {
                badge.textContent = 'Pending review';
                badge.className = 'doc-status doc-status-pending';
                if (note) {
                  note.textContent = `Uploaded ${formatDateTime(docData.uploaded_at)} ¬∑ Awaiting approval`;
                }
              }

              if (viewLink) {
                if (docData.file_url) {
                  viewLink.style.display = 'inline-flex';
                  viewLink.href = docData.file_url;
                } else {
                  viewLink.style.display = 'none';
                  viewLink.removeAttribute('href');
                }
              }
            });
          })
          .catch(error => {
            console.error('Error loading document statuses:', error);
          });
      }

      function openActiveDeliveryModal() {
        if (!activeDeliveryCache.length) {
          alert('No active deliveries yet. Accept an order to see notifications.');
          return;
        }
        const modal = document.getElementById('activeDeliveryModal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }

      function closeActiveDeliveryModal() {
        const modal = document.getElementById('activeDeliveryModal');
        if (modal) {
          modal.style.display = 'none';
        }
      }


      function initializeMap() {

        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "South Luzon" }}';
        console.log('Service Area from DB:', serviceAreaText);


        const serviceAreaParts = serviceAreaText.split(',').map(part => part.trim());
        const mainRegion = serviceAreaParts[0];
        const normalizedRegion = mainRegion.toLowerCase().trim();

        console.log('Parsed main region:', mainRegion);
        console.log('All service area parts:', serviceAreaParts);


        let regionConfig = null;
        for (const [region, config] of Object.entries(regionCoordinates)) {
          if (normalizedRegion.includes(region.toLowerCase()) || region.toLowerCase().includes(normalizedRegion)) {
            regionConfig = config;
            console.log('Matched region:', region, config);
            break;
          }
        }


        if (!regionConfig) {
          console.log('No match found, using default: South Luzon');
          regionConfig = regionCoordinates['south luzon'];
        }


        const map = L.map('serviceMap').setView(regionConfig.center, regionConfig.zoom);


        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
        }).addTo(map);


        const serviceArea = L.circle(regionConfig.center, {
          color: '#10b981',
          fillColor: '#10b981',
          fillOpacity: 0.15,
          radius: regionConfig.radius
        }).addTo(map);


        const centerMarker = L.marker(regionConfig.center, {
          icon: L.divIcon({
            className: 'center-marker',
            html: '<div style="background:#0a0a0a;color:white;padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;white-space:nowrap;box-shadow:0 2px 8px rgba(0,0,0,0.3);">üìç ' + regionConfig.displayName + '</div>',
            iconSize: [120, 32],
            iconAnchor: [60, 16]
          })
        }).addTo(map);

        centerMarker.bindPopup(`<b>${regionConfig.displayName}</b><br>Your Service Area`);


        L.control.scale().addTo(map);
      }


      function switchSection(sectionId) {

        document.querySelectorAll('[id$="-section"]').forEach(section => {
          section.style.display = 'none';
        });


        const selectedSection = document.getElementById(sectionId + '-section');
        if (selectedSection) {
          selectedSection.style.display = 'block';
        }


        document.querySelectorAll('.side-link').forEach(link => {
          link.classList.remove('active');
        });


        const activeLink = Array.from(document.querySelectorAll('.side-link')).find(
          link => link.textContent.toLowerCase().includes(sectionId.toLowerCase())
        );
        if (activeLink) {
          activeLink.classList.add('active');
        }


        if (sectionId === 'deliveries') {
          loadOrdersAndDeliveries();
        }
      }


      function clearFilters() {
        document.getElementById('filterProvince').value = '';
        document.getElementById('filterCity').value = '';
        document.getElementById('filterPostalCode').value = '';
        loadOrdersAndDeliveries();
      }



      function loadOrdersAndDeliveries() {

        const filterProvince = document.getElementById('filterProvince')?.value.trim() || '';
        const filterCity = document.getElementById('filterCity')?.value.trim() || '';
        const filterPostalCode = document.getElementById('filterPostalCode')?.value.trim() || '';


        Promise.all([
          fetch('/api/rider/available-orders').then(r => r.json()),
          fetch('/api/rider/active-deliveries' + (filterProvince || filterCity || filterPostalCode ?
            '?' + new URLSearchParams({province: filterProvince, city: filterCity, postal_code: filterPostalCode}).toString() : '')).then(r => r.json())
        ])
        .then(([availableData, activeData]) => {
          const tbody = document.querySelector('#orders-deliveries-tbody');
          const allOrders = [];


          if (availableData.success && availableData.orders && availableData.orders.length > 0) {
            const availableOrders = availableData.orders.filter(order =>
              order.order_status === 'waiting_for_pickup' && !order.assigned_rider_id
            );
            availableOrders.forEach(order => {
              allOrders.push({...order, type: 'available'});
            });
          }


          if (activeData.deliveries && activeData.deliveries.length > 0) {
            activeData.deliveries.forEach(order => {
              allOrders.push({...order, type: 'active'});
            });
          }


          if (activeData.service_area) {
            document.getElementById('riderServiceArea').textContent = activeData.service_area || 'Not assigned';
          }

          updateActiveDeliveryNotifications(activeData.deliveries || []);


          document.getElementById('order-count').textContent = `${allOrders.length} Orders`;

          if (allOrders.length > 0) {
            tbody.innerHTML = allOrders.map(order => {
              const earning = (parseFloat(order.total_amount) * 0.15).toFixed(2);
              const orderLocation = `${order.delivery_city || order.city}, ${order.delivery_province || order.province}`;


              let statusText, statusColor, statusBg;

              if (order.type === 'available') {
                statusText = 'Available';
                statusColor = '#059669';
                statusBg = '#ecfdf5';
              } else {
                const statusMeta = getShipmentStatusMeta(order.shipment_status);
                statusText = statusMeta.label;
                statusColor = statusMeta.color;
                statusBg = statusMeta.bg;
              }


              let actionButton = '';

              if (order.type === 'available') {
                actionButton = `
                  <button onclick="acceptOrder(${order.shipment_id})"
                          style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-weight:600;font-size:12px;transition:all 0.2s;white-space:nowrap"
                          onmouseover="this.style.background='#059669'"
                          onmouseout="this.style.background='#10b981'">
                    Accept Order
                  </button>
                `;
              } else {
                actionButton = buildActiveDeliveryActions(order);
              }

              const availableDate = order.available_since || order.created_at;
              const dateFormatted = availableDate ? formatDateTime(availableDate) : 'N/A';

              return `
                <tr style="border-bottom:1px solid #e5e7eb;transition:background 0.2s">
                  <td style="padding:12px 14px;font-weight:700;color:#0a0a0a;white-space:nowrap">
                    #${order.order_number}
                  </td>
                  <td style="padding:12px 14px;font-size:13px;color:#374151;white-space:nowrap">
                    ${dateFormatted}
                  </td>
                  <td style="padding:12px 14px">
                    <div style="font-weight:600;color:#0a0a0a;margin-bottom:3px">${order.customer_name}</div>
                    <div style="font-size:12px;color:#666;margin-bottom:4px">${order.delivery_address}</div>
                    <div style="font-size:11px;color:#10b981;font-weight:500">üìç ${orderLocation}</div>
                  </td>
                  <td style="padding:12px 14px;font-weight:600;color:#0a0a0a">
                    ‚Ç±${parseFloat(order.total_amount).toFixed(2)}
                  </td>
                  <td style="padding:12px 14px;text-align:right;font-weight:700;color:#10b981;font-size:13px">
                    ‚Ç±${earning}
                  </td>
                  <td style="padding:12px 14px">
                    <span style="background:${statusBg};color:${statusColor};padding:6px 10px;border-radius:6px;font-size:12px;font-weight:600;white-space:nowrap;display:inline-block">
                      ${statusText}
                    </span>
                  </td>
                  <td style="padding:12px 14px;text-align:center">
                    ${actionButton}
                  </td>
                </tr>
              `;
            }).join('');
          } else {
            const filterText = (filterProvince || filterCity || filterPostalCode) ?
              'No orders found in this area. Try adjusting your filters.' :
              'No available or active orders right now. Check back soon!';
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:#999;padding:40px">${filterText}</td></tr>`;
          }
        })
        .catch(error => {
          console.error('Error loading orders and deliveries:', error);
          document.querySelector('#orders-deliveries-tbody').innerHTML =
            '<tr><td colspan="7" style="text-align:center;color:#dc2626;padding:40px">Error loading orders</td></tr>';
          updateActiveDeliveryNotifications([]);
        });
      }


      function loadAvailableOrders() {
        loadOrdersAndDeliveries();
      }

      function loadMyActiveDeliveries() {
        loadOrdersAndDeliveries();
      }


      function acceptOrder(shipmentId) {
        if (!confirm('Accept this delivery order?')) return;

        fetch('/api/rider/accept-order', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ shipment_id: shipmentId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Order accepted! You can now start the delivery.');
            loadAvailableOrders();
            loadMyActiveDeliveries();
          } else {
            alert('Failed to accept order: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error accepting order:', error);
          alert('Error accepting order. Please try again.');
        });
      }


      function updateDeliveryStatus(shipmentId, newStatus) {
        if (!newStatus) return;

        const statusText = newStatus.replace('_', ' ').toUpperCase();
        if (!confirm(`Update status to ${statusText}?`)) {

          event.target.value = '';
          return;
        }

        fetch('/api/rider/update-delivery-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            shipment_id: shipmentId,
            status: newStatus
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Status updated successfully!');
            if (newStatus === 'delivered') {
              alert('üéâ Delivery completed! Your earnings have been updated.');

              loadMyActiveDeliveries();
              loadDeliveryHistory();
            } else {
              loadMyActiveDeliveries();
            }
          } else {
            alert('Failed to update status: ' + (data.error || 'Unknown error'));
            event.target.value = '';
          }
        })
        .catch(error => {
          console.error('Error updating status:', error);
          alert('Error updating status. Please try again.');
          event.target.value = '';
        });
      }


      function viewShipmentDetails(shipmentId, orderNumber) {

        fetch('/api/rider/shipment-details/' + shipmentId)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.shipment) {
              const s = data.shipment;


              const statusDescriptions = {
                'pending': { text: 'Pending', emoji: '‚è≥', color: '#f59e0b', description: 'Seller has not confirmed yet' },
                'assigned_to_rider': { text: 'Assigned', emoji: 'üìç', color: '#3b82f6', description: 'Assigned to you, waiting for acceptance' },
                'picked_up': { text: 'Picked Up', emoji: 'üì¶', color: '#3b82f6', description: 'You have picked up the order' },
                'in_transit': { text: 'In Transit', emoji: 'üöó', color: '#8b5cf6', description: 'On the way to delivery location' },
                'out_for_delivery': { text: 'Out for Delivery', emoji: 'üö™', color: '#ec4899', description: 'At delivery location, finalizing' },
                'delivered': { text: 'Delivered', emoji: '‚úÖ', color: '#10b981', description: 'Successfully delivered' },
                'failed': { text: 'Failed', emoji: '‚ùå', color: '#ef4444', description: 'Delivery could not be completed' }
              };

              const currentStatus = statusDescriptions[s.status] || {
                text: s.status.replace('_', ' ').toUpperCase(),
                emoji: 'üìã',
                color: '#6b7280',
                description: 'Current status'
              };


              let timeline = '';
              const statuses = ['pending', 'assigned_to_rider', 'picked_up', 'in_transit', 'out_for_delivery', 'delivered'];
              const currentIndex = statuses.indexOf(s.status);

              statuses.forEach((status, index) => {
                const statusInfo = statusDescriptions[status];
                const isCompleted = index <= currentIndex;
                const isCurrent = index === currentIndex;
                const bgColor = isCompleted ? statusInfo.color : '#e5e7eb';
                const textColor = isCompleted ? '#fff' : '#6b7280';

                timeline += `
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <div style="width:8px;height:8px;border-radius:999px;background:${bgColor};flex-shrink:0;border:2px solid ${isCurrent ? statusInfo.color : 'transparent'}"></div>
                    <div>
                      <div style="font-weight:600;color:${isCurrent ? statusInfo.color : '#0a0a0a'};font-size:13px">${statusInfo.emoji} ${statusInfo.text}</div>
                      <div style="font-size:12px;color:#666;margin-top:2px">${statusInfo.description}</div>
                    </div>
                  </div>
                `;
              });

              const details = `
üì¶ SHIPMENT STATUS DETAILS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

Order #: ${orderNumber}
Shipment ID: ${shipmentId}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Customer: ${s.customer_name || 'N/A'}
Delivery Address: ${s.delivery_address || 'N/A'}
üìç Location: ${s.delivery_city}, ${s.delivery_province}

Amount: ‚Ç±${parseFloat(s.total_amount || 0).toFixed(2)}
Your Earning (15%): ‚Ç±${(parseFloat(s.total_amount || 0) * 0.15).toFixed(2)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Current Status: ${currentStatus.emoji} ${currentStatus.text}

Delivery Timeline:
${timeline}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${s.created_at ? `Created: ${formatDateTime(s.created_at)}` : ''}
${s.updated_at ? `Last Updated: ${formatDateTime(s.updated_at)}` : ''}
              `;

              alert(details);
            } else {
              alert('Unable to load shipment details. Please try again.');
            }
          })
          .catch(error => {
            console.error('Error fetching shipment details:', error);
            alert('Error loading shipment details. Please try again.');
          });
      }


      function loadDeliveryHistory() {
        fetch('/api/rider/delivery-history')
          .then(response => response.json())
          .then(data => {
            const tbody = document.querySelector('#history-table tbody');
            if (data.success && data.history && data.history.length > 0) {
              tbody.innerHTML = data.history.map((delivery) => {
                const deliveredDate = delivery.delivered_at ? formatDateTime(delivery.delivered_at) : 'N/A';
                const earning = (parseFloat(delivery.total_amount) * 0.15).toFixed(2);
                const location = `${delivery.city}, ${delivery.province}`.trim();

                return `
                  <tr style="border-left:4px solid #10b981;background:#f0fdf4">
                    <td>
                      <div style="font-weight:600;color:#0a0a0a">#${delivery.order_number}</div>
                      <div style="font-size:11px;color:#999">${deliveredDate}</div>
                    </td>
                    <td>
                      <div style="color:#0a0a0a;font-weight:500">${delivery.customer_name || 'N/A'}</div>
                      <div style="font-size:11px;color:#999">${delivery.customer_phone || 'N/A'}</div>
                    </td>
                    <td style="color:#10b981;font-weight:600;font-size:14px">‚Ç±${earning}</td>
                    <td>
                      <div style="display:flex;align-items:center;gap:6px">
                        <span style="background:#dcfce7;color:#15803d;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">‚úì Delivered</span>
                      </div>
                      <div style="font-size:10px;color:#666;margin-top:4px">üìç ${location}</div>
                    </td>
                    <td style="text-align:center">
                      <button onclick="viewDeliveredOrderDetails(${delivery.id}, '${delivery.order_number}', '${delivery.customer_name}', ${delivery.total_amount}, '${deliveredDate}')" class="tag" style="background:#10b981;color:#fff;border:none;cursor:pointer;padding:6px 12px;border-radius:6px;font-size:11px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">View</button>
                    </td>
                  </tr>
                `;
              }).join('');
            } else {
              tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;padding:20px">No delivery history found</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading delivery history:', error);
            document.querySelector('#history-table tbody').innerHTML = '<tr><td colspan="5" style="text-align:center;color:#ef4444;padding:20px">Error loading history</td></tr>';
          });
      }


      function viewDeliveredOrderDetails(orderId, orderNumber, customerName, totalAmount, deliveredDate) {
        const earning = (parseFloat(totalAmount) * 0.15).toFixed(2);
        const details = `
üì¶ ORDER #${orderNumber}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Customer: ${customerName}
Total Amount: ‚Ç±${parseFloat(totalAmount).toFixed(2)}
Your Earnings (15%): ‚Ç±${earning}
Delivered On: ${deliveredDate}
Status: ‚úì Delivered
        `;
        alert(details);
      }


      function viewHistoryDetails(index, date, orderCount, earnings) {
        const details = `
Delivery Date: ${date}
Total Deliveries: ${orderCount}
Daily Earnings: ‚Ç±${parseFloat(earnings).toFixed(2)}
        `;
        alert(details);
      }


      function updateHistoryRecord(index, date) {
        alert('Edit delivery record for ' + date + '\n(To be implemented)');
      }


      function loadEarnings() {
        fetch('/api/rider/earnings')
          .then(response => response.json())
          .then(data => {
            if (data.success) {

              document.getElementById('weekly-earnings').textContent = '‚Ç±' + parseFloat(data.weekly_earnings).toFixed(2);
              document.getElementById('monthly-earnings').textContent = '‚Ç±' + parseFloat(data.monthly_earnings).toFixed(2);


              const tbody = document.querySelector('#earnings-breakdown-table tbody');
              tbody.innerHTML = `
                <tr>
                  <td>Base Fare</td>
                  <td>‚Ç±${parseFloat(data.breakdown.base_fare).toFixed(2)}</td>
                  <td>70%</td>
                </tr>
                <tr>
                  <td>Tips</td>
                  <td>‚Ç±${parseFloat(data.breakdown.tips).toFixed(2)}</td>
                  <td>20%</td>
                </tr>
                <tr>
                  <td>Bonuses</td>
                  <td>‚Ç±${parseFloat(data.breakdown.bonuses).toFixed(2)}</td>
                  <td>10%</td>
                </tr>
              `;
            } else {
              document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999">No earnings data available</td></tr>';
            }
          })
          .catch(error => {
            console.error('Error loading earnings:', error);
            document.querySelector('#earnings-breakdown-table tbody').innerHTML = '<tr><td colspan="3" style="text-align:center;color:#ef4444">Error loading earnings</td></tr>';
          });
      }


      function loadRatings() {
        fetch('/api/rider/rating-stats')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update overview rating card
              const ratingValue = parseFloat(data.avg_rating).toFixed(1);
              const ratingCards = document.querySelectorAll('.card .inner');
              ratingCards.forEach(card => {
                const metric = card.querySelector('.metric');
                if (metric && metric.textContent.includes('Rating')) {
                  card.querySelector('.value').textContent = ratingValue;
                }
              });

              // Update ratings section if it exists
              const overallRatingEl = document.getElementById('overall-rating');
              if (overallRatingEl) {
                overallRatingEl.textContent = ratingValue;
              }

              const fullStars = Math.floor(data.avg_rating);
              const stars = '‚≠ê'.repeat(fullStars);
              const ratingStarsEl = document.getElementById('rating-stars');
              if (ratingStarsEl) {
                ratingStarsEl.textContent = stars;
              }

              const ratingCountEl = document.getElementById('rating-count');
              if (ratingCountEl) {
                ratingCountEl.textContent = `(${data.total_ratings} ratings)`;
              }

              // Update rating breakdown if section exists
              const breakdownEl = document.getElementById('rating-breakdown');
              if (breakdownEl && data.rating_breakdown) {
                const breakdown = data.rating_breakdown;
                const total = data.total_ratings;
                let breakdownHTML = '<div style="margin-top: 20px;">';
                for (let i = 5; i >= 1; i--) {
                  const count = breakdown[i.toString()] || 0;
                  const percentage = total > 0 ? (count / total * 100).toFixed(0) : 0;
                  breakdownHTML += `
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <span style="width: 60px;">${i} star${i > 1 ? 's' : ''}</span>
                      <div style="flex: 1; background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                        <div style="background: #fbbf24; height: 100%; width: ${percentage}%;"></div>
                      </div>
                      <span style="width: 50px; text-align: right; color: #6b7280;">${count}</span>
                    </div>
                  `;
                }
                breakdownHTML += '</div>';
                breakdownEl.innerHTML = breakdownHTML;
              }

              renderReviewsTable(data.reviews || []);
            }
          })
          .catch(error => {
            console.error('Error loading ratings:', error);
            renderReviewsTable(null, true);
          });
      }

      function renderReviewsTable(reviews, hasError = false) {
        const reviewsTableBody = document.querySelector('#reviews-table tbody');
        if (!reviewsTableBody) {
          return;
        }

        if (hasError) {
          reviewsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#ef4444">Error loading reviews</td></tr>';
          return;
        }

        if (!reviews || reviews.length === 0) {
          reviewsTableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#999">No reviews yet</td></tr>';
          return;
        }

        let html = '';
        reviews.forEach(review => {
          const formattedDate = review.created_at ? formatDateTime(review.created_at) : '‚Äî';
          const stars = '‚≠ê'.repeat(Math.max(1, Math.round(review.rating || 0)));
          html += `
            <tr>
              <td>${formattedDate}</td>
              <td>${review.customer_name || 'Customer'}</td>
              <td>${stars}</td>
              <td>${review.comment || 'No comment provided'}</td>
            </tr>
          `;
        });

        reviewsTableBody.innerHTML = html;
      }


      const regionProvinces = {
        'North Luzon': [
          'Ilocos Norte', 'Ilocos Sur', 'La Union', 'Pangasinan',
          'Baguio City', 'Benguet', 'Abra', 'Kalinga', 'Apayao', 'Mountain Province',
          'Cagayan', 'Isabela', 'Nueva Vizcaya', 'Quirino', 'Batanes'
        ],
        'Central Luzon': [
          'Pampanga', 'Tarlac', 'Nueva Ecija', 'Zambales', 'Bataan',
          'Bulacan', 'Aurora', 'Angeles City', 'Olongapo City', 'San Fernando City'
        ],
        'South Luzon': [
          'Laguna', 'Batangas', 'Cavite', 'Rizal', 'Quezon',
          'Antipolo City', 'Lucena City', 'Batangas City', 'Lipa City', 'Tagaytay City',
          'Calamba City', 'Los Ba√±os', 'Bi√±an City', 'Cabuyao', 'San Pablo City',
          'Albay', 'Camarines Norte', 'Camarines Sur', 'Catanduanes', 'Masbate', 'Sorsogon',
          'Marinduque', 'Occidental Mindoro', 'Oriental Mindoro', 'Palawan', 'Romblon',
          'Manila', 'Quezon City', 'Makati', 'Pasig', 'Taguig', 'Mandaluyong',
          'Marikina', 'Pasay', 'Para√±aque', 'Las Pi√±as', 'Muntinlupa', 'Caloocan',
          'Malabon', 'Navotas', 'Valenzuela', 'San Juan'
        ],
        'Visayas': [
          'Cebu', 'Cebu City', 'Mandaue City', 'Lapu-Lapu City', 'Talisay City',
          'Iloilo', 'Iloilo City', 'Bacolod City', 'Negros Occidental', 'Negros Oriental',
          'Bohol', 'Tagbilaran City', 'Dumaguete City', 'Roxas City', 'Kalibo',
          'Tacloban City', 'Ormoc City', 'Leyte', 'Samar', 'Eastern Samar', 'Northern Samar',
          'Biliran', 'Southern Leyte'
        ],
        'Mindanao': [
          'Davao City', 'Davao del Norte', 'Davao del Sur', 'Davao Oriental', 'Davao de Oro',
          'Cagayan de Oro City', 'Misamis Oriental', 'Misamis Occidental', 'Iligan City',
          'Zamboanga City', 'Zamboanga del Norte', 'Zamboanga del Sur', 'Zamboanga Sibugay',
          'General Santos City', 'South Cotabato', 'North Cotabato', 'Sultan Kudarat',
          'Butuan City', 'Agusan del Norte', 'Agusan del Sur', 'Surigao del Norte', 'Surigao del Sur',
          'Cotabato City', 'Maguindanao', 'Lanao del Norte', 'Lanao del Sur', 'Marawi City',
          'Bukidnon', 'Valencia City', 'Malaybalay City'
        ]
      };


      function updateCoverageDetails() {
        const serviceAreaText = '{{ rider.service_area if rider and rider.service_area else "South Luzon" }}';
        console.log('Updating coverage details for:', serviceAreaText);


        const serviceAreaParts = serviceAreaText.split(',').map(part => part.trim());
        const mainRegion = serviceAreaParts[0];


        let coverageText = 'Covering: ';


        const allRegionProvinces = regionProvinces[mainRegion] || [];

        if (allRegionProvinces.length > 0) {

          coverageText += allRegionProvinces.join(', ');
        } else {

          coverageText += mainRegion;
        }


        const coverageDescription = document.getElementById('coverage-description');
        if (coverageDescription) {
          coverageDescription.textContent = coverageText;
        }
      }


      function toggleEditMode() {
        const viewMode = document.getElementById('profileViewMode');
        const editMode = document.getElementById('profileEditMode');
        const editBtn = document.getElementById('editProfileBtn');

        if (editMode.style.display === 'none') {

          viewMode.style.display = 'none';
          editMode.style.display = 'block';
          editBtn.textContent = '‚úï Cancel';
          editBtn.style.background = '#ef4444';
        } else {

          viewMode.style.display = 'block';
          editMode.style.display = 'none';
          editBtn.textContent = '‚úé Edit Profile';
          editBtn.style.background = '#0a0a0a';
        }
      }


      function saveProfileChanges() {
        const firstName = document.getElementById('editFirstName').value.trim();
        const lastName = document.getElementById('editLastName').value.trim();
        const email = document.getElementById('editEmail').value.trim();
        const phone = document.getElementById('editPhone').value.trim();
        const vehicleType = document.getElementById('editVehicle').value;
        const licenseNumber = document.getElementById('editLicense').value.trim();


        if (!firstName || !lastName) {
          alert('Please enter both first and last name');
          return;
        }

        if (!email) {
          alert('Please enter email address');
          return;
        }

        if (!phone) {
          alert('Please enter phone number');
          return;
        }


        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚è≥ Saving...';
        button.disabled = true;


        fetch('/api/rider/update-profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            first_name: firstName,
            last_name: lastName,
            email: email,
            phone: phone,
            vehicle_type: vehicleType,
            license_number: licenseNumber
          })
        })
        .then(response => response.json())
        .then(data => {
          button.textContent = originalText;
          button.disabled = false;

          if (data.success) {

            document.getElementById('viewFirstName').textContent = firstName;
            document.getElementById('viewLastName').textContent = lastName;
            document.getElementById('viewEmail').textContent = email;
            document.getElementById('viewPhone').textContent = phone;
            document.getElementById('viewVehicle').textContent = vehicleType || 'Not specified';
            document.getElementById('viewLicense').textContent = licenseNumber || 'Not provided';
            document.getElementById('viewRiderName').textContent = firstName + ' ' + lastName;

            alert('‚úì Profile updated successfully!');
            toggleEditMode();
          } else {
            alert('Error: ' + (data.error || 'Failed to update profile'));
          }
        })
        .catch(error => {
          console.error('Error saving profile:', error);
          button.textContent = originalText;
          button.disabled = false;
          alert('Error saving profile. Please try again.');
        });
      }


      function openChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'flex';
      }


      function closeChangePasswordModal() {
        document.getElementById('changePasswordModal').style.display = 'none';
        document.getElementById('changePasswordForm').reset();
      }


      function changePassword() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (!currentPassword || !newPassword || !confirmPassword) {
          alert('Please fill in all password fields');
          return;
        }

        if (newPassword !== confirmPassword) {
          alert('New passwords do not match');
          return;
        }

        if (newPassword.length < 6) {
          alert('Password must be at least 6 characters');
          return;
        }

        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚è≥ Updating...';
        button.disabled = true;

        fetch('/api/rider/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        })
        .then(response => response.json())
        .then(data => {
          button.textContent = originalText;
          button.disabled = false;

          if (data.success) {
            alert('‚úì Password changed successfully!');
            closeChangePasswordModal();
          } else {
            alert('Error: ' + (data.error || 'Failed to change password'));
          }
        })
        .catch(error => {
          console.error('Error changing password:', error);
          button.textContent = originalText;
          button.disabled = false;
          alert('Error changing password. Please try again.');
        });
      }


      function uploadProfileImage(input) {
        if (!input.files || !input.files[0]) return;

        const file = input.files[0];


        if (!file.type.startsWith('image/')) {
          alert('Please select a valid image file.');
          return;
        }


        if (file.size > 5 * 1024 * 1024) {
          alert('Image size must be less than 5MB.');
          return;
        }


        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileImage').src = e.target.result;
        };
        reader.readAsDataURL(file);


        const formData = new FormData();
        formData.append('profile_image', file);

        fetch('/api/rider/upload-profile-image', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Profile image updated successfully!');
          } else {
            alert('Failed to upload image: ' + (data.error || 'Unknown error'));

            location.reload();
          }
        })
        .catch(error => {
          console.error('Error uploading image:', error);
          alert('Error uploading image. Please try again.');

          location.reload();
        });
      }


      document.addEventListener('DOMContentLoaded', function() {

        document.getElementById('overview-section').style.display = 'block';


        updateCoverageDetails();


        initializeMap();


        loadDeliveryHistory();
        loadEarnings();
        loadRatings();


        document.querySelectorAll('.show-section').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const section = this.getAttribute('data-section');
            if (section) {
              switchSection(section);
            }
          });
        });


        document.querySelectorAll('.side-link').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();


            const onclickAttr = this.getAttribute('onclick');
            if (onclickAttr) {

              const match = onclickAttr.match(/switchSection\('(.+?)'\)/);
              if (match && match[1]) {
                switchSection(match[1]);
              }
            }
          });
        });

        const activeModal = document.getElementById('activeDeliveryModal');
        if (activeModal) {
          activeModal.addEventListener('click', function(e) {
            if (e.target === activeModal) {
              closeActiveDeliveryModal();
            }
          });
        }

        document.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            closeActiveDeliveryModal();
          }
        });

        updateActiveDeliveryNotifications([]);
        loadDocumentStatuses();

        const approvalModal = document.getElementById('riderApprovalModal');
        if (approvalModal) {
          approvalModal.style.display = 'flex';
          const dismissBtn = document.getElementById('riderApprovalDismiss');
          if (dismissBtn) {
            dismissBtn.addEventListener('click', function() {
              approvalModal.style.display = 'none';
            });
          }
        }

        console.log('Rider Dashboard initialized');
      });
    </script>

    <!-- Active Delivery Modal -->
    <div id="activeDeliveryModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:12px;padding:24px;max-width:900px;width:90%;max-height:80vh;overflow:auto;box-shadow:0 20px 45px rgba(0,0,0,0.25);position:relative">
        <button onclick="closeActiveDeliveryModal()" style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:26px;color:#9ca3af;cursor:pointer">√ó</button>
        <h2 style="margin:0 0 12px;font-size:20px;color:#0a0a0a">Active Delivery Details</h2>
        <p style="margin:0 0 18px;color:#6b7280;font-size:13px">Monitor every accepted delivery, update statuses, and review customer info in one place.</p>
        <div id="activeDeliveryList"></div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:450px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeChangePasswordModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 20px;font-size:18px">Change Password</h2>
        <form id="changePasswordForm" style="display:grid;gap:14px">
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Current Password</label>
            <input type="password" id="currentPassword" placeholder="Enter current password"
                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box">
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">New Password</label>
            <input type="password" id="newPassword" placeholder="Enter new password"
                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box">
            <div style="font-size:11px;color:#666;margin-top:4px">Must be at least 6 characters</div>
          </div>
          <div>
            <label style="display:block;font-size:12px;color:#666;margin-bottom:6px;font-weight:600">Confirm Password</label>
            <input type="password" id="confirmPassword" placeholder="Confirm new password"
                   style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;box-sizing:border-box">
          </div>
        </form>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
          <button onclick="closeChangePasswordModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="changePassword()" style="padding:10px 20px;border:none;background:#3b82f6;color:#fff;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.2s" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">Update Password</button>
        </div>
      </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" style="position:fixed;inset:0;background:rgba(10,10,10,0.45);display:none;align-items:center;justify-content:center;z-index:1000">
      <div style="background:#fff;border-radius:10px;padding:24px;max-width:400px;box-shadow:0 4px 20px rgba(0,0,0,0.2)">
        <button onclick="closeLogoutModal()" style="float:right;background:none;border:none;font-size:24px;cursor:pointer;color:#999">√ó</button>
        <h2 style="margin:0 0 8px;font-size:18px">Confirm Logout</h2>
        <p style="margin:0 0 18px;color:#666;font-size:14px">Are you sure you want to logout? You will need to log in again to access your account.</p>
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button onclick="closeLogoutModal()" style="padding:10px 20px;border:1px solid #ddd;background:#f6f6f6;color:#0a0a0a;border-radius:6px;cursor:pointer;font-weight:500">Cancel</button>
          <button onclick="proceedLogout()" style="padding:10px 20px;border:none;background:#ef4444;color:#fff;border-radius:6px;cursor:pointer;font-weight:500">Yes, Logout</button>
        </div>
      </div>
    </div>

    <script>
      function confirmLogout(event) {
        event.preventDefault();
        document.getElementById('logoutModal').style.display = 'flex';
      }

      function closeLogoutModal() {
        document.getElementById('logoutModal').style.display = 'none';
      }

      function proceedLogout() {
        window.location.href = '/logout';
      }
    </script>
  </body>
</html>
