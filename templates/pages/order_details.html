<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Order Details - Var√≥n</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600&family=Commissioner:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
      .user-dropdown {
        position: relative;
        display: inline-block;
      }
      .user-button {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        padding: 8px 12px;
        font-size: 14px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .user-button:hover {
        background: rgba(255,255,255,0.1);
      }
      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background: #fff;
        min-width: 160px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-radius: 8px;
        margin-top: 8px;
        z-index: 1000;
        overflow: hidden;
      }
      .dropdown-content.show {
        display: block;
      }
      .dropdown-content a {
        color: #0a0a0a;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        transition: background 0.2s;
      }
      .dropdown-content a:hover {
        background: #f3f4f6;
      }
    </style>
    <style>
      .order-details-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
      }
      .detail-card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
      }
      .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-bottom: 16px;
        border-bottom: 2px solid #f3f4f6;
        margin-bottom: 20px;
      }
      .status-badge {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f3f4f6;
      }
      .info-row:last-child {
        border-bottom: none;
      }
      .info-label {
        color: #666;
        font-size: 14px;
      }
      .info-value {
        font-weight: 600;
        text-align: right;
      }
      .item-card {
        display: flex;
        gap: 16px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 12px;
      }
      .item-image {
        width: 80px;
        height: 80px;
        border-radius: 6px;
        object-fit: cover;
        background: #f5f5f5;
      }
      .item-details {
        flex: 1;
      }
      .timeline {
        position: relative;
        padding-left: 40px;
      }
      .timeline-item {
        position: relative;
        padding-bottom: 24px;
      }
      .timeline-item:last-child {
        padding-bottom: 0;
      }
      .timeline-dot {
        position: absolute;
        left: -34px;
        top: 4px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #10b981;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #10b981;
      }
      .timeline-dot.inactive {
        background: #e5e7eb;
        box-shadow: 0 0 0 2px #e5e7eb;
      }
      .timeline-line {
        position: absolute;
        left: -29px;
        top: 16px;
        width: 2px;
        height: calc(100% - 16px);
        background: #e5e7eb;
      }
      #orderReceivedBtn:hover:not(:disabled) {
        background: #059669 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16,185,129,0.4);
      }
      #orderReceivedBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      #confirmOrderBtn:hover:not(:disabled) {
        background: #059669 !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16,185,129,0.4);
      }
      #confirmOrderBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: #f3f4f6;
        color: #0a0a0a;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-decoration: none;
        margin-bottom: 20px;
      }
      .btn-back:hover {
        background: #e5e7eb;
      }
    </style>
  </head>
  <body>
    <header class="site-header">
      <button class="menu-toggle" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
      <h1 class="brand"><a href="/" style="color:#fff;text-decoration:none">Var√≥n</a></h1>
      <nav class="top-nav" id="topNav">
        <a href="/indexLoggedIn.html#home">Home</a>
        <a href="/indexLoggedIn.html#browse">Browse</a>
        <a href="/indexLoggedIn.html#myOrders">My Orders</a>
        <div class="user-dropdown">
          <button class="user-button" onclick="toggleUserDropdown()">
            <span id="buyerFirstName">
              {% if session.get('first_name') %}
                {{ session.get('first_name') }}
              {% else %}
                Account
              {% endif %}
            </span> ‚ñæ
          </button>
          <div id="userDropdown" class="dropdown-content">
            <a href="{{ url_for('logout') }}">Logout</a>
          </div>
        </div>
      </nav>
    </header>

    <div class="order-details-container">
      <a href="/indexLoggedIn.html#myOrders" class="btn-back">‚Üê Back to Orders</a>

      <!-- Order Header -->
      <div class="detail-card">
        <div class="detail-header">
          <div>
            <h1 style="margin:0 0 8px;font-size:28px">Order #{{ order.order_number }}</h1>
            <p style="margin:0;color:#666">Placed on {{ order.created_at|ph_time('%B %d, %Y at %I:%M %p') or 'N/A' }}</p>
          </div>
          {% set status = order.order_status or 'pending' %}
          {% set status_info = status_colors.get(status, status_colors.get('pending')) %}
          <span class="status-badge" style="background:{{ status_info['bg'] }};color:{{ status_info['color'] }}">
            {{ status_info['emoji'] }} {{ status.upper() }}
          </span>
        </div>

        <div class="info-row">
          <span class="info-label">Order Total</span>
          <span class="info-value" style="font-size:20px;color:#0a0a0a">‚Ç±{{ "%.2f"|format(order.total_amount|float) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Payment Method</span>
          <span class="info-value">{{ order.payment_method or 'Cash on Delivery' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Payment Status</span>
          <span class="info-value" style="color:{% if order.payment_status == 'paid' %}#10b981{% else %}#f59e0b{% endif %}">{{ order.payment_status.upper() }}</span>
        </div>

        <!-- Confirm Order Button (only shows for pending orders) -->
        {% if order.order_status == 'pending' %}
        <div style="margin-top:16px;padding-top:16px;border-top:1px solid #f3f4f6">
          <button onclick="confirmOrderStatus()" id="confirmOrderBtn" style="width:100%;padding:12px;background:#10b981;color:#fff;border:none;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;transition:all 0.2s">
            ‚úì Confirm Order
          </button>
        </div>
        {% endif %}
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">
        <!-- Shipping Address -->
        <div class="detail-card">
          <h3 style="margin:0 0 16px;font-size:18px">üì¶ Shipping Address</h3>
          <p style="margin:0;line-height:1.6">
            <strong>{{ shipping_address.full_name }}</strong><br>
            {{ shipping_address.street_address }}<br>
            {% if shipping_address.barangay %}{{ shipping_address.barangay }}, {% endif %}
            {{ shipping_address.city }}, {{ shipping_address.province }}<br>
            {{ shipping_address.postal_code }}<br>
            üìû {{ shipping_address.phone }}
          </p>
        </div>

        <!-- Billing Address -->
        <div class="detail-card">
          <h3 style="margin:0 0 16px;font-size:18px">üí≥ Billing Address</h3>
          {% if billing_address %}
          <p style="margin:0;line-height:1.6">
            <strong>{{ billing_address.full_name }}</strong><br>
            {{ billing_address.street_address }}<br>
            {% if billing_address.barangay %}{{ billing_address.barangay }}, {% endif %}
            {{ billing_address.city }}, {{ billing_address.province }}<br>
            {{ billing_address.postal_code }}<br>
            üìû {{ billing_address.phone }}
          </p>
          {% else %}
          <p style="margin:0;color:#999">Same as shipping address</p>
          {% endif %}
        </div>
      </div>

      <!-- Order Items -->
      <div class="detail-card">
        <h3 style="margin:0 0 20px;font-size:18px">üõçÔ∏è Order Items ({{ items|length }})</h3>
        {% for item in items %}
        <div class="item-card">
          <img src="{{ item.image_url or 'https://via.placeholder.com/80' }}" alt="{{ item.product_name }}" class="item-image">
          <div class="item-details">
            <h4 style="margin:0 0 4px;font-size:16px">{{ item.product_name }}</h4>
            <p style="margin:0 0 8px;color:#666;font-size:14px">
              {% if item.size %}Size: {{ item.size }}{% endif %}
              {% if item.color %}{% if item.size %} ‚Ä¢ {% endif %}Color: {{ item.color }}{% endif %}
              {% if item.sku %}<br>SKU: {{ item.sku }}{% endif %}
            </p>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <span style="color:#666">Quantity: {{ item.quantity }}</span>
              <div style="text-align:right">
                <div style="color:#666;font-size:13px">‚Ç±{{ "%.2f"|format(item.unit_price|float) }} each</div>
                <div style="font-weight:600;font-size:16px">‚Ç±{{ "%.2f"|format(item.subtotal|float) }}</div>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Order Summary -->
      <div class="detail-card">
        <h3 style="margin:0 0 20px;font-size:18px">üí∞ Order Summary</h3>
        <div class="info-row">
          <span class="info-label">Subtotal</span>
          <span class="info-value">‚Ç±{{ "%.2f"|format(order.subtotal|float) }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Shipping Fee</span>
          <span class="info-value">‚Ç±{{ "%.2f"|format(order.shipping_fee|float) }}</span>
        </div>
        {% if order.tax_amount and order.tax_amount > 0 %}
        <div class="info-row">
          <span class="info-label">Tax</span>
          <span class="info-value">‚Ç±{{ "%.2f"|format(order.tax_amount|float) }}</span>
        </div>
        {% endif %}
        {% if order.discount_amount and order.discount_amount > 0 %}
        <div class="info-row" style="color:#10b981">
          <span class="info-label">Discount</span>
          <span class="info-value">-‚Ç±{{ "%.2f"|format(order.discount_amount|float) }}</span>
        </div>
        {% endif %}
        <div class="info-row" style="padding-top:16px;margin-top:12px;border-top:2px solid #f3f4f6">
          <span class="info-label" style="font-size:18px;font-weight:600;color:#0a0a0a">Total</span>
          <span class="info-value" style="font-size:22px;font-weight:600;color:#0a0a0a">‚Ç±{{ "%.2f"|format(order.total_amount|float) }}</span>
        </div>
      </div>

      <!-- Order Timeline -->
      {% if shipment %}
      <div class="detail-card">
        <h3 style="margin:0 0 20px;font-size:18px">üìç Order Tracking</h3>
        {% if shipment.tracking_number %}
        <div style="background:#f0f9ff;padding:12px 16px;border-radius:6px;margin-bottom:20px">
          <span style="color:#666;font-size:14px">Tracking Number: </span>
          <strong style="color:#3b82f6">{{ shipment.tracking_number }}</strong>
        </div>
        {% endif %}

        <div class="timeline">
          {% if shipment.seller_confirmed or order.order_status in ['confirmed', 'processing', 'shipped', 'delivered'] %}
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-line"></div>
            <strong>Order Confirmed</strong>
            <p style="margin:4px 0 0;color:#666;font-size:14px">‚úì Seller confirmed your order</p>
          </div>
          {% else %}
          <div class="timeline-item">
            <div class="timeline-dot inactive"></div>
            <div class="timeline-line"></div>
            <strong style="color:#999">Order Confirmed</strong>
            <p style="margin:4px 0 0;color:#999;font-size:14px">‚è≥ Waiting for seller approval</p>
          </div>
          {% endif %}

          {% if shipment.status in ['picked_up', 'in_transit', 'out_for_delivery', 'delivered'] %}
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-line"></div>
            <strong>Order Picked Up</strong>
            <p style="margin:4px 0 0;color:#666;font-size:14px">
              {% if shipment.shipped_at %}{{ shipment.shipped_at|ph_time('%B %d, %Y at %I:%M %p') }}{% else %}In Progress{% endif %}
            </p>
          </div>
          {% else %}
          <div class="timeline-item">
            <div class="timeline-dot inactive"></div>
            <div class="timeline-line"></div>
            <strong style="color:#999">Order Picked Up</strong>
            <p style="margin:4px 0 0;color:#999;font-size:14px">‚è≥ Waiting for rider pickup</p>
          </div>
          {% endif %}

          {% if shipment.status in ['in_transit', 'out_for_delivery', 'delivered'] %}
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-line"></div>
            <strong>In Transit</strong>
            <p style="margin:4px 0 0;color:#666;font-size:14px">üöö On the way to you</p>
          </div>
          {% else %}
          <div class="timeline-item">
            <div class="timeline-dot inactive"></div>
            <div class="timeline-line"></div>
            <strong style="color:#999">In Transit</strong>
            <p style="margin:4px 0 0;color:#999;font-size:14px">‚è≥ Pending rider update</p>
          </div>
          {% endif %}

          {% if shipment.status in ['out_for_delivery', 'delivered'] %}
          <div class="timeline-item">
            <div class="timeline-dot"></div>
            <div class="timeline-line"></div>
            <strong>Out for Delivery</strong>
            <p style="margin:4px 0 0;color:#666;font-size:14px">üöö Your package is nearby</p>
          </div>
          {% else %}
          <div class="timeline-item">
            <div class="timeline-dot inactive"></div>
            <div class="timeline-line"></div>
            <strong style="color:#999">Out for Delivery</strong>
            <p style="margin:4px 0 0;color:#999;font-size:14px">‚è≥ Waiting for rider update</p>
          </div>
          {% endif %}

          {% if shipment.status == 'delivered' %}
          <div class="timeline-item">
            <div class="timeline-dot" style="background:#10b981;box-shadow:0 0 0 2px #10b981"></div>
            <strong style="color:#10b981">‚úì Delivered</strong>
            <p style="margin:4px 0 0;color:#666;font-size:14px">
              {% if shipment.delivered_at %}{{ shipment.delivered_at|ph_time('%B %d, %Y at %I:%M %p') }}{% endif %}
            </p>
            {% if shipment.delivery_notes %}
            <p style="margin:8px 0 0;color:#666;font-size:13px;font-style:italic">"{{ shipment.delivery_notes }}"</p>
            {% endif %}
          </div>
          {% else %}
          <div class="timeline-item">
            <div class="timeline-dot inactive"></div>
            <strong style="color:#999">Delivered</strong>
            <p style="margin:4px 0 0;color:#999;font-size:14px">
              {% if shipment.estimated_delivery %}Est. {{ shipment.estimated_delivery|ph_time('%B %d, %Y') }}{% else %}‚è≥ Pending rider delivery{% endif %}
            </p>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Seller Information -->
      {% if seller %}
      <div class="detail-card">
        <h3 style="margin:0 0 16px;font-size:18px">üè™ Seller Information</h3>
        <div style="display:flex;gap:16px;align-items:center">
          {% if seller.logo_url %}
          <img src="{{ seller.logo_url }}" alt="{{ seller.store_name }}" style="width:60px;height:60px;border-radius:50%;object-fit:cover">
          {% else %}
          <div style="width:60px;height:60px;border-radius:50%;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:24px">
            üè™
          </div>
          {% endif %}
          <div>
            <h4 style="margin:0 0 4px">{{ seller.store_name }}</h4>
            <p style="margin:0;color:#666;font-size:14px">
              {% if seller.rating %}‚≠ê {{ "%.1f"|format(seller.rating|float) }} Rating{% endif %}
            </p>
          </div>
        </div>
      </div>
      {% endif %}

      {% if order.notes %}
      <div class="detail-card">
        <h3 style="margin:0 0 12px;font-size:18px">üìù Order Notes</h3>
        <p style="margin:0;color:#666;line-height:1.6">{{ order.notes }}</p>
      </div>
      {% endif %}

      <!-- Action Buttons -->
      <div class="detail-card" style="display:flex;gap:12px;justify-content:flex-end">
        <a href="/indexLoggedIn.html#myOrders" class="btn-back" style="margin:0">Back to Orders</a>
        {% if order.order_status == 'pending' %}
        <button onclick="cancelOrder('{{ order.order_number }}')" style="padding:10px 20px;background:#ef4444;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">
          Cancel Order
        </button>
        {% endif %}
        {% if order.order_status == 'delivered' %}
        <button onclick="window.print()" style="padding:10px 20px;background:#0a0a0a;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:14px">
          Print Receipt
        </button>
        {% endif %}
      </div>

      <!-- Order Received Button (Only shows when order is delivered) -->
      {% if order.order_status == 'delivered' %}
      <div id="orderReceivedSection" style="margin-top:24px;padding:20px;background:#f0fdf4;border:2px solid #10b981;border-radius:12px;text-align:center">
        {% if order.buyer_received %}
        <div style="color:#166534;font-weight:600">
          ‚úÖ You confirmed receipt of this order on {{ order.buyer_received_at|ph_time('%B %d, %Y at %I:%M %p') or 'N/A' }}.
        </div>
        {% else %}
        <p style="margin:0 0 16px;font-size:15px;color:#166534">
          üì¶ <strong>Package Delivered!</strong> Please confirm once you've received your order.
        </p>
        <button id="orderReceivedBtn" onclick="confirmOrderReceived()" style="background:#10b981;color:#fff;padding:12px 32px;font-size:16px;font-weight:600;border:none;border-radius:8px;cursor:pointer;transition:all 0.2s">
          ‚úì Order Received
        </button>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <footer class="site-footer">
      <div class="footer-bottom">
        <div class="footer-brand">Var√≥n ‚Äî Minimal Apparel</div>
        <small>¬© <span class="muted">2025</span></small>
      </div>
    </footer>

    <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
    <script>
      async function confirmOrderStatus() {
        const btn = document.getElementById('confirmOrderBtn');

        if (!btn) return;

        const confirmed = await VaronNotifications.confirm('Confirm this order? This will change the status to CONFIRMED.', {
          confirmText: 'Confirm Order',
          cancelText: 'Keep Pending',
          confirmClass: 'confirm'
        });

        if (!confirmed) return;

        btn.disabled = true;
        btn.textContent = 'Confirming...';

        try {
          const response = await fetch('/api/confirm-order/{{ order.id }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Order confirmed successfully!');
            location.reload();
          } else {
            VaronNotifications.error(data.error || 'Failed to confirm order');
            btn.disabled = false;
            btn.textContent = '‚úì Confirm Order';
          }
        } catch (error) {
          console.error('Error confirming order:', error);
          VaronNotifications.error('An error occurred. Please try again.');
          btn.disabled = false;
          btn.textContent = '‚úì Confirm Order';
        }
      }

      async function confirmOrderReceived() {
        const btn = document.getElementById('orderReceivedBtn');

        if (!btn) return;

        const confirmed = await VaronNotifications.confirm('Confirm that you have received this order in good condition?', {
          confirmText: 'Yes, Received',
          cancelText: 'Not Yet',
          confirmClass: 'confirm'
        });

        if (!confirmed) return;

        btn.disabled = true;
        btn.textContent = 'Confirming...';

        try {
          const response = await fetch('/api/order-received/{{ order.id }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success(data.message || 'Order receipt confirmed');
            location.reload();
          } else {
            VaronNotifications.error(data.error || 'Failed to confirm order receipt');
            btn.disabled = false;
            btn.textContent = '‚úì Order Received';
          }
        } catch (error) {
          console.error('Error confirming order:', error);
          VaronNotifications.error('An error occurred. Please try again.');
          btn.disabled = false;
          btn.textContent = '‚úì Order Received';
        }
      }

      async function cancelOrder(orderNumber) {
        const confirmed = await VaronNotifications.confirm('Are you sure you want to cancel this order?', {
          confirmText: 'Cancel Order',
          cancelText: 'Keep Order',
          confirmClass: 'danger'
        });

        if (!confirmed) return;

        try {
          const response = await fetch('/api/cancel-order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ order_number: orderNumber })
          });

          const data = await response.json();

          if (data.success) {
            VaronNotifications.success('Order cancelled successfully');
            location.reload();
          } else {
            VaronNotifications.error('Failed to cancel order: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error:', error);
          VaronNotifications.error('Error cancelling order: ' + error.message);
        }
      }


      function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        dropdown.classList.toggle('show');
      }


      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-button') && !e.target.closest('.user-button') && !e.target.closest('.dropdown-content')) {
          const dropdown = document.getElementById('userDropdown');
          if (dropdown && dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
          }
        }
      });


      window.addEventListener('DOMContentLoaded', function() {
        fetch('/get_buyer_name')
          .then(response => response.json())
          .then(data => {
            if (data.firstName) {
              document.getElementById('buyerFirstName').textContent = data.firstName;
            }
          })
          .catch(error => console.error('Error fetching buyer name:', error));
      });
    </script>
  </body>
</html>
